<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 有趣的工具--智能指针与智能锁, Android | Linux | Flutter">
    <meta name="description" content="背景如果遇到什么问题在这个地址下留言：https://www.jianshu.com/p/2f0ecf6ca08c
在Android 的底层中，编写大量的c/c++源码。但是却很少看到Android去调用delete去删除对象的申请的内存。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 有趣的工具--智能指针与智能锁 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/10.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 有趣的工具--智能指针与智能锁
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Linux/">
                                <span class="chip bg-color">Linux</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android-Framework/" class="post-category">
                                Android Framework
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-07-07
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        7.8k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        34 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>如果遇到什么问题在这个地址下留言：<a href="https://www.jianshu.com/p/2f0ecf6ca08c" target="_blank" rel="noopener">https://www.jianshu.com/p/2f0ecf6ca08c</a></p>
<p>在Android 的底层中，编写大量的c/c++源码。但是却很少看到Android去调用delete去删除对象的申请的内存。而这其中，必定有一个东西去管理对象的生命周期。而这个担起这个责任就是智能指针。</p>
<p>于此同时，还能看到Android底层调用了锁之后，我们也没看到相应的解锁方法。实际上这里面起作用的就是智能锁，将锁自动解开。</p>
<p>接下来，将会从智能锁开始，聊聊这两个相似的设计思路。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="智能锁"><a href="#智能锁" class="headerlink" title="智能锁"></a>智能锁</h2><p>让我们先看看源码,关于智能锁其中一个例子。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mStateLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// start the EventThread</span>
    mEventThreadSource <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>DispSyncSource<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mPrimaryDispSync<span class="token punctuation">,</span> SurfaceFlinger<span class="token operator">::</span>vsyncPhaseOffsetNs<span class="token punctuation">,</span>
                                             <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mEventThread <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventThread<span class="token operator">></span><span class="token punctuation">(</span>mEventThreadSource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                       <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                       impl<span class="token operator">::</span>EventThread<span class="token operator">::</span><span class="token function">InterceptVSyncsCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                       <span class="token string">"appEventThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSfEventThreadSource <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>DispSyncSource<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mPrimaryDispSync<span class="token punctuation">,</span>
                                             SurfaceFlinger<span class="token operator">::</span>sfVsyncPhaseOffsetNs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"sf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mSFEventThread <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventThread<span class="token operator">></span><span class="token punctuation">(</span>mSfEventThreadSource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>nsecs_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                                    mInterceptor<span class="token operator">-</span><span class="token operator">></span><span class="token function">saveVSyncEvent</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                <span class="token string">"sfEventThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mEventQueue<span class="token operator">-</span><span class="token operator">></span><span class="token function">setEventThread</span><span class="token punctuation">(</span>mSFEventThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mVsyncModulator<span class="token punctuation">.</span><span class="token function">setEventThread</span><span class="token punctuation">(</span>mSFEventThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Get a RenderEngine for the given display / config (can't fail)</span>
    <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mRenderEngine <span class="token operator">=</span>
            RE<span class="token operator">::</span>impl<span class="token operator">::</span>RenderEngine<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>HAL_PIXEL_FORMAT_RGBA_8888<span class="token punctuation">,</span>
                                           hasWideColorDisplay
                                                   <span class="token operator">?</span> RE<span class="token operator">::</span>RenderEngine<span class="token operator">::</span>WIDE_COLOR_SUPPORT
                                                   <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token function">HWComposer</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Hwc2<span class="token operator">::</span>impl<span class="token operator">::</span>Composer<span class="token operator">></span><span class="token punctuation">(</span><span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwcServiceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mComposerSequenceId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">processDisplayHotplugEventsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">getDefaultDisplayDeviceLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">makeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们能看到作为Android显示系统的核心SurfaceFlinger在自己的进程初始化的时候，会初始化我们MessageQueue(设计思路和Android应用常用的Handler一致，一个消息队列)。作为消息队列，里面没有使用线程安全的数据结构，自然需要上锁，保护里面的数据结构。</p>
<p>虽然在整个Android系统中，一般只会初始化一次SurfaceFlinger。但是这就Google工程还是做了保护措施，可见其思想就是自己的模块要保证自己模块中数据正确性。</p>
<p>我们能看到一个很有趣东西</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mStateLock<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>看到这个名字我们大致上能够明白实际上，这必定是个锁。但是我们却没看到哪里解锁，哪里上锁了。</p>
<h3 id="智能锁的思路"><a href="#智能锁的思路" class="headerlink" title="智能锁的思路"></a>智能锁的思路</h3><p>在看源码之前，我们大致思考一下，如果我们尝试着简化，通过一个对象来管理整个上锁解锁流程应该怎么做。这就能顾让我们联想到，这个过程我们可以让锁跟着对象的创建和销毁的生命周期绑定起来。这样就能很简单做到锁的自动处理。本质上源码也是这么做的。</p>
<p>大致上，我们需要往这个方向努力：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;strings.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Define.h"</span></span>
<span class="token keyword">class</span> <span class="token class-name">Mutex</span> <span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    pthread_mutex_t mMutex<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>

    <span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token operator">~</span><span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Mutex.h"</span></span>
Mutex<span class="token operator">::</span><span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mMutex<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Mutex<span class="token operator">::</span><span class="token operator">~</span><span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"unlock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    Mutex m<span class="token punctuation">;</span>
    <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"do something"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="/images/%E6%99%BA%E8%83%BD%E9%94%81%E6%B5%8B%E8%AF%95.png" alt="智能锁测试.png"></p>
<p>这样就能让锁和对象互相绑定。只要使用这种方式就能够让这个Mutex对象跟着方法内的作用域跑，当这个作用域跑完，就能自动解锁。也就是这种思路，才会在Android一些底层看到这么调用。</p>
<p>但是这样的思路，让我们看到一种可行性，就是通过作用域来决定对象的释放实际，从而决定锁的释放范围。</p>
<p>可以看到源码BufferQueueProducer(显示系统中生产GraphBuffer的生产队列)中</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferQueueProducer<span class="token operator">::</span><span class="token function">dequeueBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> outSlot<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>android<span class="token operator">::</span>Fence<span class="token operator">></span><span class="token operator">*</span> outFence<span class="token punctuation">,</span>
                                            uint32_t width<span class="token punctuation">,</span> uint32_t height<span class="token punctuation">,</span> PixelFormat format<span class="token punctuation">,</span>
                                            uint64_t usage<span class="token punctuation">,</span> uint64_t<span class="token operator">*</span> outBufferAge<span class="token punctuation">,</span>
                                            FrameEventHistoryDelta<span class="token operator">*</span> outTimestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Autolock scope</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mConsumerName <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mConsumerName<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mIsAbandoned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">BQ_LOGE</span><span class="token punctuation">(</span><span class="token string">"dequeueBuffer: BufferQueue has been abandoned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> NO_INIT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mConnectedApi <span class="token operator">==</span> BufferQueueCore<span class="token operator">::</span>NO_CONNECTED_API<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">BQ_LOGE</span><span class="token punctuation">(</span><span class="token string">"dequeueBuffer: BufferQueue has no connected producer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> NO_INIT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// Autolock scope</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以灵活运用着在方法创造一个作用域，让智能锁自动解锁。</p>
<p>当然这只是雏形，我们看看底层是做了什么。我们随意抽一个Mutex的实现看看。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Mutex</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mMutex<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// A simple class that locks a given mutex on construction</span>
    <span class="token comment" spellcheck="true">// and unlocks it when it goes out of scope.</span>
    <span class="token keyword">class</span> <span class="token class-name">Autolock</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Autolock</span><span class="token punctuation">(</span>Mutex <span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lock<span class="token operator">-</span><span class="token operator">></span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">Autolock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lock<span class="token operator">-</span><span class="token operator">></span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        Mutex <span class="token operator">*</span>lock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    pthread_mutex_t mMutex<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Disallow copy and assign.</span>
    <span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mutex<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mutex<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mutex<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其思路和和我们的上面的思路很相似。但是能够看到这里面Mutex是对pthread_mutex_t对象的存在进行管理。Autolock则是让这个对象在作用域能进行上锁解锁管理。同时禁止了Mutex的拷贝构造函数，因为这样会造成意料之外的锁存在。</p>
<p>当然，在<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libutils/include/utils/" target="_blank" rel="noopener">/system/core/libutils/include/utils/</a>下还有写的更好的智能锁。</p>
<p>能看到的是，让某种行为绑定着对象的生命周期这种设计也是很常见。比如说Glide的每一次请求都是绑定在当前Activity一个隐形的Fragment中。</p>
<p>接下来让我们看看更加重要的智能智能。</p>
<h2 id="智能指针"><a href="#智能指针" class="headerlink" title="智能指针"></a>智能指针</h2><p>智能指针诞生的初衷来源，c++每一次new一个新的对象，因为对象的内存放到了堆中，导致我们必须想办法清除掉堆中的内存。当我们忘记清除指针指向的内存时候，就会产生野指针问题。然而每一次想办法在合适的地方delete，将会让整个工程复杂度提升了一个等级，也给每个程序员素质的考验。</p>
<p>就以我之前写Binder来说，大部分对象的操作都在内核中，对binder_transaction这些事务来回拷贝，binder_ref在不断的使用，想要找到一个合适的时机delete需要判断的东西就十分多。</p>
<p>此时就诞生了智能指针。本质上智能指针的思路，实际上和我们所说的引用计数本质上是一个东西。</p>
<p>引用计数的思路就是，当每一次引用，就对这个对象引用加一，当超过作用域的之类调用一次析构函数函数，引用计数减一。知道引用计数一直减到1，说明再也没有任何对象引用这个对象，就能安心的销毁（初始引用次数为1）。</p>
<p>但是这种内存计数方式有一个致命缺点，就是当两个引用互相引用时候，会发生循环计数的问题。而智能指针的为了解决这个，诞生了强引用指针和弱引用指针。</p>
<p>了解这些之后，我们尝试的思考怎么编写智能指针才能解决上面那些问题。</p>
<h3 id="智能指针设计思路"><a href="#智能指针设计思路" class="headerlink" title="智能指针设计思路"></a>智能指针设计思路</h3><p>首先我们能够确定是这必定是一个模版类，同时能够为了能够管理指针，必定会传一个指针进来。</p>
<p>对于指针的计数，我们能不能模仿智能锁那样，通过某个类包装起来，让某个全权管理这个类的真正的析构时机以及计数呢？</p>
<p>就想我上面的说的，加入让智能指针这个对象去管理计数，就会出现一个致命的情况。当智能指针1和智能指针2都引用同一个对象的时候，当智能指针1的计数减为0，要去析构的时候，智能指针2还持用着计数，此时就会出现析构失败。</p>
<p>因此，我们不可能只用一个类去完成。这个过程中，至少需要两个类，一个是用于计数，另一个是用于管理指针。</p>
<p>接下来让我们尝试，编写一个智能指针。首先创建一个LightRefBase基类，让之后所有的类都去继承这个类，让类自己拥有计数的功能。接着再创建一个SmartPointer去管理指针。</p>
<h4 id="LightRefBase"><a href="#LightRefBase" class="headerlink" title="LightRefBase"></a>LightRefBase</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">ifndef</span> SMARTTOOLS_LIGHTREFBASE_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SMARTTOOLS_LIGHTREFBASE_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;atomic></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Define.h></span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">LightRefBase</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">LightRefBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">mCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        mCount<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"inc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"dec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>mCount<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>memory_order_release<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">delete</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> T<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"delete"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">mutable</span> atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> mCount<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">//SMARTTOOLS_LIGHTREFBASE_H</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到的是，这里我创建了一个模版类，一个轻量级别的引用计数。当调用incStrong，将会增加原子计数引用次数。当调用decStrong，则会减少原子计数的引用次数。</p>
<p>这里稍微记录一下atomic原子类操作。</p>
<ul>
<li><ol>
<li>fetch_add 是指原子数字的增加</li>
</ol>
</li>
<li><ol start="2">
<li>fetch_sub 是指原子数字的减少</li>
</ol>
</li>
</ul>
<p>在这些原子模版类的操作中memory_order_release之类的内存顺序约束的操作。一共有如下操作：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">enum</span> memory_order <span class="token punctuation">{</span>

memory_order_relaxed<span class="token punctuation">,</span>

memory_order_consume<span class="token punctuation">,</span>

memory_order_acquire<span class="token punctuation">,</span>

memory_order_release<span class="token punctuation">,</span>

memory_order_acq_rel<span class="token punctuation">,</span>

memory_order_seq_cst

<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这6种memory_order可以分为3类。第一类，relaxed内存松弛。第二类，sequential_consistency内存一致序，第三类acquire-release获取释放一致序。</p>
<ul>
<li><p>对于内存松弛（memory_order_relaxed），对于多线程没有指令顺序一致性要求。只是保证了在一个线程内的原子操作保证了顺序上处理。对于不同线程之间的执行顺序是随意的。</p>
</li>
<li><p>对于内存一致序（memory_order_seq_cst），这是以牺牲优化效率，来保证指令顺序的一致性。相当于不打开编译器的优化指令。按照正常指令执行序执行，多线程之间原子操作也会Synchronized-with，比如atomic::load()需要等待atomic::store()写下元素才能读取，同步过程。</p>
</li>
<li><p>获取释放一致序，相当于对relaxed的加强。relax序由于无法限制多线程间的排序，所以引入synchronized-with，但并不一定意味着，统一的操作顺序。因为可能出现当出现读写操作时候，写入操作完成但是还是在缓存，并没有对应的内存，造成的异常。因此设计上诞生memory_order_release释放锁，memory_order_acquire上自旋锁。memory_order_consume的多线程消费者生产这些设计。</p>
</li>
</ul>
<h4 id="SmartPointer"><a href="#SmartPointer" class="headerlink" title="SmartPointer"></a>SmartPointer</h4><p>在编写SmartPointer的时候，记住要重写几个操作符号，因为赋值，创造构造SmartPointer的构造函数，我们都需要为对象的引用计数加一。当超出了作用域，则把对象的引用减一。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">ifndef</span> SMARTTOOLS_SMARTPOINTER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SMARTTOOLS_SMARTPOINTER_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span>  <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">SmartPointer</span> <span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    T<span class="token operator">*</span> m_ptr<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">SmartPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">m_ptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>


    <span class="token function">SmartPointer</span><span class="token punctuation">(</span>T <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_ptr <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
            m_ptr<span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>


    <span class="token operator">~</span><span class="token function">SmartPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_ptr<span class="token operator">-</span><span class="token operator">></span><span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    SmartPointer<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>T<span class="token operator">*</span> other<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_ptr <span class="token operator">=</span> other<span class="token punctuation">;</span>
            other<span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">//SMARTTOOLS_SMARTPOINTER_H</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来我们测试一下，在随意一个方法，测试一下。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">TestLight</span> <span class="token operator">:</span><span class="token keyword">public</span> LightRefBase<span class="token operator">&lt;</span>TestLight<span class="token operator">></span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TestLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

SmartPointer<span class="token operator">&lt;</span>TestLight<span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">TestLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看到了吗，这个形式就和我们之前在Binder源码分析时候，出现的引用计数时候声明一个sp的方式一模一样。<br>测试一下：<br><img src="/images/%E7%AE%80%E5%8D%95%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E6%B5%8B%E8%AF%95.png" alt="简单智能指针测试.png"></p>
<p>在一个方法内，确实完成了自动增加计数和销毁了。这样的设计和智能(自动锁)锁十分相似。都是灵活运用了作用域和析构函数之间的关系，对对象的引用计数做了内存管理，来判断是否继续需要这个对象。</p>
<h3 id="LightRefBase的缺点分析"><a href="#LightRefBase的缺点分析" class="headerlink" title="LightRefBase的缺点分析"></a>LightRefBase的缺点分析</h3><p>正如上面所说的一样，这么做虽然能做到简单的计数统计，似乎没有什么问题。为什么Java虚拟机不采用引用计数，而去使用GC引用链对对象进行内存挂历。</p>
<p>我们来考虑这种情况。<br>当A和B互相引用的时候。就造成这么一个问题<br><img src="/images/%E4%BA%92%E7%9B%B8%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0.png" alt="互相引用计数.png"></p>
<p>互相引用的时候，就造成一个特殊的情况。A中的B字段指向了B内存会让B本身无法析构，而B中的A字段指向了A的内存也会让A本身无法析构。</p>
<p>这样就出现，我们常说的循环引用。为了处理这种问题，诞生了强弱指针的概念。</p>
<p>先来聊聊强指针sp(StrongPointer)。强指针和我上面写的SmartPointer原理几乎一致。目的是为了操作继承了RefBase类中引用计数。</p>
<p>那么弱指针诞生就是为了处理循环引用的问题。如果换做是我们的话，我们该怎么处理这种异常呢。</p>
<p>我们回归问题的本质，这种情况类似于死锁，因为系统检查到双方都需要对方的资源，导致无法回收。那么就按照处理死锁的办法，打断死锁的资源的引用链就ok。这就是弱引用诞生的初衷。</p>
<p>强弱指针两种指针，将会分别为自己计数。那么我们一定需要一个删除引用的计数标准，当强引用了一个对象，当强引用的计数减到了1，将会删除里面的引用。</p>
<p>这样就打断了，引用计数的循环。但是，你们一定会想到，当我们删除A对象的引用，从B访问A，不就会出现了访问野指针/空指针的问题吗？</p>
<p>因此弱指针又有一个规定，弱指针不能直接访问对象，必须升级为强指针才能访问对象。</p>
<p>有这几个标准之后，我们尝试编写一下弱指针的源码。我们抛弃原来的LightRefBase，创建一个更加泛用的RefBase基类。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">ifndef</span> SMARTTOOLS_REFBASE_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SMARTTOOLS_REFBASE_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;StrongPointer.h></span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> COMPARE_WEAK(_op_)                                      \
inline bool operator _op_ (const sp&lt;T>&amp; o) const {              \
    return m_ptr _op_ o.m_ptr;                                  \
}                                                               \
inline bool operator _op_ (const T* o) const {                  \
    return m_ptr _op_ o;                                        \
}                                                               \
template&lt;typename U>                                            \
inline bool operator _op_ (const sp&lt;U>&amp; o) const {              \
    return m_ptr _op_ o.m_ptr;                                  \
}                                                               \
template&lt;typename U>                                            \
inline bool operator _op_ (const U* o) const {                  \
    return m_ptr _op_ o;                                        \
}</span>

<span class="token keyword">class</span> <span class="token class-name">RefBase</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">getStrongCount</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">forceStrong</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>


    <span class="token keyword">class</span> <span class="token class-name">weakref_type</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        RefBase<span class="token operator">*</span> <span class="token function">refBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

        <span class="token keyword">void</span> <span class="token function">incWeak</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">void</span> <span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// acquires a strong reference if there is already one.</span>
        <span class="token keyword">bool</span> <span class="token function">attemptIncStrong</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">bool</span> <span class="token function">attemptIncWeak</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> <span class="token function">getWeakCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    weakref_type<span class="token operator">*</span> <span class="token function">createWeak</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    weakref_type<span class="token operator">*</span> <span class="token function">getWeakRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token function">RefBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">RefBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">enum</span> <span class="token punctuation">{</span>
        OBJECT_LIFETIME_STRONG <span class="token operator">=</span> <span class="token number">0x0000</span><span class="token punctuation">,</span>
        OBJECT_LIFETIME_WEAK <span class="token operator">=</span> <span class="token number">0x0001</span><span class="token punctuation">,</span>
        OBJECT_LIFETIME_MASK <span class="token operator">=</span> <span class="token number">0x0001</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">extendObjectLifetime</span><span class="token punctuation">(</span><span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">enum</span> <span class="token punctuation">{</span>
        FIRST_INC_STRONG <span class="token operator">=</span> <span class="token number">0x0001</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onLastStrongRef</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">onIncStrongAttempted</span><span class="token punctuation">(</span><span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onLastWeakRef</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment" spellcheck="true">//为了让weakref_type去访问到refbase中的私有数据</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">weakref_type</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//一个实现类</span>
    <span class="token keyword">class</span> <span class="token class-name">weakref_impl</span><span class="token punctuation">;</span>
    <span class="token function">RefBase</span><span class="token punctuation">(</span><span class="token keyword">const</span> RefBase<span class="token operator">&amp;</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>

    RefBase<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> RefBase<span class="token operator">&amp;</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>

    weakref_impl <span class="token operator">*</span><span class="token keyword">const</span> mRefs<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//---------------------</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">wp</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">typedef</span> <span class="token keyword">typename</span> RefBase<span class="token operator">::</span>weakref_type weakref_type<span class="token punctuation">;</span>

    <span class="token keyword">inline</span> <span class="token function">wp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">m_ptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token function">wp</span><span class="token punctuation">(</span>T<span class="token operator">*</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//拷贝构造函数</span>
    <span class="token function">wp</span><span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">explicit</span> <span class="token function">wp</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> <span class="token function">wp</span><span class="token punctuation">(</span>U<span class="token operator">*</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> <span class="token function">wp</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> <span class="token function">wp</span><span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token operator">~</span><span class="token function">wp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    wp<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>T<span class="token operator">*</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wp<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wp<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> wp<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>U<span class="token operator">*</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> wp<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> wp<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">set_object_and_refs</span><span class="token punctuation">(</span>T<span class="token operator">*</span> other<span class="token punctuation">,</span> weakref_type<span class="token operator">*</span> refs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// promotion to sp</span>

    sp<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">promote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>


    <span class="token comment" spellcheck="true">// Reset</span>

    <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Accessors</span>

    <span class="token keyword">inline</span>  weakref_type<span class="token operator">*</span> <span class="token function">get_refs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_refs<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">inline</span>  T<span class="token operator">*</span> <span class="token function">unsafe_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_ptr<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Operators</span>
<span class="token comment" spellcheck="true">//</span>
    <span class="token function">COMPARE_WEAK</span><span class="token punctuation">(</span><span class="token operator">==</span><span class="token punctuation">)</span>
    <span class="token function">COMPARE_WEAK</span><span class="token punctuation">(</span><span class="token operator">!=</span><span class="token punctuation">)</span>
    <span class="token function">COMPARE_WEAK</span><span class="token punctuation">(</span><span class="token operator">></span><span class="token punctuation">)</span>
    <span class="token function">COMPARE_WEAK</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token punctuation">)</span>
    <span class="token function">COMPARE_WEAK</span><span class="token punctuation">(</span><span class="token operator">&lt;=</span><span class="token punctuation">)</span>
    <span class="token function">COMPARE_WEAK</span><span class="token punctuation">(</span><span class="token operator">>=</span><span class="token punctuation">)</span>

    <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>m_ptr <span class="token operator">==</span> o<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m_refs <span class="token operator">==</span> o<span class="token punctuation">.</span>m_refs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
    <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m_ptr <span class="token operator">==</span> o<span class="token punctuation">.</span>m_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>m_ptr <span class="token operator">==</span> o<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>m_refs <span class="token operator">></span> o<span class="token punctuation">.</span>m_refs<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>m_ptr <span class="token operator">></span> o<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
    <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>m_ptr <span class="token operator">==</span> o<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>m_refs <span class="token operator">></span> o<span class="token punctuation">.</span>m_refs<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>m_ptr <span class="token operator">></span> o<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>m_ptr <span class="token operator">==</span> o<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>m_refs <span class="token operator">&lt;</span> o<span class="token punctuation">.</span>m_refs<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>m_ptr <span class="token operator">&lt;</span> o<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
    <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>m_ptr <span class="token operator">==</span> o<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>m_refs <span class="token operator">&lt;</span> o<span class="token punctuation">.</span>m_refs<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>m_ptr <span class="token operator">&lt;</span> o<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_refs <span class="token operator">!=</span> o<span class="token punctuation">.</span>m_refs<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">operator</span> <span class="token operator">==</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">operator</span> <span class="token operator">></span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">operator</span> <span class="token operator">></span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">operator</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">operator</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>


<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> Y<span class="token operator">></span> <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">wp</span><span class="token punctuation">;</span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> Y<span class="token operator">></span> <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">sp</span><span class="token punctuation">;</span>
    T<span class="token operator">*</span> m_ptr<span class="token punctuation">;</span>
    weakref_type<span class="token operator">*</span> m_refs<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">undef</span> COMPARE_WEAK</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">//SMARTTOOLS_REFBASE_H</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们能看到，所有的要使用智能指针的对象，都要继承RefBase对象。里面包含了关键的增加强引用计数以及减少强引用计数的方法，以及创建弱引用和获取强弱引用计数的方法。</p>
<p>并且为了方便弱引用能够访问到Refbase中的私有属性，作为一个友元类存在里面。</p>
<p>同时创建一个wp(WeakPointer)弱引用的类。里面包含了必要的构造函数，以及比对方法。为了避免用户使用操作符号，对弱引用中的东西进行操作，必须重写所有的操作符号。</p>
<p>更重要的是，声明一个promote方法，这个方法的作用就是把wp弱引用指针升级为强引用指针。</p>
<p>等一下，读者肯定会好奇了，为什么已经存在了wp的类，还要创造一个weakref_type的类呢？</p>
<p>从我们上面的设计上看来，我们需要统计sp和wp的引用计数，并且以sp的引用计数为标准进行删除。那么我们势必需要计算两者计数。那么我们为什么不抽离这一块计数逻辑出来呢？weakref_type的实现是weak_impl,因此其存在意义就是方便计算两种指针的引用次数。</p>
<p>那么我们继续实现sp，强引用的头文件StrongPointer。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">ifndef</span> SMARTTOOLS_STRONGPOINTER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SMARTTOOLS_STRONGPOINTER_H</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">wp</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> COMPARE(_op_)                                           \
inline bool operator _op_ (const sp&lt;T>&amp; o) const {              \
    return m_ptr _op_ o.m_ptr;                                  \
}                                                               \
inline bool operator _op_ (const T* o) const {                  \
    return m_ptr _op_ o;                                        \
}                                                               \
template&lt;typename U>                                            \
inline bool operator _op_ (const sp&lt;U>&amp; o) const {              \
    return m_ptr _op_ o.m_ptr;                                  \
}                                                               \
template&lt;typename U>                                            \
inline bool operator _op_ (const U* o) const {                  \
    return m_ptr _op_ o;                                        \
}                                                               \
inline bool operator _op_ (const wp&lt;T>&amp; o) const {              \
    return m_ptr _op_ o.m_ptr;                                  \
}                                                               \
template&lt;typename U>                                            \
inline bool operator _op_ (const wp&lt;U>&amp; o) const {              \
    return m_ptr _op_ o.m_ptr;                                  \
}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">sp</span><span class="token punctuation">{</span>
    <span class="token keyword">inline</span> <span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">m_ptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token function">sp</span><span class="token punctuation">(</span>T<span class="token operator">*</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">sp</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">sp</span><span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span>U <span class="token operator">*</span>other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> <span class="token function">sp</span><span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token operator">~</span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    sp<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>T<span class="token operator">*</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    sp<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    sp<span class="token operator">&amp;</span><span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> sp<span class="token operator">&amp;</span><span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> sp<span class="token operator">&amp;</span><span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span> sp<span class="token operator">&amp;</span><span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>U<span class="token operator">*</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">force_set</span><span class="token punctuation">(</span>T<span class="token operator">*</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">inline</span> T<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">*</span>m_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">inline</span> T<span class="token operator">*</span> <span class="token keyword">operator</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> m_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">inline</span> T<span class="token operator">*</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">inline</span> <span class="token keyword">explicit</span> <span class="token keyword">operator</span> <span class="token keyword">bool</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m_ptr <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">// Operators</span>

    <span class="token function">COMPARE</span><span class="token punctuation">(</span><span class="token operator">==</span><span class="token punctuation">)</span>
    <span class="token function">COMPARE</span><span class="token punctuation">(</span><span class="token operator">!=</span><span class="token punctuation">)</span>
    <span class="token function">COMPARE</span><span class="token punctuation">(</span><span class="token operator">></span><span class="token punctuation">)</span>
    <span class="token function">COMPARE</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token punctuation">)</span>
    <span class="token function">COMPARE</span><span class="token punctuation">(</span><span class="token operator">&lt;=</span><span class="token punctuation">)</span>
    <span class="token function">COMPARE</span><span class="token punctuation">(</span><span class="token operator">>=</span><span class="token punctuation">)</span>


<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> Y<span class="token operator">></span> <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">wp</span><span class="token punctuation">;</span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> Y<span class="token operator">></span> <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">sp</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">set_pointer</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    T<span class="token operator">*</span> m_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">//SMARTTOOLS_STRONGPOINTER_H</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>sp的设计上相对简单点，和上面的SmartPointer十分相似。只是复写很多操作符号。</p>
<h2 id="实现sp，wp，weakref-type"><a href="#实现sp，wp，weakref-type" class="headerlink" title="实现sp，wp，weakref_type"></a>实现sp，wp，weakref_type</h2><h3 id="wp的实现"><a href="#wp的实现" class="headerlink" title="wp的实现"></a>wp的实现</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">wp</span><span class="token punctuation">(</span>T <span class="token operator">*</span>other<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs <span class="token operator">=</span> other<span class="token operator">-</span><span class="token operator">></span><span class="token function">createWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">wp</span><span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span>
<span class="token operator">:</span><span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_refs</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_refs<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//other的指针不为空，再增加弱引用计数</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">incWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">wp</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs <span class="token operator">=</span> m_ptr<span class="token operator">-</span><span class="token operator">></span><span class="token function">createWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">wp</span><span class="token punctuation">(</span>U <span class="token operator">*</span>other<span class="token punctuation">)</span>
<span class="token operator">:</span><span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs <span class="token operator">=</span> other<span class="token operator">-</span><span class="token operator">></span><span class="token function">createWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">wp</span><span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span>
<span class="token operator">:</span><span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs <span class="token operator">=</span> other<span class="token punctuation">.</span>m_refs<span class="token punctuation">;</span>
        m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">incWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">wp</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span>
<span class="token operator">:</span><span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs <span class="token operator">=</span> m_ptr<span class="token operator">-</span><span class="token operator">></span><span class="token function">createWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">wp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>T <span class="token operator">*</span>other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//赋值操作，把带着RefBase的对象复制给弱引用</span>
    <span class="token comment" spellcheck="true">//为新的对象创建引用计数器</span>
    weakref_type<span class="token operator">*</span> newRefs <span class="token operator">=</span> other <span class="token operator">?</span> other<span class="token operator">-</span><span class="token operator">></span><span class="token function">createWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//如果原来的指针有数据，则需要把原来的弱引用减一。</span>
    <span class="token comment" spellcheck="true">//因为此时相当于把当前已有的弱引用被新来的替换掉</span>
    <span class="token comment" spellcheck="true">//那么，原来引用的弱引用计数要减一</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    m_ptr <span class="token operator">=</span> other<span class="token punctuation">;</span>
    m_refs <span class="token operator">=</span> newRefs<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
wp<span class="token operator">&amp;</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">&amp;</span>other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//弱引用赋值</span>
    weakref_type<span class="token operator">*</span> <span class="token function">otherRef</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_refs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    T<span class="token operator">*</span> <span class="token function">otherPtr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>otherPtr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        otherPtr<span class="token operator">-</span><span class="token operator">></span><span class="token function">incWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    m_ptr <span class="token operator">=</span> otherPtr<span class="token punctuation">;</span>
    m_refs <span class="token operator">=</span> otherRef<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
wp<span class="token operator">&amp;</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">&amp;</span>other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//强引用赋值给弱引用</span>
    <span class="token comment" spellcheck="true">//和上面对象赋值同理</span>
    weakref_type<span class="token operator">*</span> newRefs <span class="token operator">=</span> other <span class="token operator">?</span> other<span class="token operator">-</span><span class="token operator">></span><span class="token function">createWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    T<span class="token operator">*</span> <span class="token function">otherPtr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    m_ptr <span class="token operator">=</span> otherPtr<span class="token punctuation">;</span>
    m_refs <span class="token operator">=</span> newRefs<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
wp<span class="token operator">&amp;</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>U <span class="token operator">*</span>other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//不是同类型赋值给弱引用</span>
    weakref_type<span class="token operator">*</span> newRefs <span class="token operator">=</span> other <span class="token operator">?</span> other<span class="token operator">-</span><span class="token operator">></span><span class="token function">createWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    m_ptr <span class="token operator">=</span> other<span class="token punctuation">;</span>
    m_refs <span class="token operator">=</span> newRefs<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//不同类型的弱引用赋值</span>
    weakref_type<span class="token operator">*</span> <span class="token function">otherRefs</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_refs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    U<span class="token operator">*</span> <span class="token function">otherPtr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>otherPtr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        otherRefs<span class="token operator">-</span><span class="token operator">></span><span class="token function">incWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    m_ptr <span class="token operator">=</span> otherPtr<span class="token punctuation">;</span>
    m_refs <span class="token operator">=</span> otherRefs<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//不同对象的强引用赋值给弱引用</span>
    weakref_type<span class="token operator">*</span> newRefs <span class="token operator">=</span>
            other <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">?</span> other<span class="token operator">-</span><span class="token operator">></span><span class="token function">createWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    U<span class="token operator">*</span> <span class="token function">otherPtr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    m_ptr <span class="token operator">=</span> otherPtr<span class="token punctuation">;</span>
    m_refs <span class="token operator">=</span> newRefs<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">void</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">set_object_and_refs</span><span class="token punctuation">(</span>T<span class="token operator">*</span> other<span class="token punctuation">,</span> weakref_type<span class="token operator">*</span> refs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//直接赋值对象和引用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">{</span>
        refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">incWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    m_ptr <span class="token operator">=</span> other<span class="token punctuation">;</span>
    m_refs <span class="token operator">=</span> refs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">promote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//核心</span>
    sp<span class="token operator">&lt;</span>T<span class="token operator">></span> result<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_ptr <span class="token operator">&amp;&amp;</span> m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">attemptIncStrong</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">set_pointer</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">void</span> wp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里面大部分的工作都是处理操作符和构造函数。当调用构造函数的时候，会为wp弱引用指针创建一个计数器。当调用赋值操作符时候，会判断原来是否包含引用对象，有则因为我们需要替换，相当于不需要这个对象，需要减少一次引用计数。</p>
<p>在这里面核心还是promote方法。还记得wp不能直接操作，需要promote升级，没错这里是约定俗称的。因此promote的时候会创建一个sp，并且会调用attemptIncStrong增加一次引用计数。attemptIncStrong为了避免多线程干扰而创建的方法，稍后会继续聊聊。</p>
<p>那么sp的思路实际上和wp思路几乎一致</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">sp</span><span class="token punctuation">(</span>T<span class="token operator">*</span> other<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token punctuation">)</span>
        other<span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span>
        m_ptr<span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">sp</span><span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    other<span class="token punctuation">.</span>m_ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">sp</span><span class="token punctuation">(</span>U<span class="token operator">*</span> other<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span>
        m_ptr<span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">sp</span><span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">m_ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    other<span class="token punctuation">.</span>m_ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span>
        m_ptr<span class="token operator">-</span><span class="token operator">></span><span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span> <span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Force m_ptr to be read twice, to heuristically check for data races.</span>
    T<span class="token operator">*</span> <span class="token function">oldPtr</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const_cast</span><span class="token operator">&lt;</span>T<span class="token operator">*</span> <span class="token keyword">volatile</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    T<span class="token operator">*</span> <span class="token function">otherPtr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>otherPtr<span class="token punctuation">)</span> otherPtr<span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPtr<span class="token punctuation">)</span> oldPtr<span class="token operator">-</span><span class="token operator">></span><span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_ptr <span class="token operator">=</span> otherPtr<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span> <span class="token operator">=</span><span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    T<span class="token operator">*</span> <span class="token function">oldPtr</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const_cast</span><span class="token operator">&lt;</span>T<span class="token operator">*</span> <span class="token keyword">volatile</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPtr<span class="token punctuation">)</span> oldPtr<span class="token operator">-</span><span class="token operator">></span><span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_ptr <span class="token operator">=</span> other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">;</span>
    other<span class="token punctuation">.</span>m_ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span> <span class="token operator">=</span><span class="token punctuation">(</span>T<span class="token operator">*</span> other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    T<span class="token operator">*</span> <span class="token function">oldPtr</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const_cast</span><span class="token operator">&lt;</span>T<span class="token operator">*</span> <span class="token keyword">volatile</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token punctuation">)</span> other<span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPtr<span class="token punctuation">)</span> oldPtr<span class="token operator">-</span><span class="token operator">></span><span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_ptr <span class="token operator">=</span> other<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span> <span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    T<span class="token operator">*</span> <span class="token function">oldPtr</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const_cast</span><span class="token operator">&lt;</span>T<span class="token operator">*</span> <span class="token keyword">volatile</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    T<span class="token operator">*</span> <span class="token function">otherPtr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>otherPtr<span class="token punctuation">)</span> otherPtr<span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPtr<span class="token punctuation">)</span> oldPtr<span class="token operator">-</span><span class="token operator">></span><span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_ptr <span class="token operator">=</span> otherPtr<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span> <span class="token operator">=</span><span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    T<span class="token operator">*</span> <span class="token function">oldPtr</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const_cast</span><span class="token operator">&lt;</span>T<span class="token operator">*</span> <span class="token keyword">volatile</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span> m_ptr<span class="token operator">-</span><span class="token operator">></span><span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_ptr <span class="token operator">=</span> other<span class="token punctuation">.</span>m_ptr<span class="token punctuation">;</span>
    other<span class="token punctuation">.</span>m_ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span> <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> U<span class="token operator">></span>
sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">&amp;</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token keyword">operator</span> <span class="token operator">=</span><span class="token punctuation">(</span>U<span class="token operator">*</span> other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    T<span class="token operator">*</span> <span class="token function">oldPtr</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const_cast</span><span class="token operator">&lt;</span>T<span class="token operator">*</span> <span class="token keyword">volatile</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPtr<span class="token punctuation">)</span> oldPtr<span class="token operator">-</span><span class="token operator">></span><span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_ptr <span class="token operator">=</span> other<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">void</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">force_set</span><span class="token punctuation">(</span>T<span class="token operator">*</span> other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    other<span class="token operator">-</span><span class="token operator">></span><span class="token function">forceIncStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_ptr <span class="token operator">=</span> other<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">void</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_ptr<span class="token operator">-</span><span class="token operator">></span><span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">void</span> sp<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">set_pointer</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m_ptr <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="小节"><a href="#小节" class="headerlink" title="小节"></a>小节</h3><p>可以看见，在wp和sp的体系中，这两者只做两件事情，持有对象引用，并且调用计数方法进行计数。而核心方法还是在weakref_type以及RefBase中。</p>
<p>接下来，我们要实现核心的计数方法。</p>
<h3 id="weakref-type的实现"><a href="#weakref-type的实现" class="headerlink" title="weakref_type的实现"></a>weakref_type的实现</h3><p>首先肯定有强弱引用的计数</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> INITIAL_STRONG_VALUE (1&lt;&lt;28)</span>

<span class="token keyword">class</span> <span class="token class-name">RefBase</span><span class="token operator">::</span>weakref_impl <span class="token operator">:</span> <span class="token keyword">public</span> RefBase<span class="token operator">::</span>weakref_type<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment" spellcheck="true">//强引用计数</span>
    std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>int32_t<span class="token operator">></span> mStrong<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//弱引用计数</span>
    std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>int32_t<span class="token operator">></span> mWeak<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//持有计数基础</span>
    RefBase<span class="token operator">*</span> <span class="token keyword">const</span> mBase<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//声明周期的标志位</span>
    std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>int32_t<span class="token operator">></span> mFlags<span class="token punctuation">;</span>


<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">explicit</span> <span class="token function">weakref_impl</span><span class="token punctuation">(</span>RefBase<span class="token operator">*</span> base<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">mStrong</span><span class="token punctuation">(</span>INITIAL_STRONG_VALUE<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">mWeak</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">mBase</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="RefBase的实现"><a href="#RefBase的实现" class="headerlink" title="RefBase的实现"></a>RefBase的实现</h3><h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><pre class="line-numbers language-cpp"><code class="language-cpp">RefBase<span class="token operator">::</span><span class="token function">RefBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">mRefs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">weakref_impl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="首先看看，增加引用指针计数。"><a href="#首先看看，增加引用指针计数。" class="headerlink" title="首先看看，增加引用指针计数。"></a>首先看看，增加引用指针计数。</h4><h5 id="增加强引用计数"><a href="#增加强引用计数" class="headerlink" title="增加强引用计数"></a>增加强引用计数</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RefBase<span class="token operator">::</span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>id<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    weakref_impl<span class="token operator">*</span> <span class="token keyword">const</span> refs <span class="token operator">=</span> mRefs<span class="token punctuation">;</span>
    refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">incWeak</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> int32_t c <span class="token operator">=</span> refs<span class="token operator">-</span><span class="token operator">></span>mStrong<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>std<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//说明不是第一次声明</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>c <span class="token operator">!=</span> INITIAL_STRONG_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    int32_t old __unused <span class="token operator">=</span> refs<span class="token operator">-</span><span class="token operator">></span>mStrong<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span>INITIAL_STRONG_VALUE<span class="token punctuation">,</span>std<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    refs<span class="token operator">-</span><span class="token operator">></span>mBase<span class="token operator">-</span><span class="token operator">></span><span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到的是，为了同步强引用和弱引用的次数，只要每一次增加一次强引用计数，就会增加弱引用次数。但是弱引用就不是如此，因此强引用的次数一定大于弱引用。</p>
<p>在这里面，强引用的计数次数会初始化为（1&lt;&lt;28）就是1向左移动28位。在32位的int中属于十分大的数字。</p>
<p>这么做的好处就是能够通过简单的加减就能知道是否是第一次。</p>
<p>考虑到指针为因为指针是32位，所以这个大数字没有可能被引用这么多次可能。因此只要判断加一前发现不是这个数字INITIAL_STRONG_VALUE，就能确定是不是第一次。从而判断是否调用onFirstRef。这个只有第一次初始化sp才会调用的方法，相当于sp中绑定的生命周期。</p>
<p>从这里就能知道Google工程师的功力深厚。</p>
<h5 id="增加弱引用计数"><a href="#增加弱引用计数" class="headerlink" title="增加弱引用计数"></a>增加弱引用计数</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RefBase<span class="token operator">::</span>weakref_type<span class="token operator">::</span><span class="token function">incWeak</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    weakref_impl<span class="token operator">*</span> <span class="token keyword">const</span> impl <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>weakref_impl<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> int32_t c __unused <span class="token operator">=</span> impl<span class="token operator">-</span><span class="token operator">></span>mWeak<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>
            std<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单没什么好聊的。</p>
<h4 id="减少引用计数"><a href="#减少引用计数" class="headerlink" title="减少引用计数"></a>减少引用计数</h4><p>减少引用计数，我们就必须要小心。因为这个控制着对象什么时候删除。以及存在的逻辑。</p>
<p>由于定义中sp能够使用对象，那么意味着，sp的强引用指针计数将会控制对象引用的声明周期。</p>
<p>注意到没有，在这个过程中，我们除了有对象的引用对象之外，还存在着一个用来统计强弱引用计数的weakref_type。这个对象也必须销毁。既然sp管理了愿对象，那么wp的引用计数就管理控制统计强弱引用计数的weakref_type声明周期。</p>
<p>因此，我们在减少的强引用计数的时候，要注意顺序。必须先减少强引用计数，再减少弱引用顺序。</p>
<h5 id="减少强引用指针的计数"><a href="#减少强引用指针的计数" class="headerlink" title="减少强引用指针的计数"></a>减少强引用指针的计数</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RefBase<span class="token operator">::</span><span class="token function">decStrong</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>id<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    weakref_impl<span class="token operator">*</span> <span class="token keyword">const</span>  refs <span class="token operator">=</span> mRefs<span class="token punctuation">;</span>
    <span class="token keyword">const</span> int32_t c <span class="token operator">=</span> refs<span class="token operator">-</span><span class="token operator">></span>mStrong<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        std<span class="token operator">::</span><span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
        refs<span class="token operator">-</span><span class="token operator">></span>mBase<span class="token operator">-</span><span class="token operator">></span><span class="token function">onLastStrongRef</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        int32_t flags <span class="token operator">=</span> refs<span class="token operator">-</span><span class="token operator">></span>mFlags<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>OBJECT_LIFETIME_WEAK<span class="token punctuation">)</span> <span class="token operator">==</span> OBJECT_LIFETIME_STRONG<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">decWeak</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到的是，此时减少一次强引用次数，当达到1了之后，说明不会再使用，就delete掉。当然源码里面还有一个flags字段，这个字段使用扩展sp和wp的生命周期的行为。默认就是OBJECT_LIFETIME_STRONG。</p>
<h5 id="减少弱引用计数"><a href="#减少弱引用计数" class="headerlink" title="减少弱引用计数"></a>减少弱引用计数</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RefBase<span class="token operator">::</span>weakref_type<span class="token operator">::</span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    weakref_impl<span class="token operator">*</span> <span class="token keyword">const</span> impl <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>weakref_impl<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> int32_t c <span class="token operator">=</span> impl<span class="token operator">-</span><span class="token operator">></span>mWeak<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span><span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token operator">::</span><span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    int32_t flags <span class="token operator">=</span> impl<span class="token operator">-</span><span class="token operator">></span>mFlags<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>OBJECT_LIFETIME_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> OBJECT_LIFETIME_STRONG<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>impl<span class="token operator">-</span><span class="token operator">></span>mStrong<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span>
        <span class="token operator">==</span> INITIAL_STRONG_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//说明强引用指针只是初始化</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//删除引用计数对象</span>
            <span class="token keyword">delete</span> impl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>
        impl<span class="token operator">-</span><span class="token operator">></span>mBase<span class="token operator">-</span><span class="token operator">></span><span class="token function">onLastWeakRef</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> impl<span class="token operator">-</span><span class="token operator">></span>mBase<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="智能指针其他细节"><a href="#智能指针其他细节" class="headerlink" title="智能指针其他细节"></a>智能指针其他细节</h3><p>当我们第一次升级sp的时候调用了一个特殊的引用次数增加的方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> RefBase<span class="token operator">::</span>weakref_type<span class="token operator">::</span><span class="token function">attemptIncStrong</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">incWeak</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    weakref_impl<span class="token operator">*</span><span class="token keyword">const</span> impl <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>weakref_impl<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    int32_t curCount <span class="token operator">=</span> impl<span class="token operator">-</span><span class="token operator">></span>mStrong<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//这种情况是有本已经有数据引用</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>curCount <span class="token operator">></span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span>curCount <span class="token operator">!=</span> INITIAL_STRONG_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//发现和原来相比大于1则退出循环</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>impl<span class="token operator">-</span><span class="token operator">></span>mStrong<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>curCount<span class="token punctuation">,</span>curCount<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>
                std<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//这种情况是初始化，或者已经被释放了</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>curCount<span class="token operator">&lt;=</span><span class="token number">0</span> <span class="token operator">||</span> curCount <span class="token operator">==</span> INITIAL_STRONG_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        int32_t flags <span class="token operator">=</span> impl<span class="token operator">-</span><span class="token operator">></span>mFlags<span class="token punctuation">.</span>
                <span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>OBJECT_LIFETIME_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> OBJECT_LIFETIME_STRONG<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//原来的强引用被释放</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>curCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">decWeak</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//初始化</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>curCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>impl<span class="token operator">-</span><span class="token operator">></span>mStrong<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>curCount<span class="token punctuation">,</span>
                        curCount<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>std<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>


            <span class="token comment" spellcheck="true">//promote 升级失败</span>
            <span class="token comment" spellcheck="true">//避免某些线程，又把当前的sp释放掉</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>curCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">decWeak</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//会判断当前是否是需要FIRST_INC_STRONG</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>impl<span class="token operator">-</span><span class="token operator">></span>mBase<span class="token operator">-</span><span class="token operator">></span><span class="token function">onIncStrongAttempted</span><span class="token punctuation">(</span>FIRST_INC_STRONG<span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">decWeak</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            curCount <span class="token operator">=</span> impl<span class="token operator">-</span><span class="token operator">></span>mStrong<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//如果已经初始化过了引用计数，则调用onLastStrongRef</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>curCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token operator">&amp;&amp;</span>curCount<span class="token operator">!=</span>INITIAL_STRONG_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
                impl<span class="token operator">-</span><span class="token operator">></span>mBase<span class="token operator">-</span><span class="token operator">></span><span class="token function">onLastStrongRef</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//如果在添加之前是INITIAL_STRONG_VALUE，说明是初始化，</span>
    <span class="token comment" spellcheck="true">// 需要减掉INITIAL_STRONG_VALUE，才是真正的计数</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>curCount <span class="token operator">==</span> INITIAL_STRONG_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        impl<span class="token operator">-</span><span class="token operator">></span>mStrong<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span>INITIAL_STRONG_VALUE<span class="token punctuation">,</span>std<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而每一次调用createWeak的方法只会增加一次计数</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">RefBase<span class="token operator">::</span>weakref_type <span class="token operator">*</span>RefBase<span class="token operator">::</span><span class="token function">createWeak</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>id<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    mRefs<span class="token operator">-</span><span class="token operator">></span><span class="token function">incWeak</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> mRefs<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试一下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token operator">:</span><span class="token keyword">public</span> RefBase<span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"PRINT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">incStrongPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">printSCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getStrongCount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token keyword">void</span> <span class="token function">testPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>Test<span class="token operator">></span> <span class="token function">s</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E6%B5%8B%E8%AF%95.png" alt="智能指针测试.png"><br>确实是正确的流程。</p>
<p>那么，我们试试，更加复杂的作用域操作。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">testPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>Test<span class="token operator">></span> s<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s<span class="token operator">-</span><span class="token operator">></span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"1 times:%d"</span><span class="token punctuation">,</span>s<span class="token operator">-</span><span class="token operator">></span><span class="token function">printSCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s<span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrongPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"2 times:%d"</span><span class="token punctuation">,</span>s<span class="token operator">-</span><span class="token operator">></span><span class="token function">printSCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"3 times:%d"</span><span class="token punctuation">,</span>s<span class="token operator">-</span><span class="token operator">></span><span class="token function">printSCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当我们在一个作用域内声明了一个Test的对象。按照道理会在这个作用域结束的时候析构。我们看看其能不能通过增加引用计数，来延长生命周期。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">testPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>Test<span class="token operator">></span> s1<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        sp<span class="token operator">&lt;</span>Test<span class="token operator">></span> s<span class="token punctuation">;</span>
        s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s<span class="token operator">-</span><span class="token operator">></span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"1 times:%d"</span><span class="token punctuation">,</span>s<span class="token operator">-</span><span class="token operator">></span><span class="token function">printSCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//s->incStrongPointer();</span>
        s1 <span class="token operator">=</span> s<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"2 times:%d"</span><span class="token punctuation">,</span>s1<span class="token operator">-</span><span class="token operator">></span><span class="token function">printSCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"3 times:%d"</span><span class="token punctuation">,</span>s1<span class="token operator">-</span><span class="token operator">></span><span class="token function">printSCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于s1来说作用域是整个方法，而对于s来说作用域就是在方法的打括号内。理论上，=的操作符会增加一次新的强引用指针，减少一次旧的引用指针，也就如下图。<br><img src="/images/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E8%AE%A1%E6%95%B0%E6%B5%8B%E8%AF%95.png" alt="智能指针计数测试.png"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>绘制一个UML图。<br><img src="/images/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88UML.png" alt="智能指针UML.png"></p>
<p>我们能够从UML中清晰的看到各自的职责。<br>weakref_type控制弱引用的计数方法，同时通过弱引用计数控制weakref_type的生命周期。</p>
<p>所以这就是为什么在上述的代码中，并没有直接在weakref声明一个方法，而是通过参数来设置。</p>
<p>其次在继承了RefBase的Object本身具备了增加减少强引用的方法。因为此时想要操作Object的时候已经默认是强引用指针引用状态。同时持有这weakref_impl去访问引用计数。</p>
<p>wp和sp都是持有一个引用原有Object的引用。管理操作符，构造函数，拷贝构造函数，操作符，来对传进来的Object控制其引用计数。</p>
<p>实际上，看到这个UML图，就感觉很简单了。</p>
<p>特别提一句，看到上面的用法之后，sp和wp是怎么限制其他人使用内部的指针的。</p>
<p>可以关注到sp，重写下面这个操作符。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">inline</span> T<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">*</span>m_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">inline</span> T<span class="token operator">*</span> <span class="token keyword">operator</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> m_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而wp没有重写这个操作符。因此sp才能操作得了sp持有的对象。</p>
<p>附上完整的代码的地址：<br><a href="https://github.com/yjy239/SmartTool">https://github.com/yjy239/SmartTool</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/07/14/mat-ji-ben-cao-zuo-yi-ji-hui-du-tu-zhuan-hua/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="OpenCV (一)Mat基本操作以及灰度图转化">
                        
                        <span class="card-title">OpenCV (一)Mat基本操作以及灰度图转化</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言开始写OpenCV这篇文章的时候，不由想到，我的大学计算机图形学的第一门实操课程就是灰度转化，拉普拉斯锐化等。其中灰度图的转化，是计算机图形学基础中基础，这里就顺着OpenCV的灰度的转化，来看看OpenCV一些基础的api。
本文地址
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-07-14
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/OpenCV/" class="post-category">
                                    OpenCV
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/音视频/">
                        <span class="chip bg-color">音视频</span>
                    </a>
                    
                    <a href="/tags/OpenCV/">
                        <span class="chip bg-color">OpenCV</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/06/22/androidstudio-cmakelist-de-zong-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="AndroidStudio CMakeList的总结">
                        
                        <span class="card-title">AndroidStudio CMakeList的总结</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                             如果遇到什么有问题的请在这里联系我：https://www.jianshu.com/p/445d5cbe166d
背景CMakeList这个东西对于所有的Linux，Android开发者都是很熟悉的东西。但是Android的Java应用开
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-06-22
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CMakeList/" class="post-category">
                                    CMakeList
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Linux/">
                        <span class="chip bg-color">Linux</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
