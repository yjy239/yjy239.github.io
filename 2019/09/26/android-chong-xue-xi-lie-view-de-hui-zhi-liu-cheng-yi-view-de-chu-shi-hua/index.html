<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 View的绘制流程 (一)View的初始化, Android | Linux | Flutter">
    <meta name="description" content="前言View的绘制流程这一篇文章其实十分不好写，因为在网上已经有千篇一律的文章，导致我一直不太想写这一篇文章。不过既然是Android重学系列，还是一步一脚印来分析分析里面的细节。如果对这个流程很熟悉的人来说，本文就没必要阅读了。如果不是很">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 View的绘制流程 (一)View的初始化 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/9.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 View的绘制流程 (一)View的初始化
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/View的绘制流程/" class="post-category">
                                View的绘制流程
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-09-26
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        7.1k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        32 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>View的绘制流程这一篇文章其实十分不好写，因为在网上已经有千篇一律的文章，导致我一直不太想写这一篇文章。不过既然是Android重学系列，还是一步一脚印来分析分析里面的细节。如果对这个流程很熟悉的人来说，本文就没必要阅读了。如果不是很熟悉的朋友可以阅读本文，看看系统上设计的优点以及可以优化的地方。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>在整个View的绘制流程中，从大的方向看来，大致上分为两部分：</p>
<ul>
<li>在Activity的onCreate生命周期，实例化所有的View。</li>
<li>Activity的onResume生命周期，测量，布局，绘制所有的View。</li>
</ul>
<p>暂时不去看Activity如何联通SurfaceFlinger，之后会有专门的专题再来聊聊。<br>那么Activity是怎么管理View的绘制的呢？接下来我们会以上面两点为线索来分析一下源码。</p>
<p>不过内容很多，本文集中重点聊聊view的实例化是怎么回事。</p>
<h3 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h3><ul>
<li>Activity的初始化与分层</li>
<li>LayoutInflater原理，以及思考</li>
<li>AsyncLayoutInflater的原理以及缺陷</li>
</ul>
<h2 id="Activity-onCreate的绑定"><a href="#Activity-onCreate的绑定" class="headerlink" title="Activity onCreate的绑定"></a>Activity onCreate的绑定</h2><p>其实Activity的生命周期仅仅只是管理着Activity这个对象的活跃状态，并没有真的去管理View，那么Activity是怎么通过管理View的绘制的呢？我们来看看在ActivityThread调用performLaunchActivity：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ActivityThread.java" target="_blank" rel="noopener">ActivityThread.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">                Window window <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>mPendingRemoveWindow <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>mPreserveWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    window <span class="token operator">=</span> r<span class="token punctuation">.</span>mPendingRemoveWindow<span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>mPendingRemoveWindow <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>mPendingRemoveWindowManager <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                activity<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>ident<span class="token punctuation">,</span> app<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> title<span class="token punctuation">,</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>embeddedID<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastNonConfigurationInstances<span class="token punctuation">,</span> config<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span> r<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> window<span class="token punctuation">,</span> r<span class="token punctuation">.</span>configCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个步骤中，对着实例化的Activity做了一次绑定操作。具体做什么呢？</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ActivityThread aThread<span class="token punctuation">,</span>
            Instrumentation instr<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span> <span class="token keyword">int</span> ident<span class="token punctuation">,</span>
            Application application<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span> ActivityInfo info<span class="token punctuation">,</span>
            CharSequence title<span class="token punctuation">,</span> Activity parent<span class="token punctuation">,</span> String id<span class="token punctuation">,</span>
            NonConfigurationInstances lastNonConfigurationInstances<span class="token punctuation">,</span>
            Configuration config<span class="token punctuation">,</span> String referrer<span class="token punctuation">,</span> IVoiceInteractor voiceInteractor<span class="token punctuation">,</span>
            Window window<span class="token punctuation">,</span> ActivityConfigCallback activityConfigCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">attachBaseContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mFragments<span class="token punctuation">.</span><span class="token function">attachHost</span><span class="token punctuation">(</span>null <span class="token comment" spellcheck="true">/*parent*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhoneWindow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> window<span class="token punctuation">,</span> activityConfigCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWindow<span class="token punctuation">.</span><span class="token function">setWindowControllerCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWindow<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWindow<span class="token punctuation">.</span><span class="token function">setOnWindowDismissedCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWindow<span class="token punctuation">.</span><span class="token function">getLayoutInflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPrivateFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>softInputMode <span class="token operator">!=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>SOFT_INPUT_STATE_UNSPECIFIED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mWindow<span class="token punctuation">.</span><span class="token function">setSoftInputMode</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>softInputMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mUiThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mMainThread <span class="token operator">=</span> aThread<span class="token punctuation">;</span>
        mInstrumentation <span class="token operator">=</span> instr<span class="token punctuation">;</span>
        mToken <span class="token operator">=</span> token<span class="token punctuation">;</span>
        mIdent <span class="token operator">=</span> ident<span class="token punctuation">;</span>
        mApplication <span class="token operator">=</span> application<span class="token punctuation">;</span>
        mIntent <span class="token operator">=</span> intent<span class="token punctuation">;</span>
        mReferrer <span class="token operator">=</span> referrer<span class="token punctuation">;</span>
        mComponent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mActivityInfo <span class="token operator">=</span> info<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mWindow<span class="token punctuation">.</span><span class="token function">setWindowManager</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span>WindowManager<span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>WINDOW_SERVICE<span class="token punctuation">)</span><span class="token punctuation">,</span>
                mToken<span class="token punctuation">,</span> mComponent<span class="token punctuation">.</span><span class="token function">flattenToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ActivityInfo<span class="token punctuation">.</span>FLAG_HARDWARE_ACCELERATED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mParent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mWindow<span class="token punctuation">.</span><span class="token function">setContainer</span><span class="token punctuation">(</span>mParent<span class="token punctuation">.</span><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mWindowManager <span class="token operator">=</span> mWindow<span class="token punctuation">.</span><span class="token function">getWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCurrentConfig <span class="token operator">=</span> config<span class="token punctuation">;</span>

        mWindow<span class="token punctuation">.</span><span class="token function">setColorMode</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>colorMode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在attach中实际上最为重要的工作就是实例化一个PhoneWindow对象，并且把当前Phone相关的监听，如点击事件的回调，窗体消失的回调等等。</p>
<p>并且把ActivityThread，ActivityInfo，Application等重要的信息绑定到当前的Activity。</p>
<p>从上一个专栏WMS，就能知道，实际上承载视图真正的对象实际上是Window窗口。那么这个Window对象又是什么做第一次的视图加载呢？</p>
<p>其实是调用了我们及其熟悉的api：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@LayoutRes</span> <span class="token keyword">int</span> layoutResID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContentView</span><span class="token punctuation">(</span>layoutResID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initWindowDecorActionBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个api中设置了PhoneWindow的内容视图区域。这也是每一个Android开发的接触到的第一个api。因为其至关重要承载了Android接下来要显示什么内容。</p>
<p>接下来我们很容易想到setContentView究竟做了什么事情，来初始化所有的View对象。</p>
<h3 id="PhoneWindow-setContentView"><a href="#PhoneWindow-setContentView" class="headerlink" title="PhoneWindow.setContentView"></a>PhoneWindow.setContentView</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/com/android/internal/" target="_blank" rel="noopener">internal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/com/android/internal/policy/" target="_blank" rel="noopener">policy</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java" target="_blank" rel="noopener">PhoneWindow.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token keyword">int</span> layoutResID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mContentParent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">installDecor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasFeature</span><span class="token punctuation">(</span>FEATURE_CONTENT_TRANSITIONS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasFeature</span><span class="token punctuation">(</span>FEATURE_CONTENT_TRANSITIONS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mLayoutInflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>layoutResID<span class="token punctuation">,</span> mContentParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mContentParent<span class="token punctuation">.</span><span class="token function">requestApplyInsets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Callback cb <span class="token operator">=</span> <span class="token function">getCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cb <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cb<span class="token punctuation">.</span><span class="token function">onContentChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mContentParentExplicitlySet <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们这里只关注核心逻辑。能看到当mContentParent为空的时候，会调用installDecor生成一个父容器，最终会通过我们另一个熟悉的函数LayoutInflater.inflate把所有的View都实例化出来。</p>
<p>那么同理，我们把整个步骤分为2部分：</p>
<ul>
<li>1.installDecor生成DecorView安装在FrameLayout作为所有View的顶层View</li>
<li>2.LayoutInflater.inflate 实例化传进来的内容。</li>
</ul>
<h3 id="installDecor生成DecorView作为所有View的顶层View"><a href="#installDecor生成DecorView作为所有View的顶层View" class="headerlink" title="installDecor生成DecorView作为所有View的顶层View"></a>installDecor生成DecorView作为所有View的顶层View</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installDecor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mForceDecorInstall <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDecor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//核心事件1</span>
            mDecor <span class="token operator">=</span> <span class="token function">generateDecor</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mDecor<span class="token punctuation">.</span><span class="token function">setDescendantFocusability</span><span class="token punctuation">(</span>ViewGroup<span class="token punctuation">.</span>FOCUS_AFTER_DESCENDANTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mDecor<span class="token punctuation">.</span><span class="token function">setIsRootNamespace</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInvalidatePanelMenuPosted <span class="token operator">&amp;&amp;</span> mInvalidatePanelMenuFeatures <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mDecor<span class="token punctuation">.</span><span class="token function">postOnAnimation</span><span class="token punctuation">(</span>mInvalidatePanelMenuRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mDecor<span class="token punctuation">.</span><span class="token function">setWindow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mContentParent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//核心事件二</span>
            mContentParent <span class="token operator">=</span> <span class="token function">generateLayout</span><span class="token punctuation">(</span>mDecor<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Set up decor part of UI to ignore fitsSystemWindows if appropriate.</span>
            mDecor<span class="token punctuation">.</span><span class="token function">makeOptionalFitsSystemWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> DecorContentParent decorContentParent <span class="token operator">=</span> <span class="token punctuation">(</span>DecorContentParent<span class="token punctuation">)</span> mDecor<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>
                    R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>decor_content_parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>decorContentParent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mDecor<span class="token punctuation">.</span><span class="token function">getBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> mBackgroundFallbackResource <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mDecor<span class="token punctuation">.</span><span class="token function">setBackgroundFallback</span><span class="token punctuation">(</span>mBackgroundFallbackResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Only inflate or create a new TransitionManager if the caller hasn't</span>
            <span class="token comment" spellcheck="true">// already set a custom one.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasFeature</span><span class="token punctuation">(</span>FEATURE_ACTIVITY_TRANSITIONS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们抽出核心逻辑看看这个installDecor做的事情实际上很简单：</p>
<ul>
<li>1.generateDecor生成DecorView</li>
<li>2.generateLayout 获取DecorView中的内容区域</li>
<li>3.寻找DecorView中的DecorContentParent处理PanelMenu等系统内置的挂在view。</li>
<li>4.处理专场动画。</li>
</ul>
<p>我们只需要把关注点放在头两项。这两个才是本文的重点。第四项的处理实际上是处理</p>
<h4 id="generateDecor生成DecorView"><a href="#generateDecor生成DecorView" class="headerlink" title="generateDecor生成DecorView"></a>generateDecor生成DecorView</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> DecorView <span class="token function">generateDecor</span><span class="token punctuation">(</span><span class="token keyword">int</span> featureId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// System process doesn't have application context and in that case we need to directly use</span>
        <span class="token comment" spellcheck="true">// the context we have. Otherwise we want the application context, so we don't cling to the</span>
        <span class="token comment" spellcheck="true">// activity.</span>
        Context context<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mUseDecorContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Context applicationContext <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationContext <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                context <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecorContext</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mTheme <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    context<span class="token punctuation">.</span><span class="token function">setTheme</span><span class="token punctuation">(</span>mTheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            context <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DecorView</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> featureId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到里面十分简单，声明DecorContext，注入到DecorView。如果处理著名的键盘内存泄漏的时候，把打印打开，当切换到另一个Activity的时候，就会看到这个这个Context。</p>
<p>在Android系统看来DecorView必须拥有自己的Context的原因是，DecorView是系统自己的服务，因此需要做Context的隔离。不过虽然是系统服务，但是还是添加到我们的View当中。</p>
<h4 id="generateLayout-获取DecorView中的内容区域"><a href="#generateLayout-获取DecorView中的内容区域" class="headerlink" title="generateLayout 获取DecorView中的内容区域"></a>generateLayout 获取DecorView中的内容区域</h4><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">protected</span> ViewGroup <span class="token function">generateLayout</span><span class="token punctuation">(</span>DecorView decor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Apply data from current theme.</span>

        TypedArray a <span class="token operator">=</span> <span class="token function">getWindowStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//获取当前窗体所有的标志位</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true">//根据标志位做初步处理，如背景</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// 根据标志位设置资源id</span>
        <span class="token keyword">int</span> layoutResource<span class="token punctuation">;</span>
        <span class="token keyword">int</span> features <span class="token operator">=</span> <span class="token function">getLocalFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// System.out.println("Features: 0x" + Integer.toHexString(features));</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>features <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> FEATURE_SWIPE_TO_DISMISS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>features <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> FEATURE_LEFT_ICON<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> FEATURE_RIGHT_ICON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>features <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> FEATURE_PROGRESS<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> FEATURE_INDETERMINATE_PROGRESS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>features <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> FEATURE_ACTION_BAR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>features <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> FEATURE_CUSTOM_TITLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>features <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> FEATURE_NO_TITLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>features <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> FEATURE_ACTION_MODE_OVERLAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            layoutResource <span class="token operator">=</span> R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>screen_simple_overlay_action_mode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Embedded, so no decoration is needed.</span>
            layoutResource <span class="token operator">=</span> R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>screen_simple<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// System.out.println("Simple!");</span>
        <span class="token punctuation">}</span>

        mDecor<span class="token punctuation">.</span><span class="token function">startChanging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDecor<span class="token punctuation">.</span><span class="token function">onResourcesLoaded</span><span class="token punctuation">(</span>mLayoutInflater<span class="token punctuation">,</span> layoutResource<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ViewGroup contentParent <span class="token operator">=</span> <span class="token punctuation">(</span>ViewGroup<span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span>ID_ANDROID_CONTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>contentParent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Window couldn't find content container view"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> contentParent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里做的事情如下：</p>
<ul>
<li>1.获取设置在xml中的窗体style，设置相应的标志位如mFloat等</li>
<li>2.获取DecorView窗体的属性，进一步处理一些背景，根据当前的Android版本，style重新设置窗体的属性，以供后面使用。</li>
<li>3.根据上面设置的标志位设置合适的窗体资源</li>
<li>4.获取ID_ANDROID_CONTENT中的内容区域。</li>
</ul>
<p>假如，我们当前使用的是最普通的状态，将会加载R.layout.screen_simple;资源文件到DecorView中，当实例化好当前的xml资源之后，将会从DecorView找到我们的内容区域部分。</p>
<p>我们看看screen_simple是什么东西：</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>fitsSystemWindows</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ViewStub</span> <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/action_mode_bar_stub<span class="token punctuation">"</span></span>
              <span class="token attr-name"><span class="token namespace">android:</span>inflatedId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/action_mode_bar<span class="token punctuation">"</span></span>
              <span class="token attr-name"><span class="token namespace">android:</span>layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@layout/action_mode_bar<span class="token punctuation">"</span></span>
              <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
              <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
              <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>?attr/actionBarTheme<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FrameLayout</span>
         <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@android:id/content<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">android:</span>foregroundInsidePadding</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">android:</span>foregroundGravity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fill_horizontal|top<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">android:</span>foreground</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>?android:attr/windowContentOverlay<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这是一个LinearLayout包裹着的一个FrameLayout。把当前的View设置一个windowContentOverlay属性。这个属性可以在Activity生成之后，渲染速度太慢可以设置成白色透明或者图片。一个ViewStub用来优化显示actionbar</p>
<p>和startingWindow有本质上的区别，startingWindow的出现是为了处理还没有进入Activity，绘制在屏幕的窗体，同时还能获取之前保留下来的屏幕像素渲染在上面。是一个优化显示体验的设计。</p>
<p>最后找到这个id为content的内容区域返回回去。</p>
<p>这样我们就知道网上那个Android的显示区域划分图是怎么来的。<br><img src="/images/Android%E6%98%BE%E7%A4%BAView%E7%9A%84%E6%9E%84%E6%88%90.jpeg" alt="Android显示View的构成.png"></p>
<p>如果我们把对象考虑进来大致上是如此：<br><img src="/images/%E5%AF%B9%E8%B1%A1%E5%8C%85%E5%90%AB%E5%9B%BE.jpeg" alt="对象包含图.png"></p>
<h3 id="LayoutInflater-inflate实例化所有内容视图"><a href="#LayoutInflater-inflate实例化所有内容视图" class="headerlink" title="LayoutInflater.inflate实例化所有内容视图"></a>LayoutInflater.inflate实例化所有内容视图</h3><p>核心代码如下：</p>
<pre class="line-numbers language-java"><code class="language-java">mLayoutInflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>layoutResID<span class="token punctuation">,</span> mContentParent<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>实际上对于Android开发来说，这个api也熟悉的不能再熟悉了。我们看看LayoutInflater常用的用法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> LayoutInflater <span class="token function">from</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LayoutInflater LayoutInflater <span class="token operator">=</span>
                <span class="token punctuation">(</span>LayoutInflater<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>LAYOUT_INFLATER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>LayoutInflater <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token string">"LayoutInflater not found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> LayoutInflater<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以去结合我上一个专栏的WMS的getSystemService分析。实际上在这里面LayoutInflater是一个全局单例。为什么一定要设计为单例这是有原因的。看到后面就知道为什么了。</p>
<h4 id="LayoutInflater-inflate原理"><a href="#LayoutInflater-inflate原理" class="headerlink" title="LayoutInflater.inflate原理"></a>LayoutInflater.inflate原理</h4><p>接下来我们把注意力转移到inflater如何实例化view上面：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> View <span class="token function">inflate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@LayoutRes</span> <span class="token keyword">int</span> resource<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ViewGroup root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">inflate</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> root<span class="token punctuation">,</span> root <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> View <span class="token function">inflate</span><span class="token punctuation">(</span>XmlPullParser parser<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ViewGroup root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">inflate</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> root<span class="token punctuation">,</span> root <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> View <span class="token function">inflate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@LayoutRes</span> <span class="token keyword">int</span> resource<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ViewGroup root<span class="token punctuation">,</span> <span class="token keyword">boolean</span> attachToRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> Resources res <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"INFLATING from resource: \""</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">getResourceName</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\" ("</span>
                    <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> XmlResourceParser parser <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getLayout</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">inflate</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> root<span class="token punctuation">,</span> attachToRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            parser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们常用的LayoutInflater其实有三种方式，最后都会调用三个参数的inflate方法。<br>分为2个步骤</p>
<ul>
<li>1.首先先通过Resource获取XmlResourceParser的解析器</li>
<li>2.inflate按照解析器实例化View。</li>
</ul>
<p>换句话说，为了弄清楚View怎么实例化这个流程，我们必须看Android是怎么获取资源的。</p>
<h4 id="Resource解析xml"><a href="#Resource解析xml" class="headerlink" title="Resource解析xml"></a>Resource解析xml</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> XmlResourceParser <span class="token function">getLayout</span><span class="token punctuation">(</span><span class="token annotation punctuation">@LayoutRes</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">"layout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    XmlResourceParser <span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@AnyRes</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> String type<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> TypedValue value <span class="token operator">=</span> <span class="token function">obtainTempTypedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ResourcesImpl impl <span class="token operator">=</span> mResourcesImpl<span class="token punctuation">;</span>
            impl<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>type <span class="token operator">==</span> TypedValue<span class="token punctuation">.</span>TYPE_STRING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> impl<span class="token punctuation">.</span><span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>string<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span>
                        value<span class="token punctuation">.</span>assetCookie<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token string">"Resource ID #0x"</span> <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">" type #0x"</span> <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is not valid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">releaseTempTypedValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时是通过loadXmlResourceParser来告诉底层解析的是Layout资源。能看到此时会把工作交给ResourcesImpl和AssetManager去完成。这个类如果看过我的文章的朋友就很熟悉了，这两个类就是Java层加载资源的核心类，当我们做插件化的时候，是不可避免的接触这个类。</p>
<p>经过的方法，大致上我们把资源读取的步骤分为3部分：</p>
<ul>
<li>1.获取TypedValue</li>
<li>2.读取资源文件，生成保存着xml解析内容的对象</li>
<li>3.释放掉TypedValue</li>
</ul>
<p>这个步骤和我们平时开发自定义View设置自定义属性的时候何其相似，都是通过obtainStyledAttributes打开TypeArray，读取其中的数据，最后关闭TypeArray。</p>
<p>这背后隐藏这什么玄机呢？我们之后会有文章专门探索，我们不要打断当前的思绪。</p>
<h4 id="inflate解析Xml解析器中的数据"><a href="#inflate解析Xml解析器中的数据" class="headerlink" title="inflate解析Xml解析器中的数据"></a>inflate解析Xml解析器中的数据</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> View <span class="token function">inflate</span><span class="token punctuation">(</span>XmlPullParser parser<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ViewGroup root<span class="token punctuation">,</span> <span class="token keyword">boolean</span> attachToRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mConstructorArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_VIEW<span class="token punctuation">,</span> <span class="token string">"inflate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> Context inflaterContext <span class="token operator">=</span> mContext<span class="token punctuation">;</span>
            <span class="token keyword">final</span> AttributeSet attrs <span class="token operator">=</span> Xml<span class="token punctuation">.</span><span class="token function">asAttributeSet</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Context lastContext <span class="token operator">=</span> <span class="token punctuation">(</span>Context<span class="token punctuation">)</span> mConstructorArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            mConstructorArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> inflaterContext<span class="token punctuation">;</span>
            View result <span class="token operator">=</span> root<span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Look for the root node.</span>
                <span class="token keyword">int</span> type<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>START_TAG <span class="token operator">&amp;&amp;</span>
                        type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Empty</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>START_TAG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InflateException</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">": No start tag found!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> String name <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>TAG_MERGE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>attachToRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InflateException</span><span class="token punctuation">(</span><span class="token string">"&lt;merge /> can be used only with a valid "</span>
                                <span class="token operator">+</span> <span class="token string">"ViewGroup root and attachToRoot=true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token function">rInflate</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> root<span class="token punctuation">,</span> inflaterContext<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Temp is the root view that was found in the xml</span>
                    <span class="token keyword">final</span> View temp <span class="token operator">=</span> <span class="token function">createViewFromTag</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> name<span class="token punctuation">,</span> inflaterContext<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    ViewGroup<span class="token punctuation">.</span>LayoutParams params <span class="token operator">=</span> null<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Create layout params that match root, if supplied</span>
                        params <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">generateLayoutParams</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>attachToRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            temp<span class="token punctuation">.</span><span class="token function">setLayoutParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">rInflateChildren</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">// We are supposed to attach all the views we found (int temp)</span>
                    <span class="token comment" spellcheck="true">// to root. Do that now.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> attachToRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        root<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>attachToRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        result <span class="token operator">=</span> temp<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XmlPullParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Don't retain static reference on context.</span>
                mConstructorArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> lastContext<span class="token punctuation">;</span>
                mConstructorArgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>

                Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_VIEW<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这我们就能看到是否添加父布局以及是否绑定父布局之间的差别了。</p>
<p>首先不断的从xml的头部开始查找(第一个“&lt;”)，直到找到第一个view的进行解析。接下来就分为两个路线：</p>
<ul>
<li>1.此时xml布局使用了merge优化，调用rInflate。请注意直接使用LayoutInflate实例化merge标签，请设置根布局不然会报错。</li>
<li>2.xml是普通的布局，调用rInflateChildren</li>
</ul>
<p>先来看看第二种不普通情况，在没有merge布局的情况：</p>
<ul>
<li>1.先通过createViewFromTag实例化对应的view。</li>
<li>2.接着根据查看当前有没有root需要绑定的父布局，如果有，则获取根布局的generLayout：<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> LayoutParams <span class="token function">generateLayoutParams</span><span class="token punctuation">(</span>AttributeSet attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LayoutParams</span><span class="token punctuation">(</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
根据xml当前标签的属性生成适配根布局的LayoutParams。</li>
</ul>
<p>attachToRoot如果为true，则会直接添加到根布局中。</p>
<ul>
<li>3.rInflateChildren继续解析当前布局下的根布局，进入递归。</li>
</ul>
<p><strong>这也解释了三个inflate方法之间的区别，带着根部布局参数的inflate能够将当前根部的标签的参数生成一个适配根部LayoutParams，也就保留了根部布局的属性。而最后一个bool仅仅是代表用不用系统自动帮你添加到根布局中</strong></p>
<p>在这里面有一个核心的函数createViewFromTag，这是就是如何创建View的核心。</p>
<h4 id="createViewFromTag创建View"><a href="#createViewFromTag创建View" class="headerlink" title="createViewFromTag创建View"></a>createViewFromTag创建View</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> View <span class="token function">createViewFromTag</span><span class="token punctuation">(</span>View parent<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> Context context<span class="token punctuation">,</span> AttributeSet attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">createViewFromTag</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    View <span class="token function">createViewFromTag</span><span class="token punctuation">(</span>View parent<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> Context context<span class="token punctuation">,</span> AttributeSet attrs<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> ignoreThemeAttr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"view"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            name <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Apply a theme wrapper, if allowed and one is specified.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ignoreThemeAttr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> TypedArray ta <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">obtainStyledAttributes</span><span class="token punctuation">(</span>attrs<span class="token punctuation">,</span> ATTRS_THEME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> themeResId <span class="token operator">=</span> ta<span class="token punctuation">.</span><span class="token function">getResourceId</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>themeResId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextThemeWrapper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> themeResId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ta<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_1995<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Let's party like it's 1995!</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BlinkLayout</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            View view<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mFactory2 <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                view <span class="token operator">=</span> mFactory2<span class="token punctuation">.</span><span class="token function">onCreateView</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mFactory <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                view <span class="token operator">=</span> mFactory<span class="token punctuation">.</span><span class="token function">onCreateView</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                view <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> mPrivateFactory <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                view <span class="token operator">=</span> mPrivateFactory<span class="token punctuation">.</span><span class="token function">onCreateView</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> Object lastContext <span class="token operator">=</span> mConstructorArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                mConstructorArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        view <span class="token operator">=</span> <span class="token function">onCreateView</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> name<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        view <span class="token operator">=</span> <span class="token function">createView</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> null<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    mConstructorArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> lastContext<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> view<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InflateException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上这里面很简单和很巧妙，也能发现Android 中的新特性。</p>
<ul>
<li><p>1.如果标签直接是view，则直接获取xml标签中系统中class的属性，这样就能找到view对应的类名。</p>
</li>
<li><p>2.如果name是blink，则创建一个深度链接的布局</p>
</li>
<li><p>3.通过三层的Factory拦截view的创建，分别是Factory，Factory2，privateFactory。</p>
</li>
<li><p>4.如果经过上层由用户或者系统定义的特殊view的生成拦截没有生成，则会判断当前的标签名又没有”.”。有“.”说明是自定义view，没有说明是系统控件。</p>
</li>
<li><p>1.系统控件调用onCreateView创建View。</p>
</li>
<li><p>2.自定义View调用createView创建View。</p>
</li>
</ul>
<p>在继续下一步之前，让我们把目光放回系统生成LayoutInflater的方法中，看看生成LayoutInflater有什么猫腻？<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/SystemServiceRegistry.java" target="_blank" rel="noopener">SystemServiceRegistry.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token function">registerService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>LAYOUT_INFLATER_SERVICE<span class="token punctuation">,</span> LayoutInflater<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">CachedServiceFetcher</span><span class="token operator">&lt;</span>LayoutInflater<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> LayoutInflater <span class="token function">createService</span><span class="token punctuation">(</span>ContextImpl ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PhoneLayoutInflater</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">getOuterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到系统初期实例化的是一个PhoneLayoutInflater，并非是一个普通的LayoutInflater，而这个类重载了一个很重要的方法：<br>文件：<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/com/android/internal/policy/PhoneLayoutInflater.java" target="_blank" rel="noopener">http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/com/android/internal/policy/PhoneLayoutInflater.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> sClassPrefixList <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//常用控件</span>
        <span class="token string">"android.widget."</span><span class="token punctuation">,</span>
<span class="token comment" spellcheck="true">//一般指WebView</span>
        <span class="token string">"android.webkit."</span><span class="token punctuation">,</span>
<span class="token comment" spellcheck="true">//一般指Fragment</span>
        <span class="token string">"android.app."</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span> <span class="token keyword">protected</span> View <span class="token function">onCreateView</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> AttributeSet attrs<span class="token punctuation">)</span> <span class="token keyword">throws</span> ClassNotFoundException <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String prefix <span class="token operator">:</span> sClassPrefixList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                View view <span class="token operator">=</span> <span class="token function">createView</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> view<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// In this case we want to let the base class take a crack</span>
                <span class="token comment" spellcheck="true">// at it.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreateView</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这样就手动为View添加了前缀，还是调用了createView创建View。举个例子，如果是一个Linearlayout，就会为这个标签添加android.widget.前缀，称为android.widget.Linearlayout。这样就能找到相对完整的类名。</p>
<h4 id="createView创建View的核心动作"><a href="#createView创建View的核心动作" class="headerlink" title="createView创建View的核心动作"></a>createView创建View的核心动作</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> View <span class="token function">createView</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> String prefix<span class="token punctuation">,</span> AttributeSet attrs<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> ClassNotFoundException<span class="token punctuation">,</span> InflateException <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//所有view对应构造函数</span>
        Constructor<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">View</span><span class="token operator">></span> constructor <span class="token operator">=</span> sConstructorMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>constructor <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">verifyClassLoader</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            constructor <span class="token operator">=</span> null<span class="token punctuation">;</span>
            sConstructorMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">View</span><span class="token operator">></span> clazz <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_VIEW<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>constructor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Class not found in the cache, see if it's real, and try to add it</span>
                clazz <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>
                        prefix <span class="token operator">!=</span> null <span class="token operator">?</span> <span class="token punctuation">(</span>prefix <span class="token operator">+</span> name<span class="token punctuation">)</span> <span class="token operator">:</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asSubclass</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mFilter <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> clazz <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">boolean</span> allowed <span class="token operator">=</span> mFilter<span class="token punctuation">.</span><span class="token function">onLoadClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">failNotAllowed</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                constructor <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>mConstructorSignature<span class="token punctuation">)</span><span class="token punctuation">;</span>
                constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sConstructorMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// If we have a filter, apply it to cached constructor</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mFilter <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Have we seen this name before?</span>
                    Boolean allowedState <span class="token operator">=</span> mFilterMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>allowedState <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// New class -- remember whether it is allowed</span>
                        clazz <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>
                                prefix <span class="token operator">!=</span> null <span class="token operator">?</span> <span class="token punctuation">(</span>prefix <span class="token operator">+</span> name<span class="token punctuation">)</span> <span class="token operator">:</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asSubclass</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">boolean</span> allowed <span class="token operator">=</span> clazz <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mFilter<span class="token punctuation">.</span><span class="token function">onLoadClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mFilterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> allowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">failNotAllowed</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>allowedState<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">failNotAllowed</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            Object lastContext <span class="token operator">=</span> mConstructorArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mConstructorArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Fill in the context if not already within inflation.</span>
                mConstructorArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> mContext<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> mConstructorArgs<span class="token punctuation">;</span>
            args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> attrs<span class="token punctuation">;</span>

            <span class="token keyword">final</span> View view <span class="token operator">=</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token keyword">instanceof</span> <span class="token class-name">ViewStub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Use the same context when inflating ViewStub later.</span>
                <span class="token keyword">final</span> ViewStub viewStub <span class="token operator">=</span> <span class="token punctuation">(</span>ViewStub<span class="token punctuation">)</span> view<span class="token punctuation">;</span>
                viewStub<span class="token punctuation">.</span><span class="token function">setLayoutInflater</span><span class="token punctuation">(</span><span class="token function">cloneInContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Context<span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mConstructorArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> lastContext<span class="token punctuation">;</span>
            <span class="token keyword">return</span> view<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_VIEW<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上我们能够看到在实例化View有一个关键的数据结构：sConstructorMap.</p>
<p>这个数据结构保存着app应用内所有实例化过的View对应的构造函数。主要经过存储一次，就以name为key存储对应的构造函数，就不用一直反射获取了。</p>
<p>实际上这段代码就是做这个事情：</p>
<ul>
<li>1.当从name找构造函数，找的到，就直接通过构造函数实例化</li>
<li>2.没有找到构造函数，则通过prefix+name的方式查找类的构造函数，接着再实例化。</li>
</ul>
<p><strong>这也解释了为什么LayoutInflater一定要做成全局单例的方式，原因很简单就是为了加速view实例化的过程，共用反射的构造函数的缓存。</strong></p>
<h4 id="View布局优化细节"><a href="#View布局优化细节" class="headerlink" title="View布局优化细节"></a>View布局优化细节</h4><ul>
<li>当然也能看到ViewStub实际上在这里面没有做太多事情，把当前的Layoutflater复制一份进去，延后实例化里面的View。</li>
<li>merge优化原理，也能明白了，实际上在正常的分支会直接实例化一个View之后再添加，接着递归子view继续添加当前的View。而merge则是跳出第一次实例化View步骤，直接进入递归。</li>
</ul>
<p>merge能做到什么事情呢？我当然知道是压缩层级？一般是压缩include标签的层级。</p>
<p>这里就解释了怎么压缩层级。换句话说，我们使用merge的时候完全不用添加父布局，直接用merge标签包裹子view即可，当我们不能预览，在merge上添加parentTag即可。</p>
<p>举个例子：</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FrameLayout</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@layout/layout2<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FrameLayout</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>layout2.xml:</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>merge</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>merge</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>合并之后就是如下：</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FrameLayout</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FrameLayout</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果把include作为根布局呢？很明显会找不到android.view.include这个文件。</p>
<h3 id="rInflate递归解析View"><a href="#rInflate递归解析View" class="headerlink" title="rInflate递归解析View"></a>rInflate递归解析View</h3><p>当我们生成View之后，就需要继续递归子View，让我们看看其核心逻辑是什么。</p>
<p>能看到无论是是走merge分支还是正常解析分支也好，本质上都会调用到rInflate这个方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">rInflateChildren</span><span class="token punctuation">(</span>XmlPullParser parser<span class="token punctuation">,</span> View parent<span class="token punctuation">,</span> AttributeSet attrs<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> finishInflate<span class="token punctuation">)</span> <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
        <span class="token function">rInflate</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> parent<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> finishInflate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">rInflate</span><span class="token punctuation">(</span>XmlPullParser parser<span class="token punctuation">,</span> View parent<span class="token punctuation">,</span> Context context<span class="token punctuation">,</span>
            AttributeSet attrs<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finishInflate<span class="token punctuation">)</span> <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> depth <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> type<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> pendingRequestFocus <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span>
                parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> depth<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>START_TAG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> String name <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>TAG_REQUEST_FOCUS<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pendingRequestFocus <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token function">consumeChildElements</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>TAG_TAG<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">parseViewTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>TAG_INCLUDE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InflateException</span><span class="token punctuation">(</span><span class="token string">"&lt;include /> cannot be the root element"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">parseInclude</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> context<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>TAG_MERGE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InflateException</span><span class="token punctuation">(</span><span class="token string">"&lt;merge /> must be the root element"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> View view <span class="token operator">=</span> <span class="token function">createViewFromTag</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> ViewGroup viewGroup <span class="token operator">=</span> <span class="token punctuation">(</span>ViewGroup<span class="token punctuation">)</span> parent<span class="token punctuation">;</span>
                <span class="token keyword">final</span> ViewGroup<span class="token punctuation">.</span>LayoutParams params <span class="token operator">=</span> viewGroup<span class="token punctuation">.</span><span class="token function">generateLayoutParams</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">rInflateChildren</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> view<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                viewGroup<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingRequestFocus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parent<span class="token punctuation">.</span><span class="token function">restoreDefaultFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>finishInflate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parent<span class="token punctuation">.</span><span class="token function">onFinishInflate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在一段代码就是不断循环当前的当前xml的节点解析内部的标签，直到到了标签的末尾(“/&gt;”)<br>分为如下几个分支：</p>
<ul>
<li>1.如果发现需要requestFoucs，则设置当前view标志为聚焦</li>
<li>2.如果发现标签是include，则调用parseInclude，解开include内部的layout进行解析。</li>
<li>3.标签是tag，则保存tag中的内容</li>
<li>4.发现标签是merge则报错</li>
<li>5.其他情况，如正常一般，会正常生成View，并且添加当前的父布局中。</li>
</ul>
<p>最后会回调onFinishInflate监听。</p>
<h3 id="LayoutInflater-Factory的妙用"><a href="#LayoutInflater-Factory的妙用" class="headerlink" title="LayoutInflater Factory的妙用"></a>LayoutInflater Factory的妙用</h3><p>或许有人会觉得LayoutInflater中设置Factory干什么的？实际上这个Factory到处有在用，只是我们没有注意到过而已。</p>
<p>举一个例子，肯定有人注意过吧。当我们使用AppCompatActivity的时候，如果打印或者打断点，会发现内部的ImageView这些view，会被替换掉，变成AppCompat开头的view，如AppCompatImageView。</p>
<p>我们来看看AppCompatActivity的onCreate方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> AppCompatDelegate delegate <span class="token operator">=</span> <span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delegate<span class="token punctuation">.</span><span class="token function">installViewFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delegate<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上AppCompatDelegate本质上是AppCompatDelegateImpl，在这个类中调用了installViewFactory的方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">installViewFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LayoutInflater layoutInflater <span class="token operator">=</span> LayoutInflater<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layoutInflater<span class="token punctuation">.</span><span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LayoutInflaterCompat<span class="token punctuation">.</span><span class="token function">setFactory2</span><span class="token punctuation">(</span>layoutInflater<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>既然我们直到Factory需要重写onCreateView的方法，我们直接看看这个类中的方法：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> View <span class="token function">createView</span><span class="token punctuation">(</span>View parent<span class="token punctuation">,</span> <span class="token keyword">final</span> String name<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> AttributeSet attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppCompatViewInflater <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            TypedArray a <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">obtainStyledAttributes</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AppCompatTheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String viewInflaterClassName <span class="token operator">=</span>
                    a<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AppCompatTheme_viewInflaterClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>viewInflaterClassName <span class="token operator">==</span> null<span class="token punctuation">)</span>
                    <span class="token operator">||</span> AppCompatViewInflater<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>viewInflaterClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                mAppCompatViewInflater <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppCompatViewInflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    Class <span class="token class-name">viewInflaterClass</span> <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>viewInflaterClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mAppCompatViewInflater <span class="token operator">=</span>
                            <span class="token punctuation">(</span>AppCompatViewInflater<span class="token punctuation">)</span> viewInflaterClass<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span>
                    mAppCompatViewInflater <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppCompatViewInflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> mAppCompatViewInflater<span class="token punctuation">.</span><span class="token function">createView</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> inheritContext<span class="token punctuation">,</span>
                IS_PRE_LOLLIPOP<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* Only read android:theme pre-L (L+ handles this anyway) */</span>
                <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* Read read app:theme as a fallback at all times for legacy reasons */</span>
                VectorEnabledTintResources<span class="token punctuation">.</span><span class="token function">shouldBeUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* Only tint wrap the context if enabled */</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时，会实例化AppCompatViewInflater，把实例化View交给它来处理。</p>
<h4 id="AppCompatViewInflater-createView"><a href="#AppCompatViewInflater-createView" class="headerlink" title="AppCompatViewInflater.createView"></a>AppCompatViewInflater.createView</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">final</span> View <span class="token function">createView</span><span class="token punctuation">(</span>View parent<span class="token punctuation">,</span> <span class="token keyword">final</span> String name<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> AttributeSet attrs<span class="token punctuation">,</span> <span class="token keyword">boolean</span> inheritContext<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> readAndroidTheme<span class="token punctuation">,</span> <span class="token keyword">boolean</span> readAppTheme<span class="token punctuation">,</span> <span class="token keyword">boolean</span> wrapContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> Context originalContext <span class="token operator">=</span> context<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// We can emulate Lollipop's android:theme attribute propagating down the view hierarchy</span>
        <span class="token comment" spellcheck="true">// by using the parent's context</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inheritContext <span class="token operator">&amp;&amp;</span> parent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>readAndroidTheme <span class="token operator">||</span> readAppTheme<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// We then apply the theme on the context, if specified</span>
            context <span class="token operator">=</span> <span class="token function">themifyContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> readAndroidTheme<span class="token punctuation">,</span> readAppTheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context <span class="token operator">=</span> TintContextWrapper<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        View view <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// We need to 'inject' our tint aware Views in place of the standard framework versions</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"TextView"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createTextView</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"ImageView"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createImageView</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"Button"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createButton</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"EditText"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createEditText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"Spinner"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createSpinner</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"ImageButton"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createImageButton</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"CheckBox"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createCheckBox</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"RadioButton"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createRadioButton</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"CheckedTextView"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createCheckedTextView</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"AutoCompleteTextView"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createAutoCompleteTextView</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"MultiAutoCompleteTextView"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createMultiAutoCompleteTextView</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"RatingBar"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createRatingBar</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"SeekBar"</span><span class="token operator">:</span>
                view <span class="token operator">=</span> <span class="token function">createSeekBar</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">verifyNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// The fallback that allows extending class to take over view inflation</span>
                <span class="token comment" spellcheck="true">// for other tags. Note that we don't check that the result is not-null.</span>
                <span class="token comment" spellcheck="true">// That allows the custom inflater path to fall back on the default one</span>
                <span class="token comment" spellcheck="true">// later in this method.</span>
                view <span class="token operator">=</span> <span class="token function">createView</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> name<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> originalContext <span class="token operator">!=</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// If the original context does not equal our themed context, then we need to manually</span>
            <span class="token comment" spellcheck="true">// inflate it using the name so that android:theme takes effect.</span>
            view <span class="token operator">=</span> <span class="token function">createViewFromTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> name<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// If we have created a view, check its android:onClick</span>
            <span class="token function">checkOnClickListener</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> view<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到吧，此时把根据name去生成不同的View，这样就替换原来的View加入到布局中。</p>
<p><strong>从官方的App包我们能够得到什么启发？我们可以通过在这里做一个Factory，做一次View的生成拦截。实际上这种思路，已经被用于换肤框架中，其中一种，且个人认为最好的流派。就是这样设计的</strong></p>
<p>当然除了App包有这种操作，实际上在Activity里面也有一样的设计，不过是专门针对Fragment的。</p>
<h4 id="Fragment标签的实例化"><a href="#Fragment标签的实例化" class="headerlink" title="Fragment标签的实例化"></a>Fragment标签的实例化</h4><p>还记得开篇的attach方法吗？其中一行设置了当前LayoutInflater的PrivateFactory</p>
<pre class="line-numbers language-java"><code class="language-java">mWindow<span class="token punctuation">.</span><span class="token function">getLayoutInflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPrivateFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个Factory也是有一个onCreateView的接口，我们直接看看做了什么：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> View <span class="token function">onCreateView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> View parent<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> String name<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> AttributeSet attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"fragment"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">onCreateView</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> mFragments<span class="token punctuation">.</span><span class="token function">onCreateView</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在PrivateFactory拦截的正是fragment标签。接着就通过mFragments.onCreateView创建Fragment。关于Fragment，我之后专门用一篇文章聊聊。</p>
<p>正是因为Fragment不是一个View，因此才需要做这种特殊处理。</p>
<h3 id="AsyncLayoutInflater的性能优化"><a href="#AsyncLayoutInflater的性能优化" class="headerlink" title="AsyncLayoutInflater的性能优化"></a>AsyncLayoutInflater的性能优化</h3><p>在Android的渲染中，其实大部分的事情都在ui线程中完成。我们稍微思考其中的工作，我们暂时只考虑Java可以轻易看见的地方。做了反射，做了测量布局，渲染，都在一个线程中。除此之外还有很多业务逻辑，这样会导致ui线程十分重量级。</p>
<p>为了解决这个问题，官方也好，各大厂商也好，都做十分巨大的努力去优化这个ui渲染速度。</p>
<p>接下来AsyncLayoutInflater就是官方提供优化工具，实际上这是一个封装好的异步LayoutInflater，这样就能降低ui线程的压力。想法是好的，实际上不过这个api设计上有点缺陷，导致有点鸡肋。</p>
<p>我们看看怎么使用</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">new</span> <span class="token class-name">AsyncLayoutInflater</span><span class="token punctuation">(</span>Activity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>async_layout<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncLayoutInflater<span class="token punctuation">.</span>OnInflateFinishedListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onInflateFinished</span><span class="token punctuation">(</span>View view<span class="token punctuation">,</span> <span class="token keyword">int</span> resid<span class="token punctuation">,</span> ViewGroup parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">setContentView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到当异步实例化好View之后，再去setContentView。</p>
<p>我们直接看看构造函数，以及实例化的方法：</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token function">AsyncLayoutInflater</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mInflater <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicInflater</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>mHandlerCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInflateThread <span class="token operator">=</span> InflateThread<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@UiThread</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">inflate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@LayoutRes</span> <span class="token keyword">int</span> resid<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ViewGroup parent<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> OnInflateFinishedListener callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"callback argument may not be null!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        InflateRequest request <span class="token operator">=</span> mInflateThread<span class="token punctuation">.</span><span class="token function">obtainRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>inflater <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>resid <span class="token operator">=</span> resid<span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
        mInflateThread<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上每一次调用，都会把一个所有需要实例化的request封装起来，丢进mInflateThread实例化队列中。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InflateThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> InflateThread sInstance<span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token punctuation">{</span>
            sInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InflateThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sInstance<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> InflateThread <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> sInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> ArrayBlockingQueue<span class="token operator">&lt;</span>InflateRequest<span class="token operator">></span> mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> SynchronizedPool<span class="token operator">&lt;</span>InflateRequest<span class="token operator">></span> mRequestPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedPool</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Extracted to its own method to ensure locals have a constrained liveness</span>
        <span class="token comment" spellcheck="true">// scope by the GC. This is needed to avoid keeping previous request references</span>
        <span class="token comment" spellcheck="true">// alive for an indeterminate amount of time, see b/33158143 for details</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">runInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            InflateRequest request<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                request <span class="token operator">=</span> mQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Odd, just continue</span>
                Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                request<span class="token punctuation">.</span>view <span class="token operator">=</span> request<span class="token punctuation">.</span>inflater<span class="token punctuation">.</span>mInflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>
                        request<span class="token punctuation">.</span>resid<span class="token punctuation">,</span> request<span class="token punctuation">.</span>parent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Probably a Looper failure, retry on the UI thread</span>
                Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to inflate resource in the background! Retrying on the UI"</span>
                        <span class="token operator">+</span> <span class="token string">" thread"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>inflater<span class="token punctuation">.</span>mHandler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">sendToTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">runInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> InflateRequest <span class="token function">obtainRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            InflateRequest obj <span class="token operator">=</span> mRequestPool<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InflateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseRequest</span><span class="token punctuation">(</span>InflateRequest obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            obj<span class="token punctuation">.</span>callback <span class="token operator">=</span> null<span class="token punctuation">;</span>
            obj<span class="token punctuation">.</span>inflater <span class="token operator">=</span> null<span class="token punctuation">;</span>
            obj<span class="token punctuation">.</span>parent <span class="token operator">=</span> null<span class="token punctuation">;</span>
            obj<span class="token punctuation">.</span>resid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            obj<span class="token punctuation">.</span>view <span class="token operator">=</span> null<span class="token punctuation">;</span>
            mRequestPool<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>InflateRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                        <span class="token string">"Failed to enqueue async inflate request"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个线程的run方法中是一个死循环，在这个死循环里面会不断读取mQueue的的请求，进行一次次的实例化。一旦实例化完成之后，将会通过Handler通知回调完成。</p>
<p>通过AsyncLayoutInflater和正常的LayoutInflater比较就能清楚，双方的差异是什么？</p>
<p>我们稍微浏览一下用于实例化操作真正的LayoutInflater</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BasicInflater</span> <span class="token keyword">extends</span> <span class="token class-name">LayoutInflater</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> sClassPrefixList <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"android.widget."</span><span class="token punctuation">,</span>
            <span class="token string">"android.webkit."</span><span class="token punctuation">,</span>
            <span class="token string">"android.app."</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token function">BasicInflater</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> LayoutInflater <span class="token function">cloneInContext</span><span class="token punctuation">(</span>Context newContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BasicInflater</span><span class="token punctuation">(</span>newContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> View <span class="token function">onCreateView</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> AttributeSet attrs<span class="token punctuation">)</span> <span class="token keyword">throws</span> ClassNotFoundException <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String prefix <span class="token operator">:</span> sClassPrefixList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    View view <span class="token operator">=</span> <span class="token function">createView</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> view<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// In this case we want to let the base class take a crack</span>
                    <span class="token comment" spellcheck="true">// at it.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreateView</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>首先AsyncLayoutInflater不能设置Factory，那么也就没办法创建AppCompat系列的View,也没有办法创建Fragment。</li>
<li>其次AsyncLayoutInflater包含的阻塞队列居然只有10个，如果遇到RecyclerView这种多个子布局，超过了10个需要实例化的View，反而需要主线程的阻塞。可以使用线程池子处理</li>
<li>如果是setContentView的话，本身就是处于ui线程的第一步，也就没有必要异步。</li>
<li>甚至如果线程工作满了，可以把部分任务丢给主线程处理。</li>
<li>而且在run中写一个死循环进行读取实例化任务，不合理。完全有更好的异步等到做法，如生产者消费者模式。</li>
</ul>
<p>处理这几个问题确实不难，阅读过源码当然知道怎么处理，这里就不继续赘述了。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文总结了Activity的分层，本质上android从视图上来看，是一个DecorView包裹所有的View，我们绘制的内容区域一般在R.id.content中。</p>
<p>LayoutInflater本质上是通过一个构造函数的缓存map来加速反射View的速度，同时merge压缩层级原理就是越过本次View的生成，将内部的view生成出来直接添加到父布局，因此如果include需要的父布局和外层一直，就没有必要在内部也添加一个一模一样的布局。</p>
<p>AsyncLayoutInflater本质上就是把反射的工作丢给一个专门的线程去处理。但是其鸡肋的设计导致使用场景不广泛。</p>
<p>下一篇将和大家聊聊资源是怎么加载到我们的App的，把本篇遗留的问题解决了。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/10/19/okhttp-xi-lie-jie-xi-yi-okio-yuan-ma-jie-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="OKHttp系列解析(一) Okio源码解析">
                        
                        <span class="card-title">OKHttp系列解析(一) Okio源码解析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言好久没有更新，最近在阅读flutter相关源码。之后会整理一下，把自己的学习源码思考写出来。最近看到了flutter的http请求，dio相关的源码，不由的想到在Android开发中常用网络请求，OKHttp是怎么工作的。想起这一块没有
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-10-19
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-常用第三方库/" class="post-category">
                                    Android 常用第三方库
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-常用第三方库/">
                        <span class="chip bg-color">Android 常用第三方库</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/09/26/skia-de-chu-tan-skia-de-gn-jiao-ben-bian-yi-yu-di-yi-ge-skia-ying-yong/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="Skia的初探(Skia的GN脚本编译与第一个Skia应用)">
                        
                        <span class="card-title">Skia的初探(Skia的GN脚本编译与第一个Skia应用)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言如今大前端代表之一flutter十分火热，也是一种大的趋势。flutter与rn对大前端上的理解不同，rn是自上而下的大前端解决方案，而flutter是自下而上的大前端解决方案。为什么我说flutter是自下而上的解决方案呢？实际上这种
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-09-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Skia/" class="post-category">
                                    Skia
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/音视频/">
                        <span class="chip bg-color">音视频</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
