<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 WMS在Activity启动中的职责 添加窗体(三), Android | Linux | Flutter">
    <meta name="description" content="前言经过上一篇章的讨论，我们理清楚了ActivityRecord，TaskRecord和窗体容器之间的关系。同时达到了应用启动时，启动的第一个启动窗口，StartingWindow。这个时候，我们可以看到一个直指核心的代码段：
      ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 WMS在Activity启动中的职责 添加窗体(三) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/22.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 WMS在Activity启动中的职责 添加窗体(三)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/WMS/" class="post-category">
                                WMS
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-09-26
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        9k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        40 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>经过上一篇章的讨论，我们理清楚了ActivityRecord，TaskRecord和窗体容器之间的关系。同时达到了应用启动时，启动的第一个启动窗口，StartingWindow。这个时候，我们可以看到一个直指核心的代码段：</p>
<pre class="line-numbers language-java"><code class="language-java">            wm <span class="token operator">=</span> <span class="token punctuation">(</span>WindowManager<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>WINDOW_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            view <span class="token operator">=</span> win<span class="token punctuation">.</span><span class="token function">getDecorView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            wm<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法联通了WMS中的addView方法。</p>
<p>上一篇：<a href="https://www.jianshu.com/p/c7cc335b880a" target="_blank" rel="noopener">Android 重学系列 WMS在Activity启动中的职责(二)</a></p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="Context-获取系统服务"><a href="#Context-获取系统服务" class="headerlink" title="Context 获取系统服务"></a>Context 获取系统服务</h2><p>在正式聊WMS之前，我们先来看看context.getSystemService其核心原理，才能找到WindowManager的实现类：<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ContextImpl.java" target="_blank" rel="noopener">ContextImpl.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Object <span class="token function">getSystemService</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> SystemServiceRegistry<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件： /<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/SystemServiceRegistry.java" target="_blank" rel="noopener">SystemServiceRegistry.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ServiceFetcher<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> SYSTEM_SERVICE_FETCHERS <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ServiceFetcher<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">getSystemService</span><span class="token punctuation">(</span>ContextImpl ctx<span class="token punctuation">,</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ServiceFetcher<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> fetcher <span class="token operator">=</span> SYSTEM_SERVICE_FETCHERS<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> fetcher <span class="token operator">!=</span> null <span class="token operator">?</span> fetcher<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到是实际上所有的我们通过Context获取系统服务，是通过SYSTEM_SERVICE_FETCHERS这个提前存放在HashMap的服务集合中。这个服务是在静态代码域中提前注册。</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token function">registerService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>WINDOW_SERVICE<span class="token punctuation">,</span> WindowManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">CachedServiceFetcher</span><span class="token operator">&lt;</span>WindowManager<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> WindowManager <span class="token function">createService</span><span class="token punctuation">(</span>ContextImpl ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WindowManagerImpl</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时实际上WindowManager的interface是由WindowManagerImpl实现的。</p>
<p>这里先上一个WindowManager的UML类图。<br><img src="/images/WindowManager.png" alt="WindowManager.png"></p>
<p>我们能够从这个UML图能够看到，其实所有的事情都委托给WindowManagerGlobal工作。因此我们只需要看WindowManagerGlobal中做了什么。</p>
<p>因此我们要寻求WindowManager的addView的方法，实际上就是看WindowManagerGlobal的addView方法。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span>View view<span class="token punctuation">,</span> ViewGroup<span class="token punctuation">.</span>LayoutParams params<span class="token punctuation">,</span>
            Display display<span class="token punctuation">,</span> Window parentWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">final</span> WindowManager<span class="token punctuation">.</span>LayoutParams wparams <span class="token operator">=</span> <span class="token punctuation">(</span>WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">)</span> params<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parentWindow <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         parentWindow<span class="token punctuation">.</span><span class="token function">adjustLayoutParamsForSubWindow</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// If there's no parent, then hardware acceleration for this view is</span>
            <span class="token comment" spellcheck="true">// set from the application's hardware acceleration setting.</span>
            <span class="token keyword">final</span> Context context <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flags
                            <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_HARDWARE_ACCELERATED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                wparams<span class="token punctuation">.</span>flags <span class="token operator">|=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FLAG_HARDWARE_ACCELERATED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        ViewRootImpl root<span class="token punctuation">;</span>
        View panelParentView <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Start watching for system property changes.</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">findViewLocked</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mDyingViews<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Don't wait for MSG_DIE to make it's way through root's queue.</span>
                    mRoots<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"View "</span> <span class="token operator">+</span> view
                            <span class="token operator">+</span> <span class="token string">" has already been added to the window manager."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// The previous removeView() had not completed executing. Now it has.</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// If this is a panel window, then find the window it is being</span>
            <span class="token comment" spellcheck="true">// attached to for future reference.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wparams<span class="token punctuation">.</span>type <span class="token operator">>=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FIRST_SUB_WINDOW <span class="token operator">&amp;&amp;</span>
                    wparams<span class="token punctuation">.</span>type <span class="token operator">&lt;=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>LAST_SUB_WINDOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> count <span class="token operator">=</span> mViews<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mRoots<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>mWindow<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> wparams<span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        panelParentView <span class="token operator">=</span> mViews<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewRootImpl</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> display<span class="token punctuation">)</span><span class="token punctuation">;</span>

            view<span class="token punctuation">.</span><span class="token function">setLayoutParams</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mViews<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mRoots<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// do this last because it fires off messages to start doing things</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                root<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> wparams<span class="token punctuation">,</span> panelParentView<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// BadTokenException or InvalidDisplayException, clean up.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">removeViewLocked</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里能够看到一个新的addView的时候，会找到是否有父Window。没有则继续往后走，判断新建窗体的type是否是子窗口类型，是则查找传进来的Binder对象和存储在缓存中的Binder对象又没有对应的Window。有则作为本次新建窗口的复窗口。</p>
<p>最后能够看到我们熟悉的类ViewRootImpl。这个类可以说是所有View绘制的根部核心，这个类会在后面View绘制流程聊聊。最后会调用ViewRootImpl的setView进一步的沟通系统应用端。</p>
<p>这里涉及到了几个有趣的宏，如WindowManager.LayoutParams.FIRST_SUB_WINDOW 。它们象征这当前Window处于什么层级。</p>
<h2 id="Window的层级"><a href="#Window的层级" class="headerlink" title="Window的层级"></a>Window的层级</h2><p>Window的层级，我们大致可以分为3大类：System Window(系统窗口)，Application Window(应用窗口)，Sub Window(子窗口)</p>
<h3 id="Application-Window-应用窗口"><a href="#Application-Window-应用窗口" class="headerlink" title="Application Window(应用窗口)"></a>Application Window(应用窗口)</h3><p>Application值得注意的有这么几个宏：<br>type|描述<br>-|-<br>FIRST_APPLICATION_WINDOW = 1|应用程序窗口初始值<br>TYPE_BASE_APPLICATION = 1|应用窗口类型初始值，其他窗口以此为基准<br>TYPE_APPLICATION = 2|普通应用程序窗口类型<br>TYPE_APPLICATION_STARTING = 3|应用程序的启动窗口类型，不是应用进程支配，当第一个应用进程诞生了启动窗口就会销毁<br>TYPE_DRAWN_APPLICATION = 4|应用显示前WindowManager会等待这种窗口类型绘制完毕，一般在多用户使用<br>LAST_APPLICATION_WINDOW = 99|应用窗口类型最大值</p>
<p>因此此时我们能够清楚，应用窗口的范围在1～99之间。</p>
<h3 id="Sub-Window-子窗口"><a href="#Sub-Window-子窗口" class="headerlink" title="Sub Window(子窗口)"></a>Sub Window(子窗口)</h3><table>
<thead>
<tr>
<th>type</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>FIRST_SUB_WINDOW = 1000</td>
<td>子窗口初始值</td>
</tr>
<tr>
<td>TYPE_APPLICATION_PANEL = FIRST_SUB_WINDOW</td>
<td>应用的panel窗口，在父窗口上显示</td>
</tr>
<tr>
<td>TYPE_APPLICATION_MEDIA = FIRST_SUB_WINDOW + 1</td>
<td>多媒体内容子窗口，在父窗口之下</td>
</tr>
<tr>
<td>TYPE_APPLICATION_SUB_PANEL = FIRST_SUB_WINDOW + 2</td>
<td>也是一种panel子窗口，位于所有TYPE_APPLICATION_PANEL之上</td>
</tr>
<tr>
<td>TYPE_APPLICATION_ATTACHED_DIALOG = FIRST_SUB_WINDOW + 3</td>
<td>dialog弹窗</td>
</tr>
<tr>
<td>TYPE_APPLICATION_MEDIA_OVERLAY  = FIRST_SUB_WINDOW + 4</td>
<td>多媒体内容窗口的覆盖层</td>
</tr>
<tr>
<td>TYPE_APPLICATION_ABOVE_SUB_PANEL = FIRST_SUB_WINDOW + 5</td>
<td>位于子panel之上窗口</td>
</tr>
<tr>
<td>LAST_SUB_WINDOW = 1999</td>
<td>子窗口类型最大值</td>
</tr>
</tbody></table>
<p>能够看到子窗口的范围从1000～1999</p>
<h3 id="System-Window-系统窗口"><a href="#System-Window-系统窗口" class="headerlink" title="System Window(系统窗口)"></a>System Window(系统窗口)</h3><table>
<thead>
<tr>
<th>type</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>FIRST_SYSTEM_WINDOW     = 2000</td>
<td>系统窗口初始值</td>
</tr>
<tr>
<td>TYPE_STATUS_BAR = FIRST_SYSTEM_WINDOW</td>
<td>系统状态栏</td>
</tr>
<tr>
<td>TYPE_SEARCH_BAR = FIRST_SYSTEM_WINDOW+1</td>
<td>搜索条窗口</td>
</tr>
<tr>
<td>TYPE_PHONE = FIRST_SYSTEM_WINDOW+2</td>
<td>通话窗口</td>
</tr>
<tr>
<td>TYPE_SYSTEM_ALERT = FIRST_SYSTEM_WINDOW+3</td>
<td>alert窗口，电量不足时警告</td>
</tr>
<tr>
<td>TYPE_KEYGUARD  = FIRST_SYSTEM_WINDOW+4</td>
<td>屏保窗口</td>
</tr>
<tr>
<td>TYPE_TOAST = FIRST_SYSTEM_WINDOW+5</td>
<td>Toast提示窗口</td>
</tr>
<tr>
<td>TYPE_SYSTEM_OVERLAY  = FIRST_SYSTEM_WINDOW+6</td>
<td>系统覆盖层窗口，这个层不会响应点击事件</td>
</tr>
<tr>
<td>TYPE_PRIORITY_PHONE  = FIRST_SYSTEM_WINDOW+7</td>
<td>电话优先层，在屏保状态下显示通话</td>
</tr>
<tr>
<td>TYPE_SYSTEM_DIALOG = FIRST_SYSTEM_WINDOW+8</td>
<td>系统层级的dialog，比如RecentAppDialog</td>
</tr>
<tr>
<td>TYPE_KEYGUARD_DIALOG= FIRST_SYSTEM_WINDOW+9</td>
<td>屏保时候对话框(如qq屏保时候的聊天框)</td>
</tr>
<tr>
<td>TYPE_SYSTEM_ERROR= FIRST_SYSTEM_WINDOW+10</td>
<td>系统错误窗口</td>
</tr>
<tr>
<td>TYPE_INPUT_METHOD= FIRST_SYSTEM_WINDOW+11</td>
<td>输入法窗口</td>
</tr>
<tr>
<td>TYPE_INPUT_METHOD_DIALOG= FIRST_SYSTEM_WINDOW+12</td>
<td>输入法窗口上的对话框</td>
</tr>
<tr>
<td>TYPE_WALLPAPER= FIRST_SYSTEM_WINDOW+13</td>
<td>壁纸窗口</td>
</tr>
<tr>
<td>TYPE_STATUS_BAR_PANEL   = FIRST_SYSTEM_WINDOW+14</td>
<td>滑动状态栏窗口</td>
</tr>
<tr>
<td>LAST_SYSTEM_WINDOW      = 2999</td>
<td>系统窗口最大值</td>
</tr>
</tbody></table>
<p>常见的系统级别窗口主要是这几个。能够注意到系统窗口层级是从2000～2999。</p>
<p>这些层级有什么用的？这些层级会作为参考，将会插入到显示栈的位置，层级值越高，越靠近用户。这个逻辑之后会聊到。</p>
<h2 id="ViewRootImpl-setView"><a href="#ViewRootImpl-setView" class="headerlink" title="ViewRootImpl setView"></a>ViewRootImpl setView</h2><p>ViewRootImpl里面包含了许多事情，主要是包含了我们熟悉的View的绘制流程，以及添加Window实例的流程。</p>
<p>本文是关于WMS，因此我们只需要看下面这个核心函数</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setView</span><span class="token punctuation">(</span>View view<span class="token punctuation">,</span> WindowManager<span class="token punctuation">.</span>LayoutParams attrs<span class="token punctuation">,</span> View panelParentView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mView <span class="token operator">=</span> view<span class="token punctuation">;</span>

                mAttachInfo<span class="token punctuation">.</span>mDisplayState <span class="token operator">=</span> mDisplay<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//注册屏幕变换监听</span>
                mDisplayManager<span class="token punctuation">.</span><span class="token function">registerDisplayListener</span><span class="token punctuation">(</span>mDisplayListener<span class="token punctuation">,</span> mHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

                mViewLayoutDirectionInitial <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getRawLayoutDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//点击事件分发</span>
                mFallbackEventHandler<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mWindowAttributes<span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mWindowAttributes<span class="token punctuation">.</span>packageName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mWindowAttributes<span class="token punctuation">.</span>packageName <span class="token operator">=</span> mBasePackageName<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                attrs <span class="token operator">=</span> mWindowAttributes<span class="token punctuation">;</span>
                <span class="token function">setTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment" spellcheck="true">// Keep track of the actual window flags supplied by the client.</span>
                mClientWindowLayoutFlags <span class="token operator">=</span> attrs<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>

                <span class="token function">setAccessibilityFocus</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                mSoftInputMode <span class="token operator">=</span> attrs<span class="token punctuation">.</span>softInputMode<span class="token punctuation">;</span>
                mWindowAttributesChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                mWindowAttributesChangesFlag <span class="token operator">=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>EVERYTHING_CHANGED<span class="token punctuation">;</span>
                mAttachInfo<span class="token punctuation">.</span>mRootView <span class="token operator">=</span> view<span class="token punctuation">;</span>
                mAttachInfo<span class="token punctuation">.</span>mScalingRequired <span class="token operator">=</span> mTranslator <span class="token operator">!=</span> null<span class="token punctuation">;</span>
                mAttachInfo<span class="token punctuation">.</span>mApplicationScale <span class="token operator">=</span>
                        mTranslator <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">1.0f</span> <span class="token operator">:</span> mTranslator<span class="token punctuation">.</span>applicationScale<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>panelParentView <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAttachInfo<span class="token punctuation">.</span>mPanelParentWindowToken
                            <span class="token operator">=</span> panelParentView<span class="token punctuation">.</span><span class="token function">getApplicationWindowToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> res<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* = WindowManagerImpl.ADD_OKAY; */</span>

                <span class="token comment" spellcheck="true">// Schedule the first layout -before- adding to the window</span>
                <span class="token comment" spellcheck="true">// manager, to make sure we do the relayout before receiving</span>
                <span class="token comment" spellcheck="true">// any other events from the system.</span>
                <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mWindowAttributes<span class="token punctuation">.</span>inputFeatures
                        <span class="token operator">&amp;</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>INPUT_FEATURE_NO_INPUT_CHANNEL<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mInputChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mForceDecorViewVisibility <span class="token operator">=</span> <span class="token punctuation">(</span>mWindowAttributes<span class="token punctuation">.</span>privateFlags
                        <span class="token operator">&amp;</span> PRIVATE_FLAG_FORCE_DECOR_VIEW_VISIBILITY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mOrigWindowType <span class="token operator">=</span> mWindowAttributes<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
                    mAttachInfo<span class="token punctuation">.</span>mRecomputeGlobalAttributes <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token function">collectViewAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    res <span class="token operator">=</span> mWindowSession<span class="token punctuation">.</span><span class="token function">addToDisplay</span><span class="token punctuation">(</span>mWindow<span class="token punctuation">,</span> mSeq<span class="token punctuation">,</span> mWindowAttributes<span class="token punctuation">,</span>
                            <span class="token function">getHostVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mDisplay<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mWinFrame<span class="token punctuation">,</span>
                            mAttachInfo<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">,</span>
                            mAttachInfo<span class="token punctuation">.</span>mOutsets<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">,</span> mInputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    mView <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    mAttachInfo<span class="token punctuation">.</span>mRootView <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    mInputChannel <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    mFallbackEventHandler<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">unscheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setAccessibilityFocus</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Adding window failed"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>restore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        attrs<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法有两个核心requestLayout以及addToDisplay。</p>
<ul>
<li>1.requestLayout实际上就是指View的绘制流程，并且最终会把像素数据发送到Surface底层。</li>
<li>2.mWindowSession.addToDisplay 添加Window实例到WMS中。</li>
</ul>
<p>本文主要讨论WMS，requestLayout的方法暂时不谈。</p>
<h2 id="WindowManager的Session设计思想"><a href="#WindowManager的Session设计思想" class="headerlink" title="WindowManager的Session设计思想"></a>WindowManager的Session设计思想</h2><p>先来看看Session类：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Session</span> <span class="token keyword">extends</span> <span class="token class-name">IWindowSession<span class="token punctuation">.</span>Stub</span> <span class="token keyword">implements</span> <span class="token class-name">IBinder<span class="token punctuation">.</span>DeathRecipient</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>得知此时Session实现了一个IWindowSession的Binder对象。并且实现了Binder的死亡监听。</p>
<p>那么这个Session是从哪里来的呢？实际上是通过WMS通过跨进程通信把数据这个Binder对象传递过来的：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> IWindowSession <span class="token function">openSession</span><span class="token punctuation">(</span>IWindowSessionCallback callback<span class="token punctuation">,</span> IInputMethodClient client<span class="token punctuation">,</span>
            IInputContext inputContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"null client"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inputContext <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"null inputContext"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Session session <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Session</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> callback<span class="token punctuation">,</span> client<span class="token punctuation">,</span> inputContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> session<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通着这种方式，就能把一个Session带上WMS相关的环境送给客户端操作。这种方式和什么很相似，实际上和servicemanager查询服务Binder的思路几乎一模一样。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">addToDisplay</span><span class="token punctuation">(</span>IWindow window<span class="token punctuation">,</span> <span class="token keyword">int</span> seq<span class="token punctuation">,</span> WindowManager<span class="token punctuation">.</span>LayoutParams attrs<span class="token punctuation">,</span>
            <span class="token keyword">int</span> viewVisibility<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">,</span> Rect outFrame<span class="token punctuation">,</span> Rect outContentInsets<span class="token punctuation">,</span>
            Rect outStableInsets<span class="token punctuation">,</span> Rect outOutsets<span class="token punctuation">,</span>
            DisplayCutout<span class="token punctuation">.</span>ParcelableWrapper outDisplayCutout<span class="token punctuation">,</span> InputChannel outInputChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mService<span class="token punctuation">.</span><span class="token function">addWindow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> window<span class="token punctuation">,</span> seq<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> viewVisibility<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span> outFrame<span class="token punctuation">,</span>
                outContentInsets<span class="token punctuation">,</span> outStableInsets<span class="token punctuation">,</span> outOutsets<span class="token punctuation">,</span> outDisplayCutout<span class="token punctuation">,</span> outInputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很有趣的是，我们能够看到，按照道理我们需要添加窗体实例到WMS中。从逻辑上来讲，我们只需要做一次跨进程通信即可。但是为什么需要一个Session作为中转站呢？</p>
<p><img src="/images/Session%E8%AE%BE%E8%AE%A1.png" alt="Session设计.png"></p>
<p>能够看到实际上Session(会话)做的事情不仅仅只有沟通WMS这么简单。实际上它还同时处理了窗口上的拖拽，输入法等逻辑，更加重要的是Session面对着系统多个服务，但是通过这个封装，应用程序只需要面对这个Sesion接口，真的是名副其实的”会话”。</p>
<p>这种设计想什么？实际上就是我们常说的门面设计模式。</p>
<h3 id="IWindow对象"><a href="#IWindow对象" class="headerlink" title="IWindow对象"></a>IWindow对象</h3><p>注意，这里面除了IWindowSession之外,当我们调用addWindow添加Window到WMS中的时候，其实还存在一个IWindow接口.这个IWindow是指PhoneWindow吗？</p>
<p>很遗憾。并不是。PhoneWindow基础的接口只有Window接口。它并不是一个IBinder对象。我们转过头看看ViewRootImpl.</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">ViewRootImpl</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Display display<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
        mWindowSession <span class="token operator">=</span> WindowManagerGlobal<span class="token punctuation">.</span><span class="token function">getWindowSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDisplay <span class="token operator">=</span> display<span class="token punctuation">;</span>
        mBasePackageName <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBasePackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowLeaked</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLocation<span class="token punctuation">.</span><span class="token function">fillInStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWidth <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        mHeight <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        mDirty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mTempRect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mVisRect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWinFrame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">W</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mTargetSdkVersion <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">;</span>
        mViewVisibility <span class="token operator">=</span> View<span class="token punctuation">.</span>GONE<span class="token punctuation">;</span>
        mTransparentRegion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Region</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPreviousTransparentRegion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Region</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mFirst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true for the first time the view is added</span>
        mAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        mAttachInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>AttachInfo</span><span class="token punctuation">(</span>mWindowSession<span class="token punctuation">,</span> mWindow<span class="token punctuation">,</span> display<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> mHandler<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mViewConfiguration <span class="token operator">=</span> ViewConfiguration<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDensity <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>densityDpi<span class="token punctuation">;</span>
        mNoncompatDensity <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>noncompatDensityDpi<span class="token punctuation">;</span>
        mFallbackEventHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhoneFallbackEventHandler</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mChoreographer <span class="token operator">=</span> Choreographer<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDisplayManager <span class="token operator">=</span> <span class="token punctuation">(</span>DisplayManager<span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>DISPLAY_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sCompatibilityDone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sAlwaysAssignFocus <span class="token operator">=</span> mTargetSdkVersion <span class="token operator">&lt;</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>P<span class="token punctuation">;</span>

            sCompatibilityDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">loadSystemProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时，实际上在ViewRootImpl的构造函数会对应当前生成一个W的内部类。这个内部类：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">IWindow<span class="token punctuation">.</span>Stub</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个内部类实际上就是一个Binder类，里面回调了很多方法来操作当前的ViewRootImpl。换句话说，就是把当前的ViewRootImpl的代理W交给WMS去管理。</p>
<p>那么我们可以总结，IWindow是WMS用来间接操作ViewRootImpl中的View，IWindowSession是App用来间接操作WMS。</p>
<h2 id="WMS-addWindow"><a href="#WMS-addWindow" class="headerlink" title="WMS.addWindow"></a>WMS.addWindow</h2><p>WMS的addWindow很长，因此我这边拆开成3部分聊</p>
<h3 id="添加窗体的准备步骤"><a href="#添加窗体的准备步骤" class="headerlink" title="添加窗体的准备步骤"></a>添加窗体的准备步骤</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">addWindow</span><span class="token punctuation">(</span>Session session<span class="token punctuation">,</span> IWindow client<span class="token punctuation">,</span> <span class="token keyword">int</span> seq<span class="token punctuation">,</span>
            LayoutParams attrs<span class="token punctuation">,</span> <span class="token keyword">int</span> viewVisibility<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">,</span> Rect outFrame<span class="token punctuation">,</span>
            Rect outContentInsets<span class="token punctuation">,</span> Rect outStableInsets<span class="token punctuation">,</span> Rect outOutsets<span class="token punctuation">,</span>
            DisplayCutout<span class="token punctuation">.</span>ParcelableWrapper outDisplayCutout<span class="token punctuation">,</span> InputChannel outInputChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> appOp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> res <span class="token operator">=</span> mPolicy<span class="token punctuation">.</span><span class="token function">checkAddPermission</span><span class="token punctuation">(</span>attrs<span class="token punctuation">,</span> appOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_OKAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> reportNewConfig <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        WindowState parentWindow <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">long</span> origId<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> type <span class="token operator">=</span> attrs<span class="token punctuation">.</span>type<span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mWindowMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mDisplayReady<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Display has not been initialialized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> DisplayContent displayContent <span class="token operator">=</span> <span class="token function">getDisplayContentOrCreate</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>displayContent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_INVALID_DISPLAY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>displayContent<span class="token punctuation">.</span><span class="token function">hasAccess</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>mUid<span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mDisplayManagerInternal<span class="token punctuation">.</span><span class="token function">isUidPresentOnDisplay</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>mUid<span class="token punctuation">,</span> displayId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_INVALID_DISPLAY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mWindowMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_DUPLICATE_ADD<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">>=</span> FIRST_SUB_WINDOW <span class="token operator">&amp;&amp;</span> type <span class="token operator">&lt;=</span> LAST_SUB_WINDOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//如果是子窗口，则通过Binder找父窗口</span>
                parentWindow <span class="token operator">=</span> <span class="token function">windowForClientLocked</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> attrs<span class="token punctuation">.</span>token<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parentWindow <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">return</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_BAD_SUBWINDOW_TOKEN<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parentWindow<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>type <span class="token operator">>=</span> FIRST_SUB_WINDOW
                        <span class="token operator">&amp;&amp;</span> parentWindow<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>type <span class="token operator">&lt;=</span> LAST_SUB_WINDOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">return</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_BAD_SUBWINDOW_TOKEN<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_PRIVATE_PRESENTATION <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>displayContent<span class="token punctuation">.</span><span class="token function">isPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_PERMISSION_DENIED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            AppWindowToken atoken <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasParent <span class="token operator">=</span> parentWindow <span class="token operator">!=</span> null<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//从DisplayContent找到对应的WIndowToken</span>
            WindowToken token <span class="token operator">=</span> displayContent<span class="token punctuation">.</span><span class="token function">getWindowToken</span><span class="token punctuation">(</span>
                    hasParent <span class="token operator">?</span> parentWindow<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>token <span class="token operator">:</span> attrs<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">int</span> rootType <span class="token operator">=</span> hasParent <span class="token operator">?</span> parentWindow<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>type <span class="token operator">:</span> type<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们抛开大部分的校验逻辑。实际上可以把这个过程总结为以下几点：</p>
<ul>
<li>1.判断又没有相关的权限</li>
<li>2.尝试着获取当前displayId对应的DisplayContent，没有则创建。其逻辑实际上和我上一篇说的创建DisplayContent一摸一样</li>
<li>3.通过mWindowMap，判断当前IWindow是否被添加过，是的话说明已经存在这个Window，不需要继续添加</li>
<li>4.如果当前窗口类型是子窗口，则会通过WindowToken.attrs参数中的token去查找当前窗口的父窗口是什么。</li>
<li>5.如果有父窗口，则从DisplayContent中以父窗口的IWindow获取父窗口WindowToken的对象，否则尝试的获取当前窗口对应的WindowToken对象。</li>
</ul>
<p>我们稍微探索一下其中的几个核心：</p>
<h4 id="通过windowForClientLocked查找父窗口的WindowState"><a href="#通过windowForClientLocked查找父窗口的WindowState" class="headerlink" title="通过windowForClientLocked查找父窗口的WindowState"></a>通过windowForClientLocked查找父窗口的WindowState</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> WindowState <span class="token function">windowForClientLocked</span><span class="token punctuation">(</span>Session session<span class="token punctuation">,</span> IBinder client<span class="token punctuation">,</span> <span class="token keyword">boolean</span> throwOnError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        WindowState win <span class="token operator">=</span> mWindowMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_WM<span class="token punctuation">,</span> <span class="token string">"Looking up client "</span> <span class="token operator">+</span> client <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> win<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>win <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>throwOnError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                        <span class="token string">"Requested window "</span> <span class="token operator">+</span> client <span class="token operator">+</span> <span class="token string">" does not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG_WM<span class="token punctuation">,</span> <span class="token string">"Failed looking up window callers="</span> <span class="token operator">+</span> Debug<span class="token punctuation">.</span><span class="token function">getCallers</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> win<span class="token punctuation">.</span>mSession <span class="token operator">!=</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>throwOnError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Requested window "</span> <span class="token operator">+</span> client <span class="token operator">+</span> <span class="token string">" is in session "</span>
                        <span class="token operator">+</span> win<span class="token punctuation">.</span>mSession <span class="token operator">+</span> <span class="token string">", not "</span> <span class="token operator">+</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG_WM<span class="token punctuation">,</span> <span class="token string">"Failed looking up window callers="</span> <span class="token operator">+</span> Debug<span class="token punctuation">.</span><span class="token function">getCallers</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> win<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上可以看到这里面是从mWindowMap通过IWindow获取WindowState对象。还记得我上篇说过很重要的数据结构吗？mWindowMap实际上是保存着WMS中IWindow对应WindowState对象。IWindow本质上是WMS控制ViewRootImpl的Binder接口。因此我们可以把WindowState看成应用进程的对应的对象也未尝不可。</p>
<h3 id="获取对应的WindowToken"><a href="#获取对应的WindowToken" class="headerlink" title="获取对应的WindowToken"></a>获取对应的WindowToken</h3><pre class="line-numbers language-java"><code class="language-java">            AppWindowToken atoken <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasParent <span class="token operator">=</span> parentWindow <span class="token operator">!=</span> null<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//从DisplayContent找到对应的WIndowToken</span>
            WindowToken token <span class="token operator">=</span> displayContent<span class="token punctuation">.</span><span class="token function">getWindowToken</span><span class="token punctuation">(</span>
                    hasParent <span class="token operator">?</span> parentWindow<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>token <span class="token operator">:</span> attrs<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这里面我们能够看到WindowToken，是通过DisplayContent获取到的。</p>
<pre><code>WindowToken getWindowToken(IBinder binder) {
        return mTokenMap.get(binder);
    }</code></pre><p>这样就能看到我前两篇提到过的很重要的数据结构:mTokenMap以及mWindowMap。这两者要稍微区分一下：<br>mWindowMap是以IWindow为key，WindowState为value。<br>mTokenMap是以WindowState的IBinder(一般为IApplicationToken)为key，WindowToken为value</p>
<p>还记得mTokenMap在Activity的启动流程中做的事情吗？在创建AppWIndowContainer的时候，会同时创建AppWindowToken，AppWIndowToken的构造会把当前的IBinder作为key，AppWindowToken作为value添加到mTokenMap中。</p>
<p>也就是说，如果系统想要通过应用进程给的IWindow找到真正位于WMS中Window的句柄，必须通过这两层变换才能真正找到。</p>
<h3 id="拆分情况获取对应的WindowToken和AppWindowToken"><a href="#拆分情况获取对应的WindowToken和AppWindowToken" class="headerlink" title="拆分情况获取对应的WindowToken和AppWindowToken"></a>拆分情况获取对应的WindowToken和AppWindowToken</h3><p>这个时候就分为两种情况，一种是存在WindowToken，一种是不存在WindowToken。</p>
<pre class="line-numbers language-java"><code class="language-java">            <span class="token keyword">boolean</span> addToastWindowRequiresToken <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//校验窗口参数是否合法  </span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">final</span> IBinder binder <span class="token operator">=</span> attrs<span class="token punctuation">.</span>token <span class="token operator">!=</span> null <span class="token operator">?</span> attrs<span class="token punctuation">.</span>token <span class="token operator">:</span> client<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isRoundedCornerOverlay <span class="token operator">=</span>
                        <span class="token punctuation">(</span>attrs<span class="token punctuation">.</span>privateFlags <span class="token operator">&amp;</span> PRIVATE_FLAG_IS_ROUNDED_CORNERS_OVERLAY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> binder<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> displayContent<span class="token punctuation">,</span>
                        session<span class="token punctuation">.</span>mCanAddInternalSystemWindow<span class="token punctuation">,</span> isRoundedCornerOverlay<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rootType <span class="token operator">>=</span> FIRST_APPLICATION_WINDOW <span class="token operator">&amp;&amp;</span> rootType <span class="token operator">&lt;=</span> LAST_APPLICATION_WINDOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                atoken <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">asAppWindowToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>atoken <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_NOT_APP_TOKEN<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>atoken<span class="token punctuation">.</span>removed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_APPLICATION_STARTING <span class="token operator">&amp;&amp;</span> atoken<span class="token punctuation">.</span>startingWindow <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rootType <span class="token operator">==</span> TYPE_INPUT_METHOD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rootType <span class="token operator">==</span> TYPE_VOICE_INTERACTION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rootType <span class="token operator">==</span> TYPE_WALLPAPER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rootType <span class="token operator">==</span> TYPE_DREAM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rootType <span class="token operator">==</span> TYPE_ACCESSIBILITY_OVERLAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_TOAST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_QS_DIALOG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">asAppWindowToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                attrs<span class="token punctuation">.</span>token <span class="token operator">=</span> null<span class="token punctuation">;</span>
                token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> displayContent<span class="token punctuation">,</span>
                        session<span class="token punctuation">.</span>mCanAddInternalSystemWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当我们通过mTokenMap获取WindowToken的时候，大致分为四种情况。WindowToken会尝试的获取父窗口对应的Token，找不到则使用WindowManager.LayoutParams中的WindowToken。一般来说我们找到的都有父亲的WindowToken。</p>
<ul>
<li>1.无关应用的找不到WindowToken</li>
<li>2.有关应用找不到WindowToken。</li>
<li>3.无关应用找到WindowToken</li>
<li>4.有关应用找到WindowToken</li>
</ul>
<h4 id="前两种情况解析"><a href="#前两种情况解析" class="headerlink" title="前两种情况解析"></a>前两种情况解析</h4><p>实际上前两种情况，一旦发现找不到WindowToken，如果当前的窗口和应用相关的，就一定爆错误。如Toast，输入法，应用窗口等等。</p>
<p>因此在Android 8.0开始，当我们想要显示Toast的时候，加入传入的Context是Application而不是Activity，此时一旦发现mTokenMap中找不到IApplicationToken对应的WindowToken就爆出了错误。正确的做法应该是需要获取Activity当前的Context。</p>
<p>在上面的情况应用启动窗口，此时并没有启动Activity。因此不可能会被校验拦下，因此并没有异常抛出。就会自己创建一个WindowToken。</p>
<h4 id="后两种的解析"><a href="#后两种的解析" class="headerlink" title="后两种的解析"></a>后两种的解析</h4><p>当找到WindowToken，一般是指Activity启动之后，在AppWindowToken初始化后，自动加入了mTokenMap中。此时的情况稍微复杂了点。</p>
<p>当是子窗口的时候，则会判断当前的WindowToken是不是AppWindowToken。不是，或者被移除等异常情况则报错。</p>
<p>如果是壁纸，输入法，系统弹窗，toast等窗口模式，子窗口和父窗口的模式必须一致。</p>
<p>当此时的AppWindowToken不为空的时候，说明在New的时候已经生成，且没有移除，将会生成一个新的WindowToken。</p>
<p>为什么要生成一个新的windowToken?可以翻阅之前我写的文章，只要每一次调用一次构造函数将会把当前的WindowToken添加到mTokenMap中，实际上也是担心，对应的AppWindowToken出现的重新绑定的问题。</p>
<h3 id="添加WindowState实例到数据结构"><a href="#添加WindowState实例到数据结构" class="headerlink" title="添加WindowState实例到数据结构"></a>添加WindowState实例到数据结构</h3><p>但是别忘了，我们这个时候还需要把相关的数据结构存储到全局。</p>
<pre class="line-numbers language-java"><code class="language-java">            <span class="token keyword">final</span> WindowState win <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> session<span class="token punctuation">,</span> client<span class="token punctuation">,</span> token<span class="token punctuation">,</span> parentWindow<span class="token punctuation">,</span>
                    appOp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> seq<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> viewVisibility<span class="token punctuation">,</span> session<span class="token punctuation">.</span>mUid<span class="token punctuation">,</span>
                    session<span class="token punctuation">.</span>mCanAddInternalSystemWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>win<span class="token punctuation">.</span>mDeathRecipient <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_APP_EXITING<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>win<span class="token punctuation">.</span><span class="token function">getDisplayContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_INVALID_DISPLAY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasStatusBarServicePermission <span class="token operator">=</span>
                    mContext<span class="token punctuation">.</span><span class="token function">checkCallingOrSelfPermission</span><span class="token punctuation">(</span>permission<span class="token punctuation">.</span>STATUS_BAR_SERVICE<span class="token punctuation">)</span>
                            <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">;</span>
            mPolicy<span class="token punctuation">.</span><span class="token function">adjustWindowParamsLw</span><span class="token punctuation">(</span>win<span class="token punctuation">,</span> win<span class="token punctuation">.</span>mAttrs<span class="token punctuation">,</span> hasStatusBarServicePermission<span class="token punctuation">)</span><span class="token punctuation">;</span>
            win<span class="token punctuation">.</span><span class="token function">setShowToOwnerOnlyLocked</span><span class="token punctuation">(</span>mPolicy<span class="token punctuation">.</span><span class="token function">checkShowToOwnerOnly</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            res <span class="token operator">=</span> mPolicy<span class="token punctuation">.</span><span class="token function">prepareAddWindowLw</span><span class="token punctuation">(</span>win<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_OKAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> res<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// From now on, no exceptions or errors allowed!</span>

            res <span class="token operator">=</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_OKAY<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentFocus <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mWinAddedSinceNullFocus<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">excludeWindowTypeFromTapOutTask</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                displayContent<span class="token punctuation">.</span>mTapExcludedWindows<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            win<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//以IWindow为key，WindowState为value存放到WindowMap中</span>
            mWindowMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> win<span class="token punctuation">)</span><span class="token punctuation">;</span>

            win<span class="token punctuation">.</span><span class="token function">initAppOpsState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            win<span class="token punctuation">.</span>mToken<span class="token punctuation">.</span><span class="token function">addWindow</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为完全可能出现新的WindowToken，因此干脆会创建一个新的WindowState。此时会对调用WindowState.attach方法</p>
<pre><code>    void attach() {
        mSession.windowAddedLocked(mAttrs.packageName);
    }</code></pre><p>这方法挺重要的，Session做了一次添加锁定。<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/wm/" target="_blank" rel="noopener">wm</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/wm/Session.java" target="_blank" rel="noopener">Session.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">windowAddedLocked</span><span class="token punctuation">(</span>String packageName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPackageName <span class="token operator">=</span> packageName<span class="token punctuation">;</span>
        mRelayoutTag <span class="token operator">=</span> <span class="token string">"relayoutWindow: "</span> <span class="token operator">+</span> mPackageName<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSurfaceSession <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>WindowManagerService<span class="token punctuation">.</span>localLOGV<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>
                TAG_WM<span class="token punctuation">,</span> <span class="token string">"First window added to "</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">", creating SurfaceSession"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mSurfaceSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SurfaceSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>SHOW_TRANSACTIONS<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>
                    TAG_WM<span class="token punctuation">,</span> <span class="token string">"  NEW SURFACE SESSION "</span> <span class="token operator">+</span> mSurfaceSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span>mSessions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLastReportedAnimatorScale <span class="token operator">!=</span> mService<span class="token punctuation">.</span><span class="token function">getCurrentAnimatorScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mService<span class="token punctuation">.</span><span class="token function">dispatchNewAnimatorScaleLocked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mNumWindow<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时的工作是什么？联系上下文，当我们新增了PhoneWindow，就会一个ViewRootImpl，也因此新增了Session。此时说明诞生一个新界面，此时已经诞生了相关的容器对象，但是相关的绘制到底层对象还没有创建出来。</p>
<p>命名逻辑和Session很相似。Session是WMS给应用App的会话对象，SurfaceSession是SurfaceFlinger面向上层每一个WIndow需要绘制内容对象。</p>
<p>这个SurfaceSession和SurfaceControl都是重点，联通到SurfaceFlinger很重要的对象。</p>
<p>最后再添加到mWindowMap中。并且把WindowState添加到WindowToken中，让每一个WindowToken赋予状态的信息。我们稍微探索一下addWindow的方法。</p>
<h2 id="WindowState-添加Window的策略"><a href="#WindowState-添加Window的策略" class="headerlink" title="WindowState 添加Window的策略"></a>WindowState 添加Window的策略</h2><p>有没有考虑过WindowManager.LayoutParams是从哪里来的token？</p>
<p>当我们没有指定当前窗口的type，则会自动设置为TYPE_APPLICATION = 2，同时token将会是原来的appwindowtoken.当我们在addView传入了父亲窗口时候，则会通过adjustLayoutParamsForSubWindow先不设定application的值，而是先拿到父亲窗口的token:<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/Window.java" target="_blank" rel="noopener">Window.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">adjustLayoutParamsForSubWindow</span><span class="token punctuation">(</span>WindowManager<span class="token punctuation">.</span>LayoutParams wp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CharSequence curTitle <span class="token operator">=</span> wp<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wp<span class="token punctuation">.</span>type <span class="token operator">>=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FIRST_SUB_WINDOW <span class="token operator">&amp;&amp;</span>
                wp<span class="token punctuation">.</span>type <span class="token operator">&lt;=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>LAST_SUB_WINDOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wp<span class="token punctuation">.</span>token <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                View decor <span class="token operator">=</span> <span class="token function">peekDecorView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>decor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    wp<span class="token punctuation">.</span>token <span class="token operator">=</span> decor<span class="token punctuation">.</span><span class="token function">getWindowToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>wp<span class="token punctuation">.</span>type <span class="token operator">>=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FIRST_SYSTEM_WINDOW <span class="token operator">&amp;&amp;</span>
                wp<span class="token punctuation">.</span>type <span class="token operator">&lt;=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>LAST_SYSTEM_WINDOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//设置title</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wp<span class="token punctuation">.</span>token <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                wp<span class="token punctuation">.</span>token <span class="token operator">=</span> mContainer <span class="token operator">==</span> null <span class="token operator">?</span> mAppToken <span class="token operator">:</span> mContainer<span class="token punctuation">.</span>mAppToken<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
           <span class="token comment" spellcheck="true">//设置title</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wp<span class="token punctuation">.</span>packageName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            wp<span class="token punctuation">.</span>packageName <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mHardwareAccelerated <span class="token operator">||</span>
                <span class="token punctuation">(</span>mWindowAttributes<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> FLAG_HARDWARE_ACCELERATED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            wp<span class="token punctuation">.</span>flags <span class="token operator">|=</span> FLAG_HARDWARE_ACCELERATED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能够看到此时将会初始化WindowManager.LayoutParams的Token。此时Token在Activity启动流程中已经先一步初始化AppWindowToken。</p>
<p>在聊WindowState的添加窗口的策略之前，我们先来看看WindowState的构造函数。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token function">WindowState</span><span class="token punctuation">(</span>WindowManagerService service<span class="token punctuation">,</span> Session s<span class="token punctuation">,</span> IWindow c<span class="token punctuation">,</span> WindowToken token<span class="token punctuation">,</span>
            WindowState parentWindow<span class="token punctuation">,</span> <span class="token keyword">int</span> appOp<span class="token punctuation">,</span> <span class="token keyword">int</span> seq<span class="token punctuation">,</span> WindowManager<span class="token punctuation">.</span>LayoutParams a<span class="token punctuation">,</span>
            <span class="token keyword">int</span> viewVisibility<span class="token punctuation">,</span> <span class="token keyword">int</span> ownerId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ownerCanAddInternalSystemWindow<span class="token punctuation">,</span>
            PowerManagerWrapper powerManagerWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">linkToDeath</span><span class="token punctuation">(</span>deathRecipient<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mDeathRecipient <span class="token operator">=</span> deathRecipient<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttrs<span class="token punctuation">.</span>type <span class="token operator">>=</span> FIRST_SUB_WINDOW <span class="token operator">&amp;&amp;</span> mAttrs<span class="token punctuation">.</span>type <span class="token operator">&lt;=</span> LAST_SUB_WINDOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The multiplier here is to reserve space for multiple</span>
            <span class="token comment" spellcheck="true">// windows in the same type layer.</span>
            mBaseLayer <span class="token operator">=</span> mPolicy<span class="token punctuation">.</span><span class="token function">getWindowLayerLw</span><span class="token punctuation">(</span>parentWindow<span class="token punctuation">)</span>
                    <span class="token operator">*</span> TYPE_LAYER_MULTIPLIER <span class="token operator">+</span> TYPE_LAYER_OFFSET<span class="token punctuation">;</span>
            mSubLayer <span class="token operator">=</span> mPolicy<span class="token punctuation">.</span><span class="token function">getSubWindowLayerFromTypeLw</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mIsChildWindow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>


            parentWindow<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sWindowSubLayerComparator<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mLayoutAttached <span class="token operator">=</span> mAttrs<span class="token punctuation">.</span>type <span class="token operator">!=</span>
                    WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>TYPE_APPLICATION_ATTACHED_DIALOG<span class="token punctuation">;</span>
            mIsImWindow <span class="token operator">=</span> parentWindow<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>type <span class="token operator">==</span> TYPE_INPUT_METHOD
                    <span class="token operator">||</span> parentWindow<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>type <span class="token operator">==</span> TYPE_INPUT_METHOD_DIALOG<span class="token punctuation">;</span>
            mIsWallpaper <span class="token operator">=</span> parentWindow<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>type <span class="token operator">==</span> TYPE_WALLPAPER<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The multiplier here is to reserve space for multiple</span>
            <span class="token comment" spellcheck="true">// windows in the same type layer.</span>
            mBaseLayer <span class="token operator">=</span> mPolicy<span class="token punctuation">.</span><span class="token function">getWindowLayerLw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
                    <span class="token operator">*</span> TYPE_LAYER_MULTIPLIER <span class="token operator">+</span> TYPE_LAYER_OFFSET<span class="token punctuation">;</span>
            mSubLayer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            mIsChildWindow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mLayoutAttached <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mIsImWindow <span class="token operator">=</span> mAttrs<span class="token punctuation">.</span>type <span class="token operator">==</span> TYPE_INPUT_METHOD
                    <span class="token operator">||</span> mAttrs<span class="token punctuation">.</span>type <span class="token operator">==</span> TYPE_INPUT_METHOD_DIALOG<span class="token punctuation">;</span>
            mIsWallpaper <span class="token operator">=</span> mAttrs<span class="token punctuation">.</span>type <span class="token operator">==</span> TYPE_WALLPAPER<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mIsFloatingLayer <span class="token operator">=</span> mIsImWindow <span class="token operator">||</span> mIsWallpaper<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppToken <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mAppToken<span class="token punctuation">.</span>mShowForAllUsers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Windows for apps that can show for all users should also show when the device is</span>
            <span class="token comment" spellcheck="true">// locked.</span>
            mAttrs<span class="token punctuation">.</span>flags <span class="token operator">|=</span> FLAG_SHOW_WHEN_LOCKED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们把目光几种在mBaseLayer和mSubLayer的初始化上。我们能够看到在初始化WindowState的时候，会获取WindowState的type是子窗口还是不是子窗口。</p>
<p>此时我们把这个问题分为两种情况：</p>
<h4 id="1-是子窗口"><a href="#1-是子窗口" class="headerlink" title="1.是子窗口"></a>1.是子窗口</h4><p>当我们发现当前窗口子窗口，会分为如下2个层级作为基准值。获取当前传进进来的层级type：<br>符合如下公式:</p>
<blockquote>
<p>mBaselayer = 父窗口层级type(见上文Window层级的表格) * 10000 + 1000；<br>mSubLayer = 子窗口本身的层级type(见上文Window层级的表格)</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Comparator<span class="token operator">&lt;</span>WindowState<span class="token operator">></span> sWindowSubLayerComparator <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token operator">&lt;</span>WindowState<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span>WindowState w1<span class="token punctuation">,</span> WindowState w2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> layer1 <span class="token operator">=</span> w1<span class="token punctuation">.</span>mSubLayer<span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> layer2 <span class="token operator">=</span> w2<span class="token punctuation">.</span>mSubLayer<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>layer1 <span class="token operator">&lt;</span> layer2 <span class="token operator">||</span> <span class="token punctuation">(</span>layer1 <span class="token operator">==</span> layer2 <span class="token operator">&amp;&amp;</span> layer2 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<pre><code>
此时就会直接添加到parentWindow当中。会不断的比对比当前mSubLayer大的值，直到找到第一个插入。

#### 2.不是子窗口
此时也会根据当前传进来的层级去计算当前window应该插入的地方。
符合如下公式:
&gt;  mBaselayer = 当前的窗口层级type(见上文Window层级的表格) * 10000 + 1000；
&gt; mSubLayer = 0;

将会在接下来通过WindowState的addWindow做进一步调整。


文件:/[frameworks](http://androidxref.com/9.0.0_r3/xref/frameworks/)/[base](http://androidxref.com/9.0.0_r3/xref/frameworks/base/)/[services](http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/)/[core](http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/)/[java](http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/)/[com](http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/)/[android](http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/)/[server](http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/)/[wm](http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/wm/)/[WindowToken.java](http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/wm/WindowToken.java)
```java
    private final Comparator&lt;WindowState&gt; mWindowComparator =
            (WindowState newWindow, WindowState existingWindow) -&gt; {
        final WindowToken token = WindowToken.this;
        if (newWindow.mToken != token) {
            throw new IllegalArgumentException("newWindow=" + newWindow
                    + " is not a child of token=" + token);
        }

        if (existingWindow.mToken != token) {
            throw new IllegalArgumentException("existingWindow=" + existingWindow
                    + " is not a child of token=" + token);
        }

        return isFirstChildWindowGreaterThanSecond(newWindow, existingWindow) ? 1 : -1;
    };

    protected boolean isFirstChildWindowGreaterThanSecond(WindowState newWindow,
            WindowState existingWindow) {
        // New window is considered greater if it has a higher or equal base layer.
        return newWindow.mBaseLayer &gt;= existingWindow.mBaseLayer;
    }
    void addWindow(final WindowState win) {
        if (DEBUG_FOCUS) Slog.d(TAG_WM,
                "addWindow: win=" + win + " Callers=" + Debug.getCallers(5));

        if (win.isChildWindow()) {
            // Child windows are added to their parent windows.
            return;
        }
        if (!mChildren.contains(win)) {
            if (DEBUG_ADD_REMOVE) Slog.v(TAG_WM, "Adding " + win + " to " + this);
            addChild(win, mWindowComparator);
            mService.mWindowsChanged = true;
            // TODO: Should we also be setting layout needed here and other places?
        }
    }</code></pre><p>这一段都是继上面调整非子窗口逻辑，能够很轻松的看出来，实际上此时会去不断的比对mBaseLayer直到找到一个大于等于的层级添加到上面。</p>
<h3 id="层级初步计算总结"><a href="#层级初步计算总结" class="headerlink" title="层级初步计算总结"></a>层级初步计算总结</h3><p>还记得此时在DisplayContent中，把整个WindowContainer的集合拆分成几个层次吗？栈区域，statusbar区域，壁纸区域，输入法区域。</p>
<p>每当我们new了一个WindowToken，将会自动的根据此时窗口类型绑定到对应的区域的末尾。这个时候，当我们addWindow要添加WindowState的时候，将会根据这个句柄去查找WindowToken中的层级，插入到对应的层级中。</p>
<p>用一幅图总结如下:<br><img src="/images/Window%E7%9A%84%E5%B1%82%E7%BA%A7%E6%8F%92%E5%85%A5.png" alt="Window的层级插入.png"></p>
<h3 id="层级第二次计算"><a href="#层级第二次计算" class="headerlink" title="层级第二次计算"></a>层级第二次计算</h3><p>经过上面的区域划分，把窗体大致上区分到了几个区域当中，并且有了大致的顺序，但是实际上，我们只是粗略的处理了Window。实际上在App应用中不是简单的摆好,我们在平时使用的时候并非如此。</p>
<p>还有一种情况需要特殊处理，当我们尝试着执行窗口动画的时候，一般很少遇到有什么东西把Activity的Window动画给遮挡住。实际上也是得益于第二次的调整。</p>
<pre class="line-numbers language-java"><code class="language-java">

            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_INPUT_METHOD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                win<span class="token punctuation">.</span>mGivenInsetsPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token function">setInputMethodWindowLocked</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
                imMayMove <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_INPUT_METHOD_DIALOG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                displayContent<span class="token punctuation">.</span><span class="token function">computeImeTarget</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* updateImeTarget */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                imMayMove <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_WALLPAPER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    displayContent<span class="token punctuation">.</span>mWallpaperController<span class="token punctuation">.</span><span class="token function">clearLastWallpaperTimeoutTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    displayContent<span class="token punctuation">.</span>pendingLayoutChanges <span class="token operator">|=</span> FINISH_LAYOUT_REDO_WALLPAPER<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attrs<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>FLAG_SHOW_WALLPAPER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    displayContent<span class="token punctuation">.</span>pendingLayoutChanges <span class="token operator">|=</span> FINISH_LAYOUT_REDO_WALLPAPER<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>displayContent<span class="token punctuation">.</span>mWallpaperController<span class="token punctuation">.</span><span class="token function">isBelowWallpaperTarget</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    displayContent<span class="token punctuation">.</span>pendingLayoutChanges <span class="token operator">|=</span> FINISH_LAYOUT_REDO_WALLPAPER<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>imMayMove<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                displayContent<span class="token punctuation">.</span><span class="token function">computeImeTarget</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* updateImeTarget */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Don't do layout here, the window must call</span>
            <span class="token comment" spellcheck="true">// relayout to be displayed, so we'll do it there.</span>
            win<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignChildLayers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时，会从DisplayContent顶部向下重新对层级进行排序。能看到核心方法是就是computeImeTarget以及assignChildLayers。</p>
<h3 id="computeImeTarget"><a href="#computeImeTarget" class="headerlink" title="computeImeTarget"></a>computeImeTarget</h3><pre class="line-numbers language-java"><code class="language-java">    WindowState <span class="token function">computeImeTarget</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> updateImeTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mInputMethodWindow <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>updateImeTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setInputMethodTarget</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mInputMethodTargetWaitingAnim<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> WindowState curTarget <span class="token operator">=</span> mService<span class="token punctuation">.</span>mInputMethodTarget<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canUpdateImeTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> curTarget<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mUpdateImeTarget <span class="token operator">=</span> updateImeTarget<span class="token punctuation">;</span>
        WindowState target <span class="token operator">=</span> <span class="token function">getWindow</span><span class="token punctuation">(</span>mComputeImeTargetPredicate<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>type <span class="token operator">==</span> TYPE_APPLICATION_STARTING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> AppWindowToken token <span class="token operator">=</span> target<span class="token punctuation">.</span>mAppToken<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> WindowState betterTarget <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">getImeTargetBelowWindow</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>betterTarget <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    target <span class="token operator">=</span> betterTarget<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>curTarget <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> curTarget<span class="token punctuation">.</span><span class="token function">isDisplayedLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> curTarget<span class="token punctuation">.</span><span class="token function">isClosing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> null <span class="token operator">||</span> target<span class="token punctuation">.</span><span class="token function">isActivityTypeHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> curTarget<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>updateImeTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setInputMethodTarget</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mInputMethodTargetWaitingAnim<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>updateImeTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            AppWindowToken token <span class="token operator">=</span> curTarget <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> curTarget<span class="token punctuation">.</span>mAppToken<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                WindowState highestTarget <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">isSelfAnimating</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    highestTarget <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">getHighestAnimLayerWindow</span><span class="token punctuation">(</span>curTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>highestTarget <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> AppTransition appTransition <span class="token operator">=</span> mService<span class="token punctuation">.</span>mAppTransition<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>appTransition<span class="token punctuation">.</span><span class="token function">isTransitionSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">setInputMethodTarget</span><span class="token punctuation">(</span>highestTarget<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> highestTarget<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>highestTarget<span class="token punctuation">.</span>mWinAnimator<span class="token punctuation">.</span><span class="token function">isAnimationSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                            highestTarget<span class="token punctuation">.</span>mWinAnimator<span class="token punctuation">.</span>mAnimLayer <span class="token operator">></span> target<span class="token punctuation">.</span>mWinAnimator<span class="token punctuation">.</span>mAnimLayer<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token function">setInputMethodTarget</span><span class="token punctuation">(</span>highestTarget<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> highestTarget<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token function">setInputMethodTarget</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面有两个对象需要区分以下，一个是curTarget，一个是Target。</p>
<ul>
<li>curTarget是来自WMS的mInputMethodTarget。也就意味着此时是WMS预定的输入法窗口层级。也就代表当前的输入法窗口。</li>
</ul>
<ul>
<li><p>target 是来自DisplayContent对自己的孩子进行搜索到最顶部能够称为输入法窗口的WIndow。也就代表着下一个层级最高（可见的）输入法窗口。根据之前的文章，我们可以推断出来此时就是找添加到DisplayContent层级最高的NonMagnifiableWindowContainers的弹窗。也就是下一个要弹出的窗口</p>
</li>
<li><p>1.如果此时WMS中没有IME(输入法)的Window，此时就没有生成顶部的Window，就直接获取mInputMethodTargetWaitingAnim (因为此时需要做输入法窗口动画)作为新的输入法弹窗，并不需要调整。</p>
</li>
<li><p>2.通过getWindow找到最顶层能够成为输入法弹窗层级的DisplayContent的子窗口。也就是NonMagnifiableWindowContainers。</p>
</li>
<li><p>3.如果当前可以作为输入法弹窗是启动窗口类型，因为启动窗口本身很特殊，类似中转站的角色。则会自动找到下面那一层的窗口，判断是否能够作为弹窗。</p>
</li>
<li><p>4.如果当前的输入法弹窗不为空，同时当前的进程还存在，并且下一个要启动的窗口是Home。则直接返回当前进程的输入法弹窗。避免屏幕闪动。这里也就解释为什么，我们在自己应用启动了输入法弹窗，点击回退键盘回退Home之后，有些时候，输入法还留在Home上。</p>
</li>
<li><p>5.下一个目标输入法弹窗为空，则获取上一个。</p>
</li>
<li><p>6.输入法动画播放，会根据方法参数updateImeTarget这个标志位是否打开，来判断是否处理弹窗动画。因为是做需要做动画，所以需要找到当前输入法弹窗下，最高层级(可见)的窗口。</p>
</li>
</ul>
<p>这个方法到处都调用了另一个比较核心的方法setInputMethodTarget，去设定当前的输入法弹窗目标。</p>
<h4 id="setInputMethodTarget"><a href="#setInputMethodTarget" class="headerlink" title="setInputMethodTarget"></a>setInputMethodTarget</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setInputMethodTarget</span><span class="token punctuation">(</span>WindowState target<span class="token punctuation">,</span> <span class="token keyword">boolean</span> targetWaitingAnim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> mService<span class="token punctuation">.</span>mInputMethodTarget
                <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span>mInputMethodTargetWaitingAnim <span class="token operator">==</span> targetWaitingAnim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mService<span class="token punctuation">.</span>mInputMethodTarget <span class="token operator">=</span> target<span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span>mInputMethodTargetWaitingAnim <span class="token operator">=</span> targetWaitingAnim<span class="token punctuation">;</span>
        <span class="token function">assignWindowLayers</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* setLayoutNeeded */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到除了赋值之外，还做一个和我上面提过十分相似的方法assignWindowLayers。</p>
<h4 id="assignWindowLayers"><a href="#assignWindowLayers" class="headerlink" title="assignWindowLayers"></a>assignWindowLayers</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** Updates the layer assignment of windows on this display. */</span>
    <span class="token keyword">void</span> <span class="token function">assignWindowLayers</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> setLayoutNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">assignChildLayers</span><span class="token punctuation">(</span><span class="token function">getPendingTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>setLayoutNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setLayoutNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">scheduleAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时会调用assignChildLayers这个方法，并且执行窗口动画。</p>
<h4 id="assignChildLayers"><a href="#assignChildLayers" class="headerlink" title="assignChildLayers"></a>assignChildLayers</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">assignChildLayers</span><span class="token punctuation">(</span>Transaction t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> layer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// We use two passes as a way to promote children which</span>
        <span class="token comment" spellcheck="true">// need Z-boosting to the end of the list.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> WindowContainer wc <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wc<span class="token punctuation">.</span><span class="token function">assignChildLayers</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wc<span class="token punctuation">.</span><span class="token function">needsZBoost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                wc<span class="token punctuation">.</span><span class="token function">assignLayer</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> layer<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> WindowContainer wc <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wc<span class="token punctuation">.</span><span class="token function">needsZBoost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                wc<span class="token punctuation">.</span><span class="token function">assignLayer</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> layer<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">assignChildLayers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assignChildLayers</span><span class="token punctuation">(</span><span class="token function">getPendingTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scheduleAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里做了什么事情呢？实际上很巧妙，首先对整个WindowContainer的子窗体做一次调整，接着打开了needsZBoost标志位的窗口再添加到上面。</p>
<p>这样就分离了需要做动画的层级，以及普通层级。保证了做动画的窗口一定再普通窗口之上。</p>
<h2 id="添加窗口层级调整总结"><a href="#添加窗口层级调整总结" class="headerlink" title="添加窗口层级调整总结"></a>添加窗口层级调整总结</h2><p>从这里我们看到，Android 9.0对窗口层级的管理，比起过去的Android4.4的窗口层级调整有了十足的进步。</p>
<p>Android 4.4的窗口管理通过复杂的循环对窗口进行管理，这里就不分析了。到了Android 9.0 先把窗口层级大致划分出几个区域之后，再对每个区域进行循环管理，最后再调整动画的窗口。这么做的有点很显然易见，那就是抽象出了WIndowContainer提高了扩展性，并且减少了循环次数。</p>
<p>到这里窗口添加的大致上的逻辑，大体上已经弄透彻了，但是还有其他内容。</p>
<p>接下来让我们继续聊聊WMS面向应用暴露的三个接口，剩下的两个接口，updateViewLayout,removeView.以及Window如何计算Window的边缘。</p>
<h2 id="updateViewLayout"><a href="#updateViewLayout" class="headerlink" title="updateViewLayout"></a>updateViewLayout</h2><p>从上一篇文章看到ViewManager还有另外一个很重要的方法updateViewLayout。我们直奔WindowManagerGlobal看看真正的实现类做了什么：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/WindowManagerGlobal.java" target="_blank" rel="noopener">WindowManagerGlobal.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateViewLayout</span><span class="token punctuation">(</span>View view<span class="token punctuation">,</span> ViewGroup<span class="token punctuation">.</span>LayoutParams params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"view must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>params <span class="token keyword">instanceof</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Params must be WindowManager.LayoutParams"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> WindowManager<span class="token punctuation">.</span>LayoutParams wparams <span class="token operator">=</span> <span class="token punctuation">(</span>WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">)</span>params<span class="token punctuation">;</span>

        view<span class="token punctuation">.</span><span class="token function">setLayoutParams</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">findViewLocked</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ViewRootImpl root <span class="token operator">=</span> mRoots<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>
            root<span class="token punctuation">.</span><span class="token function">setLayoutParams</span><span class="token punctuation">(</span>wparams<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到其核心十分简单，就是获取Windowmanager.LayoutParams需要更新的ViewRootImpl，最后调用setLayoutParams把新的LayoutParams设置到ViewRootImpl中，最后通过requestLayout做一次更新。</p>
<p>由于这是基于ViewRootImpl做一次一个逻辑屏幕上所有View的更新，因此使用的地方并不多。</p>
<h3 id="removeView"><a href="#removeView" class="headerlink" title="removeView"></a>removeView</h3><p>removeView是最后一个ViewManager的接口。这个接口使用的次数很多。我们接着启动窗口继续聊聊，既然我们在启动我们自己的真正的窗口之前会现有一个启动窗口显示，那么当Activity准备好下一步创建的时候，就必定会移除这个启动窗口，让我们找找看，是哪里移除的。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStack.java" target="_blank" rel="noopener">ActivityStack.java</a><br>让我们把焦点放在：resumeTopActivityInnerLocked方法上.只有这个方法，才是真正开始跨进程通信，准备启动应用的Activity。</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">resumeTopActivityInnerLocked</span><span class="token punctuation">(</span>ActivityRecord prev<span class="token punctuation">,</span> ActivityOptions options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mService<span class="token punctuation">.</span>mBooting <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mBooted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Not ready yet!</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Find the next top-most activity to resume in this stack that is not finishing and is</span>
        <span class="token comment" spellcheck="true">// focusable. If it is not focusable, we will fall into the case below to resume the</span>
        <span class="token comment" spellcheck="true">// top activity in the next focusable task.</span>
        <span class="token keyword">final</span> ActivityRecord next <span class="token operator">=</span> <span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* focusableOnly */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasRunningActivity <span class="token operator">=</span> next <span class="token operator">!=</span> null<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// TODO: Maybe this entire condition can get removed?</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasRunningActivity <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mStackSupervisor<span class="token punctuation">.</span><span class="token function">cancelInitializingActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>销毁启动窗口就是通过ActivityStackSupervisor.cancelInitializingActivities。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">cancelInitializingActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ActivityDisplay display <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> stackNdx <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> stackNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>stackNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getChildAt</span><span class="token punctuation">(</span>stackNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                stack<span class="token punctuation">.</span><span class="token function">cancelInitializingActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到会获取ActivityDisplay中ActivityStack中所有的启动窗口，进行销毁。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">cancelInitializingActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> ActivityRecord topActivity <span class="token operator">=</span> <span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> aboveTop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// We don't want to clear starting window for activities that aren't behind fullscreen</span>
        <span class="token comment" spellcheck="true">// activities as we need to display their starting window until they are done initializing.</span>
        <span class="token keyword">boolean</span> behindFullscreenActivity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldBeVisible</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The stack is not visible, so no activity in it should be displaying a starting</span>
            <span class="token comment" spellcheck="true">// window. Mark all activities below top and behind fullscreen.</span>
            aboveTop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            behindFullscreenActivity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> taskNdx <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> taskNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>taskNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>ActivityRecord<span class="token operator">></span> activities <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>taskNdx<span class="token punctuation">)</span><span class="token punctuation">.</span>mActivities<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> activityNdx <span class="token operator">=</span> activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> activityNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>activityNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ActivityRecord r <span class="token operator">=</span> activities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activityNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>aboveTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> topActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        aboveTop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    behindFullscreenActivity <span class="token operator">|=</span> r<span class="token punctuation">.</span>fullscreen<span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                r<span class="token punctuation">.</span><span class="token function">removeOrphanedStartingWindow</span><span class="token punctuation">(</span>behindFullscreenActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                behindFullscreenActivity <span class="token operator">|=</span> r<span class="token punctuation">.</span>fullscreen<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>aboveTop默认是true。换句话说，从Task历史栈中获取所有Activity的启动窗口亲切销毁，如果当前的要销毁启动窗口的Activity和本次要启动的Activity是同一个对象，说明没有必要再去销毁。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityRecord.java" target="_blank" rel="noopener">ActivityRecord.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">removeOrphanedStartingWindow</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> behindFullscreenActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartingWindowState <span class="token operator">==</span> STARTING_WINDOW_SHOWN <span class="token operator">&amp;&amp;</span> behindFullscreenActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_VISIBILITY<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG_VISIBILITY<span class="token punctuation">,</span> <span class="token string">"Found orphaned starting window "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mStartingWindowState <span class="token operator">=</span> STARTING_WINDOW_REMOVED<span class="token punctuation">;</span>
            mWindowContainerController<span class="token punctuation">.</span><span class="token function">removeStartingWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>behindFullscreenActivity 这个标志位代表着是否真的执行销毁启动窗体，只要有一个Activity是全屏模式，就一定会去销毁。</p>
<p>###AppWindowContainerController.removeStartingWindow</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeStartingWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mWindowMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> StartingSurface surface<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment" spellcheck="true">// Use the same thread to remove the window as we used to add it, as otherwise we end up</span>
            <span class="token comment" spellcheck="true">// with things in the view hierarchy being called from different threads.</span>
            mService<span class="token punctuation">.</span>mAnimationHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STARTING_WINDOW<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_WM<span class="token punctuation">,</span> <span class="token string">"Removing startingView="</span> <span class="token operator">+</span> surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    surface<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG_WM<span class="token punctuation">,</span> <span class="token string">"Exception when removing starting window"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时的操作和addStartingWindow相似，也是把操作丢给WMS的动画处理Handler mAnimationHandler完成，对这个StartingSurface 进行移除。</p>
<p>而这个StartingSurface 在上一篇文章我们就能看到，实际上是一个SplashScreenSurface对象。<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/policy/" target="_blank" rel="noopener">policy</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/policy/SplashScreenSurface.java" target="_blank" rel="noopener">SplashScreenSurface.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> WindowManager wm <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>WindowManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wm<span class="token punctuation">.</span><span class="token function">removeView</span><span class="token punctuation">(</span>mView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时就是通过WindowManagerService对启动窗体进行销毁。</p>
<h3 id="WindowManagerGlobal-removeView"><a href="#WindowManagerGlobal-removeView" class="headerlink" title="WindowManagerGlobal removeView"></a>WindowManagerGlobal removeView</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/WindowManagerGlobal.java" target="_blank" rel="noopener">WindowManagerGlobal.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">findViewLocked</span><span class="token punctuation">(</span>View view<span class="token punctuation">,</span> <span class="token keyword">boolean</span> required<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> mViews<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>required <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"View="</span> <span class="token operator">+</span> view <span class="token operator">+</span> <span class="token string">" not attached to window manager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> index<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeView</span><span class="token punctuation">(</span>View view<span class="token punctuation">,</span> <span class="token keyword">boolean</span> immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"view must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">findViewLocked</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            View curView <span class="token operator">=</span> mRoots<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">removeViewLocked</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> immediate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>curView <span class="token operator">==</span> view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Calling with view "</span> <span class="token operator">+</span> view
                    <span class="token operator">+</span> <span class="token string">" but the ViewAncestor is attached to "</span> <span class="token operator">+</span> curView<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在removeView的时候，我们需要注意view为空有异常，当我们要销毁的view，从mViews中找到和mRoot中找到的不一致，则会报错。这两个对象都是在addView，同步添加到mRoots和mView中。</p>
<p>因为此时是WindowManager的销毁，那么必定会去销毁当前对应的ViewRootImpl，换句话，我们要销毁ViewGroup中的View的时候当然不会使用这个方法销毁，这个方法销毁的是整个窗体对应的根部View。</p>
<h4 id="removeViewLocked"><a href="#removeViewLocked" class="headerlink" title="removeViewLocked"></a>removeViewLocked</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">removeViewLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token keyword">boolean</span> immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ViewRootImpl root <span class="token operator">=</span> mRoots<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        View view <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            InputMethodManager imm <span class="token operator">=</span> InputMethodManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>imm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                imm<span class="token punctuation">.</span><span class="token function">windowDismissed</span><span class="token punctuation">(</span>mViews<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWindowToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> deferred <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">die</span><span class="token punctuation">(</span>immediate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            view<span class="token punctuation">.</span><span class="token function">assignParent</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mDyingViews<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在清除的行为中，首先获取对应的ViewRootImpl，先通过windowDismissed销毁输入法。通过ViewRootImpl做一次相关的销毁行为，再通过assignParent清除其View指定的父View，如果不是立即销毁则把view对象添加到正在死亡的View集合中，等到做完所有的清除操作后，再清除这个集合中的view。</p>
<h4 id="ViewRootImpl-die"><a href="#ViewRootImpl-die" class="headerlink" title="ViewRootImpl die"></a>ViewRootImpl die</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">die</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Make sure we do execute immediately if we are in the middle of a traversal or the damage</span>
        <span class="token comment" spellcheck="true">// done by dispatchDetachedFromWindow will cause havoc on return.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>immediate <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mIsInTraversal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">doDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mIsDrawing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">destroyHardwareRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>mTag<span class="token punctuation">,</span> <span class="token string">"Attempting to destroy the window while drawing!\n"</span> <span class="token operator">+</span>
                    <span class="token string">"  window="</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">", title="</span> <span class="token operator">+</span> mWindowAttributes<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>MSG_DIE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">doDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>LOCAL_LOGV<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>mTag<span class="token punctuation">,</span> <span class="token string">"DIE in "</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" of "</span> <span class="token operator">+</span> mSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mRemoved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mRemoved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">dispatchDetachedFromWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mAdded <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mFirst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">destroyHardwareRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> viewVisibility <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> viewVisibilityChanged <span class="token operator">=</span> mViewVisibility <span class="token operator">!=</span> viewVisibility<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mWindowAttributesChanged <span class="token operator">||</span> viewVisibilityChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// If layout params have been changed, first give them</span>
                        <span class="token comment" spellcheck="true">// to the window manager to make sure it has the correct</span>
                        <span class="token comment" spellcheck="true">// animation info.</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">relayoutWindow</span><span class="token punctuation">(</span>mWindowAttributes<span class="token punctuation">,</span> viewVisibility<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                                    <span class="token operator">&amp;</span> WindowManagerGlobal<span class="token punctuation">.</span>RELAYOUT_RES_FIRST_TIME<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                mWindowSession<span class="token punctuation">.</span><span class="token function">finishDrawing</span><span class="token punctuation">(</span>mWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    mSurface<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            mAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        WindowManagerGlobal<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doRemoveView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，如果需要理解销毁则会直接执行doDie的方法，否则会把doDie委托到handler中完成。</p>
<p>doDie做了几件事情，一个是分发DetachedFromWindow事件给下面的View，接着销毁所有的硬件加速的渲染线程内该View的资源(这里不做更多讨论，之后会有专门的文章讨论)，释放绘制对象Surface，如果当前的View是可见的则通过Session沟通WMS进行结束绘制，最后调用WindowManagerGlobal的doRemoveView。</p>
<p>我们这里暂时只关心两个方法finishDrawing以及doRemoveView。让我们一个个的看一遍里面做了什么东西。</p>
<h3 id="WMS-finishDrawingWindow"><a href="#WMS-finishDrawingWindow" class="headerlink" title="WMS finishDrawingWindow"></a>WMS finishDrawingWindow</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">finishDrawingWindow</span><span class="token punctuation">(</span>Session session<span class="token punctuation">,</span> IWindow client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mWindowMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                WindowState win <span class="token operator">=</span> <span class="token function">windowForClientLocked</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> client<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_ADD_REMOVE<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_WM<span class="token punctuation">,</span> <span class="token string">"finishDrawingWindow: "</span> <span class="token operator">+</span> win <span class="token operator">+</span> <span class="token string">" mDrawState="</span>
                        <span class="token operator">+</span> <span class="token punctuation">(</span>win <span class="token operator">!=</span> null <span class="token operator">?</span> win<span class="token punctuation">.</span>mWinAnimator<span class="token punctuation">.</span><span class="token function">drawStateToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"null"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>win <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> win<span class="token punctuation">.</span>mWinAnimator<span class="token punctuation">.</span><span class="token function">finishDrawingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> FLAG_SHOW_WALLPAPER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        win<span class="token punctuation">.</span><span class="token function">getDisplayContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pendingLayoutChanges <span class="token operator">|=</span>
                                WindowManagerPolicy<span class="token punctuation">.</span>FINISH_LAYOUT_REDO_WALLPAPER<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    win<span class="token punctuation">.</span><span class="token function">setDisplayLayoutNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mWindowPlacerLocked<span class="token punctuation">.</span><span class="token function">requestTraversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时先找到IWindow对应的WindowState，设置对应WindowState中的DisplayContent标志位设置为true。并且重新测量窗体边缘。稍后会稍微深入WindowPlacerLocked.requestTraversal中做了什么事情。</p>
<p>###WindowManagerGlobal doRemoveView</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">doRemoveView</span><span class="token punctuation">(</span>ViewRootImpl root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> mRoots<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mRoots<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mParams<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> View view <span class="token operator">=</span> mViews<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mDyingViews<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ThreadedRenderer<span class="token punctuation">.</span>sTrimForeground <span class="token operator">&amp;&amp;</span> ThreadedRenderer<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">doTrimForeground</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doTrimForeground</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> hasVisibleWindows <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mRoots<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ViewRootImpl root <span class="token operator">=</span> mRoots<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>mView <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> root<span class="token punctuation">.</span><span class="token function">getHostVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> View<span class="token punctuation">.</span>VISIBLE
                        <span class="token operator">&amp;&amp;</span> root<span class="token punctuation">.</span>mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    hasVisibleWindows <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    root<span class="token punctuation">.</span><span class="token function">destroyHardwareResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasVisibleWindows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ThreadedRenderer<span class="token punctuation">.</span><span class="token function">trimMemory</span><span class="token punctuation">(</span>
                    ComponentCallbacks2<span class="token punctuation">.</span>TRIM_MEMORY_COMPLETE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，经过doDie释放了必须的资源，如硬件渲染启动时候的渲染线程和Surface。并且重新计算窗体边缘。<br>最后再把WindowManagerGlobal 中的mRoots中的对象和mDyingView的对象全部移除。doTrimForeground则是清除那些看不见的Window中的view对应的渲染线程的资源。</p>
<p>removeView的核心逻辑就是这么多了。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>updateViewLayout本质上是设置WindowParams，重新测量绘制整个Window中的view。<br>removeView做了以下几个事情:</p>
<ul>
<li>1.关闭键盘</li>
<li>2.ViewRootImpl调用die方法，清除硬件加速渲染线程中对应的view资源，重新执行Window的大小计算。</li>
<li>3.清空残留在WindowManagerGlobal中的对象。</li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/09/26/android-chong-xue-xi-lie-wms-zai-activity-qi-dong-zhong-de-zhi-ze-ji-suan-chuang-ti-de-da-xiao-si/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="Android 重学系列 WMS在Activity启动中的职责 计算窗体的大小(四)">
                        
                        <span class="card-title">Android 重学系列 WMS在Activity启动中的职责 计算窗体的大小(四)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言通过启动窗口为例子，大致上明白了WMS是如何添加，更新，移除窗口的工作原理。本文将会重点聊一聊窗口的大小计算逻辑。
下面的源码都是来自Android 9.0
正文窗口大小计算计算窗口的大小和Android 4.4相比变化很大。花了一点心
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-09-26
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/WMS/" class="post-category">
                                    WMS
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/09/26/opengl-si-zuo-biao-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="OpenGL(四)坐标系">
                        
                        <span class="card-title">OpenGL(四)坐标系</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言在前两章，总结有顶点坐标，纹理坐标。实际上在这之上还有更多的坐标。作者经过学习后，在本文总结一番。
上一篇：OpenGL矩阵
正文OpenGL希望每一次运行顶点着色器之后，我们所见到的顶点坐标都转化为标准化设备坐标(NDC)。
也就是说
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-09-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/OpenGL/" class="post-category">
                                    OpenGL
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/OpenGL/">
                        <span class="chip bg-color">OpenGL</span>
                    </a>
                    
                    <a href="/tags/音视频/">
                        <span class="chip bg-color">音视频</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
