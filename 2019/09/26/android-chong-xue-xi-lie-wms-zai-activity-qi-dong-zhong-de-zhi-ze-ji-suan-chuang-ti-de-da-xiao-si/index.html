<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 WMS在Activity启动中的职责 计算窗体的大小(四), Android | Linux | Flutter">
    <meta name="description" content="前言通过启动窗口为例子，大致上明白了WMS是如何添加，更新，移除窗口的工作原理。本文将会重点聊一聊窗口的大小计算逻辑。
下面的源码都是来自Android 9.0
正文窗口大小计算计算窗口的大小和Android 4.4相比变化很大。花了一点心">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 WMS在Activity启动中的职责 计算窗体的大小(四) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/15.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 WMS在Activity启动中的职责 计算窗体的大小(四)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/WMS/" class="post-category">
                                WMS
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-09-26
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        9.6k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        43 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>通过启动窗口为例子，大致上明白了WMS是如何添加，更新，移除窗口的工作原理。本文将会重点聊一聊窗口的大小计算逻辑。</p>
<p>下面的源码都是来自Android 9.0</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="窗口大小计算"><a href="#窗口大小计算" class="headerlink" title="窗口大小计算"></a>窗口大小计算</h2><p>计算窗口的大小和Android 4.4相比变化很大。花了一点心思去重新学习了。在Android 4.4中,窗体的计算在onResume中调用了ViewRootImpl调用relayoutWindow对整个Window重新测量窗口大小以及边距。</p>
<p>relayoutWindow这个方法是做什么的呢？当我们在Activity的生命周期到达了onResume的阶段，此时ViewRootImpl的setView，开始走渲染的View的流程，并且调用requestLayout开始测量渲染。其中有一个核心的逻辑就是调用WMS的relayoutWindow，重新测量Window。</p>
<p>在Android 9.0中把这个流程和DisplayContent绑定起来。让我们稍微解剖一下这个方法。</p>
<h3 id="relayout"><a href="#relayout" class="headerlink" title="relayout"></a>relayout</h3><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">relayoutWindow</span><span class="token punctuation">(</span>Session session<span class="token punctuation">,</span> IWindow client<span class="token punctuation">,</span> <span class="token keyword">int</span> seq<span class="token punctuation">,</span> LayoutParams attrs<span class="token punctuation">,</span>
            <span class="token keyword">int</span> requestedWidth<span class="token punctuation">,</span> <span class="token keyword">int</span> requestedHeight<span class="token punctuation">,</span> <span class="token keyword">int</span> viewVisibility<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
            <span class="token keyword">long</span> frameNumber<span class="token punctuation">,</span> Rect outFrame<span class="token punctuation">,</span> Rect outOverscanInsets<span class="token punctuation">,</span> Rect outContentInsets<span class="token punctuation">,</span>
            Rect outVisibleInsets<span class="token punctuation">,</span> Rect outStableInsets<span class="token punctuation">,</span> Rect outOutsets<span class="token punctuation">,</span> Rect outBackdropFrame<span class="token punctuation">,</span>
            DisplayCutout<span class="token punctuation">.</span>ParcelableWrapper outCutout<span class="token punctuation">,</span> MergedConfiguration mergedConfiguration<span class="token punctuation">,</span>
            Surface outSurface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> configChanged<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasStatusBarPermission <span class="token operator">=</span>
                mContext<span class="token punctuation">.</span><span class="token function">checkCallingOrSelfPermission</span><span class="token punctuation">(</span>permission<span class="token punctuation">.</span>STATUS_BAR<span class="token punctuation">)</span>
                        <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasStatusBarServicePermission <span class="token operator">=</span>
                mContext<span class="token punctuation">.</span><span class="token function">checkCallingOrSelfPermission</span><span class="token punctuation">(</span>permission<span class="token punctuation">.</span>STATUS_BAR_SERVICE<span class="token punctuation">)</span>
                        <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">;</span>

        <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> displayId<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mWindowMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            WindowState win <span class="token operator">=</span> <span class="token function">windowForClientLocked</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> client<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>win <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            displayId <span class="token operator">=</span> win<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            mWindowPlacerLocked<span class="token punctuation">.</span><span class="token function">performSurfacePlacement</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* force */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldRelayout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> win<span class="token punctuation">.</span><span class="token function">relayoutVisibleWindow</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> attrChanges<span class="token punctuation">,</span> oldVisibility<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> <span class="token function">createSurfaceControl</span><span class="token punctuation">(</span>outSurface<span class="token punctuation">,</span> result<span class="token punctuation">,</span> win<span class="token punctuation">,</span> winAnimator<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mInputMonitor<span class="token punctuation">.</span><span class="token function">updateInputWindowsLw</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*force*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>result <span class="token operator">&amp;</span> WindowManagerGlobal<span class="token punctuation">.</span>RELAYOUT_RES_FIRST_TIME<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    focusMayChange <span class="token operator">=</span> isDefaultDisplay<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>win<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>type <span class="token operator">==</span> TYPE_INPUT_METHOD <span class="token operator">&amp;&amp;</span> mInputMethodWindow <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">setInputMethodWindowLocked</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    imMayMove <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                win<span class="token punctuation">.</span><span class="token function">adjustStartingWindowFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_WINDOW_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>focusMayChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">updateFocusedWindowLocked</span><span class="token punctuation">(</span>UPDATE_FOCUS_WILL_PLACE_SURFACES<span class="token punctuation">,</span>
                        <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*updateInputWindows*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    imMayMove <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> toBeDisplayed <span class="token operator">=</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;</span> WindowManagerGlobal<span class="token punctuation">.</span>RELAYOUT_RES_FIRST_TIME<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> DisplayContent dc <span class="token operator">=</span> win<span class="token punctuation">.</span><span class="token function">getDisplayContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>imMayMove<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dc<span class="token punctuation">.</span><span class="token function">computeImeTarget</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* updateImeTarget */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>toBeDisplayed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dc<span class="token punctuation">.</span><span class="token function">assignWindowLayers</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* setLayoutNeeded */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            outFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>mCompatFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            outOverscanInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>mOverscanInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            outContentInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            win<span class="token punctuation">.</span>mLastRelayoutContentInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            outVisibleInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>mVisibleInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            outStableInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            outCutout<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">.</span><span class="token function">getDisplayCutout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            outOutsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>mOutsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            outBackdropFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span><span class="token function">getBackdropFrame</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>mFrame<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            result <span class="token operator">|=</span> mInTouchMode <span class="token operator">?</span> WindowManagerGlobal<span class="token punctuation">.</span>RELAYOUT_RES_IN_TOUCH_MODE <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

            mInputMonitor<span class="token punctuation">.</span><span class="token function">updateInputWindowsLw</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*force*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            win<span class="token punctuation">.</span>mInRelayout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>relayout大致上要做了以下的事情:</p>
<ul>
<li>1.通过IWindow找到对应的WindowState，并且获取各种参数。</li>
<li>2.WindowPlacerLocked.performSurfacePlacement为Surface交互做准备。</li>
<li>3.创建Surface对象，开始和SurfaceFlinger做交互。</li>
<li>4.updateFocusedWindowLocked Window发生变化则会尝试着重新计算窗体大小的区域</li>
<li>5.计算层级，设置窗体的各种边距。</li>
</ul>
<p>relayout的方法有点长，本次我们将关注这一部分核心的逻辑。分别是两个方法：</p>
<ul>
<li><p>1.mWindowPlacerLocked.performSurfacePlacement 当窗体出现了变更，需要重新设置DisplayContent的各种参数,销毁不用的Surface，重新计算层级，计算触点区域等等</p>
</li>
<li><p>2.updateFocusedWindowLocked 当发现Window可能发生变化，则重新计算窗口大小。</p>
</li>
</ul>
<h4 id="WindowPlacerLocked-performSurfacePlacement"><a href="#WindowPlacerLocked-performSurfacePlacement" class="headerlink" title="WindowPlacerLocked.performSurfacePlacement"></a>WindowPlacerLocked.performSurfacePlacement</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">performSurfacePlacement</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDeferDepth <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> loopCount <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            mTraversalScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token function">performSurfacePlacementLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span>mAnimationHandler<span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span>mPerformSurfacePlacement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            loopCount<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>mTraversalScheduled <span class="token operator">&amp;&amp;</span> loopCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span>mRoot<span class="token punctuation">.</span>mWallpaperActionPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这里面对performSurfacePlacementLoop做最多为6次的循环,这六次循环做什么呢？</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performSurfacePlacementLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mInLayout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> recoveringMemory <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mService<span class="token punctuation">.</span>mForceRemoves<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            recoveringMemory <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>mService<span class="token punctuation">.</span>mForceRemoves<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> WindowState ws <span class="token operator">=</span> mService<span class="token punctuation">.</span>mForceRemoves<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ws<span class="token punctuation">.</span><span class="token function">removeImmediately</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Object tmp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    tmp<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span>mRoot<span class="token punctuation">.</span><span class="token function">performSurfacePlacement</span><span class="token punctuation">(</span>recoveringMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mInLayout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mRoot<span class="token punctuation">.</span><span class="token function">isLayoutNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>mLayoutRepeatCount <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">requestTraversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Performed 6 layouts in a row. Skipping"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mLayoutRepeatCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mLayoutRepeatCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mWindowsChanged <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mWindowChangeListeners<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mService<span class="token punctuation">.</span>mH<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>REPORT_WINDOWS_CHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mService<span class="token punctuation">.</span>mH<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>REPORT_WINDOWS_CHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mInLayout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里面的核心逻辑，首先会检查WMS下mForceRemoves集合中是否还有对象。有则调用removeImmediately清空WindowState的中SurfaceControl和WindowContainer之间的绑定和Surface对象，以及销毁WindowAnimator中的Surface。</p>
<p>做这个得到目的很简单，因为下一个步骤将会申请一个Surface对象，而此时如果Android系统内存过大了(OOM)，mForceRemoves就存在对象，就可以销毁不需要的Surface。这一点的设计和Davlik虚拟机申请对象时候的思路倒是一致的。</p>
<p>销毁需要一点时间，因此就需要做一个250毫秒的的等待。接着会调用RootWindowContainer的performSurfacePlacement做真正的执行。最后会通过handler通过ViewServer通知事件给DebugBridge调试类中。</p>
<p>每一次loop的最后，如果发现RootWindowContainer需要重新测量，就会把当前这个方法，放入Handler中，等待下次的调用，也是调用6次。这样就能最大限度的保证在这段时间内Window能够测量每一次的窗体参数。</p>
<h3 id="RootWindowContainer-performSurfacePlacement"><a href="#RootWindowContainer-performSurfacePlacement" class="headerlink" title="RootWindowContainer.performSurfacePlacement"></a>RootWindowContainer.performSurfacePlacement</h3><p>下面这个方法十分长，我们只看核心;</p>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">void</span> <span class="token function">performSurfacePlacement</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> recoveringMemory<span class="token punctuation">)</span> <span class="token punctuation">{</span>


        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> updateInputWindowsNeeded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//核心事件1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mFocusMayChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span>mFocusMayChange <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            updateInputWindowsNeeded <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">updateFocusedWindowLocked</span><span class="token punctuation">(</span>
                    UPDATE_FOCUS_WILL_PLACE_SURFACES<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*updateInputWindows*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 核心事件2</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> numDisplays <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> displayNdx <span class="token operator">&lt;</span> numDisplays<span class="token punctuation">;</span> <span class="token operator">++</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> DisplayContent displayContent <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            displayContent<span class="token punctuation">.</span><span class="token function">setExitingTokensHasVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mHoldScreen <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">final</span> DisplayInfo defaultInfo <span class="token operator">=</span> defaultDisplay<span class="token punctuation">.</span><span class="token function">getDisplayInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> defaultDw <span class="token operator">=</span> defaultInfo<span class="token punctuation">.</span>logicalWidth<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> defaultDh <span class="token operator">=</span> defaultInfo<span class="token punctuation">.</span>logicalHeight<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> WindowSurfacePlacer surfacePlacer <span class="token operator">=</span> mService<span class="token punctuation">.</span>mWindowPlacerLocked<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 核心事件3</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mAppTransition<span class="token punctuation">.</span><span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> layoutChanges <span class="token operator">=</span> surfacePlacer<span class="token punctuation">.</span><span class="token function">handleAppTransitionReadyLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            defaultDisplay<span class="token punctuation">.</span>pendingLayoutChanges <span class="token operator">|=</span> layoutChanges<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_LAYOUT_REPEATS<span class="token punctuation">)</span>
                surfacePlacer<span class="token punctuation">.</span><span class="token function">debugLayoutRepeats</span><span class="token punctuation">(</span><span class="token string">"after handleAppTransitionReadyLocked"</span><span class="token punctuation">,</span>
                        defaultDisplay<span class="token punctuation">.</span>pendingLayoutChanges<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAppAnimating</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span>mAppTransition<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            defaultDisplay<span class="token punctuation">.</span>pendingLayoutChanges <span class="token operator">|=</span>
                    mService<span class="token punctuation">.</span><span class="token function">handleAnimatingStoppedAndTransitionLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 核心事件4</span>
        <span class="token keyword">final</span> RecentsAnimationController recentsAnimationController <span class="token operator">=</span>
            mService<span class="token punctuation">.</span><span class="token function">getRecentsAnimationController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>recentsAnimationController <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            recentsAnimationController<span class="token punctuation">.</span><span class="token function">checkAnimationReady</span><span class="token punctuation">(</span>mWallpaperController<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mWallpaperForceHidingChanged <span class="token operator">&amp;&amp;</span> defaultDisplay<span class="token punctuation">.</span>pendingLayoutChanges <span class="token operator">==</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mAppTransition<span class="token punctuation">.</span><span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            defaultDisplay<span class="token punctuation">.</span>pendingLayoutChanges <span class="token operator">|=</span> FINISH_LAYOUT_REDO_LAYOUT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mWallpaperForceHidingChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mFocusMayChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span>mFocusMayChange <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">updateFocusedWindowLocked</span><span class="token punctuation">(</span>UPDATE_FOCUS_PLACING_SURFACES<span class="token punctuation">,</span>
                    <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*updateInputWindows*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                updateInputWindowsNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                defaultDisplay<span class="token punctuation">.</span>pendingLayoutChanges <span class="token operator">|=</span> FINISH_LAYOUT_REDO_ANIM<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">final</span> ArraySet<span class="token operator">&lt;</span>DisplayContent<span class="token operator">></span> touchExcludeRegionUpdateDisplays <span class="token operator">=</span> <span class="token function">handleResizingWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">// 核心事件5</span>
        <span class="token keyword">boolean</span> wallpaperDestroyed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        i <span class="token operator">=</span> mService<span class="token punctuation">.</span>mDestroySurface<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                i<span class="token operator">--</span><span class="token punctuation">;</span>
                WindowState win <span class="token operator">=</span> mService<span class="token punctuation">.</span>mDestroySurface<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                win<span class="token punctuation">.</span>mDestroying <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mInputMethodWindow <span class="token operator">==</span> win<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mService<span class="token punctuation">.</span><span class="token function">setInputMethodWindowLocked</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>win<span class="token punctuation">.</span><span class="token function">getDisplayContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mWallpaperController<span class="token punctuation">.</span><span class="token function">isWallpaperTarget</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    wallpaperDestroyed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                win<span class="token punctuation">.</span><span class="token function">destroySurfaceUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                win<span class="token punctuation">.</span>mWinAnimator<span class="token punctuation">.</span><span class="token function">destroyPreservedSurfaceLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span>mDestroySurface<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// 核心事件6</span>
        mService<span class="token punctuation">.</span>mInputMonitor<span class="token punctuation">.</span><span class="token function">updateInputWindowsLw</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*force*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mService<span class="token punctuation">.</span><span class="token function">setHoldScreenLocked</span><span class="token punctuation">(</span>mHoldScreen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSustainedPerformanceModeCurrent <span class="token operator">!=</span> mSustainedPerformanceModeEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSustainedPerformanceModeEnabled <span class="token operator">=</span> mSustainedPerformanceModeCurrent<span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span>mPowerManagerInternal<span class="token punctuation">.</span><span class="token function">powerHint</span><span class="token punctuation">(</span>
                    PowerHint<span class="token punctuation">.</span>SUSTAINED_PERFORMANCE<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>mSustainedPerformanceModeEnabled <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment" spellcheck="true">//事件7</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> mService<span class="token punctuation">.</span>mPendingRemove<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mPendingRemoveTmp<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> N<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mService<span class="token punctuation">.</span>mPendingRemoveTmp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowState</span><span class="token punctuation">[</span>N<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mService<span class="token punctuation">.</span>mPendingRemove<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mPendingRemoveTmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span>mPendingRemove<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ArrayList<span class="token operator">&lt;</span>DisplayContent<span class="token operator">></span> displayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> WindowState w <span class="token operator">=</span> mService<span class="token punctuation">.</span>mPendingRemoveTmp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                w<span class="token punctuation">.</span><span class="token function">removeImmediately</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> DisplayContent displayContent <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">getDisplayContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>displayContent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>displayList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>displayContent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    displayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>displayContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> displayList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> DisplayContent dc <span class="token operator">=</span> displayList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                dc<span class="token punctuation">.</span><span class="token function">assignWindowLayers</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*setLayoutNeeded*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 事件8</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkCompleteDeferredRemoval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>updateInputWindowsNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span>mInputMonitor<span class="token punctuation">.</span><span class="token function">updateInputWindowsLw</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*force*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mService<span class="token punctuation">.</span><span class="token function">setFocusTaskRegionLocked</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>touchExcludeRegionUpdateDisplays <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> DisplayContent focusedDc <span class="token operator">=</span> mService<span class="token punctuation">.</span>mFocusedApp <span class="token operator">!=</span> null
                    <span class="token operator">?</span> mService<span class="token punctuation">.</span>mFocusedApp<span class="token punctuation">.</span><span class="token function">getDisplayContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>DisplayContent dc <span class="token operator">:</span> touchExcludeRegionUpdateDisplays<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>focusedDc <span class="token operator">!=</span> dc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dc<span class="token punctuation">.</span><span class="token function">setTouchExcludeRegion</span><span class="token punctuation">(</span>null <span class="token comment" spellcheck="true">/* focusedTask */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 核心事件9</span>
        mService<span class="token punctuation">.</span><span class="token function">enableScreenIfNeededLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mService<span class="token punctuation">.</span><span class="token function">scheduleAnimationLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我在上面划分了9个部分：</p>
<ul>
<li>1.如果WMS发现当前的焦点Window发生了改变，则会调用updateFocusedWindowLocked重新测量窗口大小。</li>
<li>2.设置所有即将推出的WindowToken为不可见的标志位。</li>
<li>3.执行App transition(窗体动画)的时候，检测所有的窗体都可见。接着我们需要自然的完成我们的窗体动画，此时还没有真正的把视图绘制到屏幕上，因此为了实现这个事情，就需要推迟很多操作。如显示隐藏程序，按照z轴摆列窗体等等，因此需要重新建立Window的层级。</li>
<li>4.推迟壁纸的绘制。</li>
<li>5.清除需要销毁的Surface</li>
<li>6.更新触点事件的范围</li>
<li>7.清除掉那些当动画结束之后，需要推迟清除的Surface，接着重新对层级进行排序</li>
<li>8.更新触点事件策略，并且更新触点事件范围(这个会有专门的输入系统专栏和大家聊聊)</li>
<li>9.执行窗体动画</li>
</ul>
<p>这里只给总览，之后有机会再进去里面抓细节。</p>
<h3 id="WMS-updateFocusedWindowLocked"><a href="#WMS-updateFocusedWindowLocked" class="headerlink" title="WMS.updateFocusedWindowLocked"></a>WMS.updateFocusedWindowLocked</h3><p>我们能够看到无论是在哪里，如果窗口发生了变化，都会调用updateFocusedWindowLocked方法。实际上这个方法才是真正的核心测量窗口大小逻辑。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">boolean</span> <span class="token function">updateFocusedWindowLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> mode<span class="token punctuation">,</span> <span class="token keyword">boolean</span> updateInputWindows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        WindowState newFocus <span class="token operator">=</span> mRoot<span class="token punctuation">.</span><span class="token function">computeFocusedWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentFocus <span class="token operator">!=</span> newFocus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">final</span> DisplayContent displayContent <span class="token operator">=</span> <span class="token function">getDefaultDisplayContentLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> imWindowChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mInputMethodWindow <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> WindowState prevTarget <span class="token operator">=</span> mInputMethodTarget<span class="token punctuation">;</span>
                <span class="token keyword">final</span> WindowState newTarget <span class="token operator">=</span>
                        displayContent<span class="token punctuation">.</span><span class="token function">computeImeTarget</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* updateImeTarget*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                imWindowChanged <span class="token operator">=</span> prevTarget <span class="token operator">!=</span> newTarget<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">!=</span> UPDATE_FOCUS_WILL_ASSIGN_LAYERS
                        <span class="token operator">&amp;&amp;</span> mode <span class="token operator">!=</span> UPDATE_FOCUS_WILL_PLACE_SURFACES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> prevImeAnimLayer <span class="token operator">=</span> mInputMethodWindow<span class="token punctuation">.</span>mWinAnimator<span class="token punctuation">.</span>mAnimLayer<span class="token punctuation">;</span>
                    displayContent<span class="token punctuation">.</span><span class="token function">assignWindowLayers</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* setLayoutNeeded */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    imWindowChanged <span class="token operator">|=</span>
                            prevImeAnimLayer <span class="token operator">!=</span> mInputMethodWindow<span class="token punctuation">.</span>mWinAnimator<span class="token punctuation">.</span>mAnimLayer<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>imWindowChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mWindowsChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                displayContent<span class="token punctuation">.</span><span class="token function">setLayoutNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                newFocus <span class="token operator">=</span> mRoot<span class="token punctuation">.</span><span class="token function">computeFocusedWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">int</span> focusChanged <span class="token operator">=</span> mPolicy<span class="token punctuation">.</span><span class="token function">focusChangedLw</span><span class="token punctuation">(</span>oldFocus<span class="token punctuation">,</span> newFocus<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>imWindowChanged <span class="token operator">&amp;&amp;</span> oldFocus <span class="token operator">!=</span> mInputMethodWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> UPDATE_FOCUS_PLACING_SURFACES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    displayContent<span class="token punctuation">.</span><span class="token function">performLayout</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*initial*/</span><span class="token punctuation">,</span>  updateInputWindows<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    focusChanged <span class="token operator">&amp;=</span> <span class="token operator">~</span>FINISH_LAYOUT_REDO_LAYOUT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> UPDATE_FOCUS_WILL_PLACE_SURFACES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    displayContent<span class="token punctuation">.</span><span class="token function">assignWindowLayers</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* setLayoutNeeded */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>focusChanged <span class="token operator">&amp;</span> FINISH_LAYOUT_REDO_LAYOUT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                displayContent<span class="token punctuation">.</span><span class="token function">setLayoutNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> UPDATE_FOCUS_PLACING_SURFACES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    displayContent<span class="token punctuation">.</span><span class="token function">performLayout</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*initial*/</span><span class="token punctuation">,</span> updateInputWindows<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">!=</span> UPDATE_FOCUS_WILL_ASSIGN_LAYERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mInputMonitor<span class="token punctuation">.</span><span class="token function">setInputFocusLw</span><span class="token punctuation">(</span>mCurrentFocus<span class="token punctuation">,</span> updateInputWindows<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里注意一下isWindowChange是判断输入法焦点是否一致，而窗体焦点则是通过不同的WindowState来判断。</p>
<ul>
<li>1.首先如果发现有输入法弹窗则重新计算层级，或者说如果输入法焦点窗口发生变化，也要从RootWindowContainer找到当前的焦点窗口。</li>
<li>2.如果输入法焦点出现了变化，且当前的模式是UPDATE_FOCUS_PLACING_SURFACES(需要强制重绘）则要重新计算窗体大小，否则则直接做一次层级变化即可。</li>
<li><ol start="3">
<li>一般的情况下，如果UPDATE_FOCUS_PLACING_SURFACES这个模式，则需要performLayout重新测量窗体各个边距大小</li>
</ol>
</li>
<li>4.不是UPDATE_FOCUS_WILL_ASSIGN_LAYERS模式，则则需要处理触点焦点边距。</li>
</ul>
<p>实际上核心测量的真正动作是DisplayContent.performLayout。我们仔细一想也就知道，在Android 9.0的时候，DisplayContent象征着逻辑屏幕，我们讨论无分屏的情况，实际上就是指我们当前窗体铺满逻辑显示屏各个边距的大小。</p>
<h3 id="窗体边距的类型"><a href="#窗体边距的类型" class="headerlink" title="窗体边距的类型"></a>窗体边距的类型</h3><p>在正式开始聊窗体大小的测量之前，实际上，在Android系统中，为了把Window各个边界标记出来，实际上随着时代和审美潮流的演进，诞生越来越多的边距类型，我们往往可以通过这些边距来测定窗体的大小。</p>
<p>在DisplayFrame中有了大致的分区，如下：</p>
<table>
<thead>
<tr>
<th>type</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>mOverScan</td>
<td>带有这个前后缀的边距名字代表着过扫描。过扫描是什么东西？实际上在我们在自己看自己的手机屏幕，会发现手机屏幕显示范围并未铺满全屏，而是留有一点黑色的边框。而这个黑色的部分就是就是过扫描区域。原因是如果把显示范围铺面全屏，如电视机之类的屏幕会导致失真。<img src="/images/%E8%BF%87%E6%89%AB%E6%8F%8F%E5%8C%BA%E5%9F%9F.png" alt="过扫描区域.png"></td>
</tr>
<tr>
<td>mOverScanScreen</td>
<td>代表着显示屏真实宽高，是带上了过扫描的边距范围 <img src="/images/OverScanScreen.png" alt="OverScanScreen.png"></td>
</tr>
<tr>
<td>mRestrictedOverscan</td>
<td>类似OverScanScreen，适当的时候允许移动到OverScanScreen中</td>
</tr>
<tr>
<td>mUnrestricted</td>
<td>真实屏幕大小，但是不包含OverScan区域</td>
</tr>
<tr>
<td>mRestricted</td>
<td>当前屏幕大小;如果状态栏无法隐藏，则这些值可能不同于(0,0)-(dw,dh);在这种情况下，它有效地将显示区域从所有其他窗口分割出来。</td>
</tr>
<tr>
<td>mSystem</td>
<td>在布局期间，所有可见的SysytemUI元素区域</td>
</tr>
<tr>
<td>mStable</td>
<td>稳定不变的应用内容区域</td>
</tr>
<tr>
<td>mStableFullscreen</td>
<td>对于稳定不变的应用区域，但是这个Window是添加了FullScreen标志，这是除了StatusBar以外的区域</td>
</tr>
<tr>
<td>mCurrent</td>
<td>在布局期间，当前屏幕且带上键盘，状态栏的区域(虽然不好理解，但是如果是分屏和自由窗口模式就好理解了）</td>
</tr>
<tr>
<td>mContent</td>
<td>布局期间，向用户展示内容的所有区域，包括所有的外部装饰如状态来和键盘，一般和mCurrent一样，除非使用了嵌套模式，则会比mCurrent更大。</td>
</tr>
<tr>
<td>mVoiceContent</td>
<td>布局期间，我们声量变化时候的系统区域</td>
</tr>
<tr>
<td>mDock</td>
<td>输入法窗体区域</td>
</tr>
<tr>
<td>mDisplayCutout</td>
<td>刘海屏上面那一块的区域</td>
</tr>
<tr>
<td>mDisplayCutoutSafe</td>
<td>刘海屏不允许使用交叉部分<img src="/images/%E5%88%98%E6%B5%B7%E5%B1%8F%E4%B8%8D%E5%85%81%E8%AE%B8%E4%BD%BF%E7%94%A8%E4%BA%A4%E5%8F%89%E9%83%A8%E5%88%86.png" alt="刘海屏不允许使用交叉部分.png"></td>
</tr>
</tbody></table>
<p>可以看到，这些窗体的边距实际上是跟着这些年潮流走的。如Android 7.0的自由窗体模式，嵌套窗体模式，刘海屏等等，这些边距的共同作用，才会诞生一个真正的Window大小。有了这些基础知识之后，我们去看看测量大小的逻辑。</p>
<h3 id="DisplayContent-performLayout"><a href="#DisplayContent-performLayout" class="headerlink" title="DisplayContent.performLayout"></a>DisplayContent.performLayout</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">performLayout</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> initial<span class="token punctuation">,</span> <span class="token keyword">boolean</span> updateInputWindows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLayoutNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">clearLayoutNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> dw <span class="token operator">=</span> mDisplayInfo<span class="token punctuation">.</span>logicalWidth<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> dh <span class="token operator">=</span> mDisplayInfo<span class="token punctuation">.</span>logicalHeight<span class="token punctuation">;</span>

        mDisplayFrames<span class="token punctuation">.</span><span class="token function">onDisplayInfoUpdated</span><span class="token punctuation">(</span>mDisplayInfo<span class="token punctuation">,</span>
                <span class="token function">calculateDisplayCutoutForRotation</span><span class="token punctuation">(</span>mDisplayInfo<span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDisplayFrames<span class="token punctuation">.</span>mRotation <span class="token operator">=</span> mRotation<span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">.</span><span class="token function">beginLayoutLw</span><span class="token punctuation">(</span>mDisplayFrames<span class="token punctuation">,</span> <span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>uiMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isDefaultDisplay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span>mSystemDecorLayer <span class="token operator">=</span> mService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">.</span><span class="token function">getSystemDecorLayerLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span>mScreenRect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> dw<span class="token punctuation">,</span> dh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> seq <span class="token operator">=</span> mLayoutSeq <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seq <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> seq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        mLayoutSeq <span class="token operator">=</span> seq<span class="token punctuation">;</span>

        mTmpWindow <span class="token operator">=</span> null<span class="token punctuation">;</span>
        mTmpInitial <span class="token operator">=</span> initial<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 首先测量那些没有绑定父窗口的窗口</span>
        <span class="token function">forAllWindows</span><span class="token punctuation">(</span>mPerformLayout<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* traverseTopToBottom */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token comment" spellcheck="true">//测量那些绑定了父窗口的窗口</span>
        <span class="token function">forAllWindows</span><span class="token punctuation">(</span>mPerformLayoutAttached<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* traverseTopToBottom */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们这里把这个方法拆成如下几个部分：</p>
<ul>
<li>设置DisplayFrame</li>
<li>beginLayoutLw开始测量</li>
<li>测量那些没有绑定父窗口的窗口</li>
<li>测量那些绑定了父窗口的窗口</li>
</ul>
<h3 id="设置DisplayFrame"><a href="#设置DisplayFrame" class="headerlink" title="设置DisplayFrame"></a>设置DisplayFrame</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDisplayInfoUpdated</span><span class="token punctuation">(</span>DisplayInfo info<span class="token punctuation">,</span> WmDisplayCutout displayCutout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mDisplayWidth <span class="token operator">=</span> info<span class="token punctuation">.</span>logicalWidth<span class="token punctuation">;</span>
        mDisplayHeight <span class="token operator">=</span> info<span class="token punctuation">.</span>logicalHeight<span class="token punctuation">;</span>
        mRotation <span class="token operator">=</span> info<span class="token punctuation">.</span>rotation<span class="token punctuation">;</span>
        mDisplayInfoOverscan<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
                info<span class="token punctuation">.</span>overscanLeft<span class="token punctuation">,</span> info<span class="token punctuation">.</span>overscanTop<span class="token punctuation">,</span> info<span class="token punctuation">.</span>overscanRight<span class="token punctuation">,</span> info<span class="token punctuation">.</span>overscanBottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDisplayInfoCutout <span class="token operator">=</span> displayCutout <span class="token operator">!=</span> null <span class="token operator">?</span> displayCutout <span class="token operator">:</span> WmDisplayCutout<span class="token punctuation">.</span>NO_CUTOUT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，此时会设置当前显示屏幕的大小，以及获取过扫描区域，还会判断当前手机屏幕是否支持刘海屏。这一切实际上都是由硬件回馈到DisplayService，我们再从中获取的信息。</p>
<h4 id="PhoneWindowManager-beginLayoutLw开始测量大小与边距"><a href="#PhoneWindowManager-beginLayoutLw开始测量大小与边距" class="headerlink" title="PhoneWindowManager.beginLayoutLw开始测量大小与边距"></a>PhoneWindowManager.beginLayoutLw开始测量大小与边距</h4><p>实际上如果有读者注意到我写的WMS第一篇就会看到实际上WMS初始化的时候，我们能够看到WMS会初始化一个WindowManagerPolicy的策略，而这个策略就是PhoneWindowManager。实际上这也支持了系统开发自定义策略，从而办到自己想要的窗体计算结果。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beginLayoutLw</span><span class="token punctuation">(</span>DisplayFrames displayFrames<span class="token punctuation">,</span> <span class="token keyword">int</span> uiMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        displayFrames<span class="token punctuation">.</span><span class="token function">onBeginLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSystemGestures<span class="token punctuation">.</span>screenWidth <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSystemGestures<span class="token punctuation">.</span>screenHeight <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDockLayer <span class="token operator">=</span> <span class="token number">0x10000000</span><span class="token punctuation">;</span>
        mStatusBarLayer <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// start with the current dock rect, which will be (0,0,displayWidth,displayHeight)</span>
        <span class="token keyword">final</span> Rect pf <span class="token operator">=</span> mTmpParentFrame<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//父窗口大小</span>
        <span class="token keyword">final</span> Rect df <span class="token operator">=</span> mTmpDisplayFrame<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//显示屏大小</span>
        <span class="token keyword">final</span> Rect of <span class="token operator">=</span> mTmpOverscanFrame<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//过扫描大小</span>
        <span class="token keyword">final</span> Rect vf <span class="token operator">=</span> mTmpVisibleFrame<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//可见区域大小</span>
        <span class="token keyword">final</span> Rect dcf <span class="token operator">=</span> mTmpDecorFrame<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//输入法大小</span>
        vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dcf<span class="token punctuation">.</span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Decor frame N/A for system bars.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDisplayId <span class="token operator">==</span> DEFAULT_DISPLAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> sysui <span class="token operator">=</span> mLastSystemUiFlags<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> navVisible <span class="token operator">=</span> <span class="token punctuation">(</span>sysui <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_HIDE_NAVIGATION<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> navTranslucent <span class="token operator">=</span> <span class="token punctuation">(</span>sysui
                    <span class="token operator">&amp;</span> <span class="token punctuation">(</span>View<span class="token punctuation">.</span>NAVIGATION_BAR_TRANSLUCENT <span class="token operator">|</span> View<span class="token punctuation">.</span>NAVIGATION_BAR_TRANSPARENT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> immersive <span class="token operator">=</span> <span class="token punctuation">(</span>sysui <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_IMMERSIVE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> immersiveSticky <span class="token operator">=</span> <span class="token punctuation">(</span>sysui <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_IMMERSIVE_STICKY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> navAllowedHidden <span class="token operator">=</span> immersive <span class="token operator">||</span> immersiveSticky<span class="token punctuation">;</span>
            navTranslucent <span class="token operator">&amp;=</span> <span class="token operator">!</span>immersiveSticky<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// transient trumps translucent</span>
            <span class="token keyword">boolean</span> isKeyguardShowing <span class="token operator">=</span> <span class="token function">isStatusBarKeyguard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mKeyguardOccluded<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isKeyguardShowing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                navTranslucent <span class="token operator">&amp;=</span> <span class="token function">areTranslucentBarsAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">boolean</span> statusBarExpandedNotKeyguard <span class="token operator">=</span> <span class="token operator">!</span>isKeyguardShowing <span class="token operator">&amp;&amp;</span> mStatusBar <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> mStatusBar<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>height <span class="token operator">==</span> MATCH_PARENT
                    <span class="token operator">&amp;&amp;</span> mStatusBar<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width <span class="token operator">==</span> MATCH_PARENT<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            navVisible <span class="token operator">|=</span> <span class="token operator">!</span><span class="token function">canHideNavigationBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">boolean</span> updateSysUiVisibility <span class="token operator">=</span> <span class="token function">layoutNavigationBar</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">,</span> uiMode<span class="token punctuation">,</span> dcf<span class="token punctuation">,</span>
                    navVisible<span class="token punctuation">,</span> navTranslucent<span class="token punctuation">,</span> navAllowedHidden<span class="token punctuation">,</span> statusBarExpandedNotKeyguard<span class="token punctuation">)</span><span class="token punctuation">;</span>
            updateSysUiVisibility <span class="token operator">|=</span> <span class="token function">layoutStatusBar</span><span class="token punctuation">(</span>
                    displayFrames<span class="token punctuation">,</span> pf<span class="token punctuation">,</span> df<span class="token punctuation">,</span> of<span class="token punctuation">,</span> vf<span class="token punctuation">,</span> dcf<span class="token punctuation">,</span> sysui<span class="token punctuation">,</span> isKeyguardShowing<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>updateSysUiVisibility<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">updateSystemUiVisibilityLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">layoutScreenDecorWindows</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">,</span> pf<span class="token punctuation">,</span> df<span class="token punctuation">,</span> dcf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDisplayCutoutSafe<span class="token punctuation">.</span>top <span class="token operator">></span> displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">.</span>top<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            displayFrames<span class="token punctuation">.</span>mDisplayCutoutSafe<span class="token punctuation">.</span>top <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDisplayCutoutSafe<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
                    displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先初始化几个参数，父窗体，屏幕，过扫描，可见区域，输入法区域为当前逻辑显示屏的大小，等到后面做裁剪。</p>
<p>能看到所有的事情实际上是关注的是系统UI上的判断，检测NavBar，StatusBar大小。最后再判断当前刘海屏的不允许交叉的区域顶部和显示屏顶部哪个大。如果mDisplayCutoutSafe的top大于mUnrestricted的top，说明mDisplayCutoutSafe在mUnrestricted下面，也就是我上面那个包含一段黑色的区域。此时会拿稳定的应用区域和刘海区域顶部的最大值，作为刘海屏幕的区域。这样就能保证刘海屏的顶部就是状态栏。</p>
<p>提一句如果NavigationBar隐藏，则会创建一个虚假的区域把输入事件都捕捉起来。</p>
<p>里面有四个关键函数：</p>
<ul>
<li>函数onBeginLayout，初始化了所有边距值</li>
<li>layoutNavigationBar ,测量NavigationBar</li>
<li>layoutStatusBar 测量layoutStatusBar</li>
<li>layoutScreenDecorWindows 测量所有装饰窗口</li>
</ul>
<h4 id="DisplayFrame-onBeginLayout"><a href="#DisplayFrame-onBeginLayout" class="headerlink" title="DisplayFrame.onBeginLayout"></a>DisplayFrame.onBeginLayout</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onBeginLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>mRotation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> ROTATION_90<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> ROTATION_180<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> ROTATION_270<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                mRotatedDisplayInfoOverscan<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mDisplayInfoOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mRestrictedOverscan<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mDisplayWidth<span class="token punctuation">,</span> mDisplayHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mOverscan<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mRestrictedOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSystem<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mRestrictedOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mUnrestricted<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mRotatedDisplayInfoOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mUnrestricted<span class="token punctuation">.</span>right <span class="token operator">=</span> mDisplayWidth <span class="token operator">-</span> mUnrestricted<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
        mUnrestricted<span class="token punctuation">.</span>bottom <span class="token operator">=</span> mDisplayHeight <span class="token operator">-</span> mUnrestricted<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
        mRestricted<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mContent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mVoiceContent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mStable<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mStableFullscreen<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCurrent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mDisplayCutout <span class="token operator">=</span> mDisplayInfoCutout<span class="token punctuation">;</span>
        mDisplayCutoutSafe<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">,</span>
                Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mDisplayCutout<span class="token punctuation">.</span><span class="token function">getDisplayCutout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> DisplayCutout c <span class="token operator">=</span> mDisplayCutout<span class="token punctuation">.</span><span class="token function">getDisplayCutout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">getSafeInsetLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mDisplayCutoutSafe<span class="token punctuation">.</span>left <span class="token operator">=</span> mRestrictedOverscan<span class="token punctuation">.</span>left <span class="token operator">+</span> c<span class="token punctuation">.</span><span class="token function">getSafeInsetLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">getSafeInsetTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mDisplayCutoutSafe<span class="token punctuation">.</span>top <span class="token operator">=</span> mRestrictedOverscan<span class="token punctuation">.</span>top <span class="token operator">+</span> c<span class="token punctuation">.</span><span class="token function">getSafeInsetTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">getSafeInsetRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mDisplayCutoutSafe<span class="token punctuation">.</span>right <span class="token operator">=</span> mRestrictedOverscan<span class="token punctuation">.</span>right <span class="token operator">-</span> c<span class="token punctuation">.</span><span class="token function">getSafeInsetRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">getSafeInsetBottom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mDisplayCutoutSafe<span class="token punctuation">.</span>bottom <span class="token operator">=</span> mRestrictedOverscan<span class="token punctuation">.</span>bottom <span class="token operator">-</span> c<span class="token punctuation">.</span><span class="token function">getSafeInsetBottom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到所有的所有的间距将会设置为mUnrestricted的初始宽高，也就是不包含OverScan区域。如果是遇到刘海屏，则会根据设置的SafeInset区域来设置mDisplayCutoutSafe的安全区域。也就是我上面那种情况。比如设置了LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT这种情况，显示区域将不会超过刘海屏的底部。</p>
<h4 id="layoutNavigationBar测量NavigationBar"><a href="#layoutNavigationBar测量NavigationBar" class="headerlink" title="layoutNavigationBar测量NavigationBar"></a>layoutNavigationBar测量NavigationBar</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">layoutNavigationBar</span><span class="token punctuation">(</span>DisplayFrames displayFrames<span class="token punctuation">,</span> <span class="token keyword">int</span> uiMode<span class="token punctuation">,</span> Rect dcf<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> navVisible<span class="token punctuation">,</span> <span class="token keyword">boolean</span> navTranslucent<span class="token punctuation">,</span> <span class="token keyword">boolean</span> navAllowedHidden<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> statusBarExpandedNotKeyguard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mNavigationBar <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> transientNavBarShowing <span class="token operator">=</span> mNavigationBarController<span class="token punctuation">.</span><span class="token function">isTransientShowing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> rotation <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mRotation<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> displayHeight <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mDisplayHeight<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> displayWidth <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mDisplayWidth<span class="token punctuation">;</span>
        <span class="token keyword">final</span> Rect dockFrame <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">;</span>
        mNavigationBarPosition <span class="token operator">=</span> <span class="token function">navigationBarPosition</span><span class="token punctuation">(</span>displayWidth<span class="token punctuation">,</span> displayHeight<span class="token punctuation">,</span> rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> Rect cutoutSafeUnrestricted <span class="token operator">=</span> mTmpRect<span class="token punctuation">;</span>
        cutoutSafeUnrestricted<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cutoutSafeUnrestricted<span class="token punctuation">.</span><span class="token function">intersectUnchecked</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDisplayCutoutSafe<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mNavigationBarPosition <span class="token operator">==</span> NAV_BAR_BOTTOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> top <span class="token operator">=</span> cutoutSafeUnrestricted<span class="token punctuation">.</span>bottom
                    <span class="token operator">-</span> <span class="token function">getNavigationBarHeight</span><span class="token punctuation">(</span>rotation<span class="token punctuation">,</span> uiMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mTmpNavigationFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> top<span class="token punctuation">,</span> displayWidth<span class="token punctuation">,</span> displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>bottom <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mStableFullscreen<span class="token punctuation">.</span>bottom <span class="token operator">=</span> top<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>navVisible <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>navTranslucent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>navAllowedHidden
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mNavigationBar<span class="token punctuation">.</span><span class="token function">isAnimatingLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mNavigationBarController<span class="token punctuation">.</span><span class="token function">wasRecentlyTranslucent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                displayFrames<span class="token punctuation">.</span>mSystem<span class="token punctuation">.</span>bottom <span class="token operator">=</span> top<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//不关注旋转后的测量</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        displayFrames<span class="token punctuation">.</span>mCurrent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        displayFrames<span class="token punctuation">.</span>mVoiceContent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mStatusBarLayer <span class="token operator">=</span> mNavigationBar<span class="token punctuation">.</span><span class="token function">getSurfaceLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mNavigationBar<span class="token punctuation">.</span><span class="token function">computeFrameLw</span><span class="token punctuation">(</span>mTmpNavigationFrame<span class="token punctuation">,</span> mTmpNavigationFrame<span class="token punctuation">,</span>
                mTmpNavigationFrame<span class="token punctuation">,</span> displayFrames<span class="token punctuation">.</span>mDisplayCutoutSafe<span class="token punctuation">,</span> mTmpNavigationFrame<span class="token punctuation">,</span> dcf<span class="token punctuation">,</span>
                mTmpNavigationFrame<span class="token punctuation">,</span> displayFrames<span class="token punctuation">.</span>mDisplayCutoutSafe<span class="token punctuation">,</span>
                displayFrames<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* parentFrameWasClippedByDisplayCutout */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mNavigationBarController<span class="token punctuation">.</span><span class="token function">setContentFrame</span><span class="token punctuation">(</span>mNavigationBar<span class="token punctuation">.</span><span class="token function">getContentFrameLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> mNavigationBarController<span class="token punctuation">.</span><span class="token function">checkHiddenLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们关注到mTmpNavigationFrame这个对象的赋值，在正常的情况下的范围是如下：</p>
<blockquote>
<p>left: 0<br>top:刘海屏的安全区 - Navigation高度(也就是刘海屏幕的安全区向上移动Navigation高度)<br>right：displayWidth(屏幕宽度)<br>bottom: mUnrestricted(不包含过扫描区域的底部)</p>
</blockquote>
<p>此时mStable和mStableFullscreen区域的底部都是对应着top，也就是对应着Navigation顶部。System系统元素的底部也是Navigation顶部。</p>
<p>最后经过computeFrameLw重新计算这个区域的值。这个方法稍后会聊到，但是在正常手机开发中，其实是没有变化的。也就说，实际上对于mNavigationBar来说:</p>
<blockquote>
<p>可见区域，过扫描区域，内容区域，Dock区域：mTmpNavigationFrame<br>过扫描区域，稳定区域，刘海裁剪安全区:displayFrames.mDisplayCutoutSafe</p>
</blockquote>
<h4 id="layoutStatusBar-测量layoutStatusBar"><a href="#layoutStatusBar-测量layoutStatusBar" class="headerlink" title="layoutStatusBar 测量layoutStatusBar"></a>layoutStatusBar 测量layoutStatusBar</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">layoutStatusBar</span><span class="token punctuation">(</span>DisplayFrames displayFrames<span class="token punctuation">,</span> Rect pf<span class="token punctuation">,</span> Rect df<span class="token punctuation">,</span> Rect of<span class="token punctuation">,</span> Rect vf<span class="token punctuation">,</span>
            Rect dcf<span class="token punctuation">,</span> <span class="token keyword">int</span> sysui<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isKeyguardShowing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// decide where the status bar goes ahead of time</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStatusBar <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mStatusBarLayer <span class="token operator">=</span> mStatusBar<span class="token punctuation">.</span><span class="token function">getSurfaceLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
size<span class="token punctuation">.</span>
        mStatusBar<span class="token punctuation">.</span><span class="token function">computeFrameLw</span><span class="token punctuation">(</span>pf <span class="token comment" spellcheck="true">/* parentFrame */</span><span class="token punctuation">,</span> df <span class="token comment" spellcheck="true">/* displayFrame */</span><span class="token punctuation">,</span>
                vf <span class="token comment" spellcheck="true">/* overlayFrame */</span><span class="token punctuation">,</span> vf <span class="token comment" spellcheck="true">/* contentFrame */</span><span class="token punctuation">,</span> vf <span class="token comment" spellcheck="true">/* visibleFrame */</span><span class="token punctuation">,</span>
                dcf <span class="token comment" spellcheck="true">/* decorFrame */</span><span class="token punctuation">,</span> vf <span class="token comment" spellcheck="true">/* stableFrame */</span><span class="token punctuation">,</span> vf <span class="token comment" spellcheck="true">/* outsetFrame */</span><span class="token punctuation">,</span>
                displayFrames<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* parentFrameWasClippedByDisplayCutout */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>top <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">.</span>top
                <span class="token operator">+</span> mStatusBarHeightForRotation<span class="token punctuation">[</span>displayFrames<span class="token punctuation">.</span>mRotation<span class="token punctuation">]</span><span class="token punctuation">;</span>
        displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>top <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
                displayFrames<span class="token punctuation">.</span>mDisplayCutoutSafe<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mStatusBarController<span class="token punctuation">.</span><span class="token function">setContentFrame</span><span class="token punctuation">(</span>mTmpRect<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStatusBar<span class="token punctuation">.</span><span class="token function">isVisibleLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>statusBarTransient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> Rect dockFrame <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">;</span>
            dockFrame<span class="token punctuation">.</span>top <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>top<span class="token punctuation">;</span>
            displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            displayFrames<span class="token punctuation">.</span>mVoiceContent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            displayFrames<span class="token punctuation">.</span>mCurrent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mStatusBar<span class="token punctuation">.</span><span class="token function">isAnimatingLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>statusBarTranslucent
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mStatusBarController<span class="token punctuation">.</span><span class="token function">wasRecentlyTranslucent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                displayFrames<span class="token punctuation">.</span>mSystem<span class="token punctuation">.</span>top <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>top<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mStatusBarController<span class="token punctuation">.</span><span class="token function">checkHiddenLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同理对于statusBar来说：</p>
<blockquote>
<p>父亲区域，显示屏区域，过扫描区域，内容区域，可见区域，稳定区域，外部区域全部都是mUnrestricted<br>Dock区域为0</p>
</blockquote>
<p>注意，此时如果statusBar可见，则做如下计算：</p>
<blockquote>
<p>displayFrames.mStable的顶部向下移动StatusBar的高度位置，接着判断安全裁剪去和当前哪个更接近底部一点，则获取哪个。这样就能保证我们的应用一定能在StatusBar之下，且能够被刘海安全裁剪。</p>
</blockquote>
<blockquote>
<p>如果Statusbar可见，当然dockFrame，整体也要从屏幕去除过扫描区域的顶部向下移动StatusBar高度的位置。mSystem代表的系统元素也是同理。这样就能保证没人挡住系统状态栏。</p>
</blockquote>
<p><em>这种情况挺常见的，我们从一个隐藏状态栏的页面跳转到有状态栏的页面，国有有个PopupWindow，你能看到这个popwindow会明显向下移动。</em></p>
<h4 id="layoutScreenDecorWindows"><a href="#layoutScreenDecorWindows" class="headerlink" title="layoutScreenDecorWindows"></a>layoutScreenDecorWindows</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">layoutScreenDecorWindows</span><span class="token punctuation">(</span>DisplayFrames displayFrames<span class="token punctuation">,</span> Rect pf<span class="token punctuation">,</span> Rect df<span class="token punctuation">,</span> Rect dcf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mScreenDecorWindows<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> displayId <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">;</span>
        <span class="token keyword">final</span> Rect dockFrame <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> displayHeight <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mDisplayHeight<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> displayWidth <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mDisplayWidth<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mScreenDecorWindows<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> WindowState w <span class="token operator">=</span> mScreenDecorWindows<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> displayId <span class="token operator">||</span> <span class="token operator">!</span>w<span class="token punctuation">.</span><span class="token function">isVisibleLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Skip if not on the same display or not visible.</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            w<span class="token punctuation">.</span><span class="token function">computeFrameLw</span><span class="token punctuation">(</span>pf <span class="token comment" spellcheck="true">/* parentFrame */</span><span class="token punctuation">,</span> df <span class="token comment" spellcheck="true">/* displayFrame */</span><span class="token punctuation">,</span> df <span class="token comment" spellcheck="true">/* overlayFrame */</span><span class="token punctuation">,</span>
                    df <span class="token comment" spellcheck="true">/* contentFrame */</span><span class="token punctuation">,</span> df <span class="token comment" spellcheck="true">/* visibleFrame */</span><span class="token punctuation">,</span> dcf <span class="token comment" spellcheck="true">/* decorFrame */</span><span class="token punctuation">,</span>
                    df <span class="token comment" spellcheck="true">/* stableFrame */</span><span class="token punctuation">,</span> df <span class="token comment" spellcheck="true">/* outsetFrame */</span><span class="token punctuation">,</span> displayFrames<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">,</span>
                    <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* parentFrameWasClippedByDisplayCutout */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Rect frame <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">getFrameLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>left <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> frame<span class="token punctuation">.</span>top <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Docked at left or top.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>bottom <span class="token operator">>=</span> displayHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Docked left.</span>
                    dockFrame<span class="token punctuation">.</span>left <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>right<span class="token punctuation">,</span> dockFrame<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>right <span class="token operator">>=</span> displayWidth <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Docked top.</span>
                    dockFrame<span class="token punctuation">.</span>top <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>bottom<span class="token punctuation">,</span> dockFrame<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>right <span class="token operator">>=</span> displayWidth <span class="token operator">&amp;&amp;</span> frame<span class="token punctuation">.</span>bottom <span class="token operator">>=</span> displayHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Docked at right or bottom.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>top <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Docked right.</span>
                    dockFrame<span class="token punctuation">.</span>right <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>left<span class="token punctuation">,</span> dockFrame<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>left <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Docked bottom.</span>
                    dockFrame<span class="token punctuation">.</span>bottom <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>top<span class="token punctuation">,</span> dockFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        displayFrames<span class="token punctuation">.</span>mCurrent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        displayFrames<span class="token punctuation">.</span>mVoiceContent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        displayFrames<span class="token punctuation">.</span>mSystem<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        displayFrames<span class="token punctuation">.</span>mRestrictedOverscan<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dockFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个方法中mScreenDecorWindows这个集合实际上是在adjustWindowParamsLw以及prepareAddWindowLw这两个方法中加入。加入的条件是，每当有新的Window加入(WMS的addView)或者Window需要重新调整(WMS的relayoutWindow)，当前新增得到Window或者需要重新relayout的Window有StatusBar有权限，且显示则会添加到mScreenDecorWindows集合。</p>
<p>mScreenDecorWindows从上面的描述，能得知实际上这个步骤还没有根据层级作区分。但是没关系，此时仅仅只是初步的测量。</p>
<p>明白了mScreenDecorWindows之后，我们阅读上面这个方法就很简单了。</p>
<p>layoutScreenDecorWindows做的事情就如名字一样，要测量Window上装饰部分，如StatusBar，如输入法。此时经过循环，自尾部往头部调用所有的WindowState的computeFrameLw计算每一个WindowState的对应Window的窗体大小。</p>
<p>当计算出每一个窗体大小之后，将会把事件分成两个情况，当计算出来的当前的Window的left和top都小于等于0，也就是说，当前的Window的顶部边缘并且左边缘超过了当前的屏幕。</p>
<p>说明了有什么东西在右下侧把整个Window定上去了。因此dockFrame的计算就很简单了:</p>
<ul>
<li>当当前的Frame的底部大于等于屏幕高度，说明底部可能没东西，dockFrame在右边。计算最左侧的的位置(dockFrame.left)就是当前窗体和之前WindowState相比谁在右侧就取谁。</li>
<li>当当前的Frame的右侧大于等于屏幕宽度，说明右边可能没东西，dockFrame在底部。只需要计算dockFrame的顶部(dockFrame.top)和frame的底部谁大(谁更靠近底部)就获谁。</li>
</ul>
<p>如果计算出来的bottom大于等于屏幕高度且right大于等于屏幕宽度。说明有什么东西在左上方把整个Window顶下去了。</p>
<ul>
<li>当当前的Frame的顶部小于等于0，说明没有东西顶住上方，dock在左边。只要需要计算dockFrame右侧即可，计算原来的dockFrame的右侧(dockFrame.right)和当前的Frame的左侧更加靠左获取谁。</li>
<li>当当前的Frame左侧小于等于0，则说明没有东西在左侧，dock在顶部。只需要计算dockFrame的底部(dockFrame.bottom)和当前的frame的顶部谁更加小(靠近顶部)则获取谁。</li>
</ul>
<p><strong>最后再设置这个把displayFrames的可见等区域都设置为dockFrame。联合上下文，实际上这里就是把整个区域的顶部移动到了statusBar之下。</strong></p>
<h4 id="WindowState-computeFrameLw"><a href="#WindowState-computeFrameLw" class="headerlink" title="WindowState.computeFrameLw"></a>WindowState.computeFrameLw</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">computeFrameLw</span><span class="token punctuation">(</span>Rect parentFrame<span class="token punctuation">,</span> Rect displayFrame<span class="token punctuation">,</span> Rect overscanFrame<span class="token punctuation">,</span>
            Rect contentFrame<span class="token punctuation">,</span> Rect visibleFrame<span class="token punctuation">,</span> Rect decorFrame<span class="token punctuation">,</span> Rect stableFrame<span class="token punctuation">,</span>
            Rect outsetFrame<span class="token punctuation">,</span> WmDisplayCutout displayCutout<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> parentFrameWasClippedByDisplayCutout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> Rect layoutContainingFrame<span class="token punctuation">;</span>
        <span class="token keyword">final</span> Rect layoutDisplayFrame<span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> layoutXDiff<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> layoutYDiff<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//核心事件1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inFullscreenContainer <span class="token operator">||</span> <span class="token function">layoutInParentFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 当全屏的时候，设置内容区域就是父亲区域，显示屏区域就是传进来的显示屏区域，并且窗体没有位移</span>
            mContainingFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parentFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mDisplayFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            layoutDisplayFrame <span class="token operator">=</span> displayFrame<span class="token punctuation">;</span>
            layoutContainingFrame <span class="token operator">=</span> parentFrame<span class="token punctuation">;</span>
            layoutXDiff <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            layoutYDiff <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//当不是的全屏或者在父亲窗体内部的模式</span>
            <span class="token function">getBounds</span><span class="token punctuation">(</span>mContainingFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppToken <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mAppToken<span class="token punctuation">.</span>mFrozenBounds<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                Rect frozen <span class="token operator">=</span> mAppToken<span class="token punctuation">.</span>mFrozenBounds<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mContainingFrame<span class="token punctuation">.</span>right <span class="token operator">=</span> mContainingFrame<span class="token punctuation">.</span>left <span class="token operator">+</span> frozen<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mContainingFrame<span class="token punctuation">.</span>bottom <span class="token operator">=</span> mContainingFrame<span class="token punctuation">.</span>top <span class="token operator">+</span> frozen<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>imeWin <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> imeWin<span class="token punctuation">.</span><span class="token function">isVisibleNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isInputMethodTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inFreeformWindowingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> mContainingFrame<span class="token punctuation">.</span>bottom <span class="token operator">></span> contentFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mContainingFrame<span class="token punctuation">.</span>top <span class="token operator">-=</span> mContainingFrame<span class="token punctuation">.</span>bottom <span class="token operator">-</span> contentFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">inPinnedWindowingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> mContainingFrame<span class="token punctuation">.</span>bottom <span class="token operator">></span> parentFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mContainingFrame<span class="token punctuation">.</span>bottom <span class="token operator">=</span> parentFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true">//显示屏区域就是内容区域</span>
            mDisplayFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mContainingFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//计算偏移量，这个偏移量的计算是根据动画的临时区域来变化</span>
            layoutXDiff <span class="token operator">=</span> <span class="token operator">!</span>mInsetFrame<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> mInsetFrame<span class="token punctuation">.</span>left <span class="token operator">-</span> mContainingFrame<span class="token punctuation">.</span>left <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            layoutYDiff <span class="token operator">=</span> <span class="token operator">!</span>mInsetFrame<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> mInsetFrame<span class="token punctuation">.</span>top <span class="token operator">-</span> mContainingFrame<span class="token punctuation">.</span>top <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            layoutContainingFrame <span class="token operator">=</span> <span class="token operator">!</span>mInsetFrame<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> mInsetFrame <span class="token operator">:</span> mContainingFrame<span class="token punctuation">;</span>
            mTmpRect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> dc<span class="token punctuation">.</span><span class="token function">getDisplayInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>logicalWidth<span class="token punctuation">,</span> dc<span class="token punctuation">.</span><span class="token function">getDisplayInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>logicalHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//合并所有的区域到显示屏区域中</span>
            <span class="token function">subtractInsets</span><span class="token punctuation">(</span>mDisplayFrame<span class="token punctuation">,</span> layoutContainingFrame<span class="token punctuation">,</span> displayFrame<span class="token punctuation">,</span> mTmpRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">layoutInParentFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">subtractInsets</span><span class="token punctuation">(</span>mContainingFrame<span class="token punctuation">,</span> layoutContainingFrame<span class="token punctuation">,</span> parentFrame<span class="token punctuation">,</span> mTmpRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">subtractInsets</span><span class="token punctuation">(</span>mInsetFrame<span class="token punctuation">,</span> layoutContainingFrame<span class="token punctuation">,</span> parentFrame<span class="token punctuation">,</span> mTmpRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            layoutDisplayFrame <span class="token operator">=</span> displayFrame<span class="token punctuation">;</span>
            layoutDisplayFrame<span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span>layoutContainingFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> pw <span class="token operator">=</span> mContainingFrame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> ph <span class="token operator">=</span> mContainingFrame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mParentFrame<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parentFrame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mParentFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parentFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mContentChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRequestedWidth <span class="token operator">!=</span> mLastRequestedWidth <span class="token operator">||</span> mRequestedHeight <span class="token operator">!=</span> mLastRequestedHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mLastRequestedWidth <span class="token operator">=</span> mRequestedWidth<span class="token punctuation">;</span>
            mLastRequestedHeight <span class="token operator">=</span> mRequestedHeight<span class="token punctuation">;</span>
            mContentChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//核心事件2</span>
<span class="token comment" spellcheck="true">//设置各个区域的参数</span>
        mOverscanFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>overscanFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mContentFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>contentFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mVisibleFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>visibleFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDecorFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>decorFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mStableFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>stableFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasOutsets <span class="token operator">=</span> outsetFrame <span class="token operator">!=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasOutsets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mOutsetFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>outsetFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> fw <span class="token operator">=</span> mFrame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> fh <span class="token operator">=</span> mFrame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//设置Window的Gravity</span>
        <span class="token function">applyGravityAndUpdateFrame</span><span class="token punctuation">(</span>layoutContainingFrame<span class="token punctuation">,</span> layoutDisplayFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//设置Window外部填充区域如果存在则是mOutsetFrame - mContentFrame</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasOutsets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mOutsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mContentFrame<span class="token punctuation">.</span>left <span class="token operator">-</span> mOutsetFrame<span class="token punctuation">.</span>left<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mContentFrame<span class="token punctuation">.</span>top <span class="token operator">-</span> mOutsetFrame<span class="token punctuation">.</span>top<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mOutsetFrame<span class="token punctuation">.</span>right <span class="token operator">-</span> mContentFrame<span class="token punctuation">.</span>right<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mOutsetFrame<span class="token punctuation">.</span>bottom <span class="token operator">-</span> mContentFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mOutsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//核心事件3</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowsAreFloating <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mFrame<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttrs<span class="token punctuation">.</span>type <span class="token operator">==</span> TYPE_DOCK_DIVIDER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//计算显示区域mContentFrame  mFrame 两者之间更大的区域</span>
            mContentFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mContentFrame<span class="token punctuation">.</span>left<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mContentFrame<span class="token punctuation">.</span>top<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>mContentFrame<span class="token punctuation">.</span>right<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>mContentFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mVisibleFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mVisibleFrame<span class="token punctuation">.</span>left<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mVisibleFrame<span class="token punctuation">.</span>top<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>mVisibleFrame<span class="token punctuation">.</span>right<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>mVisibleFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mStableFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mStableFrame<span class="token punctuation">.</span>left<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mStableFrame<span class="token punctuation">.</span>top<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>mStableFrame<span class="token punctuation">.</span>right<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>mStableFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">,</span> mFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//设置过扫描区间(边距)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inFullscreenContainer <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>windowsAreFloating<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mOverscanInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mOverscanFrame<span class="token punctuation">.</span>left <span class="token operator">-</span> layoutContainingFrame<span class="token punctuation">.</span>left<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mOverscanFrame<span class="token punctuation">.</span>top <span class="token operator">-</span> layoutContainingFrame<span class="token punctuation">.</span>top<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>layoutContainingFrame<span class="token punctuation">.</span>right <span class="token operator">-</span> mOverscanFrame<span class="token punctuation">.</span>right<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>layoutContainingFrame<span class="token punctuation">.</span>bottom <span class="token operator">-</span> mOverscanFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttrs<span class="token punctuation">.</span>type <span class="token operator">==</span> TYPE_DOCK_DIVIDER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">getDisplayContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBounds</span><span class="token punctuation">(</span>mTmpRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> overrideRightInset <span class="token operator">=</span> <span class="token operator">!</span>windowsAreFloating <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inFullscreenContainer
                    <span class="token operator">&amp;&amp;</span> mFrame<span class="token punctuation">.</span>right <span class="token operator">></span> mTmpRect<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> overrideBottomInset <span class="token operator">=</span> <span class="token operator">!</span>windowsAreFloating <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inFullscreenContainer
                    <span class="token operator">&amp;&amp;</span> mFrame<span class="token punctuation">.</span>bottom <span class="token operator">></span> mTmpRect<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
            mContentInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mContentFrame<span class="token punctuation">.</span>left <span class="token operator">-</span> mFrame<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
                    mContentFrame<span class="token punctuation">.</span>top <span class="token operator">-</span> mFrame<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
                    overrideRightInset <span class="token operator">?</span> mTmpRect<span class="token punctuation">.</span>right <span class="token operator">-</span> mContentFrame<span class="token punctuation">.</span>right
                            <span class="token operator">:</span> mFrame<span class="token punctuation">.</span>right <span class="token operator">-</span> mContentFrame<span class="token punctuation">.</span>right<span class="token punctuation">,</span>
                    overrideBottomInset <span class="token operator">?</span> mTmpRect<span class="token punctuation">.</span>bottom <span class="token operator">-</span> mContentFrame<span class="token punctuation">.</span>bottom
                            <span class="token operator">:</span> mFrame<span class="token punctuation">.</span>bottom <span class="token operator">-</span> mContentFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mVisibleInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mVisibleFrame<span class="token punctuation">.</span>left <span class="token operator">-</span> mFrame<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
                    mVisibleFrame<span class="token punctuation">.</span>top <span class="token operator">-</span> mFrame<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
                    overrideRightInset <span class="token operator">?</span> mTmpRect<span class="token punctuation">.</span>right <span class="token operator">-</span> mVisibleFrame<span class="token punctuation">.</span>right
                            <span class="token operator">:</span> mFrame<span class="token punctuation">.</span>right <span class="token operator">-</span> mVisibleFrame<span class="token punctuation">.</span>right<span class="token punctuation">,</span>
                    overrideBottomInset <span class="token operator">?</span> mTmpRect<span class="token punctuation">.</span>bottom <span class="token operator">-</span> mVisibleFrame<span class="token punctuation">.</span>bottom
                            <span class="token operator">:</span> mFrame<span class="token punctuation">.</span>bottom <span class="token operator">-</span> mVisibleFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mStableInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mStableFrame<span class="token punctuation">.</span>left <span class="token operator">-</span> mFrame<span class="token punctuation">.</span>left<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mStableFrame<span class="token punctuation">.</span>top <span class="token operator">-</span> mFrame<span class="token punctuation">.</span>top<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    overrideRightInset <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mTmpRect<span class="token punctuation">.</span>right <span class="token operator">-</span> mStableFrame<span class="token punctuation">.</span>right<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                            <span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mFrame<span class="token punctuation">.</span>right <span class="token operator">-</span> mStableFrame<span class="token punctuation">.</span>right<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    overrideBottomInset <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mTmpRect<span class="token punctuation">.</span>bottom <span class="token operator">-</span> mStableFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                            <span class="token operator">:</span>  Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>mFrame<span class="token punctuation">.</span>bottom <span class="token operator">-</span> mStableFrame<span class="token punctuation">.</span>bottom<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mDisplayCutout <span class="token operator">=</span> displayCutout<span class="token punctuation">.</span><span class="token function">calculateRelativeTo</span><span class="token punctuation">(</span>mFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 设置位移区域</span>
        mFrame<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token operator">-</span>layoutXDiff<span class="token punctuation">,</span> <span class="token operator">-</span>layoutYDiff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCompatFrame<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token operator">-</span>layoutXDiff<span class="token punctuation">,</span> <span class="token operator">-</span>layoutYDiff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mContentFrame<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token operator">-</span>layoutXDiff<span class="token punctuation">,</span> <span class="token operator">-</span>layoutYDiff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mVisibleFrame<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token operator">-</span>layoutXDiff<span class="token punctuation">,</span> <span class="token operator">-</span>layoutYDiff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mStableFrame<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token operator">-</span>layoutXDiff<span class="token punctuation">,</span> <span class="token operator">-</span>layoutYDiff<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mCompatFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//设置屏幕内容的缩放</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mEnforceSizeCompat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mOverscanInsets<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>mInvGlobalScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mContentInsets<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>mInvGlobalScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mVisibleInsets<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>mInvGlobalScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mStableInsets<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>mInvGlobalScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOutsets<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>mInvGlobalScale<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mCompatFrame<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>mInvGlobalScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//更新壁纸的位移</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsWallpaper <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fw <span class="token operator">!=</span> mFrame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> fh <span class="token operator">!=</span> mFrame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> DisplayContent displayContent <span class="token operator">=</span> <span class="token function">getDisplayContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>displayContent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> DisplayInfo displayInfo <span class="token operator">=</span> displayContent<span class="token punctuation">.</span><span class="token function">getDisplayInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">getDisplayContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mWallpaperController<span class="token punctuation">.</span><span class="token function">updateWallpaperOffset</span><span class="token punctuation">(</span>
                        <span class="token keyword">this</span><span class="token punctuation">,</span> displayInfo<span class="token punctuation">.</span>logicalWidth<span class="token punctuation">,</span> displayInfo<span class="token punctuation">.</span>logicalHeight<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>方法很长，我这里只截取了需要注意的地方，并且添加了注释。这里稍微总结一下:</p>
<blockquote>
<p>mFrame只有在自由窗体模式和固定模式才有值。否则都是(0,0,0,0)<br>这个mFrame让我困惑一下子，就明白了。实际上mFrame的诞生就是为了保证在自由窗体模式下有最小的内容值，因为自由窗体模式类似PC上的窗体一样，可以变化。如果是一般情况下，实际上是没有必要设置这个值，因为有mContentFrame等区域就能确定窗体大小。</p>
</blockquote>
<p>接下来就有如下的计算窗口Frame公式</p>
<blockquote>
<p>mOverscanFrame = OverscanFrame<br>mContentFrame = Min(mContentFrame, mFrame)<br>mVisibleFrame = Min(mVisibleFrame,mFrame)<br>mDecorFrame = mTmpDecorFrame<br>mStableFrame = Min(mStableFrame,mFrame)</p>
</blockquote>
<p>当是全屏时候:</p>
<blockquote>
<p>layoutContainingFrame = parentFrame</p>
</blockquote>
<p>不是全屏:</p>
<blockquote>
<p>layoutContainingFrame = !mInsetFrame.isEmpty() ? mInsetFrame : mContainingFrame;</p>
</blockquote>
<p>mInsetFrame这个是临时的Frame，为做动画准备的Frame。不看动画实际上就是mContainingFrame</p>
<p>计算窗体的Insets</p>
<blockquote>
<p>mOverscanInsets = Max(mOverscanFrame-layoutContainingFrame,0)<br>mContentInsets = mContentFrame - mFrame<br>mVisibleInsets = mVisibleFrame - mFrame<br>mStableInsets = mStableFrame - mFrame</p>
</blockquote>
<p>我们关注到这个之后就能明白在Window中的Frame实际上是连同内部的总区域，Inset是指真正的区域。但是这里只是简单的处理了。都是根据显示屏宽高来做简单的差值计算。</p>
<h4 id="测量那些没有绑定父窗口的窗口-所有的根部窗口）"><a href="#测量那些没有绑定父窗口的窗口-所有的根部窗口）" class="headerlink" title="测量那些没有绑定父窗口的窗口(所有的根部窗口）"></a>测量那些没有绑定父窗口的窗口(所有的根部窗口）</h4><p>核心逻辑:</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token function">forAllWindows</span><span class="token punctuation">(</span>mPerformLayout<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* traverseTopToBottom */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>实际上forAllWindow就是循环DisplayContent中所有的窗体，我们只需要看看这个实现的接口:</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">final</span> Consumer<span class="token operator">&lt;</span>WindowState<span class="token operator">></span> mPerformLayout <span class="token operator">=</span> w <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> gone <span class="token operator">=</span> <span class="token punctuation">(</span>mTmpWindow <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">.</span><span class="token function">canBeHiddenByKeyguardLw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> w<span class="token punctuation">.</span><span class="token function">isGoneForLayoutLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gone <span class="token operator">||</span> <span class="token operator">!</span>w<span class="token punctuation">.</span>mHaveFrame <span class="token operator">||</span> w<span class="token punctuation">.</span>mLayoutNeeded
                <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span><span class="token function">isConfigChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> w<span class="token punctuation">.</span><span class="token function">setReportResizeHints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>w<span class="token punctuation">.</span><span class="token function">isGoneForLayoutLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>mAttrs<span class="token punctuation">.</span>privateFlags <span class="token operator">&amp;</span> PRIVATE_FLAG_KEYGUARD<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span>
                        <span class="token punctuation">(</span>w<span class="token punctuation">.</span>mHasSurface <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span>mAppToken <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                                w<span class="token punctuation">.</span>mAppToken<span class="token punctuation">.</span>layoutConfigChanges<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>w<span class="token punctuation">.</span>mLayoutAttached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                w<span class="token punctuation">.</span>mLayoutNeeded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                w<span class="token punctuation">.</span><span class="token function">prelayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> firstLayout <span class="token operator">=</span> <span class="token operator">!</span>w<span class="token punctuation">.</span><span class="token function">isLaidOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">.</span><span class="token function">layoutWindowLw</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> null<span class="token punctuation">,</span> mDisplayFrames<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一旦确定其可见且，则会调用PhoneWindowManager的layoutWindowLw。</p>
<h4 id="PhoneWindowManager-layoutWindowLw"><a href="#PhoneWindowManager-layoutWindowLw" class="headerlink" title="PhoneWindowManager.layoutWindowLw"></a>PhoneWindowManager.layoutWindowLw</h4><p>这个方法更加的冗长，下面是拆成两个部分聊聊:</p>
<ul>
<li><p>1.根据type设置区域的上下左右的边缘</p>
</li>
<li><p>2.根据其他标志，最后设置区域</p>
<h5 id="根据type设置区域的上下左右的边缘"><a href="#根据type设置区域的上下左右的边缘" class="headerlink" title="根据type设置区域的上下左右的边缘"></a>根据type设置区域的上下左右的边缘</h5><p>这里不关注旋转之后以及状态栏下拉窗口等其他窗口，指关注我们常用的Activity窗口。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">layoutWindowLw</span><span class="token punctuation">(</span>WindowState win<span class="token punctuation">,</span> WindowState attached<span class="token punctuation">,</span> DisplayFrames displayFrames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//不处理状态栏，NavigationBar，以及mScreenDecorWindows包含的装饰WindowState，因为在begin中已经处理了</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>win <span class="token operator">==</span> mStatusBar <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">canReceiveInput</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> win <span class="token operator">==</span> mNavigationBar
              <span class="token operator">||</span> mScreenDecorWindows<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true">//获取type</span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> type <span class="token operator">=</span> attrs<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> fl <span class="token operator">=</span> PolicyControl<span class="token punctuation">.</span><span class="token function">getWindowFlags</span><span class="token punctuation">(</span>win<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> pfl <span class="token operator">=</span> attrs<span class="token punctuation">.</span>privateFlags<span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> sim <span class="token operator">=</span> attrs<span class="token punctuation">.</span>softInputMode<span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> requestedSysUiFl <span class="token operator">=</span> PolicyControl<span class="token punctuation">.</span><span class="token function">getSystemUiVisibility</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> sysUiFl <span class="token operator">=</span> requestedSysUiFl <span class="token operator">|</span> <span class="token function">getImpliedSysUiFlagsForLayout</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//初始化当前的区域</span>
      <span class="token keyword">final</span> Rect pf <span class="token operator">=</span> mTmpParentFrame<span class="token punctuation">;</span>
      <span class="token keyword">final</span> Rect df <span class="token operator">=</span> mTmpDisplayFrame<span class="token punctuation">;</span>
      <span class="token keyword">final</span> Rect of <span class="token operator">=</span> mTmpOverscanFrame<span class="token punctuation">;</span>
      <span class="token keyword">final</span> Rect cf <span class="token operator">=</span> mTmpContentFrame<span class="token punctuation">;</span>
      <span class="token keyword">final</span> Rect vf <span class="token operator">=</span> mTmpVisibleFrame<span class="token punctuation">;</span>
      <span class="token keyword">final</span> Rect dcf <span class="token operator">=</span> mTmpDecorFrame<span class="token punctuation">;</span>
      <span class="token keyword">final</span> Rect sf <span class="token operator">=</span> mTmpStableFrame<span class="token punctuation">;</span>
      Rect osf <span class="token operator">=</span> null<span class="token punctuation">;</span>
      dcf<span class="token punctuation">.</span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasNavBar <span class="token operator">=</span> <span class="token punctuation">(</span>isDefaultDisplay <span class="token operator">&amp;&amp;</span> mHasNavigationBar
              <span class="token operator">&amp;&amp;</span> mNavigationBar <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mNavigationBar<span class="token punctuation">.</span><span class="token function">isVisibleLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">final</span> <span class="token keyword">int</span> adjust <span class="token operator">=</span> sim <span class="token operator">&amp;</span> SOFT_INPUT_MASK_ADJUST<span class="token punctuation">;</span>

      <span class="token keyword">final</span> <span class="token keyword">boolean</span> requestedFullscreen <span class="token operator">=</span> <span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_FULLSCREEN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
              <span class="token operator">||</span> <span class="token punctuation">(</span>requestedSysUiFl <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_FULLSCREEN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token keyword">final</span> <span class="token keyword">boolean</span> layoutInScreen <span class="token operator">=</span> <span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_LAYOUT_IN_SCREEN<span class="token punctuation">)</span> <span class="token operator">==</span> FLAG_LAYOUT_IN_SCREEN<span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">boolean</span> layoutInsetDecor <span class="token operator">=</span> <span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_LAYOUT_INSET_DECOR<span class="token punctuation">)</span> <span class="token operator">==</span> FLAG_LAYOUT_INSET_DECOR<span class="token punctuation">;</span>

      sf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_INPUT_METHOD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//如果当前是输入法区域，所有区域先设置为输入对应的mDock区域</span>
          vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
          cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
          of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
          df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
          pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>

          pf<span class="token punctuation">.</span>bottom <span class="token operator">=</span> df<span class="token punctuation">.</span>bottom <span class="token operator">=</span> of<span class="token punctuation">.</span>bottom <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>

          cf<span class="token punctuation">.</span>bottom <span class="token operator">=</span> vf<span class="token punctuation">.</span>bottom <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          attrs<span class="token punctuation">.</span>gravity <span class="token operator">=</span> Gravity<span class="token punctuation">.</span>BOTTOM<span class="token punctuation">;</span>
          mDockLayer <span class="token operator">=</span> win<span class="token punctuation">.</span><span class="token function">getSurfaceLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_VOICE_INTERACTION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//测量声音窗口</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_WALLPAPER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//测量壁纸</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>win <span class="token operator">==</span> mStatusBar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//测量状态栏</span>
          of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
          df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
          pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
          cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">)</span><span class="token punctuation">;</span>
          vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>adjust <span class="token operator">==</span> SOFT_INPUT_ADJUST_RESIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              cf<span class="token punctuation">.</span>bottom <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              cf<span class="token punctuation">.</span>bottom <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
              vf<span class="token punctuation">.</span>bottom <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//测量内容型弹窗</span>
          dcf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mSystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">final</span> <span class="token keyword">boolean</span> inheritTranslucentDecor <span class="token operator">=</span>
                  <span class="token punctuation">(</span>attrs<span class="token punctuation">.</span>privateFlags <span class="token operator">&amp;</span> PRIVATE_FLAG_INHERIT_TRANSLUCENT_DECOR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">final</span> <span class="token keyword">boolean</span> isAppWindow <span class="token operator">=</span>
                  type <span class="token operator">>=</span> FIRST_APPLICATION_WINDOW <span class="token operator">&amp;&amp;</span> type <span class="token operator">&lt;=</span> LAST_APPLICATION_WINDOW<span class="token punctuation">;</span>
          <span class="token keyword">final</span> <span class="token keyword">boolean</span> topAtRest <span class="token operator">=</span>
                  win <span class="token operator">==</span> mTopFullscreenOpaqueWindowState <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>win<span class="token punctuation">.</span><span class="token function">isAnimatingLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>isAppWindow <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inheritTranslucentDecor <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>topAtRest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sysUiFl <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_FULLSCREEN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_FULLSCREEN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_TRANSLUCENT_STATUS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pfl <span class="token operator">&amp;</span> PRIVATE_FLAG_FORCE_DRAW_STATUS_BAR_BACKGROUND<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  dcf<span class="token punctuation">.</span>top <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>top<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_TRANSLUCENT_NAVIGATION<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sysUiFl <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_HIDE_NAVIGATION<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  dcf<span class="token punctuation">.</span>bottom <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
                  dcf<span class="token punctuation">.</span>right <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>layoutInScreen <span class="token operator">&amp;&amp;</span> layoutInsetDecor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>attached <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token function">setAttachedWindowFrames</span><span class="token punctuation">(</span>win<span class="token punctuation">,</span> fl<span class="token punctuation">,</span> adjust<span class="token punctuation">,</span> attached<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> pf<span class="token punctuation">,</span> df<span class="token punctuation">,</span> of<span class="token punctuation">,</span> cf<span class="token punctuation">,</span> vf<span class="token punctuation">,</span>
                          displayFrames<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_STATUS_BAR_PANEL <span class="token operator">||</span> type <span class="token operator">==</span> TYPE_STATUS_BAR_SUB_PANEL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_LAYOUT_IN_OVERSCAN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                          <span class="token operator">&amp;&amp;</span> type <span class="token operator">>=</span> FIRST_APPLICATION_WINDOW <span class="token operator">&amp;&amp;</span> type <span class="token operator">&lt;=</span> LAST_SUB_WINDOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canHideNavigationBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                          <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sysUiFl <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                          <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">>=</span> FIRST_APPLICATION_WINDOW <span class="token operator">&amp;&amp;</span> type <span class="token operator">&lt;=</span> LAST_SUB_WINDOW
                          <span class="token operator">||</span> type <span class="token operator">==</span> TYPE_VOLUME_OVERLAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mRestrictedOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mRestrictedOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>

                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_FULLSCREEN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>win<span class="token punctuation">.</span><span class="token function">isVoiceInteraction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mVoiceContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                          <span class="token keyword">if</span> <span class="token punctuation">(</span>adjust <span class="token operator">!=</span> SOFT_INPUT_ADJUST_RESIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                              cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                              cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token punctuation">}</span>
                      <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token function">applyStableConstraints</span><span class="token punctuation">(</span>sysUiFl<span class="token punctuation">,</span> fl<span class="token punctuation">,</span> cf<span class="token punctuation">,</span> displayFrames<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>adjust <span class="token operator">!=</span> SOFT_INPUT_ADJUST_NOTHING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mCurrent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>layoutInScreen <span class="token operator">||</span> <span class="token punctuation">(</span>sysUiFl
                  <span class="token operator">&amp;</span> <span class="token punctuation">(</span>View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
                          <span class="token operator">|</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_STATUS_BAR_PANEL <span class="token operator">||</span> type <span class="token operator">==</span> TYPE_STATUS_BAR_SUB_PANEL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_NAVIGATION_BAR <span class="token operator">||</span> type <span class="token operator">==</span> TYPE_NAVIGATION_BAR_PANEL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">// The navigation bar has Real Ultimate Power.</span>
                  of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_SECURE_SYSTEM_OVERLAY <span class="token operator">||</span> type <span class="token operator">==</span> TYPE_SCREENSHOT<span class="token punctuation">)</span>
                      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_FULLSCREEN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_BOOT_PROGRESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_LAYOUT_IN_OVERSCAN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                      <span class="token operator">&amp;&amp;</span> type <span class="token operator">>=</span> FIRST_APPLICATION_WINDOW <span class="token operator">&amp;&amp;</span> type <span class="token operator">&lt;=</span> LAST_SUB_WINDOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                  cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mOverscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canHideNavigationBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sysUiFl <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_STATUS_BAR
                          <span class="token operator">||</span> type <span class="token operator">==</span> TYPE_TOAST
                          <span class="token operator">||</span> type <span class="token operator">==</span> TYPE_DOCK_DIVIDER
                          <span class="token operator">||</span> type <span class="token operator">==</span> TYPE_VOICE_INTERACTION_STARTING
                          <span class="token operator">||</span> <span class="token punctuation">(</span>type <span class="token operator">>=</span> FIRST_APPLICATION_WINDOW <span class="token operator">&amp;&amp;</span> type <span class="token operator">&lt;=</span> LAST_SUB_WINDOW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sysUiFl <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>adjust <span class="token operator">!=</span> SOFT_INPUT_ADJUST_RESIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token function">applyStableConstraints</span><span class="token punctuation">(</span>sysUiFl<span class="token punctuation">,</span> fl<span class="token punctuation">,</span> cf<span class="token punctuation">,</span>displayFrames<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>adjust <span class="token operator">!=</span> SOFT_INPUT_ADJUST_NOTHING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mCurrent<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cf<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attached <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

              <span class="token function">setAttachedWindowFrames</span><span class="token punctuation">(</span>win<span class="token punctuation">,</span> fl<span class="token punctuation">,</span> adjust<span class="token punctuation">,</span> attached<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> pf<span class="token punctuation">,</span> df<span class="token punctuation">,</span> of<span class="token punctuation">,</span> cf<span class="token punctuation">,</span> vf<span class="token punctuation">,</span>
                      displayFrames<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_STATUS_BAR_PANEL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_TOAST <span class="token operator">||</span> type <span class="token operator">==</span> TYPE_SYSTEM_ALERT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">// These dialogs are stable to interim decor changes.</span>
                  cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>win<span class="token punctuation">.</span><span class="token function">isVoiceInteraction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>adjust <span class="token operator">!=</span> SOFT_INPUT_ADJUST_RESIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>adjust <span class="token operator">!=</span> SOFT_INPUT_ADJUST_NOTHING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mCurrent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<pre><code>我们大致上可以分以下几种情况进行测量：
- 输入法
- 状态栏
- 壁纸
- 声音窗口
- 状态栏下拉窗口
- 其他(如Activity,Dialog对应的窗口(PhoneWindow),或者启动窗口等等。内容型窗口。


本文只关注，输入法，状态栏，内容型窗口。

##### 输入法
&gt; 输入法区域 = mDock
底部需要调整：
输入法的过扫描区域底部，显示屏区域底部，父区域底部 = mUnrestricted.bottom
内容区域，可见区域 = mStable.bottom
整个输入法的中心都在整个窗体的底部

##### 状态栏
&gt; 状态栏父区域，显示屏区域，过扫描区域 = mUnrestricted
可见区域，内容区域 = mStable

需要判断Window的标志位是否是SOFT_INPUT_ADJUST_RESIZE：
打开SOFT_INPUT_ADJUST_RESIZE：
&gt; 内容区域的底部 = mContent.bottom

关闭SOFT_INPUT_ADJUST_RESIZE：
&gt; 内容区域的底部 = mDock.bottom
可见区域的底部 = mContent.bottom

关闭了SOFT_INPUT_ADJUST_RESIZE，比如说打开了adjustPan，整个屏幕向上移动了。此时的内容区域就是键盘的底部，可见区域当然是就是原来的内容区域的底部。

虽然状态栏一致位于顶部，实际上显示出来的样子只是冰山一角，只是其余部分被内容型弹窗遮住了。为了严谨，状态栏的底部也需要一起改变，才是适应window的高度的变化。

打开了SOFT_INPUT_ADJUST_RESIZE，就会通过调整Activity内容来腾出键盘的空间，所以底部还是内容区域的底部。


##### 内容型窗口
- 首先调整DecorFrame，装饰区域(外部window挂载区域如statusBar)
&gt; DecorFrame = mSystem

如果此时是App应用的窗口：
当打开了fitSystemWindows，没有打开如下标志位：
- SYSTEM_UI_FLAG_FULLSCREEN
- FLAG_FULLSCREEN
- FLAG_TRANSLUCENT_STATUS
- FLAG_DRAWS_SYSTEM_BAR_BACKGROUND
- PRIVATE_FLAG_FORCE_DRAW_STATUS_BAR_BACKGROUND
实际上就是我们常见的Activity，Dialog。
&gt; DecorFrame.top = mStable.top

如果隐藏了Nav Bar：
&gt; DecorFrame.left  = mStable.bottom;
DecorFrame.right  = mStable.right;


###### 接下来调整过扫描区域(OverScanFrame),显示屏区域(displayFrame),父区域(parentFrame),最后调整内容区域(ContentFrame)和可视区域(VisiblityFrame)
*如果同时打开标志位layoutInScreen 和 layoutInsetDecor且没有绑定窗口*：
如果打开了FLAG_LAYOUT_IN_OVERSCAN：
&gt; 过扫描，显示屏区域，父区域 = mOverScan

如果隐藏NavBar：
&gt; 显示屏，父区域 = mOverscan；过扫描区域=mUnrestricted
确保没有任何窗口超过导航栏，确保没有内容插入到过扫描区


其他情况：
&gt; 显示屏区域，父区域 = mRestrictedOverscan；过扫描区域 = mUnrestricted
确保没有内容插入到过扫描区

如果关闭全屏:
&gt; 没有打开SOFT_INPUT_ADJUST_RESIZE：
&gt; 内容区域 = mDock
&gt; 打开SOFT_INPUT_ADJUST_RESIZE：
&gt; 内容区域 = mContent

如果打开全屏：
&gt; 内容区域 = mRestricted

和mStable和mStableFullScreen，获取大的一方。

adjustNothing关闭：
&gt; 可见区域 = mCurrent

adjustNothing打开：
&gt; 可见区域 = 刚刚测量好的内容区域

因此这个状态能够处理PopWindow因为状态栏等原因出现了移动的问题。

*如果只打开标志位layoutInScreen，隐藏Nav Bar且没有绑定窗口*：
其实和上面十分相似，实际上就是每一次根据标志为多同步设置了内容区域。但是可见区域还是由adjustNothing做处理。

也就是说这个状态将不会对全屏做更多的处理。

*普通情况*：
这里我们不管Toast等情况：
当关闭SOFT_INPUT_ADJUST_RESIZE：
&gt; 显示屏区域，父区域，内容区域 = mDock

当打开SOFT_INPUT_ADJUST_RESIZE:
&gt; 显示屏区域，父区域，内容区域 = mContent

关闭SOFT_INPUT_ADJUST_NOTHING：
&gt; 可见区域 = mCurrent

adjustNothing打开：
&gt; 可见区域 = 刚刚测量好的内容区域


#### 根据其他标志，最后设置区域
```java
        boolean parentFrameWasClippedByDisplayCutout = false;
        final int cutoutMode = attrs.layoutInDisplayCutoutMode;
        final boolean attachedInParent = attached != null &amp;&amp; !layoutInScreen;
        final boolean requestedHideNavigation =
                (requestedSysUiFl &amp; View.SYSTEM_UI_FLAG_HIDE_NAVIGATION) != 0;

        final boolean floatingInScreenWindow = !attrs.isFullscreen() &amp;&amp; layoutInScreen
                &amp;&amp; type != TYPE_BASE_APPLICATION;

        if (cutoutMode != LAYOUT_IN_DISPLAY_CUTOUT_MODE_ALWAYS) {
            final Rect displayCutoutSafeExceptMaybeBars = mTmpDisplayCutoutSafeExceptMaybeBarsRect;
            displayCutoutSafeExceptMaybeBars.set(displayFrames.mDisplayCutoutSafe);
            if (layoutInScreen &amp;&amp; layoutInsetDecor &amp;&amp; !requestedFullscreen
                    &amp;&amp; cutoutMode == LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT) {
                displayCutoutSafeExceptMaybeBars.top = Integer.MIN_VALUE;
            }
            if (layoutInScreen &amp;&amp; layoutInsetDecor &amp;&amp; !requestedHideNavigation
                    &amp;&amp; cutoutMode == LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT) {
                switch (mNavigationBarPosition) {
                    case NAV_BAR_BOTTOM:
                        displayCutoutSafeExceptMaybeBars.bottom = Integer.MAX_VALUE;
                        break;
                    case NAV_BAR_RIGHT:
...
                        break;
                    case NAV_BAR_LEFT:
...
                        break;
                }
            }
            if (type == TYPE_INPUT_METHOD &amp;&amp; mNavigationBarPosition == NAV_BAR_BOTTOM) {
                displayCutoutSafeExceptMaybeBars.bottom = Integer.MAX_VALUE;
            }

            if (!attachedInParent &amp;&amp; !floatingInScreenWindow) {
                mTmpRect.set(pf);
                pf.intersectUnchecked(displayCutoutSafeExceptMaybeBars);
                parentFrameWasClippedByDisplayCutout |= !mTmpRect.equals(pf);
            }

            df.intersectUnchecked(displayCutoutSafeExceptMaybeBars);
        }

        cf.intersectUnchecked(displayFrames.mDisplayCutoutSafe);

....
        win.computeFrameLw(pf, df, of, cf, vf, dcf, sf, osf, displayFrames.mDisplayCutout,
                parentFrameWasClippedByDisplayCutout);
        if (type == TYPE_INPUT_METHOD &amp;&amp; win.isVisibleLw()
                &amp;&amp; !win.getGivenInsetsPendingLw()) {
            setLastInputMethodWindowLw(null, null);
            offsetInputMethodWindowLw(win, displayFrames);
        }
        if (type == TYPE_VOICE_INTERACTION &amp;&amp; win.isVisibleLw()
                &amp;&amp; !win.getGivenInsetsPendingLw()) {
            offsetVoiceInputWindowLw(win, displayFrames);
        }
    }</code></pre><p>实际上这一段就是根据刘海屏幕的处理区间，最后调用computeFrameLw设置区域。接下来的逻辑在上面已经聊过了。</p>
<h4 id="测量那些绑定了父窗口的窗口"><a href="#测量那些绑定了父窗口的窗口" class="headerlink" title="测量那些绑定了父窗口的窗口"></a>测量那些绑定了父窗口的窗口</h4><p>实际上这里的逻辑和上面很相似，不过走的是attach的逻辑：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setAttachedWindowFrames</span><span class="token punctuation">(</span>WindowState win<span class="token punctuation">,</span> <span class="token keyword">int</span> fl<span class="token punctuation">,</span> <span class="token keyword">int</span> adjust<span class="token punctuation">,</span> WindowState attached<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> insetDecors<span class="token punctuation">,</span> Rect pf<span class="token punctuation">,</span> Rect df<span class="token punctuation">,</span> Rect of<span class="token punctuation">,</span> Rect cf<span class="token punctuation">,</span> Rect vf<span class="token punctuation">,</span>
            DisplayFrames displayFrames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>win<span class="token punctuation">.</span><span class="token function">isInputMethodTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> attached<span class="token punctuation">.</span><span class="token function">isInputMethodTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>adjust <span class="token operator">!=</span> SOFT_INPUT_ADJUST_RESIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_LAYOUT_ATTACHED_IN_DECOR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                        <span class="token operator">?</span> attached<span class="token punctuation">.</span><span class="token function">getContentFrameLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> attached<span class="token punctuation">.</span><span class="token function">getOverscanFrameLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                cf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>attached<span class="token punctuation">.</span><span class="token function">getContentFrameLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>attached<span class="token punctuation">.</span><span class="token function">isVoiceInteraction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    cf<span class="token punctuation">.</span><span class="token function">intersectUnchecked</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mVoiceContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>win<span class="token punctuation">.</span><span class="token function">isInputMethodTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> attached<span class="token punctuation">.</span><span class="token function">isInputMethodTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    cf<span class="token punctuation">.</span><span class="token function">intersectUnchecked</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            df<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>insetDecors <span class="token operator">?</span> attached<span class="token punctuation">.</span><span class="token function">getDisplayFrameLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> cf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            of<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>insetDecors <span class="token operator">?</span> attached<span class="token punctuation">.</span><span class="token function">getOverscanFrameLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> cf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            vf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>attached<span class="token punctuation">.</span><span class="token function">getVisibleFrameLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_LAYOUT_IN_SCREEN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> attached<span class="token punctuation">.</span><span class="token function">getFrameLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> df<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果附着的窗体是输入法，一切都被输入法限制住。<br>关闭SOFT_INPUT_ADJUST_RESIZE:</p>
<blockquote>
<p>FLAG_LAYOUT_ATTACHED_IN_DECOR 是否打开？<br>关闭则内容区域 = 父窗体内容区域<br>打开则内容区域 = 父窗体的扫描区域</p>
</blockquote>
<p>打开SOFT_INPUT_ADJUST_RESIZE:</p>
<blockquote>
<p>则获取比较子内容区域和mContent更大取哪个</p>
</blockquote>
<blockquote>
<p>显示，过扫描，可见区域 = 父（被父窗体限制）</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>beginLayoutLw，layoutWindowLw通过对整个Window的边距的确定，从而确定Window的大小。<br>beginLayoutLw，做了如下的事情：</p>
<ul>
<li>测量Nav Bar</li>
<li>测量status Bar</li>
<li>测量layoutDecorScreen</li>
</ul>
<p>对整个屏幕做了初步的测量，把剩下的Window都限定到了statusBar 之下。不允许任何窗体遮挡它。</p>
<p>layoutWindowLw，做了如下的事情：<br><strong>测量所有窗体的显示屏区域，过扫描区域，父区域，内容区域，可见区域。</strong><br>能够注意到的是，有两个标志为layoutInScreen，layoutInDecor。<br>这两个标志位确定了窗口能够移动的最大范围。</p>
<p>内容区域，是被adjustResize标志位确定。如果是打开则是内容区域的范围。因为这个标志是处理了Activity调整空间给键盘腾出空间。如果是关闭，打开layoutInScreen则内容区域为mDock，否则内容区域为mContent，或者根据标志为走。</p>
<p>可视区域，是由adjustNothing确定，如果打开了可视区域就等于内容区域，关闭了则内容区域为mCurrent(内容带上键盘)，任由系统自己默认适配。</p>
<h1 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h1><p>这就是WMS的最后一篇，实际上还有窗体动画以及Surface如何管理没有讲解。但是还没有涉及到SurfaceFlinger是如何工作的，View的绘制流程又是如何。接下来，将会以这个为突破口，和大家聊聊SurfaceFlinger的核心原理。不过，还需要点其他知识，除了OpenGL之外，还需要Skia相关的知识。</p>
<p>跟着我看OpenGL的朋友应该没有多少问题，如果对OpenGL感兴趣的可以看看我的OpenGL的学习日记。之后我还会放出几篇关于Skia的学习笔记。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/09/26/skia-de-chu-tan-skia-de-gn-jiao-ben-bian-yi-yu-di-yi-ge-skia-ying-yong/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="Skia的初探(Skia的GN脚本编译与第一个Skia应用)">
                        
                        <span class="card-title">Skia的初探(Skia的GN脚本编译与第一个Skia应用)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言如今大前端代表之一flutter十分火热，也是一种大的趋势。flutter与rn对大前端上的理解不同，rn是自上而下的大前端解决方案，而flutter是自下而上的大前端解决方案。为什么我说flutter是自下而上的解决方案呢？实际上这种
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-09-26
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Skia/" class="post-category">
                                    Skia
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/音视频/">
                        <span class="chip bg-color">音视频</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/09/26/android-chong-xue-xi-lie-wms-zai-activity-qi-dong-zhong-de-zhi-ze-tian-jia-chuang-ti-san/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Android 重学系列 WMS在Activity启动中的职责 添加窗体(三)">
                        
                        <span class="card-title">Android 重学系列 WMS在Activity启动中的职责 添加窗体(三)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言经过上一篇章的讨论，我们理清楚了ActivityRecord，TaskRecord和窗体容器之间的关系。同时达到了应用启动时，启动的第一个启动窗口，StartingWindow。这个时候，我们可以看到一个直指核心的代码段：
      
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-09-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/WMS/" class="post-category">
                                    WMS
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
