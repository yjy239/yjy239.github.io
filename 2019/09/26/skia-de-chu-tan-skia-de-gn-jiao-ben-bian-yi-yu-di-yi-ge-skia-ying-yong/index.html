<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Skia的初探(Skia的GN脚本编译与第一个Skia应用), Android | Linux | Flutter">
    <meta name="description" content="前言如今大前端代表之一flutter十分火热，也是一种大的趋势。flutter与rn对大前端上的理解不同，rn是自上而下的大前端解决方案，而flutter是自下而上的大前端解决方案。为什么我说flutter是自下而上的解决方案呢？实际上这种">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Skia的初探(Skia的GN脚本编译与第一个Skia应用) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Skia的初探(Skia的GN脚本编译与第一个Skia应用)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/音视频/">
                                <span class="chip bg-color">音视频</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Skia/" class="post-category">
                                Skia
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-09-26
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        6.2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        25 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>如今大前端代表之一flutter十分火热，也是一种大的趋势。flutter与rn对大前端上的理解不同，rn是自上而下的大前端解决方案，而flutter是自下而上的大前端解决方案。为什么我说flutter是自下而上的解决方案呢？实际上这种解决思路也来源与移动端手机游戏开发，flutter绕开对每一个系统顶层ui api，直接对接系统底层的cpu，gpu。</p>
<p>Google是怎么做到的？实际上，如果翻开Android底层源码，我们会在external目录发现一个名为Skia的第三方库。Skia实际上是Google出品的Android绘制2D图形的核心库，在刚诞生之初就以在低性能的移动端中表现处高性能的水平受人侧目，但是大前端的技术十分众多繁杂，就像金子被沙子掩盖一般，不受大众的关注。</p>
<p>关于Skia如何在Android运作之后我会在Android重学系列中，和大家好好聊聊。</p>
<p>回到原来的话题，我们翻开官网，发现Skia原本支持chrome浏览器，Android，iOS，Mac，Web，Windows等平台上渲染图像。换句话说，经过这些年的发展，名声不显的Skia本身就具备了跨平台的能力。skia作为核心渲染库就是极好的选择。实际上我们能够看到这段时间Google的新技术，如flutter，新平台Fuchsia都是以它为核心渲染库。</p>
<p>学习东西就要学习本质，才能更好的掌握。因此，我们需要对Skia有一定的理解，本文将作为Skia的系列第一篇，从Skia如何编译开始。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="编译的准备"><a href="#编译的准备" class="headerlink" title="编译的准备"></a>编译的准备</h2><p>我们可以执行git如下的命令，把Skia源码从官方下载下来：</p>
<blockquote>
<p>git clone <a href="https://skia.googlesource.com/skia.git" target="_blank" rel="noopener">https://skia.googlesource.com/skia.git</a></p>
</blockquote>
<p>当然，我们可以从github上搜索skia，下载下来。我就是这样做的。</p>
<p>第二步十分重要，我就踩了坑，编译老是缺少了文件,请安装了python之后，执行如下命令：</p>
<blockquote>
<p>cd skia<br>python2 tools/git-sync-deps</p>
</blockquote>
<p>把skia编译，运行需要的第三方库全部下载下来。</p>
<h2 id="GN与ninja-脚本"><a href="#GN与ninja-脚本" class="headerlink" title="GN与ninja 脚本"></a>GN与ninja 脚本</h2><p>我经过前段时间的学习，对编译有一点心得。当我信心满满的打开了Skia的目录的时候，发现我熟悉的CONFIGURE的文件呢？熟悉的CMake，Makefile呢？都不见了。取而代之的是BUILD.gn脚本。</p>
<p>GN脚本相关的资料不多，但是官方的资料还是挺详细的。GN脚本是什么？官方是怎么说的，如果CMake和Makefile是高级语言，那么GN和ninja则是相当于汇编语言的存在，存粹是为了编译速度而诞生的。我们翻开Android的源码，发现Android的编译工具经过了几次变迁，从mk到cmakelists，现在Android9.0使用的bp+GN脚本。关于bp文件，不是本文重点就不多赘述。</p>
<p>我在之前的CMake总结一文有讲解过，CMake是基于Makefile之上的很强大的编译工具。那么GN实际上是基于ninja之上的编译工具。</p>
<h2 id="ninja的简单介绍"><a href="#ninja的简单介绍" class="headerlink" title="ninja的简单介绍"></a>ninja的简单介绍</h2><p>ninja和Makefile很相似，我们类比学习一下。Makefile需要创建一个make文件，ninja则需要创建一个build.ninja文件。</p>
<p>和学习Makefile，这里我同样总结了，ninja需要清楚2个变量，1个规则，1个命令，就能完成build.ninja的编写。ninja没有自动变量，因为ninja是十分追求效率的编译工具，省略了自动变量的替换和检索。</p>
<h3 id="一个规则"><a href="#一个规则" class="headerlink" title="一个规则"></a>一个规则</h3><pre class="line-numbers language-shell"><code class="language-shell">rule cc
 command = gcc -g -c ${in} -o ${out}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>rule规则制定的是，一个规则cc这个命令实际上执行的是command赋值的命令。</p>
<h3 id="一个命令"><a href="#一个命令" class="headerlink" title="一个命令"></a>一个命令</h3><pre class="line-numbers language-shell"><code class="language-shell">build hello.o: cc hello.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>命令build 实际上告诉ninja我们要编译的结果是hello.o，通过上面定义的cc规则，以hello.c作为输入参数。</p>
<p>从上文可以知道就是是一个gcc的编译命令。</p>
<h3 id="2个变量"><a href="#2个变量" class="headerlink" title="2个变量"></a>2个变量</h3><pre class="line-numbers language-shell"><code class="language-shell">${out} ${in} <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>分别指代的是build命令中输出对象，以及输入对象。</p>
<p>完整的一个简单build.ninja如下：</p>
<pre class="line-numbers language-shell"><code class="language-shell">rule cc
 command = gcc -g -c ${in} -o ${out}
rule link
 command = gcc ${in} -o ${out}

build hello.o: cc hello.c
build hello : link hello.o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当我们编译好build.ninja之后，别忘了，调用ninja命令一下，就能自己找到当前目录下的脚本文件，进行编译。</p>
<h2 id="GN简单介绍"><a href="#GN简单介绍" class="headerlink" title="GN简单介绍"></a>GN简单介绍</h2><p>GN则稍微复杂点，提供了相当多的语法，以及复杂的流程，这里以GN脚本的开发流程为线索，铺开来聊聊。</p>
<p>GN脚本的简单开发流程：</p>
<ul>
<li>1.编写.gn文件定义GN的配置文件位置，一般名字是BUILDCONFIGURE.gn.</li>
<li>2.编写BUILDCONFIGURE.gn,并且定义GN的需要使用的toolchain文件位置，因为GN不提供默认的编译方法，需要我们去实现对应的gcc等命令。</li>
<li>3.在toolchain文件的位置，编写一个BUILD.gn文件，实现其中各种编译工具的命令。</li>
<li>4.接着在.gn所在的文件目录中，编写BUILD.gn文件，这个文件才是我们真正的编译文件。</li>
<li>5.回到.gn的目录，执行如下命令完成编译:<blockquote>
<p>gn gen out/default //执行gn脚本，并且确定输出目录<br>ninja -C out/default //调用ninja执行由GN生成的ninja脚本完成编译。</p>
</blockquote>
</li>
</ul>
<p>大致分为4个步骤，让我按照流程一一讲解。</p>
<h3 id="步骤一"><a href="#步骤一" class="headerlink" title="步骤一"></a>步骤一</h3><p>定义一个名字为.gn文件：</p>
<pre class="line-numbers language-shell"><code class="language-shell">buildconfig = "//BUILDCONFIG.gn"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>//代表当前目录。因此这里定义的是当前目录下的BUILDCONFIG.gn文件。</p>
<h3 id="步骤二"><a href="#步骤二" class="headerlink" title="步骤二"></a>步骤二</h3><p>创建一个BUILDCONFIG.gn文件：</p>
<pre class="line-numbers language-shell"><code class="language-shell">declare_args(){
} 

 set_default_toolchain("//toolchain:gcc")
 cflags_cc = [ "-std=c++11" ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个文件中，必须定义set_default_toolchain方法，设置默认的编译工具的BUILD.gn配置信息位置。</p>
<p>declare_args，这个是一个方法，一般是GN脚本要编译动态库时候，需要的默认参数时候会调用declare_args这个方法，获取默认参数。</p>
<h3 id="步骤三"><a href="#步骤三" class="headerlink" title="步骤三"></a>步骤三</h3><p>上一个步骤定义的位置为（”//toolchain:gcc”)，说明这个编译工具的配置未见在当前目录下的toolchain文件下面。<br>因此，我们需要创建一个toolchain文件夹，并且在toolchain文件下创建一个BUILD.gn文件。定义toolchain文件，实际上和ninja的rule类似，定义不同编译模式下的工具。这里我就获取chrome的toolchain，由于我是在mac上编译的，需要对这个文件做一点修改和调整。</p>
<pre class="line-numbers language-shell"><code class="language-shell">toolchain("gcc") {
  tool("cc") {
    depfile = "{{output}}.d"
    command = "gcc -MMD -MF $depfile {{defines}} {{include_dirs}} {{cflags}} {{cflags_c}} -c {{source}} -o {{output}}"
    depsformat = "gcc"
    description = "CC {{output}}"
    outputs = [
      "{{source_out_dir}}/{{target_output_name}}.{{source_name_part}}.o",
    ]
  }
  tool("cxx") {
    depfile = "{{output}}.d"
    command = "g++ -MMD -MF $depfile {{defines}} {{include_dirs}} {{cflags}} {{cflags_cc}} -c {{source}} -o {{output}}"
    depsformat = "gcc"
    description = "CXX {{output}}"
    outputs = [
      "{{source_out_dir}}/{{target_output_name}}.{{source_name_part}}.o",
    ]
  }
  tool("alink") {
    rspfile = "{{output}}.rsp"
    command = "rm -f {{output}} && ar rcs {{output}} @$rspfile"
    description = "AR {{target_output_name}}{{output_extension}}"
    rspfile_content = "{{inputs}}"
    outputs = [
      "{{target_out_dir}}/{{target_output_name}}{{output_extension}}",
    ]
    default_output_extension = ".a"
    output_prefix = "lib"
  }
  tool("solink") {
    soname = "{{target_output_name}}{{output_extension}}"  # e.g. "libfoo.so".
    rspfile = soname + ".rsp"
    command = "g++ -shared {{ldflags}} -o $soname @$rspfile"
    rspfile_content = "-Wl,-all_load {{inputs}} {{solibs}} -Wl,-noall_load {{libs}}"
    description = "SOLINK $soname"
    # Use this for {{output_extension}} expansions unless a target manually
    # overrides it (in which case {{output_extension}} will be what the target
    # specifies).
    default_output_extension = ".so"
    outputs = [
      soname,
    ]
    link_output = soname
    depend_output = soname
    output_prefix = "lib"
  }
  tool("link") {
    outfile = "{{target_output_name}}{{output_extension}}"
    rspfile = "$outfile.rsp"
    command = "g++ {{ldflags}} -o $outfile @$rspfile {{solibs}} {{libs}}"
    description = "LINK $outfile"
    rspfile_content = "{{inputs}}"
    outputs = [
      outfile,
    ]
  }
  tool("stamp") {
    command = "touch {{output}}"
    description = "STAMP {{output}}"
  }
  tool("copy") {
    command = "cp -af {{source}} {{output}}"
    description = "COPY {{source}} {{output}}"
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个BUILD.gn,中我们定义了一个toolchain这个好像方法的东西，toolchain中声明了一个”gcc”的名字。这种在GN脚本中称为模版，这是GN内置的模版。其作用相当于方法一般，能够被调用。toolchain这个模版本身带有着逻辑，当执行完这个作用域内的的所有行为之后，竟会执行模版内部的逻辑。</p>
<p>在toolchain中有许多tool(“link”)，tool(“solink”)等小的模版。这些内置模版，实际上代表着各种工具，如solink，代表着动态库的链接时候需要的命令，cxx,cc代表着编译阶段时候的命令。当GN脚本执行到某个阶段，将会调用tool中对应的命令。</p>
<p>在这里，我们所有的命令都需要做调整。比如在solink中，我们编写链接的命令，想要设定soname的时候，mac环境不支持soname，支持install_name。因此，我们需要成对应平台的对应的命令。</p>
<h3 id="步骤四"><a href="#步骤四" class="headerlink" title="步骤四"></a>步骤四</h3><p>编写属于我们的BUILD.gn脚本。<br>这里需要介绍几个，我们常用的内置模版。</p>
<blockquote>
<p>static_library： 编译静态库<br>shared_library: 编译动态库<br>executable: 编译执行文件<br>source_set: 编译一种轻量的静态库。<br>component: 可能是source_set也可能是shared_library，根据构建类型确定</p>
</blockquote>
<p>这里举一个简单的例子，我们编译个执行hello_gn的执行文件，链接一个say_hello的动态链接库。写法如下：</p>
<pre class="line-numbers language-shell"><code class="language-shell">shared_library("say_hello"){
 sources=["say_hello.c",]
}

executable("hello_gn"){
 sources = ["hello.c",]
 deps=[":say_hello",]
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，我们使用两个内置模版，自上而下的分别执行如下操作：</p>
<ul>
<li>1.编译一个名字为say_hello的动态库。sources是这个模版里面识别的属性，代表着这个动态库对应的资源文件。</li>
<li>2.编译一个名字为hello_gn的可执行文件，资源文件是hello .c，同时需要依赖say_hello模版生成的产物。换句话说，可执行文件要链接上这个动态链接库。</li>
</ul>
<p>这样就能完成了一次GN脚本的编写。最后执行第五步的命令，就能开始编译。</p>
<h3 id="GN的模版-template"><a href="#GN的模版-template" class="headerlink" title="GN的模版(template)"></a>GN的模版(template)</h3><p>能看到在GN脚本的编写过程中，模版占了绝大部分的比重。那么我们该怎么自定义模版呢？</p>
<p>自定义模版规则有四条，如下：</p>
<ul>
<li><p>1.定义一个template的作用域，并且在设置好target_name.如下定义了一个名字为opts的模版</p>
<pre class="line-numbers language-shell"><code class="language-shell">template("opts"){
...
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>2.调用一个模版方法如下，以上面定义好的模版为例子</p>
<pre class="line-numbers language-shell"><code class="language-shell">opts("target_name"){
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>调用的同时，要在里面编写一个target_name。用以识别模版不同的使用。其实可以类比为我们常用的泛型，target_name为泛型中具体的对象。</p>
</li>
<li><p>3.模版能够获取调用模版时候所有的属性，其方法个js很相似，通过invoker来获取。<br>举个例子</p>
<pre class="line-numbers language-shell"><code class="language-shell">opts("target_name"){
enabled = true
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>我们能够在定义template的时候，通过invoker.enabled访问到调用时候enabled的参数。但是请注意，注意获取方式有两种：</p>
</li>
</ul>
<ol>
<li><p>必须调用如下方法判断了模版调用者中存在该对象，才能获取属性，不然会报错。</p>
<pre class="line-numbers language-shell"><code class="language-shell">if (defined(invoker.enabled)) {
   values = invoker.enabled
 }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>在获取参数之前调用如下语句：</p>
<pre class="line-numbers language-shell"><code class="language-shell">visibility = [ ":*" ]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样默认是所有的参数可见。但是必须注意了，所有调用方注入的参数在对应作用域必须使用，不然会报错。</p>
</li>
</ol>
<ul>
<li>4.每一个模版的参数如同方法一般，只存在在自己的作用域，如果需要把参数设置到已经在全局存在的参数。需要通过如下方法，把模版内的参数跨越作用域传送出去。<pre class="line-numbers language-shell"><code class="language-shell">forward_variables_from(invoker,"*",[sources,cflags])<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>这个方法有三个参数:<br>第一个参数：要传输的对象invoker中的参数;<br>第二个参数：要传输到全局作用域的属性是什么,”*”代表着所有属性<br>第三个参数：哪些属性不需要传输出去。</p>
<p>明白了这些基础，我们就能更好的阅读Skia的GN脚本，甚至可以按照自己的心意裁剪Skia库。</p>
<p>更多关于GN脚本可以看官方文档：<a href="https://gn.googlesource.com/gn/+/master/docs/" target="_blank" rel="noopener">https://gn.googlesource.com/gn/+/master/docs/</a></p>
<h2 id="理解Skia-GN脚本"><a href="#理解Skia-GN脚本" class="headerlink" title="理解Skia GN脚本"></a>理解Skia GN脚本</h2><p>打开skia源码根目录下的BUILD.gn。首先能看到，import几个gn目录下的gni文件：</p>
<pre><code>import("gn/flutter_defines.gni")
import("gn/fuchsia_defines.gni")
import("gn/shared_sources.gni")

import("gn/skia.gni")</code></pre><p>实际上前两个我们可以忽略，是把flutter和fuchsia一些参数需要依赖的数据添加进来。主要是后面两个gni脚本。</p>
<p>shared_sources脚本主要是导入了核心以及相关的模块。skia脚本则根据编译命令，平台设置一些默认值，以及设置编译工具链toolchain。</p>
<h3 id="Skia-2个重要的模版"><a href="#Skia-2个重要的模版" class="headerlink" title="Skia 2个重要的模版"></a>Skia 2个重要的模版</h3><h4 id="opts"><a href="#opts" class="headerlink" title="opts"></a>opts</h4><pre class="line-numbers language-shell"><code class="language-shell">template("opts") {
  visibility = [ ":*" ]
  if (invoker.enabled) {
    source_set(target_name) {
      check_includes = false
      forward_variables_from(invoker, "*")
      configs += skia_library_configs 
    } 
  } else {
    # If not enabled, a phony empty target that swallows all otherwise unused variables. 
    source_set(target_name) {
      check_includes = false
      forward_variables_from(invoker,
                             "*",
                             [
                               "sources",
                               "cflags",
                             ])
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里就能看到Skia自己定义了一个模版opts的模版，用来控制编译平台需要对应需要的配置：</p>
<pre class="line-numbers language-shell"><code class="language-shell">opts("armv7") {
  enabled = current_cpu == "arm"
  sources = skia_opts.armv7_sources + skia_opts.neon_sources
  cflags = []
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，当我们需要交叉编译会在命令参数中设置当前平台current_cpu，目标平台target_cpu。能看到会判断当前的平台是什么，并且一些新的资源配置。</p>
<h4 id="optional"><a href="#optional" class="headerlink" title="optional"></a>optional</h4><p>控制Skia，各个模块是否加入到Skia中，各个模块以什么方式编译进来。就以jpeg模块为例子：</p>
<pre class="line-numbers language-shell"><code class="language-shell">optional("jpeg") {
  enabled = skia_use_libjpeg_turbo
  public_defines = [ "SK_HAS_JPEG_LIBRARY" ]

  deps = [
    "//third_party/libjpeg-turbo:libjpeg",
  ]
  public = [
    "include/encode/SkJpegEncoder.h",
  ]
  sources = [
    "src/codec/SkJpegCodec.cpp",
    "src/codec/SkJpegDecoderMgr.cpp",
    "src/codec/SkJpegUtility.cpp",
    "src/images/SkJPEGWriteUtility.cpp",
    "src/images/SkJpegEncoder.cpp",
  ]
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在jpeg模块依赖于third_party的libjpeg-turbo第三方库。公有开放出来的头文件是SkJpegEncoder，skia在这个第三方库之上封装的源码就在sources的集合中。每一个模块是否加入到编译中，由enabled来决定。</p>
<p>Skia对于每一个模块都是通过这种模式管理的。</p>
<h4 id="Skia主体模块"><a href="#Skia主体模块" class="headerlink" title="Skia主体模块"></a>Skia主体模块</h4><p>经过对每一个模块的模版都定义之后，我们能看到component内置模版。</p>
<pre class="line-numbers language-shell"><code class="language-shell">component("skia") {
...
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>实际上skia的静态/动态库就是以这里为主体，把各个模块的都依赖上。</p>
<pre class="line-numbers language-shell"><code class="language-shell">  public_deps = [
    ":gpu",
    ":pdf",
    ":skcms",
  ]

  deps = [
    ":arm64",
    ":armv7",
    ":avx",
    ":compile_processors",
    ":crc32",
    ":fontmgr_android",//android的字体
    ":fontmgr_custom",
    ":fontmgr_custom_empty",
    ":fontmgr_empty",
    ":fontmgr_fontconfig",
    ":fontmgr_fuchsia",
    ":fontmgr_wasm",
    ":fontmgr_win",
    ":fontmgr_win_gdi",
    ":gif",//gif解析
    ":heif",
    ":hsw",
    ":jpeg",//jpeg解析
    ":none",
    ":png",//png解析
    ":raw",
    ":sksl_interpreter",
    ":skvm_jit",//skia 的jit
    ":sse2",
    ":sse41",
    ":sse42",
    ":ssse3",
    ":webp",//webp
    ":wuffs",
    ":xml",//xml解析库
  ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>就是这里把所有的模块都依赖上。</p>
<p>如果要裁剪库的朋友请注意，这些不仅仅是全部，在上面的gni中还有更多的定义，每一个依赖模块实际上很可能有第二个依赖模块。就以xml来说，实际上在xml.gni能看到会依赖上zlib这个zip解压模块。我们如果通过skia_enabled_zlib为false，但是xml为true，就会出现编译找不到对应文件的异常。</p>
<p>因此裁剪库的时候，我们需要理清楚每一个依赖库之间的依赖关系。<br>当依赖全部完成之后，Skia会根据平台做进一步资源依赖，最终完成编译。</p>
<h3 id="Skia编译命令"><a href="#Skia编译命令" class="headerlink" title="Skia编译命令"></a>Skia编译命令</h3><p>当我们理清楚这些之后，我们要交叉编译出一个arm平台上的Android skia需要依次执行如下命令，就能编译出一个完整的skia出来。当然我是为了方便，编写了一个脚本</p>
<pre class="line-numbers language-shell"><code class="language-shell">bin/gn gen out/Shared -args='ndk="/Users/yjy/Library/Android/sdk/ndk/20.0.5594570" ndk_api=21  target_os="android" target_cpu="arm" is_component_build=true skia_use_libjpeg_turbo=true skia_enable_pdf=false skia_use_libpng=true skia_use_libwebp=true is_debug=false is_official_build=false'

ninja -C out/Shared<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>其中is_component_build，代表着这个时候是需要编译skia的动态库。target_cpu代表目标平台。skia_enable_pdf代表关闭pdf的模块。is_debug关闭skia的debug模式</p>
<h3 id="Skia编译总结和踩坑"><a href="#Skia编译总结和踩坑" class="headerlink" title="Skia编译总结和踩坑"></a>Skia编译总结和踩坑</h3><p>实际上，在第一次上手Skia的编译的时候，踩了不少坑。主要也是对GN脚本不熟悉。网上有不少的问题，我好像都遇到了。</p>
<p>其中有一处，skia_use_system_xxx的标志参数需要讨论一下。这个参数打开的话就会从当前系统查找又没有对应的模块源码编译进去。比如说，我们打开skia_use_system_png，则会从系统中查找又没有libpng的源码编译进来，没有则报错。一般我们是关闭的。</p>
<p>第二处，当我们关闭了jpeg,设置了skia_use_libjpeg_turbo =false的时候。编译通过了，但是却出现如下的错误信息：</p>
<pre><code>dlopen failed: cannot locate symbol '_ZN11SkJpegCodec6IsJpegEPKvj'</code></pre><p>这个错误信息，是指未定义的符号，可以通过nm -u xxx.so查看未定义符号有什么。一般是需要链接的库没有链接进来。</p>
<p>能从这里面看到实际上是有一个SkJpegCodec的isJpeg方法没有定义到导致的异常。我翻了下源码，发现到skia的so库中必须编译如下这个cpp</p>
<pre class="line-numbers language-shell"><code class="language-shell">"src/codec/SkCodec.cpp",<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个cpp中实际上调用了isJpeg方法。这就是异常的根本。虽然我们并没有编译近jpeg，但是耐不住核心库的解析类调用了啊。并不是网上所说的is_official_build没有打开。</p>
<p>当然，也有可能是我当前的代码是最新版本，导致现象不一致。</p>
<p>因此，我们要裁剪skia，还需要对skia的源码熟悉才行。这其实应该也是skia划分模块没有划分很好的坑。</p>
<p>哈哈，也就是我们常说的，组件化没有彻底。</p>
<h2 id="Skia第一个应用"><a href="#Skia第一个应用" class="headerlink" title="Skia第一个应用"></a>Skia第一个应用</h2><p>skia第一个Android应用很简单：我们就写hello world。用两种方式来写。来验证我这段时间是否阅读懂了Canvas的机制。</p>
<p>CMakeLists的代码在这里就不放出了，很简单的。我们编写两个View，一个是基于Bitmap上修改，另一个是基于Surface的编写。</p>
<p>首先编写好两个native方法：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkiaUtils</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"skia"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"native-lib"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">native_renderCanvas</span><span class="token punctuation">(</span>Bitmap bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">native_render</span><span class="token punctuation">(</span>Surface surface<span class="token punctuation">,</span><span class="token keyword">int</span> width<span class="token punctuation">,</span><span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之前写代码都是静态注册jni，这次来试试动态注册jni：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> className <span class="token operator">=</span> <span class="token string">"com/yjy/skiaapplication/SkiaUtils"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> JNINativeMethod gMethods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span><span class="token string">"native_renderCanvas"</span><span class="token punctuation">,</span><span class="token string">"(Landroid/graphics/Bitmap;)V"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>native_renderCanvas<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"native_render"</span><span class="token punctuation">,</span><span class="token string">"(Landroid/view/Surface;II)V"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>native_render<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


jint <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span><span class="token punctuation">{</span>
    JNIEnv <span class="token operator">*</span>env <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
    jint result<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>vm<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>env<span class="token punctuation">,</span>JNI_VERSION_1_4<span class="token punctuation">)</span><span class="token operator">!=</span>JNI_OK<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    jclass clazz <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>clazz<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"can not find class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>env<span class="token operator">-</span><span class="token operator">></span><span class="token function">RegisterNatives</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span>gMethods<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>gMethods<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sizeof</span><span class="token punctuation">(</span>gMethods<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"can not register method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> JNI_VERSION_1_4<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，这样就把方法注册到JNI中，熟悉源码的肯定对这种方法十分熟悉。</p>
<h4 id="Skia基于Bitmap的编写"><a href="#Skia基于Bitmap的编写" class="headerlink" title="Skia基于Bitmap的编写"></a>Skia基于Bitmap的编写</h4><p>首先编写一个简单View</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkiaView</span> <span class="token keyword">extends</span> <span class="token class-name">View</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">// Used to load the 'native-lib' library on application startup.</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"skia"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"native-lib"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Bitmap bitmap<span class="token punctuation">;</span>
    Paint paint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SkiaView</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">SkiaView</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> AttributeSet attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">SkiaView</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> AttributeSet attrs<span class="token punctuation">,</span> <span class="token keyword">int</span> defStyleAttr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onDraw</span><span class="token punctuation">(</span>Canvas canvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>bitmap <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
            bitmap<span class="token operator">=</span>
                    Bitmap<span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>canvas<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            Bitmap<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>ARGB_8888<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        SkiaUtils<span class="token punctuation">.</span><span class="token function">native_renderCanvas</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        canvas<span class="token punctuation">.</span><span class="token function">drawBitmap</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单就是在onDraw的时候把bitmap传递到底层。把上面的bitmap绘制成我们需要的样子最后把图像绘制上去。</p>
<h4 id="Skia绘制Bitmap"><a href="#Skia绘制Bitmap" class="headerlink" title="Skia绘制Bitmap"></a>Skia绘制Bitmap</h4><p>网上有很多Skia的资料，很遗憾无一例外都过时了，很多api都迁移和变化了，不过只是运用api是十分简单的事情，看看文档就能解决了。如果是Android开发看起来更加轻松，因为Skia几乎都是在SkCanvas上绘制，实际上对应的是Android的Canvas对象。每一个SkCanvas都对应上了Android中Canvas的Java api。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL
<span class="token function">native_renderCanvas</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jobject bitmap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// TODO: implement native_renderCanvas()</span>
    <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"native render"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    AndroidBitmapInfo info<span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>pixel<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">AndroidBitmap_getInfo</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>bitmap<span class="token punctuation">,</span><span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">AndroidBitmap_lockPixels</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>bitmap<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pixel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> width <span class="token operator">=</span> info<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token keyword">int</span> height <span class="token operator">=</span> info<span class="token punctuation">.</span>height<span class="token punctuation">;</span>

    SkBitmap bm <span class="token operator">=</span> <span class="token function">SkBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SkImageInfo image_info <span class="token operator">=</span> SkImageInfo
            <span class="token operator">::</span><span class="token function">MakeS32</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span>height<span class="token punctuation">,</span>SkAlphaType<span class="token operator">::</span>kOpaque_SkAlphaType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bm<span class="token punctuation">.</span><span class="token function">setInfo</span><span class="token punctuation">(</span>image_info<span class="token punctuation">,</span>image_info<span class="token punctuation">.</span><span class="token function">minRowBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bm<span class="token punctuation">.</span><span class="token function">setPixels</span><span class="token punctuation">(</span>pixel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    SkCanvas <span class="token function">background</span><span class="token punctuation">(</span>bm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SkPaint paint<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//画笔</span>

    paint<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>SK_ColorBLACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SkRect rect<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//绘制一个矩形区域</span>
    rect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>SkIRect<span class="token operator">::</span><span class="token function">MakeWH</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    background<span class="token punctuation">.</span><span class="token function">drawRect</span><span class="token punctuation">(</span>rect<span class="token punctuation">,</span>paint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    SkPaint paint2<span class="token punctuation">;</span>
    paint2<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>SK_ColorBLUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello Skia"</span><span class="token punctuation">;</span>

    SkFont <span class="token function">skfont</span><span class="token punctuation">(</span>SkTypeface<span class="token operator">::</span><span class="token function">MakeDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    background<span class="token punctuation">.</span><span class="token function">drawString</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span>skfont<span class="token punctuation">,</span>paint2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">AndroidBitmap_unlockPixels</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>AndroidBitmap_getInfo获取bitmap中所有的信息。接着通过lock方法，把pixel的像素指针给关联起来，最后通过绘制背景和文字在SKCanvas上，呈现出一个Hello Skia方法。<br><img src="/images/Hello_Skia.png" alt="Hello_Skia.png"></p>
<h3 id="Skia基于Surface绘制"><a href="#Skia基于Surface绘制" class="headerlink" title="Skia基于Surface绘制"></a>Skia基于Surface绘制</h3><p>好像很多文章都止步于绘制bitmap，没有其他想法。我倒是看到一个哥们直接获取Android源码的skia相关文件，编译出so库。这不失是一种好方法，这样就能编译出Android中纯净的Skia。</p>
<p>他的做法是把Canvas对象传到底层，直接通过GraphicsJNI把Java的Canvas转化为SkCanvas。我不知道这个作者是基于什么版本开发的，我反正一路看到Android 4.4就没兴趣看下去了。</p>
<p>GraphicsJNI本质上是获取Canvas中存着native对象的地址。但是这个地址对象并非是SkCanvas，而是SkiaCanvas。SkiaCanvas和SkCanvas并非继承关系，而是包含关系。虽然我当然能写一模一个的获取Java对象的方法，但是获取的SkiaCanvas对象，会对整个编程造成错误，甚至是误导。</p>
<p>关于这一块的源码理解，我们将会在Android重学系列，和大家好好讲讲它们之间的关系。</p>
<p>还有一种做法，了解音视频开发的哥们一定会熟悉，在Android中一种叫做NativeWindow的本地窗口，是用来在Surface上绘制。关于NativeWindow也会在Android重学系列和大家聊聊。</p>
<p>我们这一次借助NativeWindow来绘制Skia。</p>
<h5 id="编写一个简单的SurfaceView"><a href="#编写一个简单的SurfaceView" class="headerlink" title="编写一个简单的SurfaceView"></a>编写一个简单的SurfaceView</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * &lt;pre>
 *     author : yjy
 *     e-mail : yujunyu12@gmail.com
 *     time   : 2019/09/14
 *     desc   :
 *     version: 1.0
 * &lt;/pre>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkiaCanvasView</span> <span class="token keyword">extends</span> <span class="token class-name">SurfaceView</span> <span class="token keyword">implements</span> <span class="token class-name">SurfaceHolder<span class="token punctuation">.</span>Callback2</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> SurfaceHolder mHolder<span class="token punctuation">;</span>
    <span class="token keyword">private</span> HandlerThread mHandlerThread<span class="token punctuation">;</span>
    <span class="token keyword">private</span> Handler mHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DRAW <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SkiaCanvasView</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">SkiaCanvasView</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> AttributeSet attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">SkiaCanvasView</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> AttributeSet attrs<span class="token punctuation">,</span> <span class="token keyword">int</span> defStyleAttr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        mHandlerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HandlerThread</span><span class="token punctuation">(</span><span class="token string">"Skia"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHolder <span class="token operator">=</span> <span class="token function">getHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHolder<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHandlerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkiaHandler</span><span class="token punctuation">(</span>mHandlerThread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceRedrawNeeded</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceCreated</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Message message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span>what <span class="token operator">=</span> DRAW<span class="token punctuation">;</span>
        message<span class="token punctuation">.</span>obj <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> <span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span>arg2 <span class="token operator">=</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token punctuation">,</span><span class="token string">"width:"</span><span class="token operator">+</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token punctuation">,</span><span class="token string">"height"</span><span class="token operator">+</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceChanged</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">,</span> <span class="token keyword">int</span> format<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceDestroyed</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mHandlerThread<span class="token punctuation">.</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span>  <span class="token keyword">class</span> <span class="token class-name">SkiaHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span><span class="token punctuation">{</span>

        <span class="token keyword">public</span> <span class="token function">SkiaHandler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">case</span> DRAW<span class="token operator">:</span>

                       SkiaUtils<span class="token punctuation">.</span><span class="token function">native_render</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Surface<span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">,</span>msg<span class="token punctuation">.</span>arg1<span class="token punctuation">,</span>msg<span class="token punctuation">.</span>arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>


                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，不解释。</p>
<h4 id="绘制Skia"><a href="#绘制Skia" class="headerlink" title="绘制Skia"></a>绘制Skia</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL
<span class="token function">native_render</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jobject jSurface<span class="token punctuation">,</span>jint width<span class="token punctuation">,</span>jint height<span class="token punctuation">)</span><span class="token punctuation">{</span>
    ANativeWindow <span class="token operator">*</span>nativeWindow <span class="token operator">=</span> <span class="token function">ANativeWindow_fromSurface</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>jSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">ANativeWindow_setBuffersGeometry</span><span class="token punctuation">(</span>nativeWindow<span class="token punctuation">,</span>  width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> WINDOW_FORMAT_RGBA_8888<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ANativeWindow_Buffer <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">ANativeWindow_Buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ANativeWindow_lock</span><span class="token punctuation">(</span>nativeWindow<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">int</span> bpr <span class="token operator">=</span> buffer<span class="token operator">-</span><span class="token operator">></span>stride <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>


    SkBitmap bitmap<span class="token punctuation">;</span>
    SkImageInfo image_info <span class="token operator">=</span> SkImageInfo
    <span class="token operator">::</span><span class="token function">MakeS32</span><span class="token punctuation">(</span>buffer<span class="token operator">-</span><span class="token operator">></span>width<span class="token punctuation">,</span>buffer<span class="token operator">-</span><span class="token operator">></span>height<span class="token punctuation">,</span>SkAlphaType<span class="token operator">::</span>kPremul_SkAlphaType<span class="token punctuation">)</span><span class="token punctuation">;</span>


    bitmap<span class="token punctuation">.</span><span class="token function">setInfo</span><span class="token punctuation">(</span>image_info<span class="token punctuation">,</span>bpr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    bitmap<span class="token punctuation">.</span><span class="token function">setPixels</span><span class="token punctuation">(</span>buffer<span class="token operator">-</span><span class="token operator">></span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span>

    SkCanvas <span class="token operator">*</span>background <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">SkCanvas</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SkPaint paint<span class="token punctuation">;</span>

    paint<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>SK_ColorBLUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SkRect rect<span class="token punctuation">;</span>
    rect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>SkIRect<span class="token operator">::</span><span class="token function">MakeWH</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    background<span class="token operator">-</span><span class="token operator">></span><span class="token function">drawRect</span><span class="token punctuation">(</span>rect<span class="token punctuation">,</span>paint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    SkPaint paint2<span class="token punctuation">;</span>
    paint2<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>SK_ColorWHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello Surface Skia"</span><span class="token punctuation">;</span>

    SkFont <span class="token function">skfont</span><span class="token punctuation">(</span>SkTypeface<span class="token operator">::</span><span class="token function">MakeDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    background<span class="token operator">-</span><span class="token operator">></span><span class="token function">drawString</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span>skfont<span class="token punctuation">,</span>paint2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    SkImageInfo imageInfo <span class="token operator">=</span> background<span class="token operator">-</span><span class="token operator">></span><span class="token function">imageInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"row size:%d,buffer stride:%d"</span><span class="token punctuation">,</span>imageInfo<span class="token punctuation">.</span><span class="token function">minRowBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>bpr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"before native_window stride:%d,width:%d,height:%d,format:%d"</span><span class="token punctuation">,</span>
            buffer<span class="token operator">-</span><span class="token operator">></span>stride<span class="token punctuation">,</span>buffer<span class="token operator">-</span><span class="token operator">></span>width<span class="token punctuation">,</span>buffer<span class="token operator">-</span><span class="token operator">></span>height<span class="token punctuation">,</span>buffer<span class="token operator">-</span><span class="token operator">></span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> rowSize <span class="token operator">=</span> imageInfo<span class="token punctuation">.</span><span class="token function">minRowBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>




    <span class="token keyword">bool</span> isCopy <span class="token operator">=</span>  background<span class="token operator">-</span><span class="token operator">></span><span class="token function">readPixels</span><span class="token punctuation">(</span>imageInfo<span class="token punctuation">,</span>buffer<span class="token operator">-</span><span class="token operator">></span>bits<span class="token punctuation">,</span>bpr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"after native_window stride:%d,width:%d,height:%d,format:%d"</span><span class="token punctuation">,</span>
         buffer<span class="token operator">-</span><span class="token operator">></span>stride<span class="token punctuation">,</span>buffer<span class="token operator">-</span><span class="token operator">></span>width<span class="token punctuation">,</span>buffer<span class="token operator">-</span><span class="token operator">></span>height<span class="token punctuation">,</span>buffer<span class="token operator">-</span><span class="token operator">></span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ANativeWindow_unlockAndPost</span><span class="token punctuation">(</span>nativeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>readPixels 第一个参数是ImageInfo，图像信息;第二个是像素集合;第三个参数是是每一行的像素字节数；第四个参数是x方向的偏移量；第五个参数是y轴方向的偏移量。</p>
<p>能看到，我们同样是生成一个新的SkCanvas，把图像和文字绘制到上面，最后读取所有的像素点，并且把像素点的数据传送出去。</p>
<p><img src="/images/Skia%E7%BB%98%E5%88%B6%E5%BC%82%E5%B8%B8.png" alt="Skia绘制异常.png"></p>
<p>这是怎么回事？为什么文字都变形了？？看起来整个文字被压缩了。当我放大整个显示范围时候，发现整个文字向右边倒下去了，并且被压缩了。</p>
<p>这个问题坑了快一个小时。当时其实已经有了初步猜测，如果了解OpenGL就知道，实际上在我们传输数据的时候，需要定义每一行要读取多少数据，要跳转多少位数。当一行的数据设置异常的时候，就图像就会出现异常。因为每一行读的数据多了，下一行实际上起点向后挪动了，这就是文字往右边倒的原因。</p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>我当时翻阅了Android源码看到了，Android源码在测定每一行的时候，并非是通过imageInfo去计算一行最小字节数，而是通过nativeWindow中buffer的一行的像素*像素大小得到的每一行的字节数目。</p>
<p>经过打印确实nativeWindow中通过buffer得到的stride和minRowSize计算的结果不一样。有兴趣的可以去看看，minRowSize计算的是最小的行字节长度，实际上是有可能大于等于这个数字的。</p>
<p>于是，我把readPixels修改成如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">background<span class="token operator">-</span><span class="token operator">></span><span class="token function">readPixels</span><span class="token punctuation">(</span>imageInfo<span class="token punctuation">,</span>buffer<span class="token operator">-</span><span class="token operator">></span>bits<span class="token punctuation">,</span>bpr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如下图：<br><img src="/images/Hello_Skia_Surface.png" alt="Hello_Skia_Surface.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Skia的初探先到这里，到这里也算是入门了。之后Skia相关的文章将会是关于Skia的源码解析篇。这也算是Android开发的好处，不需要过多熟悉Skia的api，因为我们在做Canvas的时候其实操作的就是SkCanvas的api。</p>
<p>从解决问题上的思路，可以明白阅读源码不仅仅是理解原理，更加重要的是，能解决看起来完全没头绪的问题，看起来不太可能的实现的功能。这也是我为什么热衷于阅读源码的原因。</p>
<p>最后，附上demo地址的demo:<a href="https://github.com/yjy239/SkiaDemo">https://github.com/yjy239/SkiaDemo</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/09/26/android-chong-xue-xi-lie-view-de-hui-zhi-liu-cheng-yi-view-de-chu-shi-hua/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="Android 重学系列 View的绘制流程 (一)View的初始化">
                        
                        <span class="card-title">Android 重学系列 View的绘制流程 (一)View的初始化</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言View的绘制流程这一篇文章其实十分不好写，因为在网上已经有千篇一律的文章，导致我一直不太想写这一篇文章。不过既然是Android重学系列，还是一步一脚印来分析分析里面的细节。如果对这个流程很熟悉的人来说，本文就没必要阅读了。如果不是很
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-09-26
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/View的绘制流程/" class="post-category">
                                    View的绘制流程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/09/26/android-chong-xue-xi-lie-wms-zai-activity-qi-dong-zhong-de-zhi-ze-ji-suan-chuang-ti-de-da-xiao-si/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="Android 重学系列 WMS在Activity启动中的职责 计算窗体的大小(四)">
                        
                        <span class="card-title">Android 重学系列 WMS在Activity启动中的职责 计算窗体的大小(四)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言通过启动窗口为例子，大致上明白了WMS是如何添加，更新，移除窗口的工作原理。本文将会重点聊一聊窗口的大小计算逻辑。
下面的源码都是来自Android 9.0
正文窗口大小计算计算窗口的大小和Android 4.4相比变化很大。花了一点心
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-09-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/WMS/" class="post-category">
                                    WMS
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
