<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 Activity的启动流程(三), Android | Linux | Flutter">
    <meta name="description" content="前文提要如果发现错误，请在本文指出：https://www.jianshu.com/p/ac7b6a525b96
上一篇文章，跟随着源码深入了剖析了ActivityStack，TaskRecord在Activity启动的过程，怎么选择Tas">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 Activity的启动流程(三) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/2.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 Activity的启动流程(三)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android-Framework/" class="post-category">
                                Android Framework
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-11-07
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        7.5k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        36 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前文提要"><a href="#前文提要" class="headerlink" title="前文提要"></a>前文提要</h1><p>如果发现错误，请在本文指出：<a href="https://www.jianshu.com/p/ac7b6a525b96" target="_blank" rel="noopener">https://www.jianshu.com/p/ac7b6a525b96</a></p>
<p>上一篇文章，跟随着源码深入了剖析了ActivityStack，TaskRecord在Activity启动的过程，怎么选择TaskRecord以及ActivityStack，以及是如何创建TaskRecord以及ActivityStack。当我们，确定的ActivityRecord，确定了TaskRecord，ActivityStack以及ActivityDisplay，已经决定好了ActivityRecord应该放在哪里，接下来就要通过Binder跨进程通信创建Activity。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>在我们操作完ActivityStack，TaskRecord在什么时候移动的前端，并且添加完ActivityRecord到TaskRecord之后。我们的数据结构已经处理完毕，还差跨进程启动Activity。但是启动Activity当然不可能凭空诞生，要我们自己编写逻辑，很容易能想到如下规则:</p>
<ul>
<li>1.先暂定当前正在交互的Activity</li>
<li>2.检测Activity对应的进程是否存在</li>
<li>3.上述两步完成之后，才开始正在跨进程启动Activity。</li>
</ul>
<p>接下来也是按照如下几步来处理。</p>
<h1 id="resumeTopActivityInnerLocked-启动Activity"><a href="#resumeTopActivityInnerLocked-启动Activity" class="headerlink" title="resumeTopActivityInnerLocked 启动Activity"></a>resumeTopActivityInnerLocked 启动Activity</h1><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStack.java" target="_blank" rel="noopener">ActivityStack.java</a><br>这里我们只关注核心的内容。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">resumeTopActivityInnerLocked</span><span class="token punctuation">(</span>ActivityRecord prev<span class="token punctuation">,</span> ActivityOptions options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">final</span> ActivityRecord next <span class="token operator">=</span> <span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* focusableOnly */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasRunningActivity <span class="token operator">=</span> next <span class="token operator">!=</span> null<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// TODO: Maybe this entire condition can get removed?</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasRunningActivity <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">boolean</span> lastResumedCanPip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        ActivityRecord lastResumed <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">final</span> ActivityStack lastFocusedStack <span class="token operator">=</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">getLastStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> resumeWhilePausing <span class="token operator">=</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> FLAG_RESUME_WHILE_PAUSING<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>lastResumedCanPip<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//停止Task内栈内的Activity</span>
        <span class="token keyword">boolean</span> pausing <span class="token operator">=</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">pauseBackStacks</span><span class="token punctuation">(</span>userLeaving<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mResumedActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pausing <span class="token operator">|=</span> <span class="token function">startPausingLocked</span><span class="token punctuation">(</span>userLeaving<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//判断到停止成功，则更新进程的lru数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pausing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>resumeWhilePausing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mService<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastResumed <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lastResumed<span class="token punctuation">.</span><span class="token function">setWillCloseOrEnterPip</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mResumedActivity <span class="token operator">==</span> next <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span><span class="token function">isState</span><span class="token punctuation">(</span>RESUMED<span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">allResumedActivitiesComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        ActivityStack lastStack <span class="token operator">=</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">getLastStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">final</span> <span class="token keyword">boolean</span> lastActivityTranslucent <span class="token operator">=</span> lastStack <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>lastStack<span class="token punctuation">.</span><span class="token function">inMultiWindowMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token punctuation">(</span>lastStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>lastStack<span class="token punctuation">.</span>mLastPausedActivity<span class="token punctuation">.</span>fullscreen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//判断下一个即将即启动的ActivityRecord数据本省存在app等数据，则尝试resume</span>
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mWindowManager<span class="token punctuation">.</span><span class="token function">getWindowManagerLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>visible <span class="token operator">||</span> next<span class="token punctuation">.</span>stopped <span class="token operator">||</span> lastActivityTranslucent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>


                next<span class="token punctuation">.</span><span class="token function">startLaunchTickingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                ActivityRecord lastResumedActivity <span class="token operator">=</span>
                        lastStack <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span>lastStack<span class="token punctuation">.</span>mResumedActivity<span class="token punctuation">;</span>
                <span class="token keyword">final</span> ActivityState lastState <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                mService<span class="token punctuation">.</span><span class="token function">updateCpuStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                next<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>RESUMED<span class="token punctuation">,</span> <span class="token string">"resumeTopActivityInnerLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                mService<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">updateLRUListLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> ClientTransaction transaction <span class="token operator">=</span> ClientTransaction<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">,</span>
                            next<span class="token punctuation">.</span>appToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// Deliver all pending results.</span>
                    ArrayList<span class="token operator">&lt;</span>ResultInfo<span class="token operator">></span> a <span class="token operator">=</span> next<span class="token punctuation">.</span>results<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>finishing <span class="token operator">&amp;&amp;</span> N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            transaction<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>ActivityResultItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>newIntents <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        transaction<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>NewIntentItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>newIntents<span class="token punctuation">,</span>
                                <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* andPause */</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>


                    next<span class="token punctuation">.</span><span class="token function">notifyAppResumed</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>stopped<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    next<span class="token punctuation">.</span>sleeping <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    mService<span class="token punctuation">.</span><span class="token function">getAppWarningsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onResumeActivity</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mService<span class="token punctuation">.</span><span class="token function">showAskCompatModeDialogLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pendingUiClean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    next<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">forceProcessStateUpTo</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mTopProcessState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    next<span class="token punctuation">.</span><span class="token function">clearOptionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    transaction<span class="token punctuation">.</span><span class="token function">setLifecycleStateRequest</span><span class="token punctuation">(</span>
                            ResumeActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>repProcState<span class="token punctuation">,</span>
                                    mService<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">//resume失败，则尝试restart</span>
                    next<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>lastState<span class="token punctuation">,</span> <span class="token string">"resumeTopActivityInnerLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


                    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastResumedActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        lastResumedActivity<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>RESUMED<span class="token punctuation">,</span> <span class="token string">"resumeTopActivityInnerLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>hasBeenLaunched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        next<span class="token punctuation">.</span>hasBeenLaunched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>SHOW_APP_STARTING_PREVIEW <span class="token operator">&amp;&amp;</span> lastStack <span class="token operator">!=</span> null
                            <span class="token operator">&amp;&amp;</span> lastStack<span class="token punctuation">.</span><span class="token function">isTopStackOnDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        next<span class="token punctuation">.</span><span class="token function">showStartingWindow</span><span class="token punctuation">(</span>null <span class="token comment" spellcheck="true">/* prev */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* newTask */</span><span class="token punctuation">,</span>
                                <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* taskSwitch */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mStackSupervisor<span class="token punctuation">.</span><span class="token function">startSpecificActivityLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>


            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span><span class="token function">completeResumeLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">requestFinishActivityLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                        <span class="token string">"resume-exception"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STACK<span class="token punctuation">)</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">validateTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Whoops, need to restart this activity!</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>hasBeenLaunched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span>hasBeenLaunched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>SHOW_APP_STARTING_PREVIEW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next<span class="token punctuation">.</span><span class="token function">showStartingWindow</span><span class="token punctuation">(</span>null <span class="token comment" spellcheck="true">/* prev */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* newTask */</span><span class="token punctuation">,</span>
                            <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* taskSwich */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>

            mStackSupervisor<span class="token punctuation">.</span><span class="token function">startSpecificActivityLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个代码片段中，实际上可以看成在做两个步骤。</p>
<ul>
<li>1.第一个调用Task栈内的所有Activity的onPause方法。</li>
<li>2.检测ActivityRecord是否为复用对象，是则回调onResume，不是则准备开始跨进程</li>
</ul>
<h2 id="调用Task栈内的所有Activity的onPause"><a href="#调用Task栈内的所有Activity的onPause" class="headerlink" title="调用Task栈内的所有Activity的onPause"></a>调用Task栈内的所有Activity的onPause</h2><p>在此时这个场景中，ActivityRecord next以及ActivityRecord prev是指同一个对象。因为在上一篇文章就有交代，在addOrReparentStartingActivity中会把ActivityRecord添加到Task的mActivities顶部。</p>
<p>因此此时从方法上传过来的和topRunningActivityLocked获取到的对象实际上都是我们新增加的ActivityRecord。<br>我们关注这一段代码</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">boolean</span> pausing <span class="token operator">=</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">pauseBackStacks</span><span class="token punctuation">(</span>userLeaving<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mResumedActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pausing <span class="token operator">|=</span> <span class="token function">startPausingLocked</span><span class="token punctuation">(</span>userLeaving<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>让我们坠重一下对应的pauseBackStacks方法。<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java" target="_blank" rel="noopener">ActivityStackSupervisor.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">boolean</span> <span class="token function">pauseBackStacks</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> userLeaving<span class="token punctuation">,</span> ActivityRecord resuming<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dontWait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> someActivityPaused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ActivityDisplay display <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> stackNdx <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> stackNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>stackNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getChildAt</span><span class="token punctuation">(</span>stackNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFocusedStack</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> stack<span class="token punctuation">.</span><span class="token function">getResumedActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span> <span class="token string">"pauseBackStacks: stack="</span> <span class="token operator">+</span> stack <span class="token operator">+</span>
                            <span class="token string">" mResumedActivity="</span> <span class="token operator">+</span> stack<span class="token punctuation">.</span><span class="token function">getResumedActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    someActivityPaused <span class="token operator">|=</span> stack<span class="token punctuation">.</span><span class="token function">startPausingLocked</span><span class="token punctuation">(</span>userLeaving<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> resuming<span class="token punctuation">,</span>
                            dontWait<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> someActivityPaused<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，这里面实际上会循环获取ActivityStackSupervisor中的ActivityDisplay中的ActivityStack。去调用每个stack的startPausingLocked方法。能发现，调用Activity的onPause方法，都是通过startPausingLocked这个核心方法。</p>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">startPausingLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> userLeaving<span class="token punctuation">,</span> <span class="token keyword">boolean</span> uiSleeping<span class="token punctuation">,</span>
            ActivityRecord resuming<span class="token punctuation">,</span> <span class="token keyword">boolean</span> pauseImmediately<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPausingActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldSleepActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">completePauseLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> resuming<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        ActivityRecord prev <span class="token operator">=</span> mResumedActivity<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resuming <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mStackSupervisor<span class="token punctuation">.</span><span class="token function">resumeFocusedStackTopActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">==</span> resuming<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mPausingActivity <span class="token operator">=</span> prev<span class="token punctuation">;</span>
        mLastPausedActivity <span class="token operator">=</span> prev<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> prev<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mService<span class="token punctuation">.</span><span class="token function">updateUsageStats</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">,</span> prev<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span>
                        PauseActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>finishing<span class="token punctuation">,</span> userLeaving<span class="token punctuation">,</span>
                                prev<span class="token punctuation">.</span>configChangeFlags<span class="token punctuation">,</span> pauseImmediately<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mPausingActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
                mLastPausedActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
                mLastNoHistoryActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mPausingActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
            mLastPausedActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
            mLastNoHistoryActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uiSleeping <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span><span class="token function">isSleepingOrShuttingDownLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mStackSupervisor<span class="token punctuation">.</span><span class="token function">acquireLaunchWakelock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPausingActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uiSleeping<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                prev<span class="token punctuation">.</span><span class="token function">pauseKeyDispatchingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_PAUSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_PAUSE<span class="token punctuation">,</span> <span class="token string">"Key dispatch not paused for screen off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>pauseImmediately<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">completePauseLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> resuming<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">schedulePauseTimeout</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resuming <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mStackSupervisor<span class="token punctuation">.</span><span class="token function">resumeFocusedStackTopActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们能看到实际上在这段代码十分简单：</p>
<ul>
<li><p>1.首先判断当前需要停止的，和需要交互的ActivityRecord是不是同一个。是同一个则说明不需要停止ActivityRecord对应App端的Activity。</p>
</li>
<li><p>2.如果mResumedActivity的app以及app.thread都是不为空，说明该ActivityRecord已经启动过了。那么就能尝试着跨进程调用ActivityRecord对应的Activity的onPause方法。核心方法是下面:</p>
<pre class="line-numbers language-java"><code class="language-java"> mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">,</span> prev<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span>
                      PauseActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>finishing<span class="token punctuation">,</span> userLeaving<span class="token punctuation">,</span>
                              prev<span class="token punctuation">.</span>configChangeFlags<span class="token punctuation">,</span> pauseImmediately<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>能看到的是，里面有一个关键的对象PauseActivityItem。这个对象是用来跨进程通信，记住这个对象，十分重要，这个方法就是跨进程的核心方法，稍后会回来分析。</p>
</li>
<li><p>3.假如停止的mPausingActivity不为空，则按照标志位，来判断是否需要调用resume当前传下来的ActivityRecord。</p>
</li>
</ul>
<p>这里值得注意一下的，此时有一个mResumedActivity对象。这个对象实际上在addOrReparentStartingActivity方法中会执行这么一个步骤addActivityAtIndex，设置完ActivityRecord设置完为止，就会调用setTask方法绑定当前的Task，其中就是这个方法：<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/TaskRecord.java" target="_blank" rel="noopener">TaskRecord.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">void</span> <span class="token function">setTask</span><span class="token punctuation">(</span>TaskRecord task<span class="token punctuation">,</span> <span class="token keyword">boolean</span> reparenting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Do nothing if the {@link TaskRecord} is the same as the current {@link getTask}.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> task <span class="token operator">==</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> ActivityStack oldStack <span class="token operator">=</span> <span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//从TaskRecord找到ActivityStack</span>
        <span class="token keyword">final</span> ActivityStack newStack <span class="token operator">=</span> task <span class="token operator">!=</span> null <span class="token operator">?</span> task<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Inform old stack (if present) of activity removal and new stack (if set) of activity</span>
        <span class="token comment" spellcheck="true">// addition.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStack <span class="token operator">!=</span> newStack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reparenting <span class="token operator">&amp;&amp;</span> oldStack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                oldStack<span class="token punctuation">.</span><span class="token function">onActivityRemovedFromStack</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>newStack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                newStack<span class="token punctuation">.</span><span class="token function">onActivityAddedToStack</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>task <span class="token operator">=</span> task<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reparenting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onParentChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在ActivityRecord绑定TaskRecord的时候，能够发现当ActivityRecord切换了绑定Stack或者当ActivityRecord还没有绑定TaskRecord的时候，都会调用onActivityAddedToStack，设置mResumedActivity。也是精力这个步骤，才能确定在startPausingLocked方法中确定当前正在resume的是哪个Activity，那么pause就只需要停止这个Activity。</p>
<h2 id="检测ActivityRecord是否为复用对象，是则回调onResume，不是则准备开始跨进程"><a href="#检测ActivityRecord是否为复用对象，是则回调onResume，不是则准备开始跨进程" class="headerlink" title="检测ActivityRecord是否为复用对象，是则回调onResume，不是则准备开始跨进程"></a>检测ActivityRecord是否为复用对象，是则回调onResume，不是则准备开始跨进程</h2><pre class="line-numbers language-java"><code class="language-java">next<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在下一段代码片段中我们首先能看到上述代码段。此时分为两种情况：</p>
<ul>
<li>1.当此时判断到下一个要启动的ActivityRecord，不存在app(ProcessRecord)对象以及app.thread（IApplicationThread象征着ActivityRecord）。而绑定这个对象是在后面的步骤，因此此时就能判断到是一个复用的Activity，直接尝试调用<pre class="line-numbers language-java"><code class="language-java">transaction<span class="token punctuation">.</span><span class="token function">setLifecycleStateRequest</span><span class="token punctuation">(</span>
                         ResumeActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>repProcState<span class="token punctuation">,</span>
                                 mService<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
跨进程调用ActivityRecord对应Activity的onResume回调。</li>
</ul>
<ul>
<li>2.当判断到这两个对象为空，说明是新建的ActivityRecord，还没有和App端进行绑定。因此会调用<pre class="line-numbers language-java"><code class="language-java">mStackSupervisor<span class="token punctuation">.</span><span class="token function">startSpecificActivityLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h1 id="startSpecificActivityLocked检测ProcessRecord"><a href="#startSpecificActivityLocked检测ProcessRecord" class="headerlink" title="startSpecificActivityLocked检测ProcessRecord"></a>startSpecificActivityLocked检测ProcessRecord</h1><p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java" target="_blank" rel="noopener">ActivityStackSupervisor.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">startSpecificActivityLocked</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ProcessRecord app <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">getLaunchTimeTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLaunchTime</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ActivityInfo<span class="token punctuation">.</span>FLAG_MULTIPROCESS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                        <span class="token operator">||</span> <span class="token operator">!</span><span class="token string">"android"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>longVersionCode<span class="token punctuation">,</span>
                            mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">,</span> andResume<span class="token punctuation">,</span> checkConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        mService<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">"activity"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一段的代码主要是检测Activity是否存在期待的进程。如果存在就调用realStartActivityLocked，开始跨进程。不存在则调用startProcessLocked，先通过socket联通Zygote，让Zygote孵化一个需要的进程，在重新进行startActivity。这个步骤我在很早就聊过了，这里不再赘述，我们把目光放到realStartActivityLocked跨进程启动Activity。</p>
<h1 id="realStartActivityLocked跨进程启动Activity"><a href="#realStartActivityLocked跨进程启动Activity" class="headerlink" title="realStartActivityLocked跨进程启动Activity"></a>realStartActivityLocked跨进程启动Activity</h1><p>在这个方法中，我们只想关注，我们需要关注的。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span> ProcessRecord app<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">allPausedActivitiesComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">beginDeferResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">startFreezingScreenLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            r<span class="token punctuation">.</span><span class="token function">startLaunchTickingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            r<span class="token punctuation">.</span><span class="token function">setProcess</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getKeyguardController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isKeyguardLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span><span class="token function">notifyUnknownVisibilityLaunched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">int</span> idx <span class="token operator">=</span> app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mService<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                List<span class="token operator">&lt;</span>ResultInfo<span class="token operator">></span> results <span class="token operator">=</span> null<span class="token punctuation">;</span>
                List<span class="token operator">&lt;</span>ReferrerIntent<span class="token operator">></span> newIntents <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    results <span class="token operator">=</span> r<span class="token punctuation">.</span>results<span class="token punctuation">;</span>
                    newIntents <span class="token operator">=</span> r<span class="token punctuation">.</span>newIntents<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isActivityTypeHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Home process is the root process of the task.</span>
                    mService<span class="token punctuation">.</span>mHomeProcess <span class="token operator">=</span> task<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>app<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token comment" spellcheck="true">// Create activity launch transaction.</span>
                <span class="token keyword">final</span> ClientTransaction clientTransaction <span class="token operator">=</span> ClientTransaction<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>appToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                clientTransaction<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>LaunchActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
                        <span class="token comment" spellcheck="true">// TODO: Have this take the merged configuration instead of separate global</span>
                        <span class="token comment" spellcheck="true">// and override configs.</span>
                        mergedConfiguration<span class="token punctuation">.</span><span class="token function">getGlobalConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mergedConfiguration<span class="token punctuation">.</span><span class="token function">getOverrideConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>compat<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">,</span> task<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> app<span class="token punctuation">.</span>repProcState<span class="token punctuation">,</span> r<span class="token punctuation">.</span>icicle<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>persistentState<span class="token punctuation">,</span> results<span class="token punctuation">,</span> newIntents<span class="token punctuation">,</span> mService<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        profilerInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Set desired final state.</span>
                <span class="token keyword">final</span> ActivityLifecycleItem lifecycleItem<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lifecycleItem <span class="token operator">=</span> ResumeActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    lifecycleItem <span class="token operator">=</span> PauseActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                clientTransaction<span class="token punctuation">.</span><span class="token function">setLifecycleStateRequest</span><span class="token punctuation">(</span>lifecycleItem<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Schedule transaction.</span>
                mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>clientTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>launchFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mService<span class="token punctuation">.</span><span class="token function">appDiedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    stack<span class="token punctuation">.</span><span class="token function">requestFinishActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                            <span class="token string">"2nd-crash"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                r<span class="token punctuation">.</span>launchFailed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">endDeferResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span>launchFailed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">updateLRUListLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在真正的启动之前，AMS会先更新进程的在LRU中的缓存位置，接着会更新应用adj值，更新应用的优先级。做完这些行为之后才开始跨进程启动Activity。我们在这里在一次看到这几个类：ClientTransaction，LaunchActivityItem，ResumeActivityItem等等。</p>
<h2 id="ClientTransactionItem"><a href="#ClientTransactionItem" class="headerlink" title="ClientTransactionItem"></a>ClientTransactionItem</h2><p>这几个类实际上是，代表着AMS控制App远程端生命周期抽象成的状态机以及状态。在AMS跨进程控制Activity生命周期中涉及到了如下几个类：</p>
<ul>
<li>1.ClientTransaction 客户端事务控制者</li>
<li>2.ClientLifecycleManager 客户端的生命周期事务控制者</li>
<li>3.TransactionExecutor 远程通信事务执行者</li>
<li>4.LaunchActivityItem 远程App端的onCreate生命周期事务</li>
<li>5.ResumeActivityItem 远程App端的onResume生命周期事务</li>
<li>6.PauseActivityItem 远程App端的onPause生命周期事务</li>
<li>7.StopActivityItem 远程App端的onStop生命周期事务</li>
<li>8.DestroyActivityItem 远程App端onDestroy生命周期事务。</li>
<li>9.ClientTransactionHandler App端对ClientTransaction的处理。</li>
</ul>
<p>仅仅是这样列出就能很简单的看出了google工程师对Android生命周期设计上的优化。并且能看到的是，在这里面我们并不能看到七大生命周期中的onStart以及onRestart。实际上，onRestart复用了LaunchActivityItem重新启动Activity，而onStart只是在onCreate之后，App客户端本地调用。</p>
<p>但是这样还不足以弄清楚整个结构什么，我们看看对应的UML图。<br><img src="/images/ClientTransaction.png" alt="ClientTransaction.png"></p>
<p>从这里我们清楚看到所有生命周期都是继承抽象出来的基类ClientTransactionItem。每当我们尝试着做着跨进程的操作，都会使用ClientTransactionItem这个基类。因此实际上还有ActivityResultItem,NewIntentItem等进行跨进程操作。</p>
<p>稍微理解了其中的类的结构，我们尝试着看看里面源码。我们抽出Activity启动的源码：</p>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">final</span> ClientTransaction clientTransaction <span class="token operator">=</span> ClientTransaction<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>appToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                clientTransaction<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>LaunchActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
                        <span class="token comment" spellcheck="true">// TODO: Have this take the merged configuration instead of separate global</span>
                        <span class="token comment" spellcheck="true">// and override configs.</span>
                        mergedConfiguration<span class="token punctuation">.</span><span class="token function">getGlobalConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mergedConfiguration<span class="token punctuation">.</span><span class="token function">getOverrideConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>compat<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">,</span> task<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> app<span class="token punctuation">.</span>repProcState<span class="token punctuation">,</span> r<span class="token punctuation">.</span>icicle<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>persistentState<span class="token punctuation">,</span> results<span class="token punctuation">,</span> newIntents<span class="token punctuation">,</span> mService<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        profilerInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> ActivityLifecycleItem lifecycleItem<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 lifecycleItem <span class="token operator">=</span> ResumeActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
                clientTransaction<span class="token punctuation">.</span><span class="token function">setLifecycleStateRequest</span><span class="token punctuation">(</span>lifecycleItem<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Schedule transaction.</span>
                mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>clientTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这段代码段中，AMS先创建一个LaunchActivityItem作为callback，ResumeActivityItem设置进lifeCycle的请求中。让我们跟踪一下源码scheduleTransaction。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ClientLifecycleManager.java" target="_blank" rel="noopener">ClientLifecycleManager.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>ClientTransaction transaction<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> IApplicationThread client <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transaction<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>client <span class="token keyword">instanceof</span> <span class="token class-name">Binder</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            transaction<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/servertransaction/" target="_blank" rel="noopener">servertransaction</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/servertransaction/ClientTransaction.java" target="_blank" rel="noopener">ClientTransaction.java</a></p>
<pre><code>    public void schedule() throws RemoteException {
        mClient.scheduleTransaction(this);
    }</code></pre><p>我们看到此时将会获取IApplicationThread对象，而这个IApplicationThread是一个Binder的存根对象。实现它的ActivityThread的内部类，ApplicationThread。而从上面的UML图，能看到ClientTransaction实现了Parcel，因此能做到跨进程传送该对象。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationThread</span> <span class="token keyword">extends</span> <span class="token class-name">IApplicationThread<span class="token punctuation">.</span>Stub</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可以清楚的知道此时ApplicationThread是一个本地Binder对象。到了AMS中这个接口就象征着远程代理对象。换句话说，此时会调用App端的scheduleTransaction方法。</p>
<p>实际上在Android高版本中</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ActivityThread将会继承ClientTransactionHandler。就会在基类中处理事件。此时首先会到ApplicationThread中的方法：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ActivityThread.java" target="_blank" rel="noopener">ActivityThread.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>ClientTransaction transaction<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
            ActivityThread<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时我们能看到父类还是通过handler mH处理该方法：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>ClientTransaction transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        transaction<span class="token punctuation">.</span><span class="token function">preExecute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>H<span class="token punctuation">.</span>EXECUTE_TRANSACTION<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在mH的handlerMessage中专门处理这个片段</p>
<pre class="line-numbers language-java"><code class="language-java">                <span class="token keyword">case</span> EXECUTE_TRANSACTION<span class="token operator">:</span>
                    <span class="token keyword">final</span> ClientTransaction transaction <span class="token operator">=</span> <span class="token punctuation">(</span>ClientTransaction<span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                    mTransactionExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        transaction<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="TransactionExecutor"><a href="#TransactionExecutor" class="headerlink" title="TransactionExecutor"></a>TransactionExecutor</h2><p>此时，App端将会把启动Activity的事务交给TransactionExecutor处理。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/servertransaction/" target="_blank" rel="noopener">servertransaction</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java" target="_blank" rel="noopener">TransactionExecutor.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>ClientTransaction transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> IBinder token <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getActivityToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">executeCallbacks</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">executeLifecycleState</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPendingActions<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里分为两步：</p>
<ul>
<li>1.首先处理传递过来的ClientTransaction中的callback</li>
<li>2.接着处理ClientTransaction中的LifecycleStateRequest。</li>
</ul>
<p>代入当前情景，就是先处理LaunchActivityItem接着处理ResumeActivityItem。也就对应着onCreate以及onResume。实际上这个过程中，google工程师把每一个状态又分为两个步骤去执行，一个是execute，之后会执行postExecute。</p>
<p>我们分别看看这两个步骤分别完成了什么：</p>
<h3 id="executeCallbacks处理LaunchActivityItem"><a href="#executeCallbacks处理LaunchActivityItem" class="headerlink" title="executeCallbacks处理LaunchActivityItem"></a>executeCallbacks处理LaunchActivityItem</h3><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeCallbacks</span><span class="token punctuation">(</span>ClientTransaction transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>ClientTransactionItem<span class="token operator">></span> callbacks <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> IBinder token <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getActivityToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ActivityClientRecord r <span class="token operator">=</span> mTransactionHandler<span class="token punctuation">.</span><span class="token function">getActivityClient</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> ActivityLifecycleItem finalStateRequest <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getLifecycleStateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> finalState <span class="token operator">=</span> finalStateRequest <span class="token operator">!=</span> null <span class="token operator">?</span> finalStateRequest<span class="token punctuation">.</span><span class="token function">getTargetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> UNDEFINED<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Index of the last callback that requests some post-execution state.</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> lastCallbackRequestingState <span class="token operator">=</span> <span class="token function">lastCallbackRequestingState</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ClientTransactionItem item <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            item<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token punctuation">.</span><span class="token function">postExecute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="LaunchActivityItem-跨进程通信到ActivityThread"><a href="#LaunchActivityItem-跨进程通信到ActivityThread" class="headerlink" title="LaunchActivityItem 跨进程通信到ActivityThread"></a>LaunchActivityItem 跨进程通信到ActivityThread</h3><p>可以看到是，循环处理添加进去的callback，由于此时只有一个对象LaunchActivityItem，会先后执行execute,以及postExecute。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/servertransaction/" target="_blank" rel="noopener">servertransaction</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/servertransaction/LaunchActivityItem.java" target="_blank" rel="noopener">LaunchActivityItem.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>ClientTransactionHandler client<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span>
            PendingTransactionActions pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ActivityClientRecord r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityClientRecord</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> mIntent<span class="token punctuation">,</span> mIdent<span class="token punctuation">,</span> mInfo<span class="token punctuation">,</span>
                mOverrideConfig<span class="token punctuation">,</span> mCompatInfo<span class="token punctuation">,</span> mReferrer<span class="token punctuation">,</span> mVoiceInteractor<span class="token punctuation">,</span> mState<span class="token punctuation">,</span> mPersistentState<span class="token punctuation">,</span>
                mPendingResults<span class="token punctuation">,</span> mPendingNewIntents<span class="token punctuation">,</span> mIsForward<span class="token punctuation">,</span>
                mProfilerInfo<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> pendingActions<span class="token punctuation">,</span> null <span class="token comment" spellcheck="true">/* customIntent */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时的流程就和Android7.0的源码流程十分相似，client是指ActivityThread，生成一个AMS的ActivityRecord对应的ActivityClientRecord，调用handleLaunchActivity去调用onCreate方法。</p>
<p>到这里，就是我们十分熟悉的handleLaunchActivity方法了，实在不想说了。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> Activity <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span>ActivityClientRecord r<span class="token punctuation">,</span> Intent customIntent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ActivityInfo aInfo <span class="token operator">=</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        ContextImpl appContext <span class="token operator">=</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Activity activity <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader cl <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>
                    cl<span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Application app <span class="token operator">=</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                activity<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>ident<span class="token punctuation">,</span> app<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> title<span class="token punctuation">,</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>embeddedID<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastNonConfigurationInstances<span class="token punctuation">,</span> config<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span> r<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> window<span class="token punctuation">,</span> r<span class="token punctuation">.</span>configCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                activity<span class="token punctuation">.</span>mCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPersistable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">,</span> r<span class="token punctuation">.</span>persistentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activity<span class="token punctuation">.</span>mCalled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SuperNotCalledException</span><span class="token punctuation">(</span>
                        <span class="token string">"Activity "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token string">" did not call through to super.onCreate()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                r<span class="token punctuation">.</span>activity <span class="token operator">=</span> activity<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>ON_CREATE<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mActivities<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>token<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SuperNotCalledException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> activity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里有三个步骤：</p>
<ul>
<li><ol>
<li>反射生成Activity实例</li>
</ol>
</li>
<li>2.获取当前的应用的Application对象并且调用attach绑定</li>
<li>3.最后通过Instrument调用callActivityOnCreate调用到Activity实例中的onCreate方法。</li>
</ul>
<p>回到LaunchActivityItem，LaunchActivityItem的postExecute没有实现任何的事件，让我们看看TransactionExecutor的executeLifecycleState。</p>
<h2 id="TransactionExecutor-executeLifecycleState控制onResume生命周期"><a href="#TransactionExecutor-executeLifecycleState控制onResume生命周期" class="headerlink" title="TransactionExecutor executeLifecycleState控制onResume生命周期"></a>TransactionExecutor executeLifecycleState控制onResume生命周期</h2><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">executeLifecycleState</span><span class="token punctuation">(</span>ClientTransaction transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> ActivityLifecycleItem lifecycleItem <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getLifecycleStateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lifecycleItem <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> IBinder token <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getActivityToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ActivityClientRecord r <span class="token operator">=</span> mTransactionHandler<span class="token punctuation">.</span><span class="token function">getActivityClient</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">cycleToPath</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> lifecycleItem<span class="token punctuation">.</span><span class="token function">getTargetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* excludeLastState */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lifecycleItem<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lifecycleItem<span class="token punctuation">.</span><span class="token function">postExecute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时调用getLifecycleStateRequest获取的正是之前设置进去的ResumeActivityItem。其思路和LaunchActivityItem十分相似，也是分两步执行，先执行execute，再执行postExecute。</p>
<h2 id="调用onStart"><a href="#调用onStart" class="headerlink" title="调用onStart"></a>调用onStart</h2><p>但是请注意这个cycleToPath.</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cycleToPath</span><span class="token punctuation">(</span>ActivityClientRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> finish<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> excludeLastState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> start <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getLifecycleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> IntArray path <span class="token operator">=</span> mHelper<span class="token punctuation">.</span><span class="token function">getLifecyclePath</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> finish<span class="token punctuation">,</span> excludeLastState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">performLifecycleSequence</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法最后会调用下面这个方法：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/servertransaction/" target="_blank" rel="noopener">servertransaction</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/servertransaction/TransactionExecutorHelper.java" target="_blank" rel="noopener">TransactionExecutorHelper.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> IntArray <span class="token function">getLifecyclePath</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> finish<span class="token punctuation">,</span> <span class="token keyword">boolean</span> excludeLastState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> UNDEFINED <span class="token operator">||</span> finish <span class="token operator">==</span> UNDEFINED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Can't resolve lifecycle path for undefined state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> ON_RESTART <span class="token operator">||</span> finish <span class="token operator">==</span> ON_RESTART<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                    <span class="token string">"Can't start or finish in intermittent RESTART state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>finish <span class="token operator">==</span> PRE_ON_CREATE <span class="token operator">&amp;&amp;</span> start <span class="token operator">!=</span> finish<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Can only start in pre-onCreate state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mLifecycleSequence<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>finish <span class="token operator">>=</span> start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// just go there</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> finish<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLifecycleSequence<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// finish &lt; start, can't just cycle down</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> ON_PAUSE <span class="token operator">&amp;&amp;</span> finish <span class="token operator">==</span> ON_RESUME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;=</span> ON_STOP <span class="token operator">&amp;&amp;</span> finish <span class="token operator">>=</span> ON_START<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> mLifecycleSequence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时的start是ON_CREATE，finish是ON_RESUME,因此此时会为mLifecycleSequence添加一个中间值ON_START方法。</p>
<p>此时performLifecycleSequence，将会执行ActivityThread中的handleStartActivity方法。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleStartActivity</span><span class="token punctuation">(</span>ActivityClientRecord r<span class="token punctuation">,</span>
            PendingTransactionActions pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> Activity activity <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// TODO(lifecycler): What do we do in this case?</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>stopped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Can't start activity that is not stopped."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// TODO(lifecycler): How can this happen?</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Start</span>
        activity<span class="token punctuation">.</span><span class="token function">performStart</span><span class="token punctuation">(</span><span class="token string">"handleStartActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>ON_START<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingActions <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// No more work to do.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Restore instance state</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingActions<span class="token punctuation">.</span><span class="token function">shouldRestoreInstanceState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPersistable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> null <span class="token operator">||</span> r<span class="token punctuation">.</span>persistentState <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnRestoreInstanceState</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
                            r<span class="token punctuation">.</span>persistentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnRestoreInstanceState</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时将调用Activity的performStart方法。该方法将会调用Fragment的onStart以及通过Instrument调用onStart方法。</p>
<h3 id="ResumeActivityItem-execute"><a href="#ResumeActivityItem-execute" class="headerlink" title="ResumeActivityItem execute"></a>ResumeActivityItem execute</h3><pre class="line-numbers language-java"><code class="language-java"> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>ClientTransactionHandler client<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span>
            PendingTransactionActions pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">handleResumeActivity</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* finalStateRequest */</span><span class="token punctuation">,</span> mIsForward<span class="token punctuation">,</span>
                <span class="token string">"RESUME_ACTIVITY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时就转移到了ActivityThread的handleResumeActivity方法中，而这个方法又调用了performResumeActivity</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> ActivityClientRecord <span class="token function">performResumeActivity</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finalStateRequest<span class="token punctuation">,</span>
            String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> ActivityClientRecord r <span class="token operator">=</span> mActivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">onStateNotSaved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFragments<span class="token punctuation">.</span><span class="token function">noteStateNotSaved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkAndBlockForNetworkAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>pendingIntents <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">deliverNewIntents</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>pendingIntents<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>pendingIntents <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>pendingResults <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">deliverResults</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>pendingResults<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>pendingResults <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">performResume</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>startsNotResumed<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

            r<span class="token punctuation">.</span>state <span class="token operator">=</span> null<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>persistentState <span class="token operator">=</span> null<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>ON_RESUME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我能看到如果pendingIntent的数据不为空则发送一个pendingIntent数据回到onActivityResult，接着调用Activity的onResume方法。</p>
<h3 id="ResumeActivityItem的postExecute"><a href="#ResumeActivityItem的postExecute" class="headerlink" title="ResumeActivityItem的postExecute"></a>ResumeActivityItem的postExecute</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postExecute</span><span class="token punctuation">(</span>ClientTransactionHandler client<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span>
            PendingTransactionActions pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// TODO(lifecycler): Use interface callback instead of AMS.</span>
            ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activityResumed</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时service是指ActivityManagerService。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">activityResumed</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ActivityRecord<span class="token punctuation">.</span><span class="token function">activityResumedLocked</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mWindowManager<span class="token punctuation">.</span><span class="token function">notifyAppResumedFinished</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到的是，此时把ActivityRecord中状态设置为resume状态，把对应的windowManager设置成resume完成状态。</p>
<p>这样子就完成了Activity的onResume方法。还记得我上面写的PauseActivityItem吗？此时代表着pause的生命周期，接下来我们探索一下onPause的流程。</p>
<h3 id="PauseActivityItem-处理execute"><a href="#PauseActivityItem-处理execute" class="headerlink" title="PauseActivityItem 处理execute"></a>PauseActivityItem 处理execute</h3><p>回顾一下上面的代码段：</p>
<pre class="line-numbers language-java"><code class="language-java"> mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">,</span> prev<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span>
                        PauseActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>finishing<span class="token punctuation">,</span> userLeaving<span class="token punctuation">,</span>
                                prev<span class="token punctuation">.</span>configChangeFlags<span class="token punctuation">,</span> pauseImmediately<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>当我们执行启动一个新的Activity时候，将会借助TransactionLifecycleManager其启动跨进程通信，那么原理和上面一致，我们可以直接到PauseActivityItem的execute方法中。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>ClientTransactionHandler client<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span>
            PendingTransactionActions pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">handlePauseActivity</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> mFinished<span class="token punctuation">,</span> mUserLeaving<span class="token punctuation">,</span> mConfigChanges<span class="token punctuation">,</span> pendingActions<span class="token punctuation">,</span>
                <span class="token string">"PAUSE_ACTIVITY_ITEM"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时将会到达Activity的onPause方法。handlePauseActivity最终会达到performPauseActivity</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> Bundle <span class="token function">performPauseActivity</span><span class="token punctuation">(</span>ActivityClientRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finished<span class="token punctuation">,</span> String reason<span class="token punctuation">,</span>
            PendingTransactionActions pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>paused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>finished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> shouldSaveState <span class="token operator">=</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span><span class="token function">isPreHoneycomb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldSaveState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callActivityOnSaveInstanceState</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">performPauseActivityIfNeeded</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ArrayList<span class="token operator">&lt;</span>OnActivityPausedListener<span class="token operator">></span> listeners<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mOnPauseListeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            listeners <span class="token operator">=</span> mOnPauseListeners<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token punctuation">(</span>listeners <span class="token operator">!=</span> null <span class="token operator">?</span> listeners<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onPaused</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> Bundle oldState <span class="token operator">=</span> pendingActions <span class="token operator">!=</span> null <span class="token operator">?</span> pendingActions<span class="token punctuation">.</span><span class="token function">getOldState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldState <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPreHoneycomb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>state <span class="token operator">=</span> oldState<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> shouldSaveState <span class="token operator">?</span> r<span class="token punctuation">.</span>state <span class="token operator">:</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到的是，如果此时需要保存当前的状态，将会在onPause中save起来。并且唤醒那些在监听onPause事件的接口。通过performPauseActivityIfNeeded会调到Activity中。并且通知Fragment中所有状态设置为onPause状态。</p>
<h3 id="PauseActivityItem-处理postExecute"><a href="#PauseActivityItem-处理postExecute" class="headerlink" title="PauseActivityItem 处理postExecute"></a>PauseActivityItem 处理postExecute</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postExecute</span><span class="token punctuation">(</span>ClientTransactionHandler client<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span>
            PendingTransactionActions pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDontReport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activityPaused</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到的是此时会回调到AMS中的activityPaused，并且通知ActivityStack调用activityPausedLocked。提一句这个token是IApplicationToken.Stub用来唯一标示对应的ActivityRecord，并且通知对应的WindowManager做后续的处理。</p>
<h3 id="调用完onPause，通知AMS调用onStop方法。"><a href="#调用完onPause，通知AMS调用onStop方法。" class="headerlink" title="调用完onPause，通知AMS调用onStop方法。"></a>调用完onPause，通知AMS调用onStop方法。</h3><p>在这个activityPaused方法中，当执行完pause方法之后会执行completePauseLocked方法，执行onStop的一个步骤，之后将会调用Activity的onStop方法。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">completePauseLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> resumeNext<span class="token punctuation">,</span> ActivityRecord resuming<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ActivityRecord prev <span class="token operator">=</span> mPausingActivity<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            prev<span class="token punctuation">.</span><span class="token function">setWillCloseOrEnterPip</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> wasStopping <span class="token operator">=</span> prev<span class="token punctuation">.</span><span class="token function">isState</span><span class="token punctuation">(</span>STOPPING<span class="token punctuation">)</span><span class="token punctuation">;</span>
            prev<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>PAUSED<span class="token punctuation">,</span> <span class="token string">"completePausedLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                prev <span class="token operator">=</span> <span class="token function">finishCurrentActivityLocked</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> FINISH_AFTER_VISIBLE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token string">"completedPausedLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span>mActivitiesWaitingForVisibleActivity<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>deferRelaunchUntilPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    prev<span class="token punctuation">.</span><span class="token function">relaunchActivityLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* andResume */</span><span class="token punctuation">,</span>
                            prev<span class="token punctuation">.</span>preserveWindowOnDeferredRelaunch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>wasStopping<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    prev<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>STOPPING<span class="token punctuation">,</span> <span class="token string">"completePausedLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prev<span class="token punctuation">.</span>visible <span class="token operator">||</span> <span class="token function">shouldSleepOrShutDownActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    prev<span class="token punctuation">.</span><span class="token function">setDeferHidingClient</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">addToStopping</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* scheduleIdle */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* idleDelayed */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                prev <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们能看到的是，此时一旦判断当前ActivityRecord已经绑定了App端的数据，说明已经启动了，并且当前的ActivityRecord的visible为false，或者点击了锁屏使其睡眠，都会调用addToStopping，把当前的ActivityRecord设置为onStop。具体表现上就是当Activity默认不是window透明的时候，这个标志就会为false。场景经常在Activity的Dialog中。</p>
<p>在addToStopping中，将会透过ActivityStackSupervisorHandler 这个Handler处理onStop方法。</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">final</span> ActivityRecord <span class="token function">activityIdleInternalLocked</span><span class="token punctuation">(</span><span class="token keyword">final</span> IBinder token<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fromTimeout<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> processPausingActivities<span class="token punctuation">,</span> Configuration config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_ALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Activity idle: "</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ArrayList<span class="token operator">&lt;</span>ActivityRecord<span class="token operator">></span> finishes <span class="token operator">=</span> null<span class="token punctuation">;</span>
        ArrayList<span class="token operator">&lt;</span>UserState<span class="token operator">></span> startingUsers <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">int</span> NS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> NF <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> booting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> activityRemoved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        ActivityRecord r <span class="token operator">=</span> ActivityRecord<span class="token punctuation">.</span><span class="token function">forTokenLocked</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r <span class="token operator">=</span> stops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    stack<span class="token punctuation">.</span><span class="token function">finishCurrentActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ActivityStack<span class="token punctuation">.</span>FINISH_IMMEDIATELY<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token string">"activityIdleInternalLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    stack<span class="token punctuation">.</span><span class="token function">stopActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在ActivityStack中将会跨进程调用onStop</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">stopActivityLocked</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">adjustFocusedActivityStack</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"stopActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span><span class="token function">resumeKeyDispatchingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>stopped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>STOPPING<span class="token punctuation">,</span> <span class="token string">"stopActivityLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>visible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span>
                        StopActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>visible<span class="token punctuation">,</span> r<span class="token punctuation">.</span>configChangeFlags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSleepOrShutDownActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span><span class="token function">setSleeping</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>STOP_TIMEOUT_MSG<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> STOP_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                r<span class="token punctuation">.</span>stopped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span> <span class="token string">"Stop failed; moving to STOPPED: "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>STOPPED<span class="token punctuation">,</span> <span class="token string">"stopActivityLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>deferRelaunchUntilPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">destroyActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"stop-except"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里面我再一次看到了核心的生命周期的类StopActivityItem。我们看看其execute以及postExecute方法。</p>
<h2 id="StopActivityItem的execute"><a href="#StopActivityItem的execute" class="headerlink" title="StopActivityItem的execute"></a>StopActivityItem的execute</h2><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>ClientTransactionHandler client<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span>
            PendingTransactionActions pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">handleStopActivity</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> mShowWindow<span class="token punctuation">,</span> mConfigChanges<span class="token punctuation">,</span> pendingActions<span class="token punctuation">,</span>
                <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* finalStateRequest */</span><span class="token punctuation">,</span> <span class="token string">"STOP_ACTIVITY_ITEM"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到的是，此时将会执行ActivityThread的handleStopActivity，而它会调用如下方法:</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performStopActivityInner</span><span class="token punctuation">(</span>ActivityClientRecord r<span class="token punctuation">,</span> StopInfo info<span class="token punctuation">,</span> <span class="token keyword">boolean</span> keepShown<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> saveState<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finalStateRequest<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keepShown <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>stopped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>finalStateRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token function">performPauseActivityIfNeeded</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>info <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    info<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">onCreateDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                                <span class="token string">"Unable to save state of activity "</span>
                                <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keepShown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">callActivityOnStop</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> saveState<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当没有进行onPause的时候，将会先惊醒onPause方法，接着再调用，callActivityOnStop调用performStop，调用所有Fragment的onStop以及设置WindowManagerGlobal的状态为暂停。最后通过Instrument调用Activity的onStop方法。</p>
<h2 id="当调用Activity的finish"><a href="#当调用Activity的finish" class="headerlink" title="当调用Activity的finish"></a>当调用Activity的finish</h2><p>很常见的一个情况，就是当Activity调用finish的时候，将会最终会调用onDestory的生命周期，让我们稍微探索源码。</p>
<p>当开发者调用finish的方法最终会调用到AMS中finishActivity方法</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">finishActivity</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> Intent resultData<span class="token punctuation">,</span>
            <span class="token keyword">int</span> finishTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ActivityRecord r <span class="token operator">=</span> ActivityRecord<span class="token punctuation">.</span><span class="token function">isInStackLocked</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            TaskRecord tr <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ActivityRecord rootR <span class="token operator">=</span> tr<span class="token punctuation">.</span><span class="token function">getRootActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> res<span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> finishWithRootActivity <span class="token operator">=</span>
                        finishTask <span class="token operator">==</span> Activity<span class="token punctuation">.</span>FINISH_TASK_WITH_ROOT_ACTIVITY<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>finishTask <span class="token operator">==</span> Activity<span class="token punctuation">.</span>FINISH_TASK_WITH_ACTIVITY
                        <span class="token operator">||</span> <span class="token punctuation">(</span>finishWithRootActivity <span class="token operator">&amp;&amp;</span> r <span class="token operator">==</span> rootR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    res <span class="token operator">=</span> tr<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestFinishActivityLocked</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span>
                            resultData<span class="token punctuation">,</span> <span class="token string">"app-request"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> res<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时我们的finishtask一般不是FINISH_TASK_WITH_ACTIVITY，因此一般会走到下面的分支。此时将会拿到当前taskRecord对应的ActivityStack，开始调用requestFinishActivityLocked。</p>
<p>在requestFinishActivityLocked会通过token(上文介绍的IApplicationToken)找到唯一标示的ActivityRecord。接着调用finishActivityLocked</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">finishActivityLocked</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> Intent resultData<span class="token punctuation">,</span>
            String reason<span class="token punctuation">,</span> <span class="token keyword">boolean</span> oomAdj<span class="token punctuation">,</span> <span class="token keyword">boolean</span> pauseImmediately<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mWindowManager<span class="token punctuation">.</span><span class="token function">deferSurfaceLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">makeFinishingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>ActivityRecord<span class="token operator">></span> activities <span class="token operator">=</span> task<span class="token punctuation">.</span>mActivities<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> activities<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token punctuation">(</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                task<span class="token punctuation">.</span><span class="token function">setFrontOfTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ActivityRecord next <span class="token operator">=</span> activities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    next<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//停止事件的分发</span>
            r<span class="token punctuation">.</span><span class="token function">pauseKeyDispatchingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//调整焦点ActivityStack</span>
            <span class="token function">adjustFocusedActivityStack</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"finishActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">finishActivityResultsLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">boolean</span> endTask <span class="token operator">=</span> index <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>task<span class="token punctuation">.</span><span class="token function">isClearingToReuseTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> transit <span class="token operator">=</span> endTask <span class="token operator">?</span> TRANSIT_TASK_CLOSE <span class="token operator">:</span> TRANSIT_ACTIVITY_CLOSE<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mResumedActivity <span class="token operator">==</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                r<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPausingActivity <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">startPausingLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> pauseImmediately<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>endTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mService<span class="token punctuation">.</span><span class="token function">getLockTaskController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clearLockedTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">isState</span><span class="token punctuation">(</span>PAUSING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> finishMode <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>visible <span class="token operator">||</span> r<span class="token punctuation">.</span>nowVisible<span class="token punctuation">)</span> <span class="token operator">?</span> FINISH_AFTER_VISIBLE
                        <span class="token operator">:</span> FINISH_AFTER_PAUSE<span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> removedActivity <span class="token operator">=</span> <span class="token function">finishCurrentActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> finishMode<span class="token punctuation">,</span> oomAdj<span class="token punctuation">,</span>
                        <span class="token string">"finishActivityLocked"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">;</span>

               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> removedActivity<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            mWindowManager<span class="token punctuation">.</span><span class="token function">continueSurfaceLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从finishActivityLocked方法中，实际上在finish的时候，按照2个情况处理。当</p>
<ul>
<li><p>1.当前要finish的Activity刚好就是当前的正在交互的Activity，则调用onPause，在activityIdleInternalLocked调用onStop过程中，实际上还有这么一段代码段，</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NF<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          r <span class="token operator">=</span> finishes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              activityRemoved <span class="token operator">|=</span> stack<span class="token punctuation">.</span><span class="token function">destroyActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"finish-idle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这里能看到会调用destroyActivityLocked，调用onDestroy方法。</p>
</li>
<li><p>2.当finish的Activity不是onPause，尝试调用finishCurrentActivityLocked，finish对应的Activity。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> ActivityRecord <span class="token function">finishCurrentActivityLocked</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">,</span> <span class="token keyword">boolean</span> oomAdj<span class="token punctuation">,</span>
          String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token keyword">final</span> ActivityRecord next <span class="token operator">=</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span>
              <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* considerKeyguardState */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> FINISH_AFTER_VISIBLE <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>visible <span class="token operator">||</span> r<span class="token punctuation">.</span>nowVisible<span class="token punctuation">)</span>
              <span class="token operator">&amp;&amp;</span> next <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>next<span class="token punctuation">.</span>nowVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mStackSupervisor<span class="token punctuation">.</span>mStoppingActivities<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">addToStopping</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* scheduleIdle */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* idleDelayed */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span>
                  <span class="token string">"Moving to STOPPING: "</span><span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">" (finish requested)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>STOPPING<span class="token punctuation">,</span> <span class="token string">"finishCurrentActivityLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>oomAdj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> r<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// make sure the record is cleaned out of other places.</span>
      mStackSupervisor<span class="token punctuation">.</span>mStoppingActivities<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mStackSupervisor<span class="token punctuation">.</span>mGoingToSleepActivities<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mStackSupervisor<span class="token punctuation">.</span>mActivitiesWaitingForVisibleActivity<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> ActivityState prevState <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span> <span class="token string">"Moving to FINISHING: "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

      r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>FINISHING<span class="token punctuation">,</span> <span class="token string">"finishCurrentActivityLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">boolean</span> finishingActivityInNonFocusedStack
              <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">getFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token operator">&amp;&amp;</span> prevState <span class="token operator">==</span> PAUSED <span class="token operator">&amp;&amp;</span> mode <span class="token operator">==</span> FINISH_AFTER_VISIBLE<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> FINISH_IMMEDIATELY
              <span class="token operator">||</span> <span class="token punctuation">(</span>prevState <span class="token operator">==</span> PAUSED
                  <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> FINISH_AFTER_PAUSE <span class="token operator">||</span> <span class="token function">inPinnedWindowingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token operator">||</span> finishingActivityInNonFocusedStack
              <span class="token operator">||</span> prevState <span class="token operator">==</span> STOPPING
              <span class="token operator">||</span> prevState <span class="token operator">==</span> STOPPED
              <span class="token operator">||</span> prevState <span class="token operator">==</span> ActivityState<span class="token punctuation">.</span>INITIALIZING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          r<span class="token punctuation">.</span><span class="token function">makeFinishingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">boolean</span> activityRemoved <span class="token operator">=</span> <span class="token function">destroyActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"finish-imm:"</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token keyword">return</span> activityRemoved <span class="token operator">?</span> null <span class="token operator">:</span> r<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> r<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>能看到，此时将会尝试的调用addToStopping，会调到onStop方法，接着也会调用destroyActivityLocked，进行finish的核心操作。</p>
<h3 id="destroyActivityLocked"><a href="#destroyActivityLocked" class="headerlink" title="destroyActivityLocked"></a>destroyActivityLocked</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">destroyActivityLocked</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> removeFromApp<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isState</span><span class="token punctuation">(</span>DESTROYING<span class="token punctuation">,</span> DESTROYED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        EventLog<span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span>EventLogTags<span class="token punctuation">.</span>AM_DESTROY_ACTIVITY<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span>
                r<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>taskId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>shortComponentName<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> removedFromHistory <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token function">cleanUpActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hadApp <span class="token operator">=</span> r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>hadApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>removeFromApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mHeavyWeightProcess <span class="token operator">==</span> r<span class="token punctuation">.</span>app <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mService<span class="token punctuation">.</span>mHeavyWeightProcess <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    mService<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>
                            ActivityManagerService<span class="token punctuation">.</span>CANCEL_HEAVY_NOTIFICATION_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    mService<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> skipDestroy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span>
                        DestroyActivityItem<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing<span class="token punctuation">,</span> r<span class="token punctuation">.</span>configChangeFlags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">removeActivityFromHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> reason <span class="token operator">+</span> <span class="token string">" exceptionInScheduleDestroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    removedFromHistory <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    skipDestroy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            r<span class="token punctuation">.</span>nowVisible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skipDestroy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>DESTROYING<span class="token punctuation">,</span>
                        <span class="token string">"destroyActivityLocked. finishing and not skipping destroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>DESTROY_TIMEOUT_MSG<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> DESTROY_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>DESTROYED<span class="token punctuation">,</span>
                        <span class="token string">"destroyActivityLocked. not finishing or skipping destroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                r<span class="token punctuation">.</span>app <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">removeActivityFromHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> reason <span class="token operator">+</span> <span class="token string">" hadNoApp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                removedFromHistory <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>DESTROYED<span class="token punctuation">,</span> <span class="token string">"destroyActivityLocked. not finishing and had no app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                r<span class="token punctuation">.</span>app <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span>configChangeFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> removedFromHistory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我能够看到熟悉DestroyActivityItem这个代表着调用Activity的onResume的类。通过这个类做完跨进程通信之后，调用removeActivityFromHistoryLocked，清除TaskRecord中ActivityRecord，清除ActivityRecord中的Window对象，ProcessRecord等对象。</p>
<p>这里一样看看DestroyActivityItem的execute方法。</p>
<h3 id="DestroyActivityItem-execute"><a href="#DestroyActivityItem-execute" class="headerlink" title="DestroyActivityItem execute"></a>DestroyActivityItem execute</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>ClientTransactionHandler client<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span>
            PendingTransactionActions pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">handleDestroyActivity</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> mFinished<span class="token punctuation">,</span> mConfigChanges<span class="token punctuation">,</span>
                <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* getNonConfigInstance */</span><span class="token punctuation">,</span> <span class="token string">"DestroyActivityItem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时将调用ActivityThread的handleDestroyActivity。</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDestroyActivity</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finishing<span class="token punctuation">,</span> <span class="token keyword">int</span> configChanges<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> getNonConfigInstance<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ActivityClientRecord r <span class="token operator">=</span> <span class="token function">performDestroyActivity</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> finishing<span class="token punctuation">,</span>
                configChanges<span class="token punctuation">,</span> getNonConfigInstance<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">cleanUpPendingRemoveWindows</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> finishing<span class="token punctuation">)</span><span class="token punctuation">;</span>
            WindowManager wm <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">getWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            View v <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mDecor<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mVisibleFromServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mNumVisibleActivities<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                IBinder wtoken <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">getWindowToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mWindowAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>mPreserveWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        r<span class="token punctuation">.</span>mPendingRemoveWindow <span class="token operator">=</span> r<span class="token punctuation">.</span>window<span class="token punctuation">;</span>
                        r<span class="token punctuation">.</span>mPendingRemoveWindowManager <span class="token operator">=</span> wm<span class="token punctuation">;</span>
                        r<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">clearContentView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        wm<span class="token punctuation">.</span><span class="token function">removeViewImmediate</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>wtoken <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>mPendingRemoveWindow <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    WindowManagerGlobal<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeAll</span><span class="token punctuation">(</span>wtoken<span class="token punctuation">,</span>
                            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>mPendingRemoveWindow <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    WindowManagerGlobal<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeAllExceptView</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> v<span class="token punctuation">,</span>
                            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mDecor <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>mPendingRemoveWindow <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                WindowManagerGlobal<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeAll</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            Context c <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token keyword">instanceof</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>ContextImpl<span class="token punctuation">)</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleFinalCleanup</span><span class="token punctuation">(</span>
                        r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activityDestroyed</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mSomeActivitiesChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到当我们通过performDestroyActivity调用Activity的OnDestroy之后，将会清空Activity中设置的window数据以及设置的ContentView，最后通过activityDestroyed通知AMS。</p>
<p>最后通信到AMS中，发送一个Handler消息，10秒后把ActivityRecord从TaskRecord 中移除，如果此时TaskRecord已经不存在ActivityRecord，则从ActivityStack移除。</p>
<h4 id="performDestroyActivity"><a href="#performDestroyActivity" class="headerlink" title="performDestroyActivity"></a>performDestroyActivity</h4><pre class="line-numbers language-java"><code class="language-java">  ActivityClientRecord <span class="token function">performDestroyActivity</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finishing<span class="token punctuation">,</span>
            <span class="token keyword">int</span> configChanges<span class="token punctuation">,</span> <span class="token keyword">boolean</span> getNonConfigInstance<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ActivityClientRecord r <span class="token operator">=</span> mActivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span><span class="token operator">></span> activityClass <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Performing finish of "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            activityClass <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mConfigChangeFlags <span class="token operator">|=</span> configChanges<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">performPauseActivityIfNeeded</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"destroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>stopped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">callActivityOnStop</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* saveState */</span><span class="token punctuation">,</span> <span class="token string">"destroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>getNonConfigInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span>lastNonConfigurationInstances
                            <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">retainNonConfigurationInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                                <span class="token string">"Unable to retain activity "</span>
                                <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnDestroy</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mCalled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SuperNotCalledException</span><span class="token punctuation">(</span>
                        <span class="token string">"Activity "</span> <span class="token operator">+</span> <span class="token function">safeToComponentShortString</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token string">" did not call through to super.onDestroy()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>window <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">closeAllPanels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SuperNotCalledException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                            <span class="token string">"Unable to destroy activity "</span> <span class="token operator">+</span> <span class="token function">safeToComponentShortString</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>ON_DESTROY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mActivities<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        StrictMode<span class="token punctuation">.</span><span class="token function">decrementExpectedActivityCount</span><span class="token punctuation">(</span>activityClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到的是，此时当没有调用过onPause以及onStop将会调用一次，但是实际上这种情况不可能出现，都在上面的对应的PauseActivityItem以及StopActivityItem中调用过一次了。最后通Instrument调用callActivityOnDestroy，回调到Activity的performDestroy，最后关闭Activity的键盘，清空在ActivityThread的缓存。</p>
<p>在performDestroy调用Fragment的onDestroy，以及回调Activity的onDestroy。</p>
<p>这样就完成Activity的onDestroy流程。</p>
<h4 id="onRestart"><a href="#onRestart" class="headerlink" title="onRestart"></a>onRestart</h4><p>肯定有人觉得奇怪，七大声明周期之一的onRestart呢？他其实和onStart一样隐藏在TransactionExecutor 中。<br>来看看/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/servertransaction/" target="_blank" rel="noopener">servertransaction</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/servertransaction/TransactionExecutorHelper.java" target="_blank" rel="noopener">TransactionExecutorHelper.java</a><br>：</p>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">public</span> IntArray <span class="token function">getLifecyclePath</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> finish<span class="token punctuation">,</span> <span class="token keyword">boolean</span> excludeLastState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> UNDEFINED <span class="token operator">||</span> finish <span class="token operator">==</span> UNDEFINED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Can't resolve lifecycle path for undefined state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> ON_RESTART <span class="token operator">||</span> finish <span class="token operator">==</span> ON_RESTART<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                    <span class="token string">"Can't start or finish in intermittent RESTART state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>finish <span class="token operator">==</span> PRE_ON_CREATE <span class="token operator">&amp;&amp;</span> start <span class="token operator">!=</span> finish<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Can only start in pre-onCreate state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mLifecycleSequence<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>finish <span class="token operator">>=</span> start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// just go there</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// finish &lt; start, can't just cycle down</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> ON_PAUSE <span class="token operator">&amp;&amp;</span> finish <span class="token operator">==</span> ON_RESUME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Special case when we can just directly go to resumed state.</span>
                mLifecycleSequence<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ON_RESUME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;=</span> ON_STOP <span class="token operator">&amp;&amp;</span> finish <span class="token operator">>=</span> ON_START<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Restart and go to required state.</span>

                <span class="token comment" spellcheck="true">// Go to stopped state first.</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> ON_STOP<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mLifecycleSequence<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// Restart</span>
                mLifecycleSequence<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ON_RESTART<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Go to required state</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> ON_START<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> finish<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mLifecycleSequence<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Relaunch and go to required state</span>

                <span class="token comment" spellcheck="true">// Go to destroyed state first.</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> ON_DESTROY<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mLifecycleSequence<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// Go to required state</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> ON_CREATE<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> finish<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mLifecycleSequence<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> mLifecycleSequence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意这里的参数start是指当前Activity的状态，finish是指经过TransactionExecutor执行后，每一个<code>ActivityLifecycleItem</code>对应的目标Activity需要达到什么声明周期。</p>
<ul>
<li><p>1.如果当前的Activity是<code>ON_PAUSE</code>状态，目标是<code>ON_RESUME</code>，此时只需要执行一个<code>ON_RESUME</code></p>
</li>
<li><p>2.如果此时的状态是<code>ON_STOP</code>之后的状态，且目标是<code>ON_START</code>.一般来说此时都是执行的是<code>ResumeActivityItem</code> 需要从AMS让此时的Activity转化为可见。此时的<code>Activity</code>已经执行了onStop，就会把小于<code>ON_STOP</code>的状态添加进来(没有就跳过了),再把<code>ON_RESTART</code>声明周期添加进来，最后把<code>onStart</code>和<code>onResume</code>(因为<code>ResumeActivityItem</code> 目标就是<code>onResume</code>)添加进来</p>
</li>
<li><p>3.最后到达了TransactionExecutor中执行每一个<code>ActivityLifecycleItem</code>的生命周期，从而执行了ActivityThread的<code>onRestart</code>后执行，<code>onStart</code>,<code>onResume</code></p>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文着重说了Activity的生命周期的流程，所有的生命周期流程，就不是直接通过Binder跨进程通信，而是每一个需要通行都Activity处理的事务都抽象成了一个ClientTransactionItem处理，并且交由ClientTransaction统一分发处理。每一个ClientTransactionItem，都会把执行分为两步，execute以及postExecute。</p>
<p>可以说，Android对Activity的生命周期的思考从来没有停过，通过抽象以及实现Parcel灵活的实现了生命周期状态机的管理。</p>
<p>阅读了本文之后，就能知道我之前写的插件化，没有办法直接hook Android O的系统，因为在插件话基础模型中，有一个关键的步骤，就是hook ActivityThread的mH中的handlermessage方法。然而此时mH将不处理生命周期，因此会出现没办法偷梁换柱的情况的。但是处理的方式十分简单，就是hook handlerMessage中的处理事务的信号即可。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/11/18/android-chong-xue-xi-lie-handler-yu-xiang-guan-xi-tong-diao-yong-de-pou-xi-shang/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="Android 重学系列 Handler与相关系统调用的剖析(上)">
                        
                        <span class="card-title">Android 重学系列 Handler与相关系统调用的剖析(上)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言经过之前系列的文章，总结了View是如何实例化，又是怎么查找资源。接下来就是弄清楚整个Android是如何把View渲染到屏幕上。不过在这之前，需要剖析一遍Handler的源码。因为在整个Android系统中，Handler贯穿整个应用
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-11-18
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Linux-kernel/" class="post-category">
                                    Linux kernel
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Linux/">
                        <span class="chip bg-color">Linux</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/11/05/kai-pian-yu-dao-du/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="开篇与导读">
                        
                        <span class="card-title">开篇与导读</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            序我本来还没有想着做一个属于我的博客网站，一个是认为自己写的东西本来就比较小众没什么人看，放在自己的博库里面孤芳自赏确实没什么意思，违背了原本我写博客的初衷。我原本的初衷是希望记录自己所学的同时，能够帮助那些希望理解原理，却苦于无法各种原因
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-11-05
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
