<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 ActivityThread的初始化, Android | Linux | Flutter">
    <meta name="description" content="前言当我们了解了一个进程是怎么诞生的，一个Activity是怎么诞生的，那么在这两个中间必定会存在Application的创建，其实在前面的文章已经和大家提到过关于ActivityThread和Application的初始化，本文就带领大家">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 ActivityThread的初始化 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 ActivityThread的初始化
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android-Framework/" class="post-category">
                                Android Framework
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-11-28
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        7.7k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        35 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>当我们了解了一个进程是怎么诞生的，一个Activity是怎么诞生的，那么在这两个中间必定会存在Application的创建，其实在前面的文章已经和大家提到过关于ActivityThread和Application的初始化，本文就带领大家来看看ActivityThread和Application是如何初始化，又是如何绑定的；应用自己的ClassLoader如何加载；资源R文件如何重载的；以及思考MultiDex的设计思路。</p>
<p>遇到问题可以来本文下讨论：<a href="https://www.jianshu.com/p/2b1d43ffeba6" target="_blank" rel="noopener">https://www.jianshu.com/p/2b1d43ffeba6</a></p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="进程的初始化"><a href="#进程的初始化" class="headerlink" title="进程的初始化"></a>进程的初始化</h2><p>让我么回顾一下，当时<a href="https://www.jianshu.com/p/ac7b6a525b96" target="_blank" rel="noopener">Activity启动流程</a>在一文中，startSpecificActivityLocked检测进程是否启动一小节，我当时忽略了当没有进程时候的情况，本次因为是ActivityThread的初始化，那么必定会先走startProcessLocked先初始化进程。</p>
<pre class="line-numbers language-java"><code class="language-java">        mService<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">"activity"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>最后会走到下面这个方法。</p>
<p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java" target="_blank" rel="noopener">ActivityManagerService.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"this"</span><span class="token punctuation">)</span>
    <span class="token keyword">final</span> ProcessRecord <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>String processName<span class="token punctuation">,</span> ApplicationInfo info<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">int</span> intentFlags<span class="token punctuation">,</span> String hostingType<span class="token punctuation">,</span> ComponentName hostingName<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> allowWhileBooting<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isolated<span class="token punctuation">,</span> <span class="token keyword">int</span> isolatedUid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> keepIfLarge<span class="token punctuation">,</span>
            String abiOverride<span class="token punctuation">,</span> String entryPoint<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> entryPointArgs<span class="token punctuation">,</span> Runnable crashHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ProcessRecord app<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            app <span class="token operator">=</span> <span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> info<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> keepIfLarge<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">"startProcess: after getProcessRecord"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>intentFlags <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_FROM_BACKGROUND<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                mAppErrors<span class="token punctuation">.</span><span class="token function">resetProcessCrashTimeLocked</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppErrors<span class="token punctuation">.</span><span class="token function">isBadProcessLocked</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    mAppErrors<span class="token punctuation">.</span><span class="token function">clearBadProcessLocked</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        app<span class="token punctuation">.</span>bad <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// We don't have to do anything more if:</span>
        <span class="token comment" spellcheck="true">// (1) There is an existing application record; and</span>
        <span class="token comment" spellcheck="true">// (2) The caller doesn't think it is dead, OR there is no thread</span>
        <span class="token comment" spellcheck="true">//     object attached to it so we know it couldn't have crashed; and</span>
        <span class="token comment" spellcheck="true">// (3) There is a pid assigned to it, so it is either starting or</span>
        <span class="token comment" spellcheck="true">//     already running.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>knownToBeDead <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>app<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token operator">||</span> app<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> info<span class="token punctuation">.</span>versionCode<span class="token punctuation">,</span> mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> app<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// An application record is attached to a previous process,</span>
            <span class="token comment" spellcheck="true">// clean it up now.</span>

            <span class="token function">killProcessGroup</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">handleAppDiedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        String hostingNameStr <span class="token operator">=</span> hostingName <span class="token operator">!=</span> null
                <span class="token operator">?</span> hostingName<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            app <span class="token operator">=</span> <span class="token function">newProcessRecordLocked</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> processName<span class="token punctuation">,</span> isolated<span class="token punctuation">,</span> isolatedUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            app<span class="token punctuation">.</span>crashHandler <span class="token operator">=</span> crashHandler<span class="token punctuation">;</span>
            app<span class="token punctuation">.</span>isolatedEntryPoint <span class="token operator">=</span> entryPoint<span class="token punctuation">;</span>
            app<span class="token punctuation">.</span>isolatedEntryPointArgs <span class="token operator">=</span> entryPointArgs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> info<span class="token punctuation">.</span>versionCode<span class="token punctuation">,</span> mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mProcessesReady
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAllowedWhileBooting</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>allowWhileBooting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mProcessesOnHold<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mProcessesOnHold<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> app<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> hostingType<span class="token punctuation">,</span> hostingNameStr<span class="token punctuation">,</span> abiOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> success <span class="token operator">?</span> app <span class="token operator">:</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行启动进程的行为，有如下几种可能：</p>
<ul>
<li>1.本身还没有就没有诞生进程。</li>
<li>2.已经诞生了，但是因为一些crash等问题,或者安装好了一样的进程需要重新启动进程。</li>
</ul>
<p>因此会先通过getProcessRecordLocked获取对应的ProcessRecord。这个对象其实就是AMS中象征着进程的对象。这个对象会保存在一个SparseArray 中，因为刚好是以int型uid作为key存储。</p>
<p>如果找到ProcessRecord，说明已经诞生出来过了。因此为了让进程回归到初始状态，会清空内部的错误栈信息，接着重新从ApplicationInfo读取最新的进程对应的进程版本号等信息，接着杀掉进程组，handleAppDiedLocked处理App的死亡，主要是清空TaskRecord，记录在ActivityStackSupervisor中所有的活跃Activity，销毁对应进程WMS中的Surface。</p>
<p>如果没有找到对应ProcessRecord，则调用newProcessRecordLocked创建一个新的进程对象，并把当前ProcessRecord添加到类型为SparseArray的mProcessMap。</p>
<p>接下来核心是另一个重载函数startProcessLocked。</p>
<h4 id="AMS-startProcessLocked"><a href="#AMS-startProcessLocked" class="headerlink" title="AMS.startProcessLocked"></a>AMS.startProcessLocked</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">,</span> String hostingType<span class="token punctuation">,</span>
            String hostingNameStr<span class="token punctuation">,</span> <span class="token keyword">boolean</span> disableHiddenApiChecks<span class="token punctuation">,</span> String abiOverride<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>pendingStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>pid <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>pid <span class="token operator">!=</span> MY_PID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">"startProcess: removing from pids map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPidsSelfLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>PROC_START_TIMEOUT_MSG<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            app<span class="token punctuation">.</span><span class="token function">setPid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">final</span> String entryPoint <span class="token operator">=</span> <span class="token string">"android.app.ActivityThread"</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>hostingType<span class="token punctuation">,</span> hostingNameStr<span class="token punctuation">,</span> entryPoint<span class="token punctuation">,</span> app<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span>
                    runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span> requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span>
                    startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>中间设置很多准备启动的参数，我们只需要关注剩下这些代码。在这个当中，如果发现ProcessRecord不为空，则会拆调借助Handler实现的ANR为PROC_START_TIMEOUT_MSG的炸弹，不理解没关系，等下就有全部流程。</p>
<p>在设置的众多参数中有一个关键的参数entryPoint，字符串设置为android.app.ActivityThread。这种设计在Flutter也是这样，告诉你hook的类以及方法是什么。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>String hostingType<span class="token punctuation">,</span> String hostingNameStr<span class="token punctuation">,</span> String entryPoint<span class="token punctuation">,</span>
            ProcessRecord app<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span> <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
            String seInfo<span class="token punctuation">,</span> String requiredAbi<span class="token punctuation">,</span> String instructionSet<span class="token punctuation">,</span> String invokeWith<span class="token punctuation">,</span>
            <span class="token keyword">long</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>pendingStart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>killedByAm <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>removed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>killed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startSeq <span class="token operator">=</span> app<span class="token punctuation">.</span>startSeq <span class="token operator">=</span> <span class="token operator">++</span>mProcStartSeqCounter<span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">setStartParams</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> hostingType<span class="token punctuation">,</span> hostingNameStr<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mConstants<span class="token punctuation">.</span>FLAG_PROCESS_START_ASYNC<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mProcStartHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> String reason <span class="token operator">=</span> <span class="token function">isProcStartValidLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            app<span class="token punctuation">.</span>pendingStart <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        app<span class="token punctuation">.</span>usingWrapper <span class="token operator">=</span> invokeWith <span class="token operator">!=</span> null
                                <span class="token operator">||</span> SystemProperties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"wrap."</span> <span class="token operator">+</span> app<span class="token punctuation">.</span>processName<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">;</span>
                        mPendingStarts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>startSeq<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">final</span> ProcessStartResult startResult <span class="token operator">=</span> <span class="token function">startProcess</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>hostingType<span class="token punctuation">,</span> entryPoint<span class="token punctuation">,</span>
                            app<span class="token punctuation">,</span> app<span class="token punctuation">.</span>startUid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span> app<span class="token punctuation">.</span>seInfo<span class="token punctuation">,</span>
                            requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> app<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">handleProcessStartedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> startResult<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> app<span class="token punctuation">.</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个方法中，把fork进程分为两个步骤：</p>
<ul>
<li>1.一般的startProcess调用Process.start通信Zygote进程，fork一个新进程。如果探测是hostType是webview则调用startWebView启动webview</li>
<li>2.handleProcessStartedLocked处理后续处理。</li>
</ul>
<p>第一步骤中，我花了大量的篇幅描述了Zygote是如何孵化进程的，详细可以阅读我的第一篇重学系列<a href="https://www.jianshu.com/p/e5231f99f2a1" target="_blank" rel="noopener">系统启动到Activity(下)</a>这里就不多赘述，本文的读者只需要明白通过Zygote孵化之后就诞生了一个App进程，并且调用了ActivityThread类中的main方法；而WebView同样是由类似的方式管理通过一个WebViewZygote的对象孵化出来，有机会和大家聊聊。</p>
<p>我们来看看之前没有聊过的第二步骤handleProcessStartedLocked。</p>
<h3 id="AMS-handleProcessStartedLocked"><a href="#AMS-handleProcessStartedLocked" class="headerlink" title="AMS.handleProcessStartedLocked"></a>AMS.handleProcessStartedLocked</h3><p>经过上面的Socket通信之后，我们就能确切的获取到孵化进程是否成功，去做后续处理。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">handleProcessStartedLocked</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">,</span> <span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> usingWrapper<span class="token punctuation">,</span>
            <span class="token keyword">long</span> expectedStartSeq<span class="token punctuation">,</span> <span class="token keyword">boolean</span> procAttached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPendingStarts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>expectedStartSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mBatteryStatsService<span class="token punctuation">.</span><span class="token function">noteProcessStart</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logAppProcessStartIfNeeded</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>seInfo<span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>sourceDir<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Ignore</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Watchdog<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processStarted</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        app<span class="token punctuation">.</span><span class="token function">setPid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>usingWrapper <span class="token operator">=</span> usingWrapper<span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>pendingStart <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        ProcessRecord oldApp<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPidsSelfLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            oldApp <span class="token operator">=</span> mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPidsSelfLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//装载ANR炸弹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>procAttached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>PROC_START_TIMEOUT_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
                msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> app<span class="token punctuation">;</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> usingWrapper
                        <span class="token operator">?</span> PROC_START_TIMEOUT_WITH_WRAPPER <span class="token operator">:</span> PROC_START_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在过程中，电源服务收集启动进程的日志，把pid以及ProcessRecord存储到类型为map的mPidsSelfLocked。最后会设置一个PROC_START_TIMEOUT_MSG的延时消息发送到Handler中。而这个延时事件就是10秒。</p>
<p>假如我们试一试超过这个事件会怎么样？</p>
<h4 id="进程启动超时异常"><a href="#进程启动超时异常" class="headerlink" title="进程启动超时异常"></a>进程启动超时异常</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">case</span> PROC_START_TIMEOUT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>
                ProcessRecord app <span class="token operator">=</span> <span class="token punctuation">(</span>ProcessRecord<span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">processStartTimedOutLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processStartTimedOutLocked</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> pid <span class="token operator">=</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> gone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPidsSelfLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ProcessRecord knownApp <span class="token operator">=</span> mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>knownApp <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> knownApp<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                gone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>gone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    pid<span class="token punctuation">,</span> app<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> app<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">removeProcessNameLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mHeavyWeightProcess <span class="token operator">==</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>CANCEL_HEAVY_NOTIFICATION_MSG<span class="token punctuation">,</span>
                        mHeavyWeightProcess<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mHeavyWeightProcess <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mBatteryStatsService<span class="token punctuation">.</span><span class="token function">noteProcessFinish</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">cleanupAppInLaunchingProvidersLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mServices<span class="token punctuation">.</span><span class="token function">processStartTimedOutLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token string">"start timeout"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">removeLruProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mBackupTarget <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mBackupTarget<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pid <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            IBackupManager bm <span class="token operator">=</span> IBackupManager<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>
                                    ServiceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>BACKUP_SERVICE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            bm<span class="token punctuation">.</span><span class="token function">agentDisconnected</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// Can't happen; the backup manager is local</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPendingBroadcastProcessLocked</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token function">skipPendingBroadcastLocked</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到当启动进程超时事件执行的时候，会执行如下几个事情：</p>
<ul>
<li>1.清空mPidsSelfLocked中的缓存，清空mProcesMap中的缓存，如果是重量级进程，则会清空存储在AMS重量级进程中的缓存<ul>
<li>2.关闭电源日志对应进程的的信息,清除已经那些等待进程初始化完毕之后要去加载的ContentProvider和Service</li>
<li>3.接着执行ProcessRecord的kill的方法，从Lru缓存中清除。</li>
<li>4.关闭那些备份服务的链接，最后清除掉当前进程存放在正在监听的广播并且准备发过来的信息。</li>
</ul>
</li>
</ul>
<p>因此，进程启动也有ANR。当进程启动超过10秒事件，也会理解退出。那么这个炸弹什么拆掉呢？接下来让我们来聊聊，进程诞生之后ActivityThread的第一个方法。</p>
<h3 id="ActivityThread的初始化"><a href="#ActivityThread的初始化" class="headerlink" title="ActivityThread的初始化"></a>ActivityThread的初始化</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ActivityThread.java" target="_blank" rel="noopener">ActivityThread.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        Looper<span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ActivityThread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainThreadHandler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sMainThreadHandler <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessageLogging</span><span class="token punctuation">(</span><span class="token keyword">new</span>
                    <span class="token class-name">LogPrinter</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"ActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Main thread loop unexpectedly exited"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ActivityThread的main方法中会先初始化一个prepareMainLooper，并且进行loop的事件循环。</p>
<p>在这个过程中，能看到之前我在上一篇文章Handler中聊过的Looper日志打印。在这个过程中调用了ActivityThread的attch方法进一步绑定，这里绑定了什么呢？先来看看attach方法。</p>
<h2 id="ActivityThread-attach"><a href="#ActivityThread-attach" class="headerlink" title="ActivityThread.attach"></a>ActivityThread.attach</h2><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> system<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sCurrentActivityThread <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        mSystemThread <span class="token operator">=</span> system<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>system<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ViewRootImpl<span class="token punctuation">.</span><span class="token function">addFirstDrawHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">ensureJitEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span>DdmHandleAppName<span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"&lt;pre-initialized>"</span><span class="token punctuation">,</span>
                                                    UserHandle<span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            RuntimeInit<span class="token punctuation">.</span><span class="token function">setApplicationObject</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mgr<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Watch for getting close to heap limit.</span>
            BinderInternal<span class="token punctuation">.</span><span class="token function">addGcWatcher</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSomeActivitiesChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    Runtime runtime <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> dalvikMax <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">maxMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> dalvikUsed <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> runtime<span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dalvikUsed <span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>dalvikMax<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_MEMORY_TRIM<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Dalvik max="</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dalvikMax<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">" total="</span> <span class="token operator">+</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">" used="</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dalvikUsed<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mSomeActivitiesChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            mgr<span class="token punctuation">.</span><span class="token function">releaseSomeActivities</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// add dropbox logging to libcore</span>
        DropBox<span class="token punctuation">.</span><span class="token function">setReporter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DropBoxReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ViewRootImpl<span class="token punctuation">.</span>ConfigChangedCallback configChangedCallback
                <span class="token operator">=</span> <span class="token punctuation">(</span>Configuration globalConfig<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// We need to apply this change to the resources immediately, because upon returning</span>
                <span class="token comment" spellcheck="true">// the view hierarchy will be informed about it.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">.</span><span class="token function">applyConfigurationToResourcesLocked</span><span class="token punctuation">(</span>globalConfig<span class="token punctuation">,</span>
                        null <span class="token comment" spellcheck="true">/* compat */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">updateLocaleListFromAppContext</span><span class="token punctuation">(</span>mInitialApplication<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            mResourcesManager<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocales</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">// This actually changed the resources! Tell everyone about it.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingConfiguration <span class="token operator">==</span> null
                            <span class="token operator">||</span> mPendingConfiguration<span class="token punctuation">.</span><span class="token function">isOtherSeqNewer</span><span class="token punctuation">(</span>globalConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mPendingConfiguration <span class="token operator">=</span> globalConfig<span class="token punctuation">;</span>
                        <span class="token function">sendMessage</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>CONFIGURATION_CHANGED<span class="token punctuation">,</span> globalConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        ViewRootImpl<span class="token punctuation">.</span><span class="token function">addConfigCallback</span><span class="token punctuation">(</span>configChangedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当我们有之前的基础之后，读懂这一段就比较简单了：</p>
<ul>
<li>1.注册ViewRootImpl在第一次调用onDraw时候的回调，此时要打开虚拟机的jit模式。注意这个jit并不是Skia SkSL的jit模式，只是虚拟机的jit模式。不过在Android 9.0中是空实现。</li>
<li>2.把ApplicationThread 绑定到AMS</li>
<li>3.通过BinderInternal不断的监听Java堆中是使用情况，如果使用情况超过3/4则会释放一部分的Activity</li>
<li>4.添加DropBox的打印器。DropBox实际上使用的是DropBoxManagerService，他会把日志记录在/data/system/dropbox中。一般记录一些一场行为，如anr，crash，watchdog(系统进程异常)，native_crash，lowmem(低内存)，strict_mode等待日志。</li>
<li>5.添加当资源环境发生配置时候的回调，能看到此时会根据Locale语言环境切换资源</li>
</ul>
<p>我们先看看第二点看看这个过程中做了什么。</p>
<h2 id="绑定ApplicationThread"><a href="#绑定ApplicationThread" class="headerlink" title="绑定ApplicationThread"></a>绑定ApplicationThread</h2><pre class="line-numbers language-java"><code class="language-java">            <span class="token keyword">final</span> IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mgr<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里能看到实际上是把ApplicationThread绑定到AMS。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationThread</span> <span class="token keyword">extends</span> <span class="token class-name">IApplicationThread<span class="token punctuation">.</span>Stub</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ApplicationThread其实是一个Binder对象。</p>
<p>如果熟悉Activity启动流程的朋友就能明白，其实IActivityManager指的就是ActivityManagerService。这里不再介绍Binder如何运作的，我们直接看到ActivityManagerService中。</p>
<h3 id="AMS的attachApplicationLocked"><a href="#AMS的attachApplicationLocked" class="headerlink" title="AMS的attachApplicationLocked"></a>AMS的attachApplicationLocked</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java" target="_blank" rel="noopener">ActivityManagerService.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">     <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span>IApplicationThread thread<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> callingPid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Binder.clearCallingIdentity以及Binder.getCallingPid的使用一般会和restoreCallingIdentity一起使用。当我们需要使用Binder通信到自己的进程的时候会这么使用。这两个Clear方法其实就是清空远程端的Binder的Pid和Uid并返回到java层，restoreCallingIdentity把这两个对象设置回来。</p>
<p>这里的核心方法就是attachApplicationLocked。</p>
<h3 id="AMS-attachApplicationLocked"><a href="#AMS-attachApplicationLocked" class="headerlink" title="AMS.attachApplicationLocked"></a>AMS.attachApplicationLocked</h3><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>IApplicationThread thread<span class="token punctuation">,</span>
            <span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">// Find the application record that is being attached...  either via</span>
        <span class="token comment" spellcheck="true">// the pid if we are running in multiple processes, or just pull the</span>
        <span class="token comment" spellcheck="true">// next app record if we are emulating process with anonymous threads.</span>
        ProcessRecord app<span class="token punctuation">;</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> MY_PID <span class="token operator">&amp;&amp;</span> pid <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPidsSelfLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                app <span class="token operator">=</span> mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            app <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// It's possible that process called attachApplication before we got a chance to</span>
        <span class="token comment" spellcheck="true">// update the internal state.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> startSeq <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ProcessRecord pending <span class="token operator">=</span> mPendingStarts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> pending<span class="token punctuation">.</span>startUid <span class="token operator">==</span> callingUid
                    <span class="token operator">&amp;&amp;</span> <span class="token function">handleProcessStartedLocked</span><span class="token punctuation">(</span>pending<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> pending<span class="token punctuation">.</span>usingWrapper<span class="token punctuation">,</span>
                            startSeq<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                app <span class="token operator">=</span> pending<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handleAppDiedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Tell the process all about itself.</span>


        <span class="token keyword">final</span> String processName <span class="token operator">=</span> app<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            AppDeathRecipient adr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppDeathRecipient</span><span class="token punctuation">(</span>
                    app<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">linkToDeath</span><span class="token punctuation">(</span>adr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span>deathRecipient <span class="token operator">=</span> adr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        app<span class="token punctuation">.</span><span class="token function">makeActive</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>curAdj <span class="token operator">=</span> app<span class="token punctuation">.</span>setAdj <span class="token operator">=</span> app<span class="token punctuation">.</span>verifiedAdj <span class="token operator">=</span> ProcessList<span class="token punctuation">.</span>INVALID_ADJ<span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>curSchedGroup <span class="token operator">=</span> app<span class="token punctuation">.</span>setSchedGroup <span class="token operator">=</span> ProcessList<span class="token punctuation">.</span>SCHED_GROUP_DEFAULT<span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>forcingToImportant <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token function">updateProcessForegroundLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>hasShownUi <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>debugging <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>cached <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>killedByAm <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>killed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>


        app<span class="token punctuation">.</span>unlocked <span class="token operator">=</span> StorageManager<span class="token punctuation">.</span><span class="token function">isUserKeyUnlocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>PROC_START_TIMEOUT_MSG<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> normalMode <span class="token operator">=</span> mProcessesReady <span class="token operator">||</span> <span class="token function">isAllowedWhileBooting</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>ProviderInfo<span class="token operator">></span> providers <span class="token operator">=</span> normalMode <span class="token operator">?</span> <span class="token function">generateApplicationProvidersLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>providers <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">checkAppInLaunchingProvidersLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> app<span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> CONTENT_PROVIDER_PUBLISH_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolatedEntryPoint <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>instr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                thread<span class="token punctuation">.</span><span class="token function">bindApplication</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> providers<span class="token punctuation">,</span> null<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span>
                        null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> testMode<span class="token punctuation">,</span>
                        mBinderTransactionTrackingEnabled<span class="token punctuation">,</span> enableTrackAllocation<span class="token punctuation">,</span>
                        isRestrictedBackupMode <span class="token operator">||</span> <span class="token operator">!</span>normalMode<span class="token punctuation">,</span> app<span class="token punctuation">.</span>persistent<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token function">getGlobalConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>compat<span class="token punctuation">,</span>
                        <span class="token function">getCommonServicesLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolated<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mCoreSettingsObserver<span class="token punctuation">.</span><span class="token function">getCoreSettingsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        buildSerial<span class="token punctuation">,</span> isAutofillCompatEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>profilerInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                profilerInfo<span class="token punctuation">.</span><span class="token function">closeFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                profilerInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">"attachApplicationLocked: immediately after bindApplication"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">"attachApplicationLocked: after updateLruProcessLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span>lastRequestedGc <span class="token operator">=</span> app<span class="token punctuation">.</span>lastLowMemory <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Remove this record from the list of starting applications.</span>
        mPersistentStartingProcesses<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_PROCESSES <span class="token operator">&amp;&amp;</span> mProcessesOnHold<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_PROCESSES<span class="token punctuation">,</span>
                <span class="token string">"Attach application locked removing on hold: "</span> <span class="token operator">+</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mProcessesOnHold<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> badApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// See if the top visible activity is waiting to run in this process...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>normalMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span><span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    didSomething <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Slog<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Exception thrown launching activities in "</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Find any services that should be running in this process...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>badApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                didSomething <span class="token operator">|=</span> mServices<span class="token punctuation">.</span><span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">"attachApplicationLocked: after mServices.attachApplicationLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Check if a next-broadcast receiver is in this process...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>badApp <span class="token operator">&amp;&amp;</span> <span class="token function">isPendingBroadcastProcessLocked</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                didSomething <span class="token operator">|=</span> <span class="token function">sendPendingBroadcastsLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">checkTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">"attachApplicationLocked: after sendPendingBroadcastsLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Check whether the next backup agent is in this process...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>badApp <span class="token operator">&amp;&amp;</span> mBackupTarget <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mBackupTarget<span class="token punctuation">.</span>app <span class="token operator">==</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>mBackupTarget<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                             PackageManager<span class="token punctuation">.</span>NOTIFY_PACKAGE_USE_BACKUP<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                thread<span class="token punctuation">.</span><span class="token function">scheduleCreateBackupAgent</span><span class="token punctuation">(</span>mBackupTarget<span class="token punctuation">.</span>appInfo<span class="token punctuation">,</span>
                        <span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>mBackupTarget<span class="token punctuation">.</span>appInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mBackupTarget<span class="token punctuation">.</span>backupMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSomething<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>经过压缩流程，我们只需要关注这些代码逻辑。</p>
<ul>
<li>1.从mPidsSelfLocked缓存对象中获取对应pid的ProcessRecord对象</li>
<li>2.如果此时找不到对应的ProcessRecord，则尝试通过handleProcessStartedLocked说明可能添加遗漏了，就尝试再添加到缓存中。一般走不到这里面。</li>
<li>3.如果当前的ProcessRecord还包含着thread对象，说明这个进程其实已经启动过了,而且还是经历了重新启动进程。因此需要通过handleAppDiedLocked先清理一次之前进程所有留在AMS，WMS中的缓存</li>
<li>4.重新绑定Binder死亡监听；同时设置ProcessRecord中的数据，把ApplicationThread和ProcessRecord绑定起来。</li>
<li>5.通过mHandler .removeMessages拆除进程启动超时炸弹</li>
<li>6.跨进程调用ApplicationThread的bindApplication方法。</li>
<li>7.启动那些之前已经在TaskRecord中活跃过的Activity，Service，Broadcast，ContentProvider。一般这种情况是指进程因为crash等原因重新启动。</li>
<li>8.调整adj值。这个值是当前进程的活跃度等级。</li>
</ul>
<h4 id="ApplicationThread-bindApplication"><a href="#ApplicationThread-bindApplication" class="headerlink" title="ApplicationThread.bindApplication"></a>ApplicationThread.bindApplication</h4><p>文件：<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ActivityThread.java" target="_blank" rel="noopener">ActivityThread.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bindApplication</span><span class="token punctuation">(</span>String processName<span class="token punctuation">,</span> ApplicationInfo appInfo<span class="token punctuation">,</span>
                List<span class="token operator">&lt;</span>ProviderInfo<span class="token operator">></span> providers<span class="token punctuation">,</span> ComponentName instrumentationName<span class="token punctuation">,</span>
                ProfilerInfo profilerInfo<span class="token punctuation">,</span> Bundle instrumentationArgs<span class="token punctuation">,</span>
                IInstrumentationWatcher instrumentationWatcher<span class="token punctuation">,</span>
                IUiAutomationConnection instrumentationUiConnection<span class="token punctuation">,</span> <span class="token keyword">int</span> debugMode<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> enableBinderTracking<span class="token punctuation">,</span> <span class="token keyword">boolean</span> trackAllocation<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> isRestrictedBackupMode<span class="token punctuation">,</span> <span class="token keyword">boolean</span> persistent<span class="token punctuation">,</span> Configuration config<span class="token punctuation">,</span>
                CompatibilityInfo compatInfo<span class="token punctuation">,</span> Map services<span class="token punctuation">,</span> Bundle coreSettings<span class="token punctuation">,</span>
                String buildSerial<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autofillCompatibilityEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>services <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Test code to make sure the app could see the passed-in services.</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>Object oname <span class="token operator">:</span> services<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>services<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>oname<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// AM just passed in a null service.</span>
                        <span class="token punctuation">}</span>
                        String name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> oname<span class="token punctuation">;</span>

                        <span class="token comment" spellcheck="true">// See b/79378449 about the following exemption.</span>
                        <span class="token keyword">switch</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">case</span> <span class="token string">"package"</span><span class="token operator">:</span>
                            <span class="token keyword">case</span> Context<span class="token punctuation">.</span>WINDOW_SERVICE<span class="token operator">:</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ServiceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            Log<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Service "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">" should be accessible by this app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// Setup the service cache in the ServiceManager</span>
                ServiceManager<span class="token punctuation">.</span><span class="token function">initServiceCache</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">setCoreSettings</span><span class="token punctuation">(</span>coreSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>

            AppBindData data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppBindData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>processName <span class="token operator">=</span> processName<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>appInfo <span class="token operator">=</span> appInfo<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>providers <span class="token operator">=</span> providers<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>instrumentationName <span class="token operator">=</span> instrumentationName<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>instrumentationArgs <span class="token operator">=</span> instrumentationArgs<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>instrumentationWatcher <span class="token operator">=</span> instrumentationWatcher<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>instrumentationUiAutomationConnection <span class="token operator">=</span> instrumentationUiConnection<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>debugMode <span class="token operator">=</span> debugMode<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>enableBinderTracking <span class="token operator">=</span> enableBinderTracking<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>trackAllocation <span class="token operator">=</span> trackAllocation<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>restrictedBackupMode <span class="token operator">=</span> isRestrictedBackupMode<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>persistent <span class="token operator">=</span> persistent<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>compatInfo <span class="token operator">=</span> compatInfo<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>initProfilerInfo <span class="token operator">=</span> profilerInfo<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>buildSerial <span class="token operator">=</span> buildSerial<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>autofillCompatibilityEnabled <span class="token operator">=</span> autofillCompatibilityEnabled<span class="token punctuation">;</span>
            <span class="token function">sendMessage</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>BIND_APPLICATION<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中，实际上是初始化了ServiceManager一个隐藏的SystemService管理类，获取从AMS传输过来的字符串进行初始化。</p>
<p>学习到现在出现两个可以从App应用端获取系统SystemServer进程中的服务。</p>
<ul>
<li>SystemServiceRegistry 我们常用的Context.getService就是从这里面获取的</li>
<li>ServiceManager一个不面向开发者的系统服务缓存</li>
</ul>
<p>那么这两个是什么关系呢？其实阅读过我之前的文章就知道。在SystemServer初始化各种服务之后，会把每一个服务通过addService添加到本进程的ServiceManager中，换句话说，就是直接存放了一个key为服务名和value为IBinder的map值。</p>
<p>SystemServiceRegistry则是面向开发者的key，value的缓存IBinder的数据结构。可以通过Context.getSystemService获取。初始化AppBindData数据，发送BIND_APPLICATION，到主线程的Handler。</p>
<h4 id="ActivityThread-handleBindApplication"><a href="#ActivityThread-handleBindApplication" class="headerlink" title="ActivityThread.handleBindApplication"></a>ActivityThread.handleBindApplication</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleBindApplication</span><span class="token punctuation">(</span>AppBindData data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Register the UI Thread as a sensitive thread to the runtime.</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * Update the system configuration since its preloaded and might not
             * reflect configuration changes. The configuration object passed
             * in AppBindData can be safely assumed to be up to date
             */</span>
            mResourcesManager<span class="token punctuation">.</span><span class="token function">applyConfigurationToResourcesLocked</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>config<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mCurDefaultDisplayDpi <span class="token operator">=</span> data<span class="token punctuation">.</span>config<span class="token punctuation">.</span>densityDpi<span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// This calls mResourcesManager so keep it within the synchronized block.</span>
            <span class="token function">applyCompatConfiguration</span><span class="token punctuation">(</span>mCurDefaultDisplayDpi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        data<span class="token punctuation">.</span>info <span class="token operator">=</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>agent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handleAttachAgent</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/**
         * Switch this process to density compatibility mode if needed.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_SUPPORTS_SCREEN_DENSITIES<span class="token punctuation">)</span>
                <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mDensityCompatMode <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            Bitmap<span class="token punctuation">.</span><span class="token function">setDefaultDensity</span><span class="token punctuation">(</span>DisplayMetrics<span class="token punctuation">.</span>DENSITY_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">updateDefaultDensity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">final</span> InstrumentationInfo ii<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ii <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationPackageManager</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getInstrumentationInfo</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManager<span class="token punctuation">.</span>NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            mInstrumentationPackageName <span class="token operator">=</span> ii<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
            mInstrumentationAppDir <span class="token operator">=</span> ii<span class="token punctuation">.</span>sourceDir<span class="token punctuation">;</span>
            mInstrumentationSplitAppDirs <span class="token operator">=</span> ii<span class="token punctuation">.</span>splitSourceDirs<span class="token punctuation">;</span>
            mInstrumentationLibDir <span class="token operator">=</span> <span class="token function">getInstrumentationLibrary</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">,</span> ii<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstrumentedAppDir <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">getAppDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstrumentedSplitAppDirs <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">getSplitAppDirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstrumentedLibDir <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">getLibDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ii <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> ContextImpl appContext <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateLocaleListFromAppContext</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span>
                mResourcesManager<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocales</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>SystemProperties<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"dalvik.vm.usejitprofiles"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BaseDexClassLoader<span class="token punctuation">.</span><span class="token function">setReporter</span><span class="token punctuation">(</span>DexLoadReporter<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// Continue loading instrumentation.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ii <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mInstrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstrumentation<span class="token punctuation">.</span><span class="token function">basicInit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// Allow disk access during application and provider setup. This could</span>
        <span class="token comment" spellcheck="true">// block processing ordered broadcasts, but later processing would</span>
        <span class="token comment" spellcheck="true">// probably end up doing the same disk access.</span>
        Application app<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// If the app is being launched for full backup or restore, bring it up in</span>
            <span class="token comment" spellcheck="true">// a restricted environment with the base application class.</span>
            app <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Propagate autofill compat state</span>
            app<span class="token punctuation">.</span><span class="token function">setAutofillCompatibilityEnabled</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>autofillCompatibilityEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mInitialApplication <span class="token operator">=</span> app<span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// don't bring up providers in restricted mode; they may depend on the</span>
            <span class="token comment" spellcheck="true">// app's custom Application class</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">installContentProviders</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// For process that contains content providers, we want to</span>
                    <span class="token comment" spellcheck="true">// ensure that the JIT is enabled "at some point".</span>
                    mH<span class="token punctuation">.</span><span class="token function">sendEmptyMessageDelayed</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>ENABLE_JIT<span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Do this after providers, since instrumentation tests generally start their</span>
            <span class="token comment" spellcheck="true">// test thread at this point, and we don't want that racing.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mInstrumentation<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mInstrumentation<span class="token punctuation">.</span><span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法有点长，我们关注比较核心的逻辑：</p>
<ul>
<li><p>1.首先获取mResourcesManager实例(ActivityThread构造函数实例化)，给底层的资源设置dpi得到配置，更加详细的，可以看看<a href="https://www.jianshu.com/p/817a787910f2" target="_blank" rel="noopener">资源加载系列</a></p>
</li>
<li><p>2.接着通过getPackageInfoNoCheck获取LoadedApk对象，这个对象在插件化一文中聊过，本质是一个apk在内存中的表现对象</p>
</li>
<li><p>3.通过createAppContext创建一个ContextImpl，这就是在整个App进程中第一个创建的Context</p>
</li>
<li><p>4.创建Instrumentation对象，这个对象一般是用于自动化测试的中间键。</p>
</li>
<li><p>5.通过makeApplication创建Application对象，接着通过installContentProviders启动所有的ContextProvider对象</p>
</li>
<li><p>6.回调mInstrumentation的ApplicationCreate方法，该方法最后会调用到Application的onCreate中。</p>
</li>
</ul>
<p>在这个过程中，我们稍微看到了一处比较迷惑的地方。Application在bindApplication中执行了一次。其实我们在创建Activity时候performLaunchActivity中又创建了一次。</p>
<pre><code>Application app = r.packageInfo.makeApplication(false, mInstrumentation);</code></pre><p>以及在bindApplication中</p>
<pre><code>app = data.info.makeApplication(data.restrictedBackupMode, null);</code></pre><p>这两次有什么区别呢？假设这是一次，从零开始正常启动的进程，而不是重新启动的启动的。此时restrictedBackupMode这个标志代表重新启动时候的备份标志位。当我们是第一次启动进程的时候，这个标志位默认false。</p>
<p>为了更加彻底理解LoadedApk对象，我们先来看看Android是如何通过getPackageInfoNoCheck创建这个对象</p>
<h4 id="getPackageInfoNoCheck创建LoadedApk"><a href="#getPackageInfoNoCheck创建LoadedApk" class="headerlink" title="getPackageInfoNoCheck创建LoadedApk"></a>getPackageInfoNoCheck创建LoadedApk</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> LoadedApk <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span>ApplicationInfo ai<span class="token punctuation">,</span>
            CompatibilityInfo compatInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>ai<span class="token punctuation">,</span> compatInfo<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>getPackageInfoNoCheck最后会调用getPackageInfo方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> LoadedApk <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>ApplicationInfo aInfo<span class="token punctuation">,</span> CompatibilityInfo compatInfo<span class="token punctuation">,</span>
            ClassLoader baseLoader<span class="token punctuation">,</span> <span class="token keyword">boolean</span> securityViolation<span class="token punctuation">,</span> <span class="token keyword">boolean</span> includeCode<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> registerPackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> differentUser <span class="token operator">=</span> <span class="token punctuation">(</span>UserHandle<span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            WeakReference<span class="token operator">&lt;</span>LoadedApk<span class="token operator">></span> ref<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>differentUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Caching not supported across users</span>
                ref <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>includeCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ref <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                ref <span class="token operator">=</span> mResourcePackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            LoadedApk packageInfo <span class="token operator">=</span> ref <span class="token operator">!=</span> null <span class="token operator">?</span> ref<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>packageInfo<span class="token punctuation">.</span>mResources <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>packageInfo<span class="token punctuation">.</span>mResources<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUpToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                packageInfo <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">LoadedApk</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> compatInfo<span class="token punctuation">,</span> baseLoader<span class="token punctuation">,</span>
                            securityViolation<span class="token punctuation">,</span> includeCode <span class="token operator">&amp;&amp;</span>
                            <span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_HAS_CODE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> registerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mSystemThread <span class="token operator">&amp;&amp;</span> <span class="token string">"android"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    packageInfo<span class="token punctuation">.</span><span class="token function">installSystemApplicationInfo</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">,</span>
                            <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>differentUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Caching not supported across users</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>includeCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mPackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span>LoadedApk<span class="token operator">></span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mResourcePackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span>LoadedApk<span class="token operator">></span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> packageInfo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中其实并没有太多特殊处理本质上LoadedApk保存了ApplicationInfo这些从AMS中解析出来包中所有的信息。并且把LoadedApk保存到mResourcePackages的这个带着弱引用的map中。</p>
<h3 id="初始化Application"><a href="#初始化Application" class="headerlink" title="初始化Application"></a>初始化Application</h3><p>文件 ：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/LoadedApk.java" target="_blank" rel="noopener">LoadedApk.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> Application <span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forceDefaultAppClass<span class="token punctuation">,</span>
            Instrumentation instrumentation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mApplication <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mApplication<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Application app <span class="token operator">=</span> null<span class="token punctuation">;</span>

        String appClass <span class="token operator">=</span> mApplicationInfo<span class="token punctuation">.</span>className<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>forceDefaultAppClass <span class="token operator">||</span> <span class="token punctuation">(</span>appClass <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            appClass <span class="token operator">=</span> <span class="token string">"android.app.Application"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader cl <span class="token operator">=</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPackageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">initializeJavaContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ContextImpl appContext <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span>mActivityThread<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app <span class="token operator">=</span> mActivityThread<span class="token punctuation">.</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">newApplication</span><span class="token punctuation">(</span>
                    cl<span class="token punctuation">,</span> appClass<span class="token punctuation">,</span> appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        mActivityThread<span class="token punctuation">.</span>mAllApplications<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mApplication <span class="token operator">=</span> app<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>instrumentation <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                instrumentation<span class="token punctuation">.</span><span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                        <span class="token string">"Unable to create application "</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Rewrite the R 'constants' for all library apks.</span>
        SparseArray<span class="token operator">&lt;</span>String<span class="token operator">></span> packageIdentifiers <span class="token operator">=</span> <span class="token function">getAssets</span><span class="token punctuation">(</span>mActivityThread<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getAssignedPackageIdentifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> packageIdentifiers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> id <span class="token operator">=</span> packageIdentifiers<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token operator">||</span> id <span class="token operator">==</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">rewriteRValues</span><span class="token punctuation">(</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> packageIdentifiers<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> app<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在LoadApk对象中会全局缓存一个Application对象。之后每一次调用这个方法读取之后，就会调用这个方法直接获取缓存中的Application对象。</p>
<p>当没有设置Application的class则会有默认的class，或者打开了备份服务之后强制使用默认Application。</p>
<p>接下来可以把分为几个步骤:</p>
<ul>
<li>1.getClassLoader 装载ClassLoader，如果是系统应用则initializeJavaContextClassLoader装载另一个classLoader</li>
<li>2.createAppContext创建一个context对象</li>
<li>3.newApplication反射生成Application对象，并且调用了attachBaseContext方法，并且把Context和Application互相绑定</li>
<li>4.如果传入了instrumentation，最会调用Application.onCreate方法</li>
<li>5.rewriteRValues重写共享资源库中的资源id。这种资源库在资源章节中有聊过，这种资源共享库，packageId往往是0x00,此时的id将会依据编译的顺序获取，加载时候也是根据加载顺序获取，为此Android系统做了一个LookupTable进行一次映射。而rewriteRValues的作用就是反射这种共享资源库中的R文件的onResourceLoaded方法，重写里面的packageid，让app可以查找。稍后做进一步解析。</li>
</ul>
<p>接着从classLoader的加载开始聊。</p>
<h5 id="getClassLoader-装载Android的ClassLoader"><a href="#getClassLoader-装载Android的ClassLoader" class="headerlink" title="getClassLoader 装载Android的ClassLoader"></a>getClassLoader 装载Android的ClassLoader</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> ClassLoader <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mClassLoader <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">createOrUpdateClassLoaderLocked</span><span class="token punctuation">(</span>null <span class="token comment" spellcheck="true">/*addedPaths*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> mClassLoader<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createOrUpdateClassLoaderLocked</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> addedPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mClassLoader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mBaseClassLoader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mClassLoader <span class="token operator">=</span> mBaseClassLoader<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mClassLoader <span class="token operator">=</span> ClassLoader<span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mAppComponentFactory <span class="token operator">=</span> <span class="token function">createAppFactory</span><span class="token punctuation">(</span>mApplicationInfo<span class="token punctuation">,</span> mClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mPackageName<span class="token punctuation">,</span> ActivityThread<span class="token punctuation">.</span><span class="token function">currentPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mIncludeCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ActivityThread<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>mPackageName<span class="token punctuation">,</span>
                        PackageManager<span class="token punctuation">.</span>NOTIFY_PACKAGE_USE_CROSS_PACKAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> re<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> re<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegisterPackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPackageDependency</span><span class="token punctuation">(</span>mPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> zipPaths <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> libPaths <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> isBundledApp <span class="token operator">=</span> mApplicationInfo<span class="token punctuation">.</span><span class="token function">isSystemApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mApplicationInfo<span class="token punctuation">.</span><span class="token function">isUpdatedSystemApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">final</span> String defaultSearchPaths <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.library.path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> treatVendorApkAsUnbundled <span class="token operator">=</span> <span class="token operator">!</span>defaultSearchPaths<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"/vendor/lib"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mApplicationInfo<span class="token punctuation">.</span><span class="token function">getCodePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null
                <span class="token operator">&amp;&amp;</span> mApplicationInfo<span class="token punctuation">.</span><span class="token function">isVendor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> treatVendorApkAsUnbundled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isBundledApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">makePaths</span><span class="token punctuation">(</span>mActivityThread<span class="token punctuation">,</span> isBundledApp<span class="token punctuation">,</span> mApplicationInfo<span class="token punctuation">,</span> zipPaths<span class="token punctuation">,</span> libPaths<span class="token punctuation">)</span><span class="token punctuation">;</span>

        String libraryPermittedPath <span class="token operator">=</span> mDataDir<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isBundledApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            libraryPermittedPath <span class="token operator">+=</span> File<span class="token punctuation">.</span>pathSeparator
                    <span class="token operator">+</span> Paths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getAppDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            libraryPermittedPath <span class="token operator">+=</span> File<span class="token punctuation">.</span>pathSeparator <span class="token operator">+</span> defaultSearchPaths<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> String librarySearchPath <span class="token operator">=</span> TextUtils<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span>pathSeparator<span class="token punctuation">,</span> libPaths<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> String zip <span class="token operator">=</span> <span class="token punctuation">(</span>zipPaths<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> zipPaths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                TextUtils<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span>pathSeparator<span class="token punctuation">,</span> zipPaths<span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token keyword">boolean</span> needToSetupJitProfiles <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mClassLoader <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span>

            mClassLoader <span class="token operator">=</span> ApplicationLoaders<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span>zip<span class="token punctuation">,</span>
                    mApplicationInfo<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> isBundledApp<span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span>
                    libraryPermittedPath<span class="token punctuation">,</span> mBaseClassLoader<span class="token punctuation">,</span>
                    mApplicationInfo<span class="token punctuation">.</span>classLoaderName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mAppComponentFactory <span class="token operator">=</span> <span class="token function">createAppFactory</span><span class="token punctuation">(</span>mApplicationInfo<span class="token punctuation">,</span> mClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            needToSetupJitProfiles <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>libPaths<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> SystemProperties<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>PROPERTY_NAME_APPEND_NATIVE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ApplicationLoaders<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addNative</span><span class="token punctuation">(</span>mClassLoader<span class="token punctuation">,</span> libPaths<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        List<span class="token operator">&lt;</span>String<span class="token operator">></span> extraLibPaths <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String abiSuffix <span class="token operator">=</span> VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is64Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"64"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>defaultSearchPaths<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"/vendor/lib"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            extraLibPaths<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/vendor/lib"</span> <span class="token operator">+</span> abiSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>defaultSearchPaths<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"/odm/lib"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            extraLibPaths<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/odm/lib"</span> <span class="token operator">+</span> abiSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>defaultSearchPaths<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"/product/lib"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            extraLibPaths<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/product/lib"</span> <span class="token operator">+</span> abiSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>extraLibPaths<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ApplicationLoaders<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addNative</span><span class="token punctuation">(</span>mClassLoader<span class="token punctuation">,</span> extraLibPaths<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>addedPaths <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> addedPaths<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> String add <span class="token operator">=</span> TextUtils<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span>pathSeparator<span class="token punctuation">,</span> addedPaths<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ApplicationLoaders<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPath</span><span class="token punctuation">(</span>mClassLoader<span class="token punctuation">,</span> add<span class="token punctuation">)</span><span class="token punctuation">;</span>
            needToSetupJitProfiles <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>needToSetupJitProfiles <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ActivityThread<span class="token punctuation">.</span><span class="token function">isSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setupJitProfileSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>v<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程实际上做的事情就一件就是插件化一文中提到过的Android中ClassLoader的组成.<br><img src="/images/ClassLoader%E8%AE%BE%E8%AE%A1.jpg" alt="ClassLoader设计.jpg"></p>
<p>在应用进程初期还不会存在Application ClassLoader对象。只有开始实例化Application的时候，才会装载Android应用独有的ClassLoader对象。还能看到，如果包名是系统的android开始，则不会加载应用的ClassLoader对象。</p>
<p>当是应用的时候，判断到当前的App是BundleApp，说明有部分代码是在Google服务上，会预先设置好未来下载dex的目录，之后会从里面加载。</p>
<p>接着执行如下2个事情:</p>
<ul>
<li>1.ApplicationLoaders.getDefault().getClassLoader根据从PMS中解析出来的ApplicationInfo中所有资源的路径，生成一个Application ClassLoader</li>
<li>2.ApplicationLoaders.getDefault().addNative 添加系统中得到so，以及应用中的so。并且调用系统中过的so库</li>
</ul>
<h5 id="ApplicationLoaders-getDefault-getClassLoader"><a href="#ApplicationLoaders-getDefault-getClassLoader" class="headerlink" title="ApplicationLoaders.getDefault().getClassLoader"></a>ApplicationLoaders.getDefault().getClassLoader</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> ClassLoader <span class="token function">getClassLoader</span><span class="token punctuation">(</span>String zip<span class="token punctuation">,</span> <span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isBundled<span class="token punctuation">,</span>
                                       String librarySearchPath<span class="token punctuation">,</span> String libraryPermittedPath<span class="token punctuation">,</span>
                                       ClassLoader parent<span class="token punctuation">,</span> String cacheKey<span class="token punctuation">,</span>
                                       String classLoaderName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        ClassLoader baseParent <span class="token operator">=</span> ClassLoader<span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLoaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                parent <span class="token operator">=</span> baseParent<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> baseParent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ClassLoader loader <span class="token operator">=</span> mLoaders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>loader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> loader<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                ClassLoader classloader <span class="token operator">=</span> ClassLoaderFactory<span class="token punctuation">.</span><span class="token function">createClassLoader</span><span class="token punctuation">(</span>
                        zip<span class="token punctuation">,</span>  librarySearchPath<span class="token punctuation">,</span> libraryPermittedPath<span class="token punctuation">,</span> parent<span class="token punctuation">,</span>
                        targetSdkVersion<span class="token punctuation">,</span> isBundled<span class="token punctuation">,</span> classLoaderName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                GraphicsEnvironment<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLayerPaths</span><span class="token punctuation">(</span>
                        classloader<span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> libraryPermittedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

                mLoaders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> classloader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> classloader<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            ClassLoader loader <span class="token operator">=</span> ClassLoaderFactory<span class="token punctuation">.</span><span class="token function">createClassLoader</span><span class="token punctuation">(</span>
                    zip<span class="token punctuation">,</span> null<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> classLoaderName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> loader<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时的parent在新建一个应用Application的时候为null。此时parent就是获取getSystemClassLoader的parent。</p>
<p>此时baseParent就必定是parent。先尝试从mLoaders通过key(此时为apk包路径名)找缓存，最后通过ClassLoaderFactory.createClassLoader创造classLoader，最后添加到缓存中。</p>
<p>那么我们就有必要看看着几个ClassLoader是否是我在插件化所说那样的。</p>
<h5 id="ClassLoader的构成"><a href="#ClassLoader的构成" class="headerlink" title="ClassLoader的构成"></a>ClassLoader的构成</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/" target="_blank" rel="noopener">libcore</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/" target="_blank" rel="noopener">ojluni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/" target="_blank" rel="noopener">src</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/" target="_blank" rel="noopener">main</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/java/lang/" target="_blank" rel="noopener">lang</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/java/lang/ClassLoader.java" target="_blank" rel="noopener">ClassLoader.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SystemClassLoader</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> ClassLoader loader <span class="token operator">=</span> ClassLoader<span class="token punctuation">.</span><span class="token function">createSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> ClassLoader <span class="token function">createSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String classPath <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.class.path"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String librarySearchPath <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.library.path"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span>classPath<span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> BootClassLoader<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@CallerSensitive</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> ClassLoader <span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> SystemClassLoader<span class="token punctuation">.</span>loader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>getSystemClassLoader通过一个单例获取一个SystemClassLoader，而这个系统加载器就是PathClassLoader。而这个对象就是继承关系如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">PathClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">BaseDexClassLoader</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseDexClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>此时能看到一切的Classloader基础都是BaseDexClassLoader，而DexClassLoader用于加载外部dex文件也是如此。而PathClassLoader是系统中默认初始化好的类加载器，用于加载路径下的dex文件。因此在系统应用中，默认都是PathClassLoader。</p>
<p>让我们情景代入一下，getSystemClassLoader的parent实际上就是BootLoader，也就是上图中启动类加载器。接下来看看ClassLoader工厂的createClassLoader方法。</p>
<h5 id="ClassLoaderFactory-createClassLoader"><a href="#ClassLoaderFactory-createClassLoader" class="headerlink" title="ClassLoaderFactory.createClassLoader"></a>ClassLoaderFactory.createClassLoader</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isPathClassLoaderName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name <span class="token operator">==</span> null <span class="token operator">||</span> PATH_CLASS_LOADER_NAME<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">||</span>
                DEX_CLASS_LOADER_NAME<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> ClassLoader <span class="token function">createClassLoader</span><span class="token punctuation">(</span>String dexPath<span class="token punctuation">,</span>
            String librarySearchPath<span class="token punctuation">,</span> ClassLoader parent<span class="token punctuation">,</span> String classloaderName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPathClassLoaderName</span><span class="token punctuation">(</span>classloaderName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDelegateLastClassLoaderName</span><span class="token punctuation">(</span>classloaderName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DelegateLastClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token string">"Invalid classLoaderName: "</span> <span class="token operator">+</span> classloaderName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> ClassLoader <span class="token function">createClassLoader</span><span class="token punctuation">(</span>String dexPath<span class="token punctuation">,</span>
            String librarySearchPath<span class="token punctuation">,</span> String libraryPermittedPath<span class="token punctuation">,</span> ClassLoader parent<span class="token punctuation">,</span>
            <span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isNamespaceShared<span class="token punctuation">,</span> String classloaderName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">final</span> ClassLoader classLoader <span class="token operator">=</span> <span class="token function">createClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> parent<span class="token punctuation">,</span>
                classloaderName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> isForVendor <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String path <span class="token operator">:</span> dexPath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/vendor/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                isForVendor <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        String errorMessage <span class="token operator">=</span> <span class="token function">createClassloaderNamespace</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span>
                                                         targetSdkVersion<span class="token punctuation">,</span>
                                                         librarySearchPath<span class="token punctuation">,</span>
                                                         libraryPermittedPath<span class="token punctuation">,</span>
                                                         isNamespaceShared<span class="token punctuation">,</span>
                                                         isForVendor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> classLoader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个工厂中，能看到如果传递下来的名字是null或者名字是PathClassLoader或者DexClassLoader则会默认创建PathClassLoader，并且通过native方法createClassloaderNamespace加载native层ClassLoader。</p>
<p>而ClassLoader有一个机制叫做双亲委托，当前的ClassLoader不会立即查找类而是不断委托的根部，最后找不到才往下层查找。</p>
<p>如果从双亲委托的角度来看，本质上一般的App应用中，一层是BootClassLoader就是指Bootstrap，另一层就是PathClassLoader就是我们的App类加载器。</p>
<h3 id="Android的R文件重载"><a href="#Android的R文件重载" class="headerlink" title="Android的R文件重载"></a>Android的R文件重载</h3><p>有一个方法rewriteRValues很多人都忽视掉。一般来说这个方法很少走。但是，如果是跟着我上一篇文章资源加载文章走下来，就会知道，其实在Android中有一种特殊的库，是只有资源没有代码的资源共享库。而这种库的packageID一般都为0x00.通过底层构建LookUpTable，把编译时期和加载时期不一致的packageID映射起来。然而这样还是没办法正常找到资源，因为我们通常会通过R.xx.xxx来加载资源共享库。因此需要把资源共享库中的内容,合并到当前包名才行。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">rewriteRValues</span><span class="token punctuation">(</span>ClassLoader cl<span class="token punctuation">,</span> String packageName<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> rClazz<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            rClazz <span class="token operator">=</span> cl<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>packageName <span class="token operator">+</span> <span class="token string">".R"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> Method callback<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            callback <span class="token operator">=</span> rClazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"onResourcesLoaded"</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Throwable cause<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            callback<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cause <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cause <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to rewrite resource references for "</span> <span class="token operator">+</span> packageName<span class="token punctuation">,</span>
                cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到会反射调用当前包名对应的R文件中onResourcesLoaded方法。如果我们翻开R.java是根本找不到这个方法的。只有当链接了资源共享库的R.java才会存在。</p>
<p>为此，我翻阅了AS的打包工具aapt的源码，有机会可以尝试着详细的过一遍源码。这里先上一个资源R文件生成流程的时序图:<br><img src="/images/aapt_R.java%E7%94%9F%E6%88%90%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" alt="aapt R.java生成的工作流程.png"></p>
<p>从上图可以得知，其核心逻辑如下：当aapt的main方法解析到p参数中引用的资源，将会调用doPackage，开始尝试的调用writeSymbolClass打包生成R.java文件，把每一个R文件中资源的int值赋值上。</p>
<p>在doPackage中一个核心逻辑就是</p>
<pre class="line-numbers language-java"><code class="language-java">err <span class="token operator">=</span> <span class="token function">writeResourceSymbols</span><span class="token punctuation">(</span>bundle<span class="token punctuation">,</span> assets<span class="token punctuation">,</span> assets<span class="token operator">-</span><span class="token operator">></span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            
bundle<span class="token operator">-</span><span class="token operator">></span><span class="token function">getBuildSharedLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> bundle<span class="token operator">-</span><span class="token operator">></span><span class="token function">getBuildAppAsSharedLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>能看到只要你编译的是资源共享库，而这个标志位的打开则是依赖aapt资源打包命令：”-shared-lib”。</p>
<p>那么这个方法做的事情是什么呢？其核心逻辑如下：</p>
<pre class="line-numbers language-java"><code class="language-java">            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> declaredClasses <span class="token operator">=</span> rClazz<span class="token punctuation">.</span><span class="token function">getDeclaredClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">:</span> declaredClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"styleable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>Field field <span class="token operator">:</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">rewriteIntArrayField</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>Field field <span class="token operator">:</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">rewriteIntField</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到其实就是通过反射，把R文件中的packageId的值复写，把非法的0x00复写成当前资源库加载之后的packageID的数值，这样App就能正常访问资源共享文件。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在进程初始化过程中做了如下的事情:</p>
<ul>
<li>1.把每一个生成的进程分配一个ProcessRecord对象，以pid为key缓存起来</li>
<li>2.每一个进程都会有自己ANR，只是这个时候进程不会出现自己ANR的框。在这个过程中AMS会有一个10秒延时事件，如果进程启动后没有即使拆除这个炸弹，将会退出。</li>
</ul>
<p>在ActivityThread初始化过程中，做了如下的事情：</p>
<ul>
<li>1.把ActivityThread中作为跨进程通信的中介ApplicationThread和AMS对应的ProcessRecord绑定起来。</li>
<li>2.重新绑定死亡监听</li>
<li>3.拆除进程启动炸弹</li>
<li>4.调用bindApplication，初始化Application</li>
<li>5.启动之前已经启动过的四大组件</li>
</ul>
<p>在Application初始化过程中，做了如下几个步骤：</p>
<ul>
<li>1.加载资源配置</li>
<li>2.生成LoadedApk对象</li>
<li><ol start="3">
<li>makeApplication 加载PathClassLoader，创建一个ContextImpl对象</li>
</ol>
</li>
<li>4.反射生成Application对象，并调用attachBaseContext</li>
<li><ol start="5">
<li>rewriteRValues 重写资源库中的packageID。</li>
</ol>
</li>
<li>6.调用Applcation的onCreate方法。</li>
</ul>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>理解了这个逻辑之后，我们来聊聊MultiDex的原理。大家都知道Android加载dex有65536个方法的限制，此时一般解决的方式就是MultiDex。而这个库内部在做什么呢？为什么使用的时候，需要把install方法放在attachBaseContext中呢？</p>
<p>本质上十分简单，实际上做的就是dex的加载。这个过程就是hook PathClassLoader的pathList对象中的dexElements对象，把拆分出小的dex文件加载到主的dex中。</p>
<p>思路本质上就是化整为零，你一个dex超过65536方法对吧，那就拆成几个小的，一一加载进来，这样就变相突破了限制。</p>
<p>知道了MultiDex的原理之后，我们就不难理解为什么要把install方法放在attachBaseContext中。因为attachBaseContext这个回调是整个App生命周期最早的换掉。此时也刚好了加载了自己的PathClassLoader，连Application.onCreate都没有调用，就能办到在不影响业务的前提下，加载类。</p>
<p>那么这么做有什么坏处呢？在主线程加载dex文件会出现ANR等卡顿现象。有不少团队为了解决这个问题，使用了异步线程或者异步进程调用install方法，但是这样就会出现dex还没加载到内存，但是想要调用了，就出现类无法找到异常。</p>
<p>为了处理这个问题，有些厂商就是hook Activity的启动流程，当没有找到这个类的时候将会出现一个中间页或者等待等。</p>
<p>随着眼界的开放，如果只是为了提升启动速度，其实可以通过redex对dex进行重排，把一开始使用的dex排到主dex中，少用的dex排到其他分dex中，这样异步调用MultiDex.install的方法就能跳过这些不自然的交互。</p>
<p>所有的核心技术都在我写的插件化基础框架都有解析过<a href="https://www.jianshu.com/p/d824056f510b" target="_blank" rel="noopener">横向浅析Small,RePlugin两个插件化框架</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/12/08/android-chong-xue-xi-lie-surfaceflinger-de-gai-shu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="Android 重学系列 SurfaceFlinger的概述">
                        
                        <span class="card-title">Android 重学系列 SurfaceFlinger的概述</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言本文将会作为开启SurfaceFlinger的系列第一篇文章。然而SurfaceFlinger几乎贯通了整个Android领域中所有的知识。从HAL硬件抽象层到Framework层，从CPU绘制到OpenGL等硬件绘制。
为了让整个系列
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-12-08
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/11/18/android-chong-xue-xi-lie-handler-yu-xiang-guan-xi-tong-diao-yong-de-pou-xi-xia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="Android 重学系列 Handler与相关系统调用的剖析(下)">
                        
                        <span class="card-title">Android 重学系列 Handler与相关系统调用的剖析(下)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章，和大家讲述了Handler的中使用到的eventfd系统调用原理。而本文将会着重剖析epoll系统调用，而整个handler核心的系统就是epoll。
如果遇到问题欢迎来到这里讨论:https://www.jianshu.c
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-11-18
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Linux-kernel/" class="post-category">
                                    Linux kernel
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Linux/">
                        <span class="chip bg-color">Linux</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
