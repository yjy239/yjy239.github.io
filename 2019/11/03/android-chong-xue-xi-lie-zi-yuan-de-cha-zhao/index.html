<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 资源的查找, Android | Linux | Flutter">
    <meta name="description" content="前言上一篇文章已经聊了资源系统的初始化，本文就来看看资源适合查找到的。
如果遇到问题，欢迎在下面这个地址下留言：https://www.jianshu.com/p/b153d63d60b3
正文资源的查找,Xml布局文件的读取到这里Asse">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 资源的查找 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 资源的查找
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android-资源系统/" class="post-category">
                                Android 资源系统
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-11-03
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        8.2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        39 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇文章已经聊了资源系统的初始化，本文就来看看资源适合查找到的。</p>
<p>如果遇到问题，欢迎在下面这个地址下留言：<a href="https://www.jianshu.com/p/b153d63d60b3" target="_blank" rel="noopener">https://www.jianshu.com/p/b153d63d60b3</a></p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="资源的查找-Xml布局文件的读取"><a href="#资源的查找-Xml布局文件的读取" class="headerlink" title="资源的查找,Xml布局文件的读取"></a>资源的查找,Xml布局文件的读取</h2><p>到这里AssetManager就生成了，我们来看看资源是怎么查找的。我们来看看之前我没有深入探讨的解析Xml方法。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/" target="_blank" rel="noopener">res</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/Resources.java" target="_blank" rel="noopener">Resources.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> XmlResourceParser <span class="token function">getLayout</span><span class="token punctuation">(</span><span class="token annotation punctuation">@LayoutRes</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">"layout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    XmlResourceParser <span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@AnyRes</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> String type<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> TypedValue value <span class="token operator">=</span> <span class="token function">obtainTempTypedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ResourcesImpl impl <span class="token operator">=</span> mResourcesImpl<span class="token punctuation">;</span>
            impl<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>type <span class="token operator">==</span> TypedValue<span class="token punctuation">.</span>TYPE_STRING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> impl<span class="token punctuation">.</span><span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>string<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span>
                        value<span class="token punctuation">.</span>assetCookie<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">releaseTempTypedValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里大致分为两个步骤：</p>
<ul>
<li>1.通过ResourcesImpl.getValue获取当前resId对应的资源，设置到TypedValue</li>
<li>2.如果当前返回的数据类型是String，则直接调用loadXmlResourceParser 读取资源具体的内容中，如Xml布局文件。</li>
<li>3.缓存当前资源</li>
</ul>
<h4 id="查找resId对应的资源"><a href="#查找resId对应的资源" class="headerlink" title="查找resId对应的资源"></a>查找resId对应的资源</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/" target="_blank" rel="noopener">res</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/ResourcesImpl.java" target="_blank" rel="noopener">ResourcesImpl.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@AnyRes</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span> TypedValue outValue<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolveRefs<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> found <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">getResourceValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> outValue<span class="token punctuation">,</span> resolveRefs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>found<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里面调用了AssetManager的getResourceValue方法。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/" target="_blank" rel="noopener">res</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/AssetManager.java" target="_blank" rel="noopener">AssetManager.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">getResourceValue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@AnyRes</span> <span class="token keyword">int</span> resId<span class="token punctuation">,</span> <span class="token keyword">int</span> densityDpi<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> TypedValue outValue<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> resolveRefs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ensureValidLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> cookie <span class="token operator">=</span> <span class="token function">nativeGetResourceValue</span><span class="token punctuation">(</span>
                    mObject<span class="token punctuation">,</span> resId<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> densityDpi<span class="token punctuation">,</span> outValue<span class="token punctuation">,</span> resolveRefs<span class="token punctuation">)</span><span class="token punctuation">;</span>

            outValue<span class="token punctuation">.</span>changingConfigurations <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span><span class="token function">activityInfoConfigNativeToJava</span><span class="token punctuation">(</span>
                    outValue<span class="token punctuation">.</span>changingConfigurations<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>outValue<span class="token punctuation">.</span>type <span class="token operator">==</span> TypedValue<span class="token punctuation">.</span>TYPE_STRING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                outValue<span class="token punctuation">.</span>string <span class="token operator">=</span> mApkAssets<span class="token punctuation">[</span>cookie <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getStringFromPool</span><span class="token punctuation">(</span>outValue<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里面会调用nativeGetResourceValue获取到Asset的cookie，从底层复制数据到TypedValue中。如果判断到TypedValue中解析出来的数据是String类型，则从全局字符串字符串中获取对应TypeValue中data对应的字符串数据。</p>
<p>那么我们可以推测，如果当前的资源类型是一个字符串(说明找到)，那么nativeGetResourceValue方法实际上并不会赋值给outValue.string。因为可以通过字符串资源池更加快速查找字符串的方法。</p>
<h3 id="获取native层资源id对应的资源"><a href="#获取native层资源id对应的资源" class="headerlink" title="获取native层资源id对应的资源"></a>获取native层资源id对应的资源</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_util_AssetManager.cpp" target="_blank" rel="noopener">android_util_AssetManager.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">using</span> ApkAssetsCookie <span class="token operator">=</span> int32_t<span class="token punctuation">;</span>

<span class="token keyword">enum</span> <span class="token operator">:</span> ApkAssetsCookie <span class="token punctuation">{</span>
  kInvalidCookie <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jint <span class="token function">NativeGetResourceValue</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass <span class="token comment" spellcheck="true">/*clazz*/</span><span class="token punctuation">,</span> jlong ptr<span class="token punctuation">,</span> jint resid<span class="token punctuation">,</span>
                                   jshort density<span class="token punctuation">,</span> jobject typed_value<span class="token punctuation">,</span>
                                   jboolean resolve_references<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ScopedLock<span class="token operator">&lt;</span>AssetManager2<span class="token operator">></span> <span class="token function">assetmanager</span><span class="token punctuation">(</span><span class="token function">AssetManagerFromLong</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Res_value value<span class="token punctuation">;</span>
  ResTable_config selected_config<span class="token punctuation">;</span>
  uint32_t flags<span class="token punctuation">;</span>
  ApkAssetsCookie cookie <span class="token operator">=</span>
      assetmanager<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetResource</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*may_be_bag*/</span><span class="token punctuation">,</span>
                                <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint16_t<span class="token operator">></span><span class="token punctuation">(</span>density<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>selected_config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie <span class="token operator">==</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">ApkAssetsCookieToJavaCookie</span><span class="token punctuation">(</span>kInvalidCookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  uint32_t ref <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve_references<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cookie <span class="token operator">=</span> assetmanager<span class="token operator">-</span><span class="token operator">></span><span class="token function">ResolveReference</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>selected_config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie <span class="token operator">==</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">ApkAssetsCookieToJavaCookie</span><span class="token punctuation">(</span>kInvalidCookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">CopyValue</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cookie<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>selected_config<span class="token punctuation">,</span> typed_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在里面设计到一个比较核心的结构体ApkAssetsCookie。这个对象是在构建动态资源映射表时候，按照顺序递增加入到packageGroup中。这个结构体能看到，是十分简单的只包含一个int类型。</p>
<p>换句话说，ApkAssetsCookie对应到Java层的Cookie实际上就是指当前的资源来源于packageGroup中cookie的index，注意加入逻辑，cookie添加的顺序实际上和package数据包添加的顺序是一致，也就是说，可以通过这个cookief反向查找package数据包。</p>
<p>能看到这里面有一个比较核心的方法，assetmanager-&gt;GetResource。</p>
<h3 id="AssetManager2-GetResource"><a href="#AssetManager2-GetResource" class="headerlink" title="AssetManager2 GetResource"></a>AssetManager2 GetResource</h3><p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/" target="_blank" rel="noopener">androidfw</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/AssetManager2.cpp" target="_blank" rel="noopener">AssetManager2.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">ApkAssetsCookie AssetManager2<span class="token operator">::</span><span class="token function">GetResource</span><span class="token punctuation">(</span>uint32_t resid<span class="token punctuation">,</span> <span class="token keyword">bool</span> may_be_bag<span class="token punctuation">,</span>
                                           uint16_t density_override<span class="token punctuation">,</span> Res_value<span class="token operator">*</span> out_value<span class="token punctuation">,</span>
                                           ResTable_config<span class="token operator">*</span> out_selected_config<span class="token punctuation">,</span>
                                           uint32_t<span class="token operator">*</span> out_flags<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  FindEntryResult entry<span class="token punctuation">;</span>
  ApkAssetsCookie cookie <span class="token operator">=</span>
      <span class="token function">FindEntry</span><span class="token punctuation">(</span>resid<span class="token punctuation">,</span> density_override<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* stop_at_first_match */</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie <span class="token operator">==</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> kInvalidCookie<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dtohs</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>entry<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">)</span> <span class="token operator">&amp;</span> ResTable_entry<span class="token operator">::</span>FLAG_COMPLEX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>may_be_bag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> kInvalidCookie<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Create a reference since we can't represent this complex type as a Res_value.</span>
    out_value<span class="token operator">-</span><span class="token operator">></span>dataType <span class="token operator">=</span> Res_value<span class="token operator">::</span>TYPE_REFERENCE<span class="token punctuation">;</span>
    out_value<span class="token operator">-</span><span class="token operator">></span>data <span class="token operator">=</span> resid<span class="token punctuation">;</span>
    <span class="token operator">*</span>out_selected_config <span class="token operator">=</span> entry<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
    <span class="token operator">*</span>out_flags <span class="token operator">=</span> entry<span class="token punctuation">.</span>type_flags<span class="token punctuation">;</span>
    <span class="token keyword">return</span> cookie<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> Res_value<span class="token operator">*</span> device_value <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> Res_value<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> uint8_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>entry<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">dtohs</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>entry<span class="token operator">-</span><span class="token operator">></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  out_value<span class="token operator">-</span><span class="token operator">></span><span class="token function">copyFrom_dtoh</span><span class="token punctuation">(</span><span class="token operator">*</span>device_value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Convert the package ID to the runtime assigned package ID.</span>
  entry<span class="token punctuation">.</span>dynamic_ref_table<span class="token operator">-</span><span class="token operator">></span><span class="token function">lookupResourceValue</span><span class="token punctuation">(</span>out_value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">*</span>out_selected_config <span class="token operator">=</span> entry<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
  <span class="token operator">*</span>out_flags <span class="token operator">=</span> entry<span class="token punctuation">.</span>type_flags<span class="token punctuation">;</span>
  <span class="token keyword">return</span> cookie<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法中包含了两种情况：</p>
<ul>
<li><p>1.当当前的引用属于比较复杂的时候，是一个引用，并非真实的资源数据，则data返回的是当前引用中的resid。</p>
</li>
<li><p>2.通过FindEntry，查找每一个资源的entry，还记得上面说过的，每一个entry会包含真实的资源数据，这个时候out_value会获取当前entry中的真实数据。接着会覆盖当前的资源id，以及相关的配置等信息。</p>
</li>
</ul>
<h4 id="FindEntry查找资源Entry"><a href="#FindEntry查找资源Entry" class="headerlink" title="FindEntry查找资源Entry"></a>FindEntry查找资源Entry</h4><pre class="line-numbers language-cpp"><code class="language-cpp">ApkAssetsCookie AssetManager2<span class="token operator">::</span><span class="token function">FindEntry</span><span class="token punctuation">(</span>uint32_t resid<span class="token punctuation">,</span> uint16_t density_override<span class="token punctuation">,</span>
                                         <span class="token keyword">bool</span> <span class="token comment" spellcheck="true">/*stop_at_first_match*/</span><span class="token punctuation">,</span>
                                         FindEntryResult<span class="token operator">*</span> out_entry<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Might use this if density_override != 0.</span>
  ResTable_config density_override_config<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Select our configuration or generate a density override configuration.</span>
  <span class="token keyword">const</span> ResTable_config<span class="token operator">*</span> desired_config <span class="token operator">=</span> <span class="token operator">&amp;</span>configuration_<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>density_override <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> density_override <span class="token operator">!=</span> configuration_<span class="token punctuation">.</span>density<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    density_override_config <span class="token operator">=</span> configuration_<span class="token punctuation">;</span>
    density_override_config<span class="token punctuation">.</span>density <span class="token operator">=</span> density_override<span class="token punctuation">;</span>
    desired_config <span class="token operator">=</span> <span class="token operator">&amp;</span>density_override_config<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_valid_resid</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> base<span class="token operator">::</span><span class="token function">StringPrintf</span><span class="token punctuation">(</span><span class="token string">"Invalid ID 0x%08x."</span><span class="token punctuation">,</span> resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> kInvalidCookie<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> uint32_t package_id <span class="token operator">=</span> <span class="token function">get_package_id</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> uint8_t type_idx <span class="token operator">=</span> <span class="token function">get_type_id</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> uint16_t entry_idx <span class="token operator">=</span> <span class="token function">get_entry_id</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> uint8_t package_idx <span class="token operator">=</span> package_ids_<span class="token punctuation">[</span>package_id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>package_idx <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> kInvalidCookie<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> PackageGroup<span class="token operator">&amp;</span> package_group <span class="token operator">=</span> package_groups_<span class="token punctuation">[</span>package_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t package_count <span class="token operator">=</span> package_group<span class="token punctuation">.</span>packages_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ApkAssetsCookie best_cookie <span class="token operator">=</span> kInvalidCookie<span class="token punctuation">;</span>
  <span class="token keyword">const</span> LoadedPackage<span class="token operator">*</span> best_package <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ResTable_type<span class="token operator">*</span> best_type <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ResTable_config<span class="token operator">*</span> best_config <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  ResTable_config best_config_copy<span class="token punctuation">;</span>
  uint32_t best_offset <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>
  uint32_t type_flags <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// If desired_config is the same as the set configuration, then we can use our filtered list</span>
  <span class="token comment" spellcheck="true">// and we don't need to match the configurations, since they already matched.</span>
  <span class="token keyword">const</span> <span class="token keyword">bool</span> use_fast_path <span class="token operator">=</span> desired_config <span class="token operator">==</span> <span class="token operator">&amp;</span>configuration_<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t pi <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pi <span class="token operator">&lt;</span> package_count<span class="token punctuation">;</span> pi<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ConfiguredPackage<span class="token operator">&amp;</span> loaded_package_impl <span class="token operator">=</span> package_group<span class="token punctuation">.</span>packages_<span class="token punctuation">[</span>pi<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> LoadedPackage<span class="token operator">*</span> loaded_package <span class="token operator">=</span> loaded_package_impl<span class="token punctuation">.</span>loaded_package_<span class="token punctuation">;</span>
    ApkAssetsCookie cookie <span class="token operator">=</span> package_group<span class="token punctuation">.</span>cookies_<span class="token punctuation">[</span>pi<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// If the type IDs are offset in this package, we need to take that into account when searching</span>
    <span class="token comment" spellcheck="true">// for a type.</span>
    <span class="token keyword">const</span> TypeSpec<span class="token operator">*</span> type_spec <span class="token operator">=</span> loaded_package<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTypeSpecByTypeIndex</span><span class="token punctuation">(</span>type_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>type_spec <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    uint16_t local_entry_idx <span class="token operator">=</span> entry_idx<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// If there is an IDMAP supplied with this package, translate the entry ID.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type_spec<span class="token operator">-</span><span class="token operator">></span>idmap_entries <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>LoadedIdmap<span class="token operator">::</span><span class="token function">Lookup</span><span class="token punctuation">(</span>type_spec<span class="token operator">-</span><span class="token operator">></span>idmap_entries<span class="token punctuation">,</span> local_entry_idx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>local_entry_idx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// There is no mapping, so the resource is not meant to be in this overlay package.</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    type_flags <span class="token operator">|</span><span class="token operator">=</span> type_spec<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFlagsForEntryIndex</span><span class="token punctuation">(</span>local_entry_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// If the package is an overlay, then even configurations that are the same MUST be chosen.</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> package_is_overlay <span class="token operator">=</span> loaded_package<span class="token operator">-</span><span class="token operator">></span><span class="token function">IsOverlay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> FilteredConfigGroup<span class="token operator">&amp;</span> filtered_group <span class="token operator">=</span> loaded_package_impl<span class="token punctuation">.</span>filtered_configs_<span class="token punctuation">[</span>type_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>use_fast_path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>ResTable_config<span class="token operator">></span><span class="token operator">&amp;</span> candidate_configs <span class="token operator">=</span> filtered_group<span class="token punctuation">.</span>configurations<span class="token punctuation">;</span>
      <span class="token keyword">const</span> size_t type_count <span class="token operator">=</span> candidate_configs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>uint32_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> type_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> ResTable_config<span class="token operator">&amp;</span> this_config <span class="token operator">=</span> candidate_configs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// We can skip calling ResTable_config::match() because we know that all candidate</span>
        <span class="token comment" spellcheck="true">// configurations that do NOT match have been filtered-out.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>best_config <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> this_config<span class="token punctuation">.</span><span class="token function">isBetterThan</span><span class="token punctuation">(</span><span class="token operator">*</span>best_config<span class="token punctuation">,</span> desired_config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>package_is_overlay <span class="token operator">&amp;&amp;</span> this_config<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token operator">*</span>best_config<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> ResTable_type<span class="token operator">*</span> type_chunk <span class="token operator">=</span> filtered_group<span class="token punctuation">.</span>types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> uint32_t offset <span class="token operator">=</span> LoadedPackage<span class="token operator">::</span><span class="token function">GetEntryOffset</span><span class="token punctuation">(</span>type_chunk<span class="token punctuation">,</span> local_entry_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">==</span> ResTable_type<span class="token operator">::</span>NO_ENTRY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          best_cookie <span class="token operator">=</span> cookie<span class="token punctuation">;</span>
          best_package <span class="token operator">=</span> loaded_package<span class="token punctuation">;</span>
          best_type <span class="token operator">=</span> type_chunk<span class="token punctuation">;</span>
          best_config <span class="token operator">=</span> <span class="token operator">&amp;</span>this_config<span class="token punctuation">;</span>
          best_offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

      <span class="token keyword">const</span> <span class="token keyword">auto</span> iter_end <span class="token operator">=</span> type_spec<span class="token operator">-</span><span class="token operator">></span>types <span class="token operator">+</span> type_spec<span class="token operator">-</span><span class="token operator">></span>type_count<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> iter <span class="token operator">=</span> type_spec<span class="token operator">-</span><span class="token operator">></span>types<span class="token punctuation">;</span> iter <span class="token operator">!=</span> iter_end<span class="token punctuation">;</span> <span class="token operator">++</span>iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ResTable_config this_config<span class="token punctuation">;</span>
        this_config<span class="token punctuation">.</span><span class="token function">copyFromDtoH</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>iter<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>this_config<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token operator">*</span>desired_config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>best_config <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> this_config<span class="token punctuation">.</span><span class="token function">isBetterThan</span><span class="token punctuation">(</span><span class="token operator">*</span>best_config<span class="token punctuation">,</span> desired_config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
              <span class="token punctuation">(</span>package_is_overlay <span class="token operator">&amp;&amp;</span> this_config<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token operator">*</span>best_config<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> uint32_t offset <span class="token operator">=</span> LoadedPackage<span class="token operator">::</span><span class="token function">GetEntryOffset</span><span class="token punctuation">(</span><span class="token operator">*</span>iter<span class="token punctuation">,</span> local_entry_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">==</span> ResTable_type<span class="token operator">::</span>NO_ENTRY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            best_cookie <span class="token operator">=</span> cookie<span class="token punctuation">;</span>
            best_package <span class="token operator">=</span> loaded_package<span class="token punctuation">;</span>
            best_type <span class="token operator">=</span> <span class="token operator">*</span>iter<span class="token punctuation">;</span>
            best_config_copy <span class="token operator">=</span> this_config<span class="token punctuation">;</span>
            best_config <span class="token operator">=</span> <span class="token operator">&amp;</span>best_config_copy<span class="token punctuation">;</span>
            best_offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>best_cookie <span class="token operator">==</span> kInvalidCookie<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> kInvalidCookie<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> ResTable_entry<span class="token operator">*</span> best_entry <span class="token operator">=</span> LoadedPackage<span class="token operator">::</span><span class="token function">GetEntryFromOffset</span><span class="token punctuation">(</span>best_type<span class="token punctuation">,</span> best_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>best_entry <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> kInvalidCookie<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  out_entry<span class="token operator">-</span><span class="token operator">></span>entry <span class="token operator">=</span> best_entry<span class="token punctuation">;</span>
  out_entry<span class="token operator">-</span><span class="token operator">></span>config <span class="token operator">=</span> <span class="token operator">*</span>best_config<span class="token punctuation">;</span>
  out_entry<span class="token operator">-</span><span class="token operator">></span>type_flags <span class="token operator">=</span> type_flags<span class="token punctuation">;</span>
  out_entry<span class="token operator">-</span><span class="token operator">></span>type_string_ref <span class="token operator">=</span> <span class="token function">StringPoolRef</span><span class="token punctuation">(</span>best_package<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTypeStringPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> best_type<span class="token operator">-</span><span class="token operator">></span>id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  out_entry<span class="token operator">-</span><span class="token operator">></span>entry_string_ref <span class="token operator">=</span>
      <span class="token function">StringPoolRef</span><span class="token punctuation">(</span>best_package<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetKeyStringPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> best_entry<span class="token operator">-</span><span class="token operator">></span>key<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  out_entry<span class="token operator">-</span><span class="token operator">></span>dynamic_ref_table <span class="token operator">=</span> <span class="token operator">&amp;</span>package_group<span class="token punctuation">.</span>dynamic_ref_table<span class="token punctuation">;</span>
  <span class="token keyword">return</span> best_cookie<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里，我们先回顾一下资源ID的组成：</p>
<blockquote>
<p>资源ID：0xPPTTEEEE  。最高两位PP是指PackageID，一般编译之后，应用资源包是0x7f，系统资源包是0x01，而第三方资源包，则是从0x02开始逐个递增。接下来的两位TT，代表着当前资源类型id，如anim文件夹下的资源就是0x01,组合起来就是0x7f01.最后四位是指资源entryID，是指的资源每一项对应的id，可能是0000，一般是按照资源编译顺序递增，如果是0001，则当前资源完整就是0x7f010001.</p>
</blockquote>
<p>而这个方法就需要寻找通过资源id去寻找正确的资源。步骤如下：</p>
<ul>
<li>1.解析当前资源id中packageID，typeID，entryID</li>
<li>2.获取AssetManager2中的packageID对应的packageGroup，在这个packageGroup中，根据typeID寻找对应资源类型。如果发现typeSpec中有idmap说明有id需要被覆盖，就尝试通过Loadedmap::Lookup，转化一下entryID(从IdEntryMap的数组获取对应entry数组中的id)，接着从ConfiguredPackage获取到对应的package数据。</li>
</ul>
<p>接下来有两种情况，一种是和原来的配置config一致，一种是不一致。</p>
<ul>
<li><p>1.一致的情况下，在ConfiguredPackage中存放着在根据config已经过滤好的资源列表，直接从里面循环直接拿到对应资源Type，并调用方法GetEntryOffset根据资源entryId获取对应的资源entry对象。</p>
</li>
<li><ol start="2">
<li>不一致的情况下，则循环typeSpec中映射好的资源关系，先寻找合适的config接着在尝试寻找有没有对应的entryID。</li>
</ol>
</li>
<li><p>最后确定已经存在了资源的存在，则会通过当前的资源类型以及资源类型中的偏移数组通过方法GetEntryFromOffset获取对应的entry。</p>
</li>
</ul>
<p>最后返回当前的cookie。</p>
<h4 id="通过id寻找是否存在对应的entry"><a href="#通过id寻找是否存在对应的entry" class="headerlink" title="通过id寻找是否存在对应的entry"></a>通过id寻找是否存在对应的entry</h4><p>文件；/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/" target="_blank" rel="noopener">androidfw</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/LoadedArsc.cpp" target="_blank" rel="noopener">LoadedArsc.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">uint32_t LoadedPackage<span class="token operator">::</span><span class="token function">GetEntryOffset</span><span class="token punctuation">(</span><span class="token keyword">const</span> ResTable_type<span class="token operator">*</span> type_chunk<span class="token punctuation">,</span> uint16_t entry_index<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> size_t entry_count <span class="token operator">=</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>type_chunk<span class="token operator">-</span><span class="token operator">></span>entryCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t offsets_offset <span class="token operator">=</span> <span class="token function">dtohs</span><span class="token punctuation">(</span>type_chunk<span class="token operator">-</span><span class="token operator">></span>header<span class="token punctuation">.</span>headerSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">const</span> uint32_t<span class="token operator">*</span> entry_offsets <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> uint32_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> uint8_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>type_chunk<span class="token punctuation">)</span> <span class="token operator">+</span> offsets_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>entry_offsets<span class="token punctuation">[</span>entry_index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到通过获取资源ResTable_type起始地址+ResTable_type的头部大小+头部起点地址，来找到entry偏移数组。<br><img src="/images/%E5%AF%BB%E6%89%BERes_table_entry.png" alt="寻找Res_table_entry.png"><br>通过偏移数组中的结果来确定当前的entry是否存在。</p>
<h4 id="GetEntryFromOffset-查找具体的内容"><a href="#GetEntryFromOffset-查找具体的内容" class="headerlink" title="GetEntryFromOffset 查找具体的内容"></a>GetEntryFromOffset 查找具体的内容</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">const</span> ResTable_entry<span class="token operator">*</span> LoadedPackage<span class="token operator">::</span><span class="token function">GetEntryFromOffset</span><span class="token punctuation">(</span><span class="token keyword">const</span> ResTable_type<span class="token operator">*</span> type_chunk<span class="token punctuation">,</span>
                                                        uint32_t offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> ResTable_entry<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> uint8_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>type_chunk<span class="token punctuation">)</span> <span class="token operator">+</span>
                                                 offset <span class="token operator">+</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>type_chunk<span class="token operator">-</span><span class="token operator">></span>entriesStart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为在type中记录对应entry中数据的偏移量，因此，可以通过简单的相加找到对应的地址。<br><img src="/images/%E5%AF%BB%E6%89%BERes_table_entry2.png" alt="寻找Res_table_entry2.png"></p>
<p>而entry当中就有一个Res_value对象.这个对象保存着真实的数据，最后会通过CopyValue的方法，把Res_value.data拷贝到TypeValue中。此时就拥有了当前资源真实数据。换到当前情景就是指，找到了布局文件,layout/xxx.xml字符串对应的index。</p>
<h4 id="通过cookie以及解析资源信息尝试查找非Asset资源中具体内容"><a href="#通过cookie以及解析资源信息尝试查找非Asset资源中具体内容" class="headerlink" title="通过cookie以及解析资源信息尝试查找非Asset资源中具体内容"></a>通过cookie以及解析资源信息尝试查找非Asset资源中具体内容</h4><p>上一个步骤中已经准备好了资源包对应的cookie，确认了资源的存在以及位置，可以尝试的着读取数据。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/" target="_blank" rel="noopener">res</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/ResourcesImpl.java" target="_blank" rel="noopener">ResourcesImpl.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    XmlResourceParser <span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> String file<span class="token punctuation">,</span> <span class="token annotation punctuation">@AnyRes</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> assetCookie<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> String type<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mCachedXmlBlocks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cachedXmlBlockCookies <span class="token operator">=</span> mCachedXmlBlockCookies<span class="token punctuation">;</span>
                    <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> cachedXmlBlockFiles <span class="token operator">=</span> mCachedXmlBlockFiles<span class="token punctuation">;</span>
                    <span class="token keyword">final</span> XmlBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> cachedXmlBlocks <span class="token operator">=</span> mCachedXmlBlocks<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// First see if this block is in our cache.</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> num <span class="token operator">=</span> cachedXmlBlockFiles<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedXmlBlockCookies<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> assetCookie <span class="token operator">&amp;&amp;</span> cachedXmlBlockFiles<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> null
                                <span class="token operator">&amp;&amp;</span> cachedXmlBlockFiles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> cachedXmlBlocks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">newParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>


                    <span class="token keyword">final</span> XmlBlock block <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">openXmlBlockAsset</span><span class="token punctuation">(</span>assetCookie<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> <span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token punctuation">(</span>mLastCachedXmlBlockIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> num<span class="token punctuation">;</span>
                        mLastCachedXmlBlockIndex <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                        <span class="token keyword">final</span> XmlBlock oldBlock <span class="token operator">=</span> cachedXmlBlocks<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldBlock <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            oldBlock<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        cachedXmlBlockCookies<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> assetCookie<span class="token punctuation">;</span>
                        cachedXmlBlockFiles<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> file<span class="token punctuation">;</span>
                        cachedXmlBlocks<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> block<span class="token punctuation">;</span>
                        <span class="token keyword">return</span> block<span class="token punctuation">.</span><span class="token function">newParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看见在整个ResourcesImpl中会对所有加载过的Xml文件有一层mCachedXmlBlockFiles缓存，如果找不到则会尝试着通过openXmlBlockAsset从native查找数据。最后会通过XmlBlock生成解析器。</p>
<p>我们看看AssetManager的openXmlBlockAsset方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@NonNull</span> XmlBlock <span class="token function">openXmlBlockAsset</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> String fileName<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token string">"fileName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ensureOpenLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> xmlBlock <span class="token operator">=</span> <span class="token function">nativeOpenXmlAsset</span><span class="token punctuation">(</span>mObject<span class="token punctuation">,</span> cookie<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>xmlBlock <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FileNotFoundException</span><span class="token punctuation">(</span><span class="token string">"Asset XML file: "</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> XmlBlock block <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XmlBlock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> xmlBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">incRefsLocked</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> block<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法会调用native方法 nativeOpenXmlAsset。这个方法最后会获取native层数据块对应的地址，并且交给XmlBlock进行操控。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_util_AssetManager.cpp" target="_blank" rel="noopener">android_util_AssetManager.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jlong <span class="token function">NativeOpenXmlAsset</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject <span class="token comment" spellcheck="true">/*clazz*/</span><span class="token punctuation">,</span> jlong ptr<span class="token punctuation">,</span> jint jcookie<span class="token punctuation">,</span>
                                jstring asset_path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ApkAssetsCookie cookie <span class="token operator">=</span> <span class="token function">JavaCookieToApkAssetsCookie</span><span class="token punctuation">(</span>jcookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ScopedUtfChars <span class="token function">asset_path_utf8</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> asset_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  ScopedLock<span class="token operator">&lt;</span>AssetManager2<span class="token operator">></span> <span class="token function">assetmanager</span><span class="token punctuation">(</span><span class="token function">AssetManagerFromLong</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Asset<span class="token operator">></span> asset<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie <span class="token operator">!=</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    asset <span class="token operator">=</span> assetmanager<span class="token operator">-</span><span class="token operator">></span><span class="token function">OpenNonAsset</span><span class="token punctuation">(</span>asset_path_utf8<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cookie<span class="token punctuation">,</span> Asset<span class="token operator">::</span>ACCESS_RANDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    asset <span class="token operator">=</span> assetmanager<span class="token operator">-</span><span class="token operator">></span><span class="token function">OpenNonAsset</span><span class="token punctuation">(</span>asset_path_utf8<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Asset<span class="token operator">::</span>ACCESS_RANDOM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">const</span> DynamicRefTable<span class="token operator">*</span> dynamic_ref_table <span class="token operator">=</span> assetmanager<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetDynamicRefTableForCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>ResXMLTree<span class="token operator">></span> xml_tree <span class="token operator">=</span> util<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>ResXMLTree<span class="token operator">></span><span class="token punctuation">(</span>dynamic_ref_table<span class="token punctuation">)</span><span class="token punctuation">;</span>
  status_t err <span class="token operator">=</span> xml_tree<span class="token operator">-</span><span class="token operator">></span><span class="token function">setTo</span><span class="token punctuation">(</span>asset<span class="token operator">-</span><span class="token operator">></span><span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> asset<span class="token operator">-</span><span class="token operator">></span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  asset<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>jlong<span class="token operator">></span><span class="token punctuation">(</span>xml_tree<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里大致上分为如下几个步骤：</p>
<ul>
<li>1.通过OpenNonAsset读取资源名称对应的Asset</li>
<li>2.获取AssetManager2的动态映射表，并且把cookie对应的动态映射表转化为ResXMLTree，读取asset中对应的数据，设置到ResXMLTree中。等待解析。</li>
</ul>
<h4 id="OpenNonAsset读取资源名称对应的Asset"><a href="#OpenNonAsset读取资源名称对应的Asset" class="headerlink" title="OpenNonAsset读取资源名称对应的Asset"></a>OpenNonAsset读取资源名称对应的Asset</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/" target="_blank" rel="noopener">androidfw</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/AssetManager2.cpp" target="_blank" rel="noopener">AssetManager2.cpp</a><br>这个方法是要打开所有非Asset资源对象，这种资源还是以zip的entry方式读取出来。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Asset<span class="token operator">></span> AssetManager2<span class="token operator">::</span><span class="token function">OpenNonAsset</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> filename<span class="token punctuation">,</span>
                                                   Asset<span class="token operator">::</span>AccessMode mode<span class="token punctuation">,</span>
                                                   ApkAssetsCookie<span class="token operator">*</span> out_cookie<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>int32_t i <span class="token operator">=</span> apk_assets_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Asset<span class="token operator">></span> asset <span class="token operator">=</span> apk_assets_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">Open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>asset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>out_cookie <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>out_cookie <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> asset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>out_cookie <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>out_cookie <span class="token operator">=</span> kInvalidCookie<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>循环每一个AssetManager2管理的ApkAsset对象，获取对应资源Asset。此时的Asset，就是之前我们nativeLoad的时候解析resource.arsc生成的对象。</p>
<p>而方法名中的Asset的这个Asset并非是native层的解析resource.arsc的Asset资源，而是指Asset文件夹</p>
<h4 id="ApkAssets-Open"><a href="#ApkAssets-Open" class="headerlink" title="ApkAssets::Open"></a>ApkAssets::Open</h4><pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Asset<span class="token operator">></span> ApkAssets<span class="token operator">::</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">,</span> Asset<span class="token operator">::</span>AccessMode mode<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token function">CHECK</span><span class="token punctuation">(</span>zip_handle_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">::</span>ZipString <span class="token function">name</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">::</span>ZipEntry entry<span class="token punctuation">;</span>
  int32_t result <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">FindEntry</span><span class="token punctuation">(</span>zip_handle_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>method <span class="token operator">==</span> kCompressDeflated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>FileMap<span class="token operator">></span> map <span class="token operator">=</span> util<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>FileMap<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Asset<span class="token operator">></span> asset <span class="token operator">=</span>
        Asset<span class="token operator">::</span><span class="token function">createFromCompressedMap</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>uncompressed_length<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> asset<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>FileMap<span class="token operator">></span> map <span class="token operator">=</span> util<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>FileMap<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Asset<span class="token operator">></span> asset <span class="token operator">=</span> Asset<span class="token operator">::</span><span class="token function">createFromUncompressedMap</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> asset<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的逻辑其实和之前说过解包resource.arsc的逻辑一样。注意这里这个方法名也叫FindEntry，不过找的是zip包中压缩单位，而不是资源数据中的资源entry。这样就能找到资源的layout布局文件，在资源目录下的数据。</p>
<h4 id="XmlBlock生成解析器"><a href="#XmlBlock生成解析器" class="headerlink" title="XmlBlock生成解析器"></a>XmlBlock生成解析器</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token function">XmlBlock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> AssetManager assets<span class="token punctuation">,</span> <span class="token keyword">long</span> xmlBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mAssets <span class="token operator">=</span> assets<span class="token punctuation">;</span>
        mNative <span class="token operator">=</span> xmlBlock<span class="token punctuation">;</span>
        mStrings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBlock</span><span class="token punctuation">(</span><span class="token function">nativeGetStringBlock</span><span class="token punctuation">(</span>xmlBlock<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时XmlBlock会持有之前从zip包中解析出来的xmlBlock，以及全局字符串，方便之后解析Xml文件。</p>
<p>接下来就是解析一个树状的数据结构，获取里面所有的属性了，这里就不赘述。</p>
<h2 id="AssetManager查找Asset资源"><a href="#AssetManager查找Asset资源" class="headerlink" title="AssetManager查找Asset资源"></a>AssetManager查找Asset资源</h2><p>上面一大段聊了非Asset资源的查找，接下来让我们看看Asset资源的查找。而方法名中的Asset的这个Asset并非是native层的解析resource.arsc的Asset资源，而是指Asset文件夹。</p>
<p>当我们想要打开Asset目录下资源文件的时候，一般会调用如下方法：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token annotation punctuation">@NonNull</span> InputStream <span class="token function">open</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> String fileName<span class="token punctuation">,</span> <span class="token keyword">int</span> accessMode<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token string">"fileName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ensureOpenLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> asset <span class="token operator">=</span> <span class="token function">nativeOpenAsset</span><span class="token punctuation">(</span>mObject<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> accessMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>asset <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FileNotFoundException</span><span class="token punctuation">(</span><span class="token string">"Asset file: "</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> AssetInputStream assetInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AssetInputStream</span><span class="token punctuation">(</span>asset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">incRefsLocked</span><span class="token punctuation">(</span>assetInputStream<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> assetInputStream<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而这个方法最后会调用native层下的如下方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Asset<span class="token operator">></span> AssetManager2<span class="token operator">::</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> filename<span class="token punctuation">,</span> ApkAssetsCookie cookie<span class="token punctuation">,</span>
                                           Asset<span class="token operator">::</span>AccessMode mode<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> std<span class="token operator">::</span>string new_path <span class="token operator">=</span> <span class="token string">"assets/"</span> <span class="token operator">+</span> filename<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">OpenNonAsset</span><span class="token punctuation">(</span>new_path<span class="token punctuation">,</span> cookie<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>系统这种方式，设置了相对路径。一样还是从OpenNonAsset中查找数据。最后会把Asset返回回去。此时AssetInputStream就会尝试着操作这个Asset对象，会持有着对应zipEntry，生成的FileMap。</p>
<p>当我们尝试着读取数据的时候会调用AssetInputStream中的read方法：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_util_AssetManager.cpp" target="_blank" rel="noopener">android_util_AssetManager.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jint <span class="token function">NativeAssetReadChar</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> <span class="token comment" spellcheck="true">/*env*/</span><span class="token punctuation">,</span> jclass <span class="token comment" spellcheck="true">/*clazz*/</span><span class="token punctuation">,</span> jlong asset_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Asset<span class="token operator">*</span> asset <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Asset<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>asset_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  uint8_t b<span class="token punctuation">;</span>
  ssize_t res <span class="token operator">=</span> asset<span class="token operator">-</span><span class="token operator">></span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>jint<span class="token operator">></span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="资源属性的获取"><a href="#资源属性的获取" class="headerlink" title="资源属性的获取"></a>资源属性的获取</h2><p>在资源管理体系中，还有一个很重要的知识点，那就是解析View标签中写的属性。在此之前，想要理解整个资源Theme属性是如何获取的，先来看看Theme是如何初始化的。</p>
<h3 id="Theme的初始化"><a href="#Theme的初始化" class="headerlink" title="Theme的初始化"></a>Theme的初始化</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ActivityThread.java" target="_blank" rel="noopener">ActivityThread.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> Activity <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span>ActivityClientRecord r<span class="token punctuation">,</span> Intent customIntent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">int</span> theme <span class="token operator">=</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span><span class="token function">getThemeResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>theme <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    activity<span class="token punctuation">.</span><span class="token function">setTheme</span><span class="token punctuation">(</span>theme<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一般在Activity的onCreate的生命周期，会调用setTheme设置从Xml中解析出来的主题Theme。而这个方法最后会调用到ContextImpl中：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTheme</span><span class="token punctuation">(</span><span class="token keyword">int</span> resId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mThemeResource <span class="token operator">!=</span> resId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mThemeResource <span class="token operator">=</span> resId<span class="token punctuation">;</span>
                <span class="token function">initializeTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initializeTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTheme <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTheme <span class="token operator">=</span> mResources<span class="token punctuation">.</span><span class="token function">newTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mTheme<span class="token punctuation">.</span><span class="token function">applyStyle</span><span class="token punctuation">(</span>mThemeResource<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到其实整个主题是有一个Theme对象在控制，最后才把resID设置到Theme对象中进去。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/" target="_blank" rel="noopener">res</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/Resources.java" target="_blank" rel="noopener">Resources.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> Theme <span class="token function">newTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Theme theme <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Theme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        theme<span class="token punctuation">.</span><span class="token function">setImpl</span><span class="token punctuation">(</span>mResourcesImpl<span class="token punctuation">.</span><span class="token function">newThemeImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mThemeRefs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mThemeRefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>theme<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mThemeRefs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> mThemeRefsNextFlushSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mThemeRefs<span class="token punctuation">.</span><span class="token function">removeIf</span><span class="token punctuation">(</span>ref <span class="token operator">-</span><span class="token operator">></span> ref<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mThemeRefsNextFlushSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>MIN_THEME_REFS_FLUSH_SIZE<span class="token punctuation">,</span>
                        <span class="token number">2</span> <span class="token operator">*</span> mThemeRefs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> theme<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在Resources中，能看到每一个主题都换缓存到弱引用下来，方便下次查找。核心方法是实例化了一个ThemeImpl对象。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/" target="_blank" rel="noopener">res</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/ResourcesImpl.java" target="_blank" rel="noopener">ResourcesImpl.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    ThemeImpl <span class="token function">newThemeImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThemeImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThemeImpl</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/**
         * Unique key for the series of styles applied to this theme.
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> Resources<span class="token punctuation">.</span>ThemeKey mKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resources<span class="token punctuation">.</span>ThemeKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"hiding"</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> AssetManager mAssets<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> mTheme<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Resource identifier for the theme.
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> mThemeResId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*package*/</span> <span class="token function">ThemeImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAssets <span class="token operator">=</span> ResourcesImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mAssets<span class="token punctuation">;</span>
            mTheme <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">createTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/" target="_blank" rel="noopener">res</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/AssetManager.java" target="_blank" rel="noopener">AssetManager.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">long</span> <span class="token function">createTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ensureValidLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> themePtr <span class="token operator">=</span> <span class="token function">nativeThemeCreate</span><span class="token punctuation">(</span>mObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">incRefsLocked</span><span class="token punctuation">(</span>themePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> themePtr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用native方法实例化底层的Theme对象.</p>
<p>文件；/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_util_AssetManager.cpp" target="_blank" rel="noopener">android_util_AssetManager.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jlong <span class="token function">NativeThemeCreate</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> <span class="token comment" spellcheck="true">/*env*/</span><span class="token punctuation">,</span> jclass <span class="token comment" spellcheck="true">/*clazz*/</span><span class="token punctuation">,</span> jlong ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ScopedLock<span class="token operator">&lt;</span>AssetManager2<span class="token operator">></span> <span class="token function">assetmanager</span><span class="token punctuation">(</span><span class="token function">AssetManagerFromLong</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>jlong<span class="token operator">></span><span class="token punctuation">(</span>assetmanager<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Theme<span class="token operator">></span> AssetManager2<span class="token operator">::</span><span class="token function">NewTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Theme<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Theme</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这样就对应着Java层中ThemeImpl，在native中同样生成一样的Theme。</p>
<h3 id="ThemeImpl-applyStyle"><a href="#ThemeImpl-applyStyle" class="headerlink" title="ThemeImpl.applyStyle"></a>ThemeImpl.applyStyle</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/" target="_blank" rel="noopener">res</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/ResourcesImpl.java" target="_blank" rel="noopener">ResourcesImpl.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">void</span> <span class="token function">applyStyle</span><span class="token punctuation">(</span><span class="token keyword">int</span> resId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mAssets<span class="token punctuation">.</span><span class="token function">applyStyleToTheme</span><span class="token punctuation">(</span>mTheme<span class="token punctuation">,</span> resId<span class="token punctuation">,</span> force<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mThemeResId <span class="token operator">=</span> resId<span class="token punctuation">;</span>
                mKey<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>resId<span class="token punctuation">,</span> force<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/" target="_blank" rel="noopener">res</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/AssetManager.java" target="_blank" rel="noopener">AssetManager.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">applyStyleToTheme</span><span class="token punctuation">(</span><span class="token keyword">long</span> themePtr<span class="token punctuation">,</span> <span class="token annotation punctuation">@StyleRes</span> <span class="token keyword">int</span> resId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ensureValidLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">nativeThemeApplyStyle</span><span class="token punctuation">(</span>mObject<span class="token punctuation">,</span> themePtr<span class="token punctuation">,</span> resId<span class="token punctuation">,</span> force<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NativeThemeApplyStyle</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass <span class="token comment" spellcheck="true">/*clazz*/</span><span class="token punctuation">,</span> jlong ptr<span class="token punctuation">,</span> jlong theme_ptr<span class="token punctuation">,</span>
                                  jint resid<span class="token punctuation">,</span> jboolean force<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  ScopedLock<span class="token operator">&lt;</span>AssetManager2<span class="token operator">></span> <span class="token function">assetmanager</span><span class="token punctuation">(</span><span class="token function">AssetManagerFromLong</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Theme<span class="token operator">*</span> theme <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Theme<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>theme_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK</span><span class="token punctuation">(</span>theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetAssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>assetmanager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> assetmanager<span class="token punctuation">;</span>
  theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">ApplyStyle</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">,</span> force<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到在设置Theme过程中，核心方法是Theme的ApplyStyle。</p>
<h4 id="Theme的ApplyStyle"><a href="#Theme的ApplyStyle" class="headerlink" title="Theme的ApplyStyle"></a>Theme的ApplyStyle</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/" target="_blank" rel="noopener">androidfw</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/AssetManager2.cpp" target="_blank" rel="noopener">AssetManager2.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> Theme<span class="token operator">::</span><span class="token function">ApplyStyle</span><span class="token punctuation">(</span>uint32_t resid<span class="token punctuation">,</span> <span class="token keyword">bool</span> force<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> ResolvedBag<span class="token operator">*</span> bag <span class="token operator">=</span> asset_manager_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetBag</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>

  type_spec_flags_ <span class="token operator">|</span><span class="token operator">=</span> bag<span class="token operator">-</span><span class="token operator">></span>type_spec_flags<span class="token punctuation">;</span>

  <span class="token keyword">int</span> last_type_idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> last_package_idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  Package<span class="token operator">*</span> last_package <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  ThemeType<span class="token operator">*</span> last_type <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

  <span class="token keyword">using</span> reverse_bag_iterator <span class="token operator">=</span> std<span class="token operator">::</span>reverse_iterator<span class="token operator">&lt;</span><span class="token keyword">const</span> ResolvedBag<span class="token operator">::</span>Entry<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">auto</span> bag_iter_end <span class="token operator">=</span> <span class="token function">reverse_bag_iterator</span><span class="token punctuation">(</span><span class="token function">begin</span><span class="token punctuation">(</span>bag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> bag_iter <span class="token operator">=</span> <span class="token function">reverse_bag_iterator</span><span class="token punctuation">(</span><span class="token function">end</span><span class="token punctuation">(</span>bag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> bag_iter <span class="token operator">!=</span> bag_iter_end<span class="token punctuation">;</span> <span class="token operator">++</span>bag_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> uint32_t attr_resid <span class="token operator">=</span> bag_iter<span class="token operator">-</span><span class="token operator">></span>key<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> package_idx <span class="token operator">=</span> <span class="token function">get_package_id</span><span class="token punctuation">(</span>attr_resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> type_idx <span class="token operator">=</span> <span class="token function">get_type_id</span><span class="token punctuation">(</span>attr_resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> entry_idx <span class="token operator">=</span> <span class="token function">get_entry_id</span><span class="token punctuation">(</span>attr_resid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>last_package_idx <span class="token operator">!=</span> package_idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Package<span class="token operator">></span><span class="token operator">&amp;</span> package <span class="token operator">=</span> packages_<span class="token punctuation">[</span>package_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>package <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        package<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Package</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      last_package_idx <span class="token operator">=</span> package_idx<span class="token punctuation">;</span>
      last_package <span class="token operator">=</span> package<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      last_type_idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>last_type_idx <span class="token operator">!=</span> type_idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      util<span class="token operator">::</span>unique_cptr<span class="token operator">&lt;</span>ThemeType<span class="token operator">></span><span class="token operator">&amp;</span> type <span class="token operator">=</span> last_package<span class="token operator">-</span><span class="token operator">></span>types<span class="token punctuation">[</span>type_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>ThemeType<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>
            <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ThemeType<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>entry_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ThemeEntry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        type<span class="token operator">-</span><span class="token operator">></span>entry_count <span class="token operator">=</span> entry_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>entry_idx <span class="token operator">>=</span> type<span class="token operator">-</span><span class="token operator">></span>entry_count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> new_count <span class="token operator">=</span> entry_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        type<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>ThemeType<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>
            <span class="token function">realloc</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ThemeType<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>new_count <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ThemeEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">memset</span><span class="token punctuation">(</span>type<span class="token operator">-</span><span class="token operator">></span>entries <span class="token operator">+</span> type<span class="token operator">-</span><span class="token operator">></span>entry_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
               <span class="token punctuation">(</span>new_count <span class="token operator">-</span> type<span class="token operator">-</span><span class="token operator">></span>entry_count<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ThemeEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        type<span class="token operator">-</span><span class="token operator">></span>entry_count <span class="token operator">=</span> new_count<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      last_type_idx <span class="token operator">=</span> type_idx<span class="token punctuation">;</span>
      last_type <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ThemeEntry<span class="token operator">&amp;</span> entry <span class="token operator">=</span> last_type<span class="token operator">-</span><span class="token operator">></span>entries<span class="token punctuation">[</span>entry_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>force <span class="token operator">||</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>value<span class="token punctuation">.</span>dataType <span class="token operator">==</span> Res_value<span class="token operator">::</span>TYPE_NULL <span class="token operator">&amp;&amp;</span>
                  entry<span class="token punctuation">.</span>value<span class="token punctuation">.</span>data <span class="token operator">!=</span> Res_value<span class="token operator">::</span>DATA_NULL_EMPTY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      entry<span class="token punctuation">.</span>cookie <span class="token operator">=</span> bag_iter<span class="token operator">-</span><span class="token operator">></span>cookie<span class="token punctuation">;</span>
      entry<span class="token punctuation">.</span>type_spec_flags <span class="token operator">|</span><span class="token operator">=</span> bag<span class="token operator">-</span><span class="token operator">></span>type_spec_flags<span class="token punctuation">;</span>
      entry<span class="token punctuation">.</span>value <span class="token operator">=</span> bag_iter<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.首先先通过resId找到对应的bag，通过Bag获取对应的packageID，typeID，entryID</li>
<li>2.检查当前Theme对象中，之前是否缓存了当前要查找的packageID对应的Package对象，没有则继续啊检查是否包含对应packageID的package对象。都没有就会创建一个新的Package对象。</li>
<li>3.检查当前的package对象中，是否缓存了当前要查找typeID，是否包含对应typeID的ThemeType对象，没有则创建一个新的(大小为entry的大小*typeID)，如果typeID超过了当前ThemeType的容量，则扩容。</li>
<li>4.根据entryID，查找ThemeType的entries对应index的ThemeEntry，最后把bag中的数据赋值进来。</li>
</ul>
<p>因此在这里面有一个核心方法GetBag。</p>
<h4 id="AssetManager2的GetBag"><a href="#AssetManager2的GetBag" class="headerlink" title="AssetManager2的GetBag"></a>AssetManager2的GetBag</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">const</span> ResolvedBag<span class="token operator">*</span> AssetManager2<span class="token operator">::</span><span class="token function">GetBag</span><span class="token punctuation">(</span>uint32_t resid<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token operator">&amp;</span> child_resids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> cached_iter <span class="token operator">=</span> cached_bags_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cached_iter <span class="token operator">!=</span> cached_bags_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cached_iter<span class="token operator">-</span><span class="token operator">></span>second<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  FindEntryResult entry<span class="token punctuation">;</span>
  ApkAssetsCookie cookie <span class="token operator">=</span>
      <span class="token function">FindEntry</span><span class="token punctuation">(</span>resid<span class="token punctuation">,</span> <span class="token number">0u</span> <span class="token comment" spellcheck="true">/* density_override */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* stop_at_first_match */</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie <span class="token operator">==</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dtohs</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>entry<span class="token operator">-</span><span class="token operator">></span>size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResTable_map_entry<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token function">dtohs</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>entry<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">)</span> <span class="token operator">&amp;</span> ResTable_entry<span class="token operator">::</span>FLAG_COMPLEX<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Not a bag, nothing to do.</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> ResTable_map_entry<span class="token operator">*</span> map <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> ResTable_map_entry<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ResTable_map<span class="token operator">*</span> map_entry <span class="token operator">=</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> ResTable_map<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> uint8_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>map<span class="token punctuation">)</span> <span class="token operator">+</span> map<span class="token operator">-</span><span class="token operator">></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ResTable_map<span class="token operator">*</span> <span class="token keyword">const</span> map_entry_end <span class="token operator">=</span> map_entry <span class="token operator">+</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>map<span class="token operator">-</span><span class="token operator">></span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

  child_resids<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>

  uint32_t parent_resid <span class="token operator">=</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>map<span class="token operator">-</span><span class="token operator">></span>parent<span class="token punctuation">.</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent_resid <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> std<span class="token operator">::</span><span class="token function">find</span><span class="token punctuation">(</span>child_resids<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> child_resids<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parent_resid<span class="token punctuation">)</span>
      <span class="token operator">!=</span> child_resids<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> size_t entry_count <span class="token operator">=</span> map_entry_end <span class="token operator">-</span> map_entry<span class="token punctuation">;</span>
    util<span class="token operator">::</span>unique_cptr<span class="token operator">&lt;</span>ResolvedBag<span class="token operator">></span> new_bag<span class="token punctuation">{</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>ResolvedBag<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>
        <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResolvedBag<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>entry_count <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResolvedBag<span class="token operator">::</span>Entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    ResolvedBag<span class="token operator">::</span>Entry<span class="token operator">*</span> new_entry <span class="token operator">=</span> new_bag<span class="token operator">-</span><span class="token operator">></span>entries<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> map_entry <span class="token operator">!=</span> map_entry_end<span class="token punctuation">;</span> <span class="token operator">++</span>map_entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      uint32_t new_key <span class="token operator">=</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>map_entry<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">.</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>

      new_entry<span class="token operator">-</span><span class="token operator">></span>cookie <span class="token operator">=</span> cookie<span class="token punctuation">;</span>
      new_entry<span class="token operator">-</span><span class="token operator">></span>key <span class="token operator">=</span> new_key<span class="token punctuation">;</span>
      new_entry<span class="token operator">-</span><span class="token operator">></span>key_pool <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      new_entry<span class="token operator">-</span><span class="token operator">></span>type_pool <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      new_entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">.</span><span class="token function">copyFrom_dtoh</span><span class="token punctuation">(</span>map_entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      status_t err <span class="token operator">=</span> entry<span class="token punctuation">.</span>dynamic_ref_table<span class="token operator">-</span><span class="token operator">></span><span class="token function">lookupResourceValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token operator">++</span>new_entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    new_bag<span class="token operator">-</span><span class="token operator">></span>type_spec_flags <span class="token operator">=</span> entry<span class="token punctuation">.</span>type_flags<span class="token punctuation">;</span>
    new_bag<span class="token operator">-</span><span class="token operator">></span>entry_count <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>entry_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ResolvedBag<span class="token operator">*</span> result <span class="token operator">=</span> new_bag<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cached_bags_<span class="token punctuation">[</span>resid<span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>new_bag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  entry<span class="token punctuation">.</span>dynamic_ref_table<span class="token operator">-</span><span class="token operator">></span><span class="token function">lookupResourceId</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>parent_resid<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> ResolvedBag<span class="token operator">*</span> parent_bag <span class="token operator">=</span> <span class="token function">GetBag</span><span class="token punctuation">(</span>parent_resid<span class="token punctuation">,</span> child_resids<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> size_t max_count <span class="token operator">=</span> parent_bag<span class="token operator">-</span><span class="token operator">></span>entry_count <span class="token operator">+</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>map<span class="token operator">-</span><span class="token operator">></span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  util<span class="token operator">::</span>unique_cptr<span class="token operator">&lt;</span>ResolvedBag<span class="token operator">></span> new_bag<span class="token punctuation">{</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>ResolvedBag<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>
      <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResolvedBag<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>max_count <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResolvedBag<span class="token operator">::</span>Entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  ResolvedBag<span class="token operator">::</span>Entry<span class="token operator">*</span> new_entry <span class="token operator">=</span> new_bag<span class="token operator">-</span><span class="token operator">></span>entries<span class="token punctuation">;</span>

  <span class="token keyword">const</span> ResolvedBag<span class="token operator">::</span>Entry<span class="token operator">*</span> parent_entry <span class="token operator">=</span> parent_bag<span class="token operator">-</span><span class="token operator">></span>entries<span class="token punctuation">;</span>
  <span class="token keyword">const</span> ResolvedBag<span class="token operator">::</span>Entry<span class="token operator">*</span> <span class="token keyword">const</span> parent_entry_end <span class="token operator">=</span> parent_entry <span class="token operator">+</span> parent_bag<span class="token operator">-</span><span class="token operator">></span>entry_count<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>map_entry <span class="token operator">!=</span> map_entry_end <span class="token operator">&amp;&amp;</span> parent_entry <span class="token operator">!=</span> parent_entry_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint32_t child_key <span class="token operator">=</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>map_entry<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">.</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_key <span class="token operator">&lt;=</span> parent_entry<span class="token operator">-</span><span class="token operator">></span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      new_entry<span class="token operator">-</span><span class="token operator">></span>cookie <span class="token operator">=</span> cookie<span class="token punctuation">;</span>
      new_entry<span class="token operator">-</span><span class="token operator">></span>key <span class="token operator">=</span> child_key<span class="token punctuation">;</span>
      new_entry<span class="token operator">-</span><span class="token operator">></span>key_pool <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      new_entry<span class="token operator">-</span><span class="token operator">></span>type_pool <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      new_entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">.</span><span class="token function">copyFrom_dtoh</span><span class="token punctuation">(</span>map_entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      status_t err <span class="token operator">=</span> entry<span class="token punctuation">.</span>dynamic_ref_table<span class="token operator">-</span><span class="token operator">></span><span class="token function">lookupResourceValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token operator">++</span>map_entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Take the parent entry as-is.</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>new_entry<span class="token punctuation">,</span> parent_entry<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>new_entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_key <span class="token operator">>=</span> parent_entry<span class="token operator">-</span><span class="token operator">></span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Move to the next parent entry if we used it or it was overridden.</span>
      <span class="token operator">++</span>parent_entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Increment to the next entry to fill.</span>
    <span class="token operator">++</span>new_entry<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">while</span> <span class="token punctuation">(</span>map_entry <span class="token operator">!=</span> map_entry_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint32_t new_key <span class="token operator">=</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>map_entry<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">.</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>

    new_entry<span class="token operator">-</span><span class="token operator">></span>cookie <span class="token operator">=</span> cookie<span class="token punctuation">;</span>
    new_entry<span class="token operator">-</span><span class="token operator">></span>key <span class="token operator">=</span> new_key<span class="token punctuation">;</span>
    new_entry<span class="token operator">-</span><span class="token operator">></span>key_pool <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    new_entry<span class="token operator">-</span><span class="token operator">></span>type_pool <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    new_entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">.</span><span class="token function">copyFrom_dtoh</span><span class="token punctuation">(</span>map_entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    status_t err <span class="token operator">=</span> entry<span class="token punctuation">.</span>dynamic_ref_table<span class="token operator">-</span><span class="token operator">></span><span class="token function">lookupResourceValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">++</span>map_entry<span class="token punctuation">;</span>
    <span class="token operator">++</span>new_entry<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent_entry <span class="token operator">!=</span> parent_entry_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> size_t num_entries_to_copy <span class="token operator">=</span> parent_entry_end <span class="token operator">-</span> parent_entry<span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>new_entry<span class="token punctuation">,</span> parent_entry<span class="token punctuation">,</span> num_entries_to_copy <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>new_entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    new_entry <span class="token operator">+</span><span class="token operator">=</span> num_entries_to_copy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> size_t actual_count <span class="token operator">=</span> new_entry <span class="token operator">-</span> new_bag<span class="token operator">-</span><span class="token operator">></span>entries<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>actual_count <span class="token operator">!=</span> max_count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    new_bag<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>ResolvedBag<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token function">realloc</span><span class="token punctuation">(</span>
        new_bag<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResolvedBag<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>actual_count <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResolvedBag<span class="token operator">::</span>Entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  new_bag<span class="token operator">-</span><span class="token operator">></span>type_spec_flags <span class="token operator">=</span> entry<span class="token punctuation">.</span>type_flags <span class="token operator">|</span> parent_bag<span class="token operator">-</span><span class="token operator">></span>type_spec_flags<span class="token punctuation">;</span>
  new_bag<span class="token operator">-</span><span class="token operator">></span>entry_count <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>actual_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ResolvedBag<span class="token operator">*</span> result <span class="token operator">=</span> new_bag<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cached_bags_<span class="token punctuation">[</span>resid<span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>new_bag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.首先通过FindEntry找到对应的FindEntryResult对象，里面包含着ResTable_entry,相关的配置，以及资源池中指向的字符串。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> FindEntryResult <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//查找到的entry结果</span>
<span class="token keyword">const</span> ResTable_entry<span class="token operator">*</span> entry<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//配置</span>
ResTable_config config<span class="token punctuation">;</span>

uint32_t type_flags<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//动态映射表</span>
<span class="token keyword">const</span> DynamicRefTable<span class="token operator">*</span> dynamic_ref_table<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>//entry对应的类型名<br>  StringPoolRef type_string_ref;<br>//entry名<br>  StringPoolRef entry_string_ref;<br>};</p>
<pre><code>- 2.如果当前的ResTable_entry不是ResTable_map_entry对象则返回，通过大小的来确定。并且获取后面ResTable_map对象。ResTable_map_entry的数据结构如下:
```cpp
struct ResTable_map_entry : public ResTable_entry
{
    //指向父ResTable_map_entry的引用
    ResTable_ref parent;
    // 后面ResTable_map的数量
    uint32_t count;
};</code></pre><p>ResTable_map的位置计算如下:</p>
<blockquote>
<p>ResTable_map = ResTable_map_entry的起点+ResTable_map_entry大小</p>
</blockquote>
<p>刚好在ResTable_map_entry后面。ResTable_map的数据结构如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> ResTable_map
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// The resource identifier defining this mapping's name.  For attribute</span>
    <span class="token comment" spellcheck="true">// resources, 'name' can be one of the following special resource types</span>
    <span class="token comment" spellcheck="true">// to supply meta-data about the attribute; for all other resource types</span>
    <span class="token comment" spellcheck="true">// it must be an attribute resource.</span>
    ResTable_ref name<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// This mapping's value.</span>
    Res_value value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到ResTable_map才是真正持有Res_value的对象。ResTable_map里面包含着键值对。分别指的是当前资源当前的命名以及资源中的值。</p>
<ul>
<li>3.接下来分为两种情况，一种是ResTable_map_entry不包含父资源或者已经在原来child_resids找到了，一种的是包含父资源。<br>1 .当不包含父资源的时候，则循环ResTable_map中的引用，把里面的包含的资源真实数据，cookie都设置到ResolveBag的Entry指针中。这样ResolveBag就包含了当前ResTable_entry中所有的数据。一般的一个ResolveBag就包含一个ResTable_map。<br>2 .当包含父资源的时候，将会通过动态映射表去查找对应的父资源的packageID，递归当前的方法，找到所有父资源的数据，获取父ResolveBag。当遇到每一个子资源和父资源冲突，则让子资源覆盖父资源。</li>
</ul>
<p>这样就把所有的父子资源压缩到一起交给了ResolveBag中保管了，并且缓存到cached_bags_中。</p>
<h3 id="查找当前主题下的属性的值常用方法"><a href="#查找当前主题下的属性的值常用方法" class="headerlink" title="查找当前主题下的属性的值常用方法"></a>查找当前主题下的属性的值常用方法</h3><p>接下来，让我们探索一下，当我们编写自定义View，以及自定义属性时候常用三种在当前主题下查找对应的资源属性中的值。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> TypedArray <span class="token function">obtainStyledAttributes</span><span class="token punctuation">(</span><span class="token annotation punctuation">@StyleableRes</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mThemeImpl<span class="token punctuation">.</span><span class="token function">obtainStyledAttributes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        TypedArray <span class="token function">resolveAttributes</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Resources<span class="token punctuation">.</span>Theme wrapper<span class="token punctuation">,</span>
                <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values<span class="token punctuation">,</span>
                <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> len <span class="token operator">=</span> attrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>values <span class="token operator">==</span> null <span class="token operator">||</span> len <span class="token operator">!=</span> values<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                            <span class="token string">"Base attribute values must the same length as attrs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">final</span> TypedArray array <span class="token operator">=</span> TypedArray<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAssets<span class="token punctuation">.</span><span class="token function">resolveAttrs</span><span class="token punctuation">(</span>mTheme<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> values<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> array<span class="token punctuation">.</span>mData<span class="token punctuation">,</span> array<span class="token punctuation">.</span>mIndices<span class="token punctuation">)</span><span class="token punctuation">;</span>
                array<span class="token punctuation">.</span>mTheme <span class="token operator">=</span> wrapper<span class="token punctuation">;</span>
                array<span class="token punctuation">.</span>mXml <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">return</span> array<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> <span class="token function">resolveAttribute</span><span class="token punctuation">(</span><span class="token keyword">int</span> resid<span class="token punctuation">,</span> TypedValue outValue<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolveRefs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mAssets<span class="token punctuation">.</span><span class="token function">getThemeValue</span><span class="token punctuation">(</span>mTheme<span class="token punctuation">,</span> resid<span class="token punctuation">,</span> outValue<span class="token punctuation">,</span> resolveRefs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而这两个方法都会调用ThemeImpl中的下面方法。</p>
<pre class="line-numbers language-java"><code class="language-java">        TypedArray <span class="token function">resolveAttributes</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Resources<span class="token punctuation">.</span>Theme wrapper<span class="token punctuation">,</span>
                <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values<span class="token punctuation">,</span>
                <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> len <span class="token operator">=</span> attrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>values <span class="token operator">==</span> null <span class="token operator">||</span> len <span class="token operator">!=</span> values<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                            <span class="token string">"Base attribute values must the same length as attrs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">final</span> TypedArray array <span class="token operator">=</span> TypedArray<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAssets<span class="token punctuation">.</span><span class="token function">resolveAttrs</span><span class="token punctuation">(</span>mTheme<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> values<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> array<span class="token punctuation">.</span>mData<span class="token punctuation">,</span> array<span class="token punctuation">.</span>mIndices<span class="token punctuation">)</span><span class="token punctuation">;</span>
                array<span class="token punctuation">.</span>mTheme <span class="token operator">=</span> wrapper<span class="token punctuation">;</span>
                array<span class="token punctuation">.</span>mXml <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">return</span> array<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        TypedArray <span class="token function">obtainStyledAttributes</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Resources<span class="token punctuation">.</span>Theme wrapper<span class="token punctuation">,</span>
                AttributeSet set<span class="token punctuation">,</span>
                <span class="token annotation punctuation">@StyleableRes</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> attrs<span class="token punctuation">,</span>
                <span class="token annotation punctuation">@AttrRes</span> <span class="token keyword">int</span> defStyleAttr<span class="token punctuation">,</span>
                <span class="token annotation punctuation">@StyleRes</span> <span class="token keyword">int</span> defStyleRes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> len <span class="token operator">=</span> attrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                <span class="token keyword">final</span> TypedArray array <span class="token operator">=</span> TypedArray<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> XmlBlock<span class="token punctuation">.</span>Parser parser <span class="token operator">=</span> <span class="token punctuation">(</span>XmlBlock<span class="token punctuation">.</span>Parser<span class="token punctuation">)</span> set<span class="token punctuation">;</span>
                mAssets<span class="token punctuation">.</span><span class="token function">applyStyle</span><span class="token punctuation">(</span>mTheme<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">,</span> defStyleRes<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span>
                        array<span class="token punctuation">.</span>mDataAddress<span class="token punctuation">,</span> array<span class="token punctuation">.</span>mIndicesAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
                array<span class="token punctuation">.</span>mTheme <span class="token operator">=</span> wrapper<span class="token punctuation">;</span>
                array<span class="token punctuation">.</span>mXml <span class="token operator">=</span> parser<span class="token punctuation">;</span>
                <span class="token keyword">return</span> array<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其核心原理是十分相似。首先在ActivityThread的handleLaunch阶段，会设置一个Theme。这个Theme就是ThemeImpl，同时会在native层中生成一个Theme对象。</p>
<p>最后分别调用AssetManager的resolveAttrs以及applyStyle方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">applyStyle</span><span class="token punctuation">(</span><span class="token keyword">long</span> themePtr<span class="token punctuation">,</span> <span class="token annotation punctuation">@AttrRes</span> <span class="token keyword">int</span> defStyleAttr<span class="token punctuation">,</span> <span class="token annotation punctuation">@StyleRes</span> <span class="token keyword">int</span> defStyleRes<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> XmlBlock<span class="token punctuation">.</span>Parser parser<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inAttrs<span class="token punctuation">,</span> <span class="token keyword">long</span> outValuesAddress<span class="token punctuation">,</span>
            <span class="token keyword">long</span> outIndicesAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token function">nativeApplyStyle</span><span class="token punctuation">(</span>mObject<span class="token punctuation">,</span> themePtr<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">,</span> defStyleRes<span class="token punctuation">,</span>
                    parser <span class="token operator">!=</span> null <span class="token operator">?</span> parser<span class="token punctuation">.</span>mParseState <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> inAttrs<span class="token punctuation">,</span> outValuesAddress<span class="token punctuation">,</span>
                    outIndicesAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> <span class="token function">resolveAttrs</span><span class="token punctuation">(</span><span class="token keyword">long</span> themePtr<span class="token punctuation">,</span> <span class="token annotation punctuation">@AttrRes</span> <span class="token keyword">int</span> defStyleAttr<span class="token punctuation">,</span> <span class="token annotation punctuation">@StyleRes</span> <span class="token keyword">int</span> defStyleRes<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inValues<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inAttrs<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> outValues<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> outIndices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> <span class="token function">nativeResolveAttrs</span><span class="token punctuation">(</span>mObject<span class="token punctuation">,</span>
                    themePtr<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">,</span> defStyleRes<span class="token punctuation">,</span> inValues<span class="token punctuation">,</span> inAttrs<span class="token punctuation">,</span> outValues<span class="token punctuation">,</span> outIndices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> <span class="token function">getThemeValue</span><span class="token punctuation">(</span><span class="token keyword">long</span> theme<span class="token punctuation">,</span> <span class="token annotation punctuation">@AnyRes</span> <span class="token keyword">int</span> resId<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> TypedValue outValue<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> resolveRefs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>outValue<span class="token punctuation">,</span> <span class="token string">"outValue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ensureValidLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> cookie <span class="token operator">=</span> <span class="token function">nativeThemeGetAttributeValue</span><span class="token punctuation">(</span>mObject<span class="token punctuation">,</span> theme<span class="token punctuation">,</span> resId<span class="token punctuation">,</span> outValue<span class="token punctuation">,</span>
                    resolveRefs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Convert the changing configurations flags populated by native code.</span>
            outValue<span class="token punctuation">.</span>changingConfigurations <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span><span class="token function">activityInfoConfigNativeToJava</span><span class="token punctuation">(</span>
                    outValue<span class="token punctuation">.</span>changingConfigurations<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>outValue<span class="token punctuation">.</span>type <span class="token operator">==</span> TypedValue<span class="token punctuation">.</span>TYPE_STRING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                outValue<span class="token punctuation">.</span>string <span class="token operator">=</span> mApkAssets<span class="token punctuation">[</span>cookie <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getStringFromPool</span><span class="token punctuation">(</span>outValue<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="obtainStyledAttributes-工作原理"><a href="#obtainStyledAttributes-工作原理" class="headerlink" title="obtainStyledAttributes 工作原理"></a>obtainStyledAttributes 工作原理</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NativeApplyStyle</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass <span class="token comment" spellcheck="true">/*clazz*/</span><span class="token punctuation">,</span> jlong ptr<span class="token punctuation">,</span> jlong theme_ptr<span class="token punctuation">,</span>
                             jint def_style_attr<span class="token punctuation">,</span> jint def_style_resid<span class="token punctuation">,</span> jlong xml_parser_ptr<span class="token punctuation">,</span>
                             jintArray java_attrs<span class="token punctuation">,</span> jlong out_values_ptr<span class="token punctuation">,</span> jlong out_indices_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ScopedLock<span class="token operator">&lt;</span>AssetManager2<span class="token operator">></span> <span class="token function">assetmanager</span><span class="token punctuation">(</span><span class="token function">AssetManagerFromLong</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Theme<span class="token operator">*</span> theme <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Theme<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>theme_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CHECK</span><span class="token punctuation">(</span>theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetAssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>assetmanager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> assetmanager<span class="token punctuation">;</span>

  ResXMLParser<span class="token operator">*</span> xml_parser <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>ResXMLParser<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>xml_parser_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  uint32_t<span class="token operator">*</span> out_values <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>out_values_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  uint32_t<span class="token operator">*</span> out_indices <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>out_indices_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  jsize attrs_len <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetArrayLength</span><span class="token punctuation">(</span>java_attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  jint<span class="token operator">*</span> attrs <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>jint<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetPrimitiveArrayCritical</span><span class="token punctuation">(</span>java_attrs<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token function">ApplyStyle</span><span class="token punctuation">(</span>theme<span class="token punctuation">,</span> xml_parser<span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>def_style_attr<span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>def_style_resid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">,</span> attrs_len<span class="token punctuation">,</span>
             out_values<span class="token punctuation">,</span> out_indices<span class="token punctuation">)</span><span class="token punctuation">;</span>
  env<span class="token operator">-</span><span class="token operator">></span><span class="token function">ReleasePrimitiveArrayCritical</span><span class="token punctuation">(</span>java_attrs<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> JNI_ABORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心方法调用ApplyStyle<br>文件；/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/" target="_blank" rel="noopener">androidfw</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/AttributeResolution.cpp" target="_blank" rel="noopener">AttributeResolution.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">ApplyStyle</span><span class="token punctuation">(</span>Theme<span class="token operator">*</span> theme<span class="token punctuation">,</span> ResXMLParser<span class="token operator">*</span> xml_parser<span class="token punctuation">,</span> uint32_t def_style_attr<span class="token punctuation">,</span>
                uint32_t def_style_resid<span class="token punctuation">,</span> <span class="token keyword">const</span> uint32_t<span class="token operator">*</span> attrs<span class="token punctuation">,</span> size_t attrs_length<span class="token punctuation">,</span>
                uint32_t<span class="token operator">*</span> out_values<span class="token punctuation">,</span> uint32_t<span class="token operator">*</span> out_indices<span class="token punctuation">)</span> <span class="token punctuation">{</span>


  AssetManager2<span class="token operator">*</span> assetmanager <span class="token operator">=</span> theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetAssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ResTable_config config<span class="token punctuation">;</span>
  Res_value value<span class="token punctuation">;</span>

  <span class="token keyword">int</span> indices_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  uint32_t def_style_flags <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>def_style_attr <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Res_value value<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetAttribute</span><span class="token punctuation">(</span>def_style_attr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>def_style_flags<span class="token punctuation">)</span> <span class="token operator">!=</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">==</span> Res_value<span class="token operator">::</span>TYPE_REFERENCE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def_style_resid <span class="token operator">=</span> value<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// Retrieve the style resource ID associated with the current XML tag's style attribute.</span>
  uint32_t style_resid <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>
  uint32_t style_flags <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xml_parser <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ssize_t idx <span class="token operator">=</span> xml_parser<span class="token operator">-</span><span class="token operator">></span><span class="token function">indexOfStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> xml_parser<span class="token operator">-</span><span class="token operator">></span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">==</span> value<span class="token punctuation">.</span>TYPE_ATTRIBUTE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Resolve the attribute with out theme.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetAttribute</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>style_flags<span class="token punctuation">)</span> <span class="token operator">==</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          value<span class="token punctuation">.</span>dataType <span class="token operator">=</span> Res_value<span class="token operator">::</span>TYPE_NULL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">==</span> value<span class="token punctuation">.</span>TYPE_REFERENCE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        style_resid <span class="token operator">=</span> value<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> ResolvedBag<span class="token operator">*</span> default_style_bag <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>def_style_resid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    default_style_bag <span class="token operator">=</span> assetmanager<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetBag</span><span class="token punctuation">(</span>def_style_resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>default_style_bag <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      def_style_flags <span class="token operator">|</span><span class="token operator">=</span> default_style_bag<span class="token operator">-</span><span class="token operator">></span>type_spec_flags<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  BagAttributeFinder <span class="token function">def_style_attr_finder</span><span class="token punctuation">(</span>default_style_bag<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> ResolvedBag<span class="token operator">*</span> xml_style_bag <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>style_resid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    xml_style_bag <span class="token operator">=</span> assetmanager<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetBag</span><span class="token punctuation">(</span>style_resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xml_style_bag <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      style_flags <span class="token operator">|</span><span class="token operator">=</span> xml_style_bag<span class="token operator">-</span><span class="token operator">></span>type_spec_flags<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  BagAttributeFinder <span class="token function">xml_style_attr_finder</span><span class="token punctuation">(</span>xml_style_bag<span class="token punctuation">)</span><span class="token punctuation">;</span>

  XmlAttributeFinder <span class="token function">xml_attr_finder</span><span class="token punctuation">(</span>xml_parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> attrs_length<span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> uint32_t cur_ident <span class="token operator">=</span> attrs<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">;</span>

    ApkAssetsCookie cookie <span class="token operator">=</span> kInvalidCookie<span class="token punctuation">;</span>
    uint32_t type_set_flags <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>

    value<span class="token punctuation">.</span>dataType <span class="token operator">=</span> Res_value<span class="token operator">::</span>TYPE_NULL<span class="token punctuation">;</span>
    value<span class="token punctuation">.</span>data <span class="token operator">=</span> Res_value<span class="token operator">::</span>DATA_NULL_UNDEFINED<span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>density <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> size_t xml_attr_idx <span class="token operator">=</span> xml_attr_finder<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>cur_ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xml_attr_idx <span class="token operator">!=</span> xml_attr_finder<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      xml_parser<span class="token operator">-</span><span class="token operator">></span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>xml_attr_idx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">==</span> Res_value<span class="token operator">::</span>TYPE_NULL <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>data <span class="token operator">!=</span> Res_value<span class="token operator">::</span>DATA_NULL_EMPTY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ResolvedBag<span class="token operator">::</span>Entry<span class="token operator">*</span> entry <span class="token operator">=</span> xml_style_attr_finder<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>cur_ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> xml_style_attr_finder<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cookie <span class="token operator">=</span> entry<span class="token operator">-</span><span class="token operator">></span>cookie<span class="token punctuation">;</span>
        type_set_flags <span class="token operator">=</span> style_flags<span class="token punctuation">;</span>
        value <span class="token operator">=</span> entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">==</span> Res_value<span class="token operator">::</span>TYPE_NULL <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>data <span class="token operator">!=</span> Res_value<span class="token operator">::</span>DATA_NULL_EMPTY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ResolvedBag<span class="token operator">::</span>Entry<span class="token operator">*</span> entry <span class="token operator">=</span> def_style_attr_finder<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>cur_ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> def_style_attr_finder<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cookie <span class="token operator">=</span> entry<span class="token operator">-</span><span class="token operator">></span>cookie<span class="token punctuation">;</span>
        type_set_flags <span class="token operator">=</span> def_style_flags<span class="token punctuation">;</span>
        value <span class="token operator">=</span> entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    uint32_t resid <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">!=</span> Res_value<span class="token operator">::</span>TYPE_NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ApkAssetsCookie new_cookie <span class="token operator">=</span>
          theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">ResolveAttributeReference</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type_set_flags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>new_cookie <span class="token operator">!=</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cookie <span class="token operator">=</span> new_cookie<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>data <span class="token operator">!=</span> Res_value<span class="token operator">::</span>DATA_NULL_EMPTY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ApkAssetsCookie new_cookie <span class="token operator">=</span> theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetAttribute</span><span class="token punctuation">(</span>cur_ident<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type_set_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>new_cookie <span class="token operator">!=</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        new_cookie <span class="token operator">=</span>
            assetmanager<span class="token operator">-</span><span class="token operator">></span><span class="token function">ResolveReference</span><span class="token punctuation">(</span>new_cookie<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type_set_flags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>new_cookie <span class="token operator">!=</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          cookie <span class="token operator">=</span> new_cookie<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">==</span> Res_value<span class="token operator">::</span>TYPE_REFERENCE <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value<span class="token punctuation">.</span>dataType <span class="token operator">=</span> Res_value<span class="token operator">::</span>TYPE_NULL<span class="token punctuation">;</span>
      value<span class="token punctuation">.</span>data <span class="token operator">=</span> Res_value<span class="token operator">::</span>DATA_NULL_UNDEFINED<span class="token punctuation">;</span>
      cookie <span class="token operator">=</span> kInvalidCookie<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    out_values<span class="token punctuation">[</span>STYLE_TYPE<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>dataType<span class="token punctuation">;</span>
    out_values<span class="token punctuation">[</span>STYLE_DATA<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    out_values<span class="token punctuation">[</span>STYLE_ASSET_COOKIE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ApkAssetsCookieToJavaCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    out_values<span class="token punctuation">[</span>STYLE_RESOURCE_ID<span class="token punctuation">]</span> <span class="token operator">=</span> resid<span class="token punctuation">;</span>
    out_values<span class="token punctuation">[</span>STYLE_CHANGING_CONFIGURATIONS<span class="token punctuation">]</span> <span class="token operator">=</span> type_set_flags<span class="token punctuation">;</span>
    out_values<span class="token punctuation">[</span>STYLE_DENSITY<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>density<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">!=</span> Res_value<span class="token operator">::</span>TYPE_NULL <span class="token operator">||</span> value<span class="token punctuation">.</span>data <span class="token operator">==</span> Res_value<span class="token operator">::</span>DATA_NULL_EMPTY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      indices_idx<span class="token operator">++</span><span class="token punctuation">;</span>
      out_indices<span class="token punctuation">[</span>indices_idx<span class="token punctuation">]</span> <span class="token operator">=</span> ii<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    out_values <span class="token operator">+</span><span class="token operator">=</span> STYLE_NUM_ENTRIES<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  out_indices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> indices_idx<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.首先通过GetAttribute检查当前传进来的默认的属性，如果当前传进来了XML当前块的解析对象，则获取style的位置之后，尝试获取style中的值，是引用则记录当前的id。如果是Attribute则通过GetAttribute获取值。</li>
<li>2.如果默认的style的id不为0，则获取styleID对应的ResolveBag作为默认对象。</li>
<li>3.此时获取从上面传下来的attr引用指针，在这个情况一般是值R.styleable.xxx的一个数组，里面含有大量的属性。开始循环传下来的attr数组，逐一查找对应数组中每一个资源值对应的index。</li>
<li>4.如果xml_attr_finder找到对应的index，则通过xml_parser-&gt;getAttributeValue(xml_attr_idx, &amp;value);解析里面内容，并且拷贝到outValue中。记住如果是引用，则会通过ResolveReference方法解包引用，通过GetResources找到真正的值。如果数据为空，则从默认的style中读取。</li>
</ul>
<p>能看到这个过程中有2个核心方法我们未曾接触过，让我们着重看看里面做了什么事情：</p>
<ul>
<li>GetAttribute</li>
<li>xml_parser-&gt;getAttributeValue</li>
</ul>
<h4 id="GetAttribute-获取属性"><a href="#GetAttribute-获取属性" class="headerlink" title="GetAttribute 获取属性"></a>GetAttribute 获取属性</h4><pre class="line-numbers language-cpp"><code class="language-cpp">ApkAssetsCookie Theme<span class="token operator">::</span><span class="token function">GetAttribute</span><span class="token punctuation">(</span>uint32_t resid<span class="token punctuation">,</span> Res_value<span class="token operator">*</span> out_value<span class="token punctuation">,</span>
                                    uint32_t<span class="token operator">*</span> out_flags<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

  uint32_t type_spec_flags <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>

  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> package_idx <span class="token operator">=</span> <span class="token function">get_package_id</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> Package<span class="token operator">*</span> package <span class="token operator">=</span> packages_<span class="token punctuation">[</span>package_idx<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>package <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// The themes are constructed with a 1-based type ID, so no need to decrement here.</span>
      <span class="token keyword">const</span> <span class="token keyword">int</span> type_idx <span class="token operator">=</span> <span class="token function">get_type_id</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> ThemeType<span class="token operator">*</span> type <span class="token operator">=</span> package<span class="token operator">-</span><span class="token operator">></span>types<span class="token punctuation">[</span>type_idx<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> entry_idx <span class="token operator">=</span> <span class="token function">get_entry_id</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry_idx <span class="token operator">&lt;</span> type<span class="token operator">-</span><span class="token operator">></span>entry_count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> ThemeEntry<span class="token operator">&amp;</span> entry <span class="token operator">=</span> type<span class="token operator">-</span><span class="token operator">></span>entries<span class="token punctuation">[</span>entry_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
          type_spec_flags <span class="token operator">|</span><span class="token operator">=</span> entry<span class="token punctuation">.</span>type_spec_flags<span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>value<span class="token punctuation">.</span>dataType <span class="token operator">==</span> Res_value<span class="token operator">::</span>TYPE_ATTRIBUTE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              cnt<span class="token operator">--</span><span class="token punctuation">;</span>
              resid <span class="token operator">=</span> entry<span class="token punctuation">.</span>value<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
              <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> kInvalidCookie<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment" spellcheck="true">// @null is different than @empty.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>value<span class="token punctuation">.</span>dataType <span class="token operator">==</span> Res_value<span class="token operator">::</span>TYPE_NULL <span class="token operator">&amp;&amp;</span>
              entry<span class="token punctuation">.</span>value<span class="token punctuation">.</span>data <span class="token operator">!=</span> Res_value<span class="token operator">::</span>DATA_NULL_EMPTY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> kInvalidCookie<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token operator">*</span>out_value <span class="token operator">=</span> entry<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
          <span class="token operator">*</span>out_flags <span class="token operator">=</span> type_spec_flags<span class="token punctuation">;</span>
          <span class="token keyword">return</span> entry<span class="token punctuation">.</span>cookie<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> kInvalidCookie<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上很简单，在native层已经保存了当前主题中所有xml的映射关系，因此可以通过当前Package，ThemeType找到对应的ResTable_entry中的数据。因此我们可以得知，在obtainStyledAttributes中，设置默认的属性不是什么都可以设置，需要设置Theme中有的才能正常运作。</p>
<h4 id="getAttributeValue解析Xml数据块中的属性值"><a href="#getAttributeValue解析Xml数据块中的属性值" class="headerlink" title="getAttributeValue解析Xml数据块中的属性值"></a>getAttributeValue解析Xml数据块中的属性值</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/" target="_blank" rel="noopener">androidfw</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/ResourceTypes.cpp" target="_blank" rel="noopener">ResourceTypes.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">ssize_t ResXMLParser<span class="token operator">::</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>size_t idx<span class="token punctuation">,</span> Res_value<span class="token operator">*</span> outValue<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mEventCode <span class="token operator">==</span> START_TAG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> ResXMLTree_attrExt<span class="token operator">*</span> tag <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> ResXMLTree_attrExt<span class="token operator">*</span><span class="token punctuation">)</span>mCurExt<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> <span class="token function">dtohs</span><span class="token punctuation">(</span>tag<span class="token operator">-</span><span class="token operator">></span>attributeCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> ResXMLTree_attribute<span class="token operator">*</span> attr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> ResXMLTree_attribute<span class="token operator">*</span><span class="token punctuation">)</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> uint8_t<span class="token operator">*</span><span class="token punctuation">)</span>tag<span class="token punctuation">)</span>
                 <span class="token operator">+</span> <span class="token function">dtohs</span><span class="token punctuation">(</span>tag<span class="token operator">-</span><span class="token operator">></span>attributeStart<span class="token punctuation">)</span>
                 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">dtohs</span><span class="token punctuation">(</span>tag<span class="token operator">-</span><span class="token operator">></span>attributeSize<span class="token punctuation">)</span><span class="token operator">*</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            outValue<span class="token operator">-</span><span class="token operator">></span><span class="token function">copyFrom_dtoh</span><span class="token punctuation">(</span>attr<span class="token operator">-</span><span class="token operator">></span>typedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mTree<span class="token punctuation">.</span>mDynamicRefTable <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span>
                    mTree<span class="token punctuation">.</span>mDynamicRefTable<span class="token operator">-</span><span class="token operator">></span><span class="token function">lookupResourceValue</span><span class="token punctuation">(</span>outValue<span class="token punctuation">)</span> <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> BAD_TYPE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Res_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> BAD_TYPE<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>十分简单，就是通过当前保存的解析树中ResXMLTree_attribute对应index的属性值。还有一个resolveAttribute的方法本质上还是从ApplyStyle中查找方法。</p>
<p>到这里我们已经理解了obtainStyledAttributes的工作流程，让我们看看resolveAttributes。</p>
<h4 id="resolveAttributes的工作原理"><a href="#resolveAttributes的工作原理" class="headerlink" title="resolveAttributes的工作原理"></a>resolveAttributes的工作原理</h4><p>这个方法最终会调用native的ResolveAttrs方法。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/" target="_blank" rel="noopener">androidfw</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/AttributeResolution.cpp" target="_blank" rel="noopener">AttributeResolution.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> <span class="token function">ResolveAttrs</span><span class="token punctuation">(</span>Theme<span class="token operator">*</span> theme<span class="token punctuation">,</span> uint32_t def_style_attr<span class="token punctuation">,</span> uint32_t def_style_res<span class="token punctuation">,</span>
                  uint32_t<span class="token operator">*</span> src_values<span class="token punctuation">,</span> size_t src_values_length<span class="token punctuation">,</span> uint32_t<span class="token operator">*</span> attrs<span class="token punctuation">,</span>
                  size_t attrs_length<span class="token punctuation">,</span> uint32_t<span class="token operator">*</span> out_values<span class="token punctuation">,</span> uint32_t<span class="token operator">*</span> out_indices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  AssetManager2<span class="token operator">*</span> assetmanager <span class="token operator">=</span> theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetAssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ResTable_config config<span class="token punctuation">;</span>
  Res_value value<span class="token punctuation">;</span>

  <span class="token keyword">int</span> indices_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Load default style from attribute, if specified...</span>
  uint32_t def_style_flags <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>def_style_attr <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Res_value value<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetAttribute</span><span class="token punctuation">(</span>def_style_attr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>def_style_flags<span class="token punctuation">)</span> <span class="token operator">!=</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">==</span> Res_value<span class="token operator">::</span>TYPE_REFERENCE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def_style_res <span class="token operator">=</span> value<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> ResolvedBag<span class="token operator">*</span> default_style_bag <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>def_style_res <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    default_style_bag <span class="token operator">=</span> assetmanager<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetBag</span><span class="token punctuation">(</span>def_style_res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>default_style_bag <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      def_style_flags <span class="token operator">|</span><span class="token operator">=</span> default_style_bag<span class="token operator">-</span><span class="token operator">></span>type_spec_flags<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  BagAttributeFinder <span class="token function">def_style_attr_finder</span><span class="token punctuation">(</span>default_style_bag<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> attrs_length<span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> uint32_t cur_ident <span class="token operator">=</span> attrs<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">;</span>

    ApkAssetsCookie cookie <span class="token operator">=</span> kInvalidCookie<span class="token punctuation">;</span>
    uint32_t type_set_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    value<span class="token punctuation">.</span>dataType <span class="token operator">=</span> Res_value<span class="token operator">::</span>TYPE_NULL<span class="token punctuation">;</span>
    value<span class="token punctuation">.</span>data <span class="token operator">=</span> Res_value<span class="token operator">::</span>DATA_NULL_UNDEFINED<span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>density <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>src_values_length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> src_values<span class="token punctuation">[</span>ii<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value<span class="token punctuation">.</span>dataType <span class="token operator">=</span> Res_value<span class="token operator">::</span>TYPE_ATTRIBUTE<span class="token punctuation">;</span>
      value<span class="token punctuation">.</span>data <span class="token operator">=</span> src_values<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ResolvedBag<span class="token operator">::</span>Entry<span class="token operator">*</span> <span class="token keyword">const</span> entry <span class="token operator">=</span> def_style_attr_finder<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>cur_ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> def_style_attr_finder<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cookie <span class="token operator">=</span> entry<span class="token operator">-</span><span class="token operator">></span>cookie<span class="token punctuation">;</span>
        type_set_flags <span class="token operator">=</span> def_style_flags<span class="token punctuation">;</span>
        value <span class="token operator">=</span> entry<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    uint32_t resid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">!=</span> Res_value<span class="token operator">::</span>TYPE_NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ApkAssetsCookie new_cookie <span class="token operator">=</span>
          theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">ResolveAttributeReference</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type_set_flags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>new_cookie <span class="token operator">!=</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cookie <span class="token operator">=</span> new_cookie<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>data <span class="token operator">!=</span> Res_value<span class="token operator">::</span>DATA_NULL_EMPTY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// If we still don't have a value for this attribute, try to find it in the theme!</span>
      ApkAssetsCookie new_cookie <span class="token operator">=</span> theme<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetAttribute</span><span class="token punctuation">(</span>cur_ident<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type_set_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>new_cookie <span class="token operator">!=</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        new_cookie <span class="token operator">=</span>
            assetmanager<span class="token operator">-</span><span class="token operator">></span><span class="token function">ResolveReference</span><span class="token punctuation">(</span>new_cookie<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type_set_flags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>new_cookie <span class="token operator">!=</span> kInvalidCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          cookie <span class="token operator">=</span> new_cookie<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// Write the final value back to Java.</span>
    out_values<span class="token punctuation">[</span>STYLE_TYPE<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>dataType<span class="token punctuation">;</span>
    out_values<span class="token punctuation">[</span>STYLE_DATA<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    out_values<span class="token punctuation">[</span>STYLE_ASSET_COOKIE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ApkAssetsCookieToJavaCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    out_values<span class="token punctuation">[</span>STYLE_RESOURCE_ID<span class="token punctuation">]</span> <span class="token operator">=</span> resid<span class="token punctuation">;</span>
    out_values<span class="token punctuation">[</span>STYLE_CHANGING_CONFIGURATIONS<span class="token punctuation">]</span> <span class="token operator">=</span> type_set_flags<span class="token punctuation">;</span>
    out_values<span class="token punctuation">[</span>STYLE_DENSITY<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>density<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>out_indices <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">!=</span> Res_value<span class="token operator">::</span>TYPE_NULL <span class="token operator">||</span> value<span class="token punctuation">.</span>data <span class="token operator">==</span> Res_value<span class="token operator">::</span>DATA_NULL_EMPTY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      indices_idx<span class="token operator">++</span><span class="token punctuation">;</span>
      out_indices<span class="token punctuation">[</span>indices_idx<span class="token punctuation">]</span> <span class="token operator">=</span> ii<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    out_values <span class="token operator">+</span><span class="token operator">=</span> STYLE_NUM_ENTRIES<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>out_indices <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    out_indices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> indices_idx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的逻辑和上面的obtainStyledAttributes十分相似。唯一不同的是，obtainStyledAttributes解析的是Xml中的属性。而这里不需要解析Xml的属性，而是直接通过BagAttributeFinder查找有没有对应的属性。obtainStyledAttributes当没有在Xml中找到也是通过BagAttributeFinder去查找默认的属性。而这个方法本质上就是ResolvedBag这个数组指针，迭代查找Theme中所有的属性中的值。</p>
<pre class="line-numbers language-java"><code class="language-java">  mAssets<span class="token punctuation">.</span><span class="token function">resolveAttrs</span><span class="token punctuation">(</span>mTheme<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> values<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> array<span class="token punctuation">.</span>mData<span class="token punctuation">,</span> array<span class="token punctuation">.</span>mIndices<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>resolveAttributes在Java层并没有传递默认的style以及attr，因此获取的是当前values中index对应的属性值。我之前试着使用这个方法获取的时候，也是出现了问题，找错了方法，看了源码之后才明白是怎么回事。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总结资源查找的原理。对于AssetManager来说，资源大致分为两类：</p>
<ul>
<li>1.非Asset文件夹下的资源 </li>
<li>2.Asset文件夹下的资源</li>
<li>3.查找Theme中的属性</li>
</ul>
<p>对于非Asset文件夹下的资源来说，查找过程一般遵循如下流程：</p>
<ul>
<li><p>1.解析资源ID，根据packageID从package_groups中获取到对应的PackageGroup，接着获取每一个Group当中对应的LoadPackage对象。</p>
</li>
<li><p>2.LoadPackage对象中保存着TypeSpec对象。这个对象保存着资源类型和资源类型内容之间的映射关系。Android系统为了加速资源加载提前把当前资源环境一直的资源另外放置在一个FilteredConfigGroup中。一旦发现是一致的环境则从这个快速通道进行查找，否则则进行全局的遍历。最后通过GetEntryFromOffset找到偏移数组并且赋值到TypedValue中</p>
</li>
<li><p>3.最后就可以从TypedValue读取数据。如果是布局这种大型文件，就会保存到native的Xml的解析器中，通过mmap的方式映射读取内存数据。</p>
</li>
</ul>
<p>对于Asset文件夹下的文件来说，查找过程很简单一般遵循如下步骤:</p>
<ul>
<li>1.为路径新增一个asset的路径前缀。</li>
<li>2.把zip数据流交给AssetInputStream 这个Stream对象处理</li>
</ul>
<p>对于Theme中的属性，分为初始化Theme以及从Theme中查找2个步骤:</p>
<ul>
<li><p>1.初始化Native下的Theme的时候，会通过ApplyStyle方法先解析当前的资源结构。通过FindEntry的方法和解析一个ResTable_entry对象出来.</p>
</li>
<li><p>2.拿到ResTable_entry之后，会通过起点加上该对象的大小能拿到对应的ResTable_map对象，而这个对象中就保存着ResTable_value，也就是资源的真实内容；接着循环从子资源一路向父资源查找所有的资源属性，子资源将会覆盖掉父资源并压缩到ResloveBag中；最后保存到cached_bags_缓存中。</p>
</li>
<li><p>3.最后底层的Theme对象，将会层层缓存，根据packageid，typeid，缓存下来。并遍历ResloveBag中所有的数据出处到Theme的entry数组中</p>
</li>
<li><p>4.当进行查找时候，将会解析当前Theme中保存下来的映射对象，并且返回到Java层。</p>
</li>
</ul>
<h2 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h2><p>其实刚好这段时间在摆弄公司的基础库，抽离了一个ui公共库。经常接触这些资源解析，资源查找，因此也运气挺好的顺手写了这些东西，总结了之前的所用。</p>
<p>到这里，所有常规的资源查找方法就全部解析完毕。接下来，我会开启Android渲染体系的文章系列。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/11/05/kai-pian-yu-dao-du/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="开篇与导读">
                        
                        <span class="card-title">开篇与导读</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            序我本来还没有想着做一个属于我的博客网站，一个是认为自己写的东西本来就比较小众没什么人看，放在自己的博库里面孤芳自赏确实没什么意思，违背了原本我写博客的初衷。我原本的初衷是希望记录自己所学的同时，能够帮助那些希望理解原理，却苦于无法各种原因
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-11-05
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/11/03/android-chong-xue-xi-lie-zi-yuan-guan-li-xi-tong-zi-yuan-de-chu-shi-hua-jia-zai-xia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="Android 重学系列 资源管理系统 资源的初始化加载(下)">
                        
                        <span class="card-title">Android 重学系列 资源管理系统 资源的初始化加载(下)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章，聊到了资源管理中解析Package数据模块中的LoadedPackage::Load方法开始解析Package数据块。本文将会详细解析Package数据块的解析，以及AssetManager如何管理。接下来解析resourc
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-11-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-资源系统/" class="post-category">
                                    Android 资源系统
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
