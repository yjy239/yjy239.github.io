<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 资源管理系统 资源的初始化加载(上), Android | Linux | Flutter">
    <meta name="description" content="前言如果遇到问题欢迎在这个地址下留言：https://www.jianshu.com/p/817a787910f2
上一篇文章和大家聊了聊Android是如何进行View的实例化。但是还是遗留了一个问题，Android是怎么读取资源文件的，">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 资源管理系统 资源的初始化加载(上) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/15.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 资源管理系统 资源的初始化加载(上)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android-资源系统/" class="post-category">
                                Android 资源系统
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-11-03
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        8.9k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        37 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>如果遇到问题欢迎在这个地址下留言：<a href="https://www.jianshu.com/p/817a787910f2" target="_blank" rel="noopener">https://www.jianshu.com/p/817a787910f2</a></p>
<p>上一篇文章和大家聊了聊Android是如何进行View的实例化。但是还是遗留了一个问题，Android是怎么读取资源文件的，本文将会和大家来聊聊关于Resources类是怎么读取到底层资源的。</p>
<p>其实这部分，有部分内容在我写插件化的文章里面有聊到过，也画过一张简单的时序图，不过这只是Resources类在Java层怎么初始化，怎么获取对应资源的。本文将会更加重点的，系统的探索，native的初始化以及读取数据。</p>
<p><img src="/images/Framework%E5%B1%82%E7%9A%84%E8%B5%84%E6%BA%90%E6%9F%A5%E6%89%BE%E4%B8%8Econtext%E7%BB%91%E5%AE%9A.png" alt="Framework层的资源查找与context绑定.png"></p>
<p>不过，这仅仅只是一个很粗略的时序图。实际上每个Resources都会被ResourcesManager管理着。但是Resources相当于一个代理类，实际上真正的操作都是由ResourcesImpl去完成。</p>
<p>ResourcesImpl管理着什么？它一般管理着一个apk中各种资源文件，其中它有一个很核心的类AssetManager，这才是真正连通native层进行解析。别看AssetManager的名字上好像指管理着asset文件夹，但是它的管理范围一般是ApkAsset这个资源抽象对象。</p>
<p>有了大致的印象，我们来看看整个Android系统是如何管理ApksAsset以及AssetManager；就大致上弄明白了Android系统的资源管理体系。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>从上面时序图中，我们可以主要的关注一下ContextImpl是怎么初始化的？怎么获取到资源访问的能力的，把目光放在createActivityContext方法上。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ContextImpl.java" target="_blank" rel="noopener">ContextImpl.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">static</span> ContextImpl <span class="token function">createActivityContext</span><span class="token punctuation">(</span>ActivityThread mainThread<span class="token punctuation">,</span>
            LoadedApk packageInfo<span class="token punctuation">,</span> ActivityInfo activityInfo<span class="token punctuation">,</span> IBinder activityToken<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">,</span>
            Configuration overrideConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"packageInfo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String<span class="token punctuation">[</span><span class="token punctuation">]</span> splitDirs <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getSplitResDirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ClassLoader classLoader <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestsIsolatedSplitLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                classLoader <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getSplitClassLoader</span><span class="token punctuation">(</span>activityInfo<span class="token punctuation">.</span>splitName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                splitDirs <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getSplitPaths</span><span class="token punctuation">(</span>activityInfo<span class="token punctuation">.</span>splitName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Nothing above us can handle a NameNotFoundException, better crash.</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        ContextImpl context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> mainThread<span class="token punctuation">,</span> packageInfo<span class="token punctuation">,</span> activityInfo<span class="token punctuation">.</span>splitName<span class="token punctuation">,</span>
                activityToken<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Clamp display ID to DEFAULT_DISPLAY if it is INVALID_DISPLAY.</span>
        displayId <span class="token operator">=</span> <span class="token punctuation">(</span>displayId <span class="token operator">!=</span> Display<span class="token punctuation">.</span>INVALID_DISPLAY<span class="token punctuation">)</span> <span class="token operator">?</span> displayId <span class="token operator">:</span> Display<span class="token punctuation">.</span>DEFAULT_DISPLAY<span class="token punctuation">;</span>

        <span class="token keyword">final</span> CompatibilityInfo compatInfo <span class="token operator">=</span> <span class="token punctuation">(</span>displayId <span class="token operator">==</span> Display<span class="token punctuation">.</span>DEFAULT_DISPLAY<span class="token punctuation">)</span>
                <span class="token operator">?</span> packageInfo<span class="token punctuation">.</span><span class="token function">getCompatibilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> CompatibilityInfo<span class="token punctuation">.</span>DEFAULT_COMPATIBILITY_INFO<span class="token punctuation">;</span>

        <span class="token keyword">final</span> ResourcesManager resourcesManager <span class="token operator">=</span> ResourcesManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Create the base resources for which all configuration contexts for this Activity</span>
        <span class="token comment" spellcheck="true">// will be rebased upon.</span>
        context<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span>resourcesManager<span class="token punctuation">.</span><span class="token function">createBaseActivityResources</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">,</span>
                packageInfo<span class="token punctuation">.</span><span class="token function">getResDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                splitDirs<span class="token punctuation">,</span>
                packageInfo<span class="token punctuation">.</span><span class="token function">getOverlayDirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                packageInfo<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sharedLibraryFiles<span class="token punctuation">,</span>
                displayId<span class="token punctuation">,</span>
                overrideConfiguration<span class="token punctuation">,</span>
                compatInfo<span class="token punctuation">,</span>
                classLoader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>mDisplay <span class="token operator">=</span> resourcesManager<span class="token punctuation">.</span><span class="token function">getAdjustedDisplay</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span>
                context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面我们能够看到之前在插件话分析一文熟悉的LoadApk对象，这个对象代表这apk包在Android中的内存对象。关于这个对象，将会在PMS中和大家解析解析。</p>
<p>我们先不去细究这个对象是怎么来的。但是我们可以方法名字大致上知道做了如下几个事情：</p>
<ul>
<li>1.读取保存在LoadApk中的资源文件夹</li>
<li>2.读取LoadApk中的classLoader，作为当前应用的主要ClassLoader。</li>
<li>3.实例化ContextImpl，这个ContextImpl在绝大部分情况下就是我们应用开发常用的Context。</li>
<li>4.初始化ResourceManager，资源管理器</li>
<li><ol start="5">
<li>把资源管理设置到Context中，之后Context才具有访问资源的能力。</li>
</ol>
</li>
</ul>
<p>本文主要关注资源的加载，因此我们只需要研究ResourceManager，就能明白资源加载的原理了，关注下面这两行代码：</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">final</span> ResourcesManager resourcesManager <span class="token operator">=</span> ResourcesManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Create the base resources for which all configuration contexts for this Activity</span>
        <span class="token comment" spellcheck="true">// will be rebased upon.</span>
        context<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span>resourcesManager<span class="token punctuation">.</span><span class="token function">createBaseActivityResources</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">,</span>
                packageInfo<span class="token punctuation">.</span><span class="token function">getResDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                splitDirs<span class="token punctuation">,</span>
                packageInfo<span class="token punctuation">.</span><span class="token function">getOverlayDirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                packageInfo<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sharedLibraryFiles<span class="token punctuation">,</span>
                displayId<span class="token punctuation">,</span>
                overrideConfiguration<span class="token punctuation">,</span>
                compatInfo<span class="token punctuation">,</span>
                classLoader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因此，资源的初始化放在这个函数上：</p>
<ul>
<li>createBaseActivityResources 打开资源映射，初步解析Resource中的资源</li>
</ul>
<h2 id="createBaseActivityResources-打开资源映射"><a href="#createBaseActivityResources-打开资源映射" class="headerlink" title="createBaseActivityResources 打开资源映射"></a>createBaseActivityResources 打开资源映射</h2><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ResourcesManager.java" target="_blank" rel="noopener">ResourcesManager.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> Resources <span class="token function">createBaseActivityResources</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> IBinder activityToken<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> String resDir<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> splitResDirs<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> overlayDirs<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> libDirs<span class="token punctuation">,</span>
            <span class="token keyword">int</span> displayId<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> Configuration overrideConfig<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> CompatibilityInfo compatInfo<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ResourcesKey key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourcesKey</span><span class="token punctuation">(</span>
                    resDir<span class="token punctuation">,</span>
                    splitResDirs<span class="token punctuation">,</span>
                    overlayDirs<span class="token punctuation">,</span>
                    libDirs<span class="token punctuation">,</span>
                    displayId<span class="token punctuation">,</span>
                    overrideConfig <span class="token operator">!=</span> null <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>overrideConfig<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// Copy</span>
                    compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            classLoader <span class="token operator">=</span> classLoader <span class="token operator">!=</span> null <span class="token operator">?</span> classLoader <span class="token operator">:</span> ClassLoader<span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Force the creation of an ActivityResourcesStruct.</span>
                <span class="token function">getOrCreateActivityResourcesStructLocked</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Update any existing Activity Resources references.</span>
            <span class="token function">updateResourcesForActivity</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">,</span> overrideConfig<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span>
                    <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* movedToDifferentDisplay */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Now request an actual Resources object.</span>
            <span class="token keyword">return</span> <span class="token function">getOrCreateResources</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">,</span> key<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.基于所有的资源目录，显示屏id，配置生成一个ResourcesKey。</li>
<li><ol start="2">
<li>getOrCreateActivityResourcesStructLocked 生成ActivityResources并且保存在缓存到map。</li>
</ol>
</li>
<li><ol start="3">
<li>根据ResourcesKey，生成一个资源的实际操作者ResourceImpl。</li>
</ol>
</li>
</ul>
<h3 id="缓存ActivityResources到list中"><a href="#缓存ActivityResources到list中" class="headerlink" title="缓存ActivityResources到list中"></a>缓存ActivityResources到list中</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> ActivityResources <span class="token function">getOrCreateActivityResourcesStructLocked</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@NonNull</span> IBinder activityToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ActivityResources activityResources <span class="token operator">=</span> mActivityResourceReferences<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>activityResources <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            activityResources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mActivityResourceReferences<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">,</span> activityResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> activityResources<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ActivityResources</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> Configuration overrideConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>WeakReference<span class="token operator">&lt;</span>Resources<span class="token operator">>></span> activityResources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个缓存对象本质上控制着所有在Apk中所有的Resources资源对象，有了缓存之后，之后读取资源就不需要重新打开资源目录这些耗时操作。本质上和View的实例化一节中聊过的一样，为了减少反射的次数，会把已经反射过的View的构造函数保存下来，等待下次使用。</p>
<h3 id="根据ResourcesKey，生成ResourceImpl"><a href="#根据ResourcesKey，生成ResourceImpl" class="headerlink" title="根据ResourcesKey，生成ResourceImpl"></a>根据ResourcesKey，生成ResourceImpl</h3><h4 id="updateResourcesForActivity"><a href="#updateResourcesForActivity" class="headerlink" title="updateResourcesForActivity"></a>updateResourcesForActivity</h4><p>先来看看updateResourcesForActivity方法，更新Resource的配置。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateResourcesForActivity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> IBinder activityToken<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> Configuration overrideConfig<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> movedToDifferentDisplay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ActivityResources activityResources <span class="token operator">=</span>
                        <span class="token function">getOrCreateActivityResourcesStructLocked</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token comment" spellcheck="true">// Rebase each Resources associated with this Activity.</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> refCount <span class="token operator">=</span> activityResources<span class="token punctuation">.</span>activityResources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> refCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    WeakReference<span class="token operator">&lt;</span>Resources<span class="token operator">></span> weakResRef <span class="token operator">=</span> activityResources<span class="token punctuation">.</span>activityResources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                            i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Resources resources <span class="token operator">=</span> weakResRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>resources <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment" spellcheck="true">// Extract the ResourcesKey that was last used to create the Resources for this</span>
                    <span class="token comment" spellcheck="true">// activity.</span>
                    <span class="token keyword">final</span> ResourcesKey oldKey <span class="token operator">=</span> <span class="token function">findKeyForResourceImplLocked</span><span class="token punctuation">(</span>resources<span class="token punctuation">.</span><span class="token function">getImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldKey <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment" spellcheck="true">// Build the new override configuration for this ResourcesKey.</span>
                    <span class="token keyword">final</span> Configuration rebasedOverrideConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>overrideConfig <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        rebasedOverrideConfig<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>overrideConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>activityHasOverrideConfig <span class="token operator">&amp;&amp;</span> oldKey<span class="token punctuation">.</span><span class="token function">hasOverrideConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Generate a delta between the old base Activity override configuration and</span>
                        <span class="token comment" spellcheck="true">// the actual final override configuration that was used to figure out the</span>
                        <span class="token comment" spellcheck="true">// real delta this Resources object wanted.</span>
                        Configuration overrideOverrideConfig <span class="token operator">=</span> Configuration<span class="token punctuation">.</span><span class="token function">generateDelta</span><span class="token punctuation">(</span>
                                oldConfig<span class="token punctuation">,</span> oldKey<span class="token punctuation">.</span>mOverrideConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        rebasedOverrideConfig<span class="token punctuation">.</span><span class="token function">updateFrom</span><span class="token punctuation">(</span>overrideOverrideConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment" spellcheck="true">// Create the new ResourcesKey with the rebased override config.</span>
                    <span class="token keyword">final</span> ResourcesKey newKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourcesKey</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">.</span>mResDir<span class="token punctuation">,</span>
                            oldKey<span class="token punctuation">.</span>mSplitResDirs<span class="token punctuation">,</span>
                            oldKey<span class="token punctuation">.</span>mOverlayDirs<span class="token punctuation">,</span> oldKey<span class="token punctuation">.</span>mLibDirs<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span>
                            rebasedOverrideConfig<span class="token punctuation">,</span> oldKey<span class="token punctuation">.</span>mCompatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>


                    ResourcesImpl resourcesImpl <span class="token operator">=</span> <span class="token function">findResourcesImplForKeyLocked</span><span class="token punctuation">(</span>newKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcesImpl <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        resourcesImpl <span class="token operator">=</span> <span class="token function">createResourcesImpl</span><span class="token punctuation">(</span>newKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcesImpl <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mResourceImpls<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newKey<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>resourcesImpl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcesImpl <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> resourcesImpl <span class="token operator">!=</span> resources<span class="token punctuation">.</span><span class="token function">getImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Set the ResourcesImpl, updating it for all users of this Resources</span>
                        <span class="token comment" spellcheck="true">// object.</span>
                        resources<span class="token punctuation">.</span><span class="token function">setImpl</span><span class="token punctuation">(</span>resourcesImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法本质上是更新保存在activityResources的Resource实例。能看到每一次都会尝试通过组合出来的ResourceKey来寻找之前是否存在ResourcesKey老的ResourceKey。</p>
<p>没有则不会继续下去，有则会根据原来的老ResourceKey重新生成新的ResourceKey，中间改变的是配置，接着根据新的ResourceKey寻找ResourceImpl，不存在则创建一个，并且把key和ResourceImpl设置mResourceImpls。</p>
<p>能看到中间有2个核心的方法：</p>
<ul>
<li>findResourcesImplForKeyLocked 查找对应ResourcesImpl</li>
<li>createResourcesImpl 创建一个ResourcesImpl<br>先暂停在这里，我们先去看看getOrCreateResources，再回头看看这两个方法。</li>
</ul>
<h4 id="getOrCreateResources"><a href="#getOrCreateResources" class="headerlink" title="getOrCreateResources"></a>getOrCreateResources</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> Resources <span class="token function">getOrCreateResources</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> IBinder activityToken<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> ResourcesKey key<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span>activityToken <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ActivityResources activityResources <span class="token operator">=</span>
                        <span class="token function">getOrCreateActivityResourcesStructLocked</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Clean up any dead references so they don't pile up.</span>
                ArrayUtils<span class="token punctuation">.</span><span class="token function">unstableRemoveIf</span><span class="token punctuation">(</span>activityResources<span class="token punctuation">.</span>activityResources<span class="token punctuation">,</span>
                        sEmptyReferencePredicate<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Rebase the key's override config on top of the Activity's base override.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                ResourcesImpl resourcesImpl <span class="token operator">=</span> <span class="token function">findResourcesImplForKeyLocked</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcesImpl <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">return</span> <span class="token function">getOrCreateResourcesForActivityLocked</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">,</span> classLoader<span class="token punctuation">,</span>
                            resourcesImpl<span class="token punctuation">,</span> key<span class="token punctuation">.</span>mCompatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// We will create the ResourcesImpl object outside of holding this lock.</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Clean up any dead references so they don't pile up.</span>
                ArrayUtils<span class="token punctuation">.</span><span class="token function">unstableRemoveIf</span><span class="token punctuation">(</span>mResourceReferences<span class="token punctuation">,</span> sEmptyReferencePredicate<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Not tied to an Activity, find a shared Resources that has the right ResourcesImpl</span>
                ResourcesImpl resourcesImpl <span class="token operator">=</span> <span class="token function">findResourcesImplForKeyLocked</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcesImpl <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">return</span> <span class="token function">getOrCreateResourcesLocked</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> resourcesImpl<span class="token punctuation">,</span> key<span class="token punctuation">.</span>mCompatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// We will create the ResourcesImpl object outside of holding this lock.</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// If we're here, we didn't find a suitable ResourcesImpl to use, so create one now.</span>
            ResourcesImpl resourcesImpl <span class="token operator">=</span> <span class="token function">createResourcesImpl</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcesImpl <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Add this ResourcesImpl to the cache.</span>
            mResourceImpls<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>resourcesImpl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> Resources resources<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>activityToken <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resources <span class="token operator">=</span> <span class="token function">getOrCreateResourcesForActivityLocked</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">,</span> classLoader<span class="token punctuation">,</span>
                        resourcesImpl<span class="token punctuation">,</span> key<span class="token punctuation">.</span>mCompatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                resources <span class="token operator">=</span> <span class="token function">getOrCreateResourcesLocked</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> resourcesImpl<span class="token punctuation">,</span> key<span class="token punctuation">.</span>mCompatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> resources<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里分为两种情况：</p>
<ul>
<li>1.存在activityToken 是指开发应用层的应用</li>
<li>2.不存在activityToken 是指系统应用</li>
</ul>
<h4 id="当activityToken存在的时候"><a href="#当activityToken存在的时候" class="headerlink" title="当activityToken存在的时候"></a>当activityToken存在的时候</h4><p>当activityToken存在的时候，这里是指应用启动的时候要做的事情。</p>
<ul>
<li>1.首先会尝试去查找ResourcesImpl是否缓存起来，如下：<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> ResourcesImpl <span class="token function">findResourcesImplForKeyLocked</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> ResourcesKey key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      WeakReference<span class="token operator">&lt;</span>ResourcesImpl<span class="token operator">></span> weakImplRef <span class="token operator">=</span> mResourceImpls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ResourcesImpl impl <span class="token operator">=</span> weakImplRef <span class="token operator">!=</span> null <span class="token operator">?</span> weakImplRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>impl <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> impl<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUpToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> impl<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
能看到每一个ResourcesImpl将会保存到mResourceImpls这个ArrayMap中。</li>
</ul>
<p>当ResourceImpl存在会调用getOrCreateResourcesLocked，当通过ResourcesImpl反过来查找Resource代理类，没有找到，则会重新生成一个新的Resource，添加到mResourceReferences弱引用缓存中。</p>
<h5 id="ResourcesImpl的创建"><a href="#ResourcesImpl的创建" class="headerlink" title="ResourcesImpl的创建"></a>ResourcesImpl的创建</h5><p>当ResourcesImpl不存在的时候，就需要创建ResourcesImpl。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token annotation punctuation">@NonNull</span> ResourcesImpl <span class="token function">createResourcesImpl</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> ResourcesKey key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> DisplayAdjustments daj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayAdjustments</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>mOverrideConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        daj<span class="token punctuation">.</span><span class="token function">setCompatibilityInfo</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>mCompatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> AssetManager assets <span class="token operator">=</span> <span class="token function">createAssetManager</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> DisplayMetrics dm <span class="token operator">=</span> <span class="token function">getDisplayMetrics</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">,</span> daj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Configuration config <span class="token operator">=</span> <span class="token function">generateConfig</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ResourcesImpl impl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourcesImpl</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> dm<span class="token punctuation">,</span> config<span class="token punctuation">,</span> daj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"- creating impl="</span> <span class="token operator">+</span> impl <span class="token operator">+</span> <span class="token string">" with key: "</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> impl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在创建ResourcesImpl的同时会创建AssetManager。而这个AssetManager就是管理apk包中asset资源的管理者，我们只要需要访问资源就一定和它打交道。</p>
<h2 id="AssetManager的创建准备"><a href="#AssetManager的创建准备" class="headerlink" title="AssetManager的创建准备"></a>AssetManager的创建准备</h2><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token annotation punctuation">@Nullable</span> AssetManager <span class="token function">createAssetManager</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> ResourcesKey key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> AssetManager<span class="token punctuation">.</span>Builder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AssetManager<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span>mResDir <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                builder<span class="token punctuation">.</span><span class="token function">addApkAssets</span><span class="token punctuation">(</span><span class="token function">loadApkAssets</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>mResDir<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*sharedLib*/</span><span class="token punctuation">,</span>
                        <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*overlay*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"failed to add asset path "</span> <span class="token operator">+</span> key<span class="token punctuation">.</span>mResDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span>mSplitResDirs <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> String splitResDir <span class="token operator">:</span> key<span class="token punctuation">.</span>mSplitResDirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    builder<span class="token punctuation">.</span><span class="token function">addApkAssets</span><span class="token punctuation">(</span><span class="token function">loadApkAssets</span><span class="token punctuation">(</span>splitResDir<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*sharedLib*/</span><span class="token punctuation">,</span>
                            <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*overlay*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span>mOverlayDirs <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> String idmapPath <span class="token operator">:</span> key<span class="token punctuation">.</span>mOverlayDirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    builder<span class="token punctuation">.</span><span class="token function">addApkAssets</span><span class="token punctuation">(</span><span class="token function">loadApkAssets</span><span class="token punctuation">(</span>idmapPath<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*sharedLib*/</span><span class="token punctuation">,</span>
                            <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*overlay*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span>mLibDirs <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> String libDir <span class="token operator">:</span> key<span class="token punctuation">.</span>mLibDirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>libDir<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".apk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Avoid opening files we know do not have resources,</span>
                    <span class="token comment" spellcheck="true">// like code-only .jar files.</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        builder<span class="token punctuation">.</span><span class="token function">addApkAssets</span><span class="token punctuation">(</span><span class="token function">loadApkAssets</span><span class="token punctuation">(</span>libDir<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*sharedLib*/</span><span class="token punctuation">,</span>
                                <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*overlay*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看到这里，我们稍微回忆一下我写的插件化框架一文，其中有一段就是需要加载插件中的资源，在Android 9.0中需要用到一个核心方法addApkAssets；而在老版本中这里面的方法是assets.addAssetPath代替。为什么我们知道这样加载资源，是因为资源正是使用这种方式把资源加载到AssetManager。</p>
<p>这里的步骤可以分为2个步骤：</p>
<ul>
<li>loadApkAssets 读取资源目录的资源生成ApkAsset对象</li>
<li>addApkAssets把所有的对象都添加到AssetManager建造者中，最后生成AssetManager对象</li>
</ul>
<p>那么这里就有三个核心方法，一个是通过建造模式创建AssetManager，一个addApkAssets，一个loadApkAssets读取目录下的资源接下来，接下来一次看看这些完成什么？</p>
<h3 id="loadApkAssets-读取目录的资源，生成ApkAsset对象"><a href="#loadApkAssets-读取目录的资源，生成ApkAsset对象" class="headerlink" title="loadApkAssets 读取目录的资源，生成ApkAsset对象"></a>loadApkAssets 读取目录的资源，生成ApkAsset对象</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token annotation punctuation">@NonNull</span> ApkAssets <span class="token function">loadApkAssets</span><span class="token punctuation">(</span>String path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sharedLib<span class="token punctuation">,</span> <span class="token keyword">boolean</span> overlay<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> ApkKey newKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApkKey</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> sharedLib<span class="token punctuation">,</span> overlay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ApkAssets apkAssets <span class="token operator">=</span> mLoadedApkAssets<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>apkAssets <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> apkAssets<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Optimistically check if this ApkAssets exists somewhere else.</span>
        <span class="token keyword">final</span> WeakReference<span class="token operator">&lt;</span>ApkAssets<span class="token operator">></span> apkAssetsRef <span class="token operator">=</span> mCachedApkAssets<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>apkAssetsRef <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            apkAssets <span class="token operator">=</span> apkAssetsRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>apkAssets <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLoadedApkAssets<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newKey<span class="token punctuation">,</span> apkAssets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> apkAssets<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Clean up the reference.</span>
                mCachedApkAssets<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>newKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            apkAssets <span class="token operator">=</span> ApkAssets<span class="token punctuation">.</span><span class="token function">loadOverlayFromPath</span><span class="token punctuation">(</span><span class="token function">overlayPathToIdmapPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*system*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            apkAssets <span class="token operator">=</span> ApkAssets<span class="token punctuation">.</span><span class="token function">loadFromPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*system*/</span><span class="token punctuation">,</span> sharedLib<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mLoadedApkAssets<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newKey<span class="token punctuation">,</span> apkAssets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCachedApkAssets<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newKey<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>apkAssets<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> apkAssets<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="资源缓存思路"><a href="#资源缓存思路" class="headerlink" title="资源缓存思路"></a>资源缓存思路</h5><blockquote>
<p>我们能看到所有的资源目录路径下都会生成一个ApkAssets对象，并且缓存起来，做了二级缓存。</p>
</blockquote>
<ul>
<li>第一级缓存：mLoadedApkAssets保存这所有已经加载的了ApkAssets的强引用。</li>
<li>第二级缓存：mCachedApkAssets保存这所有加载过的ApkAssets的弱引用。</li>
</ul>
<p>首先先从mLoadedApkAssets查找是否已经存在已经加载的资源，找不到则尝试着从mCachedApkAssets中查找，如果找到了，则从mCachedApkAssets中移除，并且添加到mLoadedApkAssets中。</p>
<p>实际上这种思路在Glide中有体现，我们可以把这种缓存看作内存缓存，把缓存拆分两部分，活跃缓存以及非活跃缓存。活跃缓存持有强引用避免GC销毁，而非活跃活跃缓存则持有弱引用，就算GC销毁了也不会有什么问题。</p>
<p>当什么都找不到，只好从磁盘中读取资源。</p>
<h3 id="创建ApkAssets资源对象"><a href="#创建ApkAssets资源对象" class="headerlink" title="创建ApkAssets资源对象"></a>创建ApkAssets资源对象</h3><p>ApkAssets可以通过两种方式创建：</p>
<ul>
<li>ApkAssets.loadOverlayFromPath 当apk使用到了额外重叠的资源目录对应的ApkAsset</li>
<li>ApkAssets.loadFromPath 当apk使用一般的资源，比如的value资源，第三方资源库等创建对应的ApkAsset。</li>
</ul>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/" target="_blank" rel="noopener">res</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/res/ApkAssets.java" target="_blank" rel="noopener">ApkAssets.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token annotation punctuation">@NonNull</span> ApkAssets <span class="token function">loadOverlayFromPath</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> String idmapPath<span class="token punctuation">,</span> <span class="token keyword">boolean</span> system<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApkAssets</span><span class="token punctuation">(</span>idmapPath<span class="token punctuation">,</span> system<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*forceSharedLibrary*/</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*overlay*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token annotation punctuation">@NonNull</span> ApkAssets <span class="token function">loadFromPath</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> String path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> system<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> forceSharedLibrary<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApkAssets</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> system<span class="token punctuation">,</span> forceSharedLibrary<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*overlay*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token annotation punctuation">@NonNull</span> ApkAssets <span class="token function">loadFromPath</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> String path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> system<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApkAssets</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> system<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*forceSharedLib*/</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*overlay*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token function">ApkAssets</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> String path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> system<span class="token punctuation">,</span> <span class="token keyword">boolean</span> forceSharedLib<span class="token punctuation">,</span> <span class="token keyword">boolean</span> overlay<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        mNativePtr <span class="token operator">=</span> <span class="token function">nativeLoad</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> system<span class="token punctuation">,</span> forceSharedLib<span class="token punctuation">,</span> overlay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mStringBlock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBlock</span><span class="token punctuation">(</span><span class="token function">nativeGetStringBlock</span><span class="token punctuation">(</span>mNativePtr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*useSparse*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到每一个静态方法，最后都会通过构造函数的nativeLoad在native生成一个对应的地址指针，以及创建一个StringBlock。这里面究竟做了什么呢？让我们先来看看nativeLoad。</p>
<h4 id="ApkAssets的nativeLoad-创建native对象"><a href="#ApkAssets的nativeLoad-创建native对象" class="headerlink" title="ApkAssets的nativeLoad 创建native对象"></a>ApkAssets的nativeLoad 创建native对象</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_content_res_ApkAssets.cpp" target="_blank" rel="noopener">android_content_res_ApkAssets.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jlong <span class="token function">NativeLoad</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass <span class="token comment" spellcheck="true">/*clazz*/</span><span class="token punctuation">,</span> jstring java_path<span class="token punctuation">,</span> jboolean system<span class="token punctuation">,</span>
                        jboolean force_shared_lib<span class="token punctuation">,</span> jboolean overlay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ScopedUtfChars <span class="token function">path</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> java_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> ApkAssets<span class="token operator">></span> apk_assets<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    apk_assets <span class="token operator">=</span> ApkAssets<span class="token operator">::</span><span class="token function">LoadOverlay</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> system<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>force_shared_lib<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    apk_assets <span class="token operator">=</span> ApkAssets<span class="token operator">::</span><span class="token function">LoadAsSharedLibrary</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> system<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    apk_assets <span class="token operator">=</span> ApkAssets<span class="token operator">::</span><span class="token function">Load</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> system<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>apk_assets <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>jlong<span class="token operator">></span><span class="token punctuation">(</span>apk_assets<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，在这个native方法中一样分成三种情况去读取资源数据，生成ApkAssets native对象返回给java层。</p>
<ul>
<li>LoadOverlay 加载重叠资源</li>
<li>LoadAsSharedLibrary 加载第三方库资源</li>
<li>Load 加载一般的资源</li>
</ul>
<p>什么是重叠资源,引用罗生阳的解释？</p>
<blockquote>
<p>假设我们正在编译的是Package-1，这时候我们可以设置另外一个Package-2，用来告诉aapt，如果Package-2定义有和Package-1一样的资源，那么就用定义在Package-2的资源来替换掉定义在Package-1的资源。通过这种Overlay机制，我们就可以对资源进行定制，而又不失一般性。</p>
</blockquote>
<p>举一个例子，当我们下载某个主题并替换的时候，将会把整个Android相关的资源全部替换掉。此时会在overlay的文件夹中包含这个apk，这个apk只有资源，没有dex，并且把相关能替换的id写在某个文件。此时在初始化AssetManager会根据这个id替换掉所有的资源。和换肤框架相比，这是framework层面上的替换。</p>
<p>我们首先来看看加载一般资源的逻辑，Load。</p>
<h5 id="ApkAssets-Load-读取磁盘的资源"><a href="#ApkAssets-Load-读取磁盘的资源" class="headerlink" title="ApkAssets::Load 读取磁盘的资源"></a>ApkAssets::Load 读取磁盘的资源</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/" target="_blank" rel="noopener">androidfw</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/ApkAssets.cpp" target="_blank" rel="noopener">ApkAssets.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">const</span> std<span class="token operator">::</span>string <span class="token function">kResourcesArsc</span><span class="token punctuation">(</span><span class="token string">"resources.arsc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> ApkAssets<span class="token operator">></span> ApkAssets<span class="token operator">::</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">,</span> <span class="token keyword">bool</span> system<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">LoadImpl</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">/*fd*/</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> system<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*load_as_shared_library*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> ApkAssets<span class="token operator">></span> ApkAssets<span class="token operator">::</span><span class="token function">LoadImpl</span><span class="token punctuation">(</span>
    unique_fd fd<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">,</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Asset<span class="token operator">></span> idmap_asset<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> LoadedIdmap<span class="token operator">></span> loaded_idmap<span class="token punctuation">,</span> <span class="token keyword">bool</span> system<span class="token punctuation">,</span> <span class="token keyword">bool</span> load_as_shared_library<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">::</span>ZipArchiveHandle unmanaged_handle<span class="token punctuation">;</span>
  int32_t result<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span>
        <span class="token operator">::</span><span class="token function">OpenArchiveFd</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>unmanaged_handle<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*assume_ownership*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">OpenArchive</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>unmanaged_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>ApkAssets<span class="token operator">></span> <span class="token function">loaded_apk</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ApkAssets</span><span class="token punctuation">(</span>unmanaged_handle<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Find the resource table.</span>
  <span class="token operator">::</span>ZipString <span class="token function">entry_name</span><span class="token punctuation">(</span>kResourcesArsc<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">::</span>ZipEntry entry<span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">FindEntry</span><span class="token punctuation">(</span>loaded_apk<span class="token operator">-</span><span class="token operator">></span>zip_handle_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    loaded_apk<span class="token operator">-</span><span class="token operator">></span>loaded_arsc_ <span class="token operator">=</span> LoadedArsc<span class="token operator">::</span><span class="token function">CreateEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>loaded_apk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>method <span class="token operator">==</span> kCompressDeflated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>


  loaded_apk<span class="token operator">-</span><span class="token operator">></span>resources_asset_ <span class="token operator">=</span> loaded_apk<span class="token operator">-</span><span class="token operator">></span><span class="token function">Open</span><span class="token punctuation">(</span>kResourcesArsc<span class="token punctuation">,</span> Asset<span class="token operator">::</span>AccessMode<span class="token operator">::</span>ACCESS_BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded_apk<span class="token operator">-</span><span class="token operator">></span>resources_asset_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  loaded_apk<span class="token operator">-</span><span class="token operator">></span>idmap_asset_ <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>idmap_asset<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> StringPiece <span class="token function">data</span><span class="token punctuation">(</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>loaded_apk<span class="token operator">-</span><span class="token operator">></span>resources_asset_<span class="token operator">-</span><span class="token operator">></span><span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*wordAligned*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      loaded_apk<span class="token operator">-</span><span class="token operator">></span>resources_asset_<span class="token operator">-</span><span class="token operator">></span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  loaded_apk<span class="token operator">-</span><span class="token operator">></span>loaded_arsc_ <span class="token operator">=</span>
      LoadedArsc<span class="token operator">::</span><span class="token function">Load</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> loaded_idmap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> system<span class="token punctuation">,</span> load_as_shared_library<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded_apk<span class="token operator">-</span><span class="token operator">></span>loaded_arsc_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>loaded_apk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在LoadImpl中可以看见，资源的压缩算法是zip算法，因此我们看到在这个核心方法中，大致上把资源读取分为如下4个步骤：</p>
<ul>
<li>1.OpenArchive 打开zip文件，并且生成ApkAssets对象<br>-2.通过FindEntry，寻找apk包中的resource.arsc文件<ul>
<li>3.读取apk包中的resource.arsc文件，读取里面包含的id相关的map，以及资源asset文件夹中。</li>
</ul>
</li>
<li>4.生成StringPiece对象，接着通过LoadedArsc::Load读取其中的数据。</li>
</ul>
<p>关于zip有一篇写的比较好的文章：<a href="https://www.cnblogs.com/xumaojun/p/8544127.html" target="_blank" rel="noopener">https://www.cnblogs.com/xumaojun/p/8544127.html</a></p>
<p>zip算法本质上是一种无损压缩，通过短语式压缩，编码压缩(哈夫曼编码)进行压缩。同时我们看到Android中使用的是libziparchive,而这个内置的系统库不支持ZIP64，也就限制了包压缩的大小(必须小于32位字节就是4G)，这根本原因是系统限制了大小，而不是单单因为市场自己限制了apk大小。换句说，就算你强制生成一个过大apk包，android系统也会拒绝解析，核心检测在这里：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>file_length <span class="token operator">></span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>off64_t<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果熟悉这一块流程的哥们就一定知道resource.arsc是作为ResTable(资源表)的核心文件，等下我们在LoadedArsc::Load看看究竟做了什么。</p>
<p>现在我们只需要关心ApkAssets生成之后，Open方法读取了什么东西，StringPiece又是指代什么。</p>
<h4 id="ApkAssets-Open"><a href="#ApkAssets-Open" class="headerlink" title="ApkAssets.Open"></a>ApkAssets.Open</h4><pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Asset<span class="token operator">></span> ApkAssets<span class="token operator">::</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">,</span> Asset<span class="token operator">::</span>AccessMode mode<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token function">CHECK</span><span class="token punctuation">(</span>zip_handle_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">::</span>ZipString <span class="token function">name</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">::</span>ZipEntry entry<span class="token punctuation">;</span>
  int32_t result <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">FindEntry</span><span class="token punctuation">(</span>zip_handle_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>method <span class="token operator">==</span> kCompressDeflated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>FileMap<span class="token operator">></span> map <span class="token operator">=</span> util<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>FileMap<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token operator">-</span><span class="token operator">></span><span class="token function">create</span><span class="token punctuation">(</span>path_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">::</span><span class="token function">GetFileDescriptor</span><span class="token punctuation">(</span>zip_handle_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>offset<span class="token punctuation">,</span>
                     entry<span class="token punctuation">.</span>compressed_length<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*readOnly*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Asset<span class="token operator">></span> asset <span class="token operator">=</span>
        Asset<span class="token operator">::</span><span class="token function">createFromCompressedMap</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>uncompressed_length<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>asset <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> asset<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>FileMap<span class="token operator">></span> map <span class="token operator">=</span> util<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>FileMap<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token operator">-</span><span class="token operator">></span><span class="token function">create</span><span class="token punctuation">(</span>path_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">::</span><span class="token function">GetFileDescriptor</span><span class="token punctuation">(</span>zip_handle_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>offset<span class="token punctuation">,</span>
                     entry<span class="token punctuation">.</span>uncompressed_length<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*readOnly*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Asset<span class="token operator">></span> asset <span class="token operator">=</span> Asset<span class="token operator">::</span><span class="token function">createFromUncompressedMap</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>asset <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> asset<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>open方法的意思是，判断当前传进来的Zip的Entry，判断当前的entry是否是经过压缩。</p>
<ul>
<li><p>如果是经过压缩的模块，先通过FileMap把ZipEntry通过mmap映射到虚拟内存中(详细可以看看Binder的mmap映射原理一文)，接着通过Asset::createFromCompressedMap通过_CompressedAsset::openChunk拿到StreamingZipInflater，返回_CompressedAsset对象。</p>
</li>
<li><p>如果是没有压缩的模块，通过FileMap把ZipEntry通过mmap映射到虚拟内存中，最后Asset::createFromUncompressedMap，获取FileAsset对象.</p>
</li>
</ul>
<p>在这里，resource.arsc并没有在apk中没有压缩，因此走的下面，直接返回对应的FileAsset。</p>
<p>由此，可以得知，ApkAsset将会管理由ZipEntry映射出来的FileMap的Asset对象。</p>
<h3 id="resource-arsc存储内容"><a href="#resource-arsc存储内容" class="headerlink" title="resource.arsc存储内容"></a>resource.arsc存储内容</h3><p>这个方法就是解析整个Android资源表的方法，只要了解这个方法，就能明白，Android是怎么找到id资源的。可能光看源码很难有直观的了解其中的数据结构，先来看看apk包中resource.arsc究竟有什么东西。我们借助AS的解析器看看内部:<br><img src="/images/resource.arsc%E5%AD%98%E5%82%A8%E5%86%85%E5%AE%B9.png" alt="resource.arsc存储内容.png"></p>
<p>从这个表中能看到左边是资源的类型，右边是资源id以及资源具体的路径(或者具体的资源内容)。通常的，我们把resource.arsc中保存的资源映射表称为ResTable(资源表)。当然如果是类似String，id后面对应将会是字符串内容：<br><img src="/images/%E8%B5%84%E6%BA%90id.png" alt="资源id.png"></p>
<p>当我们使用apk内部资源的时候，一般会使用如R.id.xxx的方式引入，本质上R.id就是对应在这个的int类型。在打包的时候，会把对应的id打包到resource.arsc中，在运行阶段会解析这个文件，通过这个映射id，找到对应的路径，才能正确的找到我们需要资源。</p>
<p>之前在插件化基础框架一文中，曾经粗略的聊过每一个资源id的组成结构，这里就详细聊聊。<br>一旦提到resource.arsc文件中的数据结构，就一定会提到下面这幅图<br><img src="/images/resource.arsc%E8%B5%84%E6%BA%90%E7%BB%93%E6%9E%84.png" alt="resource.arsc资源结构.png"></p>
<h4 id="Android资源打包过程"><a href="#Android资源打包过程" class="headerlink" title="Android资源打包过程"></a>Android资源打包过程</h4><p>在聊resource.arsc之前，我先聊聊Android中这个目录下的资源打包工具<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/tools/aapt/" target="_blank" rel="noopener">/frameworks/base/tools/aapt/</a></p>
<p>aapt是我们开发中中经常打交道，但是从来没有注意过的工具。这个工具主要为我们apk收集打包资源文件，并且生成resource.arsc文件。在这个过程中，打包所有的xml资源文件的时候，会从文本格式转化为二进制格式。<br>这么做原因有两个：</p>
<ul>
<li><p>1.二进制的xml文件占用的空间更加小，所有的字符串都会被收集到字符串字典中(也叫字符串资源池)，对所有的字符串进行去重，重复的字符串都有个索引，本质上和zip的压缩很相似。</p>
</li>
<li><p>2.二进制的读取解析速度比文本速度快，因为字符串去重，需要读取的数据就小很多。</p>
<p>在整个apk包中拥有这如下几种资源：</p>
</li>
<li><p>1.二进制xml文件</p>
</li>
<li><p>2.resource.arsc文件</p>
</li>
<li><p>3.没有经过压缩的asset文件以及so库</p>
</li>
</ul>
<p>那么整个apk资源打包必然包含这几个过程。大致上可以分为如下三个大步骤：</p>
<ul>
<li>1.收集资源</li>
<li>2.收集Xml资源，压平Xml文件，转化为二进制Xml</li>
<li>3.收集资源生成resource.arsc文件</li>
</ul>
<p>整个打包大致上分为如下几个步骤：</p>
<h5 id="收集资源："><a href="#收集资源：" class="headerlink" title="收集资源："></a>收集资源：</h5><ul>
<li>1.解析AndroidManifest.xml,根据package标签创建ResourcesTable</li>
<li>2.添加被引用资源包。如系统的layout_width，如应用自己定义的资源，这些引用的资源包都会被添加进来。</li>
<li>3.收集资源文件</li>
<li>4.将收集到的资源文件添加到资源表</li>
<li>5.编译value类资源，在这个时候会为每一个资源的type添加一个资源的entry，每一个entry会根据配置生成不同的config。就如上图String资源，每一项字符串都称为entry，而字符串根据不同的语言映射着不同的真正字符串，这些称为config(配置)</li>
<li>6.给Bag资源分配ID。类型为values的资源除了是string之外，还有其它很多类型的资源，其中有一些比较特殊，如bag、style、plurals和array类的资源。这些资源会给自己定义一些专用的值，这些带有专用值的资源就统称为Bag资源</li>
</ul>
<h5 id="收集Xml资源"><a href="#收集Xml资源" class="headerlink" title="收集Xml资源"></a>收集Xml资源</h5><ul>
<li>7.编译Xml资源文件： 解析Xml文件，生成XMLNode</li>
<li>8.编译Xml资源文件：赋予属性名称资源ID,每一个Xml文件都是从根节点开始给属性名称赋予资源ID，然后再给递归给每一个子节点的属性名称赋予资源ID，直到每一个节点的属性名称都获得了资源ID为止。如下<br><img src="/images/view%E7%9A%84%E6%A0%87%E7%AD%BE.png" alt="view的标签.png"></li>
<li>9.编译Xml资源文件：解析属性值; 上一步是对Xml元素的属性的名称进行解析，这一步是对Xml元素的属性的值进行解析。通过上一步的资源id来查找bag中的对应的字符串，这就作为解析的结果。(“@+id/XXX”+符号的意思是如果没有对应的资源id就创建一个)</li>
</ul>
<h5 id="压平Xml资源"><a href="#压平Xml资源" class="headerlink" title="压平Xml资源"></a>压平Xml资源</h5><p>准备好Xml解析的资源就开始压平Xml文件，把文本的文件转化为二进制文件.</p>
<ul>
<li><p>10.收集具有资源id属性名称和字符串; 这一步除了收集那些具有资源ID的Xml元素属性的名称字符串之外，还会将对应的资源ID收集起来放在一个数组中。这里收集到的属性名称字符串保存在一个字符串资源池中，它们与收集到的资源ID数组是一一对应的。</p>
</li>
<li><p>11.收集其它字符串,如控件名称，命名空间等等</p>
</li>
<li><p>12.写入Xml文件头。包含了代表头部的type(RES_XML_TYPE)，头部大小，整个xml文件大小.最终编译出来的Xml二进制文件是一系列的chunk组成的，每一个chunk都有一个头部，用来描述chunk的元信息。同时，整个Xml二进制文件又可以看成一块总的chunk，它有一个类型为ResXMLTree_header的头部。</p>
</li>
<li><p>13.写入字符串资源池，此时把10步骤和11步骤的字符串严格按照顺序写入字符串池子。此时写入头部大小以及type为RES_STRING_POOL_TYPE</p>
</li>
<li><p>14.写入资源ID,在第10步骤中收集到的ID，将会按照顺序作为一个单独的chunk写入到xml文件中，这个chunk位于字符串池子后面。</p>
</li>
<li><p>15.压平Xml文件，把所有的字符串替换成字符串池子中的索引</p>
</li>
</ul>
<h5 id="生成resource-arsc资源表"><a href="#生成resource-arsc资源表" class="headerlink" title="生成resource.arsc资源表"></a>生成resource.arsc资源表</h5><p>从第一大步骤中，收集了大量的关于资源的数据，并且保存在资源表中(此时在内存)，此时需要真正的生成一个文件。</p>
<ul>
<li>16.收集类型字符串 如layout，id等</li>
<li>17.收集资源项名称字符串 获取类型字符串中每一项名称</li>
<li>18.收集资源项值字符串 获取每一项资源中具体的值。</li>
<li>14.写入Package资源项元信息数据块头部，写入type RES_TABLE_PACKAGE_TYPE</li>
<li>15.写入类型字符串资源池，指代的是(layout，menu,strings等xml文件名称)</li>
<li>16.写入资源项名称字符串资源池，指代的是每个资源类型中的数据项名称(如layout中有一个main.xml的文件名)</li>
<li>17.写入类型规范数据块，type为RES_TABLE_TYPE_SPEC_TYPE;类型规范指代就是这些（文件夹layout,menu中各种数据）。</li>
<li><ol start="18">
<li>写入类型资源项数据块，type为RES_TABLE_TYPE_TYPE，用来描述一个类型资源项头部。每一个资源项数据块都会指向一个资源entry，里面有着当前当前资源项在各种情况的真实数据,如mipmap，drawable在不同分辨率文件夹下具体文件路径。</li>
</ol>
</li>
<li><ol start="19">
<li>写入资源索引表头部，type为RES_TABLE_TYPE，此时size就是指resource.arsc大小</li>
</ol>
</li>
<li>20.写入资源项的值字符串资源池</li>
<li>21.写入Package数据块</li>
</ul>
<p>到这里就完成了resource.arsc文件的生成。</p>
<p>最后还需要几个额外的步骤，完善apk还没有打包的资源。</p>
<ul>
<li>1.AndroidMainfest.xml转化二进制文件</li>
<li>2.生成R.java文件</li>
<li>3.把assets目录，resources.arsc，二进制Xml文件打包到apk。</li>
</ul>
<p>至此，这就是Android打包的大致流程。</p>
<h3 id="resource-arsc文件数据结构剖析"><a href="#resource-arsc文件数据结构剖析" class="headerlink" title="resource.arsc文件数据结构剖析"></a>resource.arsc文件数据结构剖析</h3><p>根据上图以及上一节的打包流程，来分析resource.arsc文件。</p>
<p>在整个表的顶部保存着RES_TABLE_TYPE的标示位来标示着整个资源映射表是从哪里开始解析。后面接着这个头部的大小，整个文件的大小，保存着多少package的资源。</p>
<p>在整个资源映射表中，第一个chunk是字符串池子。type是RES_STRING_POOL_TYPE。在整个生成文件过程所有的资源值字符串都会经过收集，放到这个池子中，变成索引。</p>
<p>最后这一大块，就是生成resource.arsc文件最后写入的Package数据块。<br>packge数据大致分为如下几大块:</p>
<ul>
<li>1.Package的头部，type为RES_TABLE_PACKAGE_TYPE。</li>
<li>2.Package的类型规范名称字符串，资源类型值名称字符串资源池</li>
<li>3.Package的RES_TABLE_TYPE_SPEC_TYPE类型规范的头部</li>
<li>4.Package RES_TABLE_TYPE_TYPE 类型资源项的头部，里面有指向entry的指针。</li>
</ul>
<p>大致上了解整个resource.arsc文件后，看看LoadedArsc::Load是如何解析的。</p>
<h4 id="LoadedArsc-Load"><a href="#LoadedArsc-Load" class="headerlink" title="LoadedArsc::Load"></a>LoadedArsc::Load</h4><pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> LoadedArsc<span class="token operator">></span> LoadedArsc<span class="token operator">::</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword">const</span> StringPiece<span class="token operator">&amp;</span> data<span class="token punctuation">,</span>
                                                   <span class="token keyword">const</span> LoadedIdmap<span class="token operator">*</span> loaded_idmap<span class="token punctuation">,</span> <span class="token keyword">bool</span> system<span class="token punctuation">,</span>
                                                   <span class="token keyword">bool</span> load_as_shared_library<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>LoadedArsc<span class="token operator">></span> <span class="token function">loaded_arsc</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">LoadedArsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  loaded_arsc<span class="token operator">-</span><span class="token operator">></span>system_ <span class="token operator">=</span> system<span class="token punctuation">;</span>

  ChunkIterator <span class="token function">iter</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">HasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> Chunk chunk <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> RES_TABLE_TYPE<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loaded_arsc<span class="token operator">-</span><span class="token operator">></span><span class="token function">LoadTable</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> loaded_idmap<span class="token punctuation">,</span> load_as_shared_library<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>进来第一件事情就是把所有zip的chunk解析出来后，迭代寻找resource.arsc文件的标志头RES_TABLE_TYPE。找到之后，开始读取这个数据，寻找的是上面结构的如下结构:<br><img src="/images/RES_TABLE_TYPE.png" alt="RES_TABLE_TYPE.png"></p>
<h4 id="LoadedArsc-LoadTable"><a href="#LoadedArsc-LoadTable" class="headerlink" title="LoadedArsc::LoadTable"></a>LoadedArsc::LoadTable</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> LoadedArsc<span class="token operator">::</span><span class="token function">LoadTable</span><span class="token punctuation">(</span><span class="token keyword">const</span> Chunk<span class="token operator">&amp;</span> chunk<span class="token punctuation">,</span> <span class="token keyword">const</span> LoadedIdmap<span class="token operator">*</span> loaded_idmap<span class="token punctuation">,</span>
                           <span class="token keyword">bool</span> load_as_shared_library<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ResTable_header<span class="token operator">*</span> header <span class="token operator">=</span> chunk<span class="token punctuation">.</span>header<span class="token operator">&lt;</span>ResTable_header<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">const</span> size_t package_count <span class="token operator">=</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>header<span class="token operator">-</span><span class="token operator">></span>packageCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t packages_seen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  packages_<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>package_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

  ChunkIterator <span class="token function">iter</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">data_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> chunk<span class="token punctuation">.</span><span class="token function">data_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">HasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> Chunk child_chunk <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>child_chunk<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> RES_STRING_POOL_TYPE<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>global_string_pool_<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NO_INIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          status_t err <span class="token operator">=</span> global_string_pool_<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>child_chunk<span class="token punctuation">.</span>header<span class="token operator">&lt;</span>ResStringPool_header<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                   child_chunk<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> RES_TABLE_PACKAGE_TYPE<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packages_seen <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">></span> package_count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        packages_seen<span class="token operator">++</span><span class="token punctuation">;</span>

        std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> LoadedPackage<span class="token operator">></span> loaded_package <span class="token operator">=</span>
            LoadedPackage<span class="token operator">::</span><span class="token function">Load</span><span class="token punctuation">(</span>child_chunk<span class="token punctuation">,</span> loaded_idmap<span class="token punctuation">,</span> system_<span class="token punctuation">,</span> load_as_shared_library<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loaded_package<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        packages_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>loaded_package<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">default</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在LoadPackage方法中，分别加载两个大区域的数据：</p>
<ul>
<li><p>1.RES_STRING_POOL_TYPE 象征着资源中所有字符串,style的资源池(不包括资源类型名称，以及资源数据项名称)。解析的是如下部分：<br><img src="/images/RES_STRING_POOL_TYPE.png" alt="RES_STRING_POOL_TYPE.png"><br>比如：string.xml,某个R.string.xxx 中的值，比如drawable文件夹中，某个文件的具体路径</p>
</li>
<li><p>2.RES_TABLE_PACKAGE_TYPE  象征着整个Package数据块，解析的是如下这部分:<br><img src="/images/RES_TABLE_PACKAGE_TYPE.png" alt="RES_TABLE_PACKAGE_TYPE.png"></p>
</li>
</ul>
<h4 id="ResStringPool的解析过程"><a href="#ResStringPool的解析过程" class="headerlink" title="ResStringPool的解析过程"></a>ResStringPool的解析过程</h4><p>我们先来看看加载到内存中的Xml字符串资源池的结构体:</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> ResStringPool_header
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ResChunk_header header<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Number of strings in this pool (number of uint32_t indices that follow</span>
    <span class="token comment" spellcheck="true">// in the data).</span>
    uint32_t stringCount<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Number of style span arrays in the pool (number of uint32_t indices</span>
    <span class="token comment" spellcheck="true">// follow the string indices).</span>
    uint32_t styleCount<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Flags.</span>
    <span class="token keyword">enum</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// If set, the string index is sorted by the string values (based</span>
        <span class="token comment" spellcheck="true">// on strcmp16()).</span>
        SORTED_FLAG <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">,</span>

        <span class="token comment" spellcheck="true">// String pool is encoded in UTF-8</span>
        UTF8_FLAG <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    uint32_t flags<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Index from header of the string data.</span>
    uint32_t stringsStart<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Index from header of the style data.</span>
    uint32_t stylesStart<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个数据结构实际上是字符串资源池的这一部分:<br><img src="/images/ResStringPool_header.png" alt="ResStringPool_header.png"></p>
<p>我们可以从该头部解析到整个资源池的大小，字符串个数，style个数，标记，以及字符串池子起始位置偏移量和style池子的起始位置偏移量。</p>
<p>计算原理实际上就很简单：</p>
<blockquote>
<p>字符串池子的起点位置 = header地址+stringsStart<br>style 资源池的起点位置 = header地址+stylesStart</p>
</blockquote>
<p>值得注意的是字符串/style的个数并是指写入字符串/style的条数。为在setTo方法中会通过偏移量去计算整个资源StringPool/StylePool占用多少char。</p>
<p>我们还有一处值得注意的是，在整个字符串资源池中，还有两个比较重要的Entrys还没聊,这两个entry(偏移数组)的位置在图中如下，在header的后方:<br><img src="/images/%E5%81%8F%E7%A7%BB%E6%95%B0%E7%BB%84.png" alt="偏移数组.png"></p>
<p>这两个偏移数组做的事情比较重要，当我们尝试着通过index去查找String的内容，就要访问这个偏移数组，来找到对应字符串的在整个池子中的位置。计算方法如下：</p>
<blockquote>
<p>字符串偏移数组起点 = header + header.size<br>style偏移数组起点位置 = 字符串偏移数组起点 + 字符串大小</p>
</blockquote>
<p>因为资源的写入是严格按照顺序写入的，那么通过index互相查找资源成为了可能,我们来看看string8At查找字符串的方法看看：<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/" target="_blank" rel="noopener">androidfw</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/androidfw/ResourceTypes.cpp" target="_blank" rel="noopener">ResourceTypes.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ResStringPool<span class="token operator">::</span><span class="token function">string8At</span><span class="token punctuation">(</span>size_t idx<span class="token punctuation">,</span> size_t<span class="token operator">*</span> outLen<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mError <span class="token operator">==</span> NO_ERROR <span class="token operator">&amp;&amp;</span> idx <span class="token operator">&lt;</span> mHeader<span class="token operator">-</span><span class="token operator">></span>stringCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mHeader<span class="token operator">-</span><span class="token operator">></span>flags<span class="token operator">&amp;</span>ResStringPool_header<span class="token operator">::</span>UTF8_FLAG<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> uint32_t off <span class="token operator">=</span> mEntries<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>off <span class="token operator">&lt;</span> <span class="token punctuation">(</span>mStringPoolSize<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> strings <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token operator">*</span><span class="token punctuation">)</span>mStrings<span class="token punctuation">;</span>
            <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> str <span class="token operator">=</span> strings<span class="token operator">+</span>off<span class="token punctuation">;</span>

            <span class="token function">decodeLength</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">const</span> size_t encLen <span class="token operator">=</span> <span class="token function">decodeLength</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>outLen <span class="token operator">=</span> encLen<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">(</span>str<span class="token operator">+</span>encLen<span class="token operator">-</span>strings<span class="token punctuation">)</span> <span class="token operator">&lt;</span> mStringPoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">stringDecodeAt</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> str<span class="token punctuation">,</span> encLen<span class="token punctuation">,</span> outLen<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在Android底层有一层缓存mCache，里面存放着已经解析过的长度为uint_16较长的资源字符串。</p>
<p>解析String的算法如下：</p>
<blockquote>
<p>首先通过index，找到对应Entry中的数组中对应的元素off. uint32_t off = Entries[index]</p>
</blockquote>
<blockquote>
<p>当偏移元素 off 最高两位没有设置，说明这就是当前字符串的距离资源池起点的偏移量，如果设置了最高两位，则清除掉当前的最高位置，把当前的len和下个字符的加到一起。这样就灵活合并了字符串。</p>
</blockquote>
<blockquote>
<p>对应字符串string 起点地址(单位uint8_t) = mString(字符串资源池起点地址) + off</p>
</blockquote>
<p>最后调用下面这个方法解析资源池中的字符串：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ResStringPool<span class="token operator">::</span><span class="token function">stringDecodeAt</span><span class="token punctuation">(</span>size_t idx<span class="token punctuation">,</span> <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> str<span class="token punctuation">,</span>
                                          <span class="token keyword">const</span> size_t encLen<span class="token punctuation">,</span> size_t<span class="token operator">*</span> outLen<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> uint8_t<span class="token operator">*</span> strings <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token operator">*</span><span class="token punctuation">)</span>mStrings<span class="token punctuation">;</span>

    size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> end <span class="token operator">=</span> encLen<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">(</span>str<span class="token operator">+</span>end<span class="token operator">-</span>strings<span class="token punctuation">)</span> <span class="token operator">&lt;</span> mStringPoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">[</span>end<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token operator">*</span>outLen <span class="token operator">=</span> end<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">++</span>i <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> encLen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Reject malformed (non null-terminated) strings</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里面这里面的算法如下：</p>
<blockquote>
<p>在String资源池的大小限制下，unit_8长度下，不断的写入字符串，并且整个数据不断向左移动15位，遇到了0x00就停止解析，并且把结果设置到outLen中。一般的outLen是指向encLen的指针，encLen是内容，而encLen是通过解析str的内容来的，因此这个方法本质上就是写入到str中。</p>
</blockquote>
<p>确实很绕，不过没有这么难懂。</p>
<p>最后再把这个资源池，设置到全局资源global_string_pool_中，方便后面的查找。</p>
<h4 id="Package数据块解析，LoadedPackage-Load"><a href="#Package数据块解析，LoadedPackage-Load" class="headerlink" title="Package数据块解析，LoadedPackage::Load"></a>Package数据块解析，LoadedPackage::Load</h4><pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> LoadedPackage<span class="token operator">></span> LoadedPackage<span class="token operator">::</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword">const</span> Chunk<span class="token operator">&amp;</span> chunk<span class="token punctuation">,</span>
                                                         <span class="token keyword">const</span> LoadedIdmap<span class="token operator">*</span> loaded_idmap<span class="token punctuation">,</span>
                                                         <span class="token keyword">bool</span> system<span class="token punctuation">,</span> <span class="token keyword">bool</span> load_as_shared_library<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ATRACE_NAME</span><span class="token punctuation">(</span><span class="token string">"LoadedPackage::Load"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>LoadedPackage<span class="token operator">></span> <span class="token function">loaded_package</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">LoadedPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// typeIdOffset was added at some point, but we still must recognize apps built before this</span>
  <span class="token comment" spellcheck="true">// was added.</span>
  <span class="token keyword">constexpr</span> size_t kMinPackageSize <span class="token operator">=</span>
      <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResTable_package<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResTable_package<span class="token operator">::</span>typeIdOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ResTable_package<span class="token operator">*</span> header <span class="token operator">=</span> chunk<span class="token punctuation">.</span>header<span class="token operator">&lt;</span>ResTable_package<span class="token punctuation">,</span> kMinPackageSize<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>header <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  loaded_package<span class="token operator">-</span><span class="token operator">></span>system_ <span class="token operator">=</span> system<span class="token punctuation">;</span>

  loaded_package<span class="token operator">-</span><span class="token operator">></span>package_id_ <span class="token operator">=</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>header<span class="token operator">-</span><span class="token operator">></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded_package<span class="token operator">-</span><span class="token operator">></span>package_id_ <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>loaded_package<span class="token operator">-</span><span class="token operator">></span>package_id_ <span class="token operator">==</span> kAppPackageId <span class="token operator">&amp;&amp;</span> load_as_shared_library<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Package ID of 0 means this is a shared library.</span>
    loaded_package<span class="token operator">-</span><span class="token operator">></span>dynamic_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded_idmap <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    loaded_package<span class="token operator">-</span><span class="token operator">></span>package_id_ <span class="token operator">=</span> loaded_idmap<span class="token operator">-</span><span class="token operator">></span><span class="token function">TargetPackageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loaded_package<span class="token operator">-</span><span class="token operator">></span>overlay_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token operator">-</span><span class="token operator">></span>header<span class="token punctuation">.</span>headerSize <span class="token operator">>=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResTable_package<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint32_t type_id_offset <span class="token operator">=</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>header<span class="token operator">-</span><span class="token operator">></span>typeIdOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type_id_offset <span class="token operator">></span> std<span class="token operator">::</span>numeric_limits<span class="token operator">&lt;</span>uint8_t<span class="token operator">></span><span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    loaded_package<span class="token operator">-</span><span class="token operator">></span>type_id_offset_ <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>type_id_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  util<span class="token operator">::</span><span class="token function">ReadUtf16StringFromDevice</span><span class="token punctuation">(</span>header<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">,</span> <span class="token function">arraysize</span><span class="token punctuation">(</span>header<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  <span class="token operator">&amp;</span>loaded_package<span class="token operator">-</span><span class="token operator">></span>package_name_<span class="token punctuation">)</span><span class="token punctuation">;</span>


  std<span class="token operator">::</span>unordered_map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>TypeSpecPtrBuilder<span class="token operator">>></span> type_builder_map<span class="token punctuation">;</span>

  ChunkIterator <span class="token function">iter</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">data_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> chunk<span class="token punctuation">.</span><span class="token function">data_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">HasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> Chunk child_chunk <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>child_chunk<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> RES_STRING_POOL_TYPE<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> RES_TABLE_TYPE_SPEC_TYPE<span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> RES_TABLE_TYPE_TYPE<span class="token operator">:</span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> RES_TABLE_LIBRARY_TYPE<span class="token operator">:</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

     <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">default</span><span class="token operator">:</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment" spellcheck="true">// Flatten and construct the TypeSpecs.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> entry <span class="token operator">:</span> type_builder_map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint8_t type_idx <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint8_t<span class="token operator">></span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
    TypeSpecPtr type_spec_ptr <span class="token operator">=</span> entry<span class="token punctuation">.</span>second<span class="token operator">-</span><span class="token operator">></span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// We only add the type to the package if there is no IDMAP, or if the type is</span>
    <span class="token comment" spellcheck="true">// overlaying something.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded_idmap <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> type_spec_ptr<span class="token operator">-</span><span class="token operator">></span>idmap_entries <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// If this is an overlay, insert it at the target type ID.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type_spec_ptr<span class="token operator">-</span><span class="token operator">></span>idmap_entries <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        type_idx <span class="token operator">=</span> <span class="token function">dtohs</span><span class="token punctuation">(</span>type_spec_ptr<span class="token operator">-</span><span class="token operator">></span>idmap_entries<span class="token operator">-</span><span class="token operator">></span>target_type_id<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      loaded_package<span class="token operator">-</span><span class="token operator">></span>type_specs_<span class="token punctuation">.</span><span class="token function">editItemAt</span><span class="token punctuation">(</span>type_idx<span class="token punctuation">)</span> <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>type_spec_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>loaded_package<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据type，我们就能区分如下几种类型：</p>
<ul>
<li>1.RES_TABLE_PACKAGE_TYPE   解析头部，解析如下部分的数据:<br><img src="/images/RES_TABLE_PACKAGE_TYPE%E5%A4%B4%E9%83%A8.png" alt="RES_TABLE_PACKAGE_TYPE头部.png"></li>
<li>2.RES_STRING_POOL_TYPE 从资源类型字符串池子和资源项名称字符串池子解析所有资源类型名称，资源数据项名称中的字符串<br><img src="/images/%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B%E5%AD%97%E7%AC%A6%E4%B8%B2.png" alt="资源类型字符串.png"></li>
<li>3.RES_TABLE_TYPE_SPEC_TYPE 解析所有的资源类型规范<br><img src="/images/%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B.png" alt="资源类型规范.png"></li>
<li>4.RES_TABLE_TYPE_TYPE 解析所有的资源类型<br><img src="/images/%E6%89%80%E6%9C%89%E7%9A%84%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B.png" alt="所有的资源类型.png"></li>
<li>5.RES_TABLE_LIBRARY_TYPE 解析所有的第三方库资源，这里的图片没有显示。</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>限于文章的长度，本文剖析到这里，下一篇将会剖析资源类型规范，资源数据项，AssetManager的核心原理。在这里面，本文讲述了如下内容:<br>Resource 是由ResourcesImpl控制的。ApkAssets是每个资源文件夹在内存中的对象。AssetManager伴随着ResourcesImpl初始化而存在，其目的是为了更好的管理每一个ApkAssets。<br>在整个Android 资源体系的Java层中有四重缓存:</p>
<ul>
<li>1.activityResources 一个面向Resources弱引用的ArrayList</li>
<li>2.以ResourcesKey为key，ResourcesImpl的弱引用为value的Map缓存。</li>
<li>3.ApkAssets在内存中也有一层缓存，缓存拆成两部分，mLoadedApkAssets已经加载的活跃ApkAssets，mCacheApkAssets已经加载了但是不活跃的ApkAssets</li>
<li>4.native加载磁盘资源(加载磁盘资源过程中还有一些缓存)</li>
</ul>
<p>对于Android系统来说，resources.arsc文件尤为重要，它充当了Android系统解析资源的向导，没有了它，Android中的应用无法正常解析数据。</p>
<p>该文件大致分为如下几个部分，注意一下虽然存在多个字符串资源池但是存放的数据不一样:</p>
<ul>
<li>1.resources.arsc头部信息，type为RES_TABLE_TYPE</li>
<li>2.解析资源中所有的字符串，style字符串，type为RES_STRING_POOL_TYPE</li>
<li>3.剩下全部为Package数据块，type为RES_TABLE_PACKAGE_TYPE</li>
<li><ol start="4">
<li>RES_TABLE_PACKAGE_TYPE 代表这Package数据块的头部</li>
</ol>
</li>
<li>5.在Package数据块中同样存在着资源池，不过这个资源池存放的是资源类型规范字符串以及资源数据字符串。type为RES_STRING_POOL_TYPE</li>
<li><ol start="6">
<li>RES_TABLE_TYPE_SPEC_TYPE 代表这所有资源类型规范数据块(chunk)</li>
</ol>
</li>
<li>7.RES_TABLE_TYPE_TYPE 代表着所有资源数据数据块<ul>
<li>8.RES_TABLE_LIBRARY_TYPE代表所有的第三方资源库。</li>
</ul>
</li>
</ul>
<p>三个不同的字符串资源池，就以layout文件夹为例子：<br><img src="/images/%E4%B8%89%E4%B8%AA%E4%B8%8D%E5%90%8C%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%B5%84%E6%BA%90%E6%B1%A0.png" alt="三个不同的字符串资源池.png"></p>
<ul>
<li>下标1最左侧指代的是资源类型名称，也就是位于package数据块中，typeString偏移数组以及类型字符串资源池的数据，RES_TABLE_TYPE_SPEC_TYPE 也是从这里找到正确的名称</li>
<li>下标2 指代的是的是资源数据项名称，也就是位于package数据块中，String偏移数组以及资源数据项字符串资源池，RES_TABLE_TYPE_TYPE 也是从这里找到正确的名称。</li>
<li>下标3,指代的是资源字符串，位于package数据块之外，最大的字符串资源池。</li>
</ul>
<p>通过这几个资源池，加上资源数据项中指向的config数据项中的数据，就能正确的从resource.arsc文件中复原资源出来。</p>
<p>Android为了加速资源的加载速度，并不是直接通过File读写操作读取资源信息。而是通过FileMap的方式，也就是mmap把文件地址映射到虚拟内存中，时刻准备读写。这么做的好处，就是mmap回返回文件的地址，可以对文件进行操作，节省系统调用的开销，坏处就是mmap会映射到虚拟内存中，是的虚拟内存增大。更加详细的讨论，在Binder的mmap映射原理一文中。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/11/03/android-chong-xue-xi-lie-zi-yuan-guan-li-xi-tong-zi-yuan-de-chu-shi-hua-jia-zai-xia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="Android 重学系列 资源管理系统 资源的初始化加载(下)">
                        
                        <span class="card-title">Android 重学系列 资源管理系统 资源的初始化加载(下)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章，聊到了资源管理中解析Package数据模块中的LoadedPackage::Load方法开始解析Package数据块。本文将会详细解析Package数据块的解析，以及AssetManager如何管理。接下来解析resourc
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-11-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-资源系统/" class="post-category">
                                    Android 资源系统
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/10/19/okhttp-xi-lie-jie-xi-yi-okio-yuan-ma-jie-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="OKHttp系列解析(一) Okio源码解析">
                        
                        <span class="card-title">OKHttp系列解析(一) Okio源码解析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言好久没有更新，最近在阅读flutter相关源码。之后会整理一下，把自己的学习源码思考写出来。最近看到了flutter的http请求，dio相关的源码，不由的想到在Android开发中常用网络请求，OKHttp是怎么工作的。想起这一块没有
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-10-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-常用第三方库/" class="post-category">
                                    Android 常用第三方库
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-常用第三方库/">
                        <span class="chip bg-color">Android 常用第三方库</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
