<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 Activity的启动流程(二), Android | Linux | Flutter">
    <meta name="description" content="正文如果遇到错误，请在本文指出：https://www.jianshu.com/p/4d34de4418e0
上篇，讲述的在正式启动前，做了权限判断，再准备ActivityRecord，本文将介绍在Activity启动中，Activity的">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 Activity的启动流程(二) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 Activity的启动流程(二)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android-Framework/" class="post-category">
                                Android Framework
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-06-09
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        10.1k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        46 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>如果遇到错误，请在本文指出：<a href="https://www.jianshu.com/p/4d34de4418e0" target="_blank" rel="noopener">https://www.jianshu.com/p/4d34de4418e0</a></p>
<p>上篇，讲述的在正式启动前，做了权限判断，再准备ActivityRecord，本文将介绍在Activity启动中，Activity的栈的变化。</p>
<h2 id="startActivityUnchecked-初步处理Activity的栈"><a href="#startActivityUnchecked-初步处理Activity的栈" class="headerlink" title="startActivityUnchecked 初步处理Activity的栈"></a>startActivityUnchecked 初步处理Activity的栈</h2><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java" target="_blank" rel="noopener">ActivityStarter.java</a></p>
<p>在这个方法中，就是面试常问的启动模式，几种模式混搭在一次，在栈内的情况。</p>
<p>这里我分为7个步骤来详细剖析Activity栈的算法。</p>
<h3 id="初始化计算Activity栈"><a href="#初始化计算Activity栈" class="headerlink" title="初始化计算Activity栈"></a>初始化计算Activity栈</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span><span class="token keyword">final</span> ActivityRecord r<span class="token punctuation">,</span> ActivityRecord sourceRecord<span class="token punctuation">,</span>
            IVoiceInteractionSession voiceSession<span class="token punctuation">,</span> IVoiceInteractor voiceInteractor<span class="token punctuation">,</span>
            <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> ActivityOptions options<span class="token punctuation">,</span> TaskRecord inTask<span class="token punctuation">,</span>
            ActivityRecord<span class="token punctuation">[</span><span class="token punctuation">]</span> outActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">setInitialState</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span>
                voiceInteractor<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token function">computeLaunchingTaskFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">computeSourceStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>mLaunchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ActivityRecord reusedActivity <span class="token operator">=</span> <span class="token function">getReusableIntentActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="setInitialState初始化如下的数据"><a href="#setInitialState初始化如下的数据" class="headerlink" title="setInitialState初始化如下的数据"></a>setInitialState初始化如下的数据</h3><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setInitialState</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span> ActivityOptions options<span class="token punctuation">,</span> TaskRecord inTask<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> ActivityRecord sourceRecord<span class="token punctuation">,</span>
            IVoiceInteractionSession voiceSession<span class="token punctuation">,</span> IVoiceInteractor voiceInteractor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reset</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* clearRequest */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mStartActivity <span class="token operator">=</span> r<span class="token punctuation">;</span>
        mIntent <span class="token operator">=</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">;</span>
        mOptions <span class="token operator">=</span> options<span class="token punctuation">;</span>
        mCallingUid <span class="token operator">=</span> r<span class="token punctuation">.</span>launchedFromUid<span class="token punctuation">;</span>
        mSourceRecord <span class="token operator">=</span> sourceRecord<span class="token punctuation">;</span>
        mVoiceSession <span class="token operator">=</span> voiceSession<span class="token punctuation">;</span>
        mVoiceInteractor <span class="token operator">=</span> voiceInteractor<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//获取一个优先的逻辑显示器，是否是vr模式(相关源码会在之后说DisplayService)</span>
        mPreferredDisplayId <span class="token operator">=</span> <span class="token function">getPreferedDisplayId</span><span class="token punctuation">(</span>mSourceRecord<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mLaunchParams<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mSupervisor<span class="token punctuation">.</span><span class="token function">getLaunchParamsController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span>inTask<span class="token punctuation">,</span> null <span class="token comment" spellcheck="true">/*layout*/</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span>
                options<span class="token punctuation">,</span> mLaunchParams<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mLaunchMode <span class="token operator">=</span> r<span class="token punctuation">.</span>launchMode<span class="token punctuation">;</span>

        mLaunchFlags <span class="token operator">=</span> <span class="token function">adjustLaunchFlagsToDocumentMode</span><span class="token punctuation">(</span>
                r<span class="token punctuation">,</span> LAUNCH_SINGLE_INSTANCE <span class="token operator">==</span> mLaunchMode<span class="token punctuation">,</span>
                LAUNCH_SINGLE_TASK <span class="token operator">==</span> mLaunchMode<span class="token punctuation">,</span> mIntent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLaunchTaskBehind <span class="token operator">=</span> r<span class="token punctuation">.</span>mLaunchTaskBehind
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isLaunchModeOneOf</span><span class="token punctuation">(</span>LAUNCH_SINGLE_TASK<span class="token punctuation">,</span> LAUNCH_SINGLE_INSTANCE<span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_NEW_DOCUMENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token function">sendNewTaskResultRequestIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_NEW_DOCUMENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>resultTo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mLaunchFlags <span class="token operator">|=</span> FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// If we are actually going to launch in to a new task, there are some cases where</span>
        <span class="token comment" spellcheck="true">// we further want to do multiple task.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLaunchTaskBehind
                    <span class="token operator">||</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>documentLaunchMode <span class="token operator">==</span> DOCUMENT_LAUNCH_ALWAYS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLaunchFlags <span class="token operator">|=</span> FLAG_ACTIVITY_MULTIPLE_TASK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// We'll invoke onUserLeaving before onPause only if the launching</span>
        <span class="token comment" spellcheck="true">// activity did not explicitly state that this is an automated launch.</span>
        mSupervisor<span class="token punctuation">.</span>mUserLeaving <span class="token operator">=</span> <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_NO_USER_ACTION<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_USER_LEAVING<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_USER_LEAVING<span class="token punctuation">,</span>
                <span class="token string">"startActivity() => mUserLeaving="</span> <span class="token operator">+</span> mSupervisor<span class="token punctuation">.</span>mUserLeaving<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// If the caller has asked not to resume at this point, we make note</span>
        <span class="token comment" spellcheck="true">// of this in the record so that we can skip it when trying to find</span>
        <span class="token comment" spellcheck="true">// the top running activity.</span>
        mDoResume <span class="token operator">=</span> doResume<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>doResume <span class="token operator">||</span> <span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">okToShowLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>delayedResume <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mDoResume <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOptions <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mOptions<span class="token punctuation">.</span><span class="token function">getLaunchTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> mOptions<span class="token punctuation">.</span><span class="token function">getTaskOverlay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>mTaskOverlay <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOptions<span class="token punctuation">.</span><span class="token function">canTaskOverlayResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">anyTaskForIdLocked</span><span class="token punctuation">(</span>
                            mOptions<span class="token punctuation">.</span><span class="token function">getLaunchTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> ActivityRecord top <span class="token operator">=</span> task <span class="token operator">!=</span> null <span class="token operator">?</span> task<span class="token punctuation">.</span><span class="token function">getTopActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>top<span class="token punctuation">.</span><span class="token function">isState</span><span class="token punctuation">(</span>RESUMED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token comment" spellcheck="true">// The caller specifies that we'd like to be avoided to be moved to the</span>
                        <span class="token comment" spellcheck="true">// front, so be it!</span>
                        mDoResume <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        mAvoidMoveToFront <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mOptions<span class="token punctuation">.</span><span class="token function">getAvoidMoveToFront</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mDoResume <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                mAvoidMoveToFront <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mNotTop <span class="token operator">=</span> <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_PREVIOUS_IS_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">?</span> r <span class="token operator">:</span> null<span class="token punctuation">;</span>

        mInTask <span class="token operator">=</span> inTask<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// In some flows in to this function, we retrieve the task record and hold on to it</span>
        <span class="token comment" spellcheck="true">// without a lock before calling back in to here...  so the task at this point may</span>
        <span class="token comment" spellcheck="true">// not actually be in recents.  Check for that, and if it isn't in recents just</span>
        <span class="token comment" spellcheck="true">// consider it invalid.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inTask <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inTask<span class="token punctuation">.</span>inRecents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Starting activity in task not in recents: "</span> <span class="token operator">+</span> inTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInTask <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mStartFlags <span class="token operator">=</span> startFlags<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// If the onlyIfNeeded flag is set, then we can do this if the activity being launched</span>
        <span class="token comment" spellcheck="true">// is the same as the one making the call...  or, as a special case, if we do not know</span>
        <span class="token comment" spellcheck="true">// the caller then we count the current top activity as the caller.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>startFlags <span class="token operator">&amp;</span> START_FLAG_ONLY_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ActivityRecord checkedCaller <span class="token operator">=</span> sourceRecord<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkedCaller <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                checkedCaller <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span>mFocusedStack<span class="token punctuation">.</span><span class="token function">topRunningNonDelayedActivityLocked</span><span class="token punctuation">(</span>
                        mNotTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>checkedCaller<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Caller is not the same as launcher, so always needed.</span>
                mStartFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>START_FLAG_ONLY_IF_NEEDED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mNoAnimation <span class="token operator">=</span> <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_NO_ANIMATION<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不难看到，在这个方法中，把整个参数赋值给ActivityStarter的全局变量，以供之后所有的流程使用。我们能看到这里能看到此时会稍微对一些Intent启动的flag进行处理。这里稍微展开一些值得注意的细节聊聊。</p>
<ul>
<li><p>1.getPreferedDisplayId(mSourceRecord, mStartActivity, options); 该方法通过启动的ActivityRecord来判断是否是VR模式。是则直接返回一个主displayId，否则从AMS获取DisplayId。这个DisplayId简单的说就是一个索引，可以通过它从SurfaceFlinger的Binder远程对象，从而找到一个逻辑显示器。</p>
</li>
<li><p>2.mSupervisor.getLaunchParamsController().calculate()该方法实际上获取注册在LaunchParamsController中LaunchParamsModifier进行计算其表现在屏幕上的区域。实际上最基础有两个LaunchParamsModifier</p>
</li>
<li><p>1.TaskLaunchParamsModifier</p>
</li>
<li><p>2.ActivityLaunchParamsModifier</p>
</li>
</ul>
<p>我们查看源码可以看到真正控制窗口大小变化(修改TaskRecord的Rect值，位置)的是TaskLaunchParamsModifier。而ActivityLaunchParamsModifier将当前的区域大小记录到LaunchParam中。我们平常可能很少这么使用，实际上在ActivityOptions的setLaunchBounds中能够控制新建的Activity的窗体大小和位置。</p>
<p>因此我们能够猜测文档经常所说的任务(也就是TaskRecord)是不是指Activity的窗体在AMS中的对象</p>
<ul>
<li>3.adjustLaunchFlagsToDocumentMode<br>在Activity启动的flag中有一个FLAG_ACTIVITY_NEW_DOCUMENT。 这个flag如下：<blockquote>
<p>给启动的Activity开一个新的任务记录，当使用new_document或者android: documentLaunchMode的时候,相同的实例会在最近任务表中产生不同的记录。<br>直接从new_document回退，直接回退桌面，想要改变这个行为，添加FLAG</p>
</blockquote>
</li>
</ul>
<p>可能有点抽象，看看这个gif。<br><img src="/images/new_doucment.gif" alt="new_doucment.gif"></p>
<p>从这里的现象能够看到实际上new_document新建了一个新的历史记录以及一个新的栈。我们看看adjustLaunchFlagsToDocumentMode这个方法是怎么初步处理new_document的。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">adjustLaunchFlagsToDocumentMode</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> launchSingleInstance<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> launchSingleTask<span class="token punctuation">,</span> <span class="token keyword">int</span> launchFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_DOCUMENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>launchSingleInstance <span class="token operator">||</span> launchSingleTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            launchFlags <span class="token operator">&amp;=</span>
                    <span class="token operator">~</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_DOCUMENT <span class="token operator">|</span> FLAG_ACTIVITY_MULTIPLE_TASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>documentLaunchMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> ActivityInfo<span class="token punctuation">.</span>DOCUMENT_LAUNCH_NONE<span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> ActivityInfo<span class="token punctuation">.</span>DOCUMENT_LAUNCH_INTO_EXISTING<span class="token operator">:</span>
                    launchFlags <span class="token operator">|=</span> Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_DOCUMENT<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> ActivityInfo<span class="token punctuation">.</span>DOCUMENT_LAUNCH_ALWAYS<span class="token operator">:</span>
                    launchFlags <span class="token operator">|=</span> Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_DOCUMENT<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> ActivityInfo<span class="token punctuation">.</span>DOCUMENT_LAUNCH_NEVER<span class="token operator">:</span>
                    launchFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>FLAG_ACTIVITY_MULTIPLE_TASK<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> launchFlags<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面做了两个处理：</p>
<blockquote>
<p>1.当存在new_document的时候，但是launchMode是singleTask或者singleInstanceTask的时候，将会关闭new_document以及MULTIPLE_TASK。因此你会发现此时使用了singleTask或者singleInstanceTask，将不会打开新的历史记录以及Activity栈。</p>
</blockquote>
<blockquote>
<p>2.当判断到在AndroidManifest中设置了documentLaunchMode，则为其添加flag到启动项中。<br>可以看到的是：</p>
<ul>
<li>如果读取到的是NONE不添加flag</li>
<li>读取到INTO_EXISTING或者LAUNCH_ALWAYS 添加FLAG_ACTIVITY_NEW_DOCUMENT</li>
<li>读取到NEVER，则关闭FLAG_ACTIVITY_MULTIPLE_TASK</li>
</ul>
</blockquote>
<p>如下面的情况：<br><img src="/images/singleTask,Instance%E7%9A%84doucment.gif" alt="singleTask,Instance的doucment.gif"></p>
<ul>
<li><ol start="4">
<li>mLaunchTaskBehind 这个标志位判断是否新建的Activity盖在原来的Activity栈上。因此在原来的基础上判断了不是singleTask或者singleInstance，同时能打开new_document.</li>
</ol>
</li>
<li><p>5.如果打开Acitivty的mLaunchTaskBehind标志为true且是new_document没有指向下一个Activity数据，则默认添加的FLAG_ACTIVITY_NEW_TASK。</p>
</li>
<li><p>6.接着如果发现FLAG_ACTIVITY_NEW_TASK打开了，设置了DOCUMENT_LAUNCH_ALWAYS或者mLaunchTaskBehind标志为true，则继续加上FLAG_ACTIVITY_MULTIPLE_TASK。</p>
</li>
</ul>
<h4 id="小节"><a href="#小节" class="headerlink" title="小节"></a>小节</h4><p>注意，在非singleTask和singleInstance下使用new_document，刚好经过5和6步骤，因此出现了第一幅gif图的情况，打开了一个新的栈。</p>
<p>这里又出现了两个新的FLAG_ACTIVITY_MULTIPLE_TASK和FLAG_ACTIVITY_NEW_TASK。</p>
<p>这两个标志位一般是在创建新的任务栈才会使用。</p>
<p>FLAG_ACTIVITY_NEW_TASK：</p>
<blockquote>
<p>新活动会成为历史栈中的新任务（一组活动）的开始。<br>如果新活动已存在于一个为它运行的任务中，那么不会启动，只会把该任务移到屏幕最前。<br>如果需要有返回flag则不能这个flag。</p>
</blockquote>
<p>因此这个flag经常用在桌面开发里面。</p>
<p>FLAG_ACTIVITY_MULTIPLE_TASK：</p>
<blockquote>
<p>用于创建一个新任务，并启动一个活动放进去<br>一般这个标志位会和FLAG_ACTIVITY_NEW_TASK或者FLAG_ACTIVITY_NEW_DOCUMENT一起使用。</p>
</blockquote>
<ul>
<li><ol start="7">
<li>FLAG_ACTIVITY_NO_USER_ACTION判断这个标志位，从而设定mUserLeaving。FLAG_ACTIVITY_NO_USER_ACTION一般是用来阻止顶部Activity的onUserLeaveHint回调,在它被新启动的活动造成paused状态时.</li>
</ol>
</li>
<li><p>8.如果在启动的时候设置了TaskId，则通过id找到任务，判断ActivityRecord的状态来设置mDoResume和mAvoidMoveToFront。</p>
</li>
</ul>
<p>-9. 当Activity已经被启动了设置了START_FLAG_ONLY_IF_NEEDED，则找到当前正在使用的Activity栈。调用topRunningNonDelayedActivityLocked运行当前顶部的Activity。</p>
<pre class="line-numbers language-java"><code class="language-java">ActivityRecord <span class="token function">topRunningNonDelayedActivityLocked</span><span class="token punctuation">(</span>ActivityRecord notTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> taskNdx <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> taskNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>taskNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>taskNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>ActivityRecord<span class="token operator">></span> activities <span class="token operator">=</span> task<span class="token punctuation">.</span>mActivities<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> activityNdx <span class="token operator">=</span> activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> activityNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>activityNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ActivityRecord r <span class="token operator">=</span> activities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activityNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>finishing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>delayedResume <span class="token operator">&amp;&amp;</span> r <span class="token operator">!=</span> notTop <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span><span class="token function">okToShowLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里出现了另外一个数据对象TaskRecord和TaskHistroy。这辆对象象征着Activity的任务对象以及任务历史。</p>
<h3 id="computeLaunchingTaskFlags-计算Task的flag"><a href="#computeLaunchingTaskFlags-计算Task的flag" class="headerlink" title="computeLaunchingTaskFlags 计算Task的flag"></a>computeLaunchingTaskFlags 计算Task的flag</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">computeLaunchingTaskFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">///存在要打开TaskRecord</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSourceRecord <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> mInTask <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mInTask<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> Intent baseIntent <span class="token operator">=</span> mInTask<span class="token punctuation">.</span><span class="token function">getBaseIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ActivityRecord root <span class="token operator">=</span> mInTask<span class="token punctuation">.</span><span class="token function">getRootActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>baseIntent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ActivityOptions<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Launching into task without base intent: "</span>
                        <span class="token operator">+</span> mInTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

       <span class="token comment" spellcheck="true">///当启动的的模式是singleTask或者singleInstance，必须保证是根部</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLaunchModeOneOf</span><span class="token punctuation">(</span>LAUNCH_SINGLE_INSTANCE<span class="token punctuation">,</span> LAUNCH_SINGLE_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>baseIntent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ActivityOptions<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Trying to launch singleInstance/Task "</span>
                            <span class="token operator">+</span> mStartActivity <span class="token operator">+</span> <span class="token string">" into different task "</span> <span class="token operator">+</span> mInTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ActivityOptions<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Caller with mInTask "</span> <span class="token operator">+</span> mInTask
                            <span class="token operator">+</span> <span class="token string">" has root "</span> <span class="token operator">+</span> root <span class="token operator">+</span> <span class="token string">" but target is singleInstance/Task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

         <span class="token comment" spellcheck="true">//根不为空时候设置为新建一个新的任务栈</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> flagsOfInterest <span class="token operator">=</span> FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_MULTIPLE_TASK
                        <span class="token operator">|</span> FLAG_ACTIVITY_NEW_DOCUMENT <span class="token operator">|</span> FLAG_ACTIVITY_RETAIN_IN_RECENTS<span class="token punctuation">;</span>
                mLaunchFlags <span class="token operator">=</span> <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> <span class="token operator">~</span>flagsOfInterest<span class="token punctuation">)</span>
                        <span class="token operator">|</span> <span class="token punctuation">(</span>baseIntent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> flagsOfInterest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>mLaunchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mInTask<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAddingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mAddingToTask <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mAddingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//设置复用的TaskRecord为当前栈</span>
            mReuseTask <span class="token operator">=</span> mInTask<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mInTask <span class="token operator">=</span> null<span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">//当根部不为空的时候，则不会去启动当前这个任务</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span><span class="token function">isResolverActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> mStartActivity<span class="token punctuation">.</span>noDisplay<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mSourceRecord <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">inFreeformWindowingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
                mAddingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//不存在要打开的TaskRecord</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInTask <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSourceRecord <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// This activity is not being started from another...  in this</span>
                <span class="token comment" spellcheck="true">// case we -always- start a new task.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mInTask <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"startActivity called from non-Activity context; forcing "</span> <span class="token operator">+</span>
                            <span class="token string">"Intent.FLAG_ACTIVITY_NEW_TASK for: "</span> <span class="token operator">+</span> mIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mLaunchFlags <span class="token operator">|=</span> FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mSourceRecord<span class="token punctuation">.</span>launchMode <span class="token operator">==</span> LAUNCH_SINGLE_INSTANCE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// The original activity who is starting us is running as a single</span>
                <span class="token comment" spellcheck="true">// instance...  this new activity it is starting must go on its</span>
                <span class="token comment" spellcheck="true">// own task.</span>
                mLaunchFlags <span class="token operator">|=</span> FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLaunchModeOneOf</span><span class="token punctuation">(</span>LAUNCH_SINGLE_INSTANCE<span class="token punctuation">,</span> LAUNCH_SINGLE_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// The activity being started is a single instance...  it always</span>
                <span class="token comment" spellcheck="true">// gets launched into its own task.</span>
                mLaunchFlags <span class="token operator">|=</span> FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里分为两种情况：</p>
<ul>
<li>1.一种是本身知道TaskRecord，要启动的任务是哪个<br>当要启动的目标TaskRecord，singleTask/singleInstance的启动模式必须要知道根部。否则的话，如果根部Activity为空则启动一个新的任务栈，把当前的任务栈作为复用对象。根部不为空，则把mInTask设置空，当作新建任务。</li>
</ul>
<ul>
<li>2.一种是不知道将要启动TaskRecord是哪个，往往用于新建。<br>此时会判断调用方的ActivityRecord为空，或者调用方本身是一个singleInstance，或者启动模式为singleTask或者singleInstance则重新启动一个新的任务作为开始。</li>
</ul>
<p>这里有个函数稍微注意下TaskRecord.getRootActivity：<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/TaskRecord.java" target="_blank" rel="noopener">TaskRecord.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/** Returns the first non-finishing activity from the root. */</span>
    ActivityRecord <span class="token function">getRootActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mActivities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ActivityRecord r <span class="token operator">=</span> mActivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们实际上能看到一个TaskRecord存储着一个mActivities的ActivityRecord集合。换句话说这个TaskRecord就是象征我上面说的任务。因此这个函数就是找到第一个没有被finish的Activity</p>
<h3 id="computeSourceStack-获取调用方的Activity栈"><a href="#computeSourceStack-获取调用方的Activity栈" class="headerlink" title="computeSourceStack 获取调用方的Activity栈"></a>computeSourceStack 获取调用方的Activity栈</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">computeSourceStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSourceRecord <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSourceStack <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSourceRecord<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSourceStack <span class="token operator">=</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mLaunchFlags <span class="token operator">|=</span> FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">;</span>
            mNewTaskInfo <span class="token operator">=</span> mSourceRecord<span class="token punctuation">.</span>info<span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// It is not guaranteed that the source record will have a task associated with it. For,</span>
            <span class="token comment" spellcheck="true">// example, if this method is being called for processing a pending activity launch, it</span>
            <span class="token comment" spellcheck="true">// is possible that the activity has been removed from the task after the launch was</span>
            <span class="token comment" spellcheck="true">// enqueued.</span>
            <span class="token keyword">final</span> TaskRecord sourceTask <span class="token operator">=</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mNewTaskIntent <span class="token operator">=</span> sourceTask <span class="token operator">!=</span> null <span class="token operator">?</span> sourceTask<span class="token punctuation">.</span>intent <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mSourceRecord <span class="token operator">=</span> null<span class="token punctuation">;</span>
        mSourceStack <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时我们能够看到，是从ActivityRecord拿到ActivityStack对象。如果调用方没有被finish则返回当前的ActivityStack。被finish了则添加一个NEW_TASK启动一个新的任务。</p>
<h3 id="getReusableIntentActivity获取能够复用的Activity"><a href="#getReusableIntentActivity获取能够复用的Activity" class="headerlink" title="getReusableIntentActivity获取能够复用的Activity"></a>getReusableIntentActivity获取能够复用的Activity</h3><p>看到这个名字就知道是专门处理singleTask，singleTop这些栈内唯一的启动模式</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
     * Decide whether the new activity should be inserted into an existing task. Returns null
     * if not or an ActivityRecord with the task into which the new activity should be added.
     */</span>
    <span class="token keyword">private</span> ActivityRecord <span class="token function">getReusableIntentActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//根据启动模式是否能够放进已经存在的Task</span>
        <span class="token keyword">boolean</span> putIntoExistingTask <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_MULTIPLE_TASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token function">isLaunchModeOneOf</span><span class="token punctuation">(</span>LAUNCH_SINGLE_INSTANCE<span class="token punctuation">,</span> LAUNCH_SINGLE_TASK<span class="token punctuation">)</span><span class="token punctuation">;</span>

        putIntoExistingTask <span class="token operator">&amp;=</span> mInTask <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> mStartActivity<span class="token punctuation">.</span>resultTo <span class="token operator">==</span> null<span class="token punctuation">;</span>
        ActivityRecord intentActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOptions <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mOptions<span class="token punctuation">.</span><span class="token function">getLaunchTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">anyTaskForIdLocked</span><span class="token punctuation">(</span>mOptions<span class="token punctuation">.</span><span class="token function">getLaunchTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intentActivity <span class="token operator">=</span> task <span class="token operator">!=</span> null <span class="token operator">?</span> task<span class="token punctuation">.</span><span class="token function">getTopActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>putIntoExistingTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LAUNCH_SINGLE_INSTANCE <span class="token operator">==</span> mLaunchMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>

               intentActivity <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">findActivityLocked</span><span class="token punctuation">(</span>mIntent<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
                       mStartActivity<span class="token punctuation">.</span><span class="token function">isActivityTypeHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_LAUNCH_ADJACENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                intentActivity <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">findActivityLocked</span><span class="token punctuation">(</span>mIntent<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
                        <span class="token operator">!</span><span class="token punctuation">(</span>LAUNCH_SINGLE_TASK <span class="token operator">==</span> mLaunchMode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                intentActivity <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">findTaskLocked</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> mPreferredDisplayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> intentActivity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果上一段代码是为了找可以复用任务，而这段代码则是去寻找是否有可以复用的ActivityRecord。</p>
<p>这里逻辑如下：<br>putIntoExistingTask是一个是否能放入已经存早的任务的标志位。其判断的依据是FLAG_ACTIVITY_NEW_TASK打开了，但是要关闭FLAG_ACTIVITY_MULTIPLE_TASK；或者singleTask/singleInstance的启动模式(因为只有这两种启动模式才会去任务的栈内寻找复用的Activity)。</p>
<p>接着还要保证没有目标任务以及调用方本身没有要指向下一个ActivityRecord。</p>
<p>首先判断到有复用的任务(TaskRecord),则直接取出当前的任务的栈顶作为复用。</p>
<p>如果putIntoExistingTask为true分情况讨论</p>
<ul>
<li>1.当启动模式为singleInstance的时候，调用findActivityLocked查找是否存在可以复用的ActivityRecord，参数为mStartActivity.isActivityTypeHome()</li>
<li>2.当打开了FLAG_ACTIVITY_LAUNCH_ADJACENT的时候，还是调用findActivityLocked，参数为是否为singleTask的boolean判断值</li>
<li>3.否则则直接findTaskLocked，传入当前的主要逻辑显示器id。</li>
</ul>
<p>那么核心就是这个findActivityLocked和findTaskLocked方法。稍微追踪一下。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java" target="_blank" rel="noopener">ActivityStackSupervisor.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">ActivityRecord <span class="token function">findActivityLocked</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> ActivityInfo info<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> compareIntentFilters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ActivityDisplay display <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> stackNdx <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> stackNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>stackNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getChildAt</span><span class="token punctuation">(</span>stackNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> ActivityRecord ar <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">findActivityLocked</span><span class="token punctuation">(</span>
                        intent<span class="token punctuation">,</span> info<span class="token punctuation">,</span> compareIntentFilters<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ar <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> ar<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法和之前的isAnyStackLock相似，也是从mActivityDisplays获取ActivityDisplay，接着不断的从ActivityStack循环寻找和当前ActivityInfo相匹配的ActivityRecord。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStack.java" target="_blank" rel="noopener">ActivityStack.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">ActivityRecord <span class="token function">findActivityLocked</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> ActivityInfo info<span class="token punctuation">,</span>
                                      <span class="token keyword">boolean</span> compareIntentFilters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ComponentName cls <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>targetActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> info<span class="token punctuation">.</span>targetActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> taskNdx <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> taskNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>taskNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>taskNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>ActivityRecord<span class="token operator">></span> activities <span class="token operator">=</span> task<span class="token punctuation">.</span>mActivities<span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> activityNdx <span class="token operator">=</span> activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> activityNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>activityNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ActivityRecord r <span class="token operator">=</span> activities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activityNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">okToShowLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>finishing <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>userId <span class="token operator">==</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>compareIntentFilters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">filterEquals</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> r<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> r<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以发现，在ActivityStack实际存着一个TaskRecord的集合mTaskHistory。从名字我们可以猜测这是TaskRecord的历史栈，究竟有什么TaskRecord存在过ActivityStack。这样，我们再次从TaskRecord获取ActivityRecord列表，来查找是否存在一个可以用来复用的Activity。</p>
<p>这样我们就能理清楚一个包含关系：<br>ActivityDisplay- -&gt; ActivityStack -&gt; TaskRecord -&gt; ActivityRecord</p>
<h5 id="findTaskLocked"><a href="#findTaskLocked" class="headerlink" title="findTaskLocked"></a>findTaskLocked</h5><p>这段则是去寻找匹配的TaskRecord。</p>
<pre class="line-numbers language-java"><code class="language-java">ActivityRecord <span class="token function">findTaskLocked</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mTmpFindTaskResult<span class="token punctuation">.</span>r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        mTmpFindTaskResult<span class="token punctuation">.</span>matchedByRootAffinity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        ActivityRecord affinityMatch <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ActivityDisplay display <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> stackNdx <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> stackNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>stackNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getChildAt</span><span class="token punctuation">(</span>stackNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">hasCompatibleActivityType</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                stack<span class="token punctuation">.</span><span class="token function">findTaskLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> mTmpFindTaskResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mTmpFindTaskResult<span class="token punctuation">.</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTmpFindTaskResult<span class="token punctuation">.</span>matchedByRootAffinity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> mTmpFindTaskResult<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mTmpFindTaskResult<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> displayId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Note: since the traversing through the stacks is top down, the floating</span>
                        <span class="token comment" spellcheck="true">// tasks should always have lower priority than any affinity-matching tasks</span>
                        <span class="token comment" spellcheck="true">// in the fullscreen stacks</span>
                        affinityMatch <span class="token operator">=</span> mTmpFindTaskResult<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS <span class="token operator">&amp;&amp;</span> mTmpFindTaskResult<span class="token punctuation">.</span>matchedByRootAffinity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">return</span> affinityMatch<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据我们上面的包含关系是从TaskRecord来查找ActivityRecord，但是这里是通过ActivityRecord反向查找匹配的TaskRecord。因此逻辑复杂点。</p>
<p>因为包含关系还是依旧，所以会通过ActivityDisplay来找到对应的ActivityStack</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">findTaskLocked</span><span class="token punctuation">(</span>ActivityRecord target<span class="token punctuation">,</span> FindTaskResult result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Intent intent <span class="token operator">=</span> target<span class="token punctuation">.</span>intent<span class="token punctuation">;</span>
        ActivityInfo info <span class="token operator">=</span> target<span class="token punctuation">.</span>info<span class="token punctuation">;</span>
        ComponentName cls <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>targetActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> info<span class="token punctuation">.</span>targetActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isDocument <span class="token operator">=</span> intent <span class="token operator">!=</span> null <span class="token operator">&amp;</span> intent<span class="token punctuation">.</span><span class="token function">isDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// If documentData is non-null then it must match the existing task data.</span>
        Uri documentData <span class="token operator">=</span> isDocument <span class="token operator">?</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> taskNdx <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> taskNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>taskNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>taskNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>voiceSession <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>userId <span class="token operator">!=</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Looking for a different task.</span>

                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Overlays should not be considered as the task's logical top activity.</span>
            <span class="token keyword">final</span> ActivityRecord r <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getTopActivity</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* includeOverlays */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null <span class="token operator">||</span> r<span class="token punctuation">.</span>finishing <span class="token operator">||</span> r<span class="token punctuation">.</span>userId <span class="token operator">!=</span> userId <span class="token operator">||</span>
                    r<span class="token punctuation">.</span>launchMode <span class="token operator">==</span> ActivityInfo<span class="token punctuation">.</span>LAUNCH_SINGLE_INSTANCE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">hasCompatibleActivityType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> Intent taskIntent <span class="token operator">=</span> task<span class="token punctuation">.</span>intent<span class="token punctuation">;</span>
            <span class="token keyword">final</span> Intent affinityIntent <span class="token operator">=</span> task<span class="token punctuation">.</span>affinityIntent<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> taskIsDocument<span class="token punctuation">;</span>
            <span class="token keyword">final</span> Uri taskDocumentData<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>taskIntent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> taskIntent<span class="token punctuation">.</span><span class="token function">isDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                taskIsDocument <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                taskDocumentData <span class="token operator">=</span> taskIntent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>affinityIntent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> affinityIntent<span class="token punctuation">.</span><span class="token function">isDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                taskIsDocument <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                taskDocumentData <span class="token operator">=</span> affinityIntent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                taskIsDocument <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                taskDocumentData <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>taskIntent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> taskIntent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                    taskIntent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                    Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>documentData<span class="token punctuation">,</span> taskDocumentData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result<span class="token punctuation">.</span>r <span class="token operator">=</span> r<span class="token punctuation">;</span>
                result<span class="token punctuation">.</span>matchedByRootAffinity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>affinityIntent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> affinityIntent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                    affinityIntent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                    Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>documentData<span class="token punctuation">,</span> taskDocumentData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result<span class="token punctuation">.</span>r <span class="token operator">=</span> r<span class="token punctuation">;</span>
                result<span class="token punctuation">.</span>matchedByRootAffinity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDocument <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>taskIsDocument
                    <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>r <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> task<span class="token punctuation">.</span>rootAffinity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>rootAffinity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>taskAffinity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result<span class="token punctuation">.</span>r <span class="token operator">=</span> r<span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span>matchedByRootAffinity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TASKS<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_TASKS<span class="token punctuation">,</span> <span class="token string">"Not a match: "</span> <span class="token operator">+</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为一个TaskRecord会包含大量的ActivityRecord，这里并不是真的去循环匹配，而是循环ActivityStack中mTaskHistory，去拿到每个Taskrecord的顶部ActivityRecord去匹配。</p>
<p>当我们发现顶部运行的ActivityRecord是singleInstance启动模式，则跳过这个TaskRecord。去找下一个没有结束且是相同的userId的TaskRecord。</p>
<p>这里稍微注意一下，因为设定了new_document和taskAffinity会Activity的任务造成影响，因此需要分情况处理。</p>
<ul>
<li>1.当没设置taskAffinity，则取出TaskRecord的taskIntent，如果类名匹配，还有在intent中设置的Data数据相符则取出。</li>
<li>2.当设置taskAffinity，则取出TaskRecord的affinityIntent，如果类名匹配，还有在intent中设置的Data数据相符则取出。</li>
<li>3.当taskIntent / affinityIntent为空或者task没有打开new_document标志位，就会取出默认的taskAffinity去匹配名字，相符合则取出。</li>
</ul>
<h6 id="情景代入"><a href="#情景代入" class="headerlink" title="情景代入"></a>情景代入</h6><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">if</span> <span class="token punctuation">(</span>LAUNCH_SINGLE_INSTANCE <span class="token operator">==</span> mLaunchMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>

               intentActivity <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">findActivityLocked</span><span class="token punctuation">(</span>mIntent<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
                       mStartActivity<span class="token punctuation">.</span><span class="token function">isActivityTypeHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_LAUNCH_ADJACENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                intentActivity <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">findActivityLocked</span><span class="token punctuation">(</span>mIntent<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
                        <span class="token operator">!</span><span class="token punctuation">(</span>LAUNCH_SINGLE_TASK <span class="token operator">==</span> mLaunchMode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                intentActivity <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">findTaskLocked</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> mPreferredDisplayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的mStartActivity就是在上面init步骤的时候，把从上一篇文章初始化好的activityRecord设置进来。</p>
<p>换算到当前代码情景，当putIntoExistingTask为true寻找复用ActivityRecord大致上可以为如下几个步骤：</p>
<ul>
<li><p>1.当此时是singleInstance，则需要判断是不是home。因为home也一般都是类似singleInstance模式。换句说，是home的时候将会除了查找包名一致之外，还会继续匹配intent里面的意图筛选。不是home的时候则是找到包名就返回。</p>
</li>
<li><p>2.当打开了FLAG_ACTIVITY_LAUNCH_ADJACENT标志位，这个标志位一般是在分屏时候使用，新活动会显示在旧活动旁边。此时我们会发现，此时因为要分屏，那个singleTask会造成影响。所以在筛选的ActivityRecord时候，如果不是singleTask则不需要经过意图筛选直接通过类名返回，否则则通过意图筛选再返回ActivityRecord。</p>
</li>
<li><p>3.当以上两者都不是，那么只是普通的singleTask模式或者singleInstance模式，为了减少时间复杂度，直接通过displayId去查找对应的Task的顶部正在运行的ActivityRecord。找到并且匹配taskAffinity则返回。</p>
</li>
</ul>
<h3 id="当复用的reuseActivity不为空"><a href="#当复用的reuseActivity不为空" class="headerlink" title="当复用的reuseActivity不为空"></a>当复用的reuseActivity不为空</h3><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">if</span> <span class="token punctuation">(</span>reusedActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> clearTopAndResetStandardLaunchMode <span class="token operator">=</span>
                    <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_CLEAR_TOP <span class="token operator">|</span> FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token operator">==</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_CLEAR_TOP <span class="token operator">|</span> FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> mLaunchMode <span class="token operator">==</span> LAUNCH_MULTIPLE<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>clearTopAndResetStandardLaunchMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mStartActivity<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>reusedActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>reusedActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>intent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reusedActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_CLEAR_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                    <span class="token operator">||</span> <span class="token function">isDocumentLaunchesIntoExisting</span><span class="token punctuation">(</span>mLaunchFlags<span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token function">isLaunchModeOneOf</span><span class="token punctuation">(</span>LAUNCH_SINGLE_INSTANCE<span class="token punctuation">,</span> LAUNCH_SINGLE_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> reusedActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> ActivityRecord top <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">performClearTaskForReuseLocked</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span>
                        mLaunchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>reusedActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    reusedActivity<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>top<span class="token punctuation">.</span>frontOfTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        top<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">deliverNewIntent</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            mSupervisor<span class="token punctuation">.</span><span class="token function">sendPowerHintForLaunchStartIfNeeded</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* forceSend */</span><span class="token punctuation">,</span> reusedActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>

            reusedActivity <span class="token operator">=</span> <span class="token function">setTargetStackAndMoveToFrontIfNeeded</span><span class="token punctuation">(</span>reusedActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> ActivityRecord outResult <span class="token operator">=</span>
                    outActivity <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> outActivity<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> outActivity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>outResult <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>outResult<span class="token punctuation">.</span>finishing <span class="token operator">||</span> outResult<span class="token punctuation">.</span>noDisplay<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                outActivity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> reusedActivity<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mStartFlags <span class="token operator">&amp;</span> START_FLAG_ONLY_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">resumeTargetStackIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> START_RETURN_INTENT_TO_CALLER<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>reusedActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setTaskFromIntentActivity</span><span class="token punctuation">(</span>reusedActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAddingToTask <span class="token operator">&amp;&amp;</span> mReuseTask <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">resumeTargetStackIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>outActivity <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> outActivity<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        outActivity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> reusedActivity<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">return</span> mMovedToFront <span class="token operator">?</span> START_TASK_TO_FRONT <span class="token operator">:</span> START_DELIVERED_TO_TOP<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>packageName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> START_CLASS_NOT_FOUND<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里拆分3个步骤说明：</p>
<ul>
<li><p>1.如果当前的启动模式是standard(对应LAUNCH_MULTIPLE)，并且打开了FLAG_ACTIVITY_CLEAR_TOP和FLAG_ACTIVITY_RESET_TASK_IF_NEEDED，则说明要清空当前栈当前ActivityRecord一直到栈顶的数据，但是此时暂时不处理，仅仅设置了clearTopAndResetStandardLaunchMode一个boolean值。当这个boolean是false的时候，说明不用清掉Task上面的信息，因此，能够直接设置原来的TaskRecord进去</p>
</li>
<li><p>2.当打开了FLAG_ACTIVITY_CLEAR_TOP标志位，或者打开了document标志位，或者打开了singleTask / singleInstance说明此时需要清掉TaskRecord的数据。最后调用deliverNewIntent。其中核心函数是performClearTaskForReuseLocked方法。这个方法就是清掉我们常说的singleTask顶部Activity，并且让当前Activity置顶。</p>
</li>
</ul>
<p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/TaskRecord.java" target="_blank" rel="noopener">TaskRecord.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    ActivityRecord <span class="token function">performClearTaskForReuseLocked</span><span class="token punctuation">(</span>ActivityRecord newR<span class="token punctuation">,</span> <span class="token keyword">int</span> launchFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mReuseTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ActivityRecord result <span class="token operator">=</span> <span class="token function">performClearTaskLocked</span><span class="token punctuation">(</span>newR<span class="token punctuation">,</span> launchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mReuseTask <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">final</span> ActivityRecord <span class="token function">performClearTaskLocked</span><span class="token punctuation">(</span>ActivityRecord newR<span class="token punctuation">,</span> <span class="token keyword">int</span> launchFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> numActivities <span class="token operator">=</span> mActivities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> activityNdx <span class="token operator">=</span> numActivities <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> activityNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>activityNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ActivityRecord r <span class="token operator">=</span> mActivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activityNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>newR<span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Here it is!  Now finish everything in front...</span>
                <span class="token keyword">final</span> ActivityRecord ret <span class="token operator">=</span> r<span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token operator">++</span>activityNdx<span class="token punctuation">;</span> activityNdx <span class="token operator">&lt;</span> numActivities<span class="token punctuation">;</span> <span class="token operator">++</span>activityNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r <span class="token operator">=</span> mActivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activityNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    ActivityOptions opts <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">takeOptionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>opts <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ret<span class="token punctuation">.</span><span class="token function">updateOptionsLocked</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mStack <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mStack<span class="token punctuation">.</span><span class="token function">finishActivityLocked</span><span class="token punctuation">(</span>
                            r<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token string">"clear-task-stack"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token operator">--</span>activityNdx<span class="token punctuation">;</span>
                        <span class="token operator">--</span>numActivities<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>


                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">.</span>launchMode <span class="token operator">==</span> ActivityInfo<span class="token punctuation">.</span>LAUNCH_MULTIPLE
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_SINGLE_TOP<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ActivityStarter<span class="token punctuation">.</span><span class="token function">isDocumentLaunchesIntoExisting</span><span class="token punctuation">(</span>launchFlags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mStack<span class="token punctuation">.</span><span class="token function">finishActivityLocked</span><span class="token punctuation">(</span>
                                    ret<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token string">"clear-task-top"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上，这个mActivities这个ArrayList。存放着当前任务内所有的Activity。此时当作一个栈的话，就是从尾部开始往头部循环查找。那么这个算法分为两步：</p>
<blockquote>
<ul>
<li>从mActivities尾部往头部查找到被复用的Activity</li>
<li>找到被复用的Activity在往尾部依次循环，并且调用ActivityStack的finish的方法结束这个Activity，并且减少引用。</li>
</ul>
</blockquote>
<p>但是这里有个特殊处理，如果是standard启动的话，并且FLAG_ACTIVITY_SINGLE_TOP打开了。此时也会结束当前的Activity。那么此时调用不了deliverNewIntent，也就说这种方式实现类似singleTop的效果是不会会调onNewIntent。而是会当作重新启动。</p>
<ul>
<li>3.经过上面的步骤，不管是否已经清除栈顶的数据。接下来都会，确定已经是要加入到对应的筛选出来栈中。</li>
</ul>
<p>因此需要开始加入到栈中，但是根据我上面列出来的在AMS中的包含关系，我们先要找到ActivityDisplay之后，再找到其中TaskRecord，最后再把ActivityRecord加入其中。</p>
<p>必定是这个逻辑，那么在这个情况复用的ActivityRecord找到了，为了保证其正确性，就要对TaskRecord做重新处理，把当前的TaskRecord放到最顶部，究竟哪里算是顶部，接下来看看核心方法之一setTargetStackAndMoveToFrontIfNeeded。</p>
<h5 id="setTargetStackAndMoveToFrontIfNeeded"><a href="#setTargetStackAndMoveToFrontIfNeeded" class="headerlink" title="setTargetStackAndMoveToFrontIfNeeded"></a>setTargetStackAndMoveToFrontIfNeeded</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> ActivityRecord <span class="token function">setTargetStackAndMoveToFrontIfNeeded</span><span class="token punctuation">(</span>ActivityRecord intentActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mTargetStack <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mTargetStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//获取顶部信息</span>
        <span class="token keyword">final</span> ActivityStack focusStack <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">getFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ActivityRecord curTop <span class="token operator">=</span> <span class="token punctuation">(</span>focusStack <span class="token operator">==</span> null<span class="token punctuation">)</span>
                <span class="token operator">?</span> null <span class="token operator">:</span> focusStack<span class="token punctuation">.</span><span class="token function">topRunningNonDelayedActivityLocked</span><span class="token punctuation">(</span>mNotTop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> TaskRecord topTask <span class="token operator">=</span> curTop <span class="token operator">!=</span> null <span class="token operator">?</span> curTop<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//顶部复用栈的信息合法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>topTask <span class="token operator">!=</span> null
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>topTask <span class="token operator">!=</span> intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> topTask <span class="token operator">!=</span> focusStack<span class="token punctuation">.</span><span class="token function">topTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mAvoidMoveToFront<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mStartActivity<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_BROUGHT_TO_FRONT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSourceRecord <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>mSourceStack<span class="token punctuation">.</span><span class="token function">getTopActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                    mSourceStack<span class="token punctuation">.</span><span class="token function">getTopActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mLaunchTaskBehind <span class="token operator">&amp;&amp;</span> mSourceRecord <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    intentActivity<span class="token punctuation">.</span><span class="token function">setTaskToAffiliateWith</span><span class="token punctuation">(</span>mSourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>


                <span class="token keyword">final</span> <span class="token keyword">boolean</span> willClearTask <span class="token operator">=</span>
                        <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token operator">==</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>willClearTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> ActivityStack launchStack <span class="token operator">=</span> <span class="token function">getLaunchStack</span><span class="token punctuation">(</span>
                            mStartActivity<span class="token punctuation">,</span> mLaunchFlags<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> TaskRecord intentTask <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>launchStack <span class="token operator">==</span> null <span class="token operator">||</span> launchStack <span class="token operator">==</span> mTargetStack<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        mTargetStack<span class="token punctuation">.</span><span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>intentTask<span class="token punctuation">,</span> mNoAnimation<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span>
                                mStartActivity<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">,</span> <span class="token string">"bringingFoundTaskToFront"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mMovedToFront <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>launchStack<span class="token punctuation">.</span><span class="token function">inSplitScreenWindowingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_LAUNCH_ADJACENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            intentTask<span class="token punctuation">.</span><span class="token function">reparent</span><span class="token punctuation">(</span>launchStack<span class="token punctuation">,</span> ON_TOP<span class="token punctuation">,</span>
                                    REPARENT_MOVE_STACK_TO_FRONT<span class="token punctuation">,</span> ANIMATE<span class="token punctuation">,</span> DEFER_RESUME<span class="token punctuation">,</span>
                                    <span class="token string">"launchToSide"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                            mTargetStack<span class="token punctuation">.</span><span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>intentTask<span class="token punctuation">,</span>
                                    mNoAnimation<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">,</span>
                                    <span class="token string">"bringToFrontInsteadOfAdjacentLaunch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        mMovedToFront <span class="token operator">=</span> launchStack <span class="token operator">!=</span> launchStack<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">getTopStackInWindowingMode</span><span class="token punctuation">(</span>launchStack<span class="token punctuation">.</span><span class="token function">getWindowingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>launchStack<span class="token punctuation">.</span>mDisplayId <span class="token operator">!=</span> mTargetStack<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reparent</span><span class="token punctuation">(</span>launchStack<span class="token punctuation">,</span> ON_TOP<span class="token punctuation">,</span>
                                REPARENT_MOVE_STACK_TO_FRONT<span class="token punctuation">,</span> ANIMATE<span class="token punctuation">,</span> DEFER_RESUME<span class="token punctuation">,</span>
                                <span class="token string">"reparentToDisplay"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mMovedToFront <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>launchStack<span class="token punctuation">.</span><span class="token function">isActivityTypeHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mTargetStack<span class="token punctuation">.</span><span class="token function">isActivityTypeHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reparent</span><span class="token punctuation">(</span>launchStack<span class="token punctuation">,</span> ON_TOP<span class="token punctuation">,</span>
                                REPARENT_MOVE_STACK_TO_FRONT<span class="token punctuation">,</span> ANIMATE<span class="token punctuation">,</span> DEFER_RESUME<span class="token punctuation">,</span>
                                <span class="token string">"reparentingHome"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mMovedToFront <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mOptions <span class="token operator">=</span> null<span class="token punctuation">;</span>

                    intentActivity<span class="token punctuation">.</span><span class="token function">showStartingWindow</span><span class="token punctuation">(</span>null <span class="token comment" spellcheck="true">/* prev */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* newTask */</span><span class="token punctuation">,</span>
                            <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* taskSwitch */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mTargetStack <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mMovedToFront <span class="token operator">&amp;&amp;</span> mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            mTargetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">"intentActivityFound"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mSupervisor<span class="token punctuation">.</span><span class="token function">handleNonResizableTaskIfNeeded</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                WINDOWING_MODE_UNDEFINED<span class="token punctuation">,</span> DEFAULT_DISPLAY<span class="token punctuation">,</span> mTargetStack<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mTargetStack<span class="token punctuation">.</span><span class="token function">resetTaskIfNeededLocked</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> intentActivity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.首先找到当前AMS的焦点ActivityStack，也就是正在和用户交互的ActivityStack找到mTaskHistory的顶部正在运行的ActivityRecord。同时找到对应的TaskRecord。</p>
</li>
<li><p>2.当发现顶部的TaskRecord不为空，同时顶部的Task和要服用的Task不是同一个时候，并且此时mAvoidMoveToFront为false的时候(mAvoidMoveToFront是在init的步骤初始化好的，这个参数是由ActivityOptions设置的，一般是false)。当判断从此时的intent的启动flag，没有打开FLAG_ACTIVITY_NEW_TASK以及FLAG_ACTIVITY_CLEAR_TASK，说明不用清空顶部的栈内所有的信息信息，会分为几种情况，把当前的Task移动栈顶。将会在下面的场景回归继续分析。</p>
</li>
</ul>
<ul>
<li><p>3.不管有没有清空，最后都需要把当前的栈ActivityStack移动到最前方，注意这里的最前端是指和人交互最直接，最顶层的位置。</p>
</li>
<li><p>4.接下来判断FLAG_ACTIVITY_RESET_TASK_IF_NEEDED标志位，这个标志一个的时候，没办法做到什么，一般几个标志位一起联动，来判断当前是否需要重置当前的mHistoryTask或者新建一个栈。</p>
</li>
</ul>
<p>大致分为这四步骤，接下来让我们看看整个流程是值得注意的步骤怎么处理的。</p>
<h4 id="剖析setTargetStackAndMoveToFrontIfNeeded"><a href="#剖析setTargetStackAndMoveToFrontIfNeeded" class="headerlink" title="剖析setTargetStackAndMoveToFrontIfNeeded"></a>剖析setTargetStackAndMoveToFrontIfNeeded</h4><p>先看看第二步骤中值得注意的方法getLaunchStack，获取当前即将要启动的栈。</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">private</span> ActivityStack <span class="token function">getLaunchStack</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> launchFlags<span class="token punctuation">,</span> TaskRecord task<span class="token punctuation">,</span>
            ActivityOptions aOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mReuseTask <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mReuseTask<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_LAUNCH_ADJACENT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                 <span class="token operator">||</span> mPreferredDisplayId <span class="token operator">!=</span> DEFAULT_DISPLAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// We don't pass in the default display id into the get launch stack call so it can do a</span>
            <span class="token comment" spellcheck="true">// full resolution.</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> candidateDisplay <span class="token operator">=</span>
                    mPreferredDisplayId <span class="token operator">!=</span> DEFAULT_DISPLAY <span class="token operator">?</span> mPreferredDisplayId <span class="token operator">:</span> INVALID_DISPLAY<span class="token punctuation">;</span>
            <span class="token keyword">return</span> mSupervisor<span class="token punctuation">.</span><span class="token function">getLaunchStack</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> aOptions<span class="token punctuation">,</span> task<span class="token punctuation">,</span> ON_TOP<span class="token punctuation">,</span> candidateDisplay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> ActivityStack parentStack <span class="token operator">=</span> task <span class="token operator">!=</span> null <span class="token operator">?</span> task<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> mSupervisor<span class="token punctuation">.</span>mFocusedStack<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>parentStack <span class="token operator">!=</span> mSupervisor<span class="token punctuation">.</span>mFocusedStack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// If task's parent stack is not focused - use it during adjacent launch.</span>
            <span class="token keyword">return</span> parentStack<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSupervisor<span class="token punctuation">.</span>mFocusedStack <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> task <span class="token operator">==</span> mSupervisor<span class="token punctuation">.</span>mFocusedStack<span class="token punctuation">.</span><span class="token function">topTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mSupervisor<span class="token punctuation">.</span>mFocusedStack<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>parentStack <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> parentStack<span class="token punctuation">.</span><span class="token function">inSplitScreenPrimaryWindowingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> activityType <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveActivityType</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> parentStack<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrCreateStack</span><span class="token punctuation">(</span>
                        WINDOWING_MODE_SPLIT_SCREEN_SECONDARY<span class="token punctuation">,</span> activityType<span class="token punctuation">,</span> ON_TOP<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                <span class="token keyword">final</span> ActivityStack dockedStack <span class="token operator">=</span>
                        mSupervisor<span class="token punctuation">.</span><span class="token function">getDefaultDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSplitScreenPrimaryStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dockedStack <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dockedStack<span class="token punctuation">.</span><span class="token function">shouldBeVisible</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">return</span> mSupervisor<span class="token punctuation">.</span><span class="token function">getLaunchStack</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> aOptions<span class="token punctuation">,</span> task<span class="token punctuation">,</span> ON_TOP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> dockedStack<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果当前要复用的Task不为空的时候，直接复用。但是实际上Activity存在分屏操作等特殊情况，因此可能需要特殊处理。</p>
<p>所以分为以下3个步骤：</p>
<ul>
<li><p>1.先判断当前有没有打开FLAG_ACTIVITY_LAUNCH_ADJACENT标志位，并且当前的显示器id和当前的主屏id不一致。此时将会判断mPreferredDisplayId是否是默认的主屏幕id，不是则取当前屏幕id，不然则是无效id。接着调用mSupervisor.getLaunchStack进一步的确认真正的ActivityStack。</p>
</li>
<li><p>2.不然实际上是打开了FLAG_ACTIVITY_LAUNCH_ADJACENT标志位，如果加上NEW_TASK就可能会启动到分屏。</p>
</li>
</ul>
<p>则获取当前即将启动的ActivityRecord对应的task，如果为空则获取把当前的Task设置为当前焦点TaskRecord。当前的焦点ActivityStack和当前父亲ActivityStack（为当前taskrecord或者当前焦点的taskrecord，取决于当前的taskrecord是否为空）是不是同一个说明可以直接到分屏，就直接返回ActivityStack。</p>
<p>如果是同一个当前的TaskRecord和焦点ActivityStack的顶部历史Task是同一个，说明不用直接到分屏，而是直接返回ActivityStack。</p>
<p>如果当前的TaskRecord和当前焦点的ActivityStack的mHistoryTask的顶部不是同一个，且当前父亲ActivityStack不为空，且打开了inSplitScreenPrimaryWindowingMode(分屏模式)则说明此时想当前的task想要显示到顶部，却没办法，此时需要从ActivityStack中根据情况获取或者新建ActivityStack。</p>
<p>如果为空，则获取桌面的ActivityStack。</p>
<p>因此这一段的意思实际上就是根据分屏情况以及FLAG_ACTIVITY_LAUNCH_ADJACENT获取合理的ActivityStack。</p>
<p>其中值得注意的有mSupervisor.getLaunchStack这个函数，从ActivityStackSupervisor中进一步获取ActivityStack。</p>
<h4 id="ActivityStackSupervisor-创建与获取ActivityStack"><a href="#ActivityStackSupervisor-创建与获取ActivityStack" class="headerlink" title="ActivityStackSupervisor 创建与获取ActivityStack"></a>ActivityStackSupervisor 创建与获取ActivityStack</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java" target="_blank" rel="noopener">ActivityStackSupervisor.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">ActivityStack</span><span class="token operator">></span> T <span class="token function">getLaunchStack</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> ActivityRecord r<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> ActivityOptions options<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> TaskRecord candidateTask<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onTop<span class="token punctuation">,</span>
            <span class="token keyword">int</span> candidateDisplayId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> taskId <span class="token operator">=</span> INVALID_TASK_ID<span class="token punctuation">;</span>
        <span class="token keyword">int</span> displayId <span class="token operator">=</span> INVALID_DISPLAY<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            taskId <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">getLaunchTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            displayId <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">getLaunchDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>taskId <span class="token operator">!=</span> INVALID_TASK_ID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            options<span class="token punctuation">.</span><span class="token function">setLaunchTaskId</span><span class="token punctuation">(</span>INVALID_TASK_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> <span class="token function">anyTaskForIdLocked</span><span class="token punctuation">(</span>taskId<span class="token punctuation">,</span>
                    MATCH_TASK_IN_STACKS_OR_RECENT_TASKS_AND_RESTORE<span class="token punctuation">,</span> options<span class="token punctuation">,</span> onTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
            options<span class="token punctuation">.</span><span class="token function">setLaunchTaskId</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> task<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> activityType <span class="token operator">=</span> <span class="token function">resolveActivityType</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> options<span class="token punctuation">,</span> candidateTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        T stack <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>displayId <span class="token operator">==</span> INVALID_DISPLAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            displayId <span class="token operator">=</span> candidateDisplayId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>displayId <span class="token operator">!=</span> INVALID_DISPLAY <span class="token operator">&amp;&amp;</span> <span class="token function">canLaunchOnDisplay</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> displayId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stack <span class="token operator">=</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token function">getValidLaunchStackOnDisplay</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> stack<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> ActivityDisplay display <span class="token operator">=</span> <span class="token function">getActivityDisplayOrCreateLocked</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>display <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stack <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getOrCreateStack</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> options<span class="token punctuation">,</span> candidateTask<span class="token punctuation">,</span> activityType<span class="token punctuation">,</span> onTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> stack<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        stack <span class="token operator">=</span> null<span class="token punctuation">;</span>
        ActivityDisplay display <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateTask <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stack <span class="token operator">=</span> candidateTask<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stack <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            display <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>display <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">canLaunchOnDisplay</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> display<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> windowingMode <span class="token operator">=</span>
                        display<span class="token punctuation">.</span><span class="token function">resolveWindowingMode</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> options<span class="token punctuation">,</span> candidateTask<span class="token punctuation">,</span> activityType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">isCompatible</span><span class="token punctuation">(</span>windowingMode<span class="token punctuation">,</span> activityType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> stack<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>windowingMode <span class="token operator">==</span> WINDOWING_MODE_FULLSCREEN_OR_SPLIT_SCREEN_SECONDARY
                        <span class="token operator">&amp;&amp;</span> display<span class="token punctuation">.</span><span class="token function">getSplitScreenPrimaryStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> stack
                        <span class="token operator">&amp;&amp;</span> candidateTask <span class="token operator">==</span> stack<span class="token punctuation">.</span><span class="token function">topTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">return</span> stack<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>display <span class="token operator">==</span> null
                <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">canLaunchOnDisplay</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> display<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// TODO: Can be removed once we figure-out how non-standard types should launch</span>
                <span class="token comment" spellcheck="true">// outside the default display.</span>
                <span class="token operator">||</span> <span class="token punctuation">(</span>activityType <span class="token operator">!=</span> ACTIVITY_TYPE_STANDARD
                <span class="token operator">&amp;&amp;</span> activityType <span class="token operator">!=</span> ACTIVITY_TYPE_UNDEFINED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            display <span class="token operator">=</span> <span class="token function">getDefaultDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> display<span class="token punctuation">.</span><span class="token function">getOrCreateStack</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> options<span class="token punctuation">,</span> candidateTask<span class="token punctuation">,</span> activityType<span class="token punctuation">,</span> onTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里又可以分为以下几个步骤：</p>
<ul>
<li><p>1.如果ActivityOption中配置了taskId，则通过taskId从ActivityStack的mHistory中获取对应的TaskRecord,并且返回TaskRecord对应的ActivityStack。</p>
</li>
<li><p>2.如果没有taskId，则只能从当前的displayId去查找id。如果是ActivityOptions中是无效的displayId则从获取从方法中传下来的displayId获取。</p>
</li>
</ul>
<p>此时在验证一次displayId，如果有效，且当前的ActivityRecord是可以被启动在显示器上，则通过getValidLaunchStackOnDisplay方法从ActivityDisplay只能够获取与当前模式兼容的ActivityStack，不为空则返回。</p>
<p>如果当前的ActivityRecord为空，说明此时情况特殊，没有任何合适的ActivityStack则调用getActivityDisplayOrCreateLocked或者创建获取对应的ActivityDisplay，最后通过getOrCreateStack创建获取ActivityStack。</p>
<ul>
<li>3.当传下来的taskId和displayId都是非法的时候，就没有办法从这两个线索去搜索合适的ActivityStack。说明此时可能是分屏情况，一个有Activity，一个完全没启动。</li>
</ul>
<p>AMS接下来会按照方式，先从当前的TaskRecord中获取到对应的栈，如果Activity的启动和Window当前的模式兼容则直接返回。如果不兼容，说明此时可能处于分屏，判断到当前的分屏的Task是当前task，且是历史栈中的顶部，则获取分屏的信息。</p>
<ul>
<li>4.最后，这样还没办法处理，说明此时处于一切的初始状态，调用getOrCreateStack创建ActivityStack。</li>
</ul>
<p>那么，我们追溯到了ActivityStack这个重要的数据结构的创建了。先来看看怎么通过getActivityDisplayOrCreateLocked创建获取ActivityStack。</p>
<h5 id="getActivityDisplayOrCreateLocked-获取或者创建ActivityDisplay"><a href="#getActivityDisplayOrCreateLocked-获取或者创建ActivityDisplay" class="headerlink" title="getActivityDisplayOrCreateLocked 获取或者创建ActivityDisplay"></a>getActivityDisplayOrCreateLocked 获取或者创建ActivityDisplay</h5><pre class="line-numbers language-java"><code class="language-java">  ActivityDisplay <span class="token function">getActivityDisplayOrCreateLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> displayId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ActivityDisplay activityDisplay <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>activityDisplay <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> activityDisplay<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDisplayManager <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> Display display <span class="token operator">=</span> mDisplayManager<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>display <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        activityDisplay <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityDisplay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> display<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">attachDisplay</span><span class="token punctuation">(</span>activityDisplay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">calculateDefaultMinimalSizeOfResizeableTasks</span><span class="token punctuation">(</span>activityDisplay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWindowManager<span class="token punctuation">.</span><span class="token function">onDisplayAdded</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> activityDisplay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这里我们就能看到在创建或者获取ActivityStack中涉及一个核心的服务DisplayManager。该服务是用来管理显示，具体点就是管理各种显示器的。这一块就会放到WMS中的解析。现在只需要明白，根据id获取逻辑显示器。</p>
<p>首先从mActivityDisplays缓存查找对应的id的ActivityDisplay，找不到则通过DisplayManagerService去找对应id的逻辑显示器。还找不到，说明根本没有在DisplayManagerService中注册这种显示器，直接返回空。找到逻辑显示器，说明此AMS刚开始启动或者这种显示器第一次使用，因此需要新建一个ActivityDisplay。</p>
<p>因此创建ActivityDisplay分为四步骤:</p>
<ul>
<li>1.新建一个对象</li>
<li>2.通过attachDisplay把新建ActivityDisplay添加到mActivityDisplays</li>
<li>3.通过default_minimal_size_resizable_task设置全局mDefaultMinSizeOfResizeableTask大小，这个大小象征着Activity如果没有指定大小，就指定这个默认大小。</li>
<li>4.把当前的displayId绑定到WindowManagerService中。</li>
</ul>
<p>别忘了，此时我们目的是要获取ActivityDisplay中的ActivityStack。因此我们接下来看看getOrCreateStack，又是如何创建处理ActivityStack的。</p>
<h5 id="getOrCreateStack-从ActivityDisplay获取ActivityStack"><a href="#getOrCreateStack-从ActivityDisplay获取ActivityStack" class="headerlink" title="getOrCreateStack 从ActivityDisplay获取ActivityStack"></a>getOrCreateStack 从ActivityDisplay获取ActivityStack</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">ActivityStack</span><span class="token operator">></span> T <span class="token function">getOrCreateStack</span><span class="token punctuation">(</span><span class="token keyword">int</span> windowingMode<span class="token punctuation">,</span> <span class="token keyword">int</span> activityType<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> onTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">alwaysCreateStack</span><span class="token punctuation">(</span>windowingMode<span class="token punctuation">,</span> activityType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            T stack <span class="token operator">=</span> <span class="token function">getStack</span><span class="token punctuation">(</span>windowingMode<span class="token punctuation">,</span> activityType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> stack<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">createStack</span><span class="token punctuation">(</span>windowingMode<span class="token punctuation">,</span> activityType<span class="token punctuation">,</span> onTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到的是这里有个alwaysCreateStack，判断当前是否总是需要创建ActivityStack。当判断为否则尝试着从缓存中获取合适的。如果找不到则创建一个ActivityStack。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">alwaysCreateStack</span><span class="token punctuation">(</span><span class="token keyword">int</span> windowingMode<span class="token punctuation">,</span> <span class="token keyword">int</span> activityType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> activityType <span class="token operator">==</span> ACTIVITY_TYPE_STANDARD
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>windowingMode <span class="token operator">==</span> WINDOWING_MODE_FULLSCREEN
                <span class="token operator">||</span> windowingMode <span class="token operator">==</span> WINDOWING_MODE_FREEFORM
                <span class="token operator">||</span> windowingMode <span class="token operator">==</span> WINDOWING_MODE_SPLIT_SCREEN_SECONDARY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当Activity的启动方式是standard启动模式，并且window的模式是全屏，或者分屏第二个屏幕，或者是自由窗口模式(在7.0之后，Android系统支持类似PC操作系统的窗口模式)，则判断需要总要创建新的ActivityStack。</p>
<h5 id="ActivityDisplay获取ActivityStack-getStack"><a href="#ActivityDisplay获取ActivityStack-getStack" class="headerlink" title="ActivityDisplay获取ActivityStack getStack"></a>ActivityDisplay获取ActivityStack getStack</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">ActivityStack</span><span class="token operator">></span> T <span class="token function">getStack</span><span class="token punctuation">(</span><span class="token keyword">int</span> windowingMode<span class="token punctuation">,</span> <span class="token keyword">int</span> activityType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>activityType <span class="token operator">==</span> ACTIVITY_TYPE_HOME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> mHomeStack<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>activityType <span class="token operator">==</span> ACTIVITY_TYPE_RECENTS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> mRecentsStack<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowingMode <span class="token operator">==</span> WINDOWING_MODE_PINNED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> mPinnedStack<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>windowingMode <span class="token operator">==</span> WINDOWING_MODE_SPLIT_SCREEN_PRIMARY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> mSplitScreenPrimaryStack<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mStacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> mStacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">isCompatible</span><span class="token punctuation">(</span>windowingMode<span class="token punctuation">,</span> activityType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> stack<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们能够看到，ActivityStack在9.0中比起7.0复杂了很多。这里面根据windowMode以及activityType，ActivityDisplay把ActivityStack区分为如下几种ActivityStack：</p>
<ul>
<li>1.mHomeStack 象征着桌面的Activity栈</li>
<li>2.mRecentsStack 象征着应用中最近使用的ActivityStack</li>
<li>3.mPinnedStack</li>
<li>4.mSplitScreenPrimaryStack 分屏后主屏幕的ActivityStack</li>
<li>5.没有指定，直接循环获取，和当前的windowMode以及activityType相符的stack返回(当activityType不是普通的模式或者未声明的时候，只需要匹配activityType，否则则匹配windowMode)。</li>
</ul>
<h5 id="ActivityDisplay创建ActivityStack"><a href="#ActivityDisplay创建ActivityStack" class="headerlink" title="ActivityDisplay创建ActivityStack"></a>ActivityDisplay创建ActivityStack</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">ActivityStack</span><span class="token operator">></span> T <span class="token function">createStack</span><span class="token punctuation">(</span><span class="token keyword">int</span> windowingMode<span class="token punctuation">,</span> <span class="token keyword">int</span> activityType<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> stackId <span class="token operator">=</span> <span class="token function">getNextStackId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">createStackUnchecked</span><span class="token punctuation">(</span>windowingMode<span class="token punctuation">,</span> activityType<span class="token punctuation">,</span> stackId<span class="token punctuation">,</span> onTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，ActivityStack的id设置是依次增加的。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">ActivityStack</span><span class="token operator">></span> T <span class="token function">createStackUnchecked</span><span class="token punctuation">(</span><span class="token keyword">int</span> windowingMode<span class="token punctuation">,</span> <span class="token keyword">int</span> activityType<span class="token punctuation">,</span>
            <span class="token keyword">int</span> stackId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowingMode <span class="token operator">==</span> WINDOWING_MODE_PINNED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">PinnedActivityStack</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stackId<span class="token punctuation">,</span> mSupervisor<span class="token punctuation">,</span> onTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">ActivityStack</span><span class="token punctuation">(</span>
                        <span class="token keyword">this</span><span class="token punctuation">,</span> stackId<span class="token punctuation">,</span> mSupervisor<span class="token punctuation">,</span> windowingMode<span class="token punctuation">,</span> activityType<span class="token punctuation">,</span> onTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到实际上ActivityStack分为两种类型一种是普通的ActivityStack，一种是PinnedActivityStack。而PinnedActivityStack是一种固定显示的栈，其默认的activityType是standard，windowMode是WINDOWING_MODE_PINNED。</p>
<h4 id="setTargetStackAndMoveToFrontIfNeeded-场景回归"><a href="#setTargetStackAndMoveToFrontIfNeeded-场景回归" class="headerlink" title="setTargetStackAndMoveToFrontIfNeeded 场景回归"></a>setTargetStackAndMoveToFrontIfNeeded 场景回归</h4><p>回到当前的场景，获得了即将要登陆的ActivityStack之后，setTargetStackAndMoveToFrontIfNeeded，会做第二步极其重要的事情，就是移动当前的ActivityStack到最顶部，也就是人机交互的栈顶。我们重新看看源码，</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>willClearTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> ActivityStack launchStack <span class="token operator">=</span> <span class="token function">getLaunchStack</span><span class="token punctuation">(</span>
                            mStartActivity<span class="token punctuation">,</span> mLaunchFlags<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> TaskRecord intentTask <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>launchStack <span class="token operator">==</span> null <span class="token operator">||</span> launchStack <span class="token operator">==</span> mTargetStack<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        mTargetStack<span class="token punctuation">.</span><span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>intentTask<span class="token punctuation">,</span> mNoAnimation<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span>
                                mStartActivity<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">,</span> <span class="token string">"bringingFoundTaskToFront"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mMovedToFront <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>launchStack<span class="token punctuation">.</span><span class="token function">inSplitScreenWindowingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_LAUNCH_ADJACENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            intentTask<span class="token punctuation">.</span><span class="token function">reparent</span><span class="token punctuation">(</span>launchStack<span class="token punctuation">,</span> ON_TOP<span class="token punctuation">,</span>
                                    REPARENT_MOVE_STACK_TO_FRONT<span class="token punctuation">,</span> ANIMATE<span class="token punctuation">,</span> DEFER_RESUME<span class="token punctuation">,</span>
                                    <span class="token string">"launchToSide"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                            mTargetStack<span class="token punctuation">.</span><span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>intentTask<span class="token punctuation">,</span>
                                    mNoAnimation<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">,</span>
                                    <span class="token string">"bringToFrontInsteadOfAdjacentLaunch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        mMovedToFront <span class="token operator">=</span> launchStack <span class="token operator">!=</span> launchStack<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">getTopStackInWindowingMode</span><span class="token punctuation">(</span>launchStack<span class="token punctuation">.</span><span class="token function">getWindowingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>launchStack<span class="token punctuation">.</span>mDisplayId <span class="token operator">!=</span> mTargetStack<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reparent</span><span class="token punctuation">(</span>launchStack<span class="token punctuation">,</span> ON_TOP<span class="token punctuation">,</span>
                                REPARENT_MOVE_STACK_TO_FRONT<span class="token punctuation">,</span> ANIMATE<span class="token punctuation">,</span> DEFER_RESUME<span class="token punctuation">,</span>
                                <span class="token string">"reparentToDisplay"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mMovedToFront <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>launchStack<span class="token punctuation">.</span><span class="token function">isActivityTypeHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mTargetStack<span class="token punctuation">.</span><span class="token function">isActivityTypeHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reparent</span><span class="token punctuation">(</span>launchStack<span class="token punctuation">,</span> ON_TOP<span class="token punctuation">,</span>
                                REPARENT_MOVE_STACK_TO_FRONT<span class="token punctuation">,</span> ANIMATE<span class="token punctuation">,</span> DEFER_RESUME<span class="token punctuation">,</span>
                                <span class="token string">"reparentingHome"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mMovedToFront <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mOptions <span class="token operator">=</span> null<span class="token punctuation">;</span>

                    intentActivity<span class="token punctuation">.</span><span class="token function">showStartingWindow</span><span class="token punctuation">(</span>null <span class="token comment" spellcheck="true">/* prev */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* newTask */</span><span class="token punctuation">,</span>
                            <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* taskSwitch */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当确定不需要清空Activity栈内的信息时候，将会获取登陆ActivityStack。这个ActivityStack的获取是如果显式的设置了复用目标，则使用，不然则是获取在init中初始好的启动的调用方ActivityStack，当然如果遇到分屏，虚拟屏等特殊情况另说。</p>
<p>此时将会依据即将登陆的ActivityStack和当前ActivityRecord对应的ActivityStack做比较。可以分为以下几种情况：</p>
<ul>
<li>1.当要启动的栈与目标一致，或者要启动的栈为空。</li>
<li>2.要启动的栈的windowMode为分屏模式</li>
<li>3.要启动的栈displayId和当前的ActivityRecord不一致</li>
<li>4.要启动的栈是Home，而当前的ActivityRecord不是。</li>
</ul>
<p>在情况2-3都会通过reparent，把Task迁移到launchStack中。</p>
<p>稍微看看情况一</p>
<h4 id="情况一当要启动的栈与目标一致，或者要启动的栈为空"><a href="#情况一当要启动的栈与目标一致，或者要启动的栈为空" class="headerlink" title="情况一当要启动的栈与目标一致，或者要启动的栈为空"></a>情况一当要启动的栈与目标一致，或者要启动的栈为空</h4><p>此时正是我们正常的启动流程。也就是说会唤起moveTaskToFrontLocked方法。把当前的栈移动到用户交互的栈顶。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>TaskRecord tr<span class="token punctuation">,</span> <span class="token keyword">boolean</span> noAnimation<span class="token punctuation">,</span> ActivityOptions options<span class="token punctuation">,</span>
            AppTimeTracker timeTracker<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> ActivityStack topStack <span class="token operator">=</span> <span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ActivityRecord topActivity <span class="token operator">=</span> topStack <span class="token operator">!=</span> null <span class="token operator">?</span> topStack<span class="token punctuation">.</span><span class="token function">getTopActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> numTasks <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> mTaskHistory<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deferUpdateImeTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">insertTaskAtTop</span><span class="token punctuation">(</span>tr<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ActivityRecord top <span class="token operator">=</span> tr<span class="token punctuation">.</span><span class="token function">getTopActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>top<span class="token punctuation">.</span><span class="token function">okToShowLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mStackSupervisor<span class="token punctuation">.</span>mRecentTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>top<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ActivityOptions<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>


            <span class="token keyword">final</span> ActivityRecord r <span class="token operator">=</span> <span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mStackSupervisor<span class="token punctuation">.</span><span class="token function">moveFocusableActivityStackToFrontLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mStackSupervisor<span class="token punctuation">.</span><span class="token function">resumeFocusedStackTopActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以看到这个核心的算法实际上很简单，实际上就是首先先从mHistoryTasks找到对应的TaskRecord。如果找不到则立即返回，找到了则调用insertTaskAtTop，把这个TaskRecord插入到mHistoryTask顶部，如果此时的顶部ActivityRecord暂时不能显示，把TaskRecord添加到ActivityStackSupervisor的mRecentTasks，最近使用的Activity的任务列表中，这样就相当于调用过。</p>
<p>接着调用moveFocusableActivityStackToFrontLocked，处理ActivityStack这个方法最后会调用ActivityStack的moveToFront。</p>
<blockquote>
<p>moveToFront方法做的事情有两件，第一件把ActivityStackSupervisor的FocusStack设置为当前的ActivityStack，第二件事，把当前这个ActivityStack设置ActivityDisplay中的mStacks (存放着ActivityStack的ArrayList)的前端。</p>
</blockquote>
<p>最后再调用resumeFocusedStackTopActivityLocked启动Activity的Resume<br>这样就完成了当发现有复用ActivityRecord时候，TaskRecord和ActivityStack的移动到交互栈顶。</p>
<h4 id="场景回归startActivityUnchecked的复用Activity情况"><a href="#场景回归startActivityUnchecked的复用Activity情况" class="headerlink" title="场景回归startActivityUnchecked的复用Activity情况"></a>场景回归startActivityUnchecked的复用Activity情况</h4><p>在setTargetStackAndMoveToFrontIfNeeded中什么时候需要移动TaskRecord以及ActivityStack呢？主要还是当前顶部的ActivityRecord对应的TaskRecord既不是目标启动的栈，也不是当前的焦点的栈对应顶部TaskRecord。也就是说，可能需要移动把复用的TaskRecord进行一次Task之间的移动。</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setTaskFromIntentActivity</span><span class="token punctuation">(</span>ActivityRecord intentActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">==</span> <span class="token punctuation">(</span>FLAG_ACTIVITY_NEW_TASK <span class="token operator">|</span> FLAG_ACTIVITY_CLEAR_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span>
            <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            task<span class="token punctuation">.</span><span class="token function">performClearTaskLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mReuseTask <span class="token operator">=</span> task<span class="token punctuation">;</span>
            mReuseTask<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_CLEAR_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                <span class="token operator">||</span> <span class="token function">isLaunchModeOneOf</span><span class="token punctuation">(</span>LAUNCH_SINGLE_INSTANCE<span class="token punctuation">,</span> LAUNCH_SINGLE_TASK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ActivityRecord top <span class="token operator">=</span> intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">performClearTaskLocked</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span>
                    mLaunchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mAddingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                mSourceRecord <span class="token operator">=</span> intentActivity<span class="token punctuation">;</span>
                <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> task<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mTargetStack <span class="token operator">=</span> <span class="token function">computeStackFocus</span><span class="token punctuation">(</span>mSourceRecord<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* newTask */</span><span class="token punctuation">,</span>
                            mLaunchFlags<span class="token punctuation">,</span> mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mTargetStack<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span>
                            <span class="token operator">!</span>mLaunchTaskBehind <span class="token comment" spellcheck="true">/* toTop */</span><span class="token punctuation">,</span> <span class="token string">"startActivityUnchecked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_SINGLE_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                        <span class="token operator">||</span> LAUNCH_SINGLE_TOP <span class="token operator">==</span> mLaunchMode<span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> intentActivity<span class="token punctuation">.</span>realActivity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>realActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>intentActivity<span class="token punctuation">.</span>frontOfTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">deliverNewIntent</span><span class="token punctuation">(</span>intentActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSameIntentFilter</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mAddingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                mSourceRecord <span class="token operator">=</span> intentActivity<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAddingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mSourceRecord <span class="token operator">=</span> intentActivity<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rootWasReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            intentActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当不是上面的情况，需要 setTaskFromIntentActivity，进一步做处理。</p>
<ul>
<li>如果打开FLAG_ACTIVITY_NEW_TASK 以及FLAG_ACTIVITY_CLEAR_TASK，则设置mReuseTask为当前的Task。</li>
<li>如果打开了FLAG_ACTIVITY_CLEAR_TOP的标志位，同时singleInstance或者singleTask的一种，则清空Task，拿到顶部的Task，最后重新添加到ActivityStack</li>
<li>3.要启动的Activity和当前的Activity是同一个，同时打开了singleTop标志位，以及singleTop启动，直接调用onNewIntent.如果是相同过滤条件，则把启动SourceRecord设置为当前ActivityRecord。</li>
</ul>
<p>最后再调用resumeTargetStackIfNeeded，resume当前复用的Activity。</p>
<h2 id="startActivityUnchecked当没有复用Activity时候"><a href="#startActivityUnchecked当没有复用Activity时候" class="headerlink" title="startActivityUnchecked当没有复用Activity时候"></a>startActivityUnchecked当没有复用Activity时候</h2><p>在处理完FLAG_ACTIVITY_SINGLE_TOP这种情况之后，将会处理正常启动的Activity。</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">int</span> result <span class="token operator">=</span> START_SUCCESS<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>resultTo <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> mInTask <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mAddingToTask
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token function">setTaskFromReuseOrCreateNewTask</span><span class="token punctuation">(</span>taskToAffiliate<span class="token punctuation">,</span> topStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mSourceRecord <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token function">setTaskFromSourceRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mInTask <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token function">setTaskFromInTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">setTaskToCurrentTopOrCreateNewTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
mTargetStack<span class="token punctuation">.</span><span class="token function">startActivityLocked</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> topFocused<span class="token punctuation">,</span> newTask<span class="token punctuation">,</span> mKeepCurTransition<span class="token punctuation">,</span>
                mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
         mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ActivityRecord topTaskActivity <span class="token operator">=</span>
                    mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTargetStack<span class="token punctuation">.</span><span class="token function">isFocusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token punctuation">(</span>topTaskActivity <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> topTaskActivity<span class="token punctuation">.</span>mTaskOverlay
                    <span class="token operator">&amp;&amp;</span> mStartActivity <span class="token operator">!=</span> topTaskActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mTargetStack<span class="token punctuation">.</span><span class="token function">isFocusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mSupervisor<span class="token punctuation">.</span><span class="token function">isFocusedStack</span><span class="token punctuation">(</span>mTargetStack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mTargetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">"startActivityUnchecked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mSupervisor<span class="token punctuation">.</span><span class="token function">resumeFocusedStackTopActivityLocked</span><span class="token punctuation">(</span>mTargetStack<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">,</span>
                        mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时能看到为了找到，真正需要的ActivityStack启动Activity。因此这里分为三种情况：</p>
<ul>
<li><p>1.当启动的flag打开了FLAG_ACTIVITY_NEW_TASK，并且mAddingToTask为false。当前的Task根部没有任何的Activity这个标志位true，不是如果打开了<br>new_task为false，否则为true。或者是使用了自由窗口模式，复用Task的时候为null也为true。因此这个标志位起作用一般是当一个Task 中为空，才会新建一个TaskRecord。</p>
</li>
<li><p>2.当mSourceRecord不为空，把新的ActivityRecord绑定到启动者的TaskRecord上</p>
</li>
<li><p>3.剩下的情况：启动时带了mInTask，ActivityRecord绑定到mInTask。都不是则直接找焦点的ActivityStack上栈顶的Task，直接绑定(几乎不可能发生)。</p>
</li>
</ul>
<h3 id="第一种情况打开了FLAG-ACTIVITY-NEW-TASK"><a href="#第一种情况打开了FLAG-ACTIVITY-NEW-TASK" class="headerlink" title="第一种情况打开了FLAG_ACTIVITY_NEW_TASK"></a>第一种情况打开了FLAG_ACTIVITY_NEW_TASK</h3><p>当我们打开了FLAG_ACTIVITY_NEW_TASK，computeStackFocus获取目标的ActivityStack。这个方法已经在上面分析过了。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">setTaskFromReuseOrCreateNewTask</span><span class="token punctuation">(</span>
            TaskRecord taskToAffiliate<span class="token punctuation">,</span> ActivityStack topStack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mTargetStack <span class="token operator">=</span> <span class="token function">computeStackFocus</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> mLaunchFlags<span class="token punctuation">,</span> mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mReuseTask <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> mTargetStack<span class="token punctuation">.</span><span class="token function">createTaskRecord</span><span class="token punctuation">(</span>
                    mSupervisor<span class="token punctuation">.</span><span class="token function">getNextTaskIdForUserLocked</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mNewTaskInfo <span class="token operator">!=</span> null <span class="token operator">?</span> mNewTaskInfo <span class="token operator">:</span> mStartActivity<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
                    mNewTaskIntent <span class="token operator">!=</span> null <span class="token operator">?</span> mNewTaskIntent <span class="token operator">:</span> mIntent<span class="token punctuation">,</span> mVoiceSession<span class="token punctuation">,</span>
                    mVoiceInteractor<span class="token punctuation">,</span> <span class="token operator">!</span>mLaunchTaskBehind <span class="token comment" spellcheck="true">/* toTop */</span><span class="token punctuation">,</span> mStartActivity<span class="token punctuation">,</span> mSourceRecord<span class="token punctuation">,</span>
                    mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addOrReparentStartingActivity</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token string">"setTaskFromReuseOrCreateNewTask - mReuseTask"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">updateBounds</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mLaunchParams<span class="token punctuation">.</span>mBounds<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">addOrReparentStartingActivity</span><span class="token punctuation">(</span>mReuseTask<span class="token punctuation">,</span> <span class="token string">"setTaskFromReuseOrCreateNewTask"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTargetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">"reuseOrNewTask"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> START_SUCCESS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

 <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addOrReparentStartingActivity</span><span class="token punctuation">(</span>TaskRecord parent<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parent<span class="token punctuation">.</span><span class="token function">addActivityToTop</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mStartActivity<span class="token punctuation">.</span><span class="token function">reparent</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> parent<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* top */</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里代入情景，如果是分屏，则判断是否打开FLAG_ACTIVITY_LAUNCH_ADJACENT。根据这个标志位不同到本ActivityStack还是对面。如果是普通的启动获取的当前要启动的ActivityRecord对应的ActivityStack。FLAG_ACTIVITY_NEW_TASK是否生成新的Task的依据是mReuseTask是否设置。而这个对象本质上是ActivityOptions设置的，一般的为空。</p>
<p>最后判断启动的Task为空或者和启动的Task一致，则调用TaskRecord的addActivityToTop把当前要启动的Activity放到TaskRecord的顶部，否则则调用ActivityRecord的reparent。</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">void</span> <span class="token function">reparent</span><span class="token punctuation">(</span>TaskRecord newTask<span class="token punctuation">,</span> <span class="token keyword">int</span> position<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> TaskRecord prevTask <span class="token operator">=</span> task<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevTask <span class="token operator">==</span> newTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>reason <span class="token operator">+</span> <span class="token string">": task="</span> <span class="token operator">+</span> newTask
                    <span class="token operator">+</span> <span class="token string">" is already the parent of r="</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevTask <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> newTask <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> prevTask<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> newTask<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>reason <span class="token operator">+</span> <span class="token string">": task="</span> <span class="token operator">+</span> newTask
                    <span class="token operator">+</span> <span class="token string">" is in a different stack ("</span> <span class="token operator">+</span> newTask<span class="token punctuation">.</span><span class="token function">getStackId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">") than the parent of"</span>
                    <span class="token operator">+</span> <span class="token string">" r="</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" ("</span> <span class="token operator">+</span> prevTask<span class="token punctuation">.</span><span class="token function">getStackId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
mWindowContainerController<span class="token punctuation">.</span><span class="token function">reparent</span><span class="token punctuation">(</span>newTask<span class="token punctuation">.</span><span class="token function">getWindowContainerController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ActivityStack prevStack <span class="token operator">=</span> prevTask<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevStack <span class="token operator">!=</span> newTask<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            prevStack<span class="token punctuation">.</span><span class="token function">onActivityRemovedFromStack</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Remove the activity from the old task and add it to the new task.</span>
        prevTask<span class="token punctuation">.</span><span class="token function">removeActivity</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* reparenting */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        newTask<span class="token punctuation">.</span><span class="token function">addActivityAtIndex</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，这个方法是清空TaskRecord原来存在其中的ActivityRecord，并且添加到当前新的TaskRecord的顶部。以完成TaskRecord的切换。</p>
<h3 id="当mSourceRecord不为空"><a href="#当mSourceRecord不为空" class="headerlink" title="当mSourceRecord不为空"></a>当mSourceRecord不为空</h3><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">setTaskFromSourceRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">getLockTaskController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLockTaskModeViolation</span><span class="token punctuation">(</span>mSourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Attempted Lock Task Mode violation mStartActivity="</span> <span class="token operator">+</span> mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> START_RETURN_LOCK_TASK_MODE_VIOLATION<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> TaskRecord sourceTask <span class="token operator">=</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ActivityStack sourceStack <span class="token operator">=</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// We only want to allow changing stack in two cases:</span>
        <span class="token comment" spellcheck="true">// 1. If the target task is not the top one. Otherwise we would move the launching task to</span>
        <span class="token comment" spellcheck="true">//    the other side, rather than show two side by side.</span>
        <span class="token comment" spellcheck="true">// 2. If activity is not allowed on target display.</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> targetDisplayId <span class="token operator">=</span> mTargetStack <span class="token operator">!=</span> null <span class="token operator">?</span> mTargetStack<span class="token punctuation">.</span>mDisplayId
                <span class="token operator">:</span> sourceStack<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> moveStackAllowed <span class="token operator">=</span> sourceStack<span class="token punctuation">.</span><span class="token function">topTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> sourceTask
                <span class="token operator">||</span> <span class="token operator">!</span>mStartActivity<span class="token punctuation">.</span><span class="token function">canBeLaunchedOnDisplay</span><span class="token punctuation">(</span>targetDisplayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>moveStackAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTargetStack <span class="token operator">=</span> <span class="token function">getLaunchStack</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> mLaunchFlags<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mTargetStack <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> targetDisplayId <span class="token operator">!=</span> sourceStack<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mTargetStack <span class="token operator">=</span> mService<span class="token punctuation">.</span>mStackSupervisor<span class="token punctuation">.</span><span class="token function">getValidLaunchStackOnDisplay</span><span class="token punctuation">(</span>
                        sourceStack<span class="token punctuation">.</span>mDisplayId<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mTargetStack <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mTargetStack <span class="token operator">=</span> mService<span class="token punctuation">.</span>mStackSupervisor<span class="token punctuation">.</span><span class="token function">getNextValidLaunchStackLocked</span><span class="token punctuation">(</span>
                        mStartActivity<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment" spellcheck="true">/* currentFocus */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTargetStack <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTargetStack <span class="token operator">=</span> sourceStack<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mTargetStack <span class="token operator">!=</span> sourceStack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sourceTask<span class="token punctuation">.</span><span class="token function">reparent</span><span class="token punctuation">(</span>mTargetStack<span class="token punctuation">,</span> ON_TOP<span class="token punctuation">,</span> REPARENT_MOVE_STACK_TO_FRONT<span class="token punctuation">,</span> <span class="token operator">!</span>ANIMATE<span class="token punctuation">,</span>
                    DEFER_RESUME<span class="token punctuation">,</span> <span class="token string">"launchToSide"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> TaskRecord topTask <span class="token operator">=</span> mTargetStack<span class="token punctuation">.</span><span class="token function">topTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>topTask <span class="token operator">!=</span> sourceTask <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mAvoidMoveToFront<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTargetStack<span class="token punctuation">.</span><span class="token function">moveTaskToFrontLocked</span><span class="token punctuation">(</span>sourceTask<span class="token punctuation">,</span> mNoAnimation<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span>
                    mStartActivity<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">,</span> <span class="token string">"sourceTaskToFront"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTargetStack<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">"sourceStackToFront"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAddingToTask <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_CLEAR_TOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ActivityRecord top <span class="token operator">=</span> sourceTask<span class="token punctuation">.</span><span class="token function">performClearTaskLocked</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> mLaunchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mKeepCurTransition <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ActivityStack<span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span>AM_NEW_INTENT<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">,</span> top<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">deliverNewIntent</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mTargetStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mSupervisor<span class="token punctuation">.</span><span class="token function">resumeFocusedStackTopActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ActivityOptions<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> START_DELIVERED_TO_TOP<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAddingToTask <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> FLAG_ACTIVITY_REORDER_TO_FRONT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ActivityRecord top <span class="token operator">=</span> sourceTask<span class="token punctuation">.</span><span class="token function">findActivityInHistoryLocked</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> top<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                task<span class="token punctuation">.</span><span class="token function">moveActivityToFrontLocked</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
                top<span class="token punctuation">.</span><span class="token function">updateOptionsLocked</span><span class="token punctuation">(</span>mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ActivityStack<span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span>AM_NEW_INTENT<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">deliverNewIntent</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mTargetStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mSupervisor<span class="token punctuation">.</span><span class="token function">resumeFocusedStackTopActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> START_DELIVERED_TO_TOP<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">addOrReparentStartingActivity</span><span class="token punctuation">(</span>sourceTask<span class="token punctuation">,</span> <span class="token string">"setTaskFromSourceRecord"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> START_SUCCESS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个应该是最常见的情况，分步骤说明</p>
<ul>
<li><p>1.启动栈的顶部TaskRecord和启动方的TaskRecord不一致或者启动方的不允许显示。则需要移动到其他的ActivityStack。因此此时比较特殊，因此按照上面解析的逻辑，是从有效的displayId中查找与当前模式兼容的ActivityStack，找不到则创建一个ActivityDisplay，再创建对应的ActivityStack。</p>
</li>
<li><p>2.mTargetStack为空，则是默认的情况。设置为当前的启动方的ActivityStack。发现目标ActivityStack和启动的ActivityStack不是一个，则需要把启动方TaskRecord，重绑到目标的ActivityStack。</p>
</li>
<li><p>3.把目标ActivityStack移动到最前方。也就是设置为焦点ActivityStack，同时设置到ActivityDisplay集合的顶部</p>
</li>
<li><p>4 mAddingToTask为false，打开了FLAG_ACTIVITY_CLEAR_TOP，则清除启动方的TaskRecord中的顶部。顶部不为空，则调用newIntent，需要resume，再调用resume。</p>
</li>
<li><p>5.mAddingToTask为false，打开了FLAG_ACTIVITY_REORDER_TO_FRONT标志位。这个标志位是在setTargetStackAndMoveToFrontIfNeeded默认设置的。说明此时有复用，但是栈相同，此时会从TaskRecord中获取复用的ActivityRecord。最后调用onNewIntent。</p>
</li>
<li><p>6.不过经历什么步骤，都会通过startActivityLocked要把TaskRecord添加到mHistoryTasks顶部。</p>
</li>
</ul>
<p>最后调用ActivityStackSupervisor的resumeFocusedStackTopActivityLocked(因为方法此时传下来默认是true)。</p>
<p>至此就完成了ActivityStack以及TaskRecord如何转化到交互的栈顶流程。</p>
<h1 id="小节-1"><a href="#小节-1" class="headerlink" title="小节"></a>小节</h1><p>限于篇幅问题，本片总结将会之后一起放出。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/06/09/tu-xiang-chu-li-yu-yin-shi-pin-qi-dong-pian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="图像处理与音视频启动篇">
                        
                        <span class="card-title">图像处理与音视频启动篇</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            正文作为一个3-5年Android开发，必须熟悉C/C++。只懂应用层面的开发往往是不足，不明白其原理，往往无法写出更好的代码。因此，对于一个应用开发的程序员，摆在眼前的路大致有三条。

1.专心继续深研Android源码，把Android
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-06-09
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/音视频/">
                        <span class="chip bg-color">音视频</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/06/09/activity-de-qi-dong-liu-cheng-yi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="Android 重学系列 Activity的启动流程(一)">
                        
                        <span class="card-title">Android 重学系列 Activity的启动流程(一)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            如果遇到错误，请在本文地址： https://www.jianshu.com/p/91feec107d4b
背景经过前期的奋斗，我们终于来到Android开发者熟悉的部分，四大组件之一的Activity。Activity可以说是每个Andr
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-06-09
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-Framework/" class="post-category">
                                    Android Framework
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
