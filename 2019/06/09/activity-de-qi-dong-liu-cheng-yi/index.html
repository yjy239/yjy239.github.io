<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 Activity的启动流程(一), Android | Linux | Flutter">
    <meta name="description" content="如果遇到错误，请在本文地址： https://www.jianshu.com/p/91feec107d4b
背景经过前期的奋斗，我们终于来到Android开发者熟悉的部分，四大组件之一的Activity。Activity可以说是每个Andr">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 Activity的启动流程(一) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/11.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 Activity的启动流程(一)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android-Framework/" class="post-category">
                                Android Framework
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-06-09
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        7.6k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        34 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>如果遇到错误，请在本文地址： <a href="https://www.jianshu.com/p/91feec107d4b" target="_blank" rel="noopener">https://www.jianshu.com/p/91feec107d4b</a></p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>经过前期的奋斗，我们终于来到Android开发者熟悉的部分，四大组件之一的Activity。Activity可以说是每个Android程序员最为熟悉的组件，其承载App应用和人交互的桥梁。因此想要明白Android我们必须要把Activity摸透。由于我在3年前已经写过一次Activity的启动流程的解析，因此这次我尝试着尽可能的看到详细的源码，来和大家聊聊在Android 9.0中的Activity的启动。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="比较Android9-0和Android-7-0"><a href="#比较Android9-0和Android-7-0" class="headerlink" title="比较Android9.0和Android 7.0"></a>比较Android9.0和Android 7.0</h2><p>首先看看startActivity在Android7.0的时序图。<br><img src="/images/Activity%E7%9A%84%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.jpg" alt="Activity的启动流程.jpg"></p>
<p>这里实际上就是从Android诞生之初，一直到Android 9.0的启动主要脉络。实际上外面的文章已经讲得滚瓜烂熟。包括我也看这些源码了这个不下10遍，应该更多。</p>
<p>本文会继续看看Android 9.0的Acitvity启动流程的源码。看看Android 9.0比起7.0来说进步在哪里。</p>
<p>我们先上时序图：<br><img src="/images/Android9.0%E4%B8%ADActivity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png" alt="Android9.0中Activity启动流程.png"></p>
<p>注意：红色线代表跨越Binder一次进程</p>
<p>从时序图上，无论怎么Android的启动架构怎么演变，其根本流程都没有变。Android都是通过Binder通行到AMS，接着经过AMS的一系列中栈处理之后，把ActivityRecord返回到AppThread(App进程中)。</p>
<p>Android9.0看起来确实比Android7.0的经历的步骤更多，但是我们深入看源码发现Android9.0比起7.0的易读（如果对4.4的启动流程可以看我毕业那篇文章）。</p>
<p>主要的原因，我们可以从Android 9.0的时序图中可以到，在Android 9.0中，AMS不再是通过简单的调用IPC来控制App端的Activity生命周期。而是通过一个状态设计模式，将每个Activity每一个生命周期都抽象成一个状态，接着通过状态机去管理整个生命周期。</p>
<p>实际上这种思想在我平时写代码的时候，也经常用到。往往用在需求比较复杂，而且状态比较多，还会不断切换那种。</p>
<p>本文将会着重打讨论AMS中的流程。再次聊App进程准备工作也未免有点滥竽充数的嫌疑。让我们站在更高的高度，去看看AMS在启动中的细节以及设计思路。</p>
<p>提示：从上面几篇文章能看到，实际上AMS隶属于SystemServer进程。和App进程不在同一处。</p>
<h2 id="启动流程中AMS内的各个角色"><a href="#启动流程中AMS内的各个角色" class="headerlink" title="启动流程中AMS内的各个角色"></a>启动流程中AMS内的各个角色</h2><p>在Activity中启动中，AMS担任最为重要的角色，下面列出的都是AMS中承担各个主要功能的类</p>
<ul>
<li><ol>
<li>ActivityStack 代表着Activity的栈(不精准稍后会具体解释)</li>
</ol>
</li>
<li>2.ActivityStarter 代表着Activity正式启动的控制类</li>
<li>3.ActivityManagerService 代表着一切Activity行为在系统中的控制中心</li>
<li>4.ActivityStackSupervisor 代表着ActivityStack的监控中心</li>
</ul>
<p>实际上对于我们来说在整个Activity的启动需要关注这么四个核心类。<br>而在这里面往往涉及到Activity栈的变化，而这个过程涉及到的核心类有：</p>
<ul>
<li>1.ActivityRecord </li>
<li>2.TaskRecord </li>
<li>3.mRecentTasks </li>
<li>4.mTaskHistory </li>
<li>5.ProcessRecord </li>
</ul>
<p>我们稍微根据源码时序图，来看看AMS中的启动流程。上面的数据结构将会一一剖析。</p>
<h3 id="AMS跨进程通信创建Activity，第一步。"><a href="#AMS跨进程通信创建Activity，第一步。" class="headerlink" title="AMS跨进程通信创建Activity，第一步。"></a>AMS跨进程通信创建Activity，第一步。</h3><p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java" target="_blank" rel="noopener">ActivityManagerService.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span> String callingPackage<span class="token punctuation">,</span>
            Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span> IBinder resultTo<span class="token punctuation">,</span> String resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
            <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> ProfilerInfo profilerInfo<span class="token punctuation">,</span> Bundle bOptions<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> validateIncomingUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">"startActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        userId <span class="token operator">=</span> mActivityStartController<span class="token punctuation">.</span><span class="token function">checkTargetUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> validateIncomingUser<span class="token punctuation">,</span>
                Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"startActivityAsUser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">return</span> mActivityStartController<span class="token punctuation">.</span><span class="token function">obtainStarter</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token string">"startActivityAsUser"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCaller</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//调用方的AppThread的IBinder</span>
                <span class="token punctuation">.</span><span class="token function">setCallingPackage</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//调用方的包名</span>
                <span class="token punctuation">.</span><span class="token function">setResolvedType</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//调用type</span>
                <span class="token punctuation">.</span><span class="token function">setResultTo</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//调用方的ActivityClientRecord的binder（实际上是AMS的ActivityRecord对应在App端的binder对象）</span>
                <span class="token punctuation">.</span><span class="token function">setResultWho</span><span class="token punctuation">(</span>resultWho<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//调用方的标示</span>
                <span class="token punctuation">.</span><span class="token function">setRequestCode</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//需要返回的requestCode</span>
                <span class="token punctuation">.</span><span class="token function">setStartFlags</span><span class="token punctuation">(</span>startFlags<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//启动标志位</span>
                <span class="token punctuation">.</span><span class="token function">setProfilerInfo</span><span class="token punctuation">(</span>profilerInfo<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//启动时带上的权限文件对象</span>
                <span class="token punctuation">.</span><span class="token function">setActivityOptions</span><span class="token punctuation">(</span>bOptions<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//ActivityOptions的Activity的启动项,在一般的App中此时是null，不需要关注</span>
                <span class="token punctuation">.</span><span class="token function">setMayWait</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//是否是同步打开Actvivity 默认一般是true</span>
                <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//执行方法。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这里面节能很清晰的明白，在启动过程中需要什么参数。比起当初Android7.0的源码看来设计上确实进步不少，虽然看起来像是一个建造者设计模式。但是实际上工厂设计模式+享元设计+链式调用。通过obtainStarter把DefaultFactory从mStarterPool中获取一个ActivityStarter(池子中最多设置3个)，接着通过链式调用，把启动时需要的参数传递进去。</p>
<p>当设置完成之后，我们直接看看execute方法.</p>
<h3 id="ActivityStarter-正式开始启动Activity"><a href="#ActivityStarter-正式开始启动Activity" class="headerlink" title="ActivityStarter 正式开始启动Activity"></a>ActivityStarter 正式开始启动Activity</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java" target="_blank" rel="noopener">ActivityStarter.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// TODO(b/64750076): Look into passing request directly to these methods to allow</span>
            <span class="token comment" spellcheck="true">// for transactional diffs and preprocessing.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>mayWait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">startActivityMayWait</span><span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>caller<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>callingUid<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>callingPackage<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>resolvedType<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>voiceSession<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>resultWho<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>requestCode<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>startFlags<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>profilerInfo<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>waitResult<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>globalConfig<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>activityOptions<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>ignoreTargetSecurity<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>inTask<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>reason<span class="token punctuation">,</span>
                        mRequest<span class="token punctuation">.</span>allowPendingRemoteAnimationRegistryLookup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">onExecutionComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从execute我们可以看到，在这个过程Google工程师灵活的运用了try-final机制，通过onExecutionComplete在ActivityStartController清除数据放回startPool池子中。提一句实际上这种设计，我在Glide等经典第三方库已经看到了无数遍。</p>
<p>此时我们是一个同步操作，所以看看startActivityMayWait方法。</p>
<h2 id="startActivityMayWait"><a href="#startActivityMayWait" class="headerlink" title="startActivityMayWait"></a>startActivityMayWait</h2><p>这段我们分为三段来看：</p>
<h5 id="1-从PackageManagerService准备activity需要的数据"><a href="#1-从PackageManagerService准备activity需要的数据" class="headerlink" title="1.从PackageManagerService准备activity需要的数据"></a>1.从PackageManagerService准备activity需要的数据</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivityMayWait</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span>
            String callingPackage<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span>
            IVoiceInteractionSession voiceSession<span class="token punctuation">,</span> IVoiceInteractor voiceInteractor<span class="token punctuation">,</span>
            IBinder resultTo<span class="token punctuation">,</span> String resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span>
            ProfilerInfo profilerInfo<span class="token punctuation">,</span> WaitResult outResult<span class="token punctuation">,</span>
            Configuration globalConfig<span class="token punctuation">,</span> SafeActivityOptions options<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ignoreTargetSecurity<span class="token punctuation">,</span>
            <span class="token keyword">int</span> userId<span class="token punctuation">,</span> TaskRecord inTask<span class="token punctuation">,</span> String reason<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        ResolveInfo rInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                <span class="token number">0</span> <span class="token comment" spellcheck="true">/* matchFlags */</span><span class="token punctuation">,</span>
                        <span class="token function">computeResolveFilterUid</span><span class="token punctuation">(</span>
                                callingUid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>filterCallingUid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            UserInfo userInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> userInfo<span class="token punctuation">.</span><span class="token function">isManagedProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Special case for managed profiles, if attempting to launch non-cryto aware</span>
                <span class="token comment" spellcheck="true">// app in a locked managed profile from an unlocked parent allow it to resolve</span>
                <span class="token comment" spellcheck="true">// as user will be sent via confirm credentials to unlock the profile.</span>
                UserManager userManager <span class="token operator">=</span> UserManager<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> profileLockedAndParentUnlockingOrUnlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> token <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    UserInfo parent <span class="token operator">=</span> userManager<span class="token punctuation">.</span><span class="token function">getProfileParent</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    profileLockedAndParentUnlockingOrUnlocked <span class="token operator">=</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> userManager<span class="token punctuation">.</span><span class="token function">isUserUnlockingOrUnlocked</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>userManager<span class="token punctuation">.</span><span class="token function">isUserUnlockingOrUnlocked</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>profileLockedAndParentUnlockingOrUnlocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    rInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                            PackageManager<span class="token punctuation">.</span>MATCH_DIRECT_BOOT_AWARE
                                    <span class="token operator">|</span> PackageManager<span class="token punctuation">.</span>MATCH_DIRECT_BOOT_UNAWARE<span class="token punctuation">,</span>
                            <span class="token function">computeResolveFilterUid</span><span class="token punctuation">(</span>
                                    callingUid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>filterCallingUid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Collect information about the target of the Intent.</span>
        ActivityInfo aInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> rInfo<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以大致分为以下3步：<br>1.从ActivityStackSupervisor调用PMS获取ResolveInfo。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> ResolveInfo <span class="token function">resolveIntentInternal</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span>
            <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolveForStart<span class="token punctuation">,</span> <span class="token keyword">int</span> filterCallingUid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sUserManager<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            flags <span class="token operator">=</span> <span class="token function">updateFlagsForResolve</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> filterCallingUid<span class="token punctuation">,</span> resolveForStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPermissionManager<span class="token punctuation">.</span><span class="token function">enforceCrossUserPermission</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                    <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*requireFullPermission*/</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*checkShell*/</span><span class="token punctuation">,</span> <span class="token string">"resolve intent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span> query <span class="token operator">=</span> <span class="token function">queryIntentActivitiesInternal</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    flags<span class="token punctuation">,</span> filterCallingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> resolveForStart<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*allowDynamicSplits*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> ResolveInfo bestChoice <span class="token operator">=</span>
                    <span class="token function">chooseBestActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> query<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> bestChoice<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面代码，我们可以看到，这个方法是通过intent来从找到一个最合适的选择。我们可以推测，实际上这个ResolveInfo是指当我们安装了App之后，加载到PackageManagerService(后面称PMS)系统中的AndroidManifest.xml的数据。</p>
<p>queryIntentActivitiesInternal分步骤来说：</p>
<ul>
<li>1.查看当前Intent是否是显式Intent。是则取出其中的class对象和AndroidManifest的进行匹配，匹配成功返回。</li>
<li>2.如果没有指定包名则全系统的查找匹配intent</li>
<li>3.如果指定包名，则从当前的包名寻找匹配规则相符合的intent的Activity</li>
</ul>
<p>因此此时可能会匹配多个合适的Intent，再通过chooseBestActivity进一步筛选Activity。</p>
<p>为什么加上这一段，实际上这一段有一个关键的逻辑就是AppLink。开发经常用到，在AndroidManifest中设置好schme等Intent参数，让外部app来唤醒我们自己的app。<br>当唤醒的目的地只有一个直接返回，如果有多个则替换intent中的类，变成系统的ResolveActivity。用来选择我们的目的App，如下图。<br><img src="/images/AppLink.png" alt="AppLink.png"></p>
<ul>
<li>2.查不到ResolveInfo则尝试从直接启动中获取<br>自Android 5.0之后。Android系统将开始支持多用户系统，这些用户的配置都由UserManager控制，其中AccountManager则是控制每个用户下的账号。</li>
</ul>
<p>在Android7.0之后，为应用新增了一种启动模式Direct Boot(直接启动模式)。这种模式是指设备启动后进入的一个新模式，直到用户解锁（unlock）设备此阶段结束。这种模式，会为程序创建Device protected storage私有的存储空间。</p>
<p>这种模式比较特殊，我们需要在AndroidManifest中设置 android:directBootAware=”true”。</p>
<p>因此，这种模式下，需要唤醒特殊的Activity，确定此时已经解锁，需要从特殊的私有空间去查找对应的ResolveInfo。</p>
<ul>
<li>3.通过PMS的getActivityInfo读取ActivityInfo</li>
</ul>
<p>当我们确定好了ResolveInfo，就要AMS就通过resolveActivity从PMS读取ResolveInfo中的Activity信息。</p>
<pre class="line-numbers language-java"><code class="language-java">   ActivityInfo <span class="token function">resolveActivity</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> ResolveInfo rInfo<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span>
            ProfilerInfo profilerInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> ActivityInfo aInfo <span class="token operator">=</span> rInfo <span class="token operator">!=</span> null <span class="token operator">?</span> rInfo<span class="token punctuation">.</span>activityInfo <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                    aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Don't debug things in the system process</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aInfo<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>startFlags <span class="token operator">&amp;</span> ActivityManager<span class="token punctuation">.</span>START_FLAG_DEBUG<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mService<span class="token punctuation">.</span><span class="token function">setDebugApp</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> aInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>找到后，就显示的设置ComponentName，包名和类名。</p>
<h5 id="2-处理重量级进程"><a href="#2-处理重量级进程" class="headerlink" title="2.处理重量级进程"></a>2.处理重量级进程</h5><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span>mFocusedStack<span class="token punctuation">;</span>
            stack<span class="token punctuation">.</span>mConfigWillChange <span class="token operator">=</span> globalConfig <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span><span class="token function">getGlobalConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span>globalConfig<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags
                            <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_CANT_SAVE_STATE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                    mService<span class="token punctuation">.</span>mHasHeavyWeightFeature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// This may be a heavy-weight process!  Check to see if we already</span>
                <span class="token comment" spellcheck="true">// have another, different heavy-weight process running.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> ProcessRecord heavy <span class="token operator">=</span> mService<span class="token punctuation">.</span>mHeavyWeightProcess<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>heavy <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>heavy<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid <span class="token operator">!=</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid
                            <span class="token operator">||</span> <span class="token operator">!</span>heavy<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> appCallingUid <span class="token operator">=</span> callingUid<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ProcessRecord callerApp <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                appCallingUid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unable to find app for caller "</span> <span class="token operator">+</span> caller
                                        <span class="token operator">+</span> <span class="token string">" (pid="</span> <span class="token operator">+</span> callingPid <span class="token operator">+</span> <span class="token string">") when starting: "</span>
                                        <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                SafeActivityOptions<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>START_PERMISSION_DENIED<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        IIntentSender target <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getIntentSenderLocked</span><span class="token punctuation">(</span>
                                ActivityManager<span class="token punctuation">.</span>INTENT_SENDER_ACTIVITY<span class="token punctuation">,</span> <span class="token string">"android"</span><span class="token punctuation">,</span>
                                appCallingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> intent <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> resolvedType <span class="token punctuation">}</span><span class="token punctuation">,</span> PendingIntent<span class="token punctuation">.</span>FLAG_CANCEL_CURRENT
                                        <span class="token operator">|</span> PendingIntent<span class="token punctuation">.</span>FLAG_ONE_SHOT<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        Intent newIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// Caller is requesting a result.</span>
                            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>HeavyWeightSwitcherActivity<span class="token punctuation">.</span>KEY_HAS_RESULT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>HeavyWeightSwitcherActivity<span class="token punctuation">.</span>KEY_INTENT<span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">IntentSender</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>heavy<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ActivityRecord hist <span class="token operator">=</span> heavy<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>HeavyWeightSwitcherActivity<span class="token punctuation">.</span>KEY_CUR_APP<span class="token punctuation">,</span>
                                    hist<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>HeavyWeightSwitcherActivity<span class="token punctuation">.</span>KEY_CUR_TASK<span class="token punctuation">,</span>
                                    hist<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>HeavyWeightSwitcherActivity<span class="token punctuation">.</span>KEY_NEW_APP<span class="token punctuation">,</span>
                                aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        newIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        newIntent<span class="token punctuation">.</span><span class="token function">setClassName</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">,</span>
                                HeavyWeightSwitcherActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        intent <span class="token operator">=</span> newIntent<span class="token punctuation">;</span>
                        resolvedType <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        caller <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        callingPid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        componentSpecified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        rInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> null <span class="token comment" spellcheck="true">/*resolvedType*/</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                                <span class="token number">0</span> <span class="token comment" spellcheck="true">/* matchFlags */</span><span class="token punctuation">,</span> <span class="token function">computeResolveFilterUid</span><span class="token punctuation">(</span>
                                        callingUid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>filterCallingUid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        aInfo <span class="token operator">=</span> rInfo <span class="token operator">!=</span> null <span class="token operator">?</span> rInfo<span class="token punctuation">.</span>activityInfo <span class="token operator">:</span> null<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            aInfo <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getActivityInfoForUser</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个重量级进程实际上很早就存在，但是允许我们设置是在sdk 28(Android 9.0)之后才能开放给我们。</p>
<p>重量级的进程一般是指在整个系统唯一存在一个进程，不会正常走保存恢复机制，而是一直运行在后台，不会被后台杀死，因此需要用户显示退出进入该进程。</p>
<p>而这段代码就是当后台已经启动了一个重量进程的时候，用户又一次想要启动另一个重量级进程，就会弹出一个界面让用户进行选择。<br><img src="/images/%E9%87%8D%E9%87%8F%E7%BA%A7%E5%BA%94%E7%94%A8%E7%9A%84%E9%80%89%E6%8B%A9.png" alt="重量级应用的选择.png"><br>就是这个弹窗选择界面。这种行为一般是给游戏这种极其消耗资源的进程处理。</p>
<h2 id="3-进行下一步的启动"><a href="#3-进行下一步的启动" class="headerlink" title="3.进行下一步的启动"></a>3.进行下一步的启动</h2><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">final</span> ActivityRecord<span class="token punctuation">[</span><span class="token punctuation">]</span> outRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityRecord</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">startActivity</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> ephemeralIntent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> rInfo<span class="token punctuation">,</span>
                    voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span>
                    callingUid<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> options<span class="token punctuation">,</span>
                    ignoreTargetSecurity<span class="token punctuation">,</span> componentSpecified<span class="token punctuation">,</span> outRecord<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> reason<span class="token punctuation">,</span>
                    allowPendingRemoteAnimationRegistryLookup<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>outResult <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                outResult<span class="token punctuation">.</span>result <span class="token operator">=</span> res<span class="token punctuation">;</span>

                <span class="token keyword">final</span> ActivityRecord r <span class="token operator">=</span> outRecord<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token keyword">switch</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> START_SUCCESS<span class="token operator">:</span> <span class="token punctuation">{</span>
                        mSupervisor<span class="token punctuation">.</span>mWaitingActivityLaunched<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">do</span> <span class="token punctuation">{</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                mService<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>outResult<span class="token punctuation">.</span>result <span class="token operator">!=</span> START_TASK_TO_FRONT
                                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>outResult<span class="token punctuation">.</span>timeout <span class="token operator">&amp;&amp;</span> outResult<span class="token punctuation">.</span>who <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>outResult<span class="token punctuation">.</span>result <span class="token operator">==</span> START_TASK_TO_FRONT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            res <span class="token operator">=</span> START_TASK_TO_FRONT<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">case</span> START_DELIVERED_TO_TOP<span class="token operator">:</span> <span class="token punctuation">{</span>
                        outResult<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        outResult<span class="token punctuation">.</span>who <span class="token operator">=</span> r<span class="token punctuation">.</span>realActivity<span class="token punctuation">;</span>
                        outResult<span class="token punctuation">.</span>totalTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        outResult<span class="token punctuation">.</span>thisTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">case</span> START_TASK_TO_FRONT<span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ActivityRecord may represent a different activity, but it should not be</span>
                        <span class="token comment" spellcheck="true">// in the resumed state.</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>nowVisible <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span><span class="token function">isState</span><span class="token punctuation">(</span>RESUMED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            outResult<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                            outResult<span class="token punctuation">.</span>who <span class="token operator">=</span> r<span class="token punctuation">.</span>realActivity<span class="token punctuation">;</span>
                            outResult<span class="token punctuation">.</span>totalTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                            outResult<span class="token punctuation">.</span>thisTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            outResult<span class="token punctuation">.</span>thisTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            mSupervisor<span class="token punctuation">.</span><span class="token function">waitActivityVisible</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>realActivity<span class="token punctuation">,</span> outResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// Note: the timeout variable is not currently not ever set.</span>
                            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                    mService<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>outResult<span class="token punctuation">.</span>timeout <span class="token operator">&amp;&amp;</span> outResult<span class="token punctuation">.</span>who <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以看到进行下一个的启动之后，如果返回的状态码START_SUCCESS，就会阻塞AMS，等待唤醒。</p>
<p>一般来说如果startActivity正常完成了整个流程就返回状态代码为<code>START_SUCCESS</code>.进入到了第一次阻塞状态，而这个阻塞会不断判断的当前的状态是否是<code>START_TASK_TO_FRONT</code>,是才退出。然而如果此时Activity是第一次创建，则通过<code>ActivityStarter.startActivity</code>先<code>START_SUCCESS</code>后,通过postStartActivityProcessing 把结果转化为<code>START_TASK_TO_FRONT</code>.因此能够立即退出当前的状态。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token keyword">final</span> ActivityRecord r<span class="token punctuation">,</span> ActivityRecord sourceRecord<span class="token punctuation">,</span>
                IVoiceInteractionSession voiceSession<span class="token punctuation">,</span> IVoiceInteractor voiceInteractor<span class="token punctuation">,</span>
                <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> ActivityOptions options<span class="token punctuation">,</span> TaskRecord inTask<span class="token punctuation">,</span>
                ActivityRecord<span class="token punctuation">[</span><span class="token punctuation">]</span> outActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> START_CANCELED<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span>mWindowManager<span class="token punctuation">.</span><span class="token function">deferSurfaceLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span>
                    startFlags<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> outActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token function">postStartActivityProcessing</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> result<span class="token punctuation">,</span> mTargetStack<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们先把目光放在ActivityStartController.startActivity这个后续核心方法中。</p>
<h2 id="startActivity处理ActivityInfo转化为ActivityRecord"><a href="#startActivity处理ActivityInfo转化为ActivityRecord" class="headerlink" title="startActivity处理ActivityInfo转化为ActivityRecord"></a>startActivity处理ActivityInfo转化为ActivityRecord</h2><p>这里分为3步聊聊：</p>
<h3 id="1-准备ActivtyRecord的基础数据"><a href="#1-准备ActivtyRecord的基础数据" class="headerlink" title="1.准备ActivtyRecord的基础数据"></a>1.准备ActivtyRecord的基础数据</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span> Intent ephemeralIntent<span class="token punctuation">,</span>
            String resolvedType<span class="token punctuation">,</span> ActivityInfo aInfo<span class="token punctuation">,</span> ResolveInfo rInfo<span class="token punctuation">,</span>
            IVoiceInteractionSession voiceSession<span class="token punctuation">,</span> IVoiceInteractor voiceInteractor<span class="token punctuation">,</span>
            IBinder resultTo<span class="token punctuation">,</span> String resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> callingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span>
            String callingPackage<span class="token punctuation">,</span> <span class="token keyword">int</span> realCallingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> realCallingUid<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span>
            SafeActivityOptions options<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> ignoreTargetSecurity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> componentSpecified<span class="token punctuation">,</span> ActivityRecord<span class="token punctuation">[</span><span class="token punctuation">]</span> outActivity<span class="token punctuation">,</span>
            TaskRecord inTask<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> err <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span>START_SUCCESS<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Pull the optional Ephemeral Installer-only bundle out of the options early.</span>
        <span class="token keyword">final</span> Bundle verificationBundle
                <span class="token operator">=</span> options <span class="token operator">!=</span> null <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">popAppVerificationBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>

        ProcessRecord callerApp <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            callerApp <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                callingPid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
                callingUid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> aInfo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> aInfo<span class="token punctuation">.</span>applicationInfo <span class="token operator">!=</span> null
                <span class="token operator">?</span> UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        ActivityRecord sourceRecord <span class="token operator">=</span> null<span class="token punctuation">;</span>
        ActivityRecord resultRecord <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultTo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sourceRecord <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">isInAnyStackLocked</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sourceRecord<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    resultRecord <span class="token operator">=</span> sourceRecord<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了实例化ActivityRecord，Android系统通过IApplicationThread获取当前Activity所处在进程数据。</p>
<blockquote>
<p>也就是调用 mService.getRecordForAppLocked(caller); 获取ProcessRecord。</p>
</blockquote>
<h5 id="AMS寻找进程"><a href="#AMS寻找进程" class="headerlink" title="AMS寻找进程"></a>AMS寻找进程</h5><p>我们追踪一下AMS是怎么通过IApplicationThread这个AppThread远程binder对象获得的。</p>
<pre><code>    private final int getLRURecordIndexForAppLocked(IApplicationThread thread) {
        final IBinder threadBinder = thread.asBinder();
        // Find the application record.
        for (int i=mLruProcesses.size()-1; i&gt;=0; i--) {
            final ProcessRecord rec = mLruProcesses.get(i);
            if (rec.thread != null &amp;&amp; rec.thread.asBinder() == threadBinder) {
                return i;
            }
        }
        return -1;
    }

 ProcessRecord getRecordForAppLocked(IApplicationThread thread) {
        if (thread == null) {
            return null;
        }

        int appIndex = getLRURecordIndexForAppLocked(thread);
        if (appIndex &gt;= 0) {
            return mLruProcesses.get(appIndex);
        }

        // Validation: if it isn't in the LRU list, it shouldn't exist, but let's
        // double-check that.
        final IBinder threadBinder = thread.asBinder();
        final ArrayMap&lt;String, SparseArray&lt;ProcessRecord&gt;&gt; pmap = mProcessNames.getMap();
        for (int i = pmap.size()-1; i &gt;= 0; i--) {
            final SparseArray&lt;ProcessRecord&gt; procs = pmap.valueAt(i);
            for (int j = procs.size()-1; j &gt;= 0; j--) {
                final ProcessRecord proc = procs.valueAt(j);
                if (proc.thread != null &amp;&amp; proc.thread.asBinder() == threadBinder) {
                    Slog.wtf(TAG, "getRecordForApp: exists in name list but not in LRU list: "
                            + proc);
                    return proc;
                }
            }
        }

        return null;
    }</code></pre><p>从这里我们稍微能看出Google对性能的追求。在整个AMS中，有两个数据结构存储着进程对象：</p>
<h5 id="1-mLruProcesses-一个LRU的ArrayList存储着数据。这个数据结构虽然不是我们常用的LRUMap-LinkHashMap-经过处理后能够自动处理LRU算法，将会在算法专栏和大家聊聊-最近最少使用算法。但是Google-工程师选择自己处理。"><a href="#1-mLruProcesses-一个LRU的ArrayList存储着数据。这个数据结构虽然不是我们常用的LRUMap-LinkHashMap-经过处理后能够自动处理LRU算法，将会在算法专栏和大家聊聊-最近最少使用算法。但是Google-工程师选择自己处理。" class="headerlink" title="1.mLruProcesses 一个LRU的ArrayList存储着数据。这个数据结构虽然不是我们常用的LRUMap(LinkHashMap 经过处理后能够自动处理LRU算法，将会在算法专栏和大家聊聊)最近最少使用算法。但是Google 工程师选择自己处理。"></a>1.mLruProcesses 一个LRU的ArrayList存储着数据。这个数据结构虽然不是我们常用的LRUMap(LinkHashMap 经过处理后能够自动处理LRU算法，将会在算法专栏和大家聊聊)最近最少使用算法。但是Google 工程师选择自己处理。</h5><h5 id="2-mProcessNames-存储着所有进程的数据，可以通过Binde的引用名反过来找到进程的数据。"><a href="#2-mProcessNames-存储着所有进程的数据，可以通过Binde的引用名反过来找到进程的数据。" class="headerlink" title="2.mProcessNames 存储着所有进程的数据，可以通过Binde的引用名反过来找到进程的数据。"></a>2.mProcessNames 存储着所有进程的数据，可以通过Binde的引用名反过来找到进程的数据。</h5><p>所以用我们常用的话来说，AMS在进程查找中用了二级缓存。</p>
<p>趁热打铁看看进程是怎么更新的LRU算法：</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">,</span> <span class="token keyword">boolean</span> activityChange<span class="token punctuation">,</span>
            ProcessRecord client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasActivity <span class="token operator">=</span> app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> app<span class="token punctuation">.</span>hasClientActivities
                <span class="token operator">||</span> app<span class="token punctuation">.</span>treatLikeActivity <span class="token operator">||</span> app<span class="token punctuation">.</span>recentTasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasService <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// not impl yet. app.services.size() > 0;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activityChange <span class="token operator">&amp;&amp;</span> hasActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The process has activities, so we are only allowing activity-based adjustments</span>
            <span class="token comment" spellcheck="true">// to move it.  It should be kept in the front of the list with other</span>
            <span class="token comment" spellcheck="true">// processes that have activities, and we don't want those to change their</span>
            <span class="token comment" spellcheck="true">// order except due to activity operations.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mLruSeq<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>lastActivityTime <span class="token operator">=</span> now<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// First a quick reject: if the app is already at the position we will</span>
        <span class="token comment" spellcheck="true">// put it, then there is nothing to do.</span>
        <span class="token comment" spellcheck="true">//步骤一</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> mLruProcesses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mLruProcesses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLruProcessServiceStart <span class="token operator">></span> <span class="token number">0</span>
                    <span class="token operator">&amp;&amp;</span> mLruProcesses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mLruProcessServiceStart<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true">//获取最近使用相同ProcessRecord的索引</span>
        <span class="token keyword">int</span> lrui <span class="token operator">=</span> mLruProcesses<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>lrui <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lrui <span class="token operator">&lt;</span> mLruProcessActivityStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLruProcessActivityStart<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lrui <span class="token operator">&lt;</span> mLruProcessServiceStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLruProcessServiceStart<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mLruProcesses<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>lrui<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">int</span> nextIndex<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//处理Activity详细看下面带着Activity的进程情况套路</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hasService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Process has services, put it at the top of the service list.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mLruProcesses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mLruProcessActivityStart<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            nextIndex <span class="token operator">=</span> mLruProcessServiceStart<span class="token punctuation">;</span>
            mLruProcessActivityStart<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>  <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//详细看处理没有Actvity以及Service的进程</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// If the app is currently using a content provider or service,</span>
        <span class="token comment" spellcheck="true">// bump those processes as well.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>app<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConnectionRecord cr <span class="token operator">=</span> app<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span>binding <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cr<span class="token punctuation">.</span>serviceDead <span class="token operator">&amp;&amp;</span> cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>service <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>service<span class="token punctuation">.</span>app <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>service<span class="token punctuation">.</span>app<span class="token punctuation">.</span>lruSeq <span class="token operator">!=</span> mLruSeq
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>service<span class="token punctuation">.</span>app<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nextIndex <span class="token operator">=</span> <span class="token function">updateLruProcessInternalLocked</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>service<span class="token punctuation">.</span>app<span class="token punctuation">,</span> now<span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span>
                        <span class="token string">"service connection"</span><span class="token punctuation">,</span> cr<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>app<span class="token punctuation">.</span>conProviders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ContentProviderRecord cpr <span class="token operator">=</span> app<span class="token punctuation">.</span>conProviders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span>provider<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>proc <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cpr<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>lruSeq <span class="token operator">!=</span> mLruSeq <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cpr<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nextIndex <span class="token operator">=</span> <span class="token function">updateLruProcessInternalLocked</span><span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>proc<span class="token punctuation">,</span> now<span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span>
                        <span class="token string">"provider reference"</span><span class="token punctuation">,</span> cpr<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="额外知识的补充"><a href="#额外知识的补充" class="headerlink" title="额外知识的补充"></a>额外知识的补充</h5><p>要看懂这一段逻辑，我们必须要普及一个基础知识，Android的uid和userId。</p>
<blockquote>
<p>虽然Android是沿用Linux内核，其uid充满着迷惑性。android的uid和Linux的uid有区别。在Linux中uid和task_struct(进程描述符)是一对一绑定一起，代表着当前进程用户的使用者id。而Android相似却不同，Android在framework层的userid是在PMS按照时候通过PackageParser.Package.scanPackageDirtyLI()分配好的.</p>
</blockquote>
<p>每一次获取Uid都是经过下面这一段算法：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getUid</span><span class="token punctuation">(</span><span class="token annotation punctuation">@UserIdInt</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@AppIdInt</span> <span class="token keyword">int</span> appId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MU_ENABLED<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//是否支持多用户</span>
            <span class="token comment" spellcheck="true">//PER_USER_RANGE  为 100000</span>
            <span class="token keyword">return</span> userId <span class="token operator">*</span> PER_USER_RANGE <span class="token operator">+</span> <span class="token punctuation">(</span>appId <span class="token operator">%</span> PER_USER_RANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> appId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过userId获取uid</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MU_ENABLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> uid <span class="token operator">/</span> PER_USER_RANGE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>userId * 100000 + (appId % 100000)<br>这样就能把uid和userId互相转化。</p>
</blockquote>
<p>因此这种设计导致了uid可以共享，虽然用的少，但是实际上确实存在。当包名相同，但是为组件在AndroidManifest设置了android:process这个标签，就能在不同的进程共享一个uid。也能设置android:shareUserid,不同包名时候可以共享(相同包名，相同签名则会覆盖)。这里就继续不探究，后续会在PMS解析之后再来详细看看。</p>
<h5 id="回到进程的LRU算法"><a href="#回到进程的LRU算法" class="headerlink" title="回到进程的LRU算法"></a>回到进程的LRU算法</h5><p>我们先要弄明白一般的LRU算法是为了让最近最少用的放到队尾，最近最常用放在队头，目的是为了在某种常用这个对象，能够减少搜索时间，从而达到性能优化目的。</p>
<p>而这个进程的LRU算法稍微有点不一样。最近最常用的放在队末，最近最少用放在队首。</p>
<p>因此在循环的时候，AMS是从队末开始搜索进程对象(ProcessRecord)。弄懂设计原型，再来看看Google工程师的设计。</p>
<p>每一次通过update方法调整进程在LRU算法，首先会判断当前进程是否包含Activity或者Service。</p>
<p>不管包含着什么，只要发现当前要查找的ProcessRecord在队末，则立即返回。接着再次搜索最近一次使用相同的进程的索引，并且删除。</p>
<p>同时这里可以看到在这个LRU中有两个位置标签</p>
<ul>
<li><ol>
<li>mLruProcessActivityStart</li>
</ol>
</li>
<li><ol start="2">
<li>mLruProcessServiceStart</li>
</ol>
</li>
</ul>
<p>这两个位置标签把整个LRU的list切割为3部分，从mLruProcessActivityStart到队末，就是带着Activity的进程集合，mLruProcessServiceStart到mLruProcessActivityStart就是带着service的集合，从mLruProcessServiceStart到队首则是上面两者都不带。</p>
<p>因此在调整的时候，我们带着Activity的进程只需要调整mLruProcessActivityStart到队末那一段。带着service只需要调整mLruProcessServiceStart到mLruProcessActivityStart这一段。</p>
<p>因此当我们删除ProcessRecord这两个索引必须向后移动。</p>
<p>接下来分情况讨论：</p>
<ul>
<li>1.带着Activity的进程：<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> mLruProcesses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> app<span class="token punctuation">.</span>recentTasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                  <span class="token operator">&amp;&amp;</span> mLruProcessActivityStart <span class="token operator">&lt;</span> <span class="token punctuation">(</span>N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
              mLruProcesses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment" spellcheck="true">// To keep it from spamming the LRU list (by making a bunch of clients),</span>
              <span class="token comment" spellcheck="true">// we will push down any other entries owned by the app.</span>
              <span class="token keyword">final</span> <span class="token keyword">int</span> uid <span class="token operator">=</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> N <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">></span> mLruProcessActivityStart<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  ProcessRecord subProc <span class="token operator">=</span> mLruProcesses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>subProc<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid <span class="token operator">==</span> uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid <span class="token operator">!=</span> uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                          ProcessRecord tmp <span class="token operator">=</span> mLruProcesses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          mLruProcesses<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> mLruProcesses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                          mLruProcesses<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          i<span class="token operator">--</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      <span class="token comment" spellcheck="true">// A gap, we can stop here.</span>
                      <span class="token keyword">break</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
              mLruProcesses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          nextIndex <span class="token operator">=</span> mLruProcessServiceStart<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
从这里我们看到当要添加进LRU或者重新调整ProcessRecord会判断当前进程中有没有最近使用的TaskRecord集合或者ProcessRecord中的Activity集合大于0.则插入到队末。</li>
</ul>
<p>接着开始循环后面的集合，查看有没有ProcessRecord和当前的共享一个uid。找到有个这个共享的，则交换位置，让共享uid的进程往队末靠，这样就是实现了LRU关键算法。</p>
<p>最后nextIndex设置为mLruProcessServiceStart</p>
<ul>
<li><p>2.当插入的进程是有service的。<br>直接插入到mLruProcessActivityStart的位置，并且mLruProcessActivityStart加一，让Activity的集合向后移动。<br>最后nextIndex = mLruProcessServiceStart;</p>
</li>
<li><p>3.当插入的进程是没有Activity和Service的。</p>
<pre class="line-numbers language-java"><code class="language-java">          <span class="token comment" spellcheck="true">// Process not otherwise of interest, it goes to the top of the non-service area.</span>
          <span class="token keyword">int</span> index <span class="token operator">=</span> mLruProcessServiceStart<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">// If there is a client, don't allow the process to be moved up higher</span>
              <span class="token comment" spellcheck="true">// in the list than that client.</span>
              <span class="token keyword">int</span> clientIndex <span class="token operator">=</span> mLruProcesses<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>clientIndex <span class="token operator">&lt;=</span> lrui<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">// Don't allow the client index restriction to push it down farther in the</span>
                  <span class="token comment" spellcheck="true">// list than it already is.</span>
                  clientIndex <span class="token operator">=</span> lrui<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>clientIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> index <span class="token operator">></span> clientIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  index <span class="token operator">=</span> clientIndex<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          mLruProcesses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
          nextIndex <span class="token operator">=</span> index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
          mLruProcessActivityStart<span class="token operator">++</span><span class="token punctuation">;</span>
          mLruProcessServiceStart<span class="token operator">++</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里又分为有没有带上client，和没有client端，带上client端这种情况一般是service通过Binder绑定了远程端的进程并且在重启Service情况下。这个client是指远程端的ProcessRecord。因此这里有两种情况，一种是本身远程端就带着Activity/Service，一种就是都没有带。</p>
</li>
<li><p>1.当没有带上client端<br>那么当前进程将会插在mLruProcessServiceStart，之后这个位置并且mLruProcessServiceStart和mLruProcessActivityStart都向后移动一位。<br>nextindex此时为移动前mLruProcessServiceStart - 1.</p>
</li>
<li><p>2.当带上client端<br>当client端本身存在，并且比当前的进程在LRU位置考后（更加靠近前端），或者不存在，则设置clientIndex(为client原先在LRU中位置)为设置为当前进程调整前在LRU的位置。</p>
</li>
</ul>
<p>如果client不存在，则插入位置为mLruProcessServiceStart。</p>
<p>接着判断如果client如果存在，且client位置比当前进程的原先的位置靠前，并且当前位置mLruProcessServiceStart小，比则插入位置为原先的位置。</p>
<p>如果当client存在，且比当前进程(app)靠后，且client的位置比mLruProcessServiceStart小，插入的位置是mLruProcessServiceStart。</p>
<p>如果当client存在，且比当前进程(app)靠后，且client的位置比mLruProcessServiceStart大，插入的位置是client的在LRU位置。</p>
<p>nextIndex设置为mLruProcessServiceStart -1，或者client在LRU位置-1.</p>
<h5 id="进程的LRU后续算法"><a href="#进程的LRU后续算法" class="headerlink" title="进程的LRU后续算法"></a>进程的LRU后续算法</h5><p>处理了Activity和Service，会继续后续处理。处理进程中Service绑定远程端，ContentProvider。</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>app<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConnectionRecord cr <span class="token operator">=</span> app<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span>binding <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cr<span class="token punctuation">.</span>serviceDead <span class="token operator">&amp;&amp;</span> cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>service <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>service<span class="token punctuation">.</span>app <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>service<span class="token punctuation">.</span>app<span class="token punctuation">.</span>lruSeq <span class="token operator">!=</span> mLruSeq
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>service<span class="token punctuation">.</span>app<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nextIndex <span class="token operator">=</span> <span class="token function">updateLruProcessInternalLocked</span><span class="token punctuation">(</span>cr<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>service<span class="token punctuation">.</span>app<span class="token punctuation">,</span> now<span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span>
                        <span class="token string">"service connection"</span><span class="token punctuation">,</span> cr<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>app<span class="token punctuation">.</span>conProviders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ContentProviderRecord cpr <span class="token operator">=</span> app<span class="token punctuation">.</span>conProviders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span>provider<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>proc <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cpr<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>lruSeq <span class="token operator">!=</span> mLruSeq <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cpr<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nextIndex <span class="token operator">=</span> <span class="token function">updateLruProcessInternalLocked</span><span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>proc<span class="token punctuation">,</span> now<span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span>
                        <span class="token string">"provider reference"</span><span class="token punctuation">,</span> cpr<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">updateLruProcessInternalLocked</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span>
            String what<span class="token punctuation">,</span> Object obj<span class="token punctuation">,</span> ProcessRecord srcApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>lastActivityTime <span class="token operator">=</span> now<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> app<span class="token punctuation">.</span>recentTasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> index<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> lrui <span class="token operator">=</span> mLruProcesses<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lrui <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> index<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>lrui <span class="token operator">>=</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> index<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>lrui <span class="token operator">>=</span> mLruProcessActivityStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> index<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mLruProcesses<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>lrui<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            index<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mLruProcesses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> index<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的逻辑联动上面的函数：</p>
<ul>
<li>1.当service的远程进程存在Activity就不存移动了。</li>
<li>2.当service的远程进程或者ContentProvider不存在在LRU中也不调整了。</li>
<li>3.当service的远程进程或者ContentProvider比nextIndex的位置大也不调整。</li>
<li>4.当service的远程进程或者ContentProvider在mLruProcessActivityStart后面也不调整。</li>
<li>5.否则就逐个添加mLruProcessServiceStart之后；不带Activity/Service的进程插在mLruProcessServiceStart之前或者client之后。</li>
</ul>
<p>用一副图表示整个进程的LRU计算就是如下<br><img src="/images/Android%E8%BF%9B%E7%A8%8BLRU%E7%BC%93%E5%AD%98%E8%B0%83%E6%95%B4.png" alt="Android进程LRU缓存调整.png"></p>
<p>以上就是进程处理LRU全部内容。这也为什么Google工程师选择使用ArrayList而不是用LinkHashMap做LRU处理。因为Google工程机为这个LRU做了浮标，划分了调整的区域，这样就能进一步的压缩搜索和调整时间。</p>
<p>接下来让我继续回到AMS的startActivity方法。</p>
<h2 id="isInAnyStackLocked"><a href="#isInAnyStackLocked" class="headerlink" title="isInAnyStackLocked"></a>isInAnyStackLocked</h2><p>上面的长篇大论只是为了找到缓存在AMS中的进程。接下来我们要j检验对应Activity的栈。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java" target="_blank" rel="noopener">ActivityStackSupervisor.java</a></p>
<p>这个方法中传进来一个关键的resultTo的Binder代理对象。不同的是，这个指代并不是任何Activity，而是指代在启动Activity时候，绑定的WindowManager<br>Binder代理，之后就会看到了。</p>
<pre class="line-numbers language-java"><code class="language-java">ActivityRecord <span class="token function">isInAnyStackLocked</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> numDisplays <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> displayNdx <span class="token operator">&lt;</span> numDisplays<span class="token punctuation">;</span> <span class="token operator">++</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ActivityDisplay display <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> stackNdx <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> stackNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>stackNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getChildAt</span><span class="token punctuation">(</span>stackNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> ActivityRecord r <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">isInStackLocked</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到的是，如果启动的时候，带的调用方WindowManager的Binder代理对象。此时说明此时Activity很可能是和当前的Activity在同一个进程。那么Android将会从mActivityDisplays获取ActivityDisplay对象，从中找到我们需要ActivityStack，从名字就能明白，这就是就是我们的Activity栈。</p>
<p>这个mActivityDisplays是个什么数据结构，实际上这是一个联通Activity的display逻辑显示器和Activity关联。换句话说，就是WindowManager和Activity关联起来的一个数据结构。在ActivityDisplay保存这个ActivityStack，为了WIndowManager能够跟着ActivityStack变化而变化。</p>
<p>这里的场景是，先拿到当前的ActivityStack,并且从中获取到启动者的ActivityRecord(Activity在AMS保存着信息)。</p>
<h2 id="startActivity根据当前启动flag做第一次调整"><a href="#startActivity根据当前启动flag做第一次调整" class="headerlink" title="startActivity根据当前启动flag做第一次调整"></a>startActivity根据当前启动flag做第一次调整</h2><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">final</span> <span class="token keyword">int</span> launchFlags <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_FORWARD_RESULT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Transfer the result target from the source activity to the new</span>
            <span class="token comment" spellcheck="true">// one being started, including any failures.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                SafeActivityOptions<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>START_FORWARD_AND_REQUEST_CONFLICT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            resultRecord <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>resultTo<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//这个resultTo是指Activity中的属性，和上面的不一样。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>resultRecord<span class="token punctuation">.</span><span class="token function">isInStackLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resultRecord <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            resultWho <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>resultWho<span class="token punctuation">;</span>
            requestCode <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>requestCode<span class="token punctuation">;</span>
            sourceRecord<span class="token punctuation">.</span>resultTo <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resultRecord<span class="token punctuation">.</span><span class="token function">removeResultsLocked</span><span class="token punctuation">(</span>sourceRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord<span class="token punctuation">.</span>launchedFromUid <span class="token operator">==</span> callingUid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                callingPackage <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">final</span> ActivityStack resultStack <span class="token operator">=</span> resultRecord <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> resultRecord<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一段代码就是第一次获取intent中的启动flag。首先处理的flag是FORWARD_RESULT。</p>
<p>这个intent的flag用的不多，意思是透传requestCode。也就是说当设置了这个flag，那么被启动的这个Activity将不会接受这个requestCode。而是透传到启动的下一个Activity。但是作为透传者不能设置任何的requestCode，设置了则会报错 FORWARD_RESULT_FLAG used while also requesting a result。<br><img src="/images/FORWARD_RESULT_FLAG%E5%BC%82%E5%B8%B8.png" alt="FORWARD_RESULT_FLAG异常.png"></p>
<p>了解到用法，我们可以直接从这里看到当我们设置了requestCode大于0则，会立即返回错误。否则的话当成并没有发送这个requestcode。此时将会取出启动这个sourceRecord的requestCode，resultWho设置给下一个Activity，把唤起的包名更换为sourceRecord，这样就完成了透传动作。</p>
<p>同时，这个已经启动过的sourceRecord清空掉resultTo，保证透传的目标为这个新建的。</p>
<h2 id="startActivity校验权限，生成ActivityRecord"><a href="#startActivity校验权限，生成ActivityRecord" class="headerlink" title="startActivity校验权限，生成ActivityRecord"></a>startActivity校验权限，生成ActivityRecord</h2><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">boolean</span> abort <span class="token operator">=</span> <span class="token operator">!</span>mSupervisor<span class="token punctuation">.</span><span class="token function">checkStartAnyActivityPermission</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span>
                requestCode<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> ignoreTargetSecurity<span class="token punctuation">,</span>
                inTask <span class="token operator">!=</span> null<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> resultRecord<span class="token punctuation">,</span> resultStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        abort <span class="token operator">|=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mIntentFirewall<span class="token punctuation">.</span><span class="token function">checkStartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                callingPid<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Merge the two options bundles, while realCallerOptions takes precedence.</span>
        ActivityOptions checkedOptions <span class="token operator">=</span> options <span class="token operator">!=</span> null
                <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> mSupervisor<span class="token punctuation">)</span>
                <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>allowPendingRemoteAnimationRegistryLookup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            checkedOptions <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getPendingRemoteAnimationRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">overrideOptionsIfNeeded</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">,</span> checkedOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mController <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// The Intent we give to the watcher has the extra data</span>
                <span class="token comment" spellcheck="true">// stripped off, since it can contain private information.</span>
                Intent watchIntent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">cloneFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                abort <span class="token operator">|=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mController<span class="token punctuation">.</span><span class="token function">activityStarting</span><span class="token punctuation">(</span>watchIntent<span class="token punctuation">,</span>
                        aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mService<span class="token punctuation">.</span>mController <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mInterceptor<span class="token punctuation">.</span><span class="token function">setStates</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> callingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInterceptor<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> rInfo<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span>
                callingUid<span class="token punctuation">,</span> checkedOptions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// activity start was intercepted, e.g. because the target user is currently in quiet</span>
            <span class="token comment" spellcheck="true">// mode (turn off work) or the target application is suspended</span>
            intent <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mIntent<span class="token punctuation">;</span>
            rInfo <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mRInfo<span class="token punctuation">;</span>
            aInfo <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mAInfo<span class="token punctuation">;</span>
            resolvedType <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mResolvedType<span class="token punctuation">;</span>
            inTask <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mInTask<span class="token punctuation">;</span>
            callingPid <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mCallingPid<span class="token punctuation">;</span>
            callingUid <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mCallingUid<span class="token punctuation">;</span>
            checkedOptions <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mActivityOptions<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>abort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resultStack<span class="token punctuation">.</span><span class="token function">sendActivityResultLocked</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> resultRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span>
                        RESULT_CANCELED<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ActivityOptions<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>checkedOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> START_ABORTED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// If permissions need a review before any of the app components can run, we</span>
        <span class="token comment" spellcheck="true">// launch the review activity and pass a pending intent to start the activity</span>
        <span class="token comment" spellcheck="true">// we are to launching now after the review is completed.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mPermissionReviewRequired <span class="token operator">&amp;&amp;</span> aInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">getPackageManagerInternalLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPermissionsReviewRequired</span><span class="token punctuation">(</span>
                    aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                IIntentSender target <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getIntentSenderLocked</span><span class="token punctuation">(</span>
                        ActivityManager<span class="token punctuation">.</span>INTENT_SENDER_ACTIVITY<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span>
                        callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>intent<span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>resolvedType<span class="token punctuation">}</span><span class="token punctuation">,</span> PendingIntent<span class="token punctuation">.</span>FLAG_CANCEL_CURRENT
                                <span class="token operator">|</span> PendingIntent<span class="token punctuation">.</span>FLAG_ONE_SHOT<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> flags <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Intent newIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_REVIEW_PERMISSIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>flags
                        <span class="token operator">|</span> Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_PACKAGE_NAME<span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_INTENT<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntentSender</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_RESULT_NEEDED<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                intent <span class="token operator">=</span> newIntent<span class="token punctuation">;</span>

                resolvedType <span class="token operator">=</span> null<span class="token punctuation">;</span>
                callingUid <span class="token operator">=</span> realCallingUid<span class="token punctuation">;</span>
                callingPid <span class="token operator">=</span> realCallingPid<span class="token punctuation">;</span>

                rInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token function">computeResolveFilterUid</span><span class="token punctuation">(</span>
                                callingUid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>filterCallingUid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                aInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> rInfo<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span>
                        null <span class="token comment" spellcheck="true">/*profilerInfo*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>rInfo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> rInfo<span class="token punctuation">.</span>auxiliaryInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            intent <span class="token operator">=</span> <span class="token function">createLaunchIntent</span><span class="token punctuation">(</span>rInfo<span class="token punctuation">.</span>auxiliaryInfo<span class="token punctuation">,</span> ephemeralIntent<span class="token punctuation">,</span>
                    callingPackage<span class="token punctuation">,</span> verificationBundle<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            resolvedType <span class="token operator">=</span> null<span class="token punctuation">;</span>
            callingUid <span class="token operator">=</span> realCallingUid<span class="token punctuation">;</span>
            callingPid <span class="token operator">=</span> realCallingPid<span class="token punctuation">;</span>

            aInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> rInfo<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> null <span class="token comment" spellcheck="true">/*profilerInfo*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ActivityRecord r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityRecord</span><span class="token punctuation">(</span>mService<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                callingPackage<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> mService<span class="token punctuation">.</span><span class="token function">getGlobalConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                resultRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> componentSpecified<span class="token punctuation">,</span> voiceSession <span class="token operator">!=</span> null<span class="token punctuation">,</span>
                mSupervisor<span class="token punctuation">,</span> checkedOptions<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            outActivity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个代码片段中，有两个关键函数做权限判断。</p>
<ul>
<li><p>1.checkStartAnyActivityPermission<br>这个函数最后调用到PermissionManagerService中，对当前的uid精心检验是否合法。</p>
</li>
<li><p>2.mInterceptor.intercept 该函数是一个拦截器对当前的参数精心拦截，里面的拦截判断主要有三点：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStartInterceptor.java" target="_blank" rel="noopener">ActivityStartInterceptor.java</a></p>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">boolean</span> <span class="token function">intercept</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> ResolveInfo rInfo<span class="token punctuation">,</span> ActivityInfo aInfo<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span>
            TaskRecord inTask<span class="token punctuation">,</span> <span class="token keyword">int</span> callingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> ActivityOptions activityOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mUserManager <span class="token operator">=</span> UserManager<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mServiceContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mIntent <span class="token operator">=</span> intent<span class="token punctuation">;</span>
        mCallingPid <span class="token operator">=</span> callingPid<span class="token punctuation">;</span>
        mCallingUid <span class="token operator">=</span> callingUid<span class="token punctuation">;</span>
        mRInfo <span class="token operator">=</span> rInfo<span class="token punctuation">;</span>
        mAInfo <span class="token operator">=</span> aInfo<span class="token punctuation">;</span>
        mResolvedType <span class="token operator">=</span> resolvedType<span class="token punctuation">;</span>
        mInTask <span class="token operator">=</span> inTask<span class="token punctuation">;</span>
        mActivityOptions <span class="token operator">=</span> activityOptions<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">interceptSuspendedPackageIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">interceptQuietProfileIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">interceptHarmfulAppIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">interceptWorkProfileChallengeIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.当当前要启动的包被管理员是否被挂起，不允许操作</p>
</li>
<li><p>2.当此时的用户在安静模式，这个安静模式不是指音量，而是指UserManager中设置的requestQuietModeEnabled，在这个模式下，应用不会真正的运行。关闭安静模式时候就有个弹窗。</p>
</li>
</ul>
<p>-3.当前的应用被判断为有害</p>
<p>以上三种情况下，只要想要打开Activity都会有个新的ActivityInfo替代原来的Activity，用来提示用户。</p>
<p>还有一种常见情况，当我们的权限判断弹窗并不是直接拦截，而是等到Activity启动后，作为一个弹窗拦截在上面的情况。</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mPermissionReviewRequired <span class="token operator">&amp;&amp;</span> aInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">getPackageManagerInternalLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPermissionsReviewRequired</span><span class="token punctuation">(</span>
                    aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                IIntentSender target <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getIntentSenderLocked</span><span class="token punctuation">(</span>
                        ActivityManager<span class="token punctuation">.</span>INTENT_SENDER_ACTIVITY<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span>
                        callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>intent<span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>resolvedType<span class="token punctuation">}</span><span class="token punctuation">,</span> PendingIntent<span class="token punctuation">.</span>FLAG_CANCEL_CURRENT
                                <span class="token operator">|</span> PendingIntent<span class="token punctuation">.</span>FLAG_ONE_SHOT<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> flags <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Intent newIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_REVIEW_PERMISSIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>flags
                        <span class="token operator">|</span> Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_PACKAGE_NAME<span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_INTENT<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntentSender</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_RESULT_NEEDED<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                intent <span class="token operator">=</span> newIntent<span class="token punctuation">;</span>

                resolvedType <span class="token operator">=</span> null<span class="token punctuation">;</span>
                callingUid <span class="token operator">=</span> realCallingUid<span class="token punctuation">;</span>
                callingPid <span class="token operator">=</span> realCallingPid<span class="token punctuation">;</span>

                rInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token function">computeResolveFilterUid</span><span class="token punctuation">(</span>
                                callingUid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> mRequest<span class="token punctuation">.</span>filterCallingUid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                aInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> rInfo<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span>
                        null <span class="token comment" spellcheck="true">/*profilerInfo*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时，就能看到熟悉IIntentSender这个类。如果阅读过pendingIntent源码的朋友，就能知道pendingItent本质上IIntentSender就是这个类在延后操作。这里将不会铺开讲，之后会详细分析pendingIntent。这样就能附着一个intent等到Activity启动后在弹出一个弹窗Activity。</p>
<p>最后在根据这些数据生成一个新的ActivityRecord(这个ActivityRecord是目标对象的ActivityRecord)，并且把发起者的sourceRecord和当前的作为参数传入。正式开始操作ActivityStack。因此，我们可以知道Activity在AMS中将会对应一个ActivityRecord。</p>
<h3 id="小节"><a href="#小节" class="headerlink" title="小节"></a>小节</h3><p>本文就先分析到这里，稍后会重点分析ActvityStack在intent的各种startflag下的变化。</p>
<p>本文总结进程的缓存LRU算法，实际上就是分成三段进行管理，包含Activity，Service，两者不包含的。在通过ContentProvider以及Service绑定的远程端，再对两者可能链接到的进程进行管缓存理。因此我们可以清楚，在四大组件中只有Boardcast不会对进程LRU的优先进行影响。</p>
<p>不过请注意，四大组件都会Android系统中进程adj调度产生影响，两者不同。</p>
<p>于此同时通过Activitstarter.startActivity的方法为目标Activity准备好了ActivityRecord，目标对象是什么。接下来就是如何把这个ActivityRecord插入栈中。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/06/09/activity-de-qi-dong-liu-cheng-er/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="Android 重学系列 Activity的启动流程(二)">
                        
                        <span class="card-title">Android 重学系列 Activity的启动流程(二)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            正文如果遇到错误，请在本文指出：https://www.jianshu.com/p/4d34de4418e0
上篇，讲述的在正式启动前，做了权限判断，再准备ActivityRecord，本文将介绍在Activity启动中，Activity的
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-06-09
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-Framework/" class="post-category">
                                    Android Framework
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/06/04/eventbus-yuan-ma-qian-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="EventBus源码浅析">
                        
                        <span class="card-title">EventBus源码浅析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            背景如果遇到问题请在：https://www.jianshu.com/p/301edd6a2e61讨论EventBus使我们常用的第三方库之一。可以说大部分Android应用都在用这个库在做通信，当然也有人认为EventBus过于解耦导致其
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-06-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-常用第三方库/" class="post-category">
                                    Android 常用第三方库
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-常用第三方库/">
                        <span class="chip bg-color">Android 常用第三方库</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
