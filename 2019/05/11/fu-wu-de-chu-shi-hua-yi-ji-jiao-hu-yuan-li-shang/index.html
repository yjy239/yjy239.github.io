<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 Binder 服务的初始化以及交互原理(上), Android | Linux | Flutter">
    <meta name="description" content="前言经过前面三篇binder驱动的初始化阐述，我大致上稍微复习一边linux内核的基础知识，也对binder的理解更加深刻。接下来我们来看看binder 的服务是怎么注册到service_manager。如果遇到问题请到：https://w">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 Binder 服务的初始化以及交互原理(上) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 Binder 服务的初始化以及交互原理(上)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                            <a href="/tags/Linux-kernel/">
                                <span class="chip bg-color">Linux kernel</span>
                            </a>
                        
                            <a href="/tags/Binder/">
                                <span class="chip bg-color">Binder</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Binder/" class="post-category">
                                Binder
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-05-11
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        9.7k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        43 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>经过前面三篇binder驱动的初始化阐述，我大致上稍微复习一边linux内核的基础知识，也对binder的理解更加深刻。接下来我们来看看binder 的服务是怎么注册到service_manager。<br>如果遇到问题请到：<a href="https://www.jianshu.com/p/04e53fd86ca2" target="_blank" rel="noopener">https://www.jianshu.com/p/04e53fd86ca2</a></p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>很多文章一开始直接放出了binder在framework中类的之间的uml图。我先不放出，因为一开始就直接上这种图的确不怎么好理解。等我们探索完binder 服务初始化架构之后再放出来。</p>
<h2 id="ServiceManager-注册service"><a href="#ServiceManager-注册service" class="headerlink" title="ServiceManager 注册service"></a>ServiceManager 注册service</h2><p>还记得我之前写的SystemServiceManager那一章节。我稍微的提及到了服务的注册，但是我并没有深入源码。这一次我连同binder一起解析一次。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/java/com/android/server/SystemServer.java" target="_blank" rel="noopener">SystemServer.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"> wm <span class="token operator">=</span> WindowManagerService<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> inputManager<span class="token punctuation">,</span>
                    mFactoryTestMode <span class="token operator">!=</span> FactoryTest<span class="token punctuation">.</span>FACTORY_TEST_LOW_LEVEL<span class="token punctuation">,</span>
                    <span class="token operator">!</span>mFirstBoot<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PhoneWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>WINDOW_SERVICE<span class="token punctuation">,</span> wm<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* allowIsolated= */</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    DUMP_FLAG_PRIORITY_CRITICAL <span class="token operator">|</span> DUMP_FLAG_PROTO<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里为系统添加了windowManagerService的服务。这个服务Android应该十分熟悉，用来控制窗口的服务。我之后会专门取出一节来详细解析其中的代码。</p>
<p>让我们看看ServiceManager.addService方法。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/" target="_blank" rel="noopener">os</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/ServiceManager.java" target="_blank" rel="noopener">ServiceManager.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addService</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowIsolated<span class="token punctuation">,</span>
            <span class="token keyword">int</span> dumpPriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">getIServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> allowIsolated<span class="token punctuation">,</span> dumpPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"error in addService"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看这个代表着远程的异常，我们猜测这里是不是通过某种手段进行进程间通信，把IBinder添加到远程端中。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> IServiceManager <span class="token function">getIServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sServiceManager <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> sServiceManager<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Find the service manager</span>
        sServiceManager <span class="token operator">=</span> ServiceManagerNative
                <span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>Binder<span class="token punctuation">.</span><span class="token function">allowBlocking</span><span class="token punctuation">(</span>BinderInternal<span class="token punctuation">.</span><span class="token function">getContextObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sServiceManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先判断IServiceManager 这个接口对象是否存在。不存在则从从远程端获取这个实例。</p>
<p>妙啊妙，我在Binder第一节就探讨过进程间通信，无一不是通过两端通过协议进行交流，而在这里的IPC通行居然就能抽象着两个远程端直接继承一个接口，进行通信。但是还记得吗？进程之间的地址都有自己保护，我们不可能真的抽离一个接口让两个进程之间通信，只是在这个过程中把进程间通信透明化了。</p>
<p>这么棒的设计，让我们看看Google工程师是怎么设计的。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/" target="_blank" rel="noopener">os</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/ServiceManagerNative.java" target="_blank" rel="noopener">ServiceManagerNative.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">public</span> IServiceManager <span class="token function">asInterface</span><span class="token punctuation">(</span>IBinder obj<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        IServiceManager in <span class="token operator">=</span>
            <span class="token punctuation">(</span>IServiceManager<span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">queryLocalInterface</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> in<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServiceManagerProxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ProcessState-初始化"><a href="#ProcessState-初始化" class="headerlink" title="ProcessState 初始化"></a>ProcessState 初始化</h3><p>此时通过传入的IBinder查询IServiceManager这个接口对象。那么这个IBinder对象是怎么生成的？看看下面这个方法：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">native</span> IBinder <span class="token function">getContextObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个native方法究竟做了什么？</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jobject <span class="token function">android_os_BinderInternal_getContextObject</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> b <span class="token operator">=</span> ProcessState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getContextObject</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">javaObjectForIBinder</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里可以看到一个很关键的类。我们可以见到在Binder 服务中十分重要的一个类ProcessState。我们先看看这个类的self方法。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/" target="_blank" rel="noopener">binder</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/ProcessState.cpp" target="_blank" rel="noopener">ProcessState.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">sp<span class="token operator">&lt;</span>ProcessState<span class="token operator">></span> ProcessState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>gProcessMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gProcess <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> gProcess<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gProcess <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">ProcessState</span><span class="token punctuation">(</span><span class="token string">"/dev/binder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> gProcess<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这里我们可以的得知这是一个单例,如果在这个进程的ProcessState没有实例化则会实例化ProcessState。</p>
<p>接着我们看看这个构造函数。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">ProcessState<span class="token operator">::</span><span class="token function">ProcessState</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>driver<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">mDriverName</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//注意这里</span>
    <span class="token punctuation">,</span> <span class="token function">mDriverFD</span><span class="token punctuation">(</span><span class="token function">open_driver</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mVMStart</span><span class="token punctuation">(</span>MAP_FAILED<span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mThreadCountLock</span><span class="token punctuation">(</span>PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mThreadCountDecrement</span><span class="token punctuation">(</span>PTHREAD_COND_INITIALIZER<span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mExecutingThreadsCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mMaxThreads</span><span class="token punctuation">(</span>DEFAULT_MAX_BINDER_THREADS<span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mStarvationStartTimeMs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mManagesContexts</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mBinderContextCheckFunc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mBinderContextUserData</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mThreadPoolStarted</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mThreadPoolSeq</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDriverFD <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// mmap the binder, providing a chunk of virtual address space to receive transactions.</span>
        mVMStart <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> BINDER_VM_SIZE<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE <span class="token operator">|</span> MAP_NORESERVE<span class="token punctuation">,</span> mDriverFD<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mVMStart <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// *sigh*</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Using %s failed: unable to mmap transaction memory.\n"</span><span class="token punctuation">,</span> mDriverName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>mDriverFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mDriverFD <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            mDriverName<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>mDriverFD <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Binder driver could not be opened.  Terminating."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的操作和service_manager十分相似，先调用open打开binder驱动，再进行映射。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">open_driver</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>driver<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> vers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        status_t result <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> BINDER_VERSION<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Binder ioctl to obtain version failed: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> vers <span class="token operator">!=</span> BINDER_CURRENT_PROTOCOL_VERSION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Binder driver protocol(%d) does not match user space protocol(%d)! ioctl() return value: %d"</span><span class="token punctuation">,</span>
                vers<span class="token punctuation">,</span> BINDER_CURRENT_PROTOCOL_VERSION<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        size_t maxThreads <span class="token operator">=</span> DEFAULT_MAX_BINDER_THREADS<span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> BINDER_SET_MAX_THREADS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Binder ioctl to set max threads failed: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Opening '%s' failed: %s\n"</span><span class="token punctuation">,</span> driver<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的初始化和service_manager的初始化极其相似，首先写入Binder_Version,接着写入BINDER_SET_MAX_THREADS 设置最大线程数。</p>
<p>经过ProcessState构造函数之后，我们也把当前这个类已经映射到了binder驱动中。实际上这个类我在第一篇启动系统中已经惊鸿一现，系统启动的时候，zygote进程孵化的SystemServer进程也会映射到binder驱动中。</p>
<p>细节不继续赘述了，我们继续看看getContextObject。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> ProcessState<span class="token operator">::</span><span class="token function">getContextObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token comment" spellcheck="true">/*caller*/</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getStrongProxyForHandle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> ProcessState<span class="token operator">::</span><span class="token function">getStrongProxyForHandle</span><span class="token punctuation">(</span>int32_t handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> result<span class="token punctuation">;</span>

    AutoMutex <span class="token function">_l</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    handle_entry<span class="token operator">*</span> e <span class="token operator">=</span> <span class="token function">lookupHandleLocked</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We need to create a new BpBinder if there isn't currently one, OR we</span>
        <span class="token comment" spellcheck="true">// are unable to acquire a weak reference on this current one.  See comment</span>
        <span class="token comment" spellcheck="true">// in getWeakProxyForHandle() for more info about this.</span>
        IBinder<span class="token operator">*</span> b <span class="token operator">=</span> e<span class="token operator">-</span><span class="token operator">></span>binder<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token operator">!</span>e<span class="token operator">-</span><span class="token operator">></span>refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">attemptIncWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Parcel data<span class="token punctuation">;</span>
                status_t status <span class="token operator">=</span> IPCThreadState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">transact</span><span class="token punctuation">(</span>
                        <span class="token number">0</span><span class="token punctuation">,</span> IBinder<span class="token operator">::</span>PING_TRANSACTION<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> DEAD_OBJECT<span class="token punctuation">)</span>
                   <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            b <span class="token operator">=</span> BpBinder<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token operator">-</span><span class="token operator">></span>binder <span class="token operator">=</span> b<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> e<span class="token operator">-</span><span class="token operator">></span>refs <span class="token operator">=</span> b<span class="token operator">-</span><span class="token operator">></span><span class="token function">getWeakRefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> b<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// This little bit of nastyness is to allow us to add a primary</span>
            <span class="token comment" spellcheck="true">// reference to the remote proxy when this team doesn't have one</span>
            <span class="token comment" spellcheck="true">// but another team is sending the handle to us.</span>
            result<span class="token punctuation">.</span><span class="token function">force_set</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token operator">-</span><span class="token operator">></span>refs<span class="token operator">-</span><span class="token operator">></span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>lookupHandleLocked 就算是第一次来查找，控制引用的mHandleToObject的vector对象还是会自己添加一份进去。所以一般情况下不用担心找不到引用，至于为什么说是引用，放到之后再说。<br>因此，此时我们会走到b==null的分支当中，调用了BpBinder::create(handle)的方法生成一个远程端的binder代理对象。</p>
<h3 id="IPCThreadState-初始化"><a href="#IPCThreadState-初始化" class="headerlink" title="IPCThreadState 初始化"></a>IPCThreadState 初始化</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/" target="_blank" rel="noopener">binder</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/IPCThreadState.cpp" target="_blank" rel="noopener">IPCThreadState.cpp</a></p>
<p>此时handle为0，会走到下面的方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t status <span class="token operator">=</span> IPCThreadState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">transact</span><span class="token punctuation">(</span>
                        <span class="token number">0</span><span class="token punctuation">,</span> IBinder<span class="token operator">::</span>PING_TRANSACTION<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>此时出现了另一个十分关键的类IPCThreadState。看到这个调用，我们也可以知道这是一个单例设计。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">IPCThreadState<span class="token operator">*</span> IPCThreadState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gHaveTLS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
restart<span class="token operator">:</span>
        <span class="token keyword">const</span> pthread_key_t k <span class="token operator">=</span> gTLS<span class="token punctuation">;</span>
        IPCThreadState<span class="token operator">*</span> st <span class="token operator">=</span> <span class="token punctuation">(</span>IPCThreadState<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">pthread_getspecific</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">)</span> <span class="token keyword">return</span> st<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> IPCThreadState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>gShutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Calling IPCThreadState::self() during shutdown is dangerous, expect a crash.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gTLSMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gHaveTLS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> key_create_value <span class="token operator">=</span> <span class="token function">pthread_key_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gTLS<span class="token punctuation">,</span> threadDestructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key_create_value <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gTLSMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"IPCThreadState::self() unable to create TLS key, expect a crash: %s\n"</span><span class="token punctuation">,</span>
                    <span class="token function">strerror</span><span class="token punctuation">(</span>key_create_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        gHaveTLS <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gTLSMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> restart<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这这里可以清楚实际上，这个IPCThreadState的单例是做到线程单例。把IPCThreadState实例存储到线程的TLS中。这个做法实际上和Java的ThreadLocal思想相似，如果不熟悉pthread相关的操作，不妨可以代入思考。</p>
<h4 id="IPCThreadState-和binder驱动交互"><a href="#IPCThreadState-和binder驱动交互" class="headerlink" title="IPCThreadState 和binder驱动交互"></a>IPCThreadState 和binder驱动交互</h4><p>我们接下来看看transact方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t IPCThreadState<span class="token operator">::</span><span class="token function">transact</span><span class="token punctuation">(</span>int32_t handle<span class="token punctuation">,</span>
                                  uint32_t code<span class="token punctuation">,</span> <span class="token keyword">const</span> Parcel<span class="token operator">&amp;</span> data<span class="token punctuation">,</span>
                                  Parcel<span class="token operator">*</span> reply<span class="token punctuation">,</span> uint32_t flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    status_t err<span class="token punctuation">;</span>

    flags <span class="token operator">|</span><span class="token operator">=</span> TF_ACCEPT_FDS<span class="token punctuation">;</span>

    err <span class="token operator">=</span> <span class="token function">writeTransactionData</span><span class="token punctuation">(</span>BC_TRANSACTION<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> reply<span class="token operator">-</span><span class="token operator">></span><span class="token function">setError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>mLastError <span class="token operator">=</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// relayout</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            err <span class="token operator">=</span> <span class="token function">waitForResponse</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            Parcel fakeReply<span class="token punctuation">;</span>
            err <span class="token operator">=</span> <span class="token function">waitForResponse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fakeReply<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// relayout</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token function">waitForResponse</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这就是整个Binder server和client在framework层中向binder驱动传递数据最为核心的的机制。<br>这里我们分为两段来讨论。注意此时flags &amp; TF_ONE_WAY (0x10)将用来控制整个流程是否是等待远程端的回应标志位。此时flag为而0，因此会等待。当flag为1的时候则不等待。在这里的表现就是aidl中oneway开头的方法。</p>
<h4 id="writeTransactionData"><a href="#writeTransactionData" class="headerlink" title="writeTransactionData"></a>writeTransactionData</h4><pre class="line-numbers language-cpp"><code class="language-cpp">status_t IPCThreadState<span class="token operator">::</span><span class="token function">writeTransactionData</span><span class="token punctuation">(</span>int32_t cmd<span class="token punctuation">,</span> uint32_t binderFlags<span class="token punctuation">,</span>
    int32_t handle<span class="token punctuation">,</span> uint32_t code<span class="token punctuation">,</span> <span class="token keyword">const</span> Parcel<span class="token operator">&amp;</span> data<span class="token punctuation">,</span> status_t<span class="token operator">*</span> statusBuffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    binder_transaction_data tr<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//是这远程端的目标</span>
    tr<span class="token punctuation">.</span>target<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Don't pass uninitialized stack data to a remote process */</span>
    tr<span class="token punctuation">.</span>target<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
    tr<span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
    tr<span class="token punctuation">.</span>flags <span class="token operator">=</span> binderFlags<span class="token punctuation">;</span>
    tr<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tr<span class="token punctuation">.</span>sender_pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tr<span class="token punctuation">.</span>sender_euid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//设置通信的数据</span>
    <span class="token keyword">const</span> status_t err <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">errorCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tr<span class="token punctuation">.</span>data_size <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">ipcDataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">ipcData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">ipcObjectsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>binder_size_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">ipcObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statusBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tr<span class="token punctuation">.</span>flags <span class="token operator">|</span><span class="token operator">=</span> TF_STATUS_CODE<span class="token punctuation">;</span>
        <span class="token operator">*</span>statusBuffer <span class="token operator">=</span> err<span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>status_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>uintptr_t<span class="token operator">></span><span class="token punctuation">(</span>statusBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>mLastError <span class="token operator">=</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mOut<span class="token punctuation">.</span><span class="token function">writeInt32</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mOut<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里我们就能看到之前为什么binder_buffer中offset代表着元数据的偏移量以及data_size代表着有效数据的大小。其实是在Parcel中已经做好了管理了。在Parcel中mData对象代表着普通数据，而mObjects是一个偏移数组，它保存了在数据缓冲区mData中所有Binder对象的位置。Binder会通过这个对象来寻找Binder对象。</p>
<p>此时需要进去的数据是：</p>
<ul>
<li>cmd：BC_TRANSACTION</li>
<li>tr ： binder_transaction_data</li>
<li>code: IBinder::PING_TRANSACTION<br>BC_TRANSACTION 代表此时有个事务处理，binder_transaction_data代表事务数据。</li>
</ul>
<p>这里为mOut Parcel设置了第一段数据。</p>
<h4 id="waitForResponse-reply"><a href="#waitForResponse-reply" class="headerlink" title="waitForResponse(reply)"></a>waitForResponse(reply)</h4><p>我们接着看循环第二段。waitForResponse 这里把这个循环拆成两段。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t IPCThreadState<span class="token operator">::</span><span class="token function">waitForResponse</span><span class="token punctuation">(</span>Parcel <span class="token operator">*</span>reply<span class="token punctuation">,</span> status_t <span class="token operator">*</span>acquireResult<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    uint32_t cmd<span class="token punctuation">;</span>
    int32_t err<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token operator">=</span><span class="token function">talkWithDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> NO_ERROR<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        err <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">errorCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> NO_ERROR<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mIn<span class="token punctuation">.</span><span class="token function">dataAvail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="talkWithDriver"><a href="#talkWithDriver" class="headerlink" title="talkWithDriver"></a>talkWithDriver</h5><p>在这个循环里的talkWithDriver函数，看到名字就知道是和binder驱动进行沟通。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t IPCThreadState<span class="token operator">::</span><span class="token function">talkWithDriver</span><span class="token punctuation">(</span><span class="token keyword">bool</span> doReceive<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mProcess<span class="token operator">-</span><span class="token operator">></span>mDriverFD <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EBADF<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    binder_write_read bwr<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Is the read buffer empty?</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> needRead <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">dataPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> mIn<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// We don't want to write anything if we are still reading</span>
    <span class="token comment" spellcheck="true">// from data left in the input buffer and the caller</span>
    <span class="token comment" spellcheck="true">// has requested to read the next data.</span>
    <span class="token keyword">const</span> size_t outAvail <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>doReceive <span class="token operator">||</span> needRead<span class="token punctuation">)</span> <span class="token operator">?</span> mOut<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    bwr<span class="token punctuation">.</span>write_size <span class="token operator">=</span> outAvail<span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>mOut<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// This is what we'll read.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>doReceive <span class="token operator">&amp;&amp;</span> needRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">dataCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>mIn<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Return immediately if there is nothing to do.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>write_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>read_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>

    bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    status_t err<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined(__ANDROID__)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>mProcess<span class="token operator">-</span><span class="token operator">></span>mDriverFD<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            err <span class="token operator">=</span> NO_ERROR<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            err <span class="token operator">=</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
        err <span class="token operator">=</span> INVALID_OPERATION<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mProcess<span class="token operator">-</span><span class="token operator">></span>mDriverFD <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            err <span class="token operator">=</span> <span class="token operator">-</span>EBADF<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span>EINTR<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">>=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">&lt;</span> mOut<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                mOut<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>write_consumed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mOut<span class="token punctuation">.</span><span class="token function">setDataSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">processPostWriteDerefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mIn<span class="token punctuation">.</span><span class="token function">setDataSize</span><span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mIn<span class="token punctuation">.</span><span class="token function">setDataPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里我们又看到了binder_write_read这个结构体。<br>这个结构体的读取部分设置了Parcel全局对象mIn，写入部分设置Parcel全局对象mOut。当童星结束之后将会清空全局的Parcel变量mOut以及mIn中的写入/读取标记位置。</p>
<h4 id="binder-transaction"><a href="#binder-transaction" class="headerlink" title="binder_transaction"></a>binder_transaction</h4><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/binder.c" target="_blank" rel="noopener">binder.c</a></p>
<p>binder_transaction 虽然之前已经提过，但是这个方法过于长，这里我们继续只关注我们需要的。<br>此时我们通过ioctl通信到Binder驱动中。我们这边直接进入binder驱动的对应方法看看。<br>方法 binder_thread_write.</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">case</span> BC_TRANSACTION<span class="token operator">:</span>
        <span class="token keyword">case</span> BC_REPLY<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> binder_transaction_data tr<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
            ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">binder_transaction</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> cmd <span class="token operator">==</span> BC_REPLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时cmd是BC_TRANSACTION而不是BC_REPLY</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_transaction</span><span class="token punctuation">(</span><span class="token keyword">struct</span> binder_proc <span class="token operator">*</span>proc<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> binder_thread <span class="token operator">*</span>thread<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> binder_transaction_data <span class="token operator">*</span>tr<span class="token punctuation">,</span> <span class="token keyword">int</span> reply<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> binder_transaction <span class="token operator">*</span>t<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> binder_work <span class="token operator">*</span>tcomplete<span class="token punctuation">;</span>
    binder_size_t <span class="token operator">*</span>offp<span class="token punctuation">,</span> <span class="token operator">*</span>off_end<span class="token punctuation">;</span>
    binder_size_t off_min<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> binder_proc <span class="token operator">*</span>target_proc<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> binder_thread <span class="token operator">*</span>target_thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> binder_node <span class="token operator">*</span>target_node <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> list_head <span class="token operator">*</span>target_list<span class="token punctuation">;</span>
    wait_queue_head_t <span class="token operator">*</span>target_wait<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> binder_transaction <span class="token operator">*</span>in_reply_to <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> binder_transaction_log_entry <span class="token operator">*</span>e<span class="token punctuation">;</span>
    uint32_t return_error<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true">//1.通过handle查找对应的binder引用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tr<span class="token operator">-</span><span class="token operator">></span>target<span class="token punctuation">.</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            target_node <span class="token operator">=</span> binder_context_mgr_node<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>target_node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                return_error <span class="token operator">=</span> BR_DEAD_REPLY<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> err_no_context_mgr_node<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        e<span class="token operator">-</span><span class="token operator">></span>to_node <span class="token operator">=</span> target_node<span class="token operator">-</span><span class="token operator">></span>debug_id<span class="token punctuation">;</span>
        target_proc <span class="token operator">=</span> target_node<span class="token operator">-</span><span class="token operator">></span>proc<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true">//寻找事务依赖</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>tr<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> thread<span class="token operator">-</span><span class="token operator">></span>transaction_stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> binder_transaction <span class="token operator">*</span>tmp<span class="token punctuation">;</span>

            tmp <span class="token operator">=</span> thread<span class="token operator">-</span><span class="token operator">></span>transaction_stack<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-</span><span class="token operator">></span>to_thread <span class="token operator">!=</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got new transaction with bad transaction stack, transaction %d has target %d:%d\n"</span><span class="token punctuation">,</span>
                    proc<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span> thread<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span> tmp<span class="token operator">-</span><span class="token operator">></span>debug_id<span class="token punctuation">,</span>
                    tmp<span class="token operator">-</span><span class="token operator">></span>to_proc <span class="token operator">?</span> tmp<span class="token operator">-</span><span class="token operator">></span>to_proc<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    tmp<span class="token operator">-</span><span class="token operator">></span>to_thread <span class="token operator">?</span>
                    tmp<span class="token operator">-</span><span class="token operator">></span>to_thread<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> err_bad_call_stack<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-</span><span class="token operator">></span>from <span class="token operator">&amp;&amp;</span> tmp<span class="token operator">-</span><span class="token operator">></span>from<span class="token operator">-</span><span class="token operator">></span>proc <span class="token operator">==</span> target_proc<span class="token punctuation">)</span>
                    target_thread <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">></span>from<span class="token punctuation">;</span>
                tmp <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">></span>from_parent<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//2.设置当前的目标等待队列以及目标todo 队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target_thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token operator">-</span><span class="token operator">></span>to_thread <span class="token operator">=</span> target_thread<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">;</span>
        target_list <span class="token operator">=</span> <span class="token operator">&amp;</span>target_thread<span class="token operator">-</span><span class="token operator">></span>todo<span class="token punctuation">;</span>
        target_wait <span class="token operator">=</span> <span class="token operator">&amp;</span>target_thread<span class="token operator">-</span><span class="token operator">></span>wait<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        target_list <span class="token operator">=</span> <span class="token operator">&amp;</span>target_proc<span class="token operator">-</span><span class="token operator">></span>todo<span class="token punctuation">;</span>
        target_wait <span class="token operator">=</span> <span class="token operator">&amp;</span>target_proc<span class="token operator">-</span><span class="token operator">></span>wait<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    e<span class="token operator">-</span><span class="token operator">></span>to_proc <span class="token operator">=</span> target_proc<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//申请binder_transaction</span>
    <span class="token comment" spellcheck="true">/* TODO: reuse incoming transaction for reply */</span>
    t <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err_alloc_t_failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">binder_stats_created</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//申请binder_work</span>
    tcomplete <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>tcomplete<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tcomplete <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err_alloc_tcomplete_failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">binder_stats_created</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION_COMPLETE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>tr<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span>
        t<span class="token operator">-</span><span class="token operator">></span>from <span class="token operator">=</span> thread<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        t<span class="token operator">-</span><span class="token operator">></span>from <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    t<span class="token operator">-</span><span class="token operator">></span>sender_euid <span class="token operator">=</span> <span class="token function">task_euid</span><span class="token punctuation">(</span>proc<span class="token operator">-</span><span class="token operator">></span>tsk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token operator">-</span><span class="token operator">></span>to_proc <span class="token operator">=</span> target_proc<span class="token punctuation">;</span>
    t<span class="token operator">-</span><span class="token operator">></span>to_thread <span class="token operator">=</span> target_thread<span class="token punctuation">;</span>
    t<span class="token operator">-</span><span class="token operator">></span>code <span class="token operator">=</span> tr<span class="token operator">-</span><span class="token operator">></span>code<span class="token punctuation">;</span>
    t<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">=</span> tr<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">;</span>
    t<span class="token operator">-</span><span class="token operator">></span>priority <span class="token operator">=</span> <span class="token function">task_nice</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">trace_binder_transaction</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> t<span class="token punctuation">,</span> target_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//为事务分配一个binder_buffer</span>
    t<span class="token operator">-</span><span class="token operator">></span>buffer <span class="token operator">=</span> <span class="token function">binder_alloc_buf</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> tr<span class="token operator">-</span><span class="token operator">></span>data_size<span class="token punctuation">,</span>
        tr<span class="token operator">-</span><span class="token operator">></span>offsets_size<span class="token punctuation">,</span> <span class="token operator">!</span>reply <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err_binder_alloc_buf_failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>allow_user_free <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>debug_id <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>debug_id<span class="token punctuation">;</span>
    t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>transaction <span class="token operator">=</span> t<span class="token punctuation">;</span>
    t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>target_node <span class="token operator">=</span> target_node<span class="token punctuation">;</span>
    <span class="token function">trace_binder_transaction_alloc_buf</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target_node<span class="token punctuation">)</span>
        <span class="token function">binder_inc_node</span><span class="token punctuation">(</span>target_node<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    offp <span class="token operator">=</span> <span class="token punctuation">(</span>binder_size_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>data <span class="token operator">+</span>
                 <span class="token function">ALIGN</span><span class="token punctuation">(</span>tr<span class="token operator">-</span><span class="token operator">></span>data_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//拷贝</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>
               tr<span class="token operator">-</span><span class="token operator">></span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> tr<span class="token operator">-</span><span class="token operator">></span>data_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>offp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>
               tr<span class="token operator">-</span><span class="token operator">></span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">,</span> tr<span class="token operator">-</span><span class="token operator">></span>offsets_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里分为以下几步来说明：</p>
<ul>
<li><p>1.通过handle查找对应的binder引用。在这里我们的cmd是BC_TRANSCATION。因此会直接拿binder_context_mgr_node。而这个就是我在上一篇说过的service_manager的binder实体。此时我们也相当于拿到了service_manager进程映射的地址了。</p>
</li>
<li><p>2.找到我们需要的binder实体之后，我们看看该进程的binder_thread对应的事务栈transaction_stack。我们需要通过这个栈去寻找，当前分发下来的事务是否有依赖其他事务。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">          <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-</span><span class="token operator">></span>from <span class="token operator">&amp;&amp;</span> tmp<span class="token operator">-</span><span class="token operator">></span>from<span class="token operator">-</span><span class="token operator">></span>proc <span class="token operator">==</span> target_proc<span class="token punctuation">)</span>
                  target_thread <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">></span>from<span class="token punctuation">;</span>
              tmp <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">></span>from_parent<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>因此，binder驱动会通过一个循环，直接从栈顶开始查找依赖的事务的线程(binder_transaction-&gt;from)。会去查找依赖的事务所对应的binder_proc是不是当前的目标进程。是则说明有线程也在使用这个目标进程，我们需要把把这个binder_thread取出来，先把依赖的事务给处理了。</p>
<ul>
<li><p>3.判断此时有没有找到目标的binder_thread。找到则设置目标binder_thread的todo list和等待队列。不然则是binder_proc的todo list和等待队列。</p>
</li>
<li><p>4.申请内存 t 和 tcomplete 事务对象binder_transaction，工作项 binder_work。并且把相关的数据如目标进程，目标binder_thread，code，flag等写入binder_transaction。并且通过binder_alloc_buf 为这一次事务在目标进程中申请一段binder_buffer（内核缓冲区）.</p>
</li>
<li><p>5.通过copy_from_user把binder中普通数据拷贝到binder_transaction_data的data中，元数据拷贝到offsets中。</p>
</li>
</ul>
<p>为了弄清楚这一点，我们看看binder_transaction_data数据结构</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> binder_transaction_data <span class="token punctuation">{</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//引用</span>
    __u32 handle<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//对应用户空间binder_transaction_data 的ptr</span>
    binder_uintptr_t ptr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> target<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//对应用户空间binder_transaction_data的cookie</span>
  binder_uintptr_t cookie<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//对应用户空间binder_transaction_data的code</span>
  __u32 code<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//对应用户空间binder_transaction_data的flags</span>
  __u32 flags<span class="token punctuation">;</span>
  pid_t sender_pid<span class="token punctuation">;</span>
  uid_t sender_euid<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//数据大小</span>
  binder_size_t data_size<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//偏移量大小</span>
  binder_size_t offsets_size<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//元数据</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//binder_buffer</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      binder_uintptr_t buffer<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//binder数组</span>
      binder_uintptr_t offsets<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> ptr<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//数据</span>
    __u8 buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时拷贝tr-&gt;data.ptr.buffer到了binder_transaction的内核缓冲区的数据区。tr-&gt;data.ptr.offsets拷贝到offp 地址中。而这个offp地址是这么计算的</p>
<blockquote>
<p>offp = (binder_size_t *)(t-&gt;buffer-&gt;data + ALIGN(tr-&gt;data_size, sizeof(void *)));<br>这么计算的结果是把binder_transaction的binder_buffer的末尾地址计算出来，相当于定位了mData中Binder偏移数组的起始位置。</p>
</blockquote>
<pre class="line-numbers language-cpp"><code class="language-cpp">    off_end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>offp <span class="token operator">+</span> tr<span class="token operator">-</span><span class="token operator">></span>offsets_size<span class="token punctuation">;</span>
    off_min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> offp <span class="token operator">&lt;</span> off_end<span class="token punctuation">;</span> offp<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> flat_binder_object <span class="token operator">*</span>fp<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true">//获取flat_binder_object 结构体</span>
        fp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> flat_binder_object <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>data <span class="token operator">+</span> <span class="token operator">*</span>offp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        off_min <span class="token operator">=</span> <span class="token operator">*</span>offp <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> flat_binder_object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>fp<span class="token operator">-</span><span class="token operator">></span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//处理flat_binder_object 中type为 BINDER_TYPE_BINDER BINDER_TYPE_WEAK_BINDER</span>
        <span class="token keyword">case</span> BINDER_TYPE_BINDER<span class="token operator">:</span>
        <span class="token keyword">case</span> BINDER_TYPE_WEAK_BINDER<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> binder_ref <span class="token operator">*</span>ref<span class="token punctuation">;</span>
            <span class="token keyword">struct</span> binder_node <span class="token operator">*</span>node <span class="token operator">=</span> <span class="token function">binder_get_node</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> fp<span class="token operator">-</span><span class="token operator">></span>binder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//生成一个新的binder对象</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                node <span class="token operator">=</span> <span class="token function">binder_new_node</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> fp<span class="token operator">-</span><span class="token operator">></span>binder<span class="token punctuation">,</span> fp<span class="token operator">-</span><span class="token operator">></span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> err_binder_new_node_failed<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                node<span class="token operator">-</span><span class="token operator">></span>min_priority <span class="token operator">=</span> fp<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> FLAT_BINDER_FLAG_PRIORITY_MASK<span class="token punctuation">;</span>
                node<span class="token operator">-</span><span class="token operator">></span>accept_fds <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>fp<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> FLAT_BINDER_FLAG_ACCEPTS_FDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//cookie中保存着本地binder对象</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-</span><span class="token operator">></span>cookie <span class="token operator">!=</span> node<span class="token operator">-</span><span class="token operator">></span>cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d sending u%016llx node %d, cookie mismatch %016llx != %016llx\n"</span><span class="token punctuation">,</span>
                    proc<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span> thread<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>fp<span class="token operator">-</span><span class="token operator">></span>binder<span class="token punctuation">,</span> node<span class="token operator">-</span><span class="token operator">></span>debug_id<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>fp<span class="token operator">-</span><span class="token operator">></span>cookie<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>node<span class="token operator">-</span><span class="token operator">></span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
                return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> err_binder_get_ref_for_node_failed<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">security_binder_transfer_binder</span><span class="token punctuation">(</span>proc<span class="token operator">-</span><span class="token operator">></span>tsk<span class="token punctuation">,</span> target_proc<span class="token operator">-</span><span class="token operator">></span>tsk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> err_binder_get_ref_for_node_failed<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//为binder对象添加引用</span>
            ref <span class="token operator">=</span> <span class="token function">binder_get_ref_for_node</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> err_binder_get_ref_for_node_failed<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//判断是不是弱引用的binder type</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">==</span> BINDER_TYPE_BINDER<span class="token punctuation">)</span>
                fp<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">=</span> BINDER_TYPE_HANDLE<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                fp<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">=</span> BINDER_TYPE_WEAK_HANDLE<span class="token punctuation">;</span>
            fp<span class="token operator">-</span><span class="token operator">></span>handle <span class="token operator">=</span> ref<span class="token operator">-</span><span class="token operator">></span>desc<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//找到对应的binder 引用并且增加</span>
            <span class="token function">binder_inc_ref</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> fp<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">==</span> BINDER_TYPE_HANDLE<span class="token punctuation">,</span>
                       <span class="token operator">&amp;</span>thread<span class="token operator">-</span><span class="token operator">></span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">trace_binder_transaction_node_to_ref</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION<span class="token punctuation">,</span>
                     <span class="token string">"        node %d u%016llx -> ref %d desc %d\n"</span><span class="token punctuation">,</span>
                     node<span class="token operator">-</span><span class="token operator">></span>debug_id<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>node<span class="token operator">-</span><span class="token operator">></span>ptr<span class="token punctuation">,</span>
                     ref<span class="token operator">-</span><span class="token operator">></span>debug_id<span class="token punctuation">,</span> ref<span class="token operator">-</span><span class="token operator">></span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//处理flat_binder_object 中type为 BINDER_TYPE_HANDLE BINDER_TYPE_WEAK_HANDLE</span>
        <span class="token keyword">case</span> BINDER_TYPE_HANDLE<span class="token operator">:</span>
        <span class="token keyword">case</span> BINDER_TYPE_WEAK_HANDLE<span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//获取binder 引用</span>
            <span class="token keyword">struct</span> binder_ref <span class="token operator">*</span>ref <span class="token operator">=</span> <span class="token function">binder_get_ref</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> fp<span class="token operator">-</span><span class="token operator">></span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with invalid handle, %d\n"</span><span class="token punctuation">,</span>
                        proc<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span>
                        thread<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span> fp<span class="token operator">-</span><span class="token operator">></span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> err_binder_get_ref_failed<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">security_binder_transfer_binder</span><span class="token punctuation">(</span>proc<span class="token operator">-</span><span class="token operator">></span>tsk<span class="token punctuation">,</span> target_proc<span class="token operator">-</span><span class="token operator">></span>tsk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> err_binder_get_ref_failed<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//如果引用对象刚好是目标进程，转化为Binder 本地</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token operator">-</span><span class="token operator">></span>node<span class="token operator">-</span><span class="token operator">></span>proc <span class="token operator">==</span> target_proc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">==</span> BINDER_TYPE_HANDLE<span class="token punctuation">)</span>
                    fp<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">=</span> BINDER_TYPE_BINDER<span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    fp<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">=</span> BINDER_TYPE_WEAK_BINDER<span class="token punctuation">;</span>
                fp<span class="token operator">-</span><span class="token operator">></span>binder <span class="token operator">=</span> ref<span class="token operator">-</span><span class="token operator">></span>node<span class="token operator">-</span><span class="token operator">></span>ptr<span class="token punctuation">;</span>
                fp<span class="token operator">-</span><span class="token operator">></span>cookie <span class="token operator">=</span> ref<span class="token operator">-</span><span class="token operator">></span>node<span class="token operator">-</span><span class="token operator">></span>cookie<span class="token punctuation">;</span>
                <span class="token function">binder_inc_node</span><span class="token punctuation">(</span>ref<span class="token operator">-</span><span class="token operator">></span>node<span class="token punctuation">,</span> fp<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">==</span> BINDER_TYPE_BINDER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">trace_binder_transaction_ref_to_node</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION<span class="token punctuation">,</span>
                         <span class="token string">"        ref %d desc %d -> node %d u%016llx\n"</span><span class="token punctuation">,</span>
                         ref<span class="token operator">-</span><span class="token operator">></span>debug_id<span class="token punctuation">,</span> ref<span class="token operator">-</span><span class="token operator">></span>desc<span class="token punctuation">,</span> ref<span class="token operator">-</span><span class="token operator">></span>node<span class="token operator">-</span><span class="token operator">></span>debug_id<span class="token punctuation">,</span>
                         <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>ref<span class="token operator">-</span><span class="token operator">></span>node<span class="token operator">-</span><span class="token operator">></span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> binder_ref <span class="token operator">*</span>new_ref<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//不是则获取目标进程中的引用</span>
                new_ref <span class="token operator">=</span> <span class="token function">binder_get_ref_for_node</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> ref<span class="token operator">-</span><span class="token operator">></span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>new_ref <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> err_binder_get_ref_for_node_failed<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                fp<span class="token operator">-</span><span class="token operator">></span>handle <span class="token operator">=</span> new_ref<span class="token operator">-</span><span class="token operator">></span>desc<span class="token punctuation">;</span>
                <span class="token function">binder_inc_ref</span><span class="token punctuation">(</span>new_ref<span class="token punctuation">,</span> fp<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">==</span> BINDER_TYPE_HANDLE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">trace_binder_transaction_ref_to_ref</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ref<span class="token punctuation">,</span>
                                    new_ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION<span class="token punctuation">,</span>
                         <span class="token string">"        ref %d desc %d -> ref %d desc %d (node %d)\n"</span><span class="token punctuation">,</span>
                         ref<span class="token operator">-</span><span class="token operator">></span>debug_id<span class="token punctuation">,</span> ref<span class="token operator">-</span><span class="token operator">></span>desc<span class="token punctuation">,</span> new_ref<span class="token operator">-</span><span class="token operator">></span>debug_id<span class="token punctuation">,</span>
                         new_ref<span class="token operator">-</span><span class="token operator">></span>desc<span class="token punctuation">,</span> ref<span class="token operator">-</span><span class="token operator">></span>node<span class="token operator">-</span><span class="token operator">></span>debug_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//透传文件</span>
        <span class="token keyword">case</span> BINDER_TYPE_FD<span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with invalid object type, %x\n"</span><span class="token punctuation">,</span>
                proc<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span> thread<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span> fp<span class="token operator">-</span><span class="token operator">></span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> err_bad_object_type<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>async_transaction <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">binder_pop_transaction</span><span class="token punctuation">(</span>target_thread<span class="token punctuation">,</span> in_reply_to<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>async_transaction <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token operator">-</span><span class="token operator">></span>need_reply <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        t<span class="token operator">-</span><span class="token operator">></span>from_parent <span class="token operator">=</span> thread<span class="token operator">-</span><span class="token operator">></span>transaction_stack<span class="token punctuation">;</span>
        thread<span class="token operator">-</span><span class="token operator">></span>transaction_stack <span class="token operator">=</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span>target_node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>async_transaction <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target_node<span class="token operator">-</span><span class="token operator">></span>has_async_transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            target_list <span class="token operator">=</span> <span class="token operator">&amp;</span>target_node<span class="token operator">-</span><span class="token operator">></span>async_todo<span class="token punctuation">;</span>
            target_wait <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            target_node<span class="token operator">-</span><span class="token operator">></span>has_async_transaction <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//切换工作状态，添加到目标进程的工作队列</span>
    t<span class="token operator">-</span><span class="token operator">></span>work<span class="token punctuation">.</span>type <span class="token operator">=</span> BINDER_WORK_TRANSACTION<span class="token punctuation">;</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token operator">-</span><span class="token operator">></span>work<span class="token punctuation">.</span>entry<span class="token punctuation">,</span> target_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tcomplete<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">=</span> BINDER_WORK_TRANSACTION_COMPLETE<span class="token punctuation">;</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tcomplete<span class="token operator">-</span><span class="token operator">></span>entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thread<span class="token operator">-</span><span class="token operator">></span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target_wait<span class="token punctuation">)</span>
        <span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span>target_wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="增加引用计数"><a href="#增加引用计数" class="headerlink" title="增加引用计数"></a>增加引用计数</h4><p>在这个循环中有一个关键的结构体,flat_binder_object </p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> flat_binder_object <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* 8 bytes for large_flat_header. */</span>
    __u32        type<span class="token punctuation">;</span>
    __u32        flags<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* 8 bytes of data. */</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        binder_uintptr_t    binder<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* local object */</span>
        __u32            handle<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* remote object */</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* extra data associated with local object */</span>
    binder_uintptr_t    cookie<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而这个flat_binder_object 在Parcel中也有一个一模一样的数据结构，这个结构体实际上就是Binder偏移数组中的数据。很有意思，当我们尝试着写内核和用户空间交互数据的时候，我们往往可以在两侧构造一样的的数据结构再进行copy。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">fp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> flat_binder_object <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>data <span class="token operator">+</span> <span class="token operator">*</span>offp<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>但是这是怎么回事?为什么这样子能够强转flat_binder_object对象。这个东西我研究了老半天？<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/" target="_blank" rel="noopener">binder</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/Parcel.cpp" target="_blank" rel="noopener">Parcel.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t Parcel<span class="token operator">::</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> flat_binder_object<span class="token operator">&amp;</span> val<span class="token punctuation">,</span> <span class="token keyword">bool</span> nullMetaData<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> enoughData <span class="token operator">=</span> <span class="token punctuation">(</span>mDataPos<span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> mDataCapacity<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> enoughObjects <span class="token operator">=</span> mObjectsSize <span class="token operator">&lt;</span> mObjectsCapacity<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enoughData <span class="token operator">&amp;&amp;</span> enoughObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
restart_write<span class="token operator">:</span>
        <span class="token operator">*</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>flat_binder_object<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>mData<span class="token operator">+</span>mDataPos<span class="token punctuation">)</span> <span class="token operator">=</span> val<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>原来如此，这里提前说一下，Binder经常借助Parcel传递消息，而Binder的传递恰好就是调用这个方法。而在framework层换算flat_binder_object对象，也是通过普通数据+偏移量转型为flat_binder_object并且赋值。实际上这里的内核算法只是和用户空间的算法保持一致。</p>
<p>在这个循环中，主要处理了三种flat_binder_object 对应的5种type。首先看看flat_binder_object 是怎么获得的。这些type</p>
<ul>
<li><p>1.BINDER_TYPE_BINDER/BINDER_TYPE_WEAK_BINDER<br>该标志位是在Parcel中设置，判断如果是本地binder对象则，加入此标志位。此时binder驱动接受到之后，说明此时是本地端发起的交互，因此此时需要获取目标进程的引用，并且增加引用计数，同时把状态转化为BINDER_TYPE_HANDLE / BINDER_TYPE_WEAK_HANDLE。</p>
</li>
<li><p>2.BINDER_TYPE_HANDLE / BINDER_TYPE_WEAK_HANDLE<br>该标志位也是在Parcel中设置。判断到此时不是binder本地而是远程端，则会加入此标记。当binder驱动接受到，说明此时是远程端发起的交互。需要通过handle获取本地端的引用。当handle获取到的引用刚好事目标进程，则把标志位设置为BINDER_TYPE_BINDER/BINDER_TYPE_WEAK_BINDER 。不是则直接从目标进程查找引用。</p>
</li>
<li><p>3.BINDER_TYPE_FD<br>该标志控制着一个文件描述符，并且读写进数据，做跨进程的数据透传。</p>
</li>
</ul>
<h5 id="细节：binder-ref的处理"><a href="#细节：binder-ref的处理" class="headerlink" title="细节：binder_ref的处理"></a>细节：binder_ref的处理</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> binder_ref <span class="token operator">*</span><span class="token function">binder_get_ref_for_node</span><span class="token punctuation">(</span><span class="token keyword">struct</span> binder_proc <span class="token operator">*</span>proc<span class="token punctuation">,</span>
                          <span class="token keyword">struct</span> binder_node <span class="token operator">*</span>node<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> rb_node <span class="token operator">*</span>n<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rb_node <span class="token operator">*</span><span class="token operator">*</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>proc<span class="token operator">-</span><span class="token operator">></span>refs_by_node<span class="token punctuation">.</span>rb_node<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rb_node <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> binder_ref <span class="token operator">*</span>ref<span class="token punctuation">,</span> <span class="token operator">*</span>new_ref<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//从binder_proc中寻找合适ref</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
        ref <span class="token operator">=</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token keyword">struct</span> binder_ref<span class="token punctuation">,</span> rb_node_node<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">&lt;</span> ref<span class="token operator">-</span><span class="token operator">></span>node<span class="token punctuation">)</span>
            p <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>rb_left<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">></span> ref<span class="token operator">-</span><span class="token operator">></span>node<span class="token punctuation">)</span>
            p <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>rb_right<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> ref<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//没找到则新建一个</span>
    new_ref <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ref<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>new_ref <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">binder_stats_created</span><span class="token punctuation">(</span>BINDER_STAT_REF<span class="token punctuation">)</span><span class="token punctuation">;</span>
    new_ref<span class="token operator">-</span><span class="token operator">></span>debug_id <span class="token operator">=</span> <span class="token operator">++</span>binder_last_id<span class="token punctuation">;</span>
    new_ref<span class="token operator">-</span><span class="token operator">></span>proc <span class="token operator">=</span> proc<span class="token punctuation">;</span>
    new_ref<span class="token operator">-</span><span class="token operator">></span>node <span class="token operator">=</span> node<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//把binder实体添加到binder_proc的rb_node_node</span>
    <span class="token function">rb_link_node</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_ref<span class="token operator">-</span><span class="token operator">></span>rb_node_node<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rb_insert_color</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_ref<span class="token operator">-</span><span class="token operator">></span>rb_node_node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>proc<span class="token operator">-</span><span class="token operator">></span>refs_by_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//处理binder_proc中所有的引用描述（句柄）</span>
    new_ref<span class="token operator">-</span><span class="token operator">></span>desc <span class="token operator">=</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> binder_context_mgr_node<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">rb_first</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-</span><span class="token operator">></span>refs_by_desc<span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> n <span class="token operator">=</span> <span class="token function">rb_next</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ref <span class="token operator">=</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token keyword">struct</span> binder_ref<span class="token punctuation">,</span> rb_node_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token operator">-</span><span class="token operator">></span>desc <span class="token operator">></span> new_ref<span class="token operator">-</span><span class="token operator">></span>desc<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        new_ref<span class="token operator">-</span><span class="token operator">></span>desc <span class="token operator">=</span> ref<span class="token operator">-</span><span class="token operator">></span>desc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//把引用添加到rb_node_desc</span>
    p <span class="token operator">=</span> <span class="token operator">&amp;</span>proc<span class="token operator">-</span><span class="token operator">></span>refs_by_desc<span class="token punctuation">.</span>rb_node<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
        ref <span class="token operator">=</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token keyword">struct</span> binder_ref<span class="token punctuation">,</span> rb_node_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>new_ref<span class="token operator">-</span><span class="token operator">></span>desc <span class="token operator">&lt;</span> ref<span class="token operator">-</span><span class="token operator">></span>desc<span class="token punctuation">)</span>
            p <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>rb_left<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>new_ref<span class="token operator">-</span><span class="token operator">></span>desc <span class="token operator">></span> ref<span class="token operator">-</span><span class="token operator">></span>desc<span class="token punctuation">)</span>
            p <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>rb_right<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">BUG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">rb_link_node</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_ref<span class="token operator">-</span><span class="token operator">></span>rb_node_desc<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rb_insert_color</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_ref<span class="token operator">-</span><span class="token operator">></span>rb_node_desc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>proc<span class="token operator">-</span><span class="token operator">></span>refs_by_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> new_ref<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>做的事情分为以下几个步骤：</p>
<ul>
<li>1.从refs_by_node红黑树查找查找，当前的node是否有binder的引用，因为此时要做的行为是要把binder往对端的用户空间传递。此时不可能做到把binder实体交给另外的进程，因此会传递一个引用。</li>
</ul>
<ul>
<li>2.没有找到binder引用说明此时这个binder是新加入的，需要需要把当前生成的新的binder_node(binder实体)添加到binder_proc的refs_by_node。</li>
</ul>
<ul>
<li><p>3.把当前的binder_ref的描述设置为1（如果当前的binder的实体是service_manager则设置为0）。循环后面的引用描述(句柄)，当遇到引用(句柄)比当前新的大则跳出，否则则新的引用是老引用+1.实际上就是就是调整整个算法。因为在整个过程是获取refs_by_desc第二个管理binder引用的红黑树（一个以引用描述为key的）的后继，比较句柄大小，找到当前最大的那个往后加1。这个break的存在就是为了对付加入一直加的普通的binder对象，突然添加了service_manager的对象，此时我们必须要保证这个binder引用描述为0才设计。</p>
</li>
<li><p>4.把引用以desc 为key添加到refs_by_desc中。这个红黑树更加重要，因为我们在上层的handle就是对应这个描述符，通过这个描述符去查找对应的引用，从而传输binder对象引用。</p>
</li>
</ul>
<p>对于binder来说，是不会直接使用binder实体类，因为binder实体里包含这个其他进程的地址，会导致无法访问的情况。因此，需要一层binder引用包裹。</p>
<h4 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h4><p>为什么要做这一步？对于智能指针来讲，每一次减少意味这个这个binder引用可能有被析构的可能，反过来当我们不需要这个引用的时候，我们也可以把这个计数减少的步骤向后挪移也没问题。所以对于这种情况来说，我们在离开本次作用域之前需，把需要传递的binder引用对象新增加一个引用计数，来防止其被析构。<br>更为关键的的是，在Parcel读取的时候，会通过这个type,BINDER_TYPE_BINDER转型为BBinder(代表本地端对象),还是BINDER_TYPE_HANDLE转型为BpBinder（代表远程端对象）。</p>
<h4 id="唤醒目标进程"><a href="#唤醒目标进程" class="headerlink" title="唤醒目标进程"></a>唤醒目标进程</h4><pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>async_transaction <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">binder_pop_transaction</span><span class="token punctuation">(</span>target_thread<span class="token punctuation">,</span> in_reply_to<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>async_transaction <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token operator">-</span><span class="token operator">></span>need_reply <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        t<span class="token operator">-</span><span class="token operator">></span>from_parent <span class="token operator">=</span> thread<span class="token operator">-</span><span class="token operator">></span>transaction_stack<span class="token punctuation">;</span>
        thread<span class="token operator">-</span><span class="token operator">></span>transaction_stack <span class="token operator">=</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span>target_node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>async_transaction <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target_node<span class="token operator">-</span><span class="token operator">></span>has_async_transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            target_list <span class="token operator">=</span> <span class="token operator">&amp;</span>target_node<span class="token operator">-</span><span class="token operator">></span>async_todo<span class="token punctuation">;</span>
            target_wait <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            target_node<span class="token operator">-</span><span class="token operator">></span>has_async_transaction <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//切换工作状态，添加到目标进程的工作队列</span>
    t<span class="token operator">-</span><span class="token operator">></span>work<span class="token punctuation">.</span>type <span class="token operator">=</span> BINDER_WORK_TRANSACTION<span class="token punctuation">;</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token operator">-</span><span class="token operator">></span>work<span class="token punctuation">.</span>entry<span class="token punctuation">,</span> target_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tcomplete<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">=</span> BINDER_WORK_TRANSACTION_COMPLETE<span class="token punctuation">;</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tcomplete<span class="token operator">-</span><span class="token operator">></span>entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thread<span class="token operator">-</span><span class="token operator">></span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target_wait<span class="token punctuation">)</span>
        <span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span>target_wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一段是判断当前是否是BC_REPLY,这里先不去研究。当时t-&gt;flags &amp; TF_ONE_WAY为0的时候，则设置当前的binder_transaction的need_reply为1，设置依赖事务为当前的binder_thread的transaction_stack。不然则是选择todo list为目标binder实体的异步队列。</p>
<p>最后把工作加入到目标工作(todo)队列。最后调用wake_up_interruptible唤醒目标进程。tcomplete添加到当前线程的todo中。</p>
<h4 id="回到当前场景"><a href="#回到当前场景" class="headerlink" title="回到当前场景"></a>回到当前场景</h4><p>当前场景，我们发送了的mOut中实际上没有设置任何的data数据。因此在整个binder_transaction（事务交易）中，循环offsets的那部分直接跳过，将会直接寻找目标对象，设置好目标binder_thread以及工作队列还有等待队列。事务项的type设置为BINDER_WORK_TRANSACTION。tcomplete设置BINDER_WORK_TRANSACTION_COMPLETE。</p>
<p>还记得，此时我们唤醒的target_wait是谁吗？就是指service_manager。此时service_manager在binder_thread_read方法被阻塞了。我们看看binder_thread_read方法吧。唤醒的同时，ServiceManager调用者本身的进程也在继续进行。我们在这里记住，我们继续回去看看IPCThreadState的waitForResponse方法。实际上这是两个进程同时进行的事务工作。</p>
<h4 id="ServiceManager调用者进程的talkWithDriver的情景分析"><a href="#ServiceManager调用者进程的talkWithDriver的情景分析" class="headerlink" title="ServiceManager调用者进程的talkWithDriver的情景分析"></a>ServiceManager调用者进程的talkWithDriver的情景分析</h4><p>还记得吗。此时talkwithDriver的doneed默认为true，因此会走binder_thread_read的阻塞。等待service_manager的binder_thread_read的返回。</p>
<h3 id="service-manager的binder-thread-read"><a href="#service-manager的binder-thread-read" class="headerlink" title="service_manager的binder_thread_read"></a>service_manager的binder_thread_read</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uint32_t cmd<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> binder_transaction_data tr<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> binder_work <span class="token operator">*</span>w<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> binder_transaction <span class="token operator">*</span>t <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 获取todo列表的首部</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token operator">-</span><span class="token operator">></span>todo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            w <span class="token operator">=</span> <span class="token function">list_first_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token operator">-</span><span class="token operator">></span>todo<span class="token punctuation">,</span> <span class="token keyword">struct</span> binder_work<span class="token punctuation">,</span>
                         entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-</span><span class="token operator">></span>todo<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> wait_for_proc_work<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            w <span class="token operator">=</span> <span class="token function">list_first_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-</span><span class="token operator">></span>todo<span class="token punctuation">,</span> <span class="token keyword">struct</span> binder_work<span class="token punctuation">,</span>
                         entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/* no data added */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">-</span> buffer <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span><span class="token punctuation">(</span>thread<span class="token operator">-</span><span class="token operator">></span>looper <span class="token operator">&amp;</span> BINDER_LOOPER_STATE_NEED_RETURN<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> retry<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> ptr <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//判断当前工作项的type</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>w<span class="token operator">-</span><span class="token operator">></span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> BINDER_WORK_TRANSACTION<span class="token operator">:</span> <span class="token punctuation">{</span>
            t <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token keyword">struct</span> binder_transaction<span class="token punctuation">,</span> work<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//如果对应的目标node不为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>target_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> binder_node <span class="token operator">*</span>target_node <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>target_node<span class="token punctuation">;</span>

            tr<span class="token punctuation">.</span>target<span class="token punctuation">.</span>ptr <span class="token operator">=</span> target_node<span class="token operator">-</span><span class="token operator">></span>ptr<span class="token punctuation">;</span>
            tr<span class="token punctuation">.</span>cookie <span class="token operator">=</span>  target_node<span class="token operator">-</span><span class="token operator">></span>cookie<span class="token punctuation">;</span>
            t<span class="token operator">-</span><span class="token operator">></span>saved_priority <span class="token operator">=</span> <span class="token function">task_nice</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>priority <span class="token operator">&lt;</span> target_node<span class="token operator">-</span><span class="token operator">></span>min_priority <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">binder_set_nice</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token operator">||</span>
                 t<span class="token operator">-</span><span class="token operator">></span>saved_priority <span class="token operator">></span> target_node<span class="token operator">-</span><span class="token operator">></span>min_priority<span class="token punctuation">)</span>
                <span class="token function">binder_set_nice</span><span class="token punctuation">(</span>target_node<span class="token operator">-</span><span class="token operator">></span>min_priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cmd <span class="token operator">=</span> BR_TRANSACTION<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//为空，则设置cmd为BR_REPLY</span>
            tr<span class="token punctuation">.</span>target<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            tr<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            cmd <span class="token operator">=</span> BR_REPLY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        tr<span class="token punctuation">.</span>code <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>code<span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>flags <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>sender_euid <span class="token operator">=</span> <span class="token function">from_kuid</span><span class="token punctuation">(</span><span class="token function">current_user_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token operator">-</span><span class="token operator">></span>sender_euid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//设置pid</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> task_struct <span class="token operator">*</span>sender <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>from<span class="token operator">-</span><span class="token operator">></span>proc<span class="token operator">-</span><span class="token operator">></span>tsk<span class="token punctuation">;</span>

            tr<span class="token punctuation">.</span>sender_pid <span class="token operator">=</span> <span class="token function">task_tgid_nr_ns</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span>
                            <span class="token function">task_active_pid_ns</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            tr<span class="token punctuation">.</span>sender_pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//设置参数</span>
        tr<span class="token punctuation">.</span>data_size <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>data_size<span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>offsets_size<span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span>binder_uintptr_t<span class="token punctuation">)</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>data <span class="token operator">+</span>
                    proc<span class="token operator">-</span><span class="token operator">></span>user_buffer_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">+</span>
                    <span class="token function">ALIGN</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>data_size<span class="token punctuation">,</span>
                        <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//拷贝数据到用户空间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">put_user</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint32_t __user <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
        ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
        ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">trace_binder_transaction_received</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">binder_stat_br</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token operator">-</span><span class="token operator">></span>work<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>allow_user_free <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> BR_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            t<span class="token operator">-</span><span class="token operator">></span>to_parent <span class="token operator">=</span> thread<span class="token operator">-</span><span class="token operator">></span>transaction_stack<span class="token punctuation">;</span>
            t<span class="token operator">-</span><span class="token operator">></span>to_thread <span class="token operator">=</span> thread<span class="token punctuation">;</span>
            thread<span class="token operator">-</span><span class="token operator">></span>transaction_stack <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>transaction <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token function">kfree</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">binder_stats_deleted</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当ServiceManager对应的进程唤醒当前service_manager的时候，函数将会继续往下走，此时就会进入到这个循环。</p>
<ul>
<li><p>1.可以看到的是，此时会从service_manager进程中获取出todo列表的头部，优先获取binder_thread的todo双向队列。这样就能拿到我们就能拿到从ServiceManager加入进去的工作项。<br>如果binder_thread没有则去binder_proc中获取。如果都是空，但是判断后面的data数据区域还有位置(地址差为4和前文为binder_buffer划分的时候呼应)，则说明此时没有数据，就没有必要去读取从新进入阻塞。</p>
</li>
<li><p>2.此时再去解析命令，转化命令从BC的驱动命令转化RR的framework命令。此时刚好是BINDER_WORK_TRANSACTION，我们就取出里面的binder_work的binder_transaction 事务项t。注意，当t为空的时候会while向后获取命令，执行命令，直到达到了底部。底部的判断就是binder_buffer申请时候的上一个和下一个的binder_buffer差值为4.</p>
</li>
<li><p>3.如果此时该事务项中的目标进程不为空，则把命令转化为BR_TRANSACTION，并且把里面的数据赋值到binder_transaction_data中。</p>
</li>
<li><p>4.光这些不够，我们还需要把数据从内核空间往用户空间拷贝。也就是使用put_user和copy_to_user方法。由于此时正还是BR_TRANSACTION，所以把目标线程和目标对象设置为当前线程。以此来宣告此时此时处理在事务的是当前进程。</p>
</li>
</ul>
<h4 id="回到service-manager的binder-parse"><a href="#回到service-manager的binder-parse" class="headerlink" title="回到service_manager的binder_parse"></a>回到service_manager的binder_parse</h4><p>binder_thread_read  方法返回到用户空间。此时进入的binder_parse是用于解析从驱动传递上来的BR命令的解析。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/cmds/" target="_blank" rel="noopener">cmds</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/cmds/servicemanager/" target="_blank" rel="noopener">servicemanager</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/cmds/servicemanager/binder.c" target="_blank" rel="noopener">binder.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span><span class="token keyword">struct</span> binder_state <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token keyword">struct</span> binder_io <span class="token operator">*</span>bio<span class="token punctuation">,</span>
                 uintptr_t ptr<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> binder_handler func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    uintptr_t end <span class="token operator">=</span> ptr <span class="token operator">+</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span> size<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>ptr <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uint32_t cmd <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
        ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> TRACE</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"%s:\n"</span><span class="token punctuation">,</span> <span class="token function">cmd_name</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> BR_NOOP<span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> BR_TRANSACTION_COMPLETE<span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> BR_INCREFS<span class="token operator">:</span>
        <span class="token keyword">case</span> BR_ACQUIRE<span class="token operator">:</span>
        <span class="token keyword">case</span> BR_RELEASE<span class="token operator">:</span>
        <span class="token keyword">case</span> BR_DECREFS<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> BR_TRANSACTION<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> binder_transaction_data <span class="token operator">*</span>txn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> binder_transaction_data <span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">unsigned</span> rdata<span class="token punctuation">[</span><span class="token number">256</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">struct</span> binder_io msg<span class="token punctuation">;</span>
                <span class="token keyword">struct</span> binder_io reply<span class="token punctuation">;</span>
                <span class="token keyword">int</span> res<span class="token punctuation">;</span>

                <span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> rdata<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rdata<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">bio_init_from_txn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                res <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> txn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">binder_free_buffer</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> txn<span class="token operator">-</span><span class="token operator">></span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">binder_send_reply</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> txn<span class="token operator">-</span><span class="token operator">></span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> BR_REPLY<span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> BR_DEAD_BINDER<span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> BR_FAILED_REPLY<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> BR_DEAD_REPLY<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"parse: OOPS %d\n"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时传到service_manager已经转化为BR_TRANSACTION命令。在这个分支中出现了全新的一种结构体</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> binder_io
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/* pointer to read/write from */</span>
    binder_size_t <span class="token operator">*</span>offs<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* array of offsets */</span>
    size_t data_avail<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">/* bytes available in data buffer */</span>
    size_t offs_avail<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">/* entries available in offsets array */</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>data0<span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">/* start of data buffer */</span>
    binder_size_t <span class="token operator">*</span>offs0<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* start of offsets buffer */</span>
    uint32_t flags<span class="token punctuation">;</span>
    uint32_t unused<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个结构体从名字上可以看得出实际上指代的是一个binder_buffer在ioctl交互时候调用的对象.分为两个区域，四个地址。两个区域分别是binder_buffer的元数据以及有效数据去。并且0为结尾的字段就是指的是元数据以及有效数据区的起始地址。得知这些之后，我们尝试阅读其源码。因此在bio_init中初始化reply,bio_init_from_txn 把从内核中传递上来的数据拷贝的到reply中。</p>
<p>而func是从binder_loop传递下来的方法指针是指方法svcmgr_handler，这个方法负责从驱动从底层转化的code命令的执行。<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/cmds/" target="_blank" rel="noopener">cmds</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/cmds/servicemanager/" target="_blank" rel="noopener">servicemanager</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/cmds/servicemanager/service_manager.c" target="_blank" rel="noopener">service_manager.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">svcmgr_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> binder_state <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> binder_transaction_data <span class="token operator">*</span>txn<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> binder_io <span class="token operator">*</span>msg<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> binder_io <span class="token operator">*</span>reply<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> svcinfo <span class="token operator">*</span>si<span class="token punctuation">;</span>
    uint16_t <span class="token operator">*</span>s<span class="token punctuation">;</span>
    size_t len<span class="token punctuation">;</span>
    uint32_t handle<span class="token punctuation">;</span>
    uint32_t strict_policy<span class="token punctuation">;</span>
    <span class="token keyword">int</span> allow_isolated<span class="token punctuation">;</span>
    uint32_t dumpsys_priority<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//ALOGI("target=%p code=%d pid=%d uid=%d\n",</span>
    <span class="token comment" spellcheck="true">//      (void*) txn->target.ptr, txn->code, txn->sender_pid, txn->sender_euid);</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-</span><span class="token operator">></span>target<span class="token punctuation">.</span>ptr <span class="token operator">!=</span> BINDER_SERVICE_MANAGER<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-</span><span class="token operator">></span>code <span class="token operator">==</span> PING_TRANSACTION<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>txn<span class="token operator">-</span><span class="token operator">></span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>还记得我再一开始要注意到传递下来的code的吗？此时code:PING_TRANSACTION，此时我们不需要任何的处理。因为此时，第一次的transact行为用tcp里面的术语来说，只是为了ping通service_manager确定Android服务系统的核心是否被正确初始化。</p>
</blockquote>
<p>此时(txn-&gt;flags &amp; TF_ONE_WAY）的结果为0.我们直接看看此时service_manager reply了什么命令回去。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">binder_send_reply</span><span class="token punctuation">(</span><span class="token keyword">struct</span> binder_state <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                       <span class="token keyword">struct</span> binder_io <span class="token operator">*</span>reply<span class="token punctuation">,</span>
                       binder_uintptr_t buffer_to_free<span class="token punctuation">,</span>
                       <span class="token keyword">int</span> status<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        uint32_t cmd_free<span class="token punctuation">;</span>
        binder_uintptr_t buffer<span class="token punctuation">;</span>
        uint32_t cmd_reply<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> binder_transaction_data txn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>

    data<span class="token punctuation">.</span>cmd_free <span class="token operator">=</span> BC_FREE_BUFFER<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>buffer <span class="token operator">=</span> buffer_to_free<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>cmd_reply <span class="token operator">=</span> BC_REPLY<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>target<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data_size <span class="token operator">=</span> reply<span class="token operator">-</span><span class="token operator">></span>data <span class="token operator">-</span> reply<span class="token operator">-</span><span class="token operator">></span>data0<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> reply<span class="token operator">-</span><span class="token operator">></span>offs<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> reply<span class="token operator">-</span><span class="token operator">></span>offs0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>reply<span class="token operator">-</span><span class="token operator">></span>data0<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>reply<span class="token operator">-</span><span class="token operator">></span>offs0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">binder_write</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时我们能看到的是，此时定义了一个新的结构体。该结构体相当于之前的2个binder_read_write结构体。不同的是，第一段的标志位是BC_FREE_BUFFER，数据是之前通过binder_alloc_buf切割下来的结构体地址。第二段是BC_REPLY，后面binder_transaction_data 是需要返回的数据，如binder对象或者引用之类的。此时并有任何数据。接下来将进入binder驱动中</p>
<h4 id="binder-驱动处理service-manager返回的数据"><a href="#binder-驱动处理service-manager返回的数据" class="headerlink" title="binder 驱动处理service_manager返回的数据"></a>binder 驱动处理service_manager返回的数据</h4><p>此时的流程和之前的binder_thread_write的解析十分相似，所以这里我只点出不一样的逻辑看看里面做了什么事情.首先是第一段返回的命令是BC_FREE_BUFFER;</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">case</span> BC_FREE_BUFFER<span class="token operator">:</span> <span class="token punctuation">{</span>
            binder_uintptr_t data_ptr<span class="token punctuation">;</span>
            <span class="token keyword">struct</span> binder_buffer <span class="token operator">*</span>buffer<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_user</span><span class="token punctuation">(</span>data_ptr<span class="token punctuation">,</span> <span class="token punctuation">(</span>binder_uintptr_t __user <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
            ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>binder_uintptr_t<span class="token punctuation">)</span><span class="token punctuation">;</span>

            buffer <span class="token operator">=</span> <span class="token function">binder_buffer_lookup</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> data_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token operator">-</span><span class="token operator">></span>transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                buffer<span class="token operator">-</span><span class="token operator">></span>transaction<span class="token operator">-</span><span class="token operator">></span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                buffer<span class="token operator">-</span><span class="token operator">></span>transaction <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token operator">-</span><span class="token operator">></span>async_transaction <span class="token operator">&amp;&amp;</span> buffer<span class="token operator">-</span><span class="token operator">></span>target_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-</span><span class="token operator">></span>target_node<span class="token operator">-</span><span class="token operator">></span>async_todo<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    buffer<span class="token operator">-</span><span class="token operator">></span>target_node<span class="token operator">-</span><span class="token operator">></span>has_async_transaction <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    <span class="token function">list_move_tail</span><span class="token punctuation">(</span>buffer<span class="token operator">-</span><span class="token operator">></span>target_node<span class="token operator">-</span><span class="token operator">></span>async_todo<span class="token punctuation">.</span>next<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thread<span class="token operator">-</span><span class="token operator">></span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">binder_transaction_buffer_release</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">binder_free_buf</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时我能够发现到此时释放当前的使用的binder_buffer实际上就是把数据清空后，使用内核缓冲区，再回归到空闲内核缓冲区，并且减少对应binder对象的引用计数。</p>
<p>第二段下传下来的数据的命令是BC_REPLY，此时把需要返回的数据添加到事务栈中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        in_reply_to <span class="token operator">=</span> thread<span class="token operator">-</span><span class="token operator">></span>transaction_stack<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">binder_set_nice</span><span class="token punctuation">(</span>in_reply_to<span class="token operator">-</span><span class="token operator">></span>saved_priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        thread<span class="token operator">-</span><span class="token operator">></span>transaction_stack <span class="token operator">=</span> in_reply_to<span class="token operator">-</span><span class="token operator">></span>to_parent<span class="token punctuation">;</span>
        target_thread <span class="token operator">=</span> in_reply_to<span class="token operator">-</span><span class="token operator">></span>from<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target_thread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            return_error <span class="token operator">=</span> BR_DEAD_REPLY<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> err_dead_binder<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        target_proc <span class="token operator">=</span> target_thread<span class="token operator">-</span><span class="token operator">></span>proc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>tr<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">else</span>
        t<span class="token operator">-</span><span class="token operator">></span>from <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">binder_pop_transaction</span><span class="token punctuation">(</span>target_thread<span class="token punctuation">,</span> in_reply_to<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target_node<span class="token operator">-</span><span class="token operator">></span>has_async_transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            target_list <span class="token operator">=</span> <span class="token operator">&amp;</span>target_node<span class="token operator">-</span><span class="token operator">></span>async_todo<span class="token punctuation">;</span>
            target_wait <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>缩减下来就是这么点逻辑。这里需要和上面BC_TRANSACTION解析的binder_transaction进行联动。还记得在上方，结束BC_TRANSACTION命令时候的添加的行为不？</p>
<ul>
<li>1.从当前的事务栈拿出来的事务项，就是从之前ServiceManager调用者进程中的生成加在transaction_stack的顶部。</li>
<li>2.此时，我们能够这个事务项获取到目标进程的对象binder_proc。下面的逻辑就就和上面一样，不一样的地方仅仅只是调用的方向逆转过来。</li>
<li>3.binder_pop_transaction 最后再把这个从之前进程挪移来的事务弹出，并且释放内存。</li>
<li>4.最后再添加一个事务工作(binder_transaction)type为BINDER_WORK_TRANSACTION,一个事务工作(binder_work)为BINDER_WORK_TRANSACTION_COMPLETE.唤醒ServiceManager调用者进程。</li>
</ul>
<p>此时两个进程如上方一样同时进行，service_manager将会直接进入binder_thread_read阻塞休眠。</p>
<h4 id="ServiceManager调用者进程的唤醒"><a href="#ServiceManager调用者进程的唤醒" class="headerlink" title="ServiceManager调用者进程的唤醒"></a>ServiceManager调用者进程的唤醒</h4><p>当ServiceManager调用进程复苏之后，将会进入到binder_thread_read的cmd解析循环中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">        <span class="token keyword">case</span> BINDER_WORK_TRANSACTION<span class="token operator">:</span> <span class="token punctuation">{</span>
            t <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token keyword">struct</span> binder_transaction<span class="token punctuation">,</span> work<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> BINDER_WORK_TRANSACTION_COMPLETE<span class="token operator">:</span> <span class="token punctuation">{</span>
            cmd <span class="token operator">=</span> BR_TRANSACTION_COMPLETE<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">put_user</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint32_t __user <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
            ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">binder_stat_br</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION_COMPLETE<span class="token punctuation">,</span>
                     <span class="token string">"%d:%d BR_TRANSACTION_COMPLETE\n"</span><span class="token punctuation">,</span>
                     proc<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span> thread<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token operator">-</span><span class="token operator">></span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">kfree</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">binder_stats_deleted</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION_COMPLETE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>target_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            tr<span class="token punctuation">.</span>target<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            tr<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            cmd <span class="token operator">=</span> BR_REPLY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还记得吗？此时我们在第一次调用BC_TRANSACTION的时候会生成一个BINDER_WORK_TRANSACTION_COMPLETE添加到本进程线程对应的事务栈中，在BC_REPLY的时候又添加了BINDER_WORK_TRANSACTION事务栈。</p>
<p>因此此时做的事情很简单，就是通过循环执行这两个事务。并且回收掉之前binder_work的申请的内存。此时做的事情就是为了告诉binder驱动binder服务已经响应回原来的进程了。</p>
<p>此时你可以看到当service_manager写入BC_REPLY的时候，对应的binder_transaction的reply参数不为0，此时并不设置target_node，因此在这里读取的时候，会把cmd从驱动命令换成framework命令。传回上层。</p>
<p>此时read已经结束.总结一下我们能够发现的时候，在binder驱动中以BINDER开头的命令将会在binder_thread_read中处理，以BC开头的命令会在binder_thread_write中处理，RR开头的命令将会在service_manager/IPCThreadState中处理。</p>
<h4 id="ServiceManager进程调用waitForResponse第二段"><a href="#ServiceManager进程调用waitForResponse第二段" class="headerlink" title="ServiceManager进程调用waitForResponse第二段"></a>ServiceManager进程调用waitForResponse第二段</h4><p>此时binder驱动已经完成了所有事务，让我们回到顶层吧。<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/" target="_blank" rel="noopener">binder</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/IPCThreadState.cpp" target="_blank" rel="noopener">IPCThreadState.cpp</a><br>waitForResponse的命令解析：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">  <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> BR_TRANSACTION_COMPLETE<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> BR_DEAD_REPLY<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> BR_FAILED_REPLY<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> BR_ACQUIRE_RESULT<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> BR_REPLY<span class="token operator">:</span>
            <span class="token punctuation">{</span>
                binder_transaction_data tr<span class="token punctuation">;</span>
                err <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">ALOG_ASSERT</span><span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">,</span> <span class="token string">"Not enough command data for brREPLY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> TF_STATUS_CODE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        reply<span class="token operator">-</span><span class="token operator">></span><span class="token function">ipcSetDataReference</span><span class="token punctuation">(</span>
                            <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> uint8_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            tr<span class="token punctuation">.</span>data_size<span class="token punctuation">,</span>
                            <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> binder_size_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            tr<span class="token punctuation">.</span>offsets_size<span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>binder_size_t<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            freeBuffer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        err <span class="token operator">=</span> <span class="token operator">*</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> status_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">freeBuffer</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>
                            <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> uint8_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            tr<span class="token punctuation">.</span>data_size<span class="token punctuation">,</span>
                            <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> binder_size_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            tr<span class="token punctuation">.</span>offsets_size<span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>binder_size_t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">freeBuffer</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>
                        <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> uint8_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        tr<span class="token punctuation">.</span>data_size<span class="token punctuation">,</span>
                        <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> binder_size_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        tr<span class="token punctuation">.</span>offsets_size<span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>binder_size_t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>

        <span class="token keyword">default</span><span class="token operator">:</span>
            err <span class="token operator">=</span> <span class="token function">executeCommand</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时reply不为空并且(tr.flags &amp; TF_STATUS_CODE)结果为0.此时把Parcel reply字段封装从驱动穿上来的数据。此时我们略过中间的步骤，看到service_manager进程中实际上设置binder数据的时候，实际上因为判断到是PING的命令，已经返回了。此时并没有任何数据在Parcel里面。</p>
<h4 id="回到ProcessState"><a href="#回到ProcessState" class="headerlink" title="回到ProcessState"></a>回到ProcessState</h4><p>由于嵌套过深，为了避免逻辑断链，我实际上一直在研究这部分代码:</p>
<pre><code>status_t status = IPCThreadState::self()-&gt;transact(
                        0, IBinder::PING_TRANSACTION, data, NULL, 0);</code></pre><p>此时,我们可以得到一个结论，当发送code的时候，控制的是service_manager那一块的逻辑。而PING_TRANSACTION什么事情都没做，仅仅只是为了ping 通service_manager进程。但是在这个流程中我们却摸透整个binder在传输时候的设计模型。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>整个Android的service Binder架构嵌套十分的深，涉及面十分广。因此本文就停笔总结，让我们归纳一遍Android系统中的Binder事务流程。</p>
<p>经过这一次，我们能够绘制出比上一篇更加详细的binder传输数据的封包，当顶层往下层传输命令时候<br><img src="/images/binder%E4%BC%A0%E8%BE%93%E6%95%B0%E6%8D%AE%E7%9A%84%E5%B0%81%E5%8C%85.png" alt="binder传输数据的封包.png"></p>
<p>特别的，在Android整个协议中BC开头的命令时用来控制binder驱动写的行为，BINDER开头的命令用来控制binder驱动读时候的行为，BR开头的命令用来控制路由器接受端和发送端的解析行为，这里是指service_manager和IPCThreadState。中间的code控制service_manager和IPCThreadState的具体动作行为。</p>
<p>再来总结一份Binder传输时候的时序图<br><img src="/images/binder%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92%E6%97%B6%E5%BA%8F%E5%9B%BE.png" alt="binder数据交互时序图.png"></p>
<p>注意这里红色代表着跨越了进程。</p>
<p>光是时序图还是没办法看到细节，进一步的整个进程间通信模型<br>我们把模型分为三部分去看，第一部分是从ServiceManager的调用端发送数据，service_manager进程获取数据。<br><img src="/images/%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE.png" alt="发送数据.png"></p>
<p>第二部分是返回消息在清除binder_transaction_stack之前：<br><img src="/images/%E8%BF%94%E5%9B%9E%E6%B6%88%E6%81%AF%E5%9C%A8%E6%B8%85%E9%99%A4binder_transaction_stack.png" alt="返回消息在清除binder_transaction_stack.png"></p>
<p>第三部分：<br><img src="/images/binder%E4%BC%A0%E8%BE%93%E5%8E%9F%E7%90%86.png" alt="binder传输原理.png"></p>
<p>这只是大致的原理图，实际上binder_transaction存在的意义就是为了查找依赖栈，以及当每一次加入一个新的事务时候，把当前要处理的事务放在栈顶。当需要恢复回复信息的时候，以此为依据来找到原来发送端。上面那个看起来像是栈，实际上只是一个todo链表。</p>
<p>以上就是整个Binder在进程间通信的流程。这里就是它巧妙的地方，通过两个不同进程的事务栈在传递事务，从而达到数据传递的过程。同时通过tcomplete来结束读取的行为。而上面留下的tcomplete将会在下次读取数据的数据删除。这就是我在上面说的，引用删除可以留到下次读取删除，但是添加引用计数必须立即添加，不然会被智能指针析构掉同一道理。</p>
<h3 id="Binder传输过程中，内存拷贝次数"><a href="#Binder传输过程中，内存拷贝次数" class="headerlink" title="Binder传输过程中，内存拷贝次数"></a>Binder传输过程中，内存拷贝次数</h3><p>最后再来计算一次，在整个通信过程中，一共做了几次虚拟内存中的数据拷贝，一次完整的通信过程中必定包含本地端的写入以及远程端的读取，都是在binder_ioctl_write_read方法中进行数据的拷贝，一共12次：</p>
<ul>
<li>第一次：本地端写入数据到内核，远程端写回数据进行应答：</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> ubuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>第二次远程端读取数据处理，本地段读取远程端写回的数据：</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里加起来就有四次。</p>
<ul>
<li>第三次，第四次，第五次：方法binder_thread_write，执行binder_transaction准备写入到事务队列中，读取写入到数据中的binder_transaction_data结构体进行一次拷贝，再对binder_transaction_data中中的元数据大小和偏移量大小数据进行拷贝，最后再转移到目标进程binder缓冲区事务队列：<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>t<span class="token operator">-</span><span class="token operator">></span>buffer<span class="token operator">-</span><span class="token operator">></span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>
tr<span class="token operator">-</span><span class="token operator">></span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> tr<span class="token operator">-</span><span class="token operator">></span>data_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>offp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>
tr<span class="token operator">-</span><span class="token operator">></span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">,</span> tr<span class="token operator">-</span><span class="token operator">></span>offsets_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>第六次：方法binder_thread_read中解析事务队列中的内容，拷贝到远程端：<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>这是一次写入读取，最后远程端一般还有再做一次应答，因此是这个步骤加起来就有8次.</p>
<p>那么一来一回一共就是12次。但是有趣的是，整个过程中binder的进程对应的内核缓冲区都是通过mmap映射到物理页，实际上，这仅仅只是一次从本地物理页直接拷贝到远端物理页的过程。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/05/11/fu-wu-de-chu-shi-hua-yi-ji-jiao-hu-yuan-li-xia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Android 重学系列 Binder 服务的初始化以及交互原理(下)">
                        
                        <span class="card-title">Android 重学系列 Binder 服务的初始化以及交互原理(下)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            如果遇到问题请到：https://www.jianshu.com/p/84b18387992f
背景为了避免逻辑断链，这里稍微提及一下，之前所阅读到的位置
  IBinder* b = e->binder;
        if (b ==
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-05-11
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Binder/" class="post-category">
                                    Binder
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                    <a href="/tags/Linux-kernel/">
                        <span class="chip bg-color">Linux kernel</span>
                    </a>
                    
                    <a href="/tags/Binder/">
                        <span class="chip bg-color">Binder</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/05/03/binder-de-looper-chu-shi-hua/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Android 重学系列 Binder驱动初始化 Binder的Looper初始化(三)">
                        
                        <span class="card-title">Android 重学系列 Binder驱动初始化 Binder的Looper初始化(三)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            如果遇到问题请到：https://www.jianshu.com/p/2ab3aaf2aeb6
ServiceMananger 的初始化第二步 把进程对象注册到Binder驱动中文件：/frameworks/native/cmds/serv
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-05-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Binder/" class="post-category">
                                    Binder
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                    <a href="/tags/Linux-kernel/">
                        <span class="chip bg-color">Linux kernel</span>
                    </a>
                    
                    <a href="/tags/Binder/">
                        <span class="chip bg-color">Binder</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
