<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="OpenCV(二)掩码操作与平滑(均值,高斯模糊), Android | Linux | Flutter">
    <meta name="description" content="前言OpenCV知识总结来到了下一个难度高一点的，掩码操作和模糊效果，这是图像处理里面常见的操作。如果遇到问题请在这里联系我：https://www.jianshu.com/p/67324fb69074
正文掩码操作实际上思想上很简单：根据">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>OpenCV(二)掩码操作与平滑(均值,高斯模糊) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/19.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        OpenCV(二)掩码操作与平滑(均值,高斯模糊)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/音视频/">
                                <span class="chip bg-color">音视频</span>
                            </a>
                        
                            <a href="/tags/OpenCV/">
                                <span class="chip bg-color">OpenCV</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/OpenCV/" class="post-category">
                                OpenCV
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-08-06
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        8.2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        37 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>OpenCV知识总结来到了下一个难度高一点的，掩码操作和模糊效果，这是图像处理里面常见的操作。<br>如果遇到问题请在这里联系我：<a href="https://www.jianshu.com/p/67324fb69074" target="_blank" rel="noopener">https://www.jianshu.com/p/67324fb69074</a></p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>掩码操作实际上思想上很简单：根据一个掩码矩阵(卷积核)重新计算图像中的每一个像素。掩码矩阵中的值表示近邻像素的值(包括自身像素的值)对新像素的值有多大的影响，从数学上观点看来，就是对掩码矩阵内每一个设置好权重，然后对对应的像素领域内做一个权加平均。</p>
<h2 id="数学上解释"><a href="#数学上解释" class="headerlink" title="数学上解释"></a>数学上解释</h2><p>卷积是什么？用一个简单的公式来表示：</p>
<pre><code>输出 = 输入 * 系统</code></pre><p>本质上，卷积就是这种思想。卷积把万事万物看成一个输入，当万事万物的状态出现了变化，则会通过某种系统产生变化，变成另一种输出状态。而这个系统往往就在数学眼里就叫做卷积。</p>
<p>而在深度学习中，往往每一个卷积核是一个奇数的矩阵，做图像识别的时候会通过这个卷积核做一次过滤，筛选出必要的特征信息。</p>
<p>那么掩码操作在数学上是怎么回事？我们平常运用掩码做什么？在OpenCV中掩码最常见的操作就是增加图片对比度。对比度的概念是什么，在上一节聊过，通俗来讲就是能够增强像素之间的细节。我们可以对对每个像素做如下操作：<br><img src="/images/%E6%8E%A9%E7%A0%81%E7%AE%97%E6%B3%95.png" alt="掩码算法.png"></p>
<p>可能这幅图，理解起来比较困难。实际上流程如此：<br><img src="/images/%E5%8D%B7%E7%A7%AF%E7%AE%97%E6%B3%95.png" alt="卷积算法.png"></p>
<p>举个例子，就以计算出掩码矩阵之后的E的位置，能看到此时是原图中所有的像素都会取出和掩码矩阵一样大小的矩阵。也就是取出原图的红色那一块的领域，分别对E周边包括自己做了一次加权处理，最后赋值回E中。</p>
<p>并且进行如下的权加公式：</p>
<div>$F_{掩码矩阵之后的像素} = F_{原图像素} * 5 + A * 0 + -1 * B + 0 * C + -1 * E + -1 * G + I*0 + J*-1+K*0$</div>

<p>这样就能对原来的矩阵进行掩码处理。但是这么做发现没有，如果我们要对A做掩码处理就会发现掩码矩阵对应到原图的位置不存在。现在处理有两种，一种是不对边缘的像素做掩码处理，另一种是为周边的图像做一个padding处理，这种操作在深度学习的图像处理中很常见，通常设置0像素，或者拷贝对边的边缘像素。</p>
<p><img src="/images/%E5%8D%B7%E7%A7%AF%E6%A0%B8%E5%A4%84%E7%90%86%E5%8E%9F%E7%90%86.png" alt="卷积核处理原理.png"></p>
<p>能看到这里处理和卷积处理不太一样，只是为了方便，把这种掩码滤波操作称为一种核，是自相关，并不是去计算卷积。</p>
<h3 id="OpenCV的手写实现"><a href="#OpenCV的手写实现" class="headerlink" title="OpenCV的手写实现"></a>OpenCV的手写实现</h3><pre class="line-numbers language-cpp"><code class="language-cpp">Mat dst <span class="token operator">=</span> Mat<span class="token operator">::</span><span class="token function">zeros</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> src<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> cols <span class="token operator">=</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span>cols <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> src<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> rows <span class="token operator">=</span> src<span class="token punctuation">.</span>rows<span class="token punctuation">;</span>
<span class="token keyword">int</span> offsetx <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>row <span class="token operator">&lt;</span> rows <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>row<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//前一行</span>
        uchar<span class="token operator">*</span> pre <span class="token operator">=</span> src<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">></span><span class="token punctuation">(</span>row <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//当前行</span>
        uchar<span class="token operator">*</span> current <span class="token operator">=</span> src<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">></span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//下一行</span>
        uchar<span class="token operator">*</span> next <span class="token operator">=</span> src<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">></span><span class="token punctuation">(</span>row<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//输出</span>
        uchar<span class="token operator">*</span> out <span class="token operator">=</span> dst<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">></span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//计算列以及里面的每一个颜色通道</span>
        <span class="token comment" spellcheck="true">/*
         这种掩码是
         0 -1 0
         -1 5 -1
         0 -1 0
         */</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> col <span class="token operator">=</span> offsetx<span class="token punctuation">;</span>col <span class="token operator">&lt;</span> cols<span class="token punctuation">;</span>col<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//当前行</span>
            out<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span>saturate_cast<span class="token operator">&lt;</span>uchar<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> current<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">-</span>
                                           <span class="token punctuation">(</span>pre<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">+</span> next<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">+</span> current<span class="token punctuation">[</span>col <span class="token operator">-</span> offsetx<span class="token punctuation">]</span> <span class="token operator">+</span> current<span class="token punctuation">[</span>col <span class="token operator">+</span> offsetx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/%E6%8E%A9%E7%A0%81%E6%93%8D%E4%BD%9C.png" alt="掩码操作.png"></p>
<p>能看到此时这两张图片的对比度有很明显的区别。经过掩码矩阵之后，会发现原图会更加平滑一点，而掩码操作之后会导致整个图片最亮和最暗之间的差距拉大。</p>
<p>从数学公式上来看，当前像素权重为5，周边的点的权重是-1和0.能够发现会对当前的节点加深，同时把周围的像素值减掉，就增加了每一个像素点和周边像素差值，也就是对比度。</p>
<h2 id="OpenCV中的滤波函数"><a href="#OpenCV中的滤波函数" class="headerlink" title="OpenCV中的滤波函数"></a>OpenCV中的滤波函数</h2><p>当然在OpenCV中，有这么一个函数filter2D，处理掩码操作。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Mat kenrel <span class="token operator">=</span> <span class="token punctuation">(</span>Mat_<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token number">0</span> <span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">filter2D</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> src<span class="token punctuation">.</span><span class="token function">depth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kenrel<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这里创建一个3*3的核。这个核实际上就是上图的那个。这样传递一个掩码矩阵和图像的深度就完成了掩码操作。</p>
<h2 id="平滑操作"><a href="#平滑操作" class="headerlink" title="平滑操作"></a>平滑操作</h2><p>平滑也称为模糊，是一项高频率使用的操作。<br>平滑的作用有很多，其中一项就是降噪音。平滑处理和掩码操作有点相似，也是需要一个滤波器，我们最常用的滤波器就是线性滤波器。线性滤波处理的输出像素值$g(i,j)$是输出像素值$f(i+k,j+k)$的权加和：<br>$g(i,j) = \sum_{k,l}f(i+k,j+k)h(k,l)$<br>其中,h(k,l)成为核，它仅仅只是一个权加系数。图形上的操作和上面的图相似。不妨把核当成一个滑动窗口，不断的沿着原图像素的行列扫动，扫动的过程中，不断的把路过像素都平滑处理。</p>
<h3 id="均值-归一化-模糊"><a href="#均值-归一化-模糊" class="headerlink" title="均值(归一化)模糊"></a>均值(归一化)模糊</h3><p>这里先介绍均值滤波器，它的核心如下：<br><img src="/images/%E5%BD%92%E4%B8%80%E5%8C%96.png" alt="归一化.png"></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">blur</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Point</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里的参数意思是，src:输入的图像，dst：经过均值模糊之后的输出图像，Size:是指这个滤波器的大小，Point是指整个图像模糊绕着哪个原点为半径的进行处理，传入(-1,-1)就是指图像中心，这样就能模糊整个图像。</p>
<p>其计算原理很简单就是，把核里面的所有权重设置为1，最后全部相加求平均值。最后赋值到原来的像素上。</p>
<h3 id="高斯模糊"><a href="#高斯模糊" class="headerlink" title="高斯模糊"></a>高斯模糊</h3><p>最有用的滤波器 (尽管不是最快的)。 高斯滤波是将输入数组的每一个像素点与 高斯内核 卷积将卷积和当作输出像素值。</p>
<p>高斯模糊实际上是一个二维的高斯核。回顾一下一维的高斯函数：<br><img src="/images/%E4%B8%80%E7%BB%B4%E7%9A%84%E9%AB%98%E6%96%AF%E5%87%BD%E6%95%B0.png" alt="一维的高斯函数.png"></p>
<p>那么二维实际上就是，就是在原来的x,y轴的情况下，增加一个z轴的纬度，实际上看起来就像一座山一样。<br><img src="/images/%E4%BA%8C%E7%BB%B4%E7%9A%84%E9%AB%98%E6%96%AF%E5%87%BD%E6%95%B0.png" alt="二维的高斯函数.png"></p>
<p>二维的高斯函数可以表示为：<br><img src="/images/%E4%BA%8C%E7%BB%B4%E7%9A%84%E9%AB%98%E6%96%AF%E5%87%BD%E6%95%B0%E5%85%AC%E5%BC%8F.png" alt="二维的高斯函数公式.png"></p>
<p>为了达到达到</p>
<p>其OpenCV的调用方式：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">CV_EXPORTS_W <span class="token keyword">void</span> <span class="token function">GaussianBlur</span><span class="token punctuation">(</span> InputArray src<span class="token punctuation">,</span> OutputArray dst<span class="token punctuation">,</span> Size ksize<span class="token punctuation">,</span>
                                <span class="token keyword">double</span> sigmaX<span class="token punctuation">,</span> <span class="token keyword">double</span> sigmaY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
                                <span class="token keyword">int</span> borderType <span class="token operator">=</span> BORDER_DEFAULT <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">GaussianBlur</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> gaussian<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里的参数意思是，src:输入的图像，dst：经过高斯模糊之后的输出图像，Size:是指这个滤波器的大小。sigmaX和sigmaY分别指代的是高斯模糊x轴上和y轴上的二维高斯函数的变化幅度。</p>
<p>换个形象的话说，用上图举个例子，就是确定这个高斯函数这个山的x方向的陡峭程度以及y轴方向的陡峭程度。</p>
<p>下面就高斯模糊，均值模糊和原图的比对<br><img src="/images/%E6%A8%A1%E7%B3%8A%E6%AF%94%E5%AF%B9.png" alt="模糊比对.png"><br>能看到，高斯模糊比起均值模糊保留了图像中相关的形状信息。</p>
<p>为什么会这样呢？原因很简单。因为在计算高斯模糊之前，会根据当前像素区域中所有的像素点进行一次，核的计算，越往中心的权重越高，权重如同小山一下，因此中心的像素权重像素一高了，虽然模糊但是还是保留了原来的形状。</p>
<p>但是当高斯模糊的矩阵大小和sigmaX，sigmaY相似的时候，整个高斯函数就不像山，而是想平原一样平坦。换句话说，整个高斯核中的权重就会，偏向一，就会导致和均值模糊类似效果。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">GaussianBlur</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> gaussian<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">121</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/images/%E4%BF%AE%E6%94%B9%E5%8D%B7%E7%A7%AF%E6%A0%B8%E8%8C%83%E5%9B%B4%E5%90%8E%E7%9A%84%E6%AF%94%E5%AF%B9.png" alt="修改卷积核范围后的比对.png"></p>
<p>高斯模糊计算流程：<br>图像中某一段图形的像素是如下分布，<br><img src="/images/%E5%83%8F%E7%B4%A0%E5%88%86%E5%B8%83.png" alt="像素分布.png"></p>
<p>这个时候高斯模糊需要一个核去对每一个位置做滤波。此时不同于均值模糊，没有固定的核矩阵，而是通过上面这个矩阵，计算出高斯的核，最后再计算变化后的矩阵每一个对应的像素。</p>
<p>虽然原理是这样，但是实际上OpenCV为了迅速，在原生实现的时候，内部判断到核是小于7的大小，设置一套固定的高斯模糊矩阵。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">float</span> small_gaussian_tab<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span>SMALL_GAUSSIAN_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">.</span>f<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token number">0.25f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.25f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token number">0.0625f</span><span class="token punctuation">,</span> <span class="token number">0.25f</span><span class="token punctuation">,</span> <span class="token number">0.375f</span><span class="token punctuation">,</span> <span class="token number">0.25f</span><span class="token punctuation">,</span> <span class="token number">0.0625f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token number">0.03125f</span><span class="token punctuation">,</span> <span class="token number">0.109375f</span><span class="token punctuation">,</span> <span class="token number">0.21875f</span><span class="token punctuation">,</span> <span class="token number">0.28125f</span><span class="token punctuation">,</span> <span class="token number">0.21875f</span><span class="token punctuation">,</span> <span class="token number">0.109375f</span><span class="token punctuation">,</span> <span class="token number">0.03125f</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/%E5%8D%B7%E7%A7%AF%E6%A0%B8%E5%BF%83%E8%AE%A1%E7%AE%97%E8%BF%87%E7%A8%8B.png" alt="卷积核心计算过程.png"></p>
<h2 id="OpenCV-filter滤波器源码解析"><a href="#OpenCV-filter滤波器源码解析" class="headerlink" title="OpenCV filter滤波器源码解析"></a>OpenCV filter滤波器源码解析</h2><p>这样直接就结束，不是我文章的风格，作为一个程序员，还是有必要探索一下，为什么OpenCV计算速度会比我们自己手写的快。</p>
<p>为了让源码看的不那么辛苦，先聊聊OpenCV底层的设计思想。首先在OpenCV中，内置了几种计算方案，按照效率高低优先度依次的向后执行。</p>
<p>这种设计可以看成我们的平常开发的拦截器设计。当发现优先度高的计算模式发现可以使用的时候，OpenCV将会使用这种模式下的算法进行运算。</p>
<p>一般来说，OpenCV内置如下四个层级计算方案，按照优先顺序依次为：<br>OpenCV计算方案|描述<br>-|-<br>CV_IMPL_OCL(0x02)|OpenCL实际上是类似OpenGL一样借助显卡做并发计算<br>CV_IMPL_IPP(0x04)|IPP库加速<br>CV_IMPL_MT|多线程处理<br>CV_IMPL_PLAIN|OpenCV原生实现</p>
<p>能看到按照这个优先级不断的向下查找，找到当前OpenCV最快的计算环境。除了最后一个之外，其他三个都是并发计算。</p>
<p><img src="/images/OpenCV%E8%AE%A1%E7%AE%97%E7%8E%AF%E5%A2%83%E7%AD%9B%E9%80%89.png" alt="OpenCV计算环境筛选.png"></p>
<p>记住这个流程，我们查看OpenCV的源码就很轻松了。</p>
<p>先来看看filter2D的源码。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">filter2D</span><span class="token punctuation">(</span>InputArray _src<span class="token punctuation">,</span> OutputArray _dst<span class="token punctuation">,</span> <span class="token keyword">int</span> ddepth<span class="token punctuation">,</span>
              InputArray _kernel<span class="token punctuation">,</span> Point anchor0<span class="token punctuation">,</span>
              <span class="token keyword">double</span> delta<span class="token punctuation">,</span> <span class="token keyword">int</span> borderType<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">CV_INSTRUMENT_REGION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CV_OCL_RUN</span><span class="token punctuation">(</span>_dst<span class="token punctuation">.</span><span class="token function">isUMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _src<span class="token punctuation">.</span><span class="token function">dims</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">,</span>
               <span class="token function">ocl_filter2D</span><span class="token punctuation">(</span>_src<span class="token punctuation">,</span> _dst<span class="token punctuation">,</span> ddepth<span class="token punctuation">,</span> _kernel<span class="token punctuation">,</span> anchor0<span class="token punctuation">,</span> delta<span class="token punctuation">,</span> borderType<span class="token punctuation">)</span><span class="token punctuation">)</span>

    Mat src <span class="token operator">=</span> _src<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kernel <span class="token operator">=</span> _kernel<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> ddepth <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        ddepth <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">depth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _dst<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> src<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">CV_MAKETYPE</span><span class="token punctuation">(</span>ddepth<span class="token punctuation">,</span> src<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat dst <span class="token operator">=</span> _dst<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Point anchor <span class="token operator">=</span> <span class="token function">normalizeAnchor</span><span class="token punctuation">(</span>anchor0<span class="token punctuation">,</span> kernel<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Point ofs<span class="token punctuation">;</span>
    Size <span class="token function">wsz</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> src<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>borderType <span class="token operator">&amp;</span> BORDER_ISOLATED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        src<span class="token punctuation">.</span><span class="token function">locateROI</span><span class="token punctuation">(</span> wsz<span class="token punctuation">,</span> ofs <span class="token punctuation">)</span><span class="token punctuation">;</span>

    hal<span class="token operator">::</span><span class="token function">filter2D</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dst<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kernel<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  src<span class="token punctuation">.</span>data<span class="token punctuation">,</span> src<span class="token punctuation">.</span>step<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>data<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>step<span class="token punctuation">,</span>
                  dst<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>rows<span class="token punctuation">,</span> wsz<span class="token punctuation">.</span>width<span class="token punctuation">,</span> wsz<span class="token punctuation">.</span>height<span class="token punctuation">,</span> ofs<span class="token punctuation">.</span>x<span class="token punctuation">,</span> ofs<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                  kernel<span class="token punctuation">.</span>data<span class="token punctuation">,</span> kernel<span class="token punctuation">.</span>step<span class="token punctuation">,</span>  kernel<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> kernel<span class="token punctuation">.</span>rows<span class="token punctuation">,</span>
                  anchor<span class="token punctuation">.</span>x<span class="token punctuation">,</span> anchor<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                  delta<span class="token punctuation">,</span> borderType<span class="token punctuation">,</span> src<span class="token punctuation">.</span><span class="token function">isSubmatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="OpenCL执行原理"><a href="#OpenCL执行原理" class="headerlink" title="OpenCL执行原理"></a>OpenCL执行原理</h3><p>果不其然，在filter2D实现的第一步，就开始调用CV_OCL_RUN宏去调用OpenCL的显卡并发计算。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token function">CV_OCL_RUN</span><span class="token punctuation">(</span>_dst<span class="token punctuation">.</span><span class="token function">isUMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _src<span class="token punctuation">.</span><span class="token function">dims</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">,</span>
               <span class="token function">ocl_filter2D</span><span class="token punctuation">(</span>_src<span class="token punctuation">,</span> _dst<span class="token punctuation">,</span> ddepth<span class="token punctuation">,</span> _kernel<span class="token punctuation">,</span> anchor0<span class="token punctuation">,</span> delta<span class="token punctuation">,</span> borderType<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> CV_OCL_RUN(condition, func) CV_OCL_RUN_(condition, func)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，这里面发送了一个condition和一个方法到OpenCL中运行。但是如果，OpenCV在编译的时候，我们没有打开这个OpenCL的选项，没有OpenCL的环境的时候，它实际上就是一个没什么用处的宏：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> CV_OCL_RUN_(condition, func, ...)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>当有了OpenCL的环境，这个宏就会替换成这个：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> CV_OCL_RUN_(condition, func, ...)                                   \
    {                                                                       \
        if (cv::ocl::isOpenCLActivated() &amp;&amp; (condition) &amp;&amp; func)            \
        {                                                                   \
            printf("%s: OpenCL implementation is running\n", CV_Func);      \
            fflush(stdout);                                                 \
            CV_IMPL_ADD(CV_IMPL_OCL);                                       \
            return __VA_ARGS__;                                             \
        }                                                                   \
        else                                                                \
        {                                                                   \
            printf("%s: Plain implementation is running\n", CV_Func);       \
            fflush(stdout);                                                 \
        }                                                                   \
    }</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能清晰的看到，此时会判断当前的OpenCL是否还在活跃，活跃的状态,并且条件和方法符合规范，就会通过CV_IMPL_ADD，把方法添加到一个vector向量中，让OpenCL读取执行。</p>
<p>在这里面，OpenCV想要使用OpenCL进行计算，就需要这个Mat的类型是UMat，并且是纬度小于等于2.当不符合这两个条件将不会执行OpenCL。</p>
<p>UMat是专门给OpenCL规范计算而使用的矩阵。里面有很多和Mat相似的方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">addImpl</span><span class="token punctuation">(</span><span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cv<span class="token operator">::</span>AutoLock <span class="token function">lock</span><span class="token punctuation">(</span><span class="token function">getImplData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">getImplData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>implFlags <span class="token operator">|</span><span class="token operator">=</span> flag<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// use lazy collection if name was not specified</span>
    <span class="token punctuation">{</span>
        size_t index <span class="token operator">=</span> <span class="token function">getImplData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>implCode<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>index <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">getImplData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>implCode<span class="token punctuation">[</span>index<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> flag <span class="token operator">||</span> <span class="token function">getImplData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>implFun<span class="token punctuation">[</span>index<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// avoid duplicates</span>
        <span class="token punctuation">{</span>
            <span class="token function">getImplData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>implCode<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">getImplData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>implFun<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时可能是多线程处理，因此会添加一个智能锁，去保证数据的正确性。</p>
<p>具体的思路，将不作为重点，这边先看看OpenCV是传入了ocl_filter2D的方法，看看这个方法在OpenCL中的执行流程。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">ocl_filter2D</span><span class="token punctuation">(</span> InputArray _src<span class="token punctuation">,</span> OutputArray _dst<span class="token punctuation">,</span> <span class="token keyword">int</span> ddepth<span class="token punctuation">,</span>
                   InputArray _kernel<span class="token punctuation">,</span> Point anchor<span class="token punctuation">,</span>
                   <span class="token keyword">double</span> delta<span class="token punctuation">,</span> <span class="token keyword">int</span> borderType <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//获取通道数和深度</span>
    <span class="token keyword">int</span> type <span class="token operator">=</span> _src<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sdepth <span class="token operator">=</span> <span class="token function">CV_MAT_DEPTH</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span> cn <span class="token operator">=</span> <span class="token function">CV_MAT_CN</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//如果传下来的深度小于0，则取原图的深度，否则取传下来的深度</span>
    ddepth <span class="token operator">=</span> ddepth <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> sdepth <span class="token operator">:</span> ddepth<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//根据深度生成type，判断获取哪个深度原图和传下来更大，取最大</span>
    <span class="token keyword">int</span> dtype <span class="token operator">=</span> <span class="token function">CV_MAKE_TYPE</span><span class="token punctuation">(</span>ddepth<span class="token punctuation">,</span> cn<span class="token punctuation">)</span><span class="token punctuation">,</span> wdepth <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span>sdepth<span class="token punctuation">,</span> ddepth<span class="token punctuation">)</span><span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">,</span>
            wtype <span class="token operator">=</span> <span class="token function">CV_MAKE_TYPE</span><span class="token punctuation">(</span>wdepth<span class="token punctuation">,</span> cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//通道数大于4说明不支持解析</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cn <span class="token operator">></span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//获取核的大小</span>
    Size ksize <span class="token operator">=</span> _kernel<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>anchor<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        anchor<span class="token punctuation">.</span>x <span class="token operator">=</span> ksize<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>anchor<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        anchor<span class="token punctuation">.</span>y <span class="token operator">=</span> ksize<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//使用哪一种滤波的边缘处理,</span>
    <span class="token keyword">bool</span> isolated <span class="token operator">=</span> <span class="token punctuation">(</span>borderType <span class="token operator">&amp;</span> BORDER_ISOLATED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    borderType <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>BORDER_ISOLATED<span class="token punctuation">;</span>
    <span class="token keyword">const</span> cv<span class="token operator">::</span>ocl<span class="token operator">::</span>Device <span class="token operator">&amp;</span>device <span class="token operator">=</span> cv<span class="token operator">::</span>ocl<span class="token operator">::</span>Device<span class="token operator">::</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//判断设备是否支持CV_64F的解析</span>
    <span class="token keyword">bool</span> doubleSupport <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">doubleFPConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wdepth <span class="token operator">==</span> CV_64F <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>doubleSupport<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> borderMap<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"BORDER_CONSTANT"</span><span class="token punctuation">,</span> <span class="token string">"BORDER_REPLICATE"</span><span class="token punctuation">,</span> <span class="token string">"BORDER_REFLECT"</span><span class="token punctuation">,</span>
                                       <span class="token string">"BORDER_WRAP"</span><span class="token punctuation">,</span> <span class="token string">"BORDER_REFLECT_101"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//获取核的大小</span>
    cv<span class="token operator">::</span>Mat kernelMat <span class="token operator">=</span> _kernel<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span>Size sz <span class="token operator">=</span> _src<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wholeSize<span class="token punctuation">;</span>
    size_t globalsize<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>sz<span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>sz<span class="token punctuation">.</span>height <span class="token punctuation">}</span><span class="token punctuation">;</span>
    size_t localsize_general<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    size_t<span class="token operator">*</span> localsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    ocl<span class="token operator">::</span>Kernel k<span class="token punctuation">;</span>
    UMat src <span class="token operator">=</span> _src<span class="token punctuation">.</span><span class="token function">getUMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//是否是不计算边缘的方式，不是则获取UMat矩阵头</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolated<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Point ofs<span class="token punctuation">;</span>
        src<span class="token punctuation">.</span><span class="token function">locateROI</span><span class="token punctuation">(</span>wholeSize<span class="token punctuation">,</span> ofs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    size_t tryWorkItems <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">maxWorkGroupSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token function">isIntel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token number">128</span> <span class="token operator">&lt;</span> tryWorkItems<span class="token punctuation">)</span>
        tryWorkItems <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> cvt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// For smaller filter kernels, there is a special kernel that is more</span>
    <span class="token comment" spellcheck="true">// efficient than the general one.</span>
<span class="token comment" spellcheck="true">//判断其核的大小是否小于5，在很小的核，有更快的方式处理滤波</span>
    UMat kernalDataUMat<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token function">isIntel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> ocl<span class="token operator">::</span>Device<span class="token operator">::</span>TYPE_GPU<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>ksize<span class="token punctuation">.</span>width <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> ksize<span class="token punctuation">.</span>height <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>ksize<span class="token punctuation">.</span>width <span class="token operator">==</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> ksize<span class="token punctuation">.</span>height <span class="token operator">==</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> cn <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//把核化为行向量</span>
        kernelMat <span class="token operator">=</span> kernelMat<span class="token punctuation">.</span><span class="token function">reshape</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String kerStr <span class="token operator">=</span> ocl<span class="token operator">::</span><span class="token function">kernelToStr</span><span class="token punctuation">(</span>kernelMat<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> h <span class="token operator">=</span> isolated <span class="token operator">?</span> sz<span class="token punctuation">.</span>height <span class="token operator">:</span> wholeSize<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
        <span class="token keyword">int</span> w <span class="token operator">=</span> isolated <span class="token operator">?</span> sz<span class="token punctuation">.</span>width <span class="token operator">:</span> wholeSize<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//小于核说明有问题，不计算</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">&lt;</span> ksize<span class="token punctuation">.</span>width <span class="token operator">||</span> h <span class="token operator">&lt;</span> ksize<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//判断当前的通道数字不为1则pxLoadNumPixels为1，如果通道数为1，则对着原图的宽度对4除余，0则为4，大于0则取1</span>
        <span class="token comment" spellcheck="true">// Figure out what vector size to use for loading the pixels.</span>
        <span class="token keyword">int</span> pxLoadNumPixels <span class="token operator">=</span> cn <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> sz<span class="token punctuation">.</span>width <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//乘以通道数。也就是说当通道数大于1，实际上pxLoadVecSize为通道数</span>
<span class="token comment" spellcheck="true">//等于1则判断是否能除尽4，除得尽则取4，否则取1</span>
        <span class="token keyword">int</span> pxLoadVecSize <span class="token operator">=</span> cn <span class="token operator">*</span> pxLoadNumPixels<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Figure out how many pixels per work item to compute in X and Y</span>
        <span class="token comment" spellcheck="true">// directions.  Too many and we run out of registers.</span>
        <span class="token keyword">int</span> pxPerWorkItemX <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pxPerWorkItemY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>cn <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> ksize<span class="token punctuation">.</span>width <span class="token operator">&lt;=</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> ksize<span class="token punctuation">.</span>height <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            pxPerWorkItemX <span class="token operator">=</span> sz<span class="token punctuation">.</span>width <span class="token operator">%</span> <span class="token number">8</span> <span class="token operator">?</span> sz<span class="token punctuation">.</span>width <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">?</span> sz<span class="token punctuation">.</span>width <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">4</span> <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>
            pxPerWorkItemY <span class="token operator">=</span> sz<span class="token punctuation">.</span>height <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cn <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> <span class="token punctuation">(</span>ksize<span class="token punctuation">.</span>width <span class="token operator">&lt;=</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> ksize<span class="token punctuation">.</span>height <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            pxPerWorkItemX <span class="token operator">=</span> sz<span class="token punctuation">.</span>width <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>
            pxPerWorkItemY <span class="token operator">=</span> sz<span class="token punctuation">.</span>height <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        globalsize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> sz<span class="token punctuation">.</span>width <span class="token operator">/</span> pxPerWorkItemX<span class="token punctuation">;</span>
        globalsize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> sz<span class="token punctuation">.</span>height <span class="token operator">/</span> pxPerWorkItemY<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Need some padding in the private array for pixels</span>
<span class="token comment" spellcheck="true">//pxPerWorkItemX + ksize.width - 1四舍五入到pxLoadNumPixels的倍数</span>
        <span class="token keyword">int</span> privDataWidth <span class="token operator">=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span>pxPerWorkItemX <span class="token operator">+</span> ksize<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> pxLoadNumPixels<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Make the global size a nice round number so the runtime can pick</span>
        <span class="token comment" spellcheck="true">// from reasonable choices for the workgroup size</span>
<span class="token comment" spellcheck="true">//globalsize四舍五入为256的倍数</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> wgRound <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
        globalsize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span>globalsize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> wgRound<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span> build_options<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//构建命令</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>build_options<span class="token punctuation">,</span> <span class="token string">"-D cn=%d "</span>
                <span class="token string">"-D ANCHOR_X=%d -D ANCHOR_Y=%d -D KERNEL_SIZE_X=%d -D KERNEL_SIZE_Y=%d "</span>
                <span class="token string">"-D PX_LOAD_VEC_SIZE=%d -D PX_LOAD_NUM_PX=%d "</span>
                <span class="token string">"-D PX_PER_WI_X=%d -D PX_PER_WI_Y=%d -D PRIV_DATA_WIDTH=%d -D %s -D %s "</span>
                <span class="token string">"-D PX_LOAD_X_ITERATIONS=%d -D PX_LOAD_Y_ITERATIONS=%d "</span>
                <span class="token string">"-D srcT=%s -D srcT1=%s -D dstT=%s -D dstT1=%s -D WT=%s -D WT1=%s "</span>
                <span class="token string">"-D convertToWT=%s -D convertToDstT=%s %s"</span><span class="token punctuation">,</span>
                cn<span class="token punctuation">,</span> anchor<span class="token punctuation">.</span>x<span class="token punctuation">,</span> anchor<span class="token punctuation">.</span>y<span class="token punctuation">,</span> ksize<span class="token punctuation">.</span>width<span class="token punctuation">,</span> ksize<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
                pxLoadVecSize<span class="token punctuation">,</span> pxLoadNumPixels<span class="token punctuation">,</span>
                pxPerWorkItemX<span class="token punctuation">,</span> pxPerWorkItemY<span class="token punctuation">,</span> privDataWidth<span class="token punctuation">,</span> borderMap<span class="token punctuation">[</span>borderType<span class="token punctuation">]</span><span class="token punctuation">,</span>
                isolated <span class="token operator">?</span> <span class="token string">"BORDER_ISOLATED"</span> <span class="token operator">:</span> <span class="token string">"NO_BORDER_ISOLATED"</span><span class="token punctuation">,</span>
                privDataWidth <span class="token operator">/</span> pxLoadNumPixels<span class="token punctuation">,</span> pxPerWorkItemY <span class="token operator">+</span> ksize<span class="token punctuation">.</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
                ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span> ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>sdepth<span class="token punctuation">)</span><span class="token punctuation">,</span> ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span>
                ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>ddepth<span class="token punctuation">)</span><span class="token punctuation">,</span> ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>wtype<span class="token punctuation">)</span><span class="token punctuation">,</span> ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>wdepth<span class="token punctuation">)</span><span class="token punctuation">,</span>
                ocl<span class="token operator">::</span><span class="token function">convertTypeStr</span><span class="token punctuation">(</span>sdepth<span class="token punctuation">,</span> wdepth<span class="token punctuation">,</span> cn<span class="token punctuation">,</span> cvt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                ocl<span class="token operator">::</span><span class="token function">convertTypeStr</span><span class="token punctuation">(</span>wdepth<span class="token punctuation">,</span> ddepth<span class="token punctuation">,</span> cn<span class="token punctuation">,</span> cvt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kerStr<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>k<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"filter2DSmall"</span><span class="token punctuation">,</span> cv<span class="token operator">::</span>ocl<span class="token operator">::</span>imgproc<span class="token operator">::</span>filter2DSmall_oclsrc<span class="token punctuation">,</span> build_options<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//大核不展开成行向量</span>
        localsize <span class="token operator">=</span> localsize_general<span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span> kernelMatDataFloat<span class="token punctuation">;</span>
        <span class="token keyword">int</span> kernel_size_y2_aligned <span class="token operator">=</span> _prepareKernelFilter2D<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span><span class="token punctuation">(</span>kernelMatDataFloat<span class="token punctuation">,</span> kernelMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String kerStr <span class="token operator">=</span> ocl<span class="token operator">::</span><span class="token function">kernelToStr</span><span class="token punctuation">(</span>kernelMatDataFloat<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            size_t BLOCK_SIZE <span class="token operator">=</span> tryWorkItems<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>BLOCK_SIZE <span class="token operator">></span> <span class="token number">32</span> <span class="token operator">&amp;&amp;</span> BLOCK_SIZE <span class="token operator">>=</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>ksize<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> BLOCK_SIZE <span class="token operator">></span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>sz<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
                BLOCK_SIZE <span class="token operator">/</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>ksize<span class="token punctuation">.</span>width <span class="token operator">></span> BLOCK_SIZE<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> requiredTop <span class="token operator">=</span> anchor<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            <span class="token keyword">int</span> requiredLeft <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>BLOCK_SIZE<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// not this: anchor.x;</span>
            <span class="token keyword">int</span> requiredBottom <span class="token operator">=</span> ksize<span class="token punctuation">.</span>height <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> anchor<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            <span class="token keyword">int</span> requiredRight <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>BLOCK_SIZE<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// not this: ksize.width - 1 - anchor.x;</span>
            <span class="token keyword">int</span> h <span class="token operator">=</span> isolated <span class="token operator">?</span> sz<span class="token punctuation">.</span>height <span class="token operator">:</span> wholeSize<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
            <span class="token keyword">int</span> w <span class="token operator">=</span> isolated <span class="token operator">?</span> sz<span class="token punctuation">.</span>width <span class="token operator">:</span> wholeSize<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
            <span class="token keyword">bool</span> extra_extrapolation <span class="token operator">=</span> h <span class="token operator">&lt;</span> requiredTop <span class="token operator">||</span> h <span class="token operator">&lt;</span> requiredBottom <span class="token operator">||</span> w <span class="token operator">&lt;</span> requiredLeft <span class="token operator">||</span> w <span class="token operator">&lt;</span> requiredRight<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>w <span class="token operator">&lt;</span> ksize<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>h <span class="token operator">&lt;</span> ksize<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            String opts <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"-D LOCAL_SIZE=%d -D cn=%d "</span>
                                 <span class="token string">"-D ANCHOR_X=%d -D ANCHOR_Y=%d -D KERNEL_SIZE_X=%d -D KERNEL_SIZE_Y=%d "</span>
                                 <span class="token string">"-D KERNEL_SIZE_Y2_ALIGNED=%d -D %s -D %s -D %s%s%s "</span>
                                 <span class="token string">"-D srcT=%s -D srcT1=%s -D dstT=%s -D dstT1=%s -D WT=%s -D WT1=%s "</span>
                                 <span class="token string">"-D convertToWT=%s -D convertToDstT=%s"</span><span class="token punctuation">,</span>
                                 <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>BLOCK_SIZE<span class="token punctuation">,</span> cn<span class="token punctuation">,</span> anchor<span class="token punctuation">.</span>x<span class="token punctuation">,</span> anchor<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                                 ksize<span class="token punctuation">.</span>width<span class="token punctuation">,</span> ksize<span class="token punctuation">.</span>height<span class="token punctuation">,</span> kernel_size_y2_aligned<span class="token punctuation">,</span> borderMap<span class="token punctuation">[</span>borderType<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 extra_extrapolation <span class="token operator">?</span> <span class="token string">"EXTRA_EXTRAPOLATION"</span> <span class="token operator">:</span> <span class="token string">"NO_EXTRA_EXTRAPOLATION"</span><span class="token punctuation">,</span>
                                 isolated <span class="token operator">?</span> <span class="token string">"BORDER_ISOLATED"</span> <span class="token operator">:</span> <span class="token string">"NO_BORDER_ISOLATED"</span><span class="token punctuation">,</span>
                                 doubleSupport <span class="token operator">?</span> <span class="token string">" -D DOUBLE_SUPPORT"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> kerStr<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span> ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>sdepth<span class="token punctuation">)</span><span class="token punctuation">,</span> ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>ddepth<span class="token punctuation">)</span><span class="token punctuation">,</span> ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>wtype<span class="token punctuation">)</span><span class="token punctuation">,</span> ocl<span class="token operator">::</span><span class="token function">typeToStr</span><span class="token punctuation">(</span>wdepth<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 ocl<span class="token operator">::</span><span class="token function">convertTypeStr</span><span class="token punctuation">(</span>sdepth<span class="token punctuation">,</span> wdepth<span class="token punctuation">,</span> cn<span class="token punctuation">,</span> cvt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 ocl<span class="token operator">::</span><span class="token function">convertTypeStr</span><span class="token punctuation">(</span>wdepth<span class="token punctuation">,</span> ddepth<span class="token punctuation">,</span> cn<span class="token punctuation">,</span> cvt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            localsize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> BLOCK_SIZE<span class="token punctuation">;</span>
            globalsize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">DIVUP</span><span class="token punctuation">(</span>sz<span class="token punctuation">.</span>width<span class="token punctuation">,</span> BLOCK_SIZE <span class="token operator">-</span> <span class="token punctuation">(</span>ksize<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> BLOCK_SIZE<span class="token punctuation">;</span>
            globalsize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> sz<span class="token punctuation">.</span>height<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>k<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"filter2D"</span><span class="token punctuation">,</span> cv<span class="token operator">::</span>ocl<span class="token operator">::</span>imgproc<span class="token operator">::</span>filter2D_oclsrc<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            size_t kernelWorkGroupSize <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">workGroupSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localsize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> kernelWorkGroupSize<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>BLOCK_SIZE <span class="token operator">&lt;</span> kernelWorkGroupSize<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            tryWorkItems <span class="token operator">=</span> kernelWorkGroupSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    _dst<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span> dtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    UMat dst <span class="token operator">=</span> _dst<span class="token punctuation">.</span><span class="token function">getUMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> srcOffsetX <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>offset <span class="token operator">%</span> src<span class="token punctuation">.</span>step<span class="token punctuation">)</span> <span class="token operator">/</span> src<span class="token punctuation">.</span><span class="token function">elemSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> srcOffsetY <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>offset <span class="token operator">/</span> src<span class="token punctuation">.</span>step<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> srcEndX <span class="token operator">=</span> <span class="token punctuation">(</span>isolated <span class="token operator">?</span> <span class="token punctuation">(</span>srcOffsetX <span class="token operator">+</span> sz<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">:</span> wholeSize<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> srcEndY <span class="token operator">=</span> <span class="token punctuation">(</span>isolated <span class="token operator">?</span> <span class="token punctuation">(</span>srcOffsetY <span class="token operator">+</span> sz<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token operator">:</span> wholeSize<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    k<span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span>ocl<span class="token operator">::</span>KernelArg<span class="token operator">::</span><span class="token function">PtrReadOnly</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>src<span class="token punctuation">.</span>step<span class="token punctuation">,</span> srcOffsetX<span class="token punctuation">,</span> srcOffsetY<span class="token punctuation">,</span>
           srcEndX<span class="token punctuation">,</span> srcEndY<span class="token punctuation">,</span> ocl<span class="token operator">::</span>KernelArg<span class="token operator">::</span><span class="token function">WriteOnly</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>delta<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> k<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> globalsize<span class="token punctuation">,</span> localsize<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>OpenCL会把命令最后发送到显卡处理。</p>
<h2 id="进入到hal中进一步处理"><a href="#进入到hal中进一步处理" class="headerlink" title="进入到hal中进一步处理"></a>进入到hal中进一步处理</h2><pre class="line-numbers language-cpp"><code class="language-cpp">    Mat src <span class="token operator">=</span> _src<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kernel <span class="token operator">=</span> _kernel<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> ddepth <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        ddepth <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">depth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _dst<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> src<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">CV_MAKETYPE</span><span class="token punctuation">(</span>ddepth<span class="token punctuation">,</span> src<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat dst <span class="token operator">=</span> _dst<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Point anchor <span class="token operator">=</span> <span class="token function">normalizeAnchor</span><span class="token punctuation">(</span>anchor0<span class="token punctuation">,</span> kernel<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Point ofs<span class="token punctuation">;</span>
    Size <span class="token function">wsz</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> src<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>borderType <span class="token operator">&amp;</span> BORDER_ISOLATED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        src<span class="token punctuation">.</span><span class="token function">locateROI</span><span class="token punctuation">(</span> wsz<span class="token punctuation">,</span> ofs <span class="token punctuation">)</span><span class="token punctuation">;</span>

    hal<span class="token operator">::</span><span class="token function">filter2D</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dst<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kernel<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  src<span class="token punctuation">.</span>data<span class="token punctuation">,</span> src<span class="token punctuation">.</span>step<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>data<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>step<span class="token punctuation">,</span>
                  dst<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>rows<span class="token punctuation">,</span> wsz<span class="token punctuation">.</span>width<span class="token punctuation">,</span> wsz<span class="token punctuation">.</span>height<span class="token punctuation">,</span> ofs<span class="token punctuation">.</span>x<span class="token punctuation">,</span> ofs<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                  kernel<span class="token punctuation">.</span>data<span class="token punctuation">,</span> kernel<span class="token punctuation">.</span>step<span class="token punctuation">,</span>  kernel<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> kernel<span class="token punctuation">.</span>rows<span class="token punctuation">,</span>
                  anchor<span class="token punctuation">.</span>x<span class="token punctuation">,</span> anchor<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                  delta<span class="token punctuation">,</span> borderType<span class="token punctuation">,</span> src<span class="token punctuation">.</span><span class="token function">isSubmatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上这一步和上面的方法有点相似。本质上都是获取需要模糊的区域，如果是(-1,-1)，则取中心点，接着判断当前滤波对边缘的处理(BORDER_ISOLATED 不去获取Point为圆心设置的模糊之外的区域)。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">enum</span> BorderTypes <span class="token punctuation">{</span>
    BORDER_CONSTANT    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//!&lt; `iiiiii|abcdefgh|iiiiiii`  with some specified `i`</span>
    BORDER_REPLICATE   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//!&lt; `aaaaaa|abcdefgh|hhhhhhh`</span>
    BORDER_REFLECT     <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//!&lt; `fedcba|abcdefgh|hgfedcb`</span>
    BORDER_WRAP        <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//!&lt; `cdefgh|abcdefgh|abcdefg`</span>
    BORDER_REFLECT_101 <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//!&lt; `gfedcb|abcdefgh|gfedcba`</span>
    BORDER_TRANSPARENT <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//!&lt; `uvwxyz|abcdefgh|ijklmno`</span>

    BORDER_REFLECT101  <span class="token operator">=</span> BORDER_REFLECT_101<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//!&lt; same as BORDER_REFLECT_101</span>
    BORDER_DEFAULT     <span class="token operator">=</span> BORDER_REFLECT_101<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//!&lt; same as BORDER_REFLECT_101</span>
    BORDER_ISOLATED    <span class="token operator">=</span> <span class="token number">16</span> <span class="token comment" spellcheck="true">//!&lt; do not look outside of ROI</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个枚举已经解释很清楚了，默认的边缘处理是复制二个和倒数第二个填充边缘。<br>最后进入到hal的filter2D进一步操作。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">filter2D</span><span class="token punctuation">(</span><span class="token keyword">int</span> stype<span class="token punctuation">,</span> <span class="token keyword">int</span> dtype<span class="token punctuation">,</span> <span class="token keyword">int</span> kernel_type<span class="token punctuation">,</span>
              uchar <span class="token operator">*</span> src_data<span class="token punctuation">,</span> size_t src_step<span class="token punctuation">,</span>
              uchar <span class="token operator">*</span> dst_data<span class="token punctuation">,</span> size_t dst_step<span class="token punctuation">,</span>
              <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span>
              <span class="token keyword">int</span> full_width<span class="token punctuation">,</span> <span class="token keyword">int</span> full_height<span class="token punctuation">,</span>
              <span class="token keyword">int</span> offset_x<span class="token punctuation">,</span> <span class="token keyword">int</span> offset_y<span class="token punctuation">,</span>
              uchar <span class="token operator">*</span> kernel_data<span class="token punctuation">,</span> size_t kernel_step<span class="token punctuation">,</span>
              <span class="token keyword">int</span> kernel_width<span class="token punctuation">,</span> <span class="token keyword">int</span> kernel_height<span class="token punctuation">,</span>
              <span class="token keyword">int</span> anchor_x<span class="token punctuation">,</span> <span class="token keyword">int</span> anchor_y<span class="token punctuation">,</span>
              <span class="token keyword">double</span> delta<span class="token punctuation">,</span> <span class="token keyword">int</span> borderType<span class="token punctuation">,</span>
              <span class="token keyword">bool</span> isSubmatrix<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//判断到是可分离滤波，则原来的替代filter2d</span>
    <span class="token keyword">bool</span> res<span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">replacementFilter2D</span><span class="token punctuation">(</span>stype<span class="token punctuation">,</span> dtype<span class="token punctuation">,</span> kernel_type<span class="token punctuation">,</span>
                              src_data<span class="token punctuation">,</span> src_step<span class="token punctuation">,</span>
                              dst_data<span class="token punctuation">,</span> dst_step<span class="token punctuation">,</span>
                              width<span class="token punctuation">,</span> height<span class="token punctuation">,</span>
                              full_width<span class="token punctuation">,</span> full_height<span class="token punctuation">,</span>
                              offset_x<span class="token punctuation">,</span> offset_y<span class="token punctuation">,</span>
                              kernel_data<span class="token punctuation">,</span> kernel_step<span class="token punctuation">,</span>
                              kernel_width<span class="token punctuation">,</span> kernel_height<span class="token punctuation">,</span>
                              anchor_x<span class="token punctuation">,</span> anchor_y<span class="token punctuation">,</span>
                              delta<span class="token punctuation">,</span> borderType<span class="token punctuation">,</span> isSubmatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//使用IPP处理filter2D</span>
    <span class="token function">CV_IPP_RUN_FAST</span><span class="token punctuation">(</span><span class="token function">ippFilter2D</span><span class="token punctuation">(</span>stype<span class="token punctuation">,</span> dtype<span class="token punctuation">,</span> kernel_type<span class="token punctuation">,</span>
                              src_data<span class="token punctuation">,</span> src_step<span class="token punctuation">,</span>
                              dst_data<span class="token punctuation">,</span> dst_step<span class="token punctuation">,</span>
                              width<span class="token punctuation">,</span> height<span class="token punctuation">,</span>
                              full_width<span class="token punctuation">,</span> full_height<span class="token punctuation">,</span>
                              offset_x<span class="token punctuation">,</span> offset_y<span class="token punctuation">,</span>
                              kernel_data<span class="token punctuation">,</span> kernel_step<span class="token punctuation">,</span>
                              kernel_width<span class="token punctuation">,</span> kernel_height<span class="token punctuation">,</span>
                              anchor_x<span class="token punctuation">,</span> anchor_y<span class="token punctuation">,</span>
                              delta<span class="token punctuation">,</span> borderType<span class="token punctuation">,</span> isSubmatrix<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//使用dft算法处理filter2D</span>
    res <span class="token operator">=</span> <span class="token function">dftFilter2D</span><span class="token punctuation">(</span>stype<span class="token punctuation">,</span> dtype<span class="token punctuation">,</span> kernel_type<span class="token punctuation">,</span>
                      src_data<span class="token punctuation">,</span> src_step<span class="token punctuation">,</span>
                      dst_data<span class="token punctuation">,</span> dst_step<span class="token punctuation">,</span>
                      width<span class="token punctuation">,</span> height<span class="token punctuation">,</span>
                      full_width<span class="token punctuation">,</span> full_height<span class="token punctuation">,</span>
                      offset_x<span class="token punctuation">,</span> offset_y<span class="token punctuation">,</span>
                      kernel_data<span class="token punctuation">,</span> kernel_step<span class="token punctuation">,</span>
                      kernel_width<span class="token punctuation">,</span> kernel_height<span class="token punctuation">,</span>
                      anchor_x<span class="token punctuation">,</span> anchor_y<span class="token punctuation">,</span>
                      delta<span class="token punctuation">,</span> borderType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//最后再进行效率最低的filter2D的原生操作</span>
    <span class="token function">ocvFilter2D</span><span class="token punctuation">(</span>stype<span class="token punctuation">,</span> dtype<span class="token punctuation">,</span> kernel_type<span class="token punctuation">,</span>
                src_data<span class="token punctuation">,</span> src_step<span class="token punctuation">,</span>
                dst_data<span class="token punctuation">,</span> dst_step<span class="token punctuation">,</span>
                width<span class="token punctuation">,</span> height<span class="token punctuation">,</span>
                full_width<span class="token punctuation">,</span> full_height<span class="token punctuation">,</span>
                offset_x<span class="token punctuation">,</span> offset_y<span class="token punctuation">,</span>
                kernel_data<span class="token punctuation">,</span> kernel_step<span class="token punctuation">,</span>
                kernel_width<span class="token punctuation">,</span> kernel_height<span class="token punctuation">,</span>
                anchor_x<span class="token punctuation">,</span> anchor_y<span class="token punctuation">,</span>
                delta<span class="token punctuation">,</span> borderType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里有四种方式：</p>
<ul>
<li>1.判断是否是可分离的滤波，是则使用replacementFilter2D代替之后的算法。</li>
<li>2.使用IPP库并行计算</li>
<li>3.尝试着使用dft算法处理滤波</li>
<li>4.最后再是效率最差的滤波算法</li>
</ul>
<p>在情况1中，一般的情况replacementFilter2D返回的是一个没有实现的错误码，第二种情况是Intel的并行计算库，没有任何研究，跳过。我们来看看第三种情况和第四种情况</p>
<h3 id="filter2D的dft算法"><a href="#filter2D的dft算法" class="headerlink" title="filter2D的dft算法"></a>filter2D的dft算法</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">dftFilter2D</span><span class="token punctuation">(</span><span class="token keyword">int</span> stype<span class="token punctuation">,</span> <span class="token keyword">int</span> dtype<span class="token punctuation">,</span> <span class="token keyword">int</span> kernel_type<span class="token punctuation">,</span>
                        uchar <span class="token operator">*</span> src_data<span class="token punctuation">,</span> size_t src_step<span class="token punctuation">,</span>
                        uchar <span class="token operator">*</span> dst_data<span class="token punctuation">,</span> size_t dst_step<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> full_width<span class="token punctuation">,</span> <span class="token keyword">int</span> full_height<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> offset_x<span class="token punctuation">,</span> <span class="token keyword">int</span> offset_y<span class="token punctuation">,</span>
                        uchar <span class="token operator">*</span> kernel_data<span class="token punctuation">,</span> size_t kernel_step<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> kernel_width<span class="token punctuation">,</span> <span class="token keyword">int</span> kernel_height<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> anchor_x<span class="token punctuation">,</span> <span class="token keyword">int</span> anchor_y<span class="token punctuation">,</span>
                        <span class="token keyword">double</span> delta<span class="token punctuation">,</span> <span class="token keyword">int</span> borderType<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> sdepth <span class="token operator">=</span> <span class="token function">CV_MAT_DEPTH</span><span class="token punctuation">(</span>stype<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> ddepth <span class="token operator">=</span> <span class="token function">CV_MAT_DEPTH</span><span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> dft_filter_size <span class="token operator">=</span> <span class="token function">checkHardwareSupport</span><span class="token punctuation">(</span>CV_CPU_SSE3<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sdepth <span class="token operator">==</span> CV_8U <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ddepth <span class="token operator">==</span> CV_8U <span class="token operator">||</span> ddepth <span class="token operator">==</span> CV_16S<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>sdepth <span class="token operator">==</span> CV_32F <span class="token operator">&amp;&amp;</span> ddepth <span class="token operator">==</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">130</span> <span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kernel_width <span class="token operator">*</span> kernel_height <span class="token operator">&lt;</span> dft_filter_size<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// detect roi case</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>offset_x <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>offset_y <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>width <span class="token operator">!=</span> full_width<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>height <span class="token operator">!=</span> full_height<span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    Point anchor <span class="token operator">=</span> <span class="token function">Point</span><span class="token punctuation">(</span>anchor_x<span class="token punctuation">,</span> anchor_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat kernel <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span>kernel_width<span class="token punctuation">,</span> kernel_height<span class="token punctuation">)</span><span class="token punctuation">,</span> kernel_type<span class="token punctuation">,</span> kernel_data<span class="token punctuation">,</span> kernel_step<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Mat <span class="token function">src</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span> stype<span class="token punctuation">,</span> src_data<span class="token punctuation">,</span> src_step<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat <span class="token function">dst</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token punctuation">,</span> dst_data<span class="token punctuation">,</span> dst_step<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat temp<span class="token punctuation">;</span>
    <span class="token keyword">int</span> src_channels <span class="token operator">=</span> <span class="token function">CV_MAT_CN</span><span class="token punctuation">(</span>stype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> dst_channels <span class="token operator">=</span> <span class="token function">CV_MAT_CN</span><span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ddepth <span class="token operator">=</span> <span class="token function">CV_MAT_DEPTH</span><span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// crossCorr doesn't accept non-zero delta with multiple channels</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>src_channels <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> delta <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// The semantics of filter2D require that the delta be applied</span>
        <span class="token comment" spellcheck="true">// as floating-point math.  So wee need an intermediate Mat</span>
        <span class="token comment" spellcheck="true">// with a float datatype.  If the dest is already floats,</span>
        <span class="token comment" spellcheck="true">// we just use that.</span>
        <span class="token keyword">int</span> corrDepth <span class="token operator">=</span> ddepth<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ddepth <span class="token operator">==</span> CV_32F <span class="token operator">||</span> ddepth <span class="token operator">==</span> CV_64F<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> src_data <span class="token operator">!=</span> dst_data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            temp <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token punctuation">,</span> dst_data<span class="token punctuation">,</span> dst_step<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            corrDepth <span class="token operator">=</span> ddepth <span class="token operator">==</span> CV_64F <span class="token operator">?</span> CV_64F <span class="token operator">:</span> CV_32F<span class="token punctuation">;</span>
            temp<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">CV_MAKETYPE</span><span class="token punctuation">(</span>corrDepth<span class="token punctuation">,</span> dst_channels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">crossCorr</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> kernel<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> borderType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> delta<span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>temp<span class="token punctuation">.</span>data <span class="token operator">!=</span> dst_data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            temp<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> dst<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>src_data <span class="token operator">!=</span> dst_data<span class="token punctuation">)</span>
            temp <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token punctuation">,</span> dst_data<span class="token punctuation">,</span> dst_step<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            temp<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">crossCorr</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> kernel<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> delta<span class="token punctuation">,</span> borderType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>temp<span class="token punctuation">.</span>data <span class="token operator">!=</span> dst_data<span class="token punctuation">)</span>
            temp<span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当然这里面判断能够使用dft的判断首先要当前必须要整张图做滤波处理，其次是不能是(0,0)的点为圆心做滤波。最后要判断当前当前的cpu指令是否支持，支持则允许核的宽<em>高最高为130以内使用原生实现，否则只支持核的宽</em>高为50以内使用原生实现。</p>
<p>能看到这里面的核心就是调用crossCorr，处理核以及原图的矩阵(使用了快速傅立叶处理相关性计算)。最后从同add添加到目标Mat中，由于add的delta函数为0，因此就和替代的效果一致。</p>
<h1 id="OpenCV普通实现"><a href="#OpenCV普通实现" class="headerlink" title="OpenCV普通实现"></a>OpenCV普通实现</h1><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ocvFilter2D</span><span class="token punctuation">(</span><span class="token keyword">int</span> stype<span class="token punctuation">,</span> <span class="token keyword">int</span> dtype<span class="token punctuation">,</span> <span class="token keyword">int</span> kernel_type<span class="token punctuation">,</span>
                        uchar <span class="token operator">*</span> src_data<span class="token punctuation">,</span> size_t src_step<span class="token punctuation">,</span>
                        uchar <span class="token operator">*</span> dst_data<span class="token punctuation">,</span> size_t dst_step<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> full_width<span class="token punctuation">,</span> <span class="token keyword">int</span> full_height<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> offset_x<span class="token punctuation">,</span> <span class="token keyword">int</span> offset_y<span class="token punctuation">,</span>
                        uchar <span class="token operator">*</span> kernel_data<span class="token punctuation">,</span> size_t kernel_step<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> kernel_width<span class="token punctuation">,</span> <span class="token keyword">int</span> kernel_height<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> anchor_x<span class="token punctuation">,</span> <span class="token keyword">int</span> anchor_y<span class="token punctuation">,</span>
                        <span class="token keyword">double</span> delta<span class="token punctuation">,</span> <span class="token keyword">int</span> borderType<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> borderTypeValue <span class="token operator">=</span> borderType <span class="token operator">&amp;</span> <span class="token operator">~</span>BORDER_ISOLATED<span class="token punctuation">;</span>
    Mat kernel <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span>kernel_width<span class="token punctuation">,</span> kernel_height<span class="token punctuation">)</span><span class="token punctuation">,</span> kernel_type<span class="token punctuation">,</span> kernel_data<span class="token punctuation">,</span> kernel_step<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>FilterEngine<span class="token operator">></span> f <span class="token operator">=</span> <span class="token function">createLinearFilter</span><span class="token punctuation">(</span>stype<span class="token punctuation">,</span> dtype<span class="token punctuation">,</span> kernel<span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>anchor_x<span class="token punctuation">,</span> anchor_y<span class="token punctuation">)</span><span class="token punctuation">,</span> delta<span class="token punctuation">,</span>
                                             borderTypeValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat <span class="token function">src</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span> stype<span class="token punctuation">,</span> src_data<span class="token punctuation">,</span> src_step<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat <span class="token function">dst</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token punctuation">,</span> dst_data<span class="token punctuation">,</span> dst_step<span class="token punctuation">)</span><span class="token punctuation">;</span>
    f<span class="token operator">-</span><span class="token operator">></span><span class="token function">apply</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span>full_width<span class="token punctuation">,</span> full_height<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>offset_x<span class="token punctuation">,</span> offset_y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时，先初始化一个FilterEngine(线性滤波引擎)，接着使用apply调用滤波引擎的执行方法。</p>
<p>我们来看看线性引擎的创建：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Ptr<span class="token operator">&lt;</span>cv<span class="token operator">::</span>FilterEngine<span class="token operator">></span> <span class="token function">createLinearFilter</span><span class="token punctuation">(</span>
        <span class="token keyword">int</span> _srcType<span class="token punctuation">,</span> <span class="token keyword">int</span> _dstType<span class="token punctuation">,</span>
        InputArray filter_kernel<span class="token punctuation">,</span>
        Point _anchor<span class="token punctuation">,</span> <span class="token keyword">double</span> _delta<span class="token punctuation">,</span>
        <span class="token keyword">int</span> _rowBorderType<span class="token punctuation">,</span> <span class="token keyword">int</span> _columnBorderType<span class="token punctuation">,</span>
        <span class="token keyword">const</span> Scalar<span class="token operator">&amp;</span> _borderValue<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Mat _kernel <span class="token operator">=</span> filter_kernel<span class="token punctuation">.</span><span class="token function">getMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _srcType <span class="token operator">=</span> <span class="token function">CV_MAT_TYPE</span><span class="token punctuation">(</span>_srcType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _dstType <span class="token operator">=</span> <span class="token function">CV_MAT_TYPE</span><span class="token punctuation">(</span>_dstType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cn <span class="token operator">=</span> <span class="token function">CV_MAT_CN</span><span class="token punctuation">(</span>_srcType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CV_Assert</span><span class="token punctuation">(</span> cn <span class="token operator">==</span> <span class="token function">CV_MAT_CN</span><span class="token punctuation">(</span>_dstType<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    Mat kernel <span class="token operator">=</span> _kernel<span class="token punctuation">;</span>
    <span class="token keyword">int</span> bits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    Ptr<span class="token operator">&lt;</span>BaseFilter<span class="token operator">></span> _filter2D <span class="token operator">=</span> <span class="token function">getLinearFilter</span><span class="token punctuation">(</span>_srcType<span class="token punctuation">,</span> _dstType<span class="token punctuation">,</span>
        kernel<span class="token punctuation">,</span> _anchor<span class="token punctuation">,</span> _delta<span class="token punctuation">,</span> bits<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> makePtr<span class="token operator">&lt;</span>FilterEngine<span class="token operator">></span><span class="token punctuation">(</span>_filter2D<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span>BaseRowFilter<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Ptr<span class="token operator">&lt;</span>BaseColumnFilter<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _srcType<span class="token punctuation">,</span> _dstType<span class="token punctuation">,</span> _srcType<span class="token punctuation">,</span>
        _rowBorderType<span class="token punctuation">,</span> _columnBorderType<span class="token punctuation">,</span> _borderValue <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上在这个过程中通过makePtr创建一个sharedptr的指针指向FilterEngine，其原理和Android的智能指针相似。</p>
<p>这个引擎不是关键关键的是getLinearFilter，这个方法创建了一个线性滤波器的实际操作对象。</p>
<p>我们来看看这个结构体：<br>能看到这里面会根据次数传进来的目标矩阵和原始矩阵的位深创建不同的滤波操作者。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Ptr<span class="token operator">&lt;</span>BaseFilter<span class="token operator">></span> <span class="token function">getLinearFilter</span><span class="token punctuation">(</span>
        <span class="token keyword">int</span> srcType<span class="token punctuation">,</span> <span class="token keyword">int</span> dstType<span class="token punctuation">,</span>
        <span class="token keyword">const</span> Mat<span class="token operator">&amp;</span> _kernel<span class="token punctuation">,</span> Point anchor<span class="token punctuation">,</span>
        <span class="token keyword">double</span> delta<span class="token punctuation">,</span> <span class="token keyword">int</span> bits<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">CV_INSTRUMENT_REGION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> sdepth <span class="token operator">=</span> <span class="token function">CV_MAT_DEPTH</span><span class="token punctuation">(</span>srcType<span class="token punctuation">)</span><span class="token punctuation">,</span> ddepth <span class="token operator">=</span> <span class="token function">CV_MAT_DEPTH</span><span class="token punctuation">(</span>dstType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cn <span class="token operator">=</span> <span class="token function">CV_MAT_CN</span><span class="token punctuation">(</span>srcType<span class="token punctuation">)</span><span class="token punctuation">,</span> kdepth <span class="token operator">=</span> _kernel<span class="token punctuation">.</span><span class="token function">depth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CV_Assert</span><span class="token punctuation">(</span> cn <span class="token operator">==</span> <span class="token function">CV_MAT_CN</span><span class="token punctuation">(</span>dstType<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ddepth <span class="token operator">>=</span> sdepth <span class="token punctuation">)</span><span class="token punctuation">;</span>

    anchor <span class="token operator">=</span> <span class="token function">normalizeAnchor</span><span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> _kernel<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*if( sdepth == CV_8U &amp;&amp; ddepth == CV_8U &amp;&amp; kdepth == CV_32S )
        return makePtr&lt;Filter2D&lt;uchar, FixedPtCastEx&lt;int, uchar>, FilterVec_8u> >
            (_kernel, anchor, delta, FixedPtCastEx&lt;int, uchar>(bits),
            FilterVec_8u(_kernel, bits, delta));
    if( sdepth == CV_8U &amp;&amp; ddepth == CV_16S &amp;&amp; kdepth == CV_32S )
        return makePtr&lt;Filter2D&lt;uchar, FixedPtCastEx&lt;int, short>, FilterVec_8u16s> >
            (_kernel, anchor, delta, FixedPtCastEx&lt;int, short>(bits),
            FilterVec_8u16s(_kernel, bits, delta));*/</span>

    kdepth <span class="token operator">=</span> sdepth <span class="token operator">==</span> CV_64F <span class="token operator">||</span> ddepth <span class="token operator">==</span> CV_64F <span class="token operator">?</span> CV_64F <span class="token operator">:</span> CV_32F<span class="token punctuation">;</span>
    Mat kernel<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> _kernel<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kdepth <span class="token punctuation">)</span>
        kernel <span class="token operator">=</span> _kernel<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        _kernel<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>kernel<span class="token punctuation">,</span> kdepth<span class="token punctuation">,</span> _kernel<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> CV_32S <span class="token operator">?</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> bits<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> sdepth <span class="token operator">==</span> CV_8U <span class="token operator">&amp;&amp;</span> ddepth <span class="token operator">==</span> CV_8U <span class="token punctuation">)</span>
        <span class="token keyword">return</span> makePtr<span class="token operator">&lt;</span>Filter2D<span class="token operator">&lt;</span>uchar<span class="token punctuation">,</span> Cast<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">,</span> uchar<span class="token operator">></span><span class="token punctuation">,</span> FilterVec_8u<span class="token operator">></span> <span class="token operator">></span>
            <span class="token punctuation">(</span>kernel<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> delta<span class="token punctuation">,</span> Cast<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">,</span> uchar<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">FilterVec_8u</span><span class="token punctuation">(</span>kernel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> delta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> sdepth <span class="token operator">==</span> CV_8U <span class="token operator">&amp;&amp;</span> ddepth <span class="token operator">==</span> CV_16U <span class="token punctuation">)</span>
        <span class="token keyword">return</span> makePtr<span class="token operator">&lt;</span>Filter2D<span class="token operator">&lt;</span>uchar<span class="token punctuation">,</span>
            Cast<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">,</span> ushort<span class="token operator">></span><span class="token punctuation">,</span> FilterNoVec<span class="token operator">></span> <span class="token operator">></span><span class="token punctuation">(</span>kernel<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//根据位深创建不同的滤波操作者</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">CV_Error_</span><span class="token punctuation">(</span> CV_StsNotImplemented<span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">"Unsupported combination of source format (=%d), and destination format (=%d)"</span><span class="token punctuation">,</span>
        srcType<span class="token punctuation">,</span> dstType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>假设，我们现在原图和目标图都是8位位深的矩阵，我们只需要关注下面这个构造函数。</p>
<pre><code>        return makePtr&lt;Filter2D&lt;uchar, Cast&lt;float, uchar&gt;, FilterVec_8u&gt; &gt;
            (kernel, anchor, delta, Cast&lt;float, uchar&gt;(), FilterVec_8u(kernel, 0, delta));</code></pre><h3 id="Fliter2D结构体"><a href="#Fliter2D结构体" class="headerlink" title="Fliter2D结构体"></a>Fliter2D结构体</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> ST<span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">CastOp</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">VecOp</span><span class="token operator">></span> <span class="token keyword">struct</span> Filter2D <span class="token operator">:</span> <span class="token keyword">public</span> BaseFilter
<span class="token punctuation">{</span>
    <span class="token keyword">typedef</span> <span class="token keyword">typename</span> CastOp<span class="token operator">::</span>type1 KT<span class="token punctuation">;</span>
    <span class="token keyword">typedef</span> <span class="token keyword">typename</span> CastOp<span class="token operator">::</span>rtype DT<span class="token punctuation">;</span>

    <span class="token function">Filter2D</span><span class="token punctuation">(</span> <span class="token keyword">const</span> Mat<span class="token operator">&amp;</span> _kernel<span class="token punctuation">,</span> Point _anchor<span class="token punctuation">,</span>
        <span class="token keyword">double</span> _delta<span class="token punctuation">,</span> <span class="token keyword">const</span> CastOp<span class="token operator">&amp;</span> _castOp<span class="token operator">=</span><span class="token function">CastOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">const</span> VecOp<span class="token operator">&amp;</span> _vecOp<span class="token operator">=</span><span class="token function">VecOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        anchor <span class="token operator">=</span> _anchor<span class="token punctuation">;</span>
        ksize <span class="token operator">=</span> _kernel<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delta <span class="token operator">=</span> saturate_cast<span class="token operator">&lt;</span>KT<span class="token operator">></span><span class="token punctuation">(</span>_delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
        castOp0 <span class="token operator">=</span> _castOp<span class="token punctuation">;</span>
        vecOp <span class="token operator">=</span> _vecOp<span class="token punctuation">;</span>
        <span class="token function">CV_Assert</span><span class="token punctuation">(</span> _kernel<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> DataType<span class="token operator">&lt;</span>KT<span class="token operator">></span><span class="token operator">::</span>type <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">preprocess2DKernel</span><span class="token punctuation">(</span> _kernel<span class="token punctuation">,</span> coords<span class="token punctuation">,</span> coeffs <span class="token punctuation">)</span><span class="token punctuation">;</span>
        ptrs<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span> coords<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> uchar<span class="token operator">*</span><span class="token operator">*</span> src<span class="token punctuation">,</span> uchar<span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">int</span> dststep<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> cn<span class="token punctuation">)</span> CV_OVERRIDE
    <span class="token punctuation">{</span>
        KT _delta <span class="token operator">=</span> delta<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//拿到所有权重不为0的像素点位置</span>
        <span class="token keyword">const</span> Point<span class="token operator">*</span> pt <span class="token operator">=</span> <span class="token operator">&amp;</span>coords<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//拿到所有的像素值</span>
        <span class="token keyword">const</span> KT<span class="token operator">*</span> kf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> KT<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>coeffs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> ST<span class="token operator">*</span><span class="token operator">*</span> kp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> ST<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ptrs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">,</span> k<span class="token punctuation">,</span> nz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>coords<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CastOp castOp <span class="token operator">=</span> castOp0<span class="token punctuation">;</span>

        width <span class="token operator">*</span><span class="token operator">=</span> cn<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> count<span class="token operator">--</span><span class="token punctuation">,</span> dst <span class="token operator">+</span><span class="token operator">=</span> dststep<span class="token punctuation">,</span> src<span class="token operator">++</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            DT<span class="token operator">*</span> D <span class="token operator">=</span> <span class="token punctuation">(</span>DT<span class="token operator">*</span><span class="token punctuation">)</span>dst<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//把原图每一次需要计算的点</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> nz<span class="token punctuation">;</span> k<span class="token operator">++</span> <span class="token punctuation">)</span>
                kp<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> ST<span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token punctuation">[</span>pt<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">+</span> pt<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token operator">*</span>cn<span class="token punctuation">;</span>

            i <span class="token operator">=</span> <span class="token function">vecOp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> uchar<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>kp<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">#<span class="token directive keyword">if</span> CV_ENABLE_UNROLLED</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> width <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span> i <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                KT s0 <span class="token operator">=</span> _delta<span class="token punctuation">,</span> s1 <span class="token operator">=</span> _delta<span class="token punctuation">,</span> s2 <span class="token operator">=</span> _delta<span class="token punctuation">,</span> s3 <span class="token operator">=</span> _delta<span class="token punctuation">;</span>

                <span class="token keyword">for</span><span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> nz<span class="token punctuation">;</span> k<span class="token operator">++</span> <span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> ST<span class="token operator">*</span> sptr <span class="token operator">=</span> kp<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
                    KT f <span class="token operator">=</span> kf<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    s0 <span class="token operator">+</span><span class="token operator">=</span> f<span class="token operator">*</span>sptr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    s1 <span class="token operator">+</span><span class="token operator">=</span> f<span class="token operator">*</span>sptr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    s2 <span class="token operator">+</span><span class="token operator">=</span> f<span class="token operator">*</span>sptr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    s3 <span class="token operator">+</span><span class="token operator">=</span> f<span class="token operator">*</span>sptr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                D<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">castOp</span><span class="token punctuation">(</span>s0<span class="token punctuation">)</span><span class="token punctuation">;</span> D<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">castOp</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                D<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">castOp</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span> D<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">castOp</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token macro property">#<span class="token directive keyword">endif</span></span>
            <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                KT s0 <span class="token operator">=</span> _delta<span class="token punctuation">;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> nz<span class="token punctuation">;</span> k<span class="token operator">++</span> <span class="token punctuation">)</span>
                    s0 <span class="token operator">+</span><span class="token operator">=</span> kf<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token operator">*</span>kp<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                D<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">castOp</span><span class="token punctuation">(</span>s0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Point<span class="token operator">></span> coords<span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>uchar<span class="token operator">></span> coeffs<span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>uchar<span class="token operator">*</span><span class="token operator">></span> ptrs<span class="token punctuation">;</span>
    KT delta<span class="token punctuation">;</span>
    CastOp castOp0<span class="token punctuation">;</span>
    VecOp vecOp<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Fliter2D结构体持有着模糊中心点，核，原/目标矩阵， 可以猜测到实际上正在做操作的就是这个结构体。</p>
<p>在preprocess2DKernel方法中，Fliter2D把核的相关信息存储到coords，coeffs中</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    uchar<span class="token operator">*</span> _coeffs <span class="token operator">=</span> <span class="token operator">&amp;</span>coeffs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> kernel<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">const</span> uchar<span class="token operator">*</span> krow <span class="token operator">=</span> kernel<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> kernel<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> ktype <span class="token operator">==</span> CV_8U <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                uchar val <span class="token operator">=</span> krow<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> val <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                coords<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Point</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _coeffs<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到此时会判断当前的核矩阵中type是什么，接着再把矩阵中每一个不为0的位置设置进coords，像素数值设置到_coeffs。此时相当于把核矩阵展开成一个向量。</p>
<h3 id="滤波引擎的执行流程"><a href="#滤波引擎的执行流程" class="headerlink" title="滤波引擎的执行流程"></a>滤波引擎的执行流程</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">FilterEngine__apply</span><span class="token punctuation">(</span>FilterEngine<span class="token operator">&amp;</span> this_<span class="token punctuation">,</span> <span class="token keyword">const</span> Mat<span class="token operator">&amp;</span> src<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> dst<span class="token punctuation">,</span> <span class="token keyword">const</span> Size<span class="token operator">&amp;</span> wsz<span class="token punctuation">,</span> <span class="token keyword">const</span> Point<span class="token operator">&amp;</span> ofs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">CV_INSTRUMENT_REGION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CV_DbgAssert</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> this_<span class="token punctuation">.</span>srcType <span class="token operator">&amp;&amp;</span> dst<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> this_<span class="token punctuation">.</span>dstType<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">FilterEngine__start</span><span class="token punctuation">(</span>this_<span class="token punctuation">,</span> wsz<span class="token punctuation">,</span> src<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ofs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> y <span class="token operator">=</span> this_<span class="token punctuation">.</span>startY <span class="token operator">-</span> ofs<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token function">FilterEngine__proceed</span><span class="token punctuation">(</span>this_<span class="token punctuation">,</span>
            src<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token operator">*</span>src<span class="token punctuation">.</span>step<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>src<span class="token punctuation">.</span>step<span class="token punctuation">,</span>
            this_<span class="token punctuation">.</span>endY <span class="token operator">-</span> this_<span class="token punctuation">.</span>startY<span class="token punctuation">,</span>
            dst<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>dst<span class="token punctuation">.</span>step <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时滤波引擎会先调用FilterEngine__start，再调用FilterEngine__proceed执行计算。<br>实际上在FilterEngine__start中计算的是本次循环，需要计算的边界。</p>
<p>FilterEngine__proceed中才是正式计算，做dst循环，最后把具体操作丢给线性引擎生成的Fliter2D的方法中。</p>
<h3 id="fliter运作原理"><a href="#fliter运作原理" class="headerlink" title="fliter运作原理"></a>fliter运作原理</h3><p>了解这两个东西我们直接抽出核心看看fliter是如何运作：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span> dst <span class="token operator">+</span><span class="token operator">=</span> dststep<span class="token operator">*</span>i<span class="token punctuation">,</span> dy <span class="token operator">+</span><span class="token operator">=</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//计算每一列的矩阵中有多少像素，以及步长是多少</span>
        <span class="token keyword">int</span> dcount <span class="token operator">=</span> bufRows <span class="token operator">-</span> ay <span class="token operator">-</span> this_<span class="token punctuation">.</span>startY <span class="token operator">-</span> this_<span class="token punctuation">.</span>rowCount <span class="token operator">+</span> this_<span class="token punctuation">.</span>roi<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        dcount <span class="token operator">=</span> dcount <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> dcount <span class="token operator">:</span> bufRows <span class="token operator">-</span> kheight <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        dcount <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>dcount<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        count <span class="token operator">-</span><span class="token operator">=</span> dcount<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//获取到目标的矩阵的一行的像素长度，则开始循环原矩阵的像素</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> dcount<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> src <span class="token operator">+</span><span class="token operator">=</span> srcstep <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//计算每一行像素开始读取的起点</span>
            <span class="token keyword">int</span> bi <span class="token operator">=</span> <span class="token punctuation">(</span>this_<span class="token punctuation">.</span>startY <span class="token operator">-</span> this_<span class="token punctuation">.</span>startY0 <span class="token operator">+</span> this_<span class="token punctuation">.</span>rowCount<span class="token punctuation">)</span> <span class="token operator">%</span> bufRows<span class="token punctuation">;</span>
            uchar<span class="token operator">*</span> brow <span class="token operator">=</span> <span class="token function">alignPtr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>this_<span class="token punctuation">.</span>ringBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> VEC_ALIGN<span class="token punctuation">)</span> <span class="token operator">+</span> bi<span class="token operator">*</span>this_<span class="token punctuation">.</span>bufStep<span class="token punctuation">;</span>
            uchar<span class="token operator">*</span> row <span class="token operator">=</span> isSep <span class="token operator">?</span> <span class="token operator">&amp;</span>this_<span class="token punctuation">.</span>srcRow<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> brow<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>this_<span class="token punctuation">.</span>rowCount <span class="token operator">></span> bufRows<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token operator">--</span>this_<span class="token punctuation">.</span>rowCount<span class="token punctuation">;</span>
                <span class="token operator">++</span>this_<span class="token punctuation">.</span>startY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//拷贝数据到row的起点+边缘，长度为添加的像素的一行-左边padding-右边padding</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span> row <span class="token operator">+</span> _dx1<span class="token operator">*</span>esz<span class="token punctuation">,</span> src<span class="token punctuation">,</span> <span class="token punctuation">(</span>width1 <span class="token operator">-</span> _dx2 <span class="token operator">-</span> _dx1<span class="token punctuation">)</span><span class="token operator">*</span>esz <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//如果设置边缘</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> makeBorder <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> btab_esz<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">==</span> esz <span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">*</span> isrc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token punctuation">;</span>
                    <span class="token keyword">int</span><span class="token operator">*</span> irow <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>row<span class="token punctuation">;</span>

                    <span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _dx1<span class="token operator">*</span>btab_esz<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
                        irow<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> isrc<span class="token punctuation">[</span>btab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _dx2<span class="token operator">*</span>btab_esz<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
                        irow<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token punctuation">(</span>width1 <span class="token operator">-</span> _dx2<span class="token punctuation">)</span><span class="token operator">*</span>btab_esz<span class="token punctuation">]</span> <span class="token operator">=</span> isrc<span class="token punctuation">[</span>btab<span class="token punctuation">[</span>i<span class="token operator">+</span>_dx1<span class="token operator">*</span>btab_esz<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//由于上面计算的去掉了边缘，这里要加上需要的边缘，分别复制到左右两侧</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _dx1<span class="token operator">*</span>esz<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
                        row<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">[</span>btab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _dx2<span class="token operator">*</span>esz<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
                        row<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token punctuation">(</span>width1 <span class="token operator">-</span> _dx2<span class="token punctuation">)</span><span class="token operator">*</span>esz<span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">[</span>btab<span class="token punctuation">[</span>i<span class="token operator">+</span>_dx1<span class="token operator">*</span>esz<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//如果是可分离的滤波则调用rowFilter分离处理每行的数据</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> isSep <span class="token punctuation">)</span>
                <span class="token punctuation">(</span><span class="token operator">*</span>this_<span class="token punctuation">.</span>rowFilter<span class="token punctuation">)</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> brow<span class="token punctuation">,</span> width<span class="token punctuation">,</span> <span class="token function">CV_MAT_CN</span><span class="token punctuation">(</span>this_<span class="token punctuation">.</span>srcType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//准备好每一行之后数据空间，是时候计算每一列的数据，算出要循环多少列</span>
        <span class="token keyword">int</span> max_i <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>bufRows<span class="token punctuation">,</span> this_<span class="token punctuation">.</span>roi<span class="token punctuation">.</span>height <span class="token operator">-</span> <span class="token punctuation">(</span>this_<span class="token punctuation">.</span>dstY <span class="token operator">+</span> dy<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>kheight <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max_i<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//行的边缘处理了，需要处理列的边缘。这里计算需要开始计算的列的起点</span>
            <span class="token keyword">int</span> srcY <span class="token operator">=</span> <span class="token function">borderInterpolate</span><span class="token punctuation">(</span>this_<span class="token punctuation">.</span>dstY <span class="token operator">+</span> dy <span class="token operator">+</span> i <span class="token operator">+</span> this_<span class="token punctuation">.</span>roi<span class="token punctuation">.</span>y <span class="token operator">-</span> ay<span class="token punctuation">,</span>
                    this_<span class="token punctuation">.</span>wholeSize<span class="token punctuation">.</span>height<span class="token punctuation">,</span> this_<span class="token punctuation">.</span>columnBorderType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> srcY <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// can happen only with constant border type</span>
                brows<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">alignPtr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>this_<span class="token punctuation">.</span>constBorderRow<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> VEC_ALIGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">CV_Assert</span><span class="token punctuation">(</span>srcY <span class="token operator">>=</span> this_<span class="token punctuation">.</span>startY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> srcY <span class="token operator">>=</span> this_<span class="token punctuation">.</span>startY <span class="token operator">+</span> this_<span class="token punctuation">.</span>rowCount<span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> bi <span class="token operator">=</span> <span class="token punctuation">(</span>srcY <span class="token operator">-</span> this_<span class="token punctuation">.</span>startY0<span class="token punctuation">)</span> <span class="token operator">%</span> bufRows<span class="token punctuation">;</span>
                brows<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">alignPtr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>this_<span class="token punctuation">.</span>ringBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> VEC_ALIGN<span class="token punctuation">)</span> <span class="token operator">+</span> bi<span class="token operator">*</span>this_<span class="token punctuation">.</span>bufStep<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> i <span class="token operator">&lt;</span> kheight <span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        i <span class="token operator">-</span><span class="token operator">=</span> kheight <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//开始调用filter2D构造函数中operate()</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSep<span class="token punctuation">)</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>this_<span class="token punctuation">.</span>columnFilter<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> uchar<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>brows<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> dststep<span class="token punctuation">,</span> i<span class="token punctuation">,</span> this_<span class="token punctuation">.</span>roi<span class="token punctuation">.</span>width<span class="token operator">*</span>cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>this_<span class="token punctuation">.</span>filter2D<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> uchar<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>brows<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> dststep<span class="token punctuation">,</span> i<span class="token punctuation">,</span> this_<span class="token punctuation">.</span>roi<span class="token punctuation">.</span>width<span class="token punctuation">,</span> cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面Fliter2D结构体小结，实际上这里的核心操作如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">i <span class="token operator">=</span> <span class="token function">vecOp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> uchar<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>kp<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>而vecOp在此时指的是FilterVec_8u结构体,我们同样去看看这个构造体做了什么：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> uchar<span class="token operator">*</span><span class="token operator">*</span> src<span class="token punctuation">,</span> uchar<span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">)</span> <span class="token keyword">const</span>
    <span class="token punctuation">{</span>
        <span class="token function">CV_INSTRUMENT_REGION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">CV_DbgAssert</span><span class="token punctuation">(</span>_nz <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//这个也是把核转化为行向量</span>
        <span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> kf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>coeffs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> nz <span class="token operator">=</span> _nz<span class="token punctuation">;</span>

        v_float32 d4 <span class="token operator">=</span> <span class="token function">vx_setall_f32</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
        v_float32 f0 <span class="token operator">=</span> <span class="token function">vx_setall_f32</span><span class="token punctuation">(</span>kf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//循环宽度，长度是width-16，步数是16</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> width <span class="token operator">-</span> v_uint8<span class="token operator">::</span>nlanes<span class="token punctuation">;</span> i <span class="token operator">+</span><span class="token operator">=</span> v_uint8<span class="token operator">::</span>nlanes <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            v_uint16 xl<span class="token punctuation">,</span> xh<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//读取原图中需要处理像素的开始位置，并且把数据分为上下高低两个16位</span>
            <span class="token function">v_expand</span><span class="token punctuation">(</span><span class="token function">vx_load</span><span class="token punctuation">(</span>src<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> xl<span class="token punctuation">,</span> xh<span class="token punctuation">)</span><span class="token punctuation">;</span>
            v_uint32 x0<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> x3<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//高低16位再次分成上下两个8位</span>
            <span class="token function">v_expand</span><span class="token punctuation">(</span>xl<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">v_expand</span><span class="token punctuation">(</span>xh<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//v_muladd这里做的事情是s0 = x0*f0+d4</span>
<span class="token comment" spellcheck="true">//f0:核心矩阵的第一个元素，d4就是一个额外线性权重</span>
            v_float32 s0 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f0<span class="token punctuation">,</span> d4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            v_float32 s1 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f0<span class="token punctuation">,</span> d4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            v_float32 s2 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f0<span class="token punctuation">,</span> d4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            v_float32 s3 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f0<span class="token punctuation">,</span> d4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> nz<span class="token punctuation">;</span> k<span class="token operator">++</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                v_float32 f <span class="token operator">=</span> <span class="token function">vx_setall_f32</span><span class="token punctuation">(</span>kf<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">v_expand</span><span class="token punctuation">(</span><span class="token function">vx_load</span><span class="token punctuation">(</span>src<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> xl<span class="token punctuation">,</span> xh<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">v_expand</span><span class="token punctuation">(</span>xl<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">v_expand</span><span class="token punctuation">(</span>xh<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//计算第一个之后，基于第一个重新计算s0 = x0 * f + s0</span>
                s0 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> s0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                s1 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                s2 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                s3 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> s3<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">v_store</span><span class="token punctuation">(</span>dst <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token function">v_pack_u</span><span class="token punctuation">(</span><span class="token function">v_pack</span><span class="token punctuation">(</span><span class="token function">v_round</span><span class="token punctuation">(</span>s0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">v_round</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">v_pack</span><span class="token punctuation">(</span><span class="token function">v_round</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">v_round</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//如果发现i在宽度width - 16内，说明还没有循环完原图，但是核的步数太大而没走到</span>
<span class="token comment" spellcheck="true">//处理剩余的数据，按照16位不断的前进处理</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> i <span class="token operator">&lt;=</span> width <span class="token operator">-</span> v_uint16<span class="token operator">::</span>nlanes <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            v_uint32 x0<span class="token punctuation">,</span> x1<span class="token punctuation">;</span>
            <span class="token function">v_expand</span><span class="token punctuation">(</span><span class="token function">vx_load_expand</span><span class="token punctuation">(</span>src<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> x0<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            v_float32 s0 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f0<span class="token punctuation">,</span> d4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            v_float32 s1 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f0<span class="token punctuation">,</span> d4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> nz<span class="token punctuation">;</span> k<span class="token operator">++</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                v_float32 f <span class="token operator">=</span> <span class="token function">vx_setall_f32</span><span class="token punctuation">(</span>kf<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">v_expand</span><span class="token punctuation">(</span><span class="token function">vx_load_expand</span><span class="token punctuation">(</span>src<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> x0<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                s0 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> s0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                s1 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span>x1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">v_pack_u_store</span><span class="token punctuation">(</span>dst <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token function">v_pack</span><span class="token punctuation">(</span><span class="token function">v_round</span><span class="token punctuation">(</span>s0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">v_round</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i <span class="token operator">+</span><span class="token operator">=</span> v_uint16<span class="token operator">::</span>nlanes<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">if</span> CV_SIMD_WIDTH > 16</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span> i <span class="token operator">&lt;=</span> width <span class="token operator">-</span> v_int32x4<span class="token operator">::</span>nlanes <span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token comment" spellcheck="true">//发现处理完之后，i还在width-4内，说明16的步数太大，再度按照步数4处理数据</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> i <span class="token operator">&lt;=</span> width <span class="token operator">-</span> v_int32x4<span class="token operator">::</span>nlanes <span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token punctuation">{</span>
            v_float32x4 s0 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span><span class="token function">v_load_expand_q</span><span class="token punctuation">(</span>src<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">v_setall_f32</span><span class="token punctuation">(</span>kf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">v_setall_f32</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> nz<span class="token punctuation">;</span> k<span class="token operator">++</span> <span class="token punctuation">)</span>
                s0 <span class="token operator">=</span> <span class="token function">v_muladd</span><span class="token punctuation">(</span><span class="token function">v_cvt_f32</span><span class="token punctuation">(</span><span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span><span class="token function">v_load_expand_q</span><span class="token punctuation">(</span>src<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">v_setall_f32</span><span class="token punctuation">(</span>kf<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            v_int32x4 s32 <span class="token operator">=</span> <span class="token function">v_round</span><span class="token punctuation">(</span>s0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            v_int16x8 s16 <span class="token operator">=</span> <span class="token function">v_pack</span><span class="token punctuation">(</span>s32<span class="token punctuation">,</span> s32<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span><span class="token punctuation">(</span>unaligned_int<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dst <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">v_reinterpret_as_s32</span><span class="token punctuation">(</span><span class="token function">v_pack_u</span><span class="token punctuation">(</span>s16<span class="token punctuation">,</span> s16<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i <span class="token operator">+</span><span class="token operator">=</span> v_int32x4<span class="token operator">::</span>nlanes<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要的流程在注释已经解释了。这里再度总结一下：<br>其核心逻辑如下，把原图和核转化一个行向量，如下图<br><img src="/images/fliter2d%E5%8E%9F%E7%90%86.png" alt="fliter2d原理.png"></p>
<p>但是，fliter2d担心核心每一步走的太大。因此当走完循环，则会检查此时i指针是否已经走完一行中所有的数据(一行的数据量-16)，没有则按照16位的步数再处理剩下，接着再检查(一行的数据量-4),还在这个范围，说明这个时候还有数据没有处理，则按照4位的前进处理。</p>
<p>可以看到opencv的确实比我们的demo严谨很多。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个掩码以及平滑操作，实际上是计算机图像学中的基础。经过对opencv的源码解析，相信各位对掩码操作有更加深刻的理解。</p>
<p>但是，这里我并有写高斯模糊的源码解析也没有对dst(离散傅立叶变换)进行解析，因为其核心和fliter相似，也是计算自相关。</p>
<p>可惜的是，篇幅原因，第二个是本人对dst虽然有一定的了解，但是要提炼成文字还需要一定火候以及更加深刻的理解。相信不久的将来，我会和大家解析我没有解析在大核情况下，使用dst(离散傅立叶变换)的opencv原理。</p>
<p>这也是第一次让我看源码感到十分吃力，明明我的主张就是源码在手天下我有的态度，看来我的数学基础还需要进一步补充。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/08/15/android-chong-xue-xi-lie-wms-zai-activity-qi-dong-zhong-de-zhi-ze-yi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Android 重学系列 WMS在Activity启动中的职责(一)">
                        
                        <span class="card-title">Android 重学系列 WMS在Activity启动中的职责(一)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言好久没有继续写Android重学系列了。这次我们继续聊聊当Activity创建之后。Android接下来就会尝试的显示界面ui。此时就会牵扯到一个核心的服务WindowManagerService(当然Activity的启动也牵扯到了W
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-08-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/WMS/" class="post-category">
                                    WMS
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/07/27/opengl-wen-li-ji-chu-yu-suo-yin/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="OpenGL (三)纹理基础与索引">
                        
                        <span class="card-title">OpenGL (三)纹理基础与索引</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言OpenGL的纹理实际上运用十分广泛，是OpenGL中的重点。如果你有看过Android底层的绘制原理，能够发现实际上，一般的ui界面，Android把会把像素点当作纹理数据绘制在屏幕上。
因此还是有必要稍微学习一下OpenGL的纹理。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-07-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/OpenGL/" class="post-category">
                                    OpenGL
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/OpenGL/">
                        <span class="chip bg-color">OpenGL</span>
                    </a>
                    
                    <a href="/tags/音视频/">
                        <span class="chip bg-color">音视频</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
