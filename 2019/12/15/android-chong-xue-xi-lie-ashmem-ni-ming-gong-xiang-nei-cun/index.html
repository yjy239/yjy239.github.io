<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 Ashmem匿名共享内存, Android | Linux | Flutter">
    <meta name="description" content="前言本文让我们来聊聊匿名共享内存Ashmem。Ashmem为什么会诞生？共享内存本质上还是为了方便跨进程通信，减少拷贝次数，提高性能。
遇到问题可以来本文讨论https://www.jianshu.com/p/6a8513fdb792
但是">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 Ashmem匿名共享内存 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 Ashmem匿名共享内存
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Linux/">
                                <span class="chip bg-color">Linux</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android-Framework/" class="post-category">
                                Android Framework
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-12-15
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        8.2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        36 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文让我们来聊聊匿名共享内存Ashmem。Ashmem为什么会诞生？共享内存本质上还是为了方便跨进程通信，减少拷贝次数，提高性能。</p>
<p>遇到问题可以来本文讨论<a href="https://www.jianshu.com/p/6a8513fdb792" target="_blank" rel="noopener">https://www.jianshu.com/p/6a8513fdb792</a></p>
<p>但是我们Android不是已经有了Binder这个跨进程通信利器吗？为什么还需要匿名共享内存？让我们先看看Binder初始化时候这行代码。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/" target="_blank" rel="noopener">binder</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/ProcessState.cpp" target="_blank" rel="noopener">ProcessState.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> BINDER_VM_SIZE ((1 * 1024 * 1024) - sysconf(_SC_PAGE_SIZE) * 2)</span>
ProcessState<span class="token operator">::</span><span class="token function">ProcessState</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>driver<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">mDriverName</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mDriverFD</span><span class="token punctuation">(</span><span class="token function">open_driver</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mVMStart</span><span class="token punctuation">(</span>MAP_FAILED<span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mThreadCountLock</span><span class="token punctuation">(</span>PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mThreadCountDecrement</span><span class="token punctuation">(</span>PTHREAD_COND_INITIALIZER<span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mExecutingThreadsCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mMaxThreads</span><span class="token punctuation">(</span>DEFAULT_MAX_BINDER_THREADS<span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mStarvationStartTimeMs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mManagesContexts</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mBinderContextCheckFunc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mBinderContextUserData</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mThreadPoolStarted</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">mThreadPoolSeq</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDriverFD <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// mmap the binder, providing a chunk of virtual address space to receive transactions.</span>
        mVMStart <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> BINDER_VM_SIZE<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE <span class="token operator">|</span> MAP_NORESERVE<span class="token punctuation">,</span> mDriverFD<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到应用在初始化Binder的时候，已经限制了大小为1M-2页(1页=4k)的大小也就是1016k大小，如果只是传输命令的话还可以，但是要传输图像数据这个大小根本不够。</p>
<p>加上Binder内部有对每一个Binder内核缓冲区有自己的调度算法，没办法满足以最快的速度传输到SF进程中。也因此，Android选择使用共享内存的方式传递数据，也就是Ashmem匿名内存。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>其实Ashmem不仅仅只是内核中能够使用，其实在Java层Android也提供了一个名为MemoryFile的类提供方便使用匿名共享内存，本次就以MemoryFile为切口，来聊聊Ashmem匿名内存的使用。</p>
<p>老规矩，先来看看MemoryFile是如何使用的。</p>
<pre class="line-numbers language-java"><code class="language-java">MemoryFile memoryFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//构建一个共享内存</span>
            memoryFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryFile</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            OutputStream o <span class="token operator">=</span> memoryFile<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            bs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//写入</span>
            o<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            o<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//读出</span>
            InputStream in <span class="token operator">=</span> memoryFile<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> r <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"r"</span><span class="token punctuation">,</span><span class="token string">"r:"</span><span class="token operator">+</span>bs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>memoryFile <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
                memoryFile<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到操作和普通的File操作一模一样，好像根本没有什么区别。File本身也可以作为数据中转站做传递信息。那么MemoryFile比起普通的File优势强在哪里呢？接下来，让我们剖析一下源码，来比较看看匿名内存和File相比有什么区别，和Binder驱动又有什么区别。</p>
<h2 id="MemoryFile源码解析"><a href="#MemoryFile源码解析" class="headerlink" title="MemoryFile源码解析"></a>MemoryFile源码解析</h2><h3 id="MemoryFile的创建"><a href="#MemoryFile的创建" class="headerlink" title="MemoryFile的创建"></a>MemoryFile的创建</h3><p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/" target="_blank" rel="noopener">os</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/MemoryFile.java" target="_blank" rel="noopener">MemoryFile.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">MemoryFile</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mSharedMemory <span class="token operator">=</span> SharedMemory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mMapping <span class="token operator">=</span> mSharedMemory<span class="token punctuation">.</span><span class="token function">mapReadWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ex<span class="token punctuation">.</span><span class="token function">rethrowAsIOException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上MemoryFile内部有一个核心的类SharedMemory作为核心操作类。我们去看看SharedMemory创建了什么东西。</p>
<p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/" target="_blank" rel="noopener">os</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/SharedMemory.java" target="_blank" rel="noopener">SharedMemory.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token annotation punctuation">@NonNull</span> SharedMemory <span class="token function">create</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> String name<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> ErrnoException <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SharedMemory</span><span class="token punctuation">(</span><span class="token function">nCreate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token function">SharedMemory</span><span class="token punctuation">(</span>FileDescriptor fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mFileDescriptor <span class="token operator">=</span> fd<span class="token punctuation">;</span>
        mSize <span class="token operator">=</span> <span class="token function">nGetSize</span><span class="token punctuation">(</span>mFileDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span>
        mMemoryRegistration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryRegistration</span><span class="token punctuation">(</span>mSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCleaner <span class="token operator">=</span> Cleaner<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>mFileDescriptor<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Closer</span><span class="token punctuation">(</span>mFileDescriptor<span class="token punctuation">,</span> mMemoryRegistration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>SharedMemory首先通过nCreate在native下创建一个文件描述符，并且关联到到SharedMemory，通过nGetSize获取当前共享内存大小，最后通过MemoryRegistration把当前大小注册到Java 虚拟机中的native堆栈大小中，初始化Cleaner等到合适的时候通过gc联动Cleaner销毁native下的对象。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MemoryRegistration</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> mSize<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> mReferenceCount<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token function">MemoryRegistration</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
            mReferenceCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerNativeAllocation</span><span class="token punctuation">(</span>mSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> MemoryRegistration <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mReferenceCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mReferenceCount<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mReferenceCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerNativeFree</span><span class="token punctuation">(</span>mSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>MemoryRegistration 本质上就是注册了Java虚拟机中native堆的大小，每一次一个引用都有一次计数，只有减到0才销毁，毕竟这是共享内存，不应该完全由Java虚拟机的GC机制决定</p>
<p>那么其核心毕竟就是nCreate这个native方法，接着会通过mapReadWrite</p>
<h3 id="nCreate构建native下层的共享内存"><a href="#nCreate构建native下层的共享内存" class="headerlink" title="nCreate构建native下层的共享内存"></a>nCreate构建native下层的共享内存</h3><p>文件: /<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_os_SharedMemory.cpp" target="_blank" rel="noopener">android_os_SharedMemory.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jobject <span class="token function">SharedMemory_create</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jstring jname<span class="token punctuation">,</span> jint size<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> jname <span class="token operator">?</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>jname<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">ashmem_create_region</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> errno <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>jname<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token function">jniCreateFileDescriptor</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>终于看到了，匿名共享内存相关的字眼，通过ashmem_create_region，创建一个共享内存的区域。还记得Linux中那句话，一切皆为文件，实际上匿名共享内存创建出来也是一个文件，不过因为是在tmpfs临时文件系统才叫做匿名的。最后创建java的文件描述符对象并和fd关联起来。</p>
<p>接下来让我们看看cutils中ashmem_create_region做了什么封装。<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libcutils/" target="_blank" rel="noopener">libcutils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libcutils/ashmem-dev.cpp" target="_blank" rel="noopener">ashmem-dev.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">ashmem_create_region</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">,</span> save_errno<span class="token punctuation">;</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">__ashmem_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span>ASHMEM_NAME_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">strlcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_SET_NAME<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_SET_SIZE<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建匿名共享内存分为三个步骤:</p>
<ul>
<li><p>1.__ashmem_open 创建匿名共享内存</p>
</li>
<li><p>2.通过ioctl 给匿名共享内存命名，只有命名了才能通过命名找到对应的匿名共享内存。</p>
</li>
<li><p>3.ioctl通过ASHMEM_SET_SIZE命令设置匿名共享内存的大小</p>
</li>
</ul>
<h4 id="ashmem-open"><a href="#ashmem-open" class="headerlink" title="__ashmem_open"></a>__ashmem_open</h4><p>这个方法最终会调用到如下的方法:</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> ASHMEM_DEVICE "/dev/ashmem"</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__ashmem_open_locked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> stat st<span class="token punctuation">;</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span>ASHMEM_DEVICE<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">S_ISCHR</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>st<span class="token punctuation">.</span>st_rdev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        errno <span class="token operator">=</span> ENOTTY<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    __ashmem_rdev <span class="token operator">=</span> st<span class="token punctuation">.</span>st_rdev<span class="token punctuation">;</span>
    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>终于看到了，类似于Binder驱动的打开方式一样，通过/dev/ashmem的方式访问ashmem驱动的file_operation的open方法，最后获得对应的文件描述符fd。</p>
<p>在这这里先停下来，只要记住Ashmem创建三个步骤:</p>
<ul>
<li>1.open /dev/ashmem驱动连通ashmem驱动</li>
<li>2.ioctl 发送ASHMEM_SET_NAME命令为该ashmem创建名字</li>
<li>3.ioctl通过ASHMEM_SET_SIZE命令设置匿名共享内存的大小</li>
</ul>
<h3 id="ShareMemory-mapReadWrite创建内存映射缓存区"><a href="#ShareMemory-mapReadWrite创建内存映射缓存区" class="headerlink" title="ShareMemory.mapReadWrite创建内存映射缓存区"></a>ShareMemory.mapReadWrite创建内存映射缓存区</h3><p>ShareMemory当创建好ashmem匿名共享内存之后，将会调用mapReadWrite</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token annotation punctuation">@NonNull</span> ByteBuffer <span class="token function">mapReadWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> ErrnoException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">map</span><span class="token punctuation">(</span>OsConstants<span class="token punctuation">.</span>PROT_READ <span class="token operator">|</span> OsConstants<span class="token punctuation">.</span>PROT_WRITE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token annotation punctuation">@NonNull</span> ByteBuffer <span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token keyword">throws</span> ErrnoException <span class="token punctuation">{</span>
        <span class="token function">checkOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateProt</span><span class="token punctuation">(</span>prot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">long</span> address <span class="token operator">=</span> Os<span class="token punctuation">.</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> prot<span class="token punctuation">,</span> OsConstants<span class="token punctuation">.</span>MAP_SHARED<span class="token punctuation">,</span> mFileDescriptor<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> readOnly <span class="token operator">=</span> <span class="token punctuation">(</span>prot <span class="token operator">&amp;</span> OsConstants<span class="token punctuation">.</span>PROT_WRITE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
        Runnable unmapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Unmapper</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> length<span class="token punctuation">,</span> mMemoryRegistration<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectByteBuffer</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> address<span class="token punctuation">,</span> mFileDescriptor<span class="token punctuation">,</span> unmapper<span class="token punctuation">,</span> readOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到map方法最终会调用 Os.mmap。其实这个方法的本质就是调用系统调用mmap。这里面的意思就是调用Ashmem对应的文件描述符mmap方法，也就是会调用Ashmem驱动中file_ops中的mmap方法，最后会直接映射一段逻辑上的虚拟内存和文件file关联起来。当系统正式访问这一段虚拟内存，如果找不到就会触发缺页中断(或者尝试的从磁盘执行物理页的换入换出)，此时就会把这一段逻辑绑定的虚拟内存和file正式映射到物理内存。</p>
<p>通过这种常规的mmap，让用户态的虚拟内存直接和物理内存映射起来，就能通过0次拷贝的方式映射起来。是否是这样，我们稍后来看看。</p>
<p>同时在DirectByteBuffer设置解开映射的回调Unmapper</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Unmapper</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">long</span> mAddress<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> mSize<span class="token punctuation">;</span>
        <span class="token keyword">private</span> MemoryRegistration mMemoryReference<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token function">Unmapper</span><span class="token punctuation">(</span><span class="token keyword">long</span> address<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> MemoryRegistration memoryReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAddress <span class="token operator">=</span> address<span class="token punctuation">;</span>
            mSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
            mMemoryReference <span class="token operator">=</span> memoryReference<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                Os<span class="token punctuation">.</span><span class="token function">munmap</span><span class="token punctuation">(</span>mAddress<span class="token punctuation">,</span> mSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* swallow exception */</span> <span class="token punctuation">}</span>
            mMemoryReference<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mMemoryReference <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到如果通过mMemoryRegistration察觉到引用计数为0，就会调用munmap解映射。因此我们可以推敲出，MemoryFile将会以mapReadWrite产生出来的mMapping为基准，不断的从这一段虚拟内存读写。让我们来看看MemoryFile的读写方法。</p>
<h2 id="MemoryFile写入数据"><a href="#MemoryFile写入数据" class="headerlink" title="MemoryFile写入数据"></a>MemoryFile写入数据</h2><p>写入操作能看到就是获取MemoryFile的OutputStream对象进行操作。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">MemoryOutputStream</span> <span class="token keyword">extends</span> <span class="token class-name">OutputStream</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> mOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mSingleByte<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">byte</span> buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token function">writeBytes</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> mOffset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOffset <span class="token operator">+=</span> count<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> oneByte<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSingleByte <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSingleByte <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mSingleByte<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span>oneByte<span class="token punctuation">;</span>
            <span class="token function">write</span><span class="token punctuation">(</span>mSingleByte<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在write方法中，本质上还是调用writeBytes作为核心写入方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">beginAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token function">checkActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAllowPurging<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">native_pin</span><span class="token punctuation">(</span>mSharedMemory<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"MemoryFile has been purged"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">endAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAllowPurging<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">native_pin</span><span class="token punctuation">(</span>mSharedMemory<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> srcOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> destOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token function">beginAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mMapping<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>destOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mMapping<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> srcOffset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">endAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个过程中会先调用native_pin进行锁定这一块大小的虚拟内存，避免被系统回收，最后才调用mMapping的position记录写完后的位置，并且把buffer数据写入到mMapping中.</p>
<p>等一下怎么回事，为什么不调用write系统调用？如果阅读过我之前文章就知道mmap的核心原理就是把物理页和虚拟内存页映射起来。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> ByteBuffer <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> srcOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">checkBounds</span><span class="token punctuation">(</span>srcOffset<span class="token punctuation">,</span> length<span class="token punctuation">,</span> src<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> lim <span class="token operator">=</span> <span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;=</span> lim<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rem <span class="token operator">=</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;=</span> lim <span class="token operator">?</span> lim <span class="token operator">-</span> pos <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        Memory<span class="token punctuation">.</span><span class="token function">pokeByteArray</span><span class="token punctuation">(</span><span class="token function">ix</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">,</span>
                src<span class="token punctuation">,</span> srcOffset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        position <span class="token operator">=</span> pos <span class="token operator">+</span> length<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>put首先会根据设置进来的position设定已经写入了多少数据，从哪里开始写入。接着会通过传进来的数据长度以及要写入的偏移量来确定要写入哪一块内存。</p>
<p>此时put会调用Memory.pokeByteArray方法，把内容写到虚拟地址偏移量的起点到数据长度结束中，也就是写入到对应位置的物理页中。</p>
<p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/" target="_blank" rel="noopener">libcore</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/" target="_blank" rel="noopener">luni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/" target="_blank" rel="noopener">src</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/main/" target="_blank" rel="noopener">main</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/main/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/main/native/libcore_io_Memory.cpp" target="_blank" rel="noopener">libcore_io_Memory.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Memory_pokeByteArray</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass<span class="token punctuation">,</span> jlong dstAddress<span class="token punctuation">,</span> jbyteArray src<span class="token punctuation">,</span> jint offset<span class="token punctuation">,</span> jint length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetByteArrayRegion</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">,</span> cast<span class="token operator">&lt;</span>jbyte<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>dstAddress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如下就是示意图：<br><img src="/images/DirectByteBuffer.png" alt="DirectByteBuffer.png"></p>
<h2 id="MemoryFile读取数据"><a href="#MemoryFile读取数据" class="headerlink" title="MemoryFile读取数据"></a>MemoryFile读取数据</h2><p>同理，MemoryFile读取数据的核心方法也是类似的.<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/" target="_blank" rel="noopener">os</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/MemoryFile.java" target="_blank" rel="noopener">MemoryFile.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">MemoryInputStream</span> <span class="token keyword">extends</span> <span class="token class-name">InputStream</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> mMark <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> mOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mSingleByte<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSingleByte <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSingleByte <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>mSingleByte<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> mSingleByte<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">byte</span> buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> count <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> offset <span class="token operator">+</span> count <span class="token operator">></span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// readBytes() also does this check, but we need to do it before</span>
                <span class="token comment" spellcheck="true">// changing count.</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IndexOutOfBoundsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            count <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">readBytes</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> mOffset<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mOffset <span class="token operator">+=</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到MemoryInputStream的read核心方法还是使用readBytes方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">readBytes</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> srcOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> destOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token function">beginAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mMapping<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>srcOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mMapping<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> destOffset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">endAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到核心还是获取mMapping这一块DirectByteBuffer中的数据，其调用核心调用，<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/" target="_blank" rel="noopener">libcore</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/" target="_blank" rel="noopener">ojluni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/" target="_blank" rel="noopener">src</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/" target="_blank" rel="noopener">main</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/java/nio/" target="_blank" rel="noopener">nio</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/java/nio/DirectByteBuffer.java" target="_blank" rel="noopener">DirectByteBuffer.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> ByteBuffer <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dst<span class="token punctuation">,</span> <span class="token keyword">int</span> dstOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> lim <span class="token operator">=</span> <span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;=</span> lim<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rem <span class="token operator">=</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;=</span> lim <span class="token operator">?</span> lim <span class="token operator">-</span> pos <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        Memory<span class="token punctuation">.</span><span class="token function">peekByteArray</span><span class="token punctuation">(</span><span class="token function">ix</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">,</span>
                dst<span class="token punctuation">,</span> dstOffset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        position <span class="token operator">=</span> pos <span class="token operator">+</span> length<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一样也是获取当前已经写入的位置，从该位置+偏移量作为读取数据的起点，读取数据的长度即为所得。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Memory_peekByteArray</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass<span class="token punctuation">,</span> jlong srcAddress<span class="token punctuation">,</span> jbyteArray dst<span class="token punctuation">,</span> jint dstOffset<span class="token punctuation">,</span> jint byteCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    env<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetByteArrayRegion</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> dstOffset<span class="token punctuation">,</span> byteCount<span class="token punctuation">,</span> cast<span class="token operator">&lt;</span><span class="token keyword">const</span> jbyte<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>srcAddress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>能看到此时就是获取目标区域内存的数据，设置到srcAddress中。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>经过对MemoryFile的解析，能够弄清楚，Ashmem匿名共享内存使用的步骤可以分为4步：</p>
<ul>
<li>1.open /dev/ashmem驱动连通ashmem驱动。</li>
<li>2.ioctl 发送ASHMEM_SET_NAME命令为该ashmem创建名字。</li>
<li>3.ioctl 发送ASHMEM_SET_SIZE命令为ashmem设置大小</li>
<li>4.mmap 做内存映射。</li>
<li>5.对该文件描述符进行读写即可。</li>
</ul>
<p>只要进行了前三步骤，算作是进程初始化了为在ashmem驱动内创建一个文件描述符用于共享内存，但是此时还没有关联起来相当于有了一个该名字的匿名内存标识；同时设置了共享内存的大小区域</p>
<p>第三步，调用mmap才正式把file和虚拟内存在逻辑上关联起来；</p>
<p>第四步，读写才会触发缺页中断，申请物理页并且绑定起来。</p>
<p>从这里我想起一些网上可笑的言论，在做性能优化的内存优化的时候，为了减少Java堆中的大小而把部分数据通过共享内存传递，这样就规避了Java的内存检测。这是优化？这仅仅只是使用了Android老版本检测内存的漏洞而已。如果熟知Linux内核的朋友就知道，这只是障眼法，Linux用户态和内核态使用的都是虚拟内存(内存管理系统分配物理页流程除外)，且有大小限制。</p>
<p>而Java虚拟机对Java堆栈和Java的Native堆栈做了大小的限制，就是因为每一个进程本身能申请的虚拟内存就是有限的。压根就没有真正的做到内存优化。</p>
<h2 id="Ashmem驱动"><a href="#Ashmem驱动" class="headerlink" title="Ashmem驱动"></a>Ashmem驱动</h2><p>我们了解如何使用Ashmem驱动之后，我们就根据着使用流程，从初始化到使用阅读一下Ashmem究竟在内核中做了什么。</p>
<h3 id="Ashmem-初始化"><a href="#Ashmem-初始化" class="headerlink" title="Ashmem 初始化"></a>Ashmem 初始化</h3><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ashmem.c" target="_blank" rel="noopener">ashmem.c</a></p>
<p>先来看看Ashmem的初始化</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">ashmem_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    ashmem_area_cachep <span class="token operator">=</span> <span class="token function">kmem_cache_create</span><span class="token punctuation">(</span><span class="token string">"ashmem_area_cache"</span><span class="token punctuation">,</span>
                      <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ashmem_area<span class="token punctuation">)</span><span class="token punctuation">,</span>
                      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    ashmem_range_cachep <span class="token operator">=</span> <span class="token function">kmem_cache_create</span><span class="token punctuation">(</span><span class="token string">"ashmem_range_cache"</span><span class="token punctuation">,</span>
                      <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ashmem_range<span class="token punctuation">)</span><span class="token punctuation">,</span>
                      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    ret <span class="token operator">=</span> <span class="token function">misc_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_misc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">register_shrinker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_shrinker<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个过程中，在slab高速缓存开辟了ashmem_area，以及ashmem_range两个结构体的cache，方便之后的申请。ashmem_area结构体的作用为切割出来给用户态的内存，ashmem_range为非锁定的内存块的链表结构，里面的内存块会在内核需要的时候被回收。</p>
<p>最后通过register_shrinker向内存管理系统注册Ashmem回收函数。</p>
<h3 id="Ashmem-的file-operation"><a href="#Ashmem-的file-operation" class="headerlink" title="Ashmem 的file_operation"></a>Ashmem 的file_operation</h3><p>了解驱动最快的方式就要看这个驱动复写的file_operation 结构体中有多少操作，每个操作指向哪一个方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> file_operations ashmem_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> ashmem_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> ashmem_release<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> ashmem_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>llseek <span class="token operator">=</span> ashmem_llseek<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>mmap <span class="token operator">=</span> ashmem_mmap<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> ashmem_ioctl<span class="token punctuation">,</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_COMPAT</span>
    <span class="token punctuation">.</span>compat_ioctl <span class="token operator">=</span> compat_ashmem_ioctl<span class="token punctuation">,</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到里面有open，read，mmap，unlocked_ioctl这四个核心的方法，我们只要分析这四个在Ashmem下的方法就能清除Ashmem做了什么。</p>
<h3 id="Ashmem-open"><a href="#Ashmem-open" class="headerlink" title="Ashmem open"></a>Ashmem open</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> ASHMEM_NAME_PREFIX "dev/ashmem/"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ASHMEM_NAME_PREFIX_LEN (sizeof(ASHMEM_NAME_PREFIX) - 1)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ASHMEM_FULL_NAME_LEN (ASHMEM_NAME_LEN + ASHMEM_NAME_PREFIX_LEN)</span>


<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ashmem_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> inode <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ashmem_area <span class="token operator">*</span>asma<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">generic_file_open</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    asma <span class="token operator">=</span> <span class="token function">kmem_cache_zalloc</span><span class="token punctuation">(</span>ashmem_area_cachep<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>asma<span class="token operator">-</span><span class="token operator">></span>unpinned_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>asma<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">,</span> ASHMEM_NAME_PREFIX<span class="token punctuation">,</span> ASHMEM_NAME_PREFIX_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    asma<span class="token operator">-</span><span class="token operator">></span>prot_mask <span class="token operator">=</span> PROT_MASK<span class="token punctuation">;</span>
    file<span class="token operator">-</span><span class="token operator">></span>private_data <span class="token operator">=</span> asma<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先从ashmem_area_cachep申请slab缓冲区中一块ashmem_area区域，并且初始化ashmem_area中unpinned_list解锁内存块列表的队列头，并且把asma这一块匿名区域设置名字为/dev/ashmem。</p>
<p>最后把当前的ashmem_area设置为file的私有数据。</p>
<h3 id="Ashmem-ioctl设置名字与大小"><a href="#Ashmem-ioctl设置名字与大小" class="headerlink" title="Ashmem ioctl设置名字与大小"></a>Ashmem ioctl设置名字与大小</h3><p>接下来会通过ioctl设置名字，调用的命令是ASHMEM_SET_NAME。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">ashmem_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ashmem_area <span class="token operator">*</span>asma <span class="token operator">=</span> file<span class="token operator">-</span><span class="token operator">></span>private_data<span class="token punctuation">;</span>
    <span class="token keyword">long</span> ret <span class="token operator">=</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> ASHMEM_SET_NAME<span class="token operator">:</span>
        ret <span class="token operator">=</span> <span class="token function">set_name</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ASHMEM_GET_NAME<span class="token operator">:</span>
        ret <span class="token operator">=</span> <span class="token function">get_name</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ASHMEM_SET_SIZE<span class="token operator">:</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>asma<span class="token operator">-</span><span class="token operator">></span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            asma<span class="token operator">-</span><span class="token operator">></span>size <span class="token operator">=</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> arg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ASHMEM_GET_SIZE<span class="token operator">:</span>
        ret <span class="token operator">=</span> asma<span class="token operator">-</span><span class="token operator">></span>size<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先来看看几个简单的命令，ASHMEM_SET_NAME通过set_name设置名字；ASHMEM_GET_NAME通过get_name获取名字；ASHMEM_SET_SIZE设置区域大小。设置大小本质上就是设置asma中的size属性。我们来看看设置名字的set_name的逻辑。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">set_name</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ashmem_area <span class="token operator">*</span>asma<span class="token punctuation">,</span> <span class="token keyword">void</span> __user <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> local_name<span class="token punctuation">[</span>ASHMEM_NAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

    len <span class="token operator">=</span> <span class="token function">strncpy_from_user</span><span class="token punctuation">(</span>local_name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> ASHMEM_NAME_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> ASHMEM_NAME_LEN<span class="token punctuation">)</span>
        local_name<span class="token punctuation">[</span>ASHMEM_NAME_LEN <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* cannot change an existing mapping's name */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>asma<span class="token operator">-</span><span class="token operator">></span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>asma<span class="token operator">-</span><span class="token operator">></span>name <span class="token operator">+</span> ASHMEM_NAME_PREFIX_LEN<span class="token punctuation">,</span> local_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面的逻辑很简单，实际上就是获取asma中那么属性，之前是/dev/ashmem,现在在末尾追加文件名字，如/dev/ashmem/<filename>,这样驱动程序为每一个匿名共享内存创建自己独有的名字，当然一旦判断这个asma已经映射了file就拒绝再次命名。</filename></p>
<h3 id="Ashmem的mmap映射内存"><a href="#Ashmem的mmap映射内存" class="headerlink" title="Ashmem的mmap映射内存"></a>Ashmem的mmap映射内存</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ashmem_mmap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">struct</span> vm_area_struct <span class="token operator">*</span>vma<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ashmem_area <span class="token operator">*</span>asma <span class="token operator">=</span> file<span class="token operator">-</span><span class="token operator">></span>private_data<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* user needs to SET_SIZE before mapping */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>asma<span class="token operator">-</span><span class="token operator">></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/* requested protection bits must match our allowed protection mask */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vma<span class="token operator">-</span><span class="token operator">></span>vm_flags <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token function">calc_vm_prot_bits</span><span class="token punctuation">(</span>asma<span class="token operator">-</span><span class="token operator">></span>prot_mask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>
             <span class="token function">calc_vm_prot_bits</span><span class="token punctuation">(</span>PROT_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    vma<span class="token operator">-</span><span class="token operator">></span>vm_flags <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token function">calc_vm_may_flags</span><span class="token punctuation">(</span><span class="token operator">~</span>asma<span class="token operator">-</span><span class="token operator">></span>prot_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>asma<span class="token operator">-</span><span class="token operator">></span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>name <span class="token operator">=</span> ASHMEM_NAME_DEF<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> file <span class="token operator">*</span>vmfile<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>asma<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">[</span>ASHMEM_NAME_PREFIX_LEN<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">)</span>
            name <span class="token operator">=</span> asma<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* ... and allocate the backing shmem file */</span>
        vmfile <span class="token operator">=</span> <span class="token function">shmem_file_setup</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> asma<span class="token operator">-</span><span class="token operator">></span>size<span class="token punctuation">,</span> vma<span class="token operator">-</span><span class="token operator">></span>vm_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>vmfile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ret <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>vmfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        asma<span class="token operator">-</span><span class="token operator">></span>file <span class="token operator">=</span> vmfile<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">get_file</span><span class="token punctuation">(</span>asma<span class="token operator">-</span><span class="token operator">></span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>vma<span class="token operator">-</span><span class="token operator">></span>vm_flags <span class="token operator">&amp;</span> VM_SHARED<span class="token punctuation">)</span>
        <span class="token function">shmem_set_file</span><span class="token punctuation">(</span>vma<span class="token punctuation">,</span> asma<span class="token operator">-</span><span class="token operator">></span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vma<span class="token operator">-</span><span class="token operator">></span>vm_file<span class="token punctuation">)</span>
            <span class="token function">fput</span><span class="token punctuation">(</span>vma<span class="token operator">-</span><span class="token operator">></span>vm_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vma<span class="token operator">-</span><span class="token operator">></span>vm_file <span class="token operator">=</span> asma<span class="token operator">-</span><span class="token operator">></span>file<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

out<span class="token operator">:</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程校验了，必须要设置asma的size，不然会抛异常。检测需要映射的vma虚拟内存是否符合权限，否则抛异常。</p>
<p>接着检查asma中的file文件结构体是否创建，没有则获取asma名字和大小通过shmem_file_setup创建一个文件描述符。</p>
<p>检查如果当前的vma虚拟内存允许共享则调用shmem_set_file映射文件。</p>
<p>我们就来看看shmem_file_setup和shmem_set_file。</p>
<h4 id="shmem-file-setup"><a href="#shmem-file-setup" class="headerlink" title="shmem_file_setup"></a>shmem_file_setup</h4><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/mm/" target="_blank" rel="noopener">mm</a>/<a href="http://androidxref.com/kernel_3.18/xref/mm/shmem.c" target="_blank" rel="noopener">shmem.c</a></p>
<p>最后会调用如下核心代码</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> file <span class="token operator">*</span><span class="token function">__shmem_file_setup</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> loff_t size<span class="token punctuation">,</span>
                       <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i_flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> file <span class="token operator">*</span>res<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> inode <span class="token operator">*</span>inode<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> path path<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> super_block <span class="token operator">*</span>sb<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> qstr <span class="token keyword">this</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    res <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* will go */</span>
    sb <span class="token operator">=</span> shm_mnt<span class="token operator">-</span><span class="token operator">></span>mnt_sb<span class="token punctuation">;</span>
    path<span class="token punctuation">.</span>mnt <span class="token operator">=</span> <span class="token function">mntget</span><span class="token punctuation">(</span>shm_mnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    path<span class="token punctuation">.</span>dentry <span class="token operator">=</span> <span class="token function">d_alloc_pseudo</span><span class="token punctuation">(</span>sb<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">d_set_d_op</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>dentry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>anon_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>

    res <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOSPC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    inode <span class="token operator">=</span> <span class="token function">shmem_get_inode</span><span class="token punctuation">(</span>sb<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> S_IFREG <span class="token operator">|</span> S_IRWXUGO<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    inode<span class="token operator">-</span><span class="token operator">></span>i_flags <span class="token operator">|</span><span class="token operator">=</span> i_flags<span class="token punctuation">;</span>
    <span class="token function">d_instantiate</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>dentry<span class="token punctuation">,</span> inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    inode<span class="token operator">-</span><span class="token operator">></span>i_size <span class="token operator">=</span> size<span class="token punctuation">;</span>
    <span class="token function">clear_nlink</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* It is unlinked */</span>
    res <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token function">ramfs_nommu_expand_for_mapping</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> put_path<span class="token punctuation">;</span>

    res <span class="token operator">=</span> <span class="token function">alloc_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">,</span> FMODE_WRITE <span class="token operator">|</span> FMODE_READ<span class="token punctuation">,</span>
          <span class="token operator">&amp;</span>shmem_file_operations<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> res<span class="token punctuation">;</span>

put_memory<span class="token operator">:</span>
    <span class="token function">shmem_unacct_size</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
put_path<span class="token operator">:</span>
    <span class="token function">path_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在__shmem_file_setup中做了如下几个十分重要的事情：</p>
<ul>
<li>1.d_instantiate设置目录结构体</li>
<li>2.通过shmem_get_inode设置共享的inode，inode是Linux访问硬盘文件系统的基本单位，里面包含如superblock等元数据。</li>
<li>3.alloc_file申请一个file结构体，同时复写file的结构中的file_operation文件操作.</li>
</ul>
<p>让我们看看shmem_file_operations有具体操作：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> file_operations shmem_file_operations <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>mmap        <span class="token operator">=</span> shmem_mmap<span class="token punctuation">,</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_TMPFS</span>
    <span class="token punctuation">.</span>llseek        <span class="token operator">=</span> shmem_file_llseek<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read        <span class="token operator">=</span> new_sync_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write        <span class="token operator">=</span> new_sync_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read_iter    <span class="token operator">=</span> shmem_file_read_iter<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write_iter    <span class="token operator">=</span> generic_file_write_iter<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>fsync        <span class="token operator">=</span> noop_fsync<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>splice_read    <span class="token operator">=</span> shmem_file_splice_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>splice_write    <span class="token operator">=</span> iter_file_splice_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>fallocate    <span class="token operator">=</span> shmem_fallocate<span class="token punctuation">,</span><span class="token comment" spellcheck="true">//预分配物理内存</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过shmem_file_setup，ashmem驱动程序就把vma中的file文件结构体转化为共享内存了。</p>
<p>不过看到shmem这个名字就应该知道其实这就是Linux中的共享内存。</p>
<h4 id="shmem-set-file"><a href="#shmem-set-file" class="headerlink" title="shmem_set_file"></a>shmem_set_file</h4><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/mm/" target="_blank" rel="noopener">mm</a>/<a href="http://androidxref.com/kernel_3.18/xref/mm/shmem.c" target="_blank" rel="noopener">shmem.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">shmem_set_file</span><span class="token punctuation">(</span><span class="token keyword">struct</span> vm_area_struct <span class="token operator">*</span>vma<span class="token punctuation">,</span> <span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_file<span class="token punctuation">)</span>
        <span class="token function">fput</span><span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vma<span class="token operator">-></span>vm_file <span class="token operator">=</span> file<span class="token punctuation">;</span>
    vma<span class="token operator">-></span>vm_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>shmem_vm_ops<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到本质上这个方法就是把vm_file和file结构体关联起来，同时设置了虚拟内存的操作函数：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> vm_operations_struct shmem_vm_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>fault        <span class="token operator">=</span> shmem_fault<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>map_pages    <span class="token operator">=</span> filemap_map_pages<span class="token punctuation">,</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_NUMA</span>
    <span class="token punctuation">.</span>set_policy     <span class="token operator">=</span> shmem_set_policy<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>get_policy     <span class="token operator">=</span> shmem_get_policy<span class="token punctuation">,</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token punctuation">.</span>remap_pages    <span class="token operator">=</span> generic_file_remap_pages<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个结构体尤为的重要其中fault操作函数shmem_fault，是指当接收到缺页中断时候，共享内存该如何绑定物理页。</p>
<p>因为此时只是从逻辑上把vma和匿名共享内存对应的file文件在逻辑上关联起来，当我们尝试读写这一段虚拟内存的时候，发现并没有映射，也没有在硬盘上保存相应的数据进行换入，就会绑定一段物理内存。</p>
<p>先不关心是怎么调用到shmem_fault之后有机会会聊到的，先看看下面这个方法做了什么。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">shmem_fault</span><span class="token punctuation">(</span><span class="token keyword">struct</span> vm_area_struct <span class="token operator">*</span>vma<span class="token punctuation">,</span> <span class="token keyword">struct</span> vm_fault <span class="token operator">*</span>vmf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> inode <span class="token operator">*</span>inode <span class="token operator">=</span> <span class="token function">file_inode</span><span class="token punctuation">(</span>vma<span class="token operator">-</span><span class="token operator">></span>vm_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> VM_FAULT_LOCKED<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>inode<span class="token operator">-</span><span class="token operator">></span>i_private<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> shmem_falloc <span class="token operator">*</span>shmem_falloc<span class="token punctuation">;</span>

        <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inode<span class="token operator">-</span><span class="token operator">></span>i_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        shmem_falloc <span class="token operator">=</span> inode<span class="token operator">-</span><span class="token operator">></span>i_private<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shmem_falloc <span class="token operator">&amp;&amp;</span>
            shmem_falloc<span class="token operator">-</span><span class="token operator">></span>waitq <span class="token operator">&amp;&amp;</span>
            vmf<span class="token operator">-</span><span class="token operator">></span>pgoff <span class="token operator">>=</span> shmem_falloc<span class="token operator">-</span><span class="token operator">></span>start <span class="token operator">&amp;&amp;</span>
            vmf<span class="token operator">-</span><span class="token operator">></span>pgoff <span class="token operator">&lt;</span> shmem_falloc<span class="token operator">-</span><span class="token operator">></span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inode<span class="token operator">-</span><span class="token operator">></span>i_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    error <span class="token operator">=</span> <span class="token function">shmem_getpage</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> vmf<span class="token operator">-</span><span class="token operator">></span>pgoff<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vmf<span class="token operator">-</span><span class="token operator">></span>page<span class="token punctuation">,</span> SGP_CACHE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当触发了缺页中断之后，就会查找预分配的物理内存，此时没有，会直接调用shmem_getpage，绑定vmf中的物理页和虚拟内存页。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">shmem_getpage_gfp</span><span class="token punctuation">(</span><span class="token keyword">struct</span> inode <span class="token operator">*</span>inode<span class="token punctuation">,</span> pgoff_t index<span class="token punctuation">,</span>
    <span class="token keyword">struct</span> page <span class="token operator">*</span><span class="token operator">*</span>pagep<span class="token punctuation">,</span> <span class="token keyword">enum</span> sgp_type sgp<span class="token punctuation">,</span> gfp_t gfp<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>fault_type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> address_space <span class="token operator">*</span>mapping <span class="token operator">=</span> inode<span class="token operator">-</span><span class="token operator">></span>i_mapping<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> shmem_inode_info <span class="token operator">*</span>info<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> shmem_sb_info <span class="token operator">*</span>sbinfo<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> mem_cgroup <span class="token operator">*</span>memcg<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> page <span class="token operator">*</span>page<span class="token punctuation">;</span>
    swp_entry_t swap<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>
    <span class="token keyword">int</span> once <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> alloced <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">></span> <span class="token punctuation">(</span>MAX_LFS_FILESIZE <span class="token operator">>></span> PAGE_CACHE_SHIFT<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFBIG<span class="token punctuation">;</span>
repeat<span class="token operator">:</span>
    swap<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    page <span class="token operator">=</span> <span class="token function">find_lock_entry</span><span class="token punctuation">(</span>mapping<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">/*
     * Fast cache lookup did not find it:
     * bring it back from swap or allocate.
     */</span>
    info <span class="token operator">=</span> <span class="token function">SHMEM_I</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sbinfo <span class="token operator">=</span> <span class="token function">SHMEM_SB</span><span class="token punctuation">(</span>inode<span class="token operator">-</span><span class="token operator">></span>i_sb<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>swap<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shmem_acct_block</span><span class="token punctuation">(</span>info<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            error <span class="token operator">=</span> <span class="token operator">-</span>ENOSPC<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sbinfo<span class="token operator">-</span><span class="token operator">></span>max_blocks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">percpu_counter_compare</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sbinfo<span class="token operator">-</span><span class="token operator">></span>used_blocks<span class="token punctuation">,</span>
                        sbinfo<span class="token operator">-</span><span class="token operator">></span>max_blocks<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                error <span class="token operator">=</span> <span class="token operator">-</span>ENOSPC<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> unacct<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">percpu_counter_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sbinfo<span class="token operator">-</span><span class="token operator">></span>used_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        page <span class="token operator">=</span> <span class="token function">shmem_alloc_page</span><span class="token punctuation">(</span>gfp<span class="token punctuation">,</span> info<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            error <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> decused<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">__SetPageSwapBacked</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__set_page_locked</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sgp <span class="token operator">==</span> SGP_WRITE<span class="token punctuation">)</span>
            <span class="token function">__SetPageReferenced</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>

        error <span class="token operator">=</span> <span class="token function">mem_cgroup_try_charge</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> current<span class="token operator">-</span><span class="token operator">></span>mm<span class="token punctuation">,</span> gfp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>memcg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> decused<span class="token punctuation">;</span>
        error <span class="token operator">=</span> <span class="token function">radix_tree_maybe_preload</span><span class="token punctuation">(</span>gfp <span class="token operator">&amp;</span> GFP_RECLAIM_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            error <span class="token operator">=</span> <span class="token function">shmem_add_to_page_cache</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> mapping<span class="token punctuation">,</span> index<span class="token punctuation">,</span>
                            <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">radix_tree_preload_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">mem_cgroup_cancel_charge</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> memcg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> decused<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">mem_cgroup_commit_charge</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> memcg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">lru_cache_add_anon</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token operator">-</span><span class="token operator">></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token operator">-</span><span class="token operator">></span>alloced<span class="token operator">++</span><span class="token punctuation">;</span>
        inode<span class="token operator">-</span><span class="token operator">></span>i_blocks <span class="token operator">+</span><span class="token operator">=</span> BLOCKS_PER_PAGE<span class="token punctuation">;</span>
        <span class="token function">shmem_recalc_inode</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token operator">-</span><span class="token operator">></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        alloced <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * Let SGP_FALLOC use the SGP_WRITE optimization on a new page.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sgp <span class="token operator">==</span> SGP_FALLOC<span class="token punctuation">)</span>
            sgp <span class="token operator">=</span> SGP_WRITE<span class="token punctuation">;</span>
clear<span class="token operator">:</span>
        <span class="token comment" spellcheck="true">/*
         * Let SGP_WRITE caller clear ends if write does not fill page;
         * but SGP_FALLOC on a page fallocated earlier must initialize
         * it now, lest undo on failure cancel our earlier guarantee.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sgp <span class="token operator">!=</span> SGP_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">clear_highpage</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">flush_dcache_page</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">SetPageUptodate</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sgp <span class="token operator">==</span> SGP_DIRTY<span class="token punctuation">)</span>
            <span class="token function">set_page_dirty</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/* Perhaps the file has been truncated since we checked */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">*</span>pagep <span class="token operator">=</span> page<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面做的事情有如下几件：</p>
<ul>
<li>1.首先拿到页内偏移，尝试的查找是否虚拟地址中保存着物理内存页</li>
<li>2.检查inode中的superblock的标志位或者容量是否已经超出原来预设的</li>
<li>3.shmem_alloc_page通过alloc_page通过伙伴系统申请绑定物理页</li>
<li>4.mem_cgroup_try_charge 记录当前page的缓存，mem_cgroup_commit_charge提交到linux中。cgroup的机制就是为了检测申请的内存，以及寻找时机回收。</li>
<li>5.最后把page挂在到address_space这个结构体的maping的基数树中。</li>
</ul>
<p>这里提一句，address_space这个结构体是用于记录文件和内存的关联的。基数树实际上就是以bit为key，生成多个分支的树。有点像哈夫曼树一样，把一个key的bit位全部读出来，取出key中一位一位或者多位的生成多个阶段的树，只要把这个key的bit位全部读取完毕就能找到内容。</p>
<p>是一个十分快速的映射数据结构,借用网上的一个图：<br><img src="/images/%E5%9F%BA%E6%95%B0%E6%A0%91.jpeg" alt="基数树.jpeg"></p>
<p>这样就完成了映射，而这种机制其实是比起Binder的mmap很接近ext4文件系统的方式。</p>
<h3 id="Ashmem驱动读写"><a href="#Ashmem驱动读写" class="headerlink" title="Ashmem驱动读写"></a>Ashmem驱动读写</h3><p>还记得读写操作此时不会对ashmem生成的文件进行读写，而是对映射的区域进行读写，换句话说就是对共享内存这段地址区域直接进行读写，没有经过write，read的系统调用，也就不会走到他们对应的file_operation.</p>
<h3 id="Ashmem锁定与解锁"><a href="#Ashmem锁定与解锁" class="headerlink" title="Ashmem锁定与解锁"></a>Ashmem锁定与解锁</h3><p>还记得，在这Ashmem初始化一节就说过的另一个数据结构ashmem_range吗？这里就涉及到了。那么Ashmem申请的共享匿名共享本质上还是借助shmem共享内存函数实现的，那么Ashmem和shmem有什么区别，其实区别就在这个映射区域的锁定与解锁中。</p>
<p>让我们把目光回顾到MemoryFile中,能够发现每一次调用读写都会调用一次native_pin方法：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token function">native_pin</span><span class="token punctuation">(</span>mSharedMemory<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//锁定</span>
<span class="token function">native_pin</span><span class="token punctuation">(</span>mSharedMemory<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//解锁</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在native层调用方式如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jboolean <span class="token function">android_os_MemoryFile_pin</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span> jobject fileDescriptor<span class="token punctuation">,</span>
        jboolean pin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">jniGetFDFromFileDescriptor</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> fileDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token punctuation">(</span>pin <span class="token operator">?</span> <span class="token function">ashmem_pin_region</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ashmem_unpin_region</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">jniThrowException</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"java/io/IOException"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result <span class="token operator">==</span> ASHMEM_WAS_PURGED<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libcutils/" target="_blank" rel="noopener">libcutils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libcutils/ashmem-dev.cpp" target="_blank" rel="noopener">ashmem-dev.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">ashmem_pin_region</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> size_t offset<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// TODO: should LP64 reject too-large offset/len?</span>
    ashmem_pin pin <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">__ashmem_is_ashmem</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_PIN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">ashmem_unpin_region</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> size_t offset<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// TODO: should LP64 reject too-large offset/len?</span>
    ashmem_pin pin <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">__ashmem_is_ashmem</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_UNPIN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到本质上就是把offset偏移量和len要写入的长度封装为一个ashmem_pin结构体中。此时全是0.</p>
<p>而这个方式本质上是调用ioctl如下命令ASHMEM_PIN和ASHMEM_UNPIN：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">ashmem_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ashmem_area <span class="token operator">*</span>asma <span class="token operator">=</span> file<span class="token operator">-</span><span class="token operator">></span>private_data<span class="token punctuation">;</span>
    <span class="token keyword">long</span> ret <span class="token operator">=</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">case</span> ASHMEM_PIN<span class="token operator">:</span>
    <span class="token keyword">case</span> ASHMEM_UNPIN<span class="token operator">:</span>
    <span class="token keyword">case</span> ASHMEM_GET_PIN_STATUS<span class="token operator">:</span>
        ret <span class="token operator">=</span> <span class="token function">ashmem_pin_unpin</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ashmem_pin_unpin</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ashmem_area <span class="token operator">*</span>asma<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> cmd<span class="token punctuation">,</span>
                <span class="token keyword">void</span> __user <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ashmem_pin pin<span class="token punctuation">;</span>
    size_t pgstart<span class="token punctuation">,</span> pgend<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pin<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    pgstart <span class="token operator">=</span> pin<span class="token punctuation">.</span>offset <span class="token operator">/</span> PAGE_SIZE<span class="token punctuation">;</span>
    pgend <span class="token operator">=</span> pgstart <span class="token operator">+</span> <span class="token punctuation">(</span>pin<span class="token punctuation">.</span>len <span class="token operator">/</span> PAGE_SIZE<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> ASHMEM_PIN<span class="token operator">:</span>
        ret <span class="token operator">=</span> <span class="token function">ashmem_pin</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> pgstart<span class="token punctuation">,</span> pgend<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ASHMEM_UNPIN<span class="token operator">:</span>
        ret <span class="token operator">=</span> <span class="token function">ashmem_unpin</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> pgstart<span class="token punctuation">,</span> pgend<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ASHMEM_GET_PIN_STATUS<span class="token operator">:</span>
        ret <span class="token operator">=</span> <span class="token function">ashmem_get_pin_status</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> pgstart<span class="token punctuation">,</span> pgend<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时会计算要锁定或者解锁的区域开始和结束地址。pgstart计算方式就是除去一页大小4kb，这样就能拿到偏移量是第几页，由于是除没有余数就能拿到当前页的起点。pgend就是pgstart加上长度占用的页数减1.</p>
<p>其实从计算就能知道，ashmem的锁定区域必定是按照页为最基本单位锁定和解锁的。</p>
<p>在阅读源码之前首先要明白，默认mmap出来的地址都是锁定好的。</p>
<h3 id="Ashmem的解锁ashmem-unpin"><a href="#Ashmem的解锁ashmem-unpin" class="headerlink" title="Ashmem的解锁ashmem_unpin"></a>Ashmem的解锁ashmem_unpin</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ashmem_unpin</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ashmem_area <span class="token operator">*</span>asma<span class="token punctuation">,</span> size_t pgstart<span class="token punctuation">,</span> size_t pgend<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ashmem_range <span class="token operator">*</span>range<span class="token punctuation">,</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> purged <span class="token operator">=</span> ASHMEM_NOT_PURGED<span class="token punctuation">;</span>

restart<span class="token operator">:</span>
    <span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token operator">&amp;</span>asma<span class="token operator">-</span><span class="token operator">></span>unpinned_list<span class="token punctuation">,</span> unpinned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* short circuit: this is our insertion point */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">range_before_page</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> pgstart<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * The user can ask us to unpin pages that are already entirely
         * or partially pinned. We handle those two cases here.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_range_subsumed_by_range</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> pgstart<span class="token punctuation">,</span> pgend<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_range_in_range</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> pgstart<span class="token punctuation">,</span> pgend<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pgstart <span class="token operator">=</span> <span class="token function">min_t</span><span class="token punctuation">(</span>size_t<span class="token punctuation">,</span> range<span class="token operator">-</span><span class="token operator">></span>pgstart<span class="token punctuation">,</span> pgstart<span class="token punctuation">)</span><span class="token punctuation">,</span>
            pgend <span class="token operator">=</span> <span class="token function">max_t</span><span class="token punctuation">(</span>size_t<span class="token punctuation">,</span> range<span class="token operator">-</span><span class="token operator">></span>pgend<span class="token punctuation">,</span> pgend<span class="token punctuation">)</span><span class="token punctuation">;</span>
            purged <span class="token operator">|</span><span class="token operator">=</span> range<span class="token operator">-</span><span class="token operator">></span>purged<span class="token punctuation">;</span>
            <span class="token function">range_del</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> restart<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">range_alloc</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> range<span class="token punctuation">,</span> purged<span class="token punctuation">,</span> pgstart<span class="token punctuation">,</span> pgend<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/unpin5%E7%A7%8D%E6%83%85%E5%86%B5.png" alt="unpin5种情况.png"></p>
<p>在这个过程中需要比较从unpinned_list链表种每一项已经解锁的range。大致会分为5种情况：<br>在情况1，2，3种当解锁的range在这一次pagestart和pageend之间有交集，则会合并起来.</p>
<p>在第4种情况，由于range已经包含了pagestart和pageend就没必要处理</p>
<p>第5种情况，由于range和即将解锁的区域不相交，并且range在即将解锁区域的前方则不需要遍历，没必要做合并操作。</p>
<h4 id="range-alloc"><a href="#range-alloc" class="headerlink" title="range_alloc"></a>range_alloc</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">range_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ashmem_area <span class="token operator">*</span>asma<span class="token punctuation">,</span>
               <span class="token keyword">struct</span> ashmem_range <span class="token operator">*</span>prev_range<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> purged<span class="token punctuation">,</span>
               size_t start<span class="token punctuation">,</span> size_t end<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ashmem_range <span class="token operator">*</span>range<span class="token punctuation">;</span>

    range <span class="token operator">=</span> <span class="token function">kmem_cache_zalloc</span><span class="token punctuation">(</span>ashmem_range_cachep<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    range<span class="token operator">-</span><span class="token operator">></span>asma <span class="token operator">=</span> asma<span class="token punctuation">;</span>
    range<span class="token operator">-</span><span class="token operator">></span>pgstart <span class="token operator">=</span> start<span class="token punctuation">;</span>
    range<span class="token operator">-</span><span class="token operator">></span>pgend <span class="token operator">=</span> end<span class="token punctuation">;</span>
    range<span class="token operator">-</span><span class="token operator">></span>purged <span class="token operator">=</span> purged<span class="token punctuation">;</span>

    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>range<span class="token operator">-</span><span class="token operator">></span>unpinned<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prev_range<span class="token operator">-</span><span class="token operator">></span>unpinned<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">range_on_lru</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">lru_add</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时会从ashmem_range_cachep创建一个asma_range，设置好其起始和结束地址，添加amsa的unpinnedlist末尾中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">lru_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ashmem_range <span class="token operator">*</span>range<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>range<span class="token operator">-</span><span class="token operator">></span>lru<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ashmem_lru_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lru_count <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">range_size</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后把当前range设置到全局变量ashmem_lru_list链表的末尾，并且记录当前解锁的总大小。</p>
<h3 id="Ashmem的锁定ashmem-pin"><a href="#Ashmem的锁定ashmem-pin" class="headerlink" title="Ashmem的锁定ashmem_pin"></a>Ashmem的锁定ashmem_pin</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ashmem_pin</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ashmem_area <span class="token operator">*</span>asma<span class="token punctuation">,</span> size_t pgstart<span class="token punctuation">,</span> size_t pgend<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ashmem_range <span class="token operator">*</span>range<span class="token punctuation">,</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> ASHMEM_NOT_PURGED<span class="token punctuation">;</span>

    <span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token operator">&amp;</span>asma<span class="token operator">-</span><span class="token operator">></span>unpinned_list<span class="token punctuation">,</span> unpinned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* moved past last applicable page; we can short circuit */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">range_before_page</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> pgstart<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * The user can ask us to pin pages that span multiple ranges,
         * or to pin pages that aren't even unpinned, so this is messy.
         *
         * Four cases:
         * 1. The requested range subsumes an existing range, so we
         *    just remove the entire matching range.
         * 2. The requested range overlaps the start of an existing
         *    range, so we just update that range.
         * 3. The requested range overlaps the end of an existing
         *    range, so we just update that range.
         * 4. The requested range punches a hole in an existing range,
         *    so we have to update one side of the range and then
         *    create a new range for the other side.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_range_in_range</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> pgstart<span class="token punctuation">,</span> pgend<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ret <span class="token operator">|</span><span class="token operator">=</span> range<span class="token operator">-</span><span class="token operator">></span>purged<span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/* Case #1: Easy. Just nuke the whole thing. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_range_subsumes_range</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> pgstart<span class="token punctuation">,</span> pgend<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">range_del</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">/* Case #2: We overlap from the start, so adjust it */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token operator">-</span><span class="token operator">></span>pgstart <span class="token operator">>=</span> pgstart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">range_shrink</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> pgend <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> range<span class="token operator">-</span><span class="token operator">></span>pgend<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">/* Case #3: We overlap from the rear, so adjust it */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token operator">-</span><span class="token operator">></span>pgend <span class="token operator">&lt;=</span> pgend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">range_shrink</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> range<span class="token operator">-</span><span class="token operator">></span>pgstart<span class="token punctuation">,</span> pgstart<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">/*
             * Case #4: We eat a chunk out of the middle. A bit
             * more complicated, we allocate a new range for the
             * second half and adjust the first chunk's endpoint.
             */</span>
            <span class="token function">range_alloc</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> range<span class="token punctuation">,</span> range<span class="token operator">-</span><span class="token operator">></span>purged<span class="token punctuation">,</span>
                    pgend <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> range<span class="token operator">-</span><span class="token operator">></span>pgend<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">range_shrink</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> range<span class="token operator">-</span><span class="token operator">></span>pgstart<span class="token punctuation">,</span> pgstart <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同理，在上锁的情况也可以依照上面解锁的图中的4种情况：</p>
<ul>
<li>1.情况1如果内存块start和end包含了range区域，那么直接把range从unpinned_list中移除</li>
<li>2.如果是内存块start和end后半部分和让相交，则直接修改要锁定的unpinned_list中range的起始地址是内存块的末尾地址</li>
<li>3.如果是内存块start和end前半部分和让相交，则直接修改要锁定的unpinned_list中range的末尾地址是内存块的起始地址</li>
<li>4.如果range包含了要锁定的内存块，则要挖一个洞，移除range中间部分，把前后两部分生成两个新的range加入到unpinned_list</li>
</ul>
<p>第5种情况不相交就不用管了。</p>
<h3 id="Ashmem的内存回收"><a href="#Ashmem的内存回收" class="headerlink" title="Ashmem的内存回收"></a>Ashmem的内存回收</h3><p>既然存在了unpinned_list解锁定的内存区域，那么什么时候回收呢？这个操作结构体在初始化的时候就提到过，我们来直接看看这个结构体做了什么。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> shrinker ashmem_shrinker <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>count_objects <span class="token operator">=</span> ashmem_shrink_count<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>scan_objects <span class="token operator">=</span> ashmem_shrink_scan<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>seeks <span class="token operator">=</span> DEFAULT_SEEKS <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心是这个扫描函数ashmem_shrink_scan</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span>
<span class="token function">ashmem_shrink_scan</span><span class="token punctuation">(</span><span class="token keyword">struct</span> shrinker <span class="token operator">*</span>shrink<span class="token punctuation">,</span> <span class="token keyword">struct</span> shrink_control <span class="token operator">*</span>sc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ashmem_range <span class="token operator">*</span>range<span class="token punctuation">,</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* We might recurse into filesystem code, so bail out if necessary */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ashmem_lru_list<span class="token punctuation">,</span> lru<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        loff_t start <span class="token operator">=</span> range<span class="token operator">-</span><span class="token operator">></span>pgstart <span class="token operator">*</span> PAGE_SIZE<span class="token punctuation">;</span>
        loff_t end <span class="token operator">=</span> <span class="token punctuation">(</span>range<span class="token operator">-</span><span class="token operator">></span>pgend <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> PAGE_SIZE<span class="token punctuation">;</span>

        range<span class="token operator">-</span><span class="token operator">></span>asma<span class="token operator">-</span><span class="token operator">></span>file<span class="token operator">-</span><span class="token operator">></span>f_op<span class="token operator">-</span><span class="token operator">></span><span class="token function">fallocate</span><span class="token punctuation">(</span>range<span class="token operator">-</span><span class="token operator">></span>asma<span class="token operator">-</span><span class="token operator">></span>file<span class="token punctuation">,</span>
                FALLOC_FL_PUNCH_HOLE <span class="token operator">|</span> FALLOC_FL_KEEP_SIZE<span class="token punctuation">,</span>
                start<span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        range<span class="token operator">-</span><span class="token operator">></span>purged <span class="token operator">=</span> ASHMEM_WAS_PURGED<span class="token punctuation">;</span>
        <span class="token function">lru_del</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>

        freed <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">range_size</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>sc<span class="token operator">-</span><span class="token operator">></span>nr_to_scan <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> freed<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，在这个过程会循环之前解锁放进来的全局链表，并且不断的调用lru_del删除rang项，重新计算剩余的空间大小。还有一个更加重要的是调用了fallocate文件操作调用。</p>
<p>还记得这个文件操作是在__shmem_file_setup中设置的吗？我们去shmem中一看shmem_fallocate方法中解映射的逻辑<br>文件：/<a href="http://androidxref.com/kernel_3.18/xref/mm/" target="_blank" rel="noopener">mm</a>/<a href="http://androidxref.com/kernel_3.18/xref/mm/shmem.c" target="_blank" rel="noopener">shmem.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">shmem_fallocate</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">,</span> loff_t offset<span class="token punctuation">,</span>
                             loff_t len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> inode <span class="token operator">*</span>inode <span class="token operator">=</span> <span class="token function">file_inode</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> shmem_sb_info <span class="token operator">*</span>sbinfo <span class="token operator">=</span> <span class="token function">SHMEM_SB</span><span class="token punctuation">(</span>inode<span class="token operator">-</span><span class="token operator">></span>i_sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> shmem_inode_info <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">SHMEM_I</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> shmem_falloc shmem_falloc<span class="token punctuation">;</span>
    pgoff_t start<span class="token punctuation">,</span> index<span class="token punctuation">,</span> end<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>FALLOC_FL_KEEP_SIZE <span class="token operator">|</span> FALLOC_FL_PUNCH_HOLE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EOPNOTSUPP<span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inode<span class="token operator">-</span><span class="token operator">></span>i_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> FALLOC_FL_PUNCH_HOLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> address_space <span class="token operator">*</span>mapping <span class="token operator">=</span> file<span class="token operator">-</span><span class="token operator">></span>f_mapping<span class="token punctuation">;</span>
        loff_t unmap_start <span class="token operator">=</span> <span class="token function">round_up</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        loff_t unmap_end <span class="token operator">=</span> <span class="token function">round_down</span><span class="token punctuation">(</span>offset <span class="token operator">+</span> len<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">DECLARE_WAIT_QUEUE_HEAD_ONSTACK</span><span class="token punctuation">(</span>shmem_falloc_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* protected by i_mutex */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token operator">-</span><span class="token operator">></span>seals <span class="token operator">&amp;</span> F_SEAL_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            error <span class="token operator">=</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        shmem_falloc<span class="token punctuation">.</span>waitq <span class="token operator">=</span> <span class="token operator">&amp;</span>shmem_falloc_waitq<span class="token punctuation">;</span>
        shmem_falloc<span class="token punctuation">.</span>start <span class="token operator">=</span> unmap_start <span class="token operator">>></span> PAGE_SHIFT<span class="token punctuation">;</span>
        shmem_falloc<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token punctuation">(</span>unmap_end <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">>></span> PAGE_SHIFT<span class="token punctuation">;</span>
        <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inode<span class="token operator">-</span><span class="token operator">></span>i_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inode<span class="token operator">-</span><span class="token operator">></span>i_private <span class="token operator">=</span> <span class="token operator">&amp;</span>shmem_falloc<span class="token punctuation">;</span>
        <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inode<span class="token operator">-</span><span class="token operator">></span>i_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token punctuation">)</span>unmap_end <span class="token operator">></span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>unmap_start<span class="token punctuation">)</span>
            <span class="token function">unmap_mapping_range</span><span class="token punctuation">(</span>mapping<span class="token punctuation">,</span> unmap_start<span class="token punctuation">,</span>
                        <span class="token number">1</span> <span class="token operator">+</span> unmap_end <span class="token operator">-</span> unmap_start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">shmem_truncate_range</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> offset <span class="token operator">+</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* No need to unmap again: hole-punching leaves COWed pages */</span>

        <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inode<span class="token operator">-</span><span class="token operator">></span>i_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inode<span class="token operator">-</span><span class="token operator">></span>i_private <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token function">wake_up_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>shmem_falloc_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inode<span class="token operator">-</span><span class="token operator">></span>i_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
out<span class="token operator">:</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inode<span class="token operator">-</span><span class="token operator">></span>i_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为调用时候设置了FALLOC_FL_PUNCH_HOLE标志，因此会走到这里面，能看到最核心的方法，调用了unmap_mapping_range解开了物理内存和虚拟内存的映射关系。同时调用shmem_truncate_range释放保存在address_space的mapping的映射区域。并且设置等大小的文件空洞。这个这个空洞的意思，可以访问超出当前的文件大小，当然要在预留的空洞大小内，当写入的时候就会把该文件撑大。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>ashmem的使用流程如下：</p>
<ul>
<li><ol>
<li>ashmem_create_region创建匿名共享内存区域，本质是调用open系统调用</li>
</ol>
</li>
<li>2.ioctl设置共享内存的名字和大小，设置的名字为/dev/ashmem/<filename>，名字的存在就为了能够让其他人找到目标</filename></li>
<li>3.mmap映射文件中的虚拟内存以及物理内存</li>
<li>4.直接对着这一块地址区域读写。</li>
</ul>
<p>其中ioctl必须设置名字和大小，不然没办法进行映射，因为在映射之前进行了校验。</p>
<p>而mmap步骤才会真正的把匿名共享内存的区域和file结构体关联起来，并且设置上shmem共享内存的文件操作符以及共享内存的vma操作。到这一步开始ashmem把工作交给了shmem中，最后通过alloc_page的方法把虚拟内存和物理页映射起来。</p>
<p>因此ashmem本质上还是依靠这shmem共享内存进行工作。那么ashmem和shmem有什么关系吗。从名字上就能知道a是指auto，也就是能够通过内存系统自动回收需要的内存。</p>
<p>因此在ashmem中有比较重要的机制锁定和解锁的机制。一般所有解锁都会放到当前amsa的unpinned_list中管理，同时会记录在全局变量ashmem_lru_list中。上锁就是把添加到unpinned_list和ashmem_lru_list的内存块记录移除。</p>
<p>因此，mmap诞生出来的整个内存块默认是解锁的。也正因为添加到全局变量ashmem_lru_list中，也就让内存管理系统遍历ashmem_lru_list通过shmem_fallocate文件操作对这些内存进行解开映射，并且留下文件空洞(其实就是想办法通过页缓存,重新申请等手段重新把这一块内存重新填补上来)，</p>
<p>原理图如下：<br><img src="/images/ashmem%E8%AE%BE%E8%AE%A1.png" alt="ashmem.png"></p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>那么ashmem和Binder有什么区别呢？先放上Binder的mmap 的文章：<br><a href="https://www.jianshu.com/p/4399aedb4d42" target="_blank" rel="noopener">Android 重学系列 Binder驱动的初始化 映射原理(二)</a></p>
<p>其实最主要的区别就是Binder的mmap时候已经通过伙伴系统绑定了物理页和虚拟内存之间的联系，而Ashmem则是通过缺页中断，调用相关的函数才进行绑定。换句话说Ashmem是按需加载，而Binder则是一开始就通过mmap就分配好。当然这也是Binder的机制相关，因为Binder一旦在一个Android启动之后就要开始通信，同时Binder需要通过mmap的方式，在Binder驱动程序中设置一个象征进程的内核缓冲区，方便一开始通信，没必要等到中断来了再申请物理页，从设计的角度来看Binder这么做更加合理。</p>
<p>两者之间的设计有什么优劣呢？很明显，Ashmem就是打通一块大的内存通道方便进程之间通信大数据。而Binder更加倾向小规模的指令，并且这种指令有明确的方向和顺序，保证每一个指令的可靠性。从功能上看起来差不多的东西，但是由于设计出发的角度看来，Binder为了保证每一个指令的可靠做了极其复杂的数据结构进行管理。</p>
<p>对了，稍后还有一篇关于Linux内存管理的笔记，如果对内存管理系统比较吃力，不妨先去看那一篇再回来看Binder和Ashmem吧。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/12/15/linux-nei-he-ni-hao-xi-lie-dui-nei-cun-xi-tong-de-zong-lan/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Linux内核你好系列 对内存系统的总览">
                        
                        <span class="card-title">Linux内核你好系列 对内存系统的总览</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言在阅读Android底层源码，特别是关于Linux内核的代码时候，如果对Linux内核整体上没有一定的认知，阅读起来一定很幸苦，本文就总结一下Linux内核内存管理系统的总览，之后有时间会把这些总览分为一个个详细的知识点一一解析其源码

                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-12-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Linux-kernel/" class="post-category">
                                    Linux kernel
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Linux/">
                        <span class="chip bg-color">Linux</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/12/08/android-chong-xue-xi-lie-surfaceflinger-de-gai-shu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="Android 重学系列 SurfaceFlinger的概述">
                        
                        <span class="card-title">Android 重学系列 SurfaceFlinger的概述</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言本文将会作为开启SurfaceFlinger的系列第一篇文章。然而SurfaceFlinger几乎贯通了整个Android领域中所有的知识。从HAL硬件抽象层到Framework层，从CPU绘制到OpenGL等硬件绘制。
为了让整个系列
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-12-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
