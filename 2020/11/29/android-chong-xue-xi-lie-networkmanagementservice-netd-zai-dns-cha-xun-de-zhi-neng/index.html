<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android重学系列 NetworkManagementService,netd在DNS查询的职能, Android | Linux | Flutter">
    <meta name="description" content="前言前四篇文章讲述了Okhttp的核心原理，得知Okhttp是基于Socket开发的，而不是基于HttpUrlConnection开发的。
其中对于客户端来说，核心有如下四个步骤：

1.dns lookup 把资源地址转化为ip地址
2.">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android重学系列 NetworkManagementService,netd在DNS查询的职能 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android重学系列 NetworkManagementService,netd在DNS查询的职能
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/网络编程/">
                                <span class="chip bg-color">网络编程</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/网络编程/" class="post-category">
                                网络编程
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-11-29
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        13.7k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        68 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前四篇文章讲述了Okhttp的核心原理，得知Okhttp是基于Socket开发的，而不是基于HttpUrlConnection开发的。</p>
<p>其中对于客户端来说，核心有如下四个步骤：</p>
<ul>
<li>1.dns lookup 把资源地址转化为ip地址</li>
<li>2.socket.connect 通过socket把客户端和服务端联系起来</li>
<li>3.socket.starthandshake</li>
<li>4.socket.handshake</li>
</ul>
<p>本文着重来看看DNS做了什么事情。在Okhttp默认的DNS 对象就是如下这个DnsSystem对象。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">private</span> <span class="token keyword">class</span> DnsSystem <span class="token operator">:</span> Dns <span class="token punctuation">{</span>
      <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">lookup</span><span class="token punctuation">(</span>hostname<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>InetAddress<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> InetAddress<span class="token punctuation">.</span><span class="token function">getAllByName</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> NullPointerException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token function">UnknownHostException</span><span class="token punctuation">(</span><span class="token string">"Broken system behaviour for dns lookup of <span class="token interpolation variable">$hostname</span>"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span>
            <span class="token function">initCause</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然而本文并不会立即和大家聊DNS的解析过程。因为在Android的网络模块中，存在着2个十分重要的对象：</p>
<ul>
<li>1.用于监控网络状态的 NetworkManagementService</li>
<li>2.Android/Linux 网络监控核心netd进程。</li>
</ul>
<p>而DNS的查询恰好是通过2个模块的互相运作才能执行。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="netd进程启动"><a href="#netd进程启动" class="headerlink" title="netd进程启动"></a>netd进程启动</h2><p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/" target="_blank" rel="noopener">netd</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/server/netd.rc" target="_blank" rel="noopener">netd.rc</a></p>
<pre><code>service netd /system/bin/netd
    class main
    socket netd stream 0660 root system
    socket dnsproxyd stream 0660 root inet
    socket mdns stream 0660 root system
    socket fwmarkd stream 0660 root inet
    onrestart restart zygote
    onrestart restart zygote_secondary</code></pre><p>关于rc文件如何解析，本文就不多赘述了。详情可以阅读我写的 <a href="https://www.jianshu.com/p/68758696b2ab" target="_blank" rel="noopener">系统启动到Activity(上)</a> 一文。</p>
<p>能看到在这个过程中，会启动一个<code>netd</code> 进程，接着会启动<code>netd</code>,<code>dnsproxyd</code>,<code>mdns</code>,<code>fwmarkd</code> 四个socket。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/" target="_blank" rel="noopener">netd</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/server/main.cpp" target="_blank" rel="noopener">main.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">using</span> android<span class="token operator">::</span>net<span class="token operator">::</span>gCtls<span class="token punctuation">;</span>
    Stopwatch s<span class="token punctuation">;</span>

    <span class="token function">remove_pid_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">blockSigpipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> sock <span class="token operator">:</span> <span class="token punctuation">{</span> CommandListener<span class="token operator">::</span>SOCKET_NAME<span class="token punctuation">,</span>
                              DnsProxyListener<span class="token operator">::</span>SOCKET_NAME<span class="token punctuation">,</span>
                              FwmarkServer<span class="token operator">::</span>SOCKET_NAME<span class="token punctuation">,</span>
                              MDnsSdListener<span class="token operator">::</span>SOCKET_NAME <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setCloseOnExec</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    NetlinkManager <span class="token operator">*</span>nm <span class="token operator">=</span> NetlinkManager<span class="token operator">::</span><span class="token function">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nm <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    gCtls <span class="token operator">=</span> <span class="token keyword">new</span> android<span class="token operator">::</span>net<span class="token operator">::</span><span class="token function">Controllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gCtls<span class="token operator">-</span><span class="token operator">></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    CommandListener cl<span class="token punctuation">;</span>
    nm<span class="token operator">-</span><span class="token operator">></span><span class="token function">setBroadcaster</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SocketListener <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nm<span class="token operator">-</span><span class="token operator">></span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>NFLogListener<span class="token operator">></span> logListener<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> result <span class="token operator">=</span> <span class="token function">makeNFLogListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isOk</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logListener <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> status <span class="token operator">=</span> gCtls<span class="token operator">-</span><span class="token operator">></span>wakeupCtrl<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>logListener<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>


    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"ANDROID_DNS_MODE"</span><span class="token punctuation">,</span> <span class="token string">"local"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    DnsProxyListener <span class="token function">dpl</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gCtls<span class="token operator">-</span><span class="token operator">></span>netCtrl<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gCtls<span class="token operator">-</span><span class="token operator">></span>eventReporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dpl<span class="token punctuation">.</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    MDnsSdListener mdnsl<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mdnsl<span class="token punctuation">.</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    FwmarkServer <span class="token function">fwmarkServer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gCtls<span class="token operator">-</span><span class="token operator">></span>netCtrl<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gCtls<span class="token operator">-</span><span class="token operator">></span>eventReporter<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gCtls<span class="token operator">-</span><span class="token operator">></span>trafficCtrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwmarkServer<span class="token punctuation">.</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Stopwatch subTime<span class="token punctuation">;</span>
    status_t ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> NetdNativeService<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> android<span class="token operator">::</span>OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token keyword">if</span> <span class="token punctuation">(</span>cl<span class="token punctuation">.</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token function">write_pid_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    NetdHwService mHwSvc<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> mHwSvc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> android<span class="token operator">::</span>OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    IPCThreadState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">joinThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">remove_pid_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.屏蔽SIGPIPE信号，构建一个<code>NetlinkManager</code>单例对象</li>
<li>2.实例化<code>android::net::Controllers</code>，并调用<code>init</code>初始化</li>
<li>3.实例化<code>CommandListener</code>,这个监听者将会监听名为<code>netd</code>的socket</li>
<li>4.<code>NetlinkManager</code>的<code>setBroadcaster</code>把广播消息的发送设置为<code>CommandListener</code>，并调用<code>NetlinkManager</code>的start方法。</li>
<li>5.初始化<code>NFLogListener</code> 日志对象到<code>Controllers</code> 中。之后下面所有的组件都会设置该<code>Controllers</code> 到其中从而获得日志。</li>
<li>5.设置当前<code>netd</code>进程的环境变量<code>ANDROID_DNS_MODE</code> 为<code>local</code></li>
<li>6.生成<code>DnsProxyListener</code>对象并启动线程监听，是DNS发送请求和返回的本地代理对象，监听了<code>dnsproxyd</code> socket</li>
<li><ol start="7">
<li>生成<code>MDnsSdListener</code>对象并启动线程监听<code>mdns</code> socket。这个socket实际上全名为<code>Multicast DNS Service Service Discovery</code> 会自动给局域网内没有分配地址的ip给自动分配ip。是基于组播域名服务实现的</li>
</ol>
</li>
<li>8.生成一个FwmarkServer对象，并监听<code>fwmarkd</code> socket,这个socket实际上是用来监听标记从防火墙来的数据包。</li>
<li><ol start="9">
<li>启动Binder服务NetdNativeService，可以跨进程操作中<code>android::net::Controllers</code>的行为</li>
</ol>
</li>
<li>10.启动CommandListener 对所有socket接口命令监听</li>
<li>11.启动<code>NetdHwService</code>服务</li>
<li>12.通过joinThreadPool 阻塞当前的进程</li>
</ul>
<p>这里我们分别看看都做了什么。</p>
<h3 id="NetlinkManager-初始化"><a href="#NetlinkManager-初始化" class="headerlink" title="NetlinkManager 初始化"></a>NetlinkManager 初始化</h3><pre class="line-numbers language-cpp"><code class="language-cpp">NetlinkManager <span class="token operator">*</span>NetlinkManager<span class="token operator">::</span><span class="token function">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sInstance<span class="token punctuation">)</span>
        sInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">NetlinkManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实例化NetlinkManager对象后，设置一个CommandListener 到NetlinkManager 中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">void</span> <span class="token function">setBroadcaster</span><span class="token punctuation">(</span>SocketListener <span class="token operator">*</span>sl<span class="token punctuation">)</span> <span class="token punctuation">{</span> mBroadcaster <span class="token operator">=</span> sl<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    SocketListener <span class="token operator">*</span><span class="token function">getBroadcaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mBroadcaster<span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>接着调用start方法启动<code>NetlinkManager</code>.</p>
<h4 id="NetlinkManager-start"><a href="#NetlinkManager-start" class="headerlink" title="NetlinkManager start"></a>NetlinkManager start</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> NetlinkManager<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mUeventHandler <span class="token operator">=</span> <span class="token function">setupSocket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mUeventSock<span class="token punctuation">,</span> NETLINK_KOBJECT_UEVENT<span class="token punctuation">,</span>
         <span class="token number">0xffffffff</span><span class="token punctuation">,</span> NetlinkListener<span class="token operator">::</span>NETLINK_FORMAT_ASCII<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mRouteHandler <span class="token operator">=</span> <span class="token function">setupSocket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mRouteSock<span class="token punctuation">,</span> NETLINK_ROUTE<span class="token punctuation">,</span>
                                     RTMGRP_LINK <span class="token operator">|</span>
                                     RTMGRP_IPV4_IFADDR <span class="token operator">|</span>
                                     RTMGRP_IPV6_IFADDR <span class="token operator">|</span>
                                     RTMGRP_IPV6_ROUTE <span class="token operator">|</span>
                                     <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>RTNLGRP_ND_USEROPT <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         NetlinkListener<span class="token operator">::</span>NETLINK_FORMAT_BINARY<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mQuotaHandler <span class="token operator">=</span> <span class="token function">setupSocket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mQuotaSock<span class="token punctuation">,</span> NETLINK_NFLOG<span class="token punctuation">,</span>
            NFLOG_QUOTA_GROUP<span class="token punctuation">,</span> NetlinkListener<span class="token operator">::</span>NETLINK_FORMAT_BINARY<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mStrictHandler <span class="token operator">=</span> <span class="token function">setupSocket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mStrictSock<span class="token punctuation">,</span> NETLINK_NETFILTER<span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span> NetlinkListener<span class="token operator">::</span>NETLINK_FORMAT_BINARY_UNICAST<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这三个步骤都是生成一个socket对象，并设置domain为<code>PF_NETLINK</code>,然后设置不同的Type用于监听socket从内核模块释放的信息。</p>
<ul>
<li><p>1.监听<code>NETLINK_KOBJECT_UEVENT</code> 代表的socket端口，代表kobject事件。kobject一般是指内核通知外部某个内核模块卸载和加载的。这里主要监听的是<code>/sys/class/net</code>。把获取的数据转化为<code>ASCII</code>字符串到NetworkLinker</p>
</li>
<li><p>2.监听一个<code>NETLINK_ROUTE</code> 所代表的socket。这个socket就是指内核中routing或link改变时候返回的UEvent消息。监听如<code>RTMGRP_LINK</code> 事件，这样就能从内核模块中获取到当前Android 网络断开还是链接状态。</p>
</li>
<li><p>3.监听一个<code>NETLINK_NETFILTER</code>所代表的接口。用于控制带宽，带宽可以设置一个预警数值，超过就会发送一个警告。该功能是iptable的功能之一。</p>
</li>
</ul>
<h3 id="CommandListener-初始化"><a href="#CommandListener-初始化" class="headerlink" title="CommandListener 初始化"></a>CommandListener 初始化</h3><pre><code>static constexpr const char* SOCKET_NAME = "netd";</code></pre><pre class="line-numbers language-cpp"><code class="language-cpp">CommandListener<span class="token operator">::</span><span class="token function">CommandListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">FrameworkListener</span><span class="token punctuation">(</span>SOCKET_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">InterfaceCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">IpFwdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gCtls<span class="token operator">-</span><span class="token operator">></span>tetherCtrl<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">TetherCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gCtls<span class="token operator">-</span><span class="token operator">></span>tetherCtrl<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">NatCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gCtls<span class="token operator">-</span><span class="token operator">></span>tetherCtrl<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ListTtysCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">PppdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">BandwidthControlCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gCtls<span class="token operator">-</span><span class="token operator">></span>bandwidthCtrl<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">IdletimerControlCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ResolverCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">FirewallCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gCtls<span class="token operator">-</span><span class="token operator">></span>firewallCtrl<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ClatdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">NetworkCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">StrictCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里面设置了一个socket名字为<code>netd</code>,并在父类<code>FrameworkListener</code>进行初始化。</p>
<p>在这一层构造函数中，会注册不同命令的监听。当从<code>netd</code>socket中接受到信息的到来就会检测获取第一个参数，是否是对应类型的CMD。</p>
<p>比如说，这里注册了InterfaceCmd对象：</p>
<pre><code>CommandListener::InterfaceCmd::InterfaceCmd() :
                 NetdCommand("interface") {
}</code></pre><p>为这个NetdCommand 设置了一个对应的字符串<code>interface</code>.当<code>netd</code>socket中监听到第一个参数字符串是<code>interface</code>,找到注册到<code>FrameworkListener</code>集合中的命令数据，并且调用对应<code>NetdCommand</code>的<code>runCommand</code>方法,从而执行对应的逻辑。</p>
<h3 id="DnsProxyListener-初始化"><a href="#DnsProxyListener-初始化" class="headerlink" title="DnsProxyListener 初始化"></a>DnsProxyListener 初始化</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/" target="_blank" rel="noopener">netd</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/server/DnsProxyListener.cpp" target="_blank" rel="noopener">DnsProxyListener.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> SOCKET_NAME <span class="token operator">=</span> <span class="token string">"dnsproxyd"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">DnsProxyListener<span class="token operator">::</span><span class="token function">DnsProxyListener</span><span class="token punctuation">(</span><span class="token keyword">const</span> NetworkController<span class="token operator">*</span> netCtrl<span class="token punctuation">,</span> EventReporter<span class="token operator">*</span> eventReporter<span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">FrameworkListener</span><span class="token punctuation">(</span>SOCKET_NAME<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mNetCtrl</span><span class="token punctuation">(</span>netCtrl<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mEventReporter</span><span class="token punctuation">(</span>eventReporter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">registerCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">GetAddrInfoCmd</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">GetHostByAddrCmd</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">GetHostByNameCmd</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>DnsProxyListener</code> 也是<code>FrameworkListener</code>派生类。注册了<code>GetAddrInfoCmd</code>命令域名查找ip地址对象，<code>GetHostByAddrCmd</code>通过返回给定ip地址服务器信息命令对象,<code>GetHostByNameCmd</code>通过域名查找服务器信息命令对象.</p>
<p>简单来看看这几个对象注册命令是什么：</p>
<h5 id="GetAddrInfoCmd"><a href="#GetAddrInfoCmd" class="headerlink" title="GetAddrInfoCmd"></a>GetAddrInfoCmd</h5><pre class="line-numbers language-cpp"><code class="language-cpp">DnsProxyListener<span class="token operator">::</span>GetAddrInfoCmd<span class="token operator">::</span><span class="token function">GetAddrInfoCmd</span><span class="token punctuation">(</span>DnsProxyListener<span class="token operator">*</span> dnsProxyListener<span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">NetdCommand</span><span class="token punctuation">(</span><span class="token string">"getaddrinfo"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mDnsProxyListener</span><span class="token punctuation">(</span>dnsProxyListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>对应的命令识别字符串是<code>getaddrinfo</code></p>
<h5 id="GetHostByAddrCmd"><a href="#GetHostByAddrCmd" class="headerlink" title="GetHostByAddrCmd"></a>GetHostByAddrCmd</h5><pre class="line-numbers language-cpp"><code class="language-cpp">DnsProxyListener<span class="token operator">::</span>GetHostByAddrCmd<span class="token operator">::</span><span class="token function">GetHostByAddrCmd</span><span class="token punctuation">(</span><span class="token keyword">const</span> DnsProxyListener<span class="token operator">*</span> dnsProxyListener<span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">NetdCommand</span><span class="token punctuation">(</span><span class="token string">"gethostbyaddr"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mDnsProxyListener</span><span class="token punctuation">(</span>dnsProxyListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>对应的命令识别字符串是<code>gethostbyaddr</code></p>
<h5 id="GetHostByNameCmd"><a href="#GetHostByNameCmd" class="headerlink" title="GetHostByNameCmd"></a>GetHostByNameCmd</h5><pre class="line-numbers language-cpp"><code class="language-cpp">DnsProxyListener<span class="token operator">::</span>GetHostByNameCmd<span class="token operator">::</span><span class="token function">GetHostByNameCmd</span><span class="token punctuation">(</span>DnsProxyListener<span class="token operator">*</span> dnsProxyListener<span class="token punctuation">)</span> <span class="token operator">:</span>
      <span class="token function">NetdCommand</span><span class="token punctuation">(</span><span class="token string">"gethostbyname"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mDnsProxyListener</span><span class="token punctuation">(</span>dnsProxyListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>对应的命令识别字符串是<code>gethostbyname</code></p>
<h4 id="DnsProxyListener-startListener"><a href="#DnsProxyListener-startListener" class="headerlink" title="DnsProxyListener startListener"></a>DnsProxyListener startListener</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> SocketListener<span class="token operator">::</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token keyword">int</span> backlog<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSocketName <span class="token operator">&amp;&amp;</span> mSock <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        errno <span class="token operator">=</span> EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mSocketName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mSock <span class="token operator">=</span> <span class="token function">android_get_control_socket</span><span class="token punctuation">(</span>mSocketName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fcntl</span><span class="token punctuation">(</span>mSock<span class="token punctuation">,</span> F_SETFD<span class="token punctuation">,</span> FD_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mListen <span class="token operator">&amp;&amp;</span> <span class="token function">listen</span><span class="token punctuation">(</span>mSock<span class="token punctuation">,</span> backlog<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mListen<span class="token punctuation">)</span>
        mClients<span class="token operator">-</span><span class="token operator">></span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">SocketClient</span><span class="token punctuation">(</span>mSock<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mUseCmdNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pipe</span><span class="token punctuation">(</span>mCtrlPipe<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mThread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> SocketListener<span class="token operator">::</span>threadStart<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程中</p>
<ul>
<li><p>1.如果遇到需要监听的sokcet的listen的监听方法。但是这里是是生成一个新的SocketClient对象保存当前的需要监听scoket缓存到mClients</p>
</li>
<li><p>2.启动新的线程执行<code>threadStart</code> 方法</p>
</li>
<li><p>3.线程中会持续监听socket的数据，如果有数据返回就会调用<code>onDataAvailable</code>方法到FrameworkListener。</p>
</li>
</ul>
<h3 id="MDnsSdListener-初始化"><a href="#MDnsSdListener-初始化" class="headerlink" title="MDnsSdListener  初始化"></a>MDnsSdListener  初始化</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/" target="_blank" rel="noopener">netd</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/netd/server/MDnsSdListener.cpp" target="_blank" rel="noopener">MDnsSdListener.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> SOCKET_NAME <span class="token operator">=</span> <span class="token string">"mdns"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">MDnsSdListener<span class="token operator">::</span><span class="token function">MDnsSdListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">FrameworkListener</span><span class="token punctuation">(</span>SOCKET_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Monitor <span class="token operator">*</span>m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Handler</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

MDnsSdListener<span class="token operator">::</span>Handler<span class="token operator">::</span><span class="token function">Handler</span><span class="token punctuation">(</span>Monitor <span class="token operator">*</span>m<span class="token punctuation">,</span> MDnsSdListener <span class="token operator">*</span>listener<span class="token punctuation">)</span> <span class="token operator">:</span>
   <span class="token function">NetdCommand</span><span class="token punctuation">(</span><span class="token string">"mdnssd"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   mMonitor <span class="token operator">=</span> m<span class="token punctuation">;</span>
   mListener <span class="token operator">=</span> listener<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注册了一个<code>mdnssd</code> 命令监听。当调用了startListener方法后就会构建一个<code>mdns</code>socket 监听<code>mdnssd</code>命令的到来。</p>
<h3 id="FwmarkServer-初始化"><a href="#FwmarkServer-初始化" class="headerlink" title="FwmarkServer 初始化"></a>FwmarkServer 初始化</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> SOCKET_NAME <span class="token operator">=</span> <span class="token string">"fwmarkd"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">FwmarkServer<span class="token operator">::</span><span class="token function">FwmarkServer</span><span class="token punctuation">(</span>NetworkController<span class="token operator">*</span> networkController<span class="token punctuation">,</span> EventReporter<span class="token operator">*</span> eventReporter<span class="token punctuation">,</span>
                           TrafficController<span class="token operator">*</span> trafficCtrl<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">SocketListener</span><span class="token punctuation">(</span>SOCKET_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mNetworkController</span><span class="token punctuation">(</span>networkController<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mEventReporter</span><span class="token punctuation">(</span>eventReporter<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mTrafficCtrl</span><span class="token punctuation">(</span>trafficCtrl<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先实例化一个<code>fwmarkd</code>socket，并监听这个socket传递过来的内容。</p>
<ul>
<li>1.NetworkController 核心处理的是关于iptables的路由规则的</li>
<li>2.EventReporter 则是把调用socket的connect方法后，回调上来的状态数据</li>
<li>3.TrafficController 则是进行流量监控。所有流量相关的开销都会记录在<code>/sys/fs/bpf</code> 下的文件。比如说当<code>FwmarkServer</code>收到回调则会判断命令中是否带有<code>TAG_SOCKET</code> 这个枚举也就是数字(8)那么就往<code>traffic_cookie_tag_map</code>记录当前的uid以及信息用于标记socket。 </li>
</ul>
<p>注意<code>TrafficController</code>隶属于<code>eBPF 网络流浪监控模块</code> 。除了标记和取消标记socket外还承担了删除流量数据的职责。可以同时从<code>/sys/fs/bpf</code> 下其他文件中实时的读取不同uid，appid的流量数据。</p>
<h3 id="NetworkManagementService-初始化"><a href="#NetworkManagementService-初始化" class="headerlink" title="NetworkManagementService 初始化"></a>NetworkManagementService 初始化</h3><p>初始化位置在为文件SystemServer中：</p>
<pre class="line-numbers language-java"><code class="language-java">            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                networkManagement <span class="token operator">=</span> NetworkManagementService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>NETWORKMANAGEMENT_SERVICE<span class="token punctuation">,</span> networkManagement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reportWtf</span><span class="token punctuation">(</span><span class="token string">"starting NetworkManagement Service"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/NetworkManagementService.java" target="_blank" rel="noopener">NetworkManagementService.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">static</span> <span class="token keyword">final</span> String NETD_SERVICE_NAME <span class="token operator">=</span> <span class="token string">"netd"</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> NetworkManagementService <span class="token function">create</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> String socket<span class="token punctuation">,</span> SystemServices services<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> NetworkManagementService service <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">NetworkManagementService</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> services<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> CountDownLatch connectedSignal <span class="token operator">=</span> service<span class="token punctuation">.</span>mConnectedSignal<span class="token punctuation">;</span>
        service<span class="token punctuation">.</span>mThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectedSignal<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">connectNativeNetdService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> service<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> NetworkManagementService <span class="token function">create</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> NETD_SERVICE_NAME<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SystemServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.传入的是SystemServer的Context对象</li>
<li>2.设置一个名为<code>netd</code>的socket名到NetworkManagementService中。</li>
<li>3.生成一个SystemServices到NetworkManagementService中。</li>
<li>4.通过connectedSignal等待<code>SystemServices</code>完成后，通过<code>SystemServices</code>的<code>connectNativeNetdService</code>链接到<code>netd</code>进程</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token function">NetworkManagementService</span><span class="token punctuation">(</span>
            Context context<span class="token punctuation">,</span> String socket<span class="token punctuation">,</span> SystemServices services<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
        mServices <span class="token operator">=</span> services<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// make sure this is on the same looper as our NativeDaemonConnector for sync purposes</span>
        mFgHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>FgThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment" spellcheck="true">//PowerManager pm = (PowerManager)context.getSystemService(Context.POWER_SERVICE);</span>
        PowerManager<span class="token punctuation">.</span>WakeLock wl <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, NETD_TAG);</span>

        mConnector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeDaemonConnector</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">NetdCallbackReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> socket<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> NETD_TAG<span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> wl<span class="token punctuation">,</span>
                FgThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mConnector<span class="token punctuation">,</span> NETD_TAG<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mDaemonHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>FgThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add ourself to the Watchdog monitors.</span>
        Watchdog<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addMonitor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mServices<span class="token punctuation">.</span><span class="token function">registerLocalService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LocalService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mTetheringStatsProviders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTetheringStatsProviders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NetdTetheringStatsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"netd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.在其中生成一个持有FgThread线程Looper的Handler，注意FgThread 是一个HandlerThread</li>
<li>2.生成一个NativeDaemonConnector 后台常驻链接，链接到<code>netd</code>进程中，并通过<code>NetdCallbackReceiver</code>监听<code>netd</code>进程的回调。</li>
<li>3.mDaemonHandler 也是属于<code>FgThread</code> 线程的Looper</li>
<li>4.<code>Watchdog</code>监听当前的<code>NetworkManagementService</code> 的是否卡死的状态。</li>
</ul>
<h4 id="NativeDaemonConnector-实例化"><a href="#NativeDaemonConnector-实例化" class="headerlink" title="NativeDaemonConnector 实例化"></a>NativeDaemonConnector 实例化</h4><p>注意 <code>NativeDaemonConnector</code>是一个Runnable对象，在上面一节中进行Thread的实例化和start后会启动run方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token function">NativeDaemonConnector</span><span class="token punctuation">(</span>INativeDaemonConnectorCallbacks callbacks<span class="token punctuation">,</span> String socket<span class="token punctuation">,</span>
            <span class="token keyword">int</span> responseQueueSize<span class="token punctuation">,</span> String logTag<span class="token punctuation">,</span> <span class="token keyword">int</span> maxLogSize<span class="token punctuation">,</span> PowerManager<span class="token punctuation">.</span>WakeLock wl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> responseQueueSize<span class="token punctuation">,</span> logTag<span class="token punctuation">,</span> maxLogSize<span class="token punctuation">,</span> wl<span class="token punctuation">,</span>
                FgThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">NativeDaemonConnector</span><span class="token punctuation">(</span>INativeDaemonConnectorCallbacks callbacks<span class="token punctuation">,</span> String socket<span class="token punctuation">,</span>
            <span class="token keyword">int</span> responseQueueSize<span class="token punctuation">,</span> String logTag<span class="token punctuation">,</span> <span class="token keyword">int</span> maxLogSize<span class="token punctuation">,</span> PowerManager<span class="token punctuation">.</span>WakeLock wl<span class="token punctuation">,</span>
            Looper looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mCallbacks <span class="token operator">=</span> callbacks<span class="token punctuation">;</span>
        mSocket <span class="token operator">=</span> socket<span class="token punctuation">;</span>
        mResponseQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseQueue</span><span class="token punctuation">(</span>responseQueueSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWakeLock <span class="token operator">=</span> wl<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mWakeLock <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mWakeLock<span class="token punctuation">.</span><span class="token function">setReferenceCounted</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mLooper <span class="token operator">=</span> looper<span class="token punctuation">;</span>
        mSequenceNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TAG <span class="token operator">=</span> logTag <span class="token operator">!=</span> null <span class="token operator">?</span> logTag <span class="token operator">:</span> <span class="token string">"NativeDaemonConnector"</span><span class="token punctuation">;</span>
        mLocalLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalLog</span><span class="token punctuation">(</span>maxLogSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mCallbackHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>mLooper<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isShuttingDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">listenToSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">loge</span><span class="token punctuation">(</span><span class="token string">"Error in NativeDaemonConnector: "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isShuttingDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                SystemClock<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.在构造函数中<code>mResponseQueue</code>就是<code>netd</code>发送的过来的消息的消息队列</li>
<li>2.在run方法中有一个死循环，调用<code>listenToSocket</code>不断的监听socket的到来。</li>
</ul>
<h5 id="listenToSocket"><a href="#listenToSocket" class="headerlink" title="listenToSocket"></a>listenToSocket</h5><pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">private</span> LocalSocketAddress <span class="token function">determineSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSocket<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"__test__"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> Build<span class="token punctuation">.</span>IS_DEBUGGABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocketAddress</span><span class="token punctuation">(</span>mSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocketAddress</span><span class="token punctuation">(</span>mSocket<span class="token punctuation">,</span> LocalSocketAddress<span class="token punctuation">.</span>Namespace<span class="token punctuation">.</span>RESERVED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">listenToSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        LocalSocket socket <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            LocalSocketAddress address <span class="token operator">=</span> <span class="token function">determineSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>

            InputStream inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mDaemonLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mOutputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mCallbacks<span class="token punctuation">.</span><span class="token function">onDaemonConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            FileDescriptor<span class="token punctuation">[</span><span class="token punctuation">]</span> fdList <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> count <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> start<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">loge</span><span class="token punctuation">(</span><span class="token string">"got "</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">" reading with start = "</span> <span class="token operator">+</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                fdList <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getAncillaryFileDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Add our starting point to the count and reset the start.</span>
                count <span class="token operator">+=</span> start<span class="token punctuation">;</span>
                start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> String rawEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>
                                buffer<span class="token punctuation">,</span> start<span class="token punctuation">,</span> i <span class="token operator">-</span> start<span class="token punctuation">,</span> StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">boolean</span> releaseWl <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token keyword">final</span> NativeDaemonEvent event <span class="token operator">=</span>
                                    NativeDaemonEvent<span class="token punctuation">.</span><span class="token function">parseRawEvent</span><span class="token punctuation">(</span>rawEvent<span class="token punctuation">,</span> fdList<span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"RCV &lt;- {"</span> <span class="token operator">+</span> event <span class="token operator">+</span> <span class="token string">"}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">isClassUnsolicited</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// TODO: migrate to sending NativeDaemonEvent instances</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallbacks<span class="token punctuation">.</span><span class="token function">onCheckHoldWakeLock</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                        <span class="token operator">&amp;&amp;</span> mWakeLock <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    mWakeLock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    releaseWl <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                Message msg <span class="token operator">=</span> mCallbackHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>
                                        event<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uptimeMillisInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getRawEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallbackHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    releaseWl <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                mResponseQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getCmdNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Problem parsing message "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>releaseWl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                mWakeLock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        start <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>


                <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">!=</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> remaining <span class="token operator">=</span> BUFFER_SIZE <span class="token operator">-</span> start<span class="token punctuation">;</span>
                    System<span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> start<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    start <span class="token operator">=</span> remaining<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">loge</span><span class="token punctuation">(</span><span class="token string">"Communications error: "</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程实际上做的事情就是一件：</p>
<ul>
<li>1.不断的监听从<code>netd</code>socket返回回来的信息，并一一添加到ResponseQueue中，进行消费回调外部监听。</li>
</ul>
<p>这里的<code>netd</code>socket实际上就是指<code>netd</code>进程创建的时候，通过app_main 解析init.rc创建出来的socket。而在<code>netd</code>进程也构造了这个socket，随时进行发送或者监听信息。</p>
<p>值得注意的是，这里面有一个有趣的对象<code>PowerManager.WakeLock</code>.每当从<code>netd</code>监听到消息的时候，发现从<code>netd</code>进程传送过来的事件是从<code>netd</code>主动来的请求，那么就会调用<code>PowerManager.WakeLock</code> 立即唤醒设备发送通过Handler发送数据。</p>
<p>这也是为什么耗电量会被Android系统监听到的原因的，这个WakeLock 唤醒锁是一个重要的依据。</p>
<h2 id="InetAddress-getAllByName-DNS-查询过程"><a href="#InetAddress-getAllByName-DNS-查询过程" class="headerlink" title="InetAddress.getAllByName DNS 查询过程"></a>InetAddress.getAllByName DNS 查询过程</h2><p>对NetworkManagementService以及netd 两个服务都有了大致的了解后，我们才好开展本次重点话题，Android是怎么进行通过域名进行DNS查询到ip地址的。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> InetAddressImpl impl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Inet6AddressImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> InetAddress<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getAllByName</span><span class="token punctuation">(</span>String host<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> UnknownHostException <span class="token punctuation">{</span>

        <span class="token keyword">return</span> impl<span class="token punctuation">.</span><span class="token function">lookupAllHostAddr</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> NETID_UNSET<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程实际上是交给了<code>Inet6AddressImpl</code>的lookupAllHostAddr处理。</p>
<h4 id="Inet6AddressImpl-lookupAllHostAddr"><a href="#Inet6AddressImpl-lookupAllHostAddr" class="headerlink" title="Inet6AddressImpl lookupAllHostAddr"></a>Inet6AddressImpl lookupAllHostAddr</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> InetAddress<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">lookupAllHostAddr</span><span class="token punctuation">(</span>String host<span class="token punctuation">,</span> <span class="token keyword">int</span> netId<span class="token punctuation">)</span> <span class="token keyword">throws</span> UnknownHostException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>host <span class="token operator">==</span> null <span class="token operator">||</span> host<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> <span class="token function">loopbackAddresses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Is it a numeric address?</span>
        InetAddress result <span class="token operator">=</span> InetAddress<span class="token punctuation">.</span><span class="token function">parseNumericAddressNoThrow</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> InetAddress<span class="token punctuation">.</span><span class="token function">disallowDeprecatedFormats</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnknownHostException</span><span class="token punctuation">(</span><span class="token string">"Deprecated IPv4 address format: "</span> <span class="token operator">+</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InetAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> result <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">lookupHostByName</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> netId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果传入的host 为空则通过loopbackAddresses返回，ipv6的默认虚拟回环地址以及ipv4的默认虚拟回环地址。就是我们常说的localhost，ipv4默认为<code>127.0.0.0/8</code> 以及 ipv6为<code>:: 1/128</code>。虚拟回环地址是一个特殊的网络接口，所有的网络数据都会在这个虚拟的网卡中处理。</p>
</li>
<li><p>2.InetAddress的parseNumericAddressNoThrow 处理带有<code>[:]</code>格式的ip地址，并通过<code>Libcore.os.android_getaddrinfo</code>进行查询，查到了则返回。</p>
</li>
<li><p>3.如果不符合上面的格式则调用<code>lookupHostByName</code>通过域名查找ip地址。</p>
</li>
</ul>
<h5 id="Inet6AddressImpl-lookupHostByName"><a href="#Inet6AddressImpl-lookupHostByName" class="headerlink" title="Inet6AddressImpl lookupHostByName"></a>Inet6AddressImpl lookupHostByName</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> InetAddress<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">lookupHostByName</span><span class="token punctuation">(</span>String host<span class="token punctuation">,</span> <span class="token keyword">int</span> netId<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> UnknownHostException <span class="token punctuation">{</span>
        BlockGuard<span class="token punctuation">.</span><span class="token function">getThreadPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Do we have a result cached?</span>
        Object cachedResult <span class="token operator">=</span> addressCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> netId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedResult <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedResult <span class="token keyword">instanceof</span> <span class="token class-name">InetAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// A cached positive result.</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>InetAddress<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> cachedResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// A cached negative result.</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnknownHostException</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> cachedResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            StructAddrinfo hints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructAddrinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_ADDRCONFIG<span class="token punctuation">;</span>
            hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>

            hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
            InetAddress<span class="token punctuation">[</span><span class="token punctuation">]</span> addresses <span class="token operator">=</span> Libcore<span class="token punctuation">.</span>os<span class="token punctuation">.</span><span class="token function">android_getaddrinfo</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> hints<span class="token punctuation">,</span> netId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>InetAddress address <span class="token operator">:</span> addresses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                address<span class="token punctuation">.</span><span class="token function">holder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hostName <span class="token operator">=</span> host<span class="token punctuation">;</span>
                address<span class="token punctuation">.</span><span class="token function">holder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>originalHostName <span class="token operator">=</span> host<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            addressCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> netId<span class="token punctuation">,</span> addresses<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> addresses<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GaiException</span> gaiException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>构建了一个<code>StructAddrinfo</code>对象，保存了三个十分重要的标志：</p>
<ul>
<li>ai_flags 为AI_ADDRCONFIG</li>
<li>ai_family 为AF_UNSPEC</li>
<li>ai_socktype 为SOCK_STREAM</li>
</ul>
<p>并把StructAddrinfo作为参数传入方法Libcore.os.android_getaddrinfo中处理。</p>
<h4 id="Libcore-os-android-getaddrinfo"><a href="#Libcore-os-android-getaddrinfo" class="headerlink" title="Libcore.os.android_getaddrinfo"></a>Libcore.os.android_getaddrinfo</h4><p>这个方法实际上就是一个native方法，对应如下文件：<br>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/" target="_blank" rel="noopener">libcore</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/" target="_blank" rel="noopener">luni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/" target="_blank" rel="noopener">src</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/main/" target="_blank" rel="noopener">main</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/main/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/main/native/libcore_io_Linux.cpp" target="_blank" rel="noopener">libcore_io_Linux.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jobjectArray <span class="token function">Linux_android_getaddrinfo</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jstring javaNode<span class="token punctuation">,</span>
        jobject javaHints<span class="token punctuation">,</span> jint netId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ScopedUtfChars <span class="token function">node</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> javaNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> jfieldID flagsFid <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFieldID</span><span class="token punctuation">(</span>JniConstants<span class="token operator">::</span>structAddrinfoClass<span class="token punctuation">,</span> <span class="token string">"ai_flags"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> jfieldID familyFid <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFieldID</span><span class="token punctuation">(</span>JniConstants<span class="token operator">::</span>structAddrinfoClass<span class="token punctuation">,</span> <span class="token string">"ai_family"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> jfieldID socktypeFid <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFieldID</span><span class="token punctuation">(</span>JniConstants<span class="token operator">::</span>structAddrinfoClass<span class="token punctuation">,</span> <span class="token string">"ai_socktype"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> jfieldID protocolFid <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFieldID</span><span class="token punctuation">(</span>JniConstants<span class="token operator">::</span>structAddrinfoClass<span class="token punctuation">,</span> <span class="token string">"ai_protocol"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    addrinfo hints<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>hints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetIntField</span><span class="token punctuation">(</span>javaHints<span class="token punctuation">,</span> flagsFid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetIntField</span><span class="token punctuation">(</span>javaHints<span class="token punctuation">,</span> familyFid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetIntField</span><span class="token punctuation">(</span>javaHints<span class="token punctuation">,</span> socktypeFid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_protocol <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetIntField</span><span class="token punctuation">(</span>javaHints<span class="token punctuation">,</span> protocolFid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    addrinfo<span class="token operator">*</span> addressList <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    errno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">android_getaddrinfofornet</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> netId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addressList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>addrinfo<span class="token punctuation">,</span> addrinfo_deleter<span class="token operator">></span> <span class="token function">addressListDeleter</span><span class="token punctuation">(</span>addressList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">throwGaiException</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"android_getaddrinfo"</span><span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Count results so we know how to size the output array.</span>
    <span class="token keyword">int</span> addressCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>addrinfo<span class="token operator">*</span> ai <span class="token operator">=</span> addressList<span class="token punctuation">;</span> ai <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> ai <span class="token operator">=</span> ai<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">==</span> AF_INET <span class="token operator">||</span> ai<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">==</span> AF_INET6<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">++</span>addressCount<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"android_getaddrinfo unexpected ai_family %i"</span><span class="token punctuation">,</span> ai<span class="token operator">-</span><span class="token operator">></span>ai_family<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>addressCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Prepare output array.</span>
    jobjectArray result <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewObjectArray</span><span class="token punctuation">(</span>addressCount<span class="token punctuation">,</span> JniConstants<span class="token operator">::</span>inetAddressClass<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Examine returned addresses one by one, save them in the output array.</span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>addrinfo<span class="token operator">*</span> ai <span class="token operator">=</span> addressList<span class="token punctuation">;</span> ai <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> ai <span class="token operator">=</span> ai<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">!=</span> AF_INET <span class="token operator">&amp;&amp;</span> ai<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">!=</span> AF_INET6<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Unknown address family. Skip this address.</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"android_getaddrinfo unexpected ai_family %i"</span><span class="token punctuation">,</span> ai<span class="token operator">-</span><span class="token operator">></span>ai_family<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Convert each IP address into a Java byte array.</span>
        sockaddr_storage<span class="token operator">&amp;</span> address <span class="token operator">=</span> <span class="token operator">*</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>sockaddr_storage<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ScopedLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">></span> <span class="token function">inetAddress</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token function">sockaddrToInetAddress</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> address<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inetAddress<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetObjectArrayElement</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> index<span class="token punctuation">,</span> inetAddress<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>index<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程实际上就是从<code>StructAddrinfo</code>中拿到<code>ai_flags</code>,<code>ai_family</code>,<code>ai_socktype</code>作为参数传递到<code>android_getaddrinfofornet</code>方法中。并把取到的数据保存到Java数组中并返回。</p>
<h5 id="android-getaddrinfofornet-从netd进程中查找dns"><a href="#android-getaddrinfofornet-从netd进程中查找dns" class="headerlink" title="android_getaddrinfofornet 从netd进程中查找dns"></a>android_getaddrinfofornet 从netd进程中查找dns</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">if</span> defined(__BIONIC__)</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">int</span> <span class="token function">android_getaddrinfofornet</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> addrinfo<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> addrinfo<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">android_getaddrinfofornet</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> hostname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> servname<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> addrinfo<span class="token operator">*</span> hints<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token comment" spellcheck="true">/*netid*/</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token comment" spellcheck="true">/*mark*/</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> addrinfo<span class="token operator">*</span><span class="token operator">*</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> servname<span class="token punctuation">,</span> hints<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意接下来分为2个分之，是调用libc中内置的<code>getaddrinfo</code>方法还是调用bionic的<code>android_getaddrinfofornet</code>.</p>
<p>一半的jdk都是使用libc内置的方法，而android中都是使用bionic库进行处理。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/" target="_blank" rel="noopener">bionic</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/" target="_blank" rel="noopener">libc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/" target="_blank" rel="noopener">dns</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/net/getaddrinfo.c" target="_blank" rel="noopener">getaddrinfo.c</a></p>
<pre class="line-numbers language-java"><code class="language-java">__BIONIC_WEAK_FOR_NATIVE_BRIDGE
<span class="token keyword">int</span>
<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>servname<span class="token punctuation">,</span>
    <span class="token keyword">const</span> struct addrinfo <span class="token operator">*</span>hints<span class="token punctuation">,</span> struct addrinfo <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">android_getaddrinfofornet</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> servname<span class="token punctuation">,</span> hints<span class="token punctuation">,</span> NETID_UNSET<span class="token punctuation">,</span> MARK_UNSET<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

__BIONIC_WEAK_FOR_NATIVE_BRIDGE
<span class="token keyword">int</span>
<span class="token function">android_getaddrinfofornet</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>servname<span class="token punctuation">,</span>
    <span class="token keyword">const</span> struct addrinfo <span class="token operator">*</span>hints<span class="token punctuation">,</span> unsigned netid<span class="token punctuation">,</span> unsigned mark<span class="token punctuation">,</span> struct addrinfo <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    struct android_net_context netcontext <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>app_netid <span class="token operator">=</span> netid<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>app_mark <span class="token operator">=</span> mark<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>dns_netid <span class="token operator">=</span> netid<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>dns_mark <span class="token operator">=</span> mark<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>uid <span class="token operator">=</span> NET_CONTEXT_INVALID_UID<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">android_getaddrinfofornetcontext</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> servname<span class="token punctuation">,</span> hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>netcontext<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>生成一个<code>android_net_context</code> 结构体后，调用 <code>android_getaddrinfofornetcontext</code>.</p>
<h5 id="android-getaddrinfofornetcontext"><a href="#android-getaddrinfofornetcontext" class="headerlink" title="android_getaddrinfofornetcontext"></a>android_getaddrinfofornetcontext</h5><pre class="line-numbers language-cpp"><code class="language-cpp">__BIONIC_WEAK_FOR_NATIVE_BRIDGE
<span class="token keyword">int</span>
<span class="token function">android_getaddrinfofornetcontext</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>servname<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>hints<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> android_net_context <span class="token operator">*</span>netcontext<span class="token punctuation">,</span>
    <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> addrinfo sentinel<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>cur<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> addrinfo ai<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> addrinfo ai0<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>pai<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> explore <span class="token operator">*</span>ex<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* hostname is allowed to be NULL */</span>
    <span class="token comment" spellcheck="true">/* servname is allowed to be NULL */</span>
    <span class="token comment" spellcheck="true">/* hints is allowed to be NULL */</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>res <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>netcontext <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sentinel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sentinel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cur <span class="token operator">=</span> <span class="token operator">&amp;</span>sentinel<span class="token punctuation">;</span>
    pai <span class="token operator">=</span> <span class="token operator">&amp;</span>ai<span class="token punctuation">;</span>
    pai<span class="token operator">-</span><span class="token operator">></span>ai_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    pai<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">=</span> PF_UNSPEC<span class="token punctuation">;</span>
    pai<span class="token operator">-</span><span class="token operator">></span>ai_socktype <span class="token operator">=</span> ANY<span class="token punctuation">;</span>
    pai<span class="token operator">-</span><span class="token operator">></span>ai_protocol <span class="token operator">=</span> ANY<span class="token punctuation">;</span>
    pai<span class="token operator">-</span><span class="token operator">></span>ai_addrlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    pai<span class="token operator">-</span><span class="token operator">></span>ai_canonname <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    pai<span class="token operator">-</span><span class="token operator">></span>ai_addr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    pai<span class="token operator">-</span><span class="token operator">></span>ai_next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* error check for hints */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hints<span class="token operator">-</span><span class="token operator">></span>ai_addrlen <span class="token operator">||</span> hints<span class="token operator">-</span><span class="token operator">></span>ai_canonname <span class="token operator">||</span>
            hints<span class="token operator">-</span><span class="token operator">></span>ai_addr <span class="token operator">||</span> hints<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">)</span>
            <span class="token function">ERR</span><span class="token punctuation">(</span>EAI_BADHINTS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* xxx */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hints<span class="token operator">-</span><span class="token operator">></span>ai_flags <span class="token operator">&amp;</span> <span class="token operator">~</span>AI_MASK<span class="token punctuation">)</span>
            <span class="token function">ERR</span><span class="token punctuation">(</span>EAI_BADFLAGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>hints<span class="token operator">-</span><span class="token operator">></span>ai_family<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> PF_UNSPEC<span class="token operator">:</span>
        <span class="token keyword">case</span> PF_INET<span class="token operator">:</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> INET6</span>
        <span class="token keyword">case</span> PF_INET6<span class="token operator">:</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">ERR</span><span class="token punctuation">(</span>EAI_FAMILY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>pai<span class="token punctuation">,</span> hints<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>pai<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * if both socktype/protocol are specified, check if they
         * are meaningful combination.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_socktype <span class="token operator">!=</span> ANY <span class="token operator">&amp;&amp;</span> pai<span class="token operator">-</span><span class="token operator">></span>ai_protocol <span class="token operator">!=</span> ANY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ex <span class="token operator">=</span> explore<span class="token punctuation">;</span> ex<span class="token operator">-</span><span class="token operator">></span>e_af <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> ex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">!=</span> ex<span class="token operator">-</span><span class="token operator">></span>e_af<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ex<span class="token operator">-</span><span class="token operator">></span>e_socktype <span class="token operator">==</span> ANY<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ex<span class="token operator">-</span><span class="token operator">></span>e_protocol <span class="token operator">==</span> ANY<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_socktype <span class="token operator">==</span> ex<span class="token operator">-</span><span class="token operator">></span>e_socktype
                 <span class="token operator">&amp;&amp;</span> pai<span class="token operator">-</span><span class="token operator">></span>ai_protocol <span class="token operator">!=</span> ex<span class="token operator">-</span><span class="token operator">></span>e_protocol<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">ERR</span><span class="token punctuation">(</span>EAI_BADHINTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/*
     * check for special cases.  (1) numeric servname is disallowed if
     * socktype/protocol are left unspecified. (2) servname is disallowed
     * for raw and other inet{,6} sockets.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">MATCH_FAMILY</span><span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_family<span class="token punctuation">,</span> PF_INET<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> PF_INET6</span>
     <span class="token operator">||</span> <span class="token function">MATCH_FAMILY</span><span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_family<span class="token punctuation">,</span> PF_INET6<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ai0 <span class="token operator">=</span> <span class="token operator">*</span>pai<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* backup *pai */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">==</span> PF_UNSPEC<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> PF_INET6</span>
            pai<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">=</span> PF_INET6<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
            pai<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">=</span> PF_INET<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token punctuation">}</span>
        error <span class="token operator">=</span> <span class="token function">get_portmatch</span><span class="token punctuation">(</span>pai<span class="token punctuation">,</span> servname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token function">ERR</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token operator">*</span>pai <span class="token operator">=</span> ai0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ai0 <span class="token operator">=</span> <span class="token operator">*</span>pai<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* NULL hostname, or numeric hostname */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined(__ANDROID__)</span>
    <span class="token keyword">int</span> gai_error <span class="token operator">=</span> <span class="token function">android_getaddrinfo_proxy</span><span class="token punctuation">(</span>
        hostname<span class="token punctuation">,</span> servname<span class="token punctuation">,</span> hints<span class="token punctuation">,</span> res<span class="token punctuation">,</span> netcontext<span class="token operator">-</span><span class="token operator">></span>app_netid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gai_error <span class="token operator">!=</span> EAI_SYSTEM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> gai_error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token comment" spellcheck="true">/*
     * hostname as alphabetical name.
     * we would like to prefer AF_INET6 than AF_INET, so we'll make a
     * outer loop by AFs.
     */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>ex <span class="token operator">=</span> explore<span class="token punctuation">;</span> ex<span class="token operator">-</span><span class="token operator">></span>e_af <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> ex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>pai <span class="token operator">=</span> ai0<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* require exact match for family field */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">!=</span> ex<span class="token operator">-</span><span class="token operator">></span>e_af<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">MATCH</span><span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_socktype<span class="token punctuation">,</span> ex<span class="token operator">-</span><span class="token operator">></span>e_socktype<span class="token punctuation">,</span>
                <span class="token function">WILD_SOCKTYPE</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">MATCH</span><span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_protocol<span class="token punctuation">,</span> ex<span class="token operator">-</span><span class="token operator">></span>e_protocol<span class="token punctuation">,</span>
                <span class="token function">WILD_PROTOCOL</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_socktype <span class="token operator">==</span> ANY <span class="token operator">&amp;&amp;</span> ex<span class="token operator">-</span><span class="token operator">></span>e_socktype <span class="token operator">!=</span> ANY<span class="token punctuation">)</span>
            pai<span class="token operator">-</span><span class="token operator">></span>ai_socktype <span class="token operator">=</span> ex<span class="token operator">-</span><span class="token operator">></span>e_socktype<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_protocol <span class="token operator">==</span> ANY <span class="token operator">&amp;&amp;</span> ex<span class="token operator">-</span><span class="token operator">></span>e_protocol <span class="token operator">!=</span> ANY<span class="token punctuation">)</span>
            pai<span class="token operator">-</span><span class="token operator">></span>ai_protocol <span class="token operator">=</span> ex<span class="token operator">-</span><span class="token operator">></span>e_protocol<span class="token punctuation">;</span>

        error <span class="token operator">=</span> <span class="token function">explore_fqdn</span><span class="token punctuation">(</span>
            pai<span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> servname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cur<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">,</span> netcontext<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>cur <span class="token operator">&amp;&amp;</span> cur<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">)</span>
            cur <span class="token operator">=</span> cur<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/* XXX */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sentinel<span class="token punctuation">.</span>ai_next<span class="token punctuation">)</span>
        error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> free<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sentinel<span class="token punctuation">.</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 good<span class="token operator">:</span>
            <span class="token operator">*</span>res <span class="token operator">=</span> sentinel<span class="token punctuation">.</span>ai_next<span class="token punctuation">;</span>
            <span class="token keyword">return</span> SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            error <span class="token operator">=</span> EAI_FAIL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 free<span class="token operator">:</span>
 bad<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sentinel<span class="token punctuation">.</span>ai_next<span class="token punctuation">)</span>
        <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>sentinel<span class="token punctuation">.</span>ai_next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>res <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.首先是把从Java对象传递进来的参数，组装到<code>addrinfo</code>结构体中</p>
</li>
<li><p>2.此时一半编译器的预定义宏一半来说就是<code>__ANDROID__</code>，对应Android系统。此时就会调用<code>android_getaddrinfo_proxy</code> 把查询动作交给代理进程<code>netd</code>。</p>
</li>
<li><p>3.<code>explore_fqdn</code> 方法将会真正进行查询和解析，从文件缓存以及互联网中查询结果，最后返回。</p>
</li>
</ul>
<h5 id="android-getaddrinfo-proxy"><a href="#android-getaddrinfo-proxy" class="headerlink" title="android_getaddrinfo_proxy"></a>android_getaddrinfo_proxy</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">android_getaddrinfo_proxy</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>servname<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>hints<span class="token punctuation">,</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> netid<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> success <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    FILE<span class="token operator">*</span> proxy <span class="token operator">=</span> <span class="token function">android_open_proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proxy <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> EAI_SYSTEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    netid <span class="token operator">=</span> __netdClientDispatch<span class="token punctuation">.</span><span class="token function">netIdForResolv</span><span class="token punctuation">(</span>netid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Send the request.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fprintf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">"getaddrinfo %s %s %d %d %d %d %u"</span><span class="token punctuation">,</span>
            hostname <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"^"</span> <span class="token operator">:</span> hostname<span class="token punctuation">,</span>
            servname <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"^"</span> <span class="token operator">:</span> servname<span class="token punctuation">,</span>
            hints <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> hints<span class="token operator">-</span><span class="token operator">></span>ai_flags<span class="token punctuation">,</span>
            hints <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> hints<span class="token operator">-</span><span class="token operator">></span>ai_family<span class="token punctuation">,</span>
            hints <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> hints<span class="token operator">-</span><span class="token operator">></span>ai_socktype<span class="token punctuation">,</span>
            hints <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> hints<span class="token operator">-</span><span class="token operator">></span>ai_protocol<span class="token punctuation">,</span>
            netid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// literal NULL byte at end, required by FrameworkListener</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fputc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span> <span class="token operator">||</span>
        <span class="token function">fflush</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// read result code for gethostbyaddr</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> result_code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strtol</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// verify the code itself</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result_code <span class="token operator">!=</span> DnsProxyQueryResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> addrinfo<span class="token operator">*</span> ai <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> addrinfo<span class="token operator">*</span><span class="token operator">*</span> nextres <span class="token operator">=</span> res<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        int32_t have_more<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">readBE32</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token operator">&amp;</span>have_more<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>have_more <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            success <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">struct</span> addrinfo<span class="token operator">*</span> ai <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> addrinfo<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr_storage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ai <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ai<span class="token operator">-</span><span class="token operator">></span>ai_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ai <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// struct addrinfo {</span>
        <span class="token comment" spellcheck="true">//    int    ai_flags;    </span><span class="token comment" spellcheck="true">/* AI_PASSIVE, AI_CANONNAME, AI_NUMERICHOST */</span>
        <span class="token comment" spellcheck="true">//    int    ai_family;    </span><span class="token comment" spellcheck="true">/* PF_xxx */</span>
        <span class="token comment" spellcheck="true">//    int    ai_socktype;    </span><span class="token comment" spellcheck="true">/* SOCK_xxx */</span>
        <span class="token comment" spellcheck="true">//    int    ai_protocol;    </span><span class="token comment" spellcheck="true">/* 0 or IPPROTO_xxx for IPv4 and IPv6 */</span>
        <span class="token comment" spellcheck="true">//    socklen_t ai_addrlen;    </span><span class="token comment" spellcheck="true">/* length of ai_addr */</span>
        <span class="token comment" spellcheck="true">//    char    *ai_canonname;    </span><span class="token comment" spellcheck="true">/* canonical name for hostname */</span>
        <span class="token comment" spellcheck="true">//    struct    sockaddr *ai_addr;    </span><span class="token comment" spellcheck="true">/* binary address */</span>
        <span class="token comment" spellcheck="true">//    struct    addrinfo *ai_next;    </span><span class="token comment" spellcheck="true">/* next structure in linked list */</span>
        <span class="token comment" spellcheck="true">// };</span>

        <span class="token comment" spellcheck="true">// Read the struct piece by piece because we might be a 32-bit process</span>
        <span class="token comment" spellcheck="true">// talking to a 64-bit netd.</span>
        int32_t addr_len<span class="token punctuation">;</span>
        <span class="token keyword">bool</span> success <span class="token operator">=</span>
                <span class="token function">readBE32</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_flags<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">readBE32</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_family<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">readBE32</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_socktype<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">readBE32</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_protocol<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">readBE32</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Set ai_addrlen and read the ai_addr data.</span>
        ai<span class="token operator">-</span><span class="token operator">></span>ai_addrlen <span class="token operator">=</span> addr_len<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>addr_len <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> addr_len <span class="token operator">></span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr_storage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Bogus; too big.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fread</span><span class="token punctuation">(</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_addr<span class="token punctuation">,</span> addr_len<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// The string for ai_cannonname.</span>
        int32_t name_len<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">readBE32</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token operator">&amp;</span>name_len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name_len <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ai<span class="token operator">-</span><span class="token operator">></span>ai_canonname <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span>name_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fread</span><span class="token punctuation">(</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_canonname<span class="token punctuation">,</span> name_len<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_canonname<span class="token punctuation">[</span>name_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// The proxy should be returning this</span>
                <span class="token comment" spellcheck="true">// NULL-terminated.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token operator">*</span>nextres <span class="token operator">=</span> ai<span class="token punctuation">;</span>
        nextres <span class="token operator">=</span> <span class="token operator">&amp;</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">;</span>
        ai <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ai <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Clean up partially-built addrinfo that we never ended up</span>
        <span class="token comment" spellcheck="true">// attaching to the response.</span>
        <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>ai<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
exit<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proxy <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Proxy failed;</span>
    <span class="token comment" spellcheck="true">// clean up memory we might've allocated.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>res <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> EAI_NODATA<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.<code>android_open_proxy</code> 校验当前的环境变量是<code>ANDROID_DNS_MODE</code>是否是<code>local</code>还记得这个环境变量只有在<code>netd</code>设置了，而App进程并没有设置。 </li>
</ul>
<p>此时App进程<code>ANDROID_DNS_MODE</code>不是<code>local</code>模式那么说明需要走代理，就会联通<code>netd</code>进程的<code>/dev/socket/dnsproxyd</code> 的socket接口，并返回。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">
__LIBC_HIDDEN__ FILE<span class="token operator">*</span> <span class="token function">android_open_proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> cache_mode <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"ANDROID_DNS_MODE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> use_proxy <span class="token operator">=</span> <span class="token punctuation">(</span>cache_mode <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>cache_mode<span class="token punctuation">,</span> <span class="token string">"local"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>use_proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_STREAM <span class="token operator">|</span> SOCK_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> sockaddr_un proxy_addr<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proxy_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>proxy_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxy_addr<span class="token punctuation">.</span>sun_family <span class="token operator">=</span> AF_UNIX<span class="token punctuation">;</span>
    <span class="token function">strlcpy</span><span class="token punctuation">(</span>proxy_addr<span class="token punctuation">.</span>sun_path<span class="token punctuation">,</span> <span class="token string">"/dev/socket/dnsproxyd"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>proxy_addr<span class="token punctuation">.</span>sun_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>proxy_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>proxy_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">fdopen</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"r+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>2.拿到socket的文件描述符后，往<code>dnsproxyd</code>写入<code>"getaddrinfo %s %s %d %d %d %d %u"</code>命令。</li>
<li>3.进入一个循环知道有消息传入，从<code>dnsproxyd</code>返回的查询结果数据必定是 <code>addrinfo</code>结构体的数据结构返回，解析后直接返回。</li>
</ul>
<h3 id="netd进程接受getaddrinfo命令"><a href="#netd进程接受getaddrinfo命令" class="headerlink" title="netd进程接受getaddrinfo命令"></a>netd进程接受<code>getaddrinfo</code>命令</h3><p>前面聊到了DnsProxyListener在内部中生成了<code>dnsproxyd</code>的socket。在DnsProxyListener构造函数中，就调用了<code>registerCmd</code>方法注册了不同命令的监听.</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libsysutils/" target="_blank" rel="noopener">libsysutils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libsysutils/src/" target="_blank" rel="noopener">src</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libsysutils/src/FrameworkListener.cpp" target="_blank" rel="noopener">FrameworkListener.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> FrameworkListener<span class="token operator">::</span><span class="token function">registerCmd</span><span class="token punctuation">(</span>FrameworkCommand <span class="token operator">*</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mCommands<span class="token operator">-</span><span class="token operator">></span><span class="token function">push_back</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>把FrameworkCommand添加到mCommands集合中。</p>
<p>FrameworkListener的父类就是SocketListener，而SocketListener在调用startListener方法后，就会启动一个线程执行<code>threadStart</code>方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token operator">*</span>SocketListener<span class="token operator">::</span><span class="token function">threadStart</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SocketListener <span class="token operator">*</span>me <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>SocketListener <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    me<span class="token operator">-</span><span class="token operator">></span><span class="token function">runListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> SocketListener<span class="token operator">::</span><span class="token function">runListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    SocketClientCollection pendingList<span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SocketClientCollection<span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
        fd_set read_fds<span class="token punctuation">;</span>
        <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mListen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            max <span class="token operator">=</span> mSock<span class="token punctuation">;</span>
            <span class="token function">FD_SET</span><span class="token punctuation">(</span>mSock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">FD_SET</span><span class="token punctuation">(</span>mCtrlPipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCtrlPipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> max<span class="token punctuation">)</span>
            max <span class="token operator">=</span> mCtrlPipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>it <span class="token operator">=</span> mClients<span class="token operator">-</span><span class="token operator">></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> mClients<span class="token operator">-</span><span class="token operator">></span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// NB: calling out to an other object with mClientsLock held (safe)</span>
            <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">FD_SET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">></span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                max <span class="token operator">=</span> fd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>max <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rc<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mListen <span class="token operator">&amp;&amp;</span> <span class="token function">FD_ISSET</span><span class="token punctuation">(</span>mSock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">accept4</span><span class="token punctuation">(</span>mSock<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> SOCK_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mClients<span class="token operator">-</span><span class="token operator">></span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">SocketClient</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> mUseCmdNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/* Add all active clients to the pending list first */</span>
        pendingList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>it <span class="token operator">=</span> mClients<span class="token operator">-</span><span class="token operator">></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> mClients<span class="token operator">-</span><span class="token operator">></span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SocketClient<span class="token operator">*</span> c <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// NB: calling out to an other object with mClientsLock held (safe)</span>
            <span class="token keyword">int</span> fd <span class="token operator">=</span> c<span class="token operator">-</span><span class="token operator">></span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pendingList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token operator">-</span><span class="token operator">></span><span class="token function">incRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* Process the pending list, since it is owned by the thread,
         * there is no need to lock it */</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>pendingList<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/* Pop the first item from the list */</span>
            it <span class="token operator">=</span> pendingList<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            SocketClient<span class="token operator">*</span> c <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
            pendingList<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/* Process it, if false is returned, remove from list */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">onDataAvailable</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">release</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            c<span class="token operator">-</span><span class="token operator">></span><span class="token function">decRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.把pipeline对应的文件描述符以及<code>fd_set</code>(内含有外部设置进来的socket文件描述符)中，也就是系统帮你实现的一个fd缓存集合。在这里，我们设置了一个<code>/dev/socket/dnsproxyd</code>的socket文件描述符缓存到<code>SocketClient</code>.</li>
</ul>
<ul>
<li>2.通过select方法把监听<code>fd_set</code>中所有socket的数据到来的操作交给select系统调用。在这里实际上就是监听了<code>/dev/socket/dnsproxyd</code>.</li>
</ul>
<ul>
<li>3.注意在startListener方法中已经对改socket进行了listen监听操作，接下来在这个循环中就会调用<code>accept4</code> 接受网络数据。一旦有数据到来，把数据包装成一个个<code>SocketClient</code>保存<code>pendingList</code>集合中，调用<code>onDataAvailable</code>方法。</li>
</ul>
<p>onDataAvailable 这个方法在FrameworkListener有实现。</p>
<h4 id="FrameworkListener-onDataAvailable"><a href="#FrameworkListener-onDataAvailable" class="headerlink" title="FrameworkListener onDataAvailable"></a>FrameworkListener onDataAvailable</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libsysutils/" target="_blank" rel="noopener">libsysutils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libsysutils/src/" target="_blank" rel="noopener">src</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libsysutils/src/FrameworkListener.cpp" target="_blank" rel="noopener">FrameworkListener.cpp</a></p>
<pre class="line-numbers language-java"><code class="language-java">bool FrameworkListener<span class="token operator">:</span><span class="token operator">:</span><span class="token function">onDataAvailable</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>CMD_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>

    len <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>c<span class="token operator">-</span><span class="token operator">></span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/* IMPORTANT: dispatchCommand() expects a zero-terminated string */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSkipToNextNullByte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSkipToNextNullByte <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">dispatchCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> buffer <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            offset <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    mSkipToNextNullByte <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在onDataAvailable 中，调用了<code>read</code>方法读socket传送来的数据，并调用<code>dispatchCommand</code>把保存在<code>pendingList</code>的数据分发出去。</p>
<h3 id="FrameworkListener-dispatchCommand"><a href="#FrameworkListener-dispatchCommand" class="headerlink" title="FrameworkListener dispatchCommand"></a>FrameworkListener dispatchCommand</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> FrameworkListener<span class="token operator">::</span><span class="token function">dispatchCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>cli<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FrameworkCommandCollection<span class="token operator">::</span>iterator i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> argc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span>FrameworkListener<span class="token operator">::</span>CMD_ARGS_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> tmp<span class="token punctuation">[</span>CMD_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>q <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>qlimit <span class="token operator">=</span> tmp <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> esc <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> quote <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> haveCmdNum <span class="token operator">=</span> <span class="token operator">!</span>mWithSeq<span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> mCommands<span class="token operator">-</span><span class="token operator">></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> mCommands<span class="token operator">-</span><span class="token operator">></span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        FrameworkCommand <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token operator">*</span>i<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token operator">-</span><span class="token operator">></span><span class="token function">getCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-</span><span class="token operator">></span><span class="token function">runCommand</span><span class="token punctuation">(</span>cli<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">SLOGW</span><span class="token punctuation">(</span><span class="token string">"Handler '%s' error (%s)"</span><span class="token punctuation">,</span> c<span class="token operator">-</span><span class="token operator">></span><span class="token function">getCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    cli<span class="token operator">-</span><span class="token operator">></span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"Command not recognized"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
out<span class="token operator">:</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">free</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

overflow<span class="token operator">:</span>
    cli<span class="token operator">-</span><span class="token operator">></span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"Command too long"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还记得<code>FrameworkListener</code>中的<code>mCommands</code>集合实际上是通过上面registerCmd设置进来的。</p>
<p>在这个过程中，会遍历所有设置进来的命令对象。校验每一个<code>FrameworkCommand</code>设置好的字符串，当命令第一个字符串和<code>FrameworkCommand</code>匹配上了才会执行对应<code>FrameworkCommand</code>的<code>runCommand</code></p>
<h4 id="netd进程监听到App进程发送的DNS查询命令"><a href="#netd进程监听到App进程发送的DNS查询命令" class="headerlink" title="netd进程监听到App进程发送的DNS查询命令"></a>netd进程监听到App进程发送的DNS查询命令</h4><p>注意，此时App进程调用了如下命令：</p>
<pre><code>getaddrinfo %s %s %d %d %d %d %u</code></pre><p>换句话说，此时<code>netd</code>进程需要匹配<code>getaddrinfo</code>命令</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">DnsProxyListener<span class="token operator">::</span>GetAddrInfoCmd<span class="token operator">::</span><span class="token function">GetAddrInfoCmd</span><span class="token punctuation">(</span>DnsProxyListener<span class="token operator">*</span> dnsProxyListener<span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">NetdCommand</span><span class="token punctuation">(</span><span class="token string">"getaddrinfo"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mDnsProxyListener</span><span class="token punctuation">(</span>dnsProxyListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时会匹配上<code>GetAddrInfoCmd</code>中的<code>getaddrinfo</code>的字符串。此时就会调用<code>GetAddrInfoCmd</code>的<code>runCommand</code>.</p>
<h5 id="GetAddrInfoCmd-runCommand"><a href="#GetAddrInfoCmd-runCommand" class="headerlink" title="GetAddrInfoCmd runCommand"></a>GetAddrInfoCmd runCommand</h5><pre class="line-numbers language-cpp"><code class="language-cpp">
<span class="token comment" spellcheck="true">// Limits the number of outstanding DNS queries by client UID.</span>
<span class="token keyword">constexpr</span> <span class="token keyword">int</span> MAX_QUERIES_PER_UID <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
android<span class="token operator">::</span>netdutils<span class="token operator">::</span>OperationLimiter<span class="token operator">&lt;</span>uid_t<span class="token operator">></span> <span class="token function">queryLimiter</span><span class="token punctuation">(</span>MAX_QUERIES_PER_UID<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">int</span> DnsProxyListener<span class="token operator">::</span>GetAddrInfoCmd<span class="token operator">::</span><span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>cli<span class="token punctuation">,</span>
                                            <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">char</span><span class="token operator">*</span> service <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">struct</span> addrinfo<span class="token operator">*</span> hints <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ai_flags <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ai_family <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ai_socktype <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ai_protocol <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> netId <span class="token operator">=</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> useLocalNameservers <span class="token operator">=</span> <span class="token function">checkAndClearUseLocalNameserversFlag</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> uid_t uid <span class="token operator">=</span> cli<span class="token operator">-</span><span class="token operator">></span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    android_net_context netcontext<span class="token punctuation">;</span>
    mDnsProxyListener<span class="token operator">-</span><span class="token operator">></span>mNetCtrl<span class="token operator">-</span><span class="token operator">></span><span class="token function">getNetworkContext</span><span class="token punctuation">(</span>netId<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>netcontext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>useLocalNameservers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        netcontext<span class="token punctuation">.</span>flags <span class="token operator">|</span><span class="token operator">=</span> NET_CONTEXT_FLAG_USE_LOCAL_NAMESERVERS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ai_flags <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> ai_family <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span>
        ai_socktype <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> ai_protocol <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hints <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> addrinfo<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> addrinfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hints<span class="token operator">-</span><span class="token operator">></span>ai_flags <span class="token operator">=</span> ai_flags<span class="token punctuation">;</span>
        hints<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">=</span> ai_family<span class="token punctuation">;</span>
        hints<span class="token operator">-</span><span class="token operator">></span>ai_socktype <span class="token operator">=</span> ai_socktype<span class="token punctuation">;</span>
        hints<span class="token operator">-</span><span class="token operator">></span>ai_protocol <span class="token operator">=</span> ai_protocol<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">const</span> <span class="token keyword">int</span> metricsLevel <span class="token operator">=</span> mDnsProxyListener<span class="token operator">-</span><span class="token operator">></span>mEventReporter<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMetricsReportingLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    DnsProxyListener<span class="token operator">::</span>GetAddrInfoHandler<span class="token operator">*</span> handler <span class="token operator">=</span>
            <span class="token keyword">new</span> DnsProxyListener<span class="token operator">::</span><span class="token function">GetAddrInfoHandler</span><span class="token punctuation">(</span>cli<span class="token punctuation">,</span> name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> hints<span class="token punctuation">,</span> netcontext<span class="token punctuation">,</span>
                    metricsLevel<span class="token punctuation">,</span> mDnsProxyListener<span class="token operator">-</span><span class="token operator">></span>mEventReporter<span class="token operator">-</span><span class="token operator">></span><span class="token function">getNetdEventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tryThreadOrError</span><span class="token punctuation">(</span>cli<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.从传递过来的字符串中读取了传递过来的<code>ai_flags</code>,<code>ai_family</code>,<code>ai_socktype</code>,<code>ai_protocol</code>几个数据，并在netd进程同样构造了<code>addrinfo</code>结构体传入<code>GetAddrInfoHandler</code>中，并调用<code>tryThreadOrError</code>启动<code>GetAddrInfoHandler</code>处理。</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">void</span> <span class="token function">tryThreadOrError</span><span class="token punctuation">(</span>SocketClient<span class="token operator">*</span> cli<span class="token punctuation">,</span> T<span class="token operator">*</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cli<span class="token operator">-</span><span class="token operator">></span><span class="token function">incRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> rval <span class="token operator">=</span> <span class="token function">threadLaunch</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// SocketClient decRef() happens in the handler's run() method.</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意<code>threadLaunch</code>这个方式实际上就是创建了一个线程，并执行了<code>handler</code>的run方法。</p>
<h5 id="GetAddrInfoHandler-run"><a href="#GetAddrInfoHandler-run" class="headerlink" title="GetAddrInfoHandler run"></a>GetAddrInfoHandler run</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> DnsProxyListener<span class="token operator">::</span>GetAddrInfoHandler<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">struct</span> addrinfo<span class="token operator">*</span> result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    Stopwatch s<span class="token punctuation">;</span>
    <span class="token function">maybeFixupNetContext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mNetContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> uid_t uid <span class="token operator">=</span> mClient<span class="token operator">-</span><span class="token operator">></span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint32_t rv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queryLimiter<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rv <span class="token operator">=</span> <span class="token function">android_getaddrinfofornetcontext</span><span class="token punctuation">(</span>mHost<span class="token punctuation">,</span> mService<span class="token punctuation">,</span> mHints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mNetContext<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryLimiter<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> latencyMs <span class="token operator">=</span> <span class="token function">lround</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">timeTaken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// getaddrinfo failed</span>
        mClient<span class="token operator">-</span><span class="token operator">></span><span class="token function">sendBinaryMsg</span><span class="token punctuation">(</span>ResponseCode<span class="token operator">::</span>DnsProxyOperationFailed<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">bool</span> success <span class="token operator">=</span> <span class="token operator">!</span>mClient<span class="token operator">-</span><span class="token operator">></span><span class="token function">sendCode</span><span class="token punctuation">(</span>ResponseCode<span class="token operator">::</span>DnsProxyQueryResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> addrinfo<span class="token operator">*</span> ai <span class="token operator">=</span> result<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ai <span class="token operator">&amp;&amp;</span> success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            success <span class="token operator">=</span> <span class="token function">sendBE32</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sendaddrinfo</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> ai<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ai <span class="token operator">=</span> ai<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        success <span class="token operator">=</span> success <span class="token operator">&amp;&amp;</span> <span class="token function">sendBE32</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>String16<span class="token operator">></span> ip_addrs<span class="token punctuation">;</span>
    <span class="token keyword">int</span> total_ip_addr_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mClient<span class="token operator">-</span><span class="token operator">></span><span class="token function">decRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.调用<code>android_getaddrinfofornetcontext</code>方法进行进行联网和文件缓存查询DNS</p>
</li>
<li><p>2.如果失败则返回<code>ResponseCode::DnsProxyOperationFailed</code></p>
</li>
<li><p>3.如果成功，则发送<code>addrinfo</code>指针数组，不断的通过<code>sendBE32</code>发送到App进程。</p>
</li>
</ul>
<p>到这里又返回了android_getaddrinfofornetcontext。</p>
<h4 id="explore-fqdn-查询DNS服务"><a href="#explore-fqdn-查询DNS服务" class="headerlink" title="explore_fqdn 查询DNS服务"></a>explore_fqdn 查询DNS服务</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/" target="_blank" rel="noopener">bionic</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/" target="_blank" rel="noopener">libc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/" target="_blank" rel="noopener">dns</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/net/getaddrinfo.c" target="_blank" rel="noopener">getaddrinfo.c</a></p>
<p>值得注意的是，这里又调用了之前App进程调用的<code>bionic</code>库中的<code>android_getaddrinfofornetcontext</code>方法。由于<code>netd</code>进程在初始化时候设置了<code>ANDROID_DNS_MODE</code> 为<code>local</code>,此时就不会再一次走到<code>android_getaddrinfo_proxy</code>中，而是直接走到下半部分的 <code>explore_fqdn</code>方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/*
 * FQDN hostname, DNS lookup
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">explore_fqdn</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>pai<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>servname<span class="token punctuation">,</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> android_net_context <span class="token operator">*</span>netcontext<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>result<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>cur<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> ns_dtab dtab<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function">NS_FILES_CB</span><span class="token punctuation">(</span>_files_getaddrinfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span> NSSRC_DNS<span class="token punctuation">,</span> _dns_getaddrinfo<span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* force -DHESIOD */</span>
        <span class="token function">NS_NIS_CB</span><span class="token punctuation">(</span>_yp_getaddrinfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">assert</span><span class="token punctuation">(</span>pai <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* hostname may be NULL */</span>
    <span class="token comment" spellcheck="true">/* servname may be NULL */</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>res <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
     * if the servname does not match socktype/protocol, ignore it.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_portmatch</span><span class="token punctuation">(</span>pai<span class="token punctuation">,</span> servname<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">nsdispatch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">,</span> dtab<span class="token punctuation">,</span> NSDB_HOSTS<span class="token punctuation">,</span> <span class="token string">"getaddrinfo"</span><span class="token punctuation">,</span>
            default_dns_files<span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> pai<span class="token punctuation">,</span> netcontext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> NS_TRYAGAIN<span class="token operator">:</span>
        error <span class="token operator">=</span> EAI_AGAIN<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> free<span class="token punctuation">;</span>
    <span class="token keyword">case</span> NS_UNAVAIL<span class="token operator">:</span>
        error <span class="token operator">=</span> EAI_FAIL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> free<span class="token punctuation">;</span>
    <span class="token keyword">case</span> NS_NOTFOUND<span class="token operator">:</span>
        error <span class="token operator">=</span> EAI_NODATA<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> free<span class="token punctuation">;</span>
    <span class="token keyword">case</span> NS_SUCCESS<span class="token operator">:</span>
        error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>cur <span class="token operator">=</span> result<span class="token punctuation">;</span> cur<span class="token punctuation">;</span> cur <span class="token operator">=</span> cur<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">GET_PORT</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> servname<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/* canonname should be filled already */</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>res <span class="token operator">=</span> result<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

free<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>构建一个ns_dtab 数组，内含有三个结构体，这三个结构体实际上会被<code>nsdispatch</code>接受。这个过程会以传递到<code>nsdispatch</code>中最后三个为参数，并循环调用<code>_files_getaddrinfo</code>，<code>_dns_getaddrinfo</code>,<code>_yp_getaddrinfo</code>方法,直到找到该域名对应的ip地址。</p>
<p>我们分别来考量一下这三个方法都做了什么？</p>
<h5 id="files-getaddrinfo-从文件缓存中查询ip地址"><a href="#files-getaddrinfo-从文件缓存中查询ip地址" class="headerlink" title="_files_getaddrinfo  从文件缓存中查询ip地址"></a>_files_getaddrinfo  从文件缓存中查询ip地址</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">_files_getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>rv<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>cb_data<span class="token punctuation">,</span> va_list ap<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>pai<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> addrinfo sentinel<span class="token punctuation">,</span> <span class="token operator">*</span>cur<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>p<span class="token punctuation">;</span>
    FILE <span class="token operator">*</span>hostf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    name <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pai <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//    fprintf(stderr, "_files_getaddrinfo() name = '%s'\n", name);</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sentinel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sentinel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cur <span class="token operator">=</span> <span class="token operator">&amp;</span>sentinel<span class="token punctuation">;</span>

    <span class="token function">_sethtent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hostf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token function">_gethtent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hostf<span class="token punctuation">,</span> name<span class="token punctuation">,</span> pai<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cur<span class="token operator">-</span><span class="token operator">></span>ai_next <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>cur <span class="token operator">&amp;&amp;</span> cur<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">)</span>
            cur <span class="token operator">=</span> cur<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">_endhtent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hostf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> addrinfo <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>rv<span class="token punctuation">)</span> <span class="token operator">=</span> sentinel<span class="token punctuation">.</span>ai_next<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sentinel<span class="token punctuation">.</span>ai_next <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> NS_NOTFOUND<span class="token punctuation">;</span>
    <span class="token keyword">return</span> NS_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">_sethtent</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token operator">*</span>hostf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span>hostf<span class="token punctuation">)</span>
        <span class="token operator">*</span>hostf <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>_PATH_HOSTS<span class="token punctuation">,</span> <span class="token string">"re"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token operator">*</span>hostf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意<code>_PATH_HOSTS</code>是指：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span>    _PATH_HOSTS    "/system/etc/hosts"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个过程实际上就是打开<code>/system/etc/hosts</code> 系统环境文件，然后读取去该文件中的内容，转化<code>addrinfo</code>结构体。并和当前的域名进行匹配。</p>
<p>如果熟悉Linux的读者肯定知道<code>/system/etc/hosts</code>这个文件实际上就是缓存了每一次从网络中通过DNS服务器查询到的结果。</p>
<h5 id="dns-getaddrinfo"><a href="#dns-getaddrinfo" class="headerlink" title="_dns_getaddrinfo"></a>_dns_getaddrinfo</h5><p>如果缓存查不到，那么调用 <code>_dns_getaddrinfo</code>查询DNS服务器，看看域名对应的ip地址是什么？</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">_dns_getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>rv<span class="token punctuation">,</span> <span class="token keyword">void</span>    <span class="token operator">*</span>cb_data<span class="token punctuation">,</span> va_list ap<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>ai<span class="token punctuation">;</span>
    querybuf <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token operator">*</span>buf2<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>pai<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> addrinfo sentinel<span class="token punctuation">,</span> <span class="token operator">*</span>cur<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> res_target q<span class="token punctuation">,</span> q2<span class="token punctuation">;</span>
    res_state res<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> android_net_context <span class="token operator">*</span>netcontext<span class="token punctuation">;</span>

    name <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pai <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    netcontext <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> android_net_context <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//fprintf(stderr, "_dns_getaddrinfo() name = '%s'\n", name);</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>q<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>q2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>q2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sentinel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sentinel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cur <span class="token operator">=</span> <span class="token operator">&amp;</span>sentinel<span class="token punctuation">;</span>

    buf <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buf <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        h_errno <span class="token operator">=</span> NETDB_INTERNAL<span class="token punctuation">;</span>
        <span class="token keyword">return</span> NS_NOTFOUND<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    buf2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>buf2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buf2 <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">free</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        h_errno <span class="token operator">=</span> NETDB_INTERNAL<span class="token punctuation">;</span>
        <span class="token keyword">return</span> NS_NOTFOUND<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_family<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> AF_UNSPEC<span class="token operator">:</span>
        <span class="token comment" spellcheck="true">/* prefer IPv6 */</span>
        q<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        q<span class="token punctuation">.</span>qclass <span class="token operator">=</span> C_IN<span class="token punctuation">;</span>
        q<span class="token punctuation">.</span>answer <span class="token operator">=</span> buf<span class="token operator">-</span><span class="token operator">></span>buf<span class="token punctuation">;</span>
        q<span class="token punctuation">.</span>anslen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token operator">-</span><span class="token operator">></span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> query_ipv6 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> query_ipv4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pai<span class="token operator">-</span><span class="token operator">></span>ai_flags <span class="token operator">&amp;</span> AI_ADDRCONFIG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            query_ipv6 <span class="token operator">=</span> <span class="token function">_have_ipv6</span><span class="token punctuation">(</span>netcontext<span class="token operator">-</span><span class="token operator">></span>app_mark<span class="token punctuation">,</span> netcontext<span class="token operator">-</span><span class="token operator">></span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            query_ipv4 <span class="token operator">=</span> <span class="token function">_have_ipv4</span><span class="token punctuation">(</span>netcontext<span class="token operator">-</span><span class="token operator">></span>app_mark<span class="token punctuation">,</span> netcontext<span class="token operator">-</span><span class="token operator">></span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>query_ipv6<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">.</span>qtype <span class="token operator">=</span> T_AAAA<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>query_ipv4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                q<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token operator">&amp;</span>q2<span class="token punctuation">;</span>
                q2<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
                q2<span class="token punctuation">.</span>qclass <span class="token operator">=</span> C_IN<span class="token punctuation">;</span>
                q2<span class="token punctuation">.</span>qtype <span class="token operator">=</span> T_A<span class="token punctuation">;</span>
                q2<span class="token punctuation">.</span>answer <span class="token operator">=</span> buf2<span class="token operator">-</span><span class="token operator">></span>buf<span class="token punctuation">;</span>
                q2<span class="token punctuation">.</span>anslen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf2<span class="token operator">-</span><span class="token operator">></span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>query_ipv4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">.</span>qtype <span class="token operator">=</span> T_A<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">free</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> NS_NOTFOUND<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> AF_INET<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> AF_INET6<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">free</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> NS_UNAVAIL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    res <span class="token operator">=</span> <span class="token function">__res_get_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">free</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> NS_NOTFOUND<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token function">res_setnetcontext</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> netcontext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">res_searchN</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>q<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">__res_put_state</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> NS_NOTFOUND<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ai <span class="token operator">=</span> <span class="token function">getanswer</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> q<span class="token punctuation">.</span>n<span class="token punctuation">,</span> q<span class="token punctuation">.</span>name<span class="token punctuation">,</span> q<span class="token punctuation">.</span>qtype<span class="token punctuation">,</span> pai<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cur<span class="token operator">-</span><span class="token operator">></span>ai_next <span class="token operator">=</span> ai<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>cur <span class="token operator">&amp;&amp;</span> cur<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">)</span>
            cur <span class="token operator">=</span> cur<span class="token operator">-</span><span class="token operator">></span>ai_next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ai <span class="token operator">=</span> <span class="token function">getanswer</span><span class="token punctuation">(</span>buf2<span class="token punctuation">,</span> q2<span class="token punctuation">.</span>n<span class="token punctuation">,</span> q2<span class="token punctuation">.</span>name<span class="token punctuation">,</span> q2<span class="token punctuation">.</span>qtype<span class="token punctuation">,</span> pai<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token punctuation">)</span>
            cur<span class="token operator">-</span><span class="token operator">></span>ai_next <span class="token operator">=</span> ai<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sentinel<span class="token punctuation">.</span>ai_next <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">__res_put_state</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>h_errno<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> HOST_NOT_FOUND<span class="token operator">:</span>
            <span class="token keyword">return</span> NS_NOTFOUND<span class="token punctuation">;</span>
        <span class="token keyword">case</span> TRY_AGAIN<span class="token operator">:</span>
            <span class="token keyword">return</span> NS_TRYAGAIN<span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> NS_UNAVAIL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">_rfc6724_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sentinel<span class="token punctuation">,</span> netcontext<span class="token operator">-</span><span class="token operator">></span>app_mark<span class="token punctuation">,</span> netcontext<span class="token operator">-</span><span class="token operator">></span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">__res_put_state</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> addrinfo <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>rv<span class="token punctuation">)</span> <span class="token operator">=</span> sentinel<span class="token punctuation">.</span>ai_next<span class="token punctuation">;</span>
    <span class="token keyword">return</span> NS_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意在Java层的StructInfo的<code>ai_family</code>中设置了<code>AF_UNSPEC</code>标志位，<code>ai_flags</code> 为<code>AI_ADDRCONFIG</code></p>
<p>那么就会从<code>_have_ipv6</code>以及<code>_have_ipv4</code>查询。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">_have_ipv6</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> mark<span class="token punctuation">,</span> uid_t uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr_in6 sin6_test <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>sin6_family <span class="token operator">=</span> AF_INET6<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>sin6_addr<span class="token punctuation">.</span>s6_addr <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 2000::</span>
            <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    sockaddr_union addr <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>in6 <span class="token operator">=</span> sin6_test <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">_find_src_addr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">.</span>generic<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> mark<span class="token punctuation">,</span> uid<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">_have_ipv4</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> mark<span class="token punctuation">,</span> uid_t uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr_in sin_test <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">__constant_htonl</span><span class="token punctuation">(</span><span class="token number">0x08080808L</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 8.8.8.8</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    sockaddr_union addr <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>in <span class="token operator">=</span> sin_test <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">_find_src_addr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">.</span>generic<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> mark<span class="token punctuation">,</span> uid<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这两个参数主要是用来确定是ipv6还是ipv4的。<code>AI_ADDRCONFIG</code>标志位不是用来检测链接是否可用，而是应该检测在本地中是否进行了配置。然而bionic不支持<code>getifaddrs</code>.因此需要先链接一下网络，确定DNS服务器是否正常。</p>
<p><code>8.8.8.8</code>是google面向全球的查询的DNS服务器，<code>2000::</code>是ipv6全球单播地址。</p>
<ul>
<li><ol start="2">
<li><code>__res_get_state</code>获取系统设置好的默认DNS配置，以及承载结构体<code>res_target</code>，并调用<code>res_searchN</code>开始查询。查询到的结果通过<code>getanswer</code>解析，并设置到到第一个参数中返回。</li>
</ol>
</li>
</ul>
<p>核心来看看<code>res_searchN</code>都做了什么？</p>
<h5 id="res-searchN"><a href="#res-searchN" class="headerlink" title="res_searchN"></a>res_searchN</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">res_searchN</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">struct</span> res_target <span class="token operator">*</span>target<span class="token punctuation">,</span> res_state res<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span>domain<span class="token punctuation">;</span>
    HEADER <span class="token operator">*</span>hp<span class="token punctuation">;</span>
    u_int dots<span class="token punctuation">;</span>
    <span class="token keyword">int</span> trailing_dot<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> saved_herrno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> got_nodata <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> got_servfail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> tried_as_is <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>


    hp <span class="token operator">=</span> <span class="token punctuation">(</span>HEADER <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>target<span class="token operator">-</span><span class="token operator">></span>answer<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*XXX*/</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>cp <span class="token operator">=</span> name<span class="token punctuation">;</span> <span class="token operator">*</span>cp<span class="token punctuation">;</span> cp<span class="token operator">++</span><span class="token punctuation">)</span>
        dots <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    trailing_dot <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cp <span class="token operator">></span> name <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token operator">--</span>cp <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span>
        trailing_dot<span class="token operator">++</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


    saved_herrno <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dots <span class="token operator">>=</span> res<span class="token operator">-</span><span class="token operator">></span>ndots<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">res_querydomainN</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        saved_herrno <span class="token operator">=</span> h_errno<span class="token punctuation">;</span>
        tried_as_is<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>dots <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>res<span class="token operator">-</span><span class="token operator">></span>options <span class="token operator">&amp;</span> RES_DEFNAMES<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>dots <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>trailing_dot <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>res<span class="token operator">-</span><span class="token operator">></span>options <span class="token operator">&amp;</span> RES_DNSRCH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> done <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token function">_resolv_populate_res_for_net</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>domain <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span><span class="token punctuation">)</span>res<span class="token operator">-</span><span class="token operator">></span>dnsrch<span class="token punctuation">;</span>
           <span class="token operator">*</span>domain <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>done<span class="token punctuation">;</span>
           domain<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            ret <span class="token operator">=</span> <span class="token function">res_querydomainN</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span> target<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ECONNREFUSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                h_errno <span class="token operator">=</span> TRY_AGAIN<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>h_errno<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> NO_DATA<span class="token operator">:</span>
                got_nodata<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/* FALLTHROUGH */</span>
            <span class="token keyword">case</span> HOST_NOT_FOUND<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">/* keep trying */</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> TRY_AGAIN<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>hp<span class="token operator">-</span><span class="token operator">></span>rcode <span class="token operator">==</span> SERVFAIL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">/* try next search element, if any */</span>
                    got_servfail<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">/* FALLTHROUGH */</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment" spellcheck="true">/* anything else implies that we're done */</span>
                done<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>res<span class="token operator">-</span><span class="token operator">></span>options <span class="token operator">&amp;</span> RES_DNSRCH<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    done<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tried_as_is<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">res_querydomainN</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时会把整个域名如<code>www.baidu.com</code> 通过<code>.</code>的符号计算有多少个。如果阅读过我之前写的序言，就知道其实DNS就是根据<code>.</code>划分的层级开始逐层遍历查找不同层级的DNS服务器。</p>
<p>这里前后进行了两次<code>res_querydomainN</code>查询。 第一次是判断当前域名是否有超过阈值，超出了阈值后会进行一次查询。剩下的部分会在下面的循环中根据<code>res-&gt;dnsrch</code>的分割好的域名层层一次进行查询。</p>
<h5 id="res-querydomainN"><a href="#res-querydomainN" class="headerlink" title="res_querydomainN"></a>res_querydomainN</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">res_querydomainN</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span>
    <span class="token keyword">struct</span> res_target <span class="token operator">*</span>target<span class="token punctuation">,</span> res_state res<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> nbuf<span class="token punctuation">[</span>MAXDNAME<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>longname <span class="token operator">=</span> nbuf<span class="token punctuation">;</span>
    size_t n<span class="token punctuation">,</span> d<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>domain <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * Check for trailing '.';
         * copy without '.' if present.
         */</span>
        n <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">></span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nbuf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            h_errno <span class="token operator">=</span> NO_RECOVERY<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">[</span><span class="token operator">--</span>n<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>nbuf<span class="token punctuation">,</span> name<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
            nbuf<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            longname <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        n <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        d <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> d <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">></span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nbuf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            h_errno <span class="token operator">=</span> NO_RECOVERY<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>nbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nbuf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%s.%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">res_queryN</span><span class="token punctuation">(</span>longname<span class="token punctuation">,</span> target<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程会根据域名如<code>www.baidu.com</code>从尾部开始把每一个层级划分出来设置到<code>longname</code>中。</p>
<h4 id="res-queryN"><a href="#res-queryN" class="headerlink" title="res_queryN"></a>res_queryN</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">res_queryN</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* domain name */</span> <span class="token keyword">struct</span> res_target <span class="token operator">*</span>target<span class="token punctuation">,</span>
    res_state res<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    u_char buf<span class="token punctuation">[</span>MAXPACKET<span class="token punctuation">]</span><span class="token punctuation">;</span>
    HEADER <span class="token operator">*</span>hp<span class="token punctuation">;</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> res_target <span class="token operator">*</span>t<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rcode<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ancount<span class="token punctuation">;</span>

    <span class="token function">assert</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* XXX: target may be NULL??? */</span>

    rcode <span class="token operator">=</span> NOERROR<span class="token punctuation">;</span>
    ancount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> target<span class="token punctuation">;</span> t<span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> <span class="token keyword">class</span><span class="token punctuation">,</span> type<span class="token punctuation">;</span>
        u_char <span class="token operator">*</span>answer<span class="token punctuation">;</span>
        <span class="token keyword">int</span> anslen<span class="token punctuation">;</span>
        u_int oflags<span class="token punctuation">;</span>

        hp <span class="token operator">=</span> <span class="token punctuation">(</span>HEADER <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>t<span class="token operator">-</span><span class="token operator">></span>answer<span class="token punctuation">;</span>
        oflags <span class="token operator">=</span> res<span class="token operator">-</span><span class="token operator">></span>_flags<span class="token punctuation">;</span>

again<span class="token operator">:</span>
        hp<span class="token operator">-</span><span class="token operator">></span>rcode <span class="token operator">=</span> NOERROR<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* default */</span>

        <span class="token comment" spellcheck="true">/* make it easier... */</span>
        <span class="token keyword">class</span> <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>qclass<span class="token punctuation">;</span>
        type <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>qtype<span class="token punctuation">;</span>
        answer <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>answer<span class="token punctuation">;</span>
        anslen <span class="token operator">=</span> t<span class="token operator">-</span><span class="token operator">></span>anslen<span class="token punctuation">;</span>


        n <span class="token operator">=</span> <span class="token function">res_nmkquery</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> QUERY<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
            buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> RES_USE_EDNS0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            h_errno <span class="token operator">=</span> NO_RECOVERY<span class="token punctuation">;</span>
            <span class="token keyword">return</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        n <span class="token operator">=</span> <span class="token function">res_nsend</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">,</span> answer<span class="token punctuation">,</span> anslen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> hp<span class="token operator">-</span><span class="token operator">></span>rcode <span class="token operator">!=</span> NOERROR <span class="token operator">||</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>hp<span class="token operator">-</span><span class="token operator">></span>ancount<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rcode <span class="token operator">=</span> hp<span class="token operator">-</span><span class="token operator">></span>rcode<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* record most recent error */</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> RES_USE_EDNS0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ancount <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>hp<span class="token operator">-</span><span class="token operator">></span>ancount<span class="token punctuation">)</span><span class="token punctuation">;</span>

        t<span class="token operator">-</span><span class="token operator">></span>n <span class="token operator">=</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ancount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>rcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> NXDOMAIN<span class="token operator">:</span>
            h_errno <span class="token operator">=</span> HOST_NOT_FOUND<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> SERVFAIL<span class="token operator">:</span>
            h_errno <span class="token operator">=</span> TRY_AGAIN<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> NOERROR<span class="token operator">:</span>
            h_errno <span class="token operator">=</span> NO_DATA<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> FORMERR<span class="token operator">:</span>
        <span class="token keyword">case</span> NOTIMP<span class="token operator">:</span>
        <span class="token keyword">case</span> REFUSED<span class="token operator">:</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            h_errno <span class="token operator">=</span> NO_RECOVERY<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ancount<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于DNS的扩展字段这里就不多聊，我们直接看又关键如下几个关键步骤：</p>
<ul>
<li>1.res_nmkquery 为buf缓冲区 设置当前查询的头部数据（实际上就是一个HEADER结构体）</li>
<li>2.res_nsend 发送buf缓冲区（HEADER结构体）中的数据.</li>
</ul>
<h5 id="res-nsend"><a href="#res-nsend" class="headerlink" title="res_nsend"></a>res_nsend</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/" target="_blank" rel="noopener">bionic</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/" target="_blank" rel="noopener">libc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/" target="_blank" rel="noopener">dns</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/resolv/" target="_blank" rel="noopener">resolv</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/resolv/res_send.c" target="_blank" rel="noopener">res_send.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span>
<span class="token function">res_nsend</span><span class="token punctuation">(</span>res_state statp<span class="token punctuation">,</span>
      <span class="token keyword">const</span> u_char <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> buflen<span class="token punctuation">,</span> u_char <span class="token operator">*</span>ans<span class="token punctuation">,</span> <span class="token keyword">int</span> anssiz<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> gotsomewhere<span class="token punctuation">,</span> terrno<span class="token punctuation">,</span> <span class="token keyword">try</span><span class="token punctuation">,</span> v_circuit<span class="token punctuation">,</span> resplen<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> n<span class="token punctuation">;</span>
    <span class="token keyword">char</span> abuf<span class="token punctuation">[</span>NI_MAXHOST<span class="token punctuation">]</span><span class="token punctuation">;</span>
    ResolvCacheStatus     cache_status <span class="token operator">=</span> RESOLV_CACHE_UNSUPPORTED<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    v_circuit <span class="token operator">=</span> <span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>options <span class="token operator">&amp;</span> RES_USEVC<span class="token punctuation">)</span> <span class="token operator">||</span> buflen <span class="token operator">></span> PACKETSZ<span class="token punctuation">;</span>
    gotsomewhere <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    terrno <span class="token operator">=</span> ETIMEDOUT<span class="token punctuation">;</span>

    <span class="token keyword">int</span>  anslen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    cache_status <span class="token operator">=</span> <span class="token function">_resolv_cache_lookup</span><span class="token punctuation">(</span>
            statp<span class="token operator">-</span><span class="token operator">></span>netid<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span>
            ans<span class="token punctuation">,</span> anssiz<span class="token punctuation">,</span> <span class="token operator">&amp;</span>anslen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache_status <span class="token operator">==</span> RESOLV_CACHE_FOUND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> anslen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cache_status <span class="token operator">!=</span> RESOLV_CACHE_UNSUPPORTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// had a cache miss for a known network, so populate the thread private</span>
        <span class="token comment" spellcheck="true">// data so the normal resolve path can do its thing</span>
        <span class="token function">_resolv_populate_res_for_net</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>nscount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We have no nameservers configured, so there's no point trying.</span>
        <span class="token comment" spellcheck="true">// Tell the cache the query failed, or any retries and anyone else asking the same</span>
        <span class="token comment" spellcheck="true">// question will block for PENDING_REQUEST_TIMEOUT seconds instead of failing fast.</span>
        <span class="token function">_resolv_cache_query_failed</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>netid<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        errno <span class="token operator">=</span> ESRCH<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/*
     * If the ns_addr_list in the resolver context has changed, then
     * invalidate our cached copy and the associated timing data.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>nscount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> needclose <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> sockaddr_storage peer<span class="token punctuation">;</span>
        socklen_t peerlen<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>nscount <span class="token operator">!=</span> statp<span class="token operator">-</span><span class="token operator">></span>nscount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            needclose<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ns <span class="token operator">&lt;</span> statp<span class="token operator">-</span><span class="token operator">></span>nscount<span class="token punctuation">;</span> ns<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>nsaddr_list<span class="token punctuation">[</span>ns<span class="token punctuation">]</span><span class="token punctuation">.</span>sin_family <span class="token operator">&amp;&amp;</span>
                    <span class="token operator">!</span><span class="token function">sock_eq</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>statp<span class="token operator">-</span><span class="token operator">></span>nsaddr_list<span class="token punctuation">[</span>ns<span class="token punctuation">]</span><span class="token punctuation">,</span>
                         <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>ext<span class="token operator">-</span><span class="token operator">></span>nsaddrs<span class="token punctuation">[</span>ns<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    needclose<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>nssocks<span class="token punctuation">[</span>ns<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                peerlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getpeername</span><span class="token punctuation">(</span><span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>nssocks<span class="token punctuation">[</span>ns<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>peer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>peerlen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    needclose<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sock_eq</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>peer<span class="token punctuation">,</span>
                    <span class="token function">get_nsaddr</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>ns<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    needclose<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>needclose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">res_nclose</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>nscount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


    <span class="token comment" spellcheck="true">/*
     * Send request, RETRY times, or until successful.
     */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">try</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">try</span> <span class="token operator">&lt;</span> statp<span class="token operator">-</span><span class="token operator">></span>retry<span class="token punctuation">;</span> <span class="token keyword">try</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> __res_stats stats<span class="token punctuation">[</span>MAXNS<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> __res_params params<span class="token punctuation">;</span>
        <span class="token keyword">int</span> revision_id <span class="token operator">=</span> <span class="token function">_resolv_cache_get_resolver_stats</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>netid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>params<span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> usable_servers<span class="token punctuation">[</span>MAXNS<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">android_net_res_stats_get_usable_servers</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>params<span class="token punctuation">,</span> stats<span class="token punctuation">,</span> statp<span class="token operator">-</span><span class="token operator">></span>nscount<span class="token punctuation">,</span>
            usable_servers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ns <span class="token operator">&lt;</span> statp<span class="token operator">-</span><span class="token operator">></span>nscount<span class="token punctuation">;</span> ns<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>usable_servers<span class="token punctuation">[</span>ns<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>nsap<span class="token punctuation">;</span>
        <span class="token keyword">int</span> nsaplen<span class="token punctuation">;</span>
        time_t now <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rcode <span class="token operator">=</span> RCODE_INTERNAL_ERROR<span class="token punctuation">;</span>
        <span class="token keyword">int</span> delay <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        nsap <span class="token operator">=</span> <span class="token function">get_nsaddr</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nsaplen <span class="token operator">=</span> <span class="token function">get_salen</span><span class="token punctuation">(</span>nsap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        statp<span class="token operator">-</span><span class="token operator">></span>_flags <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>RES_F_LASTMASK<span class="token punctuation">;</span>
        statp<span class="token operator">-</span><span class="token operator">></span>_flags <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>ns <span class="token operator">&lt;&lt;</span> RES_F_LASTSHIFT<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>v_circuit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/* Use datagrams. */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            n <span class="token operator">=</span> <span class="token function">send_dg</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> ans<span class="token punctuation">,</span> anssiz<span class="token punctuation">,</span> <span class="token operator">&amp;</span>terrno<span class="token punctuation">,</span>
                    ns<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v_circuit<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gotsomewhere<span class="token punctuation">,</span> <span class="token operator">&amp;</span>now<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rcode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/* Only record stats the first time we try a query. See above. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">try</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> __res_sample sample<span class="token punctuation">;</span>
                <span class="token function">_res_stats_set_sample</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sample<span class="token punctuation">,</span> now<span class="token punctuation">,</span> rcode<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">_resolv_cache_add_resolver_stats_sample</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>netid<span class="token punctuation">,</span> revision_id<span class="token punctuation">,</span>
                    ns<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sample<span class="token punctuation">,</span> params<span class="token punctuation">.</span>max_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> next_ns<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v_circuit<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> same_ns<span class="token punctuation">;</span>
            resplen <span class="token operator">=</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache_status <span class="token operator">==</span> RESOLV_CACHE_NOTFOUND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">_resolv_cache_add</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>netid<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span>
                      ans<span class="token punctuation">,</span> resplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * If we have temporarily opened a virtual circuit,
         * or if we haven't been asked to keep a socket open,
         * close the socket.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v_circuit <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>options <span class="token operator">&amp;</span> RES_USEVC<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0U</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>options <span class="token operator">&amp;</span> RES_STAYOPEN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0U</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">res_nclose</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>resplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
 next_ns<span class="token operator">:</span> <span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">/*foreach ns*/</span>
    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">/*foreach retry*/</span>
    <span class="token function">res_nclose</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>v_circuit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gotsomewhere<span class="token punctuation">)</span>
            errno <span class="token operator">=</span> ECONNREFUSED<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* no nameservers found */</span>
        <span class="token keyword">else</span>
            errno <span class="token operator">=</span> ETIMEDOUT<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* no answer obtained */</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        errno <span class="token operator">=</span> terrno<span class="token punctuation">;</span>

    <span class="token function">_resolv_cache_query_failed</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>netid<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fail<span class="token operator">:</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.首先通过<code>_resolv_cache_lookup</code> 查询缓存中的已经通过DNS解析好的数据。不过一旦发现res_state中缓存的nsaddr_list发生了改变那么就会废弃当前的缓存继续下面步骤进行查找。</p>
</li>
<li><p>2.在DNS查询中，分为2中模式查询，一种是通过TCP请求，一种是通过UDP请求。我们常用的一般是DNS请求。TCP请求的诞生是因为日益增加的数据量获取，而UDP无法保证数据的连贯性，因此需要使用TCP进行获取。</p>
</li>
</ul>
<p>这里我们就以经典的UDP请求为例子。</p>
<p>send_dg 发送之前设置好的HEADER数据,如果<code>send_dg</code>返回的结果是0，说明还有域名没有解析到，需要进一步的迭代查询。</p>
<h6 id="send-dg"><a href="#send-dg" class="headerlink" title="send_dg"></a>send_dg</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">send_dg</span><span class="token punctuation">(</span>res_state statp<span class="token punctuation">,</span>
    <span class="token keyword">const</span> u_char <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> buflen<span class="token punctuation">,</span> u_char <span class="token operator">*</span>ans<span class="token punctuation">,</span> <span class="token keyword">int</span> anssiz<span class="token punctuation">,</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>terrno<span class="token punctuation">,</span> <span class="token keyword">int</span> ns<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>v_circuit<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>gotsomewhere<span class="token punctuation">,</span>
    time_t <span class="token operator">*</span>at<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>rcode<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> delay<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">*</span>at <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>rcode <span class="token operator">=</span> RCODE_INTERNAL_ERROR<span class="token punctuation">;</span>
    <span class="token operator">*</span>delay <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> HEADER <span class="token operator">*</span>hp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> HEADER <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>
    HEADER <span class="token operator">*</span>anhp <span class="token operator">=</span> <span class="token punctuation">(</span>HEADER <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ans<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>nsap<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nsaplen<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> timespec now<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> finish<span class="token punctuation">,</span> done<span class="token punctuation">;</span>
    fd_set dsmask<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_storage from<span class="token punctuation">;</span>
    socklen_t fromlen<span class="token punctuation">;</span>
    <span class="token keyword">int</span> resplen<span class="token punctuation">,</span> seconds<span class="token punctuation">,</span> n<span class="token punctuation">,</span> s<span class="token punctuation">;</span>

    nsap <span class="token operator">=</span> <span class="token function">get_nsaddr</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nsaplen <span class="token operator">=</span> <span class="token function">get_salen</span><span class="token punctuation">(</span>nsap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>nssocks<span class="token punctuation">[</span>ns<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>nssocks<span class="token punctuation">[</span>ns<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>nsap<span class="token operator">-</span><span class="token operator">></span>sa_family<span class="token punctuation">,</span> SOCK_DGRAM <span class="token operator">|</span> SOCK_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>nssocks<span class="token punctuation">[</span>ns<span class="token punctuation">]</span> <span class="token operator">></span> highestFD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">res_nclose</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            errno <span class="token operator">=</span> ENOTSOCK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>nssocks<span class="token punctuation">[</span>ns<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>errno<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> EPROTONOSUPPORT<span class="token operator">:</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> EPFNOSUPPORT</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
            <span class="token keyword">case</span> EAFNOSUPPORT<span class="token operator">:</span>
                <span class="token function">Perror</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"socket(dg)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token operator">*</span>terrno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
                <span class="token function">Perror</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"socket(dg)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">fchown</span><span class="token punctuation">(</span><span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>nssocks<span class="token punctuation">[</span>ns<span class="token punctuation">]</span><span class="token punctuation">,</span> AID_DNS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>_mark <span class="token operator">!=</span> MARK_UNSET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token function">EXT</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">.</span>nssocks<span class="token punctuation">[</span>ns<span class="token punctuation">]</span><span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span>
                    SO_MARK<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>_mark<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>_mark<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">res_nclose</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendto</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nsap<span class="token punctuation">,</span> nsaplen<span class="token punctuation">)</span> <span class="token operator">!=</span> buflen<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Aerror</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"sendto"</span><span class="token punctuation">,</span> errno<span class="token punctuation">,</span> nsap<span class="token punctuation">,</span> nsaplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">res_nclose</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">/* !CANNOT_CONNECT_DGRAM */</span>


    seconds <span class="token operator">=</span> <span class="token function">get_timeout</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    now <span class="token operator">=</span> <span class="token function">evNowTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timeout <span class="token operator">=</span> <span class="token function">evConsTime</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>seconds<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    finish <span class="token operator">=</span> <span class="token function">evAddTime</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
retry<span class="token operator">:</span>
    n <span class="token operator">=</span> <span class="token function">retrying_select</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dsmask<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>finish<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>rcode <span class="token operator">=</span> RCODE_TIMEOUT<span class="token punctuation">;</span>
        <span class="token operator">*</span>gotsomewhere <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">Perror</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"select"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">res_nclose</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    errno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    fromlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
    resplen <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>ans<span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>anssiz<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
               <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>from<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fromlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>resplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.调用<code>socket</code>系统调用.注意这里面的第一个代表<code>domain</code>参数<code>nsap-&gt;sa_family</code> 并没有进行设置此时就是数值为0的<code>AF_UNSPEC</code>，第二个参数为发送类型为<code>SOCK_DGRAM</code>. <code>AF_UNSPEC</code>是指不指定协议根据内容进行对应的解析；<code>SOCK_DGRAM</code>的意是指<code>UDP</code>传输方式。</p>
</li>
<li><ol start="2">
<li>sendto 把缓冲区的数据发送出去</li>
</ol>
</li>
</ul>
<ul>
<li><p>3.retrying_select 使用<code>select</code>系统调用把socket的监听交给select系统调用</p>
</li>
<li><ol start="4">
<li>recvfrom 读取从socket传递进来的数据。</li>
</ol>
</li>
</ul>
<h4 id="DNS-服务器的设置"><a href="#DNS-服务器的设置" class="headerlink" title="DNS 服务器的设置"></a>DNS 服务器的设置</h4><p>看了半天好像没说到是怎么设置DNS查询的服务器的。可以看到send_dg方法中通过<code>nsap = get_nsaddr(statp, (size_t)ns);</code>方法获取需要请求的DNS地址。</p>
<p>其实这个数据是在netd第一次获取res_state的时候初始化好的，方法是来自<code>__res_get_state</code>.这个方法会一个线程唯一调用一次res_ninit方法读取系统中设置好的配置。</p>
<p>文件： /<a href="http://androidxref.com/9.0.0_r3/xref/bionic/" target="_blank" rel="noopener">bionic</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/" target="_blank" rel="noopener">libc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/" target="_blank" rel="noopener">dns</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/resolv/" target="_blank" rel="noopener">resolv</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/resolv/res_init.c" target="_blank" rel="noopener">res_init.c</a></p>
<p>下面是核心的阶段</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>_PATH_RESCONF<span class="token punctuation">,</span> <span class="token string">"re"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* read the config file */</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>buf <span class="token operator">==</span> <span class="token string">';'</span> <span class="token operator">||</span> <span class="token operator">*</span>buf <span class="token operator">==</span> <span class="token string">'#'</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">MATCH</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"domain"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>haveenv<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/* skip if have from environ */</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            cp <span class="token operator">=</span> buf <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"domain"</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">' '</span> <span class="token operator">||</span> <span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'\t'</span><span class="token punctuation">)</span>
                cp<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>defdname<span class="token punctuation">,</span> cp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>defdname<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            statp<span class="token operator">-</span><span class="token operator">></span>defdname<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>defdname<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cp <span class="token operator">=</span> <span class="token function">strpbrk</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>defdname<span class="token punctuation">,</span> <span class="token string">" \t\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
                <span class="token operator">*</span>cp <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            havesearch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">MATCH</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"search"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>haveenv<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/* skip if have from environ */</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            cp <span class="token operator">=</span> buf <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"search"</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">' '</span> <span class="token operator">||</span> <span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'\t'</span><span class="token punctuation">)</span>
                cp<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>defdname<span class="token punctuation">,</span> cp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>defdname<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            statp<span class="token operator">-</span><span class="token operator">></span>defdname<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>defdname<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cp <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>defdname<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
                <span class="token operator">*</span>cp <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            cp <span class="token operator">=</span> statp<span class="token operator">-</span><span class="token operator">></span>defdname<span class="token punctuation">;</span>
            pp <span class="token operator">=</span> statp<span class="token operator">-</span><span class="token operator">></span>dnsrch<span class="token punctuation">;</span>
            <span class="token operator">*</span>pp<span class="token operator">++</span> <span class="token operator">=</span> cp<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">*</span>cp <span class="token operator">&amp;&amp;</span> pp <span class="token operator">&lt;</span> statp<span class="token operator">-</span><span class="token operator">></span>dnsrch <span class="token operator">+</span> MAXDNSRCH<span class="token punctuation">;</span> cp<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">' '</span> <span class="token operator">||</span> <span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'\t'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token operator">*</span>cp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token operator">*</span>pp<span class="token operator">++</span> <span class="token operator">=</span> cp<span class="token punctuation">;</span>
                    n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">!=</span> <span class="token string">'\0'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>cp <span class="token operator">!=</span> <span class="token string">' '</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>cp <span class="token operator">!=</span> <span class="token string">'\t'</span><span class="token punctuation">)</span>
                cp<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>cp <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>pp<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            havesearch <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">MATCH</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"nameserver"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> nserv <span class="token operator">&lt;</span> MAXNS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> addrinfo hints<span class="token punctuation">,</span> <span class="token operator">*</span>ai<span class="token punctuation">;</span>
            <span class="token keyword">char</span> sbuf<span class="token punctuation">[</span>NI_MAXSERV<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> size_t minsiz <span class="token operator">=</span>
                <span class="token keyword">sizeof</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>_u<span class="token punctuation">.</span>_ext<span class="token punctuation">.</span>ext<span class="token operator">-</span><span class="token operator">></span>nsaddrs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            cp <span class="token operator">=</span> buf <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"nameserver"</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">' '</span> <span class="token operator">||</span> <span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'\t'</span><span class="token punctuation">)</span>
            cp<span class="token operator">++</span><span class="token punctuation">;</span>
            cp<span class="token punctuation">[</span><span class="token function">strcspn</span><span class="token punctuation">(</span>cp<span class="token punctuation">,</span> <span class="token string">";# \t\n"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">!=</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>hints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> PF_UNSPEC<span class="token punctuation">;</span>
            hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_DGRAM<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*dummy*/</span>
            hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_NUMERICHOST<span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>sbuf<span class="token punctuation">,</span> <span class="token string">"%u"</span><span class="token punctuation">,</span> NAMESERVER_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getaddrinfo</span><span class="token punctuation">(</span>cp<span class="token punctuation">,</span> sbuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ai<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                ai<span class="token operator">-</span><span class="token operator">></span>ai_addrlen <span class="token operator">&lt;=</span> minsiz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>_u<span class="token punctuation">.</span>_ext<span class="token punctuation">.</span>ext <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>statp<span class="token operator">-</span><span class="token operator">></span>_u<span class="token punctuation">.</span>_ext<span class="token punctuation">.</span>ext<span class="token operator">-</span><span class="token operator">></span>nsaddrs<span class="token punctuation">[</span>nserv<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    ai<span class="token operator">-</span><span class="token operator">></span>ai_addr<span class="token punctuation">,</span> ai<span class="token operator">-</span><span class="token operator">></span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_addrlen <span class="token operator">&lt;=</span>
                    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>nsaddr_list<span class="token punctuation">[</span>nserv<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>statp<span class="token operator">-</span><span class="token operator">></span>nsaddr_list<span class="token punctuation">[</span>nserv<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    ai<span class="token operator">-</span><span class="token operator">></span>ai_addr<span class="token punctuation">,</span> ai<span class="token operator">-</span><span class="token operator">></span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span>
                statp<span class="token operator">-</span><span class="token operator">></span>nsaddr_list<span class="token punctuation">[</span>nserv<span class="token punctuation">]</span><span class="token punctuation">.</span>sin_family <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>ai<span class="token punctuation">)</span><span class="token punctuation">;</span>
                nserv<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">MATCH</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"sortlist"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> in_addr a<span class="token punctuation">;</span>

            cp <span class="token operator">=</span> buf <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"sortlist"</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>nsort <span class="token operator">&lt;</span> MAXRESOLVSORT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">' '</span> <span class="token operator">||</span> <span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'\t'</span><span class="token punctuation">)</span>
                cp<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'\0'</span> <span class="token operator">||</span> <span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">'\n'</span> <span class="token operator">||</span> <span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token string">';'</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            net <span class="token operator">=</span> cp<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">ISSORTMASK</span><span class="token punctuation">(</span><span class="token operator">*</span>cp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>cp <span class="token operator">!=</span> <span class="token string">';'</span> <span class="token operator">&amp;&amp;</span>
                   <span class="token function">isascii</span><span class="token punctuation">(</span><span class="token operator">*</span>cp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isspace</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">*</span>cp<span class="token punctuation">)</span><span class="token punctuation">)</span>
                cp<span class="token operator">++</span><span class="token punctuation">;</span>
            n <span class="token operator">=</span> <span class="token operator">*</span>cp<span class="token punctuation">;</span>
            <span class="token operator">*</span>cp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_aton</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                statp<span class="token operator">-</span><span class="token operator">></span>sort_list<span class="token punctuation">[</span>nsort<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> a<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ISSORTMASK</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>cp<span class="token operator">++</span> <span class="token operator">=</span> n<span class="token punctuation">;</span>
                net <span class="token operator">=</span> cp<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>cp <span class="token operator">!=</span> <span class="token string">';'</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token function">isascii</span><span class="token punctuation">(</span><span class="token operator">*</span>cp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token operator">!</span><span class="token function">isspace</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">*</span>cp<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    cp<span class="token operator">++</span><span class="token punctuation">;</span>
                n <span class="token operator">=</span> <span class="token operator">*</span>cp<span class="token punctuation">;</span>
                <span class="token operator">*</span>cp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_aton</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    statp<span class="token operator">-</span><span class="token operator">></span>sort_list<span class="token punctuation">[</span>nsort<span class="token punctuation">]</span><span class="token punctuation">.</span>mask <span class="token operator">=</span> a<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    statp<span class="token operator">-</span><span class="token operator">></span>sort_list<span class="token punctuation">[</span>nsort<span class="token punctuation">]</span><span class="token punctuation">.</span>mask <span class="token operator">=</span>
                    <span class="token function">net_mask</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>sort_list<span class="token punctuation">[</span>nsort<span class="token punctuation">]</span><span class="token punctuation">.</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                statp<span class="token operator">-</span><span class="token operator">></span>sort_list<span class="token punctuation">[</span>nsort<span class="token punctuation">]</span><span class="token punctuation">.</span>mask <span class="token operator">=</span>
                    <span class="token function">net_mask</span><span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>sort_list<span class="token punctuation">[</span>nsort<span class="token punctuation">]</span><span class="token punctuation">.</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                nsort<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token operator">*</span>cp <span class="token operator">=</span> n<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">MATCH</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"options"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">res_setoptions</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> buf <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"options"</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"conf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nserv <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        statp<span class="token operator">-</span><span class="token operator">></span>nscount <span class="token operator">=</span> nserv<span class="token punctuation">;</span>
        statp<span class="token operator">-</span><span class="token operator">></span>nsort <span class="token operator">=</span> nsort<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在Android中对应的文件名为<code>resolv.conf</code></p>
<pre><code>_PATH_RESCONF        "/etc/ppp/resolv.conf"</code></pre><p>下面是一个例子：</p>
<pre><code>domain  51osos.com

search  [www.51osos.com](http://www.51osos.com/)  51osos.com

nameserver 202.102.192.68

nameserver 202.102.192.69
</code></pre><p>这段代码就是对这个字符串进行解析：</p>
<ul>
<li>nameserver 对应DNS服务器</li>
<li>domain 自定义的本地域名</li>
<li>search 代表定义域名的搜索列表</li>
<li>sortlist 对返回的域名进行排序</li>
</ul>
<p>对于我们来说，值得注意的是<code>nameserver</code>对应的数据，会注入到<code>statp-&gt;nsaddr_list</code>列表中,在后续发送时候就会根据这些DNS服务器进行解析。其中必定存在<code>8.8.8.8</code>google面向全球提供的DNS服务器。</p>
<p>这一段的知识来源是来自我对Linux系统的理解和结合Android源码的流程进行理解，然而我没在Android虚拟机中没找到对应的文件，如果知道的朋友请告诉一下我学习一下。</p>
<h3 id="UDP-传输的DNS查询数据格式"><a href="#UDP-传输的DNS查询数据格式" class="headerlink" title="UDP 传输的DNS查询数据格式"></a>UDP 传输的DNS查询数据格式</h3><p>既然知道这是怎么传送的，来看看传送的数据是什么。</p>
<p>一说起DNS查询报文，我们上一张大家十分熟悉的图</p>
<p><img src="/images/DNS%E6%9F%A5%E8%AF%A2%E6%8A%A5%E6%96%87.gif" alt="DNS查询报文.gif"></p>
<p>DNS报文可以分为两种类型：</p>
<ul>
<li>1.DNS 请求查询</li>
<li>2.DNS 查询相应</li>
</ul>
<p>但是整个数据协议格式都是一致的。</p>
<p>DNS报文可以分为如下三个区域的：</p>
<ul>
<li><p>1.基础部分 </p>
</li>
<li><p>2.问题部分</p>
</li>
<li><p>3.资源记录部分</p>
</li>
</ul>
<p>DNS请求查询阶段中，会设置基础和问题部分。而资源记录部分则通过0进行占位。</p>
<h4 id="基础部分"><a href="#基础部分" class="headerlink" title="基础部分"></a>基础部分</h4><p>下面是一个查询的例子(数据来源于 <a href="http://c.biancheng.net/view/6457.html)：" target="_blank" rel="noopener">http://c.biancheng.net/view/6457.html)：</a></p>
<pre><code>Domain Name System (query)
    Transaction ID: 0x9ad0                              #事务ID
    Flags: 0x0000 Standard query                        #报文中的标志字段
        0... .... .... .... = Response: Message is a query
                                                        #QR字段, 值为0, 因为是一个请求包
        .000 0... .... .... = Opcode: Standard query (0)
                                                        #Opcode字段, 值为0, 因为是标准查询
        .... ..0. .... .... = Truncated: Message is not truncated
                                                        #TC字段
        .... ...0 .... .... = Recursion desired: Don't do query recursively 
                                                        #RD字段
        .... .... .0.. .... = Z: reserved (0)           #保留字段, 值为0
        .... .... ...0 .... = Non-authenticated data: Unacceptable   
                                                        #保留字段, 值为0
    Questions: 1                                        #问题计数, 这里有1个问题
    Answer RRs: 0                                       #回答资源记录数
    Authority RRs: 0                                    #权威名称服务器计数
    Additional RRs: 0                                   #附加资源记录数</code></pre><p>在这个部分里面为基础部分，基础部分又称为报文首部，在bionic中用Header结构体进行表示。</p>
<p><img src="/images/DNS%E5%9F%BA%E7%A1%80%E9%83%A8%E5%88%86.gif" alt="DNS基础部分.gif"></p>
<ul>
<li>事务 ID：DNS 报文的 ID 标识。对于请求报文和其对应的应答报文，该字段的值是相同的。通过它可以区分 DNS 应答报文是对哪个请求进行响应的。</li>
<li>标志：DNS 报文中的标志字段。</li>
<li>问题计数：DNS 查询请求的数目。</li>
<li>回答资源记录数：DNS 响应的数目。</li>
<li>权威名称服务器计数：权威名称服务器的数目。</li>
<li>附加资源记录数：额外的记录数目（权威名称服务器对应 IP 地址的数目）。</li>
</ul>
<p>当DNS相应查询后，就会在资源查询部分添加查询的结果。</p>
<p>下面是一个查询响应的例子：</p>
<pre><code>Domain Name System (response)
    Transaction ID: 0x9ad0                                    #事务ID
    Flags: 0x8180 Standard query response, No error           #报文中的标志字段
        1... .... .... .... = Response: Message is a response
                                                              #QR字段, 值为1, 因为是一个响应包
        .000 0... .... .... = Opcode: Standard query (0)      # Opcode字段
        .... .0.. .... .... = Authoritative: Server is not an authority for
        domain                                                #AA字段
        .... ..0. .... .... = Truncated: Message is not truncated
                                                              #TC字段
        .... ...1 .... .... = Recursion desired: Do query recursively 
                                                              #RD字段
        .... .... 1... .... = Recursion available: Server can do recursive
        queries                                               #RA字段
        .... .... .0.. .... = Z: reserved (0)
        .... .... ..0. .... = Answer authenticated: Answer/authority portion
        was not authenticated by the server
        .... .... ...0 .... = Non-authenticated data: Unacceptable
        .... .... .... 0000 = Reply code: No error (0)        #返回码字段
    Questions: 1
    Answer RRs: 2
    Authority RRs: 5
    Additional RRs: 5</code></pre><p>整个首部是通过如下结构体进行表示：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span>    id <span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* query identification number */</span>
            <span class="token comment" spellcheck="true">/* fields in third byte */</span>
    <span class="token keyword">unsigned</span>    rd <span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* recursion desired */</span>
    <span class="token keyword">unsigned</span>    tc <span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* truncated message */</span>
    <span class="token keyword">unsigned</span>    aa <span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* authoritive answer */</span>
    <span class="token keyword">unsigned</span>    opcode <span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* purpose of message */</span>
    <span class="token keyword">unsigned</span>    qr <span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* response flag */</span>
            <span class="token comment" spellcheck="true">/* fields in fourth byte */</span>
    <span class="token keyword">unsigned</span>    rcode <span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* response code */</span>
    <span class="token keyword">unsigned</span>    cd<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* checking disabled by resolver */</span>
    <span class="token keyword">unsigned</span>    ad<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* authentic data from named */</span>
    <span class="token keyword">unsigned</span>    unused <span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* unused bits (MBZ as of 4.9.3a3) */</span>
    <span class="token keyword">unsigned</span>    ra <span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* recursion available */</span>
            <span class="token comment" spellcheck="true">/* remaining bytes */</span>
    <span class="token keyword">unsigned</span>    qdcount <span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* number of question entries */</span>
    <span class="token keyword">unsigned</span>    ancount <span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* number of answer entries */</span>
    <span class="token keyword">unsigned</span>    nscount <span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* number of authority entries */</span>
    <span class="token keyword">unsigned</span>    arcount <span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* number of resource entries */</span>
<span class="token punctuation">}</span> HEADER<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>qr（Response）：查询请求/响应的标志信息。查询请求时，值为 0；响应时，值为 1。</li>
<li>opcode：操作码。其中，0 表示标准查询；1 表示反向查询；2 表示服务器状态请求。</li>
<li>aa（Authoritative）：授权应答，该字段在响应报文中有效。值为 1 时，表示名称服务器是权威服务器；值为 0 时，表示不是权威服务器。</li>
<li>tc（Truncated）：表示是否被截断。值为 1 时，表示响应已超过 512 字节并已被截断，只返回前 512 个字节。</li>
<li>rd（Recursion Desired）：期望递归。该字段能在一个查询中设置，并在响应中返回。该标志告诉名称服务器必须处理这个查询，这种方式被称为一个递归查询。如果该位为 0，且被请求的名称服务器没有一个授权回答，它将返回一个能解答该查询的其他名称服务器列表。这种方式被称为迭代查询。</li>
<li>ra（Recursion Available）：可用递归。该字段只出现在响应报文中。当值为 1 时，表示服务器支持递归查询。</li>
<li>Z：保留字段，在所有的请求和应答报文中，它的值必须为 0。</li>
<li>rcode（Reply code）：返回码字段，表示响应的差错状态。当值为 0 时，表示没有错误；当值为 1 时，表示报文格式错误（Format error），服务器不能理解请求的报文；当值为 2 时，表示域名服务器失败（Server failure），因为服务器的原因导致没办法处理这个请求；当值为 3 时，表示名字错误（Name Error），只有对授权域名解析服务器有意义，指出解析的域名不存在；当值为 4 时，表示查询类型不支持（Not Implemented），即域名服务器不支持查询类型；当值为 5 时，表示拒绝（Refused），一般是服务器由于设置的策略拒绝给出应答，如服务器不希望对某些请求者给出应答。</li>
</ul>
<h4 id="问题部分"><a href="#问题部分" class="headerlink" title="问题部分"></a>问题部分</h4><p><img src="/images/DNS%E9%97%AE%E9%A2%98%E6%9F%A5%E8%AF%A2%E9%83%A8%E5%88%86.gif" alt="DNS问题查询部分.gif"></p>
<p>整个问题部分十分简单，分为如下几个部分：</p>
<ul>
<li>查询名： 要查询的地址。可能是ip地址，用于反向查询</li>
<li>查询类型： DNS查询请求的资源类型，如A类代表是获取域名对应的ip地址，在源码中用TA表示</li>
<li>查询类：地址类型。</li>
</ul>
<p>举一个例子：</p>
<pre><code>Domain Name System (query)                        #查询请求
    Queries                                       #问题部分
        baidu.com: type A, class IN
            Name: baidu.com                       #查询名字段, 这里请求域名baidu.com
            [Name Length: 9]
            [Label Count: 2]
            Type: A (Host Address) (1)            #查询类型字段, 这里为A类型
            Class: IN (0x0001)                    #查询类字段, 这里为互联网地址</code></pre><p>那么基础部分和问题部分表现在源码中是什么形式呢？其实这部分工作是交给<code>res_mkquery</code>完成的。</p>
<h4 id="res-mkquery-构建DNS查询的基础部分和问题部分"><a href="#res-mkquery-构建DNS查询的基础部分和问题部分" class="headerlink" title="res_mkquery 构建DNS查询的基础部分和问题部分"></a>res_mkquery 构建DNS查询的基础部分和问题部分</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/" target="_blank" rel="noopener">bionic</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/" target="_blank" rel="noopener">libc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/" target="_blank" rel="noopener">dns</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/resolv/" target="_blank" rel="noopener">resolv</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/dns/resolv/res_mkquery.c" target="_blank" rel="noopener">res_mkquery.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">        n <span class="token operator">=</span> <span class="token function">res_nmkquery</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> QUERY<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
            buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span>
<span class="token function">res_nmkquery</span><span class="token punctuation">(</span>res_state statp<span class="token punctuation">,</span>
         <span class="token keyword">int</span> op<span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">/* opcode of query */</span>
         <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dname<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">/* domain name */</span>
         <span class="token keyword">int</span> <span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* class and type of query */</span>
         <span class="token keyword">const</span> u_char <span class="token operator">*</span>data<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* resource record data */</span>
         <span class="token keyword">int</span> datalen<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">/* length of data */</span>
         <span class="token keyword">const</span> u_char <span class="token operator">*</span>newrr_in<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* new rr for modify or append */</span>
         u_char <span class="token operator">*</span>buf<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">/* buffer to put query */</span>
         <span class="token keyword">int</span> buflen<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">/* size of buffer */</span>
<span class="token punctuation">{</span>
    <span class="token keyword">register</span> HEADER <span class="token operator">*</span>hp<span class="token punctuation">;</span>
    <span class="token keyword">register</span> u_char <span class="token operator">*</span>cp<span class="token punctuation">,</span> <span class="token operator">*</span>ep<span class="token punctuation">;</span>
    <span class="token keyword">register</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    u_char <span class="token operator">*</span>dnptrs<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>dpp<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>lastdnptr<span class="token punctuation">;</span>

    <span class="token function">UNUSED</span><span class="token punctuation">(</span>newrr_in<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>buf <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>buflen <span class="token operator">&lt;</span> HFIXEDSZ<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> HFIXEDSZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hp <span class="token operator">=</span> <span class="token punctuation">(</span>HEADER <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>
    hp<span class="token operator">-</span><span class="token operator">></span>id <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">res_randomid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hp<span class="token operator">-</span><span class="token operator">></span>opcode <span class="token operator">=</span> op<span class="token punctuation">;</span>
    hp<span class="token operator">-</span><span class="token operator">></span>rd <span class="token operator">=</span> <span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>options <span class="token operator">&amp;</span> RES_RECURSE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0U</span><span class="token punctuation">;</span>
    hp<span class="token operator">-</span><span class="token operator">></span>ad <span class="token operator">=</span> <span class="token punctuation">(</span>statp<span class="token operator">-</span><span class="token operator">></span>options <span class="token operator">&amp;</span> RES_USE_DNSSEC<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0U</span><span class="token punctuation">;</span>
    hp<span class="token operator">-</span><span class="token operator">></span>rcode <span class="token operator">=</span> NOERROR<span class="token punctuation">;</span>
    cp <span class="token operator">=</span> buf <span class="token operator">+</span> HFIXEDSZ<span class="token punctuation">;</span>
    ep <span class="token operator">=</span> buf <span class="token operator">+</span> buflen<span class="token punctuation">;</span>
    dpp <span class="token operator">=</span> dnptrs<span class="token punctuation">;</span>
    <span class="token operator">*</span>dpp<span class="token operator">++</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>
    <span class="token operator">*</span>dpp<span class="token operator">++</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    lastdnptr <span class="token operator">=</span> dnptrs <span class="token operator">+</span> <span class="token keyword">sizeof</span> dnptrs <span class="token operator">/</span> <span class="token keyword">sizeof</span> dnptrs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/*
     * perform opcode specific processing
     */</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> QUERY<span class="token operator">:</span>    <span class="token comment" spellcheck="true">/*FALLTHROUGH*/</span>
    <span class="token keyword">case</span> NS_NOTIFY_OP<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ep <span class="token operator">-</span> cp <span class="token operator">&lt;</span> QFIXEDSZ<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">dn_comp</span><span class="token punctuation">(</span>dname<span class="token punctuation">,</span> cp<span class="token punctuation">,</span> ep <span class="token operator">-</span> cp <span class="token operator">-</span> QFIXEDSZ<span class="token punctuation">,</span> dnptrs<span class="token punctuation">,</span>
            lastdnptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cp <span class="token operator">+</span><span class="token operator">=</span> n<span class="token punctuation">;</span>
        <span class="token function">ns_put16</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> cp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cp <span class="token operator">+</span><span class="token operator">=</span> INT16SZ<span class="token punctuation">;</span>
        <span class="token function">ns_put16</span><span class="token punctuation">(</span><span class="token keyword">class</span><span class="token punctuation">,</span> cp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cp <span class="token operator">+</span><span class="token operator">=</span> INT16SZ<span class="token punctuation">;</span>
        hp<span class="token operator">-</span><span class="token operator">></span>qdcount <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>op <span class="token operator">==</span> QUERY <span class="token operator">||</span> data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ep <span class="token operator">-</span> cp<span class="token punctuation">)</span> <span class="token operator">&lt;</span> RRFIXEDSZ<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        n <span class="token operator">=</span> <span class="token function">dn_comp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">,</span> cp<span class="token punctuation">,</span> ep <span class="token operator">-</span> cp <span class="token operator">-</span> RRFIXEDSZ<span class="token punctuation">,</span>
                dnptrs<span class="token punctuation">,</span> lastdnptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cp <span class="token operator">+</span><span class="token operator">=</span> n<span class="token punctuation">;</span>
        <span class="token function">ns_put16</span><span class="token punctuation">(</span>T_NULL<span class="token punctuation">,</span> cp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cp <span class="token operator">+</span><span class="token operator">=</span> INT16SZ<span class="token punctuation">;</span>
        <span class="token function">ns_put16</span><span class="token punctuation">(</span><span class="token keyword">class</span><span class="token punctuation">,</span> cp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cp <span class="token operator">+</span><span class="token operator">=</span> INT16SZ<span class="token punctuation">;</span>
        <span class="token function">ns_put32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> cp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cp <span class="token operator">+</span><span class="token operator">=</span> INT32SZ<span class="token punctuation">;</span>
        <span class="token function">ns_put16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> cp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cp <span class="token operator">+</span><span class="token operator">=</span> INT16SZ<span class="token punctuation">;</span>
        hp<span class="token operator">-</span><span class="token operator">></span>arcount <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> IQUERY<span class="token operator">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>cp <span class="token operator">-</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时调用的标志位为<code>QUERY</code>，此时会依次往HEADER中设置了如下的数据：</p>
<ul>
<li>id 事务id 通过一个<code>res_randomid</code>随机数方法设置</li>
<li>opcode 操作码 为<code>QUERY</code></li>
<li>rd 和 ad。这两个递归标志位分别由<code>RES_RECURSE</code> 以及<code>RES_USE_DNSSEC</code>决定。</li>
<li>rcode 为NOERROR</li>
</ul>
<p>其他默认为0.接着<code>cp</code> 是缓冲区的地址指针。因为这个Header最后会记录到缓冲区buf中，此时向后移动一个HEADER的大小，就是设置问题区域的位置了。</p>
<p>因此下面不断的向后移动16位，依次设置了dname（查询名,dn_com通过name_compress进行编码压缩）,type(查询类型)以及class(查询类)。</p>
<h4 id="获取DNS服务器返回的查询结果"><a href="#获取DNS服务器返回的查询结果" class="headerlink" title="获取DNS服务器返回的查询结果"></a>获取DNS服务器返回的查询结果</h4><p>先来看看整个格式：<br><img src="/images/DNS%E8%B5%84%E6%BA%90%E8%AE%B0%E5%BD%95%E9%83%A8%E5%88%86.gif" alt="DNS资源记录部分.gif"></p>
<p>这里分为如下6个部分：</p>
<ul>
<li>1.域名： DNS请求的域名</li>
<li>2.类型 ：资源记录类型和问题部分一致</li>
<li>3.类：地址类型</li>
<li>4.生存时间：秒为单位的，生命周期内可以通过之前提过的缓存方法从中获取到缓存并返回</li>
<li>5.资源长度</li>
<li>6.资源数据：表示按照查询的资源返回的数据。</li>
</ul>
<p>下面是一个例子：</p>
<pre><code>Answers                                                      #“回答问题区域”字段
    baidu.com: type A, class IN, addr 220.181.57.216         #资源记录部分
        Name: baidu.com                                      #域名字段, 这里请求的域名为baidu.com
        Type: A (Host Address) (1)                           #类型字段, 这里为A类型
        Class: IN (0x0001)                                   #类字段
        Time to live: 5                                      #生存时间
        Data length: 4                                       #数据长度
        Address: 220.181.57.216                              #资源数据, 这里为IP地址
    baidu.com: type A, class IN, addr 123.125.115.110        #资源记录部分
        Name: baidu.com
        Type: A (Host Address) (1)
        Class: IN (0x0001)
        Time to live: 5
        Data length: 4
        Address: 123.125.115.110</code></pre><p>表现在代码的形式，就是在核心方法在<code>_dns_getaddrinfo</code>：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">ai <span class="token operator">=</span> <span class="token function">getanswer</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> q<span class="token punctuation">.</span>n<span class="token punctuation">,</span> q<span class="token punctuation">.</span>name<span class="token punctuation">,</span> q<span class="token punctuation">.</span>qtype<span class="token punctuation">,</span> pai<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">union</span> <span class="token punctuation">{</span>
    HEADER hdr<span class="token punctuation">;</span>
    u_char buf<span class="token punctuation">[</span>MAXPACKET<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> querybuf<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意此时的用于回应的结果是一个联合体。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> res_target <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> res_target <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* domain name */</span>
    <span class="token keyword">int</span> qclass<span class="token punctuation">,</span> qtype<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* class and type of query */</span>
    u_char <span class="token operator">*</span>answer<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* buffer to put answer */</span>
    <span class="token keyword">int</span> anslen<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* size of answer buffer */</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/* result length */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>res_target 是一个链表项，记录了返回数据模块中的信息，用于辅助解析querybuf</p>
<pre><code>static struct addrinfo *
getanswer(const querybuf *answer, int anslen, const char *qname, int qtype,
    const struct addrinfo *pai)
{
    struct addrinfo sentinel, *cur;
    struct addrinfo ai;
    const struct afd *afd;
    char *canonname;
    const HEADER *hp;
    const u_char *cp;
    int n;
    const u_char *eom;
    char *bp, *ep;
    int type, class, ancount, qdcount;
    int haveanswer, had_error;
    char tbuf[MAXDNAME];
    int (*name_ok) (const char *);
    char hostbuf[8*1024];


    memset(&amp;sentinel, 0, sizeof(sentinel));
    cur = &amp;sentinel;

    canonname = NULL;
    eom = answer-&gt;buf + anslen;
    switch (qtype) {
    case T_A:
    case T_AAAA:
    case T_ANY:    /*use T_ANY only for T_A/T_AAAA lookup*/
        name_ok = res_hnok;
        break;
    default:
        return NULL;    /* XXX should be abort(); */
    }

    hp = &amp;answer-&gt;hdr;
    ancount = ntohs(hp-&gt;ancount);
    qdcount = ntohs(hp-&gt;qdcount);
    bp = hostbuf;
    ep = hostbuf + sizeof hostbuf;
    cp = answer-&gt;buf;
    BOUNDED_INCR(HFIXEDSZ);
    if (qdcount != 1) {
        h_errno = NO_RECOVERY;
        return (NULL);
    }
    n = dn_expand(answer-&gt;buf, eom, cp, bp, ep - bp);
    if ((n &lt; 0) || !(*name_ok)(bp)) {
        h_errno = NO_RECOVERY;
        return (NULL);
    }
    BOUNDED_INCR(n + QFIXEDSZ);
    if (qtype == T_A || qtype == T_AAAA || qtype == T_ANY) {

        n = strlen(bp) + 1;        /* for the \0 */
        if (n &gt;= MAXHOSTNAMELEN) {
            h_errno = NO_RECOVERY;
            return (NULL);
        }
        canonname = bp;
        bp += n;
        /* The qname can be abbreviated, but h_name is now absolute. */
        qname = canonname;
    }
    haveanswer = 0;
    had_error = 0;
    while (ancount-- &gt; 0 &amp;&amp; cp &lt; eom &amp;&amp; !had_error) {
        n = dn_expand(answer-&gt;buf, eom, cp, bp, ep - bp);
        if ((n &lt; 0) || !(*name_ok)(bp)) {
            had_error++;
            continue;
        }
        cp += n;            /* name */
        BOUNDS_CHECK(cp, 3 * INT16SZ + INT32SZ);
        type = _getshort(cp);
         cp += INT16SZ;            /* type */
        class = _getshort(cp);
         cp += INT16SZ + INT32SZ;    /* class, TTL */
        n = _getshort(cp);
        cp += INT16SZ;            /* len */
        BOUNDS_CHECK(cp, n);
        if (class != C_IN) {
            cp += n;
            continue;        
        }
        if ((qtype == T_A || qtype == T_AAAA || qtype == T_ANY) &amp;&amp;
            type == T_CNAME) {
            n = dn_expand(answer-&gt;buf, eom, cp, tbuf, sizeof tbuf);
            if ((n &lt; 0) || !(*name_ok)(tbuf)) {
                had_error++;
                continue;
            }
            cp += n;
            /* Get canonical name. */
            n = strlen(tbuf) + 1;    /* for the \0 */
            if (n &gt; ep - bp || n &gt;= MAXHOSTNAMELEN) {
                had_error++;
                continue;
            }
            strlcpy(bp, tbuf, (size_t)(ep - bp));
            canonname = bp;
            bp += n;
            continue;
        }
        if (qtype == T_ANY) {
            if (!(type == T_A || type == T_AAAA)) {
                cp += n;
                continue;
            }
        } else if (type != qtype) {
            if (type != T_KEY &amp;&amp; type != T_SIG)

            cp += n;
            continue;        /* XXX - had_error++ ? */
        }
        switch (type) {
        case T_A:
        case T_AAAA:
            if (strcasecmp(canonname, bp) != 0) {
                cp += n;
                continue;    /* XXX - had_error++ ? */
            }
            if (type == T_A &amp;&amp; n != INADDRSZ) {
                cp += n;
                continue;
            }
            if (type == T_AAAA &amp;&amp; n != IN6ADDRSZ) {
                cp += n;
                continue;
            }
            if (type == T_AAAA) {
                struct in6_addr in6;
                memcpy(&amp;in6, cp, IN6ADDRSZ);
                if (IN6_IS_ADDR_V4MAPPED(&amp;in6)) {
                    cp += n;
                    continue;
                }
            }
            if (!haveanswer) {
                int nn;

                canonname = bp;
                nn = strlen(bp) + 1;    /* for the \0 */
                bp += nn;
            }

            /* don't overwrite pai */
            ai = *pai;
            ai.ai_family = (type == T_A) ? AF_INET : AF_INET6;
            afd = find_afd(ai.ai_family);
            if (afd == NULL) {
                cp += n;
                continue;
            }
            cur-&gt;ai_next = get_ai(&amp;ai, afd, (const char *)cp);
            if (cur-&gt;ai_next == NULL)
                had_error++;
            while (cur &amp;&amp; cur-&gt;ai_next)
                cur = cur-&gt;ai_next;
            cp += n;
            break;
        default:
            abort();
        }
        if (!had_error)
            haveanswer++;
    }
    if (haveanswer) {
        if (!canonname)
            (void)get_canonname(pai, sentinel.ai_next, qname);
        else
            (void)get_canonname(pai, sentinel.ai_next, canonname);
        h_errno = NETDB_SUCCESS;
        return sentinel.ai_next;
    }

    h_errno = NO_RECOVERY;
    return NULL;
}</code></pre><p>这里有三个重要的指针：</p>
<ul>
<li>bp 用于承载解析出来的头部数据 hostbuf</li>
<li>ep hostbuf后用于承载后续的资源记录部分</li>
<li>cp 指向了querybuf结构体的起始地址</li>
<li>eom 是指向了querybuf 后面的资源记录部分</li>
</ul>
<p>流程如下：</p>
<ul>
<li><ol>
<li>dn_expand 方法把<code>answer-&gt;buf</code>中的数据解码解析(每一次解析一个hostbuf的大小 8kb)，保存到bp指针指向的内存地址</li>
</ol>
</li>
<li><ol start="2">
<li>如果此时是<code>T_A</code>类型，则把<code>bp</code>解析到的头几位作为域名<code>canonname</code>，并把指针向后移动长度+1(处理‘\0’)</li>
</ol>
</li>
<li>3.接下来就是一个循环，因为可能返回了多个地址内容。这里的前提是ancont也就是回答数目大于0，同时第一次递增cp的指针发现小于eom，说明还有没有解析的数据。</li>
<li>4.再调用一次<code>dn_expand</code>方法，把压缩的数据解码出来放到cp指针后续的地址，接着依次取出其中的class(类)和type(类型)。当判断到type是<code>T_A</code>，则继续往后展开内容到<code>tbuf</code>中。</li>
<li>5.然后把cp解码的数据通过<code>get_ai</code>直接拷贝到<code>addrinfo</code></li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> addrinfo <span class="token punctuation">{</span>
    <span class="token keyword">int</span>    ai_flags<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* AI_PASSIVE, AI_CANONNAME, AI_NUMERICHOST */</span>
    <span class="token keyword">int</span>    ai_family<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* PF_xxx */</span>
    <span class="token keyword">int</span>    ai_socktype<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* SOCK_xxx */</span>
    <span class="token keyword">int</span>    ai_protocol<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* 0 or IPPROTO_xxx for IPv4 and IPv6 */</span>
    socklen_t ai_addrlen<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* length of ai_addr */</span>
    <span class="token keyword">char</span>    <span class="token operator">*</span>ai_canonname<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* canonical name for hostname */</span>
    <span class="token keyword">struct</span>    sockaddr <span class="token operator">*</span>ai_addr<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* binary address */</span>
    <span class="token keyword">struct</span>    addrinfo <span class="token operator">*</span>ai_next<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* next structure in linked list */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>
<span class="token function">get_ai</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>pai<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> afd <span class="token operator">*</span>afd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>ai<span class="token punctuation">;</span>

    ai <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> addrinfo <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> addrinfo<span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token punctuation">(</span>afd<span class="token operator">-</span><span class="token operator">></span>a_socklen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ai <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span>ai<span class="token punctuation">,</span> pai<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> addrinfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ai<span class="token operator">-</span><span class="token operator">></span>ai_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ai <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>afd<span class="token operator">-</span><span class="token operator">></span>a_socklen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ai<span class="token operator">-</span><span class="token operator">></span>ai_addrlen <span class="token operator">=</span> afd<span class="token operator">-</span><span class="token operator">></span>a_socklen<span class="token punctuation">;</span>

    ai<span class="token operator">-</span><span class="token operator">></span>ai_addr<span class="token operator">-</span><span class="token operator">></span>sa_family <span class="token operator">=</span> ai<span class="token operator">-</span><span class="token operator">></span>ai_family <span class="token operator">=</span> afd<span class="token operator">-</span><span class="token operator">></span>a_af<span class="token punctuation">;</span>
    p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ai<span class="token operator">-</span><span class="token operator">></span>ai_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>p <span class="token operator">+</span> afd<span class="token operator">-</span><span class="token operator">></span>a_off<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>afd<span class="token operator">-</span><span class="token operator">></span>a_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ai<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明后面的cp数据接就是<code>addrinfo</code>结构体的内容。当生成了<code>addrinfo</code>后就会返回到底层，并从netd通过socket传送到App进程中，最后返回到Java层的api中。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="/images/DNS%E5%8F%91%E9%80%81%E8%BF%87%E7%A8%8B.png" alt="DNS发送过程.png"></p>
<p>整个流程用图来表示就比较简单了。</p>
<p>在netd进程首先会从线程内存中查询是否有符合的目标，不存在则从文件<code>/system/etc/hosts</code>中读取缓存好的域名对应的ip地址，如果找不到就从配置文件<code>/etc/ppp/resolv.conf</code> 中每一个DNS服务器找到对应的服务器进行迭代查询，最终返回addrinfo结构体的结果，转化成Java对象返回。</p>
<p>也是一个经典的3层缓存模式.</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/01/24/qian-yan/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="# 前言">
                        
                        <span class="card-title"># 前言</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-01-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/11/03/android-chong-xue-xi-lie-okhttp-yuan-ma-jie-xi-si/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="Android重学系列 OkHttp源码解析(四)">
                        
                        <span class="card-title">Android重学系列 OkHttp源码解析(四)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章和大家探讨了，Okhttp的ConnectInterceptor 拦截器。接下来，我们就来聊聊Okhttp最后一个拦截器，CallServerInterceptor拦截器都做了什么？
正文  @Throws(IOExcepti
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-11-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/网络编程/" class="post-category">
                                    网络编程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/网络编程/">
                        <span class="chip bg-color">网络编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
