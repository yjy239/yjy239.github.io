<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android重学系列 OkHttp源码解析(四), Android | Linux | Flutter">
    <meta name="description" content="前言上一篇文章和大家探讨了，Okhttp的ConnectInterceptor 拦截器。接下来，我们就来聊聊Okhttp最后一个拦截器，CallServerInterceptor拦截器都做了什么？
正文  @Throws(IOExcepti">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android重学系列 OkHttp源码解析(四) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/8.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android重学系列 OkHttp源码解析(四)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/网络编程/">
                                <span class="chip bg-color">网络编程</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/网络编程/" class="post-category">
                                网络编程
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-11-03
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        8.5k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        40 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇文章和大家探讨了，Okhttp的ConnectInterceptor 拦截器。接下来，我们就来聊聊Okhttp最后一个拦截器，CallServerInterceptor拦截器都做了什么？</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
    <span class="token keyword">val</span> realChain <span class="token operator">=</span> chain <span class="token keyword">as</span> RealInterceptorChain
    <span class="token keyword">val</span> exchange <span class="token operator">=</span> realChain<span class="token punctuation">.</span>exchange<span class="token operator">!!</span>
    <span class="token keyword">val</span> request <span class="token operator">=</span> realChain<span class="token punctuation">.</span>request
    <span class="token keyword">val</span> requestBody <span class="token operator">=</span> request<span class="token punctuation">.</span>body
    <span class="token keyword">val</span> sentRequestMillis <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    exchange<span class="token punctuation">.</span><span class="token function">writeRequestHeaders</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>

    <span class="token keyword">var</span> invokeStartEvent <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">var</span> responseBuilder<span class="token operator">:</span> Response<span class="token punctuation">.</span>Builder<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>HttpMethod<span class="token punctuation">.</span><span class="token function">permitsRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> requestBody <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// If there's a "Expect: 100-continue" header on the request, wait for a "HTTP/1.1 100</span>
      <span class="token comment" spellcheck="true">// Continue" response before transmitting the request body. If we don't get that, return</span>
      <span class="token comment" spellcheck="true">// what we did get (such as a 4xx response) without ever transmitting the request body.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"100-continue"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Expect"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ignoreCase <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exchange<span class="token punctuation">.</span><span class="token function">flushRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        responseBuilder <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span>expectContinue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        exchange<span class="token punctuation">.</span><span class="token function">responseHeadersStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        invokeStartEvent <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>responseBuilder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBody<span class="token punctuation">.</span><span class="token function">isDuplex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// Prepare a duplex body so that the application can send a request body later.</span>
          exchange<span class="token punctuation">.</span><span class="token function">flushRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">val</span> bufferedRequestBody <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          requestBody<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>bufferedRequestBody<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// Write the request body if the "Expect: 100-continue" expectation was met.</span>
          <span class="token keyword">val</span> bufferedRequestBody <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          requestBody<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>bufferedRequestBody<span class="token punctuation">)</span>
          bufferedRequestBody<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        exchange<span class="token punctuation">.</span><span class="token function">noRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exchange<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>isMultiplexed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// If the "Expect: 100-continue" expectation wasn't met, prevent the HTTP/1 connection</span>
          <span class="token comment" spellcheck="true">// from being reused. Otherwise we're still obligated to transmit the request body to</span>
          <span class="token comment" spellcheck="true">// leave the connection in a consistent state.</span>
          exchange<span class="token punctuation">.</span><span class="token function">noNewExchangesOnConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      exchange<span class="token punctuation">.</span><span class="token function">noRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBody <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>requestBody<span class="token punctuation">.</span><span class="token function">isDuplex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      exchange<span class="token punctuation">.</span><span class="token function">finishRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>responseBuilder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      responseBuilder <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span>expectContinue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">!!</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>invokeStartEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exchange<span class="token punctuation">.</span><span class="token function">responseHeadersStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        invokeStartEvent <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> response <span class="token operator">=</span> responseBuilder
        <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span>sentRequestMillis<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> code <span class="token operator">=</span> response<span class="token punctuation">.</span>code
    <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Server sent a 100-continue even though we did not request one. Try again to read the actual</span>
      <span class="token comment" spellcheck="true">// response status.</span>
      responseBuilder <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span>expectContinue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">!!</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>invokeStartEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exchange<span class="token punctuation">.</span><span class="token function">responseHeadersStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      response <span class="token operator">=</span> responseBuilder
          <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span>sentRequestMillis<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      code <span class="token operator">=</span> response<span class="token punctuation">.</span>code
    <span class="token punctuation">}</span>

    exchange<span class="token punctuation">.</span><span class="token function">responseHeadersEnd</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>

    response <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>forWebSocket <span class="token operator">&amp;&amp;</span> code <span class="token operator">==</span> <span class="token number">101</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Connection is upgrading, but we need to ensure interceptors see a non-null response body.</span>
      response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>EMPTY_RESPONSE<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">openResponseBody</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Connection"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ignoreCase <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token string">"close"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Connection"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ignoreCase <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      exchange<span class="token punctuation">.</span><span class="token function">noNewExchangesOnConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">204</span> <span class="token operator">||</span> code <span class="token operator">==</span> <span class="token number">205</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>body<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">></span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">ProtocolException</span><span class="token punctuation">(</span>
          <span class="token string">"HTTP <span class="token interpolation variable">$code</span> had non-zero Content-Length: <span class="token interpolation"><span class="token delimiter variable">${</span>response<span class="token punctuation">.</span>body<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> response
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>做的事情如下：</p>
<ul>
<li><p>1.exchange.writeRequestHeaders 把请求的头部往socket写入</p>
</li>
<li><ol start="2">
<li>判断到请求方式是并非<code>GET</code>和<code>HEAD</code>,那么需要进行传输请求体。接下来会查看请求的头部是否存在一个<code>Expect</code>的key，内容为<code>HTTP/1.1 100 Continue</code> 说明 此时需要等待服务器专门对这个请求进行等待，继续读取。</li>
</ol>
<ul>
<li>2.1.如果存在，就会执行<code>exchange.readResponseHeaders</code> 读取响应的头部</li>
<li>2.2. 如果读取出来的响应的头部 为空，且判断到 请求体requestBody的<code>isDuplex</code>为false，那么通过<code>exchange.createRequestBody</code>创造新的<code>bufferedRequestBody</code>RequestBodySink 请求体写入流并记录当前的isDuplex为true,往请求Request的<code>requestBody</code>写入。其实就是准备了一个常驻的专门写入请求体的全双工的写入流。</li>
<li>2.3.如果读取出来的响应的头部 不为空，和2.2一样，不过<code>bufferedRequestBody</code>记录的isDuplex为false。但是不同的是这个写入流只存在一次就关闭了。因此isDuplex实际上代表的就是是否可以常驻一个写入请求流的标志位。</li>
<li>2.4.如果读取出来的响应头不存在将不会继续写入请求体。</li>
</ul>
</li>
<li><p>3.如果是<code>GET</code>和<code>HEAD</code>模式，就没必要写入请求体了。</p>
</li>
<li><p>4.如果没有请求体或者请求体的isDuplex为false(只使用一次的请求体流),可以直接调用 <code>exchange.finishRequest</code> 结束请求，并发送所有缓冲在缓冲区的数据到socket对面。</p>
</li>
<li><p>5.如果响应体此时为空，说明此时头部并没有带上<code>HTTP/1.1 100 Continue</code>，需要对服务器对该请求流整体的响应进行读取。调用的方法是<code>readResponseHeaders</code></p>
</li>
<li><p>6.当拿到了请求体之后之后，就判断请求体的code是否为100.</p>
<ul>
<li>6.1. 如果为100，说明服务器后面还有更多的流需要传输过来，那么还会再调用一次<code>readResponseHeaders</code>方法再次读取服务器传输过来的数据，组成新的Response响应对象</li>
<li>6.2. 如果再读取一次后是101或者本身就是101的响应代码，并且此时是websocket的模式，那么就会设置一个空的响应体在其中返回。不是则通过<code>exchange.openResponseBody(response)</code> 读取response中的数据生成一个真正的从流中获取的响应数据。</li>
</ul>
</li>
<li><p>6.3 如果是204或者205 ，且发现请求体内容是空，则爆异常。没问题则直接返回。</p>
</li>
</ul>
<blockquote>
<p>从RFC协议文档中可以得知，除了101之外的1xx都是代表了服务器发送了第一帧的响应数据，需要继续往后读取才能继续读取完毕。当头部中带了<code>END_STREAM</code>的标志位才代表该传输流结束了。在Okhttp中就是用了RFC协议中的code为100例子作为整个标准。</p>
</blockquote>
<p>整个流程最为核心的方法依次为：</p>
<ul>
<li>1.Exchange.writeRequestHeaders</li>
<li>2.Exchange.readResponseHeaders</li>
<li>3.Exchange.createRequestBody</li>
<li>4.requestBody.writeTo 往responseBody写入数据</li>
<li>5.Exchange.finishRequest</li>
<li>6.Exchange.openResponseBody</li>
</ul>
<p>还记得上一篇文章中聊过的，在ConnectInterceptor拦截器中生成的Exchange对象，并传递到当前的CallServiceInterceptor拦截中。而Exchange包含了一个十分重要的对象ExchangeCodec 。</p>
<p>ExchangeCodec在上一篇文章中有解析，实际上是根据协议类型http 1.0/1.1 以及Http 2.0分别生成了<code>Http1ExchangeCodec</code>或者<code>Http2ExchangeCodec</code>两个对象。</p>
<p>接下来我将分为两个不同协议 对这几个方法进行解析进行解析。</p>
<h2 id="Http-1-0-1-1"><a href="#Http-1-0-1-1" class="headerlink" title="Http 1.0/1.1"></a>Http 1.0/1.1</h2><h3 id="Exchange-writeRequestHeaders-往服务端写入请求"><a href="#Exchange-writeRequestHeaders-往服务端写入请求" class="headerlink" title="Exchange.writeRequestHeaders 往服务端写入请求"></a>Exchange.writeRequestHeaders 往服务端写入请求</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">writeRequestHeaders</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">requestHeadersStart</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span>
      codec<span class="token punctuation">.</span><span class="token function">writeRequestHeaders</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
      eventListener<span class="token punctuation">.</span><span class="token function">requestHeadersEnd</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">requestFailed</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token function">trackFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> e
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是调用了ExchangeCodec 的writeRequestHeaders方法。</p>
<p>此时是Http 1.0/1.1那么将会进入<code>Http1ExchangeCodec</code> 中进行处理。</p>
<h4 id="Http1ExchangeCodec-writeRequestHeaders"><a href="#Http1ExchangeCodec-writeRequestHeaders" class="headerlink" title="Http1ExchangeCodec writeRequestHeaders"></a>Http1ExchangeCodec writeRequestHeaders</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">writeRequestHeaders</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> requestLine <span class="token operator">=</span> RequestLine<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> connection<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>proxy<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">writeRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">,</span> requestLine<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/** Returns bytes of a request header for sending on an HTTP transport. */</span>
  <span class="token keyword">fun</span> <span class="token function">writeRequest</span><span class="token punctuation">(</span>headers<span class="token operator">:</span> Headers<span class="token punctuation">,</span> requestLine<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">check</span><span class="token punctuation">(</span>state <span class="token operator">==</span> STATE_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">"state: <span class="token interpolation variable">$state</span>"</span> <span class="token punctuation">}</span>
    sink<span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span>requestLine<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until headers<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sink<span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span>headers<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span>headers<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sink<span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span>
    state <span class="token operator">=</span> STATE_OPEN_REQUEST_BODY
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token keyword">get</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">,</span> proxyType<span class="token operator">:</span> Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">)</span> <span class="token operator">=</span> buildString <span class="token punctuation">{</span>
    <span class="token function">append</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>method<span class="token punctuation">)</span>
    <span class="token function">append</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">includeAuthorityInRequestLine</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> proxyType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">append</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">append</span><span class="token punctuation">(</span><span class="token function">requestPath</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" HTTP/1.1"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>RequestLine.get</code> 方法实际上就是构造了一个Http请求的请求行。然后在请求行下拼接 头部内容信息</p>
<p>如下图：<br><img src="/images/Http%E8%AF%B7%E6%B1%82%E5%8D%8F%E8%AE%AE%E7%BB%93%E6%9E%84.png" alt="Http请求协议结构.png"></p>
<p>到这里一步还差一个请求体没有设置。如果是<code>GET</code>或者<code>HEAD</code>请求方式，这里已经完成了字符串的拼接可以进行下一步的发送了。</p>
<h4 id="Exchange-readResponseHeaders"><a href="#Exchange-readResponseHeaders" class="headerlink" title="Exchange.readResponseHeaders"></a>Exchange.readResponseHeaders</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">readResponseHeaders</span><span class="token punctuation">(</span>expectContinue<span class="token operator">:</span> Boolean<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token punctuation">.</span>Builder<span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> result <span class="token operator">=</span> codec<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span>expectContinue<span class="token punctuation">)</span>
      result<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">initExchange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> result
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">responseFailed</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token function">trackFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> e
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">private</span> <span class="token keyword">val</span> headersReader <span class="token operator">=</span> <span class="token function">HeadersReader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>

  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">readResponseHeaders</span><span class="token punctuation">(</span>expectContinue<span class="token operator">:</span> Boolean<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token punctuation">.</span>Builder<span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token function">check</span><span class="token punctuation">(</span>state <span class="token operator">==</span> STATE_OPEN_REQUEST_BODY <span class="token operator">||</span> state <span class="token operator">==</span> STATE_READ_RESPONSE_HEADERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">"state: <span class="token interpolation variable">$state</span>"</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> statusLine <span class="token operator">=</span> StatusLine<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>headersReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">val</span> responseBuilder <span class="token operator">=</span> Response<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span>statusLine<span class="token punctuation">.</span>protocol<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span>statusLine<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span>statusLine<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span>headersReader<span class="token punctuation">.</span><span class="token function">readHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> <span class="token keyword">when</span> <span class="token punctuation">{</span>
        expectContinue <span class="token operator">&amp;&amp;</span> statusLine<span class="token punctuation">.</span>code <span class="token operator">==</span> HTTP_CONTINUE <span class="token operator">-></span> <span class="token punctuation">{</span>
          <span class="token keyword">null</span>
        <span class="token punctuation">}</span>
        statusLine<span class="token punctuation">.</span>code <span class="token operator">==</span> HTTP_CONTINUE <span class="token operator">-></span> <span class="token punctuation">{</span>
          state <span class="token operator">=</span> STATE_READ_RESPONSE_HEADERS
          responseBuilder
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
          state <span class="token operator">=</span> STATE_OPEN_RESPONSE_BODY
          responseBuilder
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> EOFException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Provide more context if the server ends the stream before sending a response.</span>
      <span class="token keyword">val</span> address <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">redact</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"unexpected end of stream on <span class="token interpolation variable">$address</span>"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.HeadersReader 包裹了从socket中获取的输出流。首先通过 <code>HeadersReader.readLine</code> 读取状态行。</li>
<li>2.保存状态行中的code，message等信息到Response对象中</li>
<li>3.<code>HeadersReader.readHeaders</code> 读取头部信息</li>
<li>4.如果code是101 则记录当前状态是STATE_READ_RESPONSE_HEADERS，否则就是STATE_OPEN_RESPONSE_BODY。并返回Response.Builder</li>
</ul>
<h3 id="Exchange-createRequestBody"><a href="#Exchange-createRequestBody" class="headerlink" title="Exchange.createRequestBody"></a>Exchange.createRequestBody</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">,</span> duplex<span class="token operator">:</span> Boolean<span class="token punctuation">)</span><span class="token operator">:</span> Sink <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isDuplex <span class="token operator">=</span> duplex
    <span class="token keyword">val</span> contentLength <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    eventListener<span class="token punctuation">.</span><span class="token function">requestBodyStart</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span>
    <span class="token keyword">val</span> rawRequestBody <span class="token operator">=</span> codec<span class="token punctuation">.</span><span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> contentLength<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">RequestBodySink</span><span class="token punctuation">(</span>rawRequestBody<span class="token punctuation">,</span> contentLength<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先获取request中请求体的长度。然后调用Http1ExchangeCodec.createRequestBody</p>
<h4 id="Http1ExchangeCodec-createRequestBody"><a href="#Http1ExchangeCodec-createRequestBody" class="headerlink" title="Http1ExchangeCodec createRequestBody"></a>Http1ExchangeCodec createRequestBody</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">,</span> contentLength<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Sink <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">when</span> <span class="token punctuation">{</span>
      request<span class="token punctuation">.</span>body <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">isDuplex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">throw</span> <span class="token function">ProtocolException</span><span class="token punctuation">(</span>
          <span class="token string">"Duplex connections are not supported for HTTP/1"</span><span class="token punctuation">)</span>
      request<span class="token punctuation">.</span>isChunked <span class="token operator">-></span> <span class="token function">newChunkedSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Stream a request body of unknown length.</span>
      contentLength <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">-></span> <span class="token function">newKnownLengthSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Stream a request body of a known length.</span>
      <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token comment" spellcheck="true">// Stream a request body of a known length.</span>
        <span class="token keyword">throw</span> <span class="token function">IllegalStateException</span><span class="token punctuation">(</span>
            <span class="token string">"Cannot stream a request body without chunked encoding or a known content length!"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">newChunkedSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Sink <span class="token punctuation">{</span>
    <span class="token function">check</span><span class="token punctuation">(</span>state <span class="token operator">==</span> STATE_OPEN_REQUEST_BODY<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">"state: <span class="token interpolation variable">$state</span>"</span> <span class="token punctuation">}</span>
    state <span class="token operator">=</span> STATE_WRITING_REQUEST_BODY
    <span class="token keyword">return</span> <span class="token function">ChunkedSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程就返回了一个ChunkedSink 对象。简单的来看看这个内部类：</p>
<h5 id="ChunkedSink"><a href="#ChunkedSink" class="headerlink" title="ChunkedSink"></a>ChunkedSink</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">private</span> <span class="token keyword">inner</span> <span class="token keyword">class</span> ChunkedSink <span class="token operator">:</span> Sink <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> timeout <span class="token operator">=</span> <span class="token function">ForwardingTimeout</span><span class="token punctuation">(</span>sink<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> closed<span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">false</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Timeout <span class="token operator">=</span> timeout

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">write</span><span class="token punctuation">(</span>source<span class="token operator">:</span> Buffer<span class="token punctuation">,</span> byteCount<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">check</span><span class="token punctuation">(</span><span class="token operator">!</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">"closed"</span> <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>byteCount <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

      sink<span class="token punctuation">.</span><span class="token function">writeHexadecimalUnsignedLong</span><span class="token punctuation">(</span>byteCount<span class="token punctuation">)</span>
      sink<span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span>
      sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span>
      sink<span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Synchronized</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment" spellcheck="true">// Don't throw; this stream might have been closed on the caller's behalf.</span>
      sink<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Synchronized</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">return</span>
      closed <span class="token operator">=</span> <span class="token boolean">true</span>
      sink<span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span><span class="token string">"0\r\n\r\n"</span><span class="token punctuation">)</span>
      <span class="token function">detachTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
      state <span class="token operator">=</span> STATE_READ_RESPONSE_HEADERS
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之后所有对流的操作实际上都会操作到这个对象中，能看到这个对象<code>ChunkedSink</code> 会把数据往内容内写入。写入的格式是<code>\r\n</code> + <code>内容</code> + <code>\r\n</code>。</p>
<p>获取到<code>ChunkedSink</code> 会被<code>RequestBodySink</code> 包裹。</p>
<h5 id="RequestBodySink"><a href="#RequestBodySink" class="headerlink" title="RequestBodySink"></a>RequestBodySink</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">private</span> <span class="token keyword">inner</span> <span class="token keyword">class</span> <span class="token function">RequestBodySink</span><span class="token punctuation">(</span>
    delegate<span class="token operator">:</span> Sink<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">/** The exact number of bytes to be written, or -1L if that is unknown. */</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> contentLength<span class="token operator">:</span> Long
  <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ForwardingSink</span><span class="token punctuation">(</span>delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> completed <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> bytesReceived <span class="token operator">=</span> <span class="token number">0L</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> closed <span class="token operator">=</span> <span class="token boolean">false</span>

    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">write</span><span class="token punctuation">(</span>source<span class="token operator">:</span> Buffer<span class="token punctuation">,</span> byteCount<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">check</span><span class="token punctuation">(</span><span class="token operator">!</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">"closed"</span> <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>contentLength <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&amp;&amp;</span> bytesReceived <span class="token operator">+</span> byteCount <span class="token operator">></span> contentLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">ProtocolException</span><span class="token punctuation">(</span>
            <span class="token string">"expected <span class="token interpolation variable">$contentLength</span> bytes but received <span class="token interpolation"><span class="token delimiter variable">${</span>bytesReceived <span class="token operator">+</span> byteCount<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bytesReceived <span class="token operator">+=</span> byteCount
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">complete</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">complete</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">return</span>
      closed <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>contentLength <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&amp;&amp;</span> bytesReceived <span class="token operator">!=</span> contentLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">ProtocolException</span><span class="token punctuation">(</span><span class="token string">"unexpected end of stream"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">complete</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">complete</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>E <span class="token operator">:</span> IOException<span class="token operator">?</span><span class="token operator">></span> <span class="token function">complete</span><span class="token punctuation">(</span>e<span class="token operator">:</span> E<span class="token punctuation">)</span><span class="token operator">:</span> E <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>completed<span class="token punctuation">)</span> <span class="token keyword">return</span> e
      completed <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">return</span> <span class="token function">bodyComplete</span><span class="token punctuation">(</span>bytesReceived<span class="token punctuation">,</span> responseDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> requestDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> e <span class="token operator">=</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程简单，几乎把所有的事情代理交给ChunkedSink，而自己只是记录了一些关键信息，如接受的字节大小。</p>
<h4 id="ResponseBody-writeTo"><a href="#ResponseBody-writeTo" class="headerlink" title="ResponseBody writeTo"></a>ResponseBody writeTo</h4><p>ResponseBody 其实是一个抽象类，派生很多对象。举两个例子，最常用的表单对象FormBody 以及 混合使用的 MultipartBody，还支持自定义的<code>RequestBody</code>.如果手写过断点下载等功能，必定会对<code>RequestBody</code>进行复写。</p>
<p><img src="/images/RequestBody.png" alt="RequestBody.png"></p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">abstract</span> <span class="token keyword">class</span> RequestBody <span class="token punctuation">{</span>

  <span class="token comment" spellcheck="true">/** Returns the Content-Type header for this body. */</span>
  <span class="token keyword">abstract</span> <span class="token keyword">fun</span> <span class="token function">contentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> MediaType<span class="token operator">?</span>

  <span class="token comment" spellcheck="true">/**
   * Returns the number of bytes that will be written to sink in a call to [writeTo],
   * or -1 if that count is unknown.
   */</span>
  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span>

  <span class="token comment" spellcheck="true">/** Writes the content of this request to [sink]. */</span>
  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">abstract</span> <span class="token keyword">fun</span> <span class="token function">writeTo</span><span class="token punctuation">(</span>sink<span class="token operator">:</span> BufferedSink<span class="token punctuation">)</span>

  <span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">isDuplex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">false</span>


  <span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">isOneShot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.contentType 代表当前请求体<code>Content-Type</code> 的内容：</p>
<p>常见的媒体格式类型如下：</p>
</li>
<li><p>text/html ： HTML格式</p>
</li>
<li><p>text/plain ：纯文本格式      </p>
</li>
<li><p>text/xml ：  XML格式</p>
</li>
<li><p>image/gif ：gif图片格式    </p>
</li>
<li><p>image/jpeg ：jpg图片格式 </p>
</li>
<li><p>image/png：png图片格式</p>
</li>
</ul>
<p>以application开头的媒体格式类型：</p>
<ul>
<li>application/xhtml+xml ：XHTML格式</li>
<li>application/xml     ： XML数据格式</li>
<li>application/atom+xml  ：Atom XML聚合格式    </li>
<li>application/json    ： JSON数据格式</li>
<li>application/pdf       ：pdf格式  </li>
<li>application/msword  ： Word文档格式</li>
<li>application/octet-stream ： 二进制流数据（如常见的文件下载）</li>
<li>application/x-www-form-urlencoded ： <form enctype="””">中默认的encType，form表单数据被编码为key/value格式发送到服务器（表单默认的提交数据的格式）</form></li>
</ul>
<p>另外一种常见的媒体格式是上传文件之时使用的：</p>
<ul>
<li><p>multipart/form-data ： 需要在表单中进行文件上传时，就需要使用该格式</p>
</li>
<li><p>2.<code>contentLength</code> 代表了当前请求体有多长。</p>
</li>
<li><p>3.writeTo 方法是把写入流往请求体中写入的操作。</p>
</li>
<li><p>4.isDuplex 代表当前的请求体中的写入读取全双工流是否可以常驻</p>
</li>
<li><p>5.isOneShot 代表当前请求体是否只能使用一次，如果是遇到408,401,407等情况可以重复请求。此时需要这个标志位判断。</p>
</li>
</ul>
<p>核心还是writeTo方法。</p>
<h4 id="MultipartBody-writeTo"><a href="#MultipartBody-writeTo" class="headerlink" title="MultipartBody writeTo"></a>MultipartBody writeTo</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">private</span> <span class="token keyword">val</span> COLONSPACE <span class="token operator">=</span> <span class="token function">byteArrayOf</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> CRLF <span class="token operator">=</span> <span class="token function">byteArrayOf</span><span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> DASHDASH <span class="token operator">=</span> <span class="token function">byteArrayOf</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">writeTo</span><span class="token punctuation">(</span>sink<span class="token operator">:</span> BufferedSink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">writeOrCountBytes</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">writeOrCountBytes</span><span class="token punctuation">(</span>
    sink<span class="token operator">:</span> BufferedSink<span class="token operator">?</span><span class="token punctuation">,</span>
    countBytes<span class="token operator">:</span> Boolean
  <span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token punctuation">{</span>
    <span class="token keyword">var</span> sink <span class="token operator">=</span> sink
    <span class="token keyword">var</span> byteCount <span class="token operator">=</span> <span class="token number">0L</span>

    <span class="token keyword">var</span> byteCountBuffer<span class="token operator">:</span> Buffer<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>countBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      byteCountBuffer <span class="token operator">=</span> <span class="token function">Buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      sink <span class="token operator">=</span> byteCountBuffer
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token keyword">in</span> <span class="token number">0</span> until parts<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> part <span class="token operator">=</span> parts<span class="token punctuation">[</span>p<span class="token punctuation">]</span>
      <span class="token keyword">val</span> headers <span class="token operator">=</span> part<span class="token punctuation">.</span>headers
      <span class="token keyword">val</span> body <span class="token operator">=</span> part<span class="token punctuation">.</span>body

      sink<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>DASHDASH<span class="token punctuation">)</span>
      sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>boundaryByteString<span class="token punctuation">)</span>
      sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>CRLF<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>headers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>h <span class="token keyword">in</span> <span class="token number">0</span> until headers<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          sink<span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span>headers<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>COLONSPACE<span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span>headers<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>CRLF<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">val</span> contentType <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>contentType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sink<span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span><span class="token string">"Content-Type: "</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span>contentType<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>CRLF<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">val</span> contentLength <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>contentLength <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sink<span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span><span class="token string">"Content-Length: "</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">writeDecimalLong</span><span class="token punctuation">(</span>contentLength<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>CRLF<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>countBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We can't measure the body's size without the sizes of its components.</span>
        byteCountBuffer<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1L</span>
      <span class="token punctuation">}</span>

      sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>CRLF<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>countBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        byteCount <span class="token operator">+=</span> contentLength
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        body<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>sink<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>CRLF<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    sink<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>DASHDASH<span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>boundaryByteString<span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>DASHDASH<span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>CRLF<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>countBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      byteCount <span class="token operator">+=</span> byteCountBuffer<span class="token operator">!!</span><span class="token punctuation">.</span>size
      byteCountBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> byteCount
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>写入内容格式如下：</p>
<p>注意${}这里代表去大括号内的值</p>
<pre><code>\r\n${UUID.randomUUID()}\r\n
${header[0].key}: ${headers[0].value}\r\n
${header[1].key}: ${headers[1].value}\r\n
Content-Type: multipart/form-data; boundary=${UUID.randomUUID()}\r\n
Content-Length: ${contentLength}\r\n
${文件内容}
\r\n
\r\n${UUID.randomUUID()}\r\n</code></pre><p>一般的<code>multipart</code> 除了可以传输键值对之外，还能传输文件。</p>
<p>再来看看一般用于表单提交的FormBody都做了什么？</p>
<h5 id="FormBody-writeTo"><a href="#FormBody-writeTo" class="headerlink" title="FormBody writeTo"></a>FormBody writeTo</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">writeTo</span><span class="token punctuation">(</span>sink<span class="token operator">:</span> BufferedSink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">writeOrCountBytes</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">writeOrCountBytes</span><span class="token punctuation">(</span>sink<span class="token operator">:</span> BufferedSink<span class="token operator">?</span><span class="token punctuation">,</span> countBytes<span class="token operator">:</span> Boolean<span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token punctuation">{</span>
    <span class="token keyword">var</span> byteCount <span class="token operator">=</span> <span class="token number">0L</span>
    <span class="token keyword">val</span> buffer<span class="token operator">:</span> Buffer <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>countBytes<span class="token punctuation">)</span> <span class="token function">Buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> sink<span class="token operator">!!</span><span class="token punctuation">.</span>buffer

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until encodedNames<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> buffer<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      buffer<span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span>encodedNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      buffer<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      buffer<span class="token punctuation">.</span><span class="token function">writeUtf8</span><span class="token punctuation">(</span>encodedValues<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>countBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      byteCount <span class="token operator">=</span> buffer<span class="token punctuation">.</span>size
      buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> byteCount
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>提交表单的请求体格式也很简单：</p>
<pre><code>${encodedNames[0]}=${encodedValues[0]}&amp;${encodedNames[1]}=${encodedValues[1]}</code></pre><p>注意往往这种mediaType格式都是<code>application/x-www-form-urlencoded</code>,一般的，FormBody只能传输简单的键值对不能传输文件。</p>
<h3 id="Exchange-finishRequest"><a href="#Exchange-finishRequest" class="headerlink" title="Exchange.finishRequest"></a>Exchange.finishRequest</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">finishRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      codec<span class="token punctuation">.</span><span class="token function">finishRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">requestFailed</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token function">trackFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> e
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">finishRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sink<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>实际上很简单，就是把写入大缓冲区的内容一口气推倒socket的对端中。</p>
<h3 id="Exchange-openResponseBody"><a href="#Exchange-openResponseBody" class="headerlink" title="Exchange.openResponseBody"></a>Exchange.openResponseBody</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">openResponseBody</span><span class="token punctuation">(</span>response<span class="token operator">:</span> Response<span class="token punctuation">)</span><span class="token operator">:</span> ResponseBody <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> contentType <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> contentLength <span class="token operator">=</span> codec<span class="token punctuation">.</span><span class="token function">reportedContentLength</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
      <span class="token keyword">val</span> rawSource <span class="token operator">=</span> codec<span class="token punctuation">.</span><span class="token function">openResponseBodySource</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
      <span class="token keyword">val</span> source <span class="token operator">=</span> <span class="token function">ResponseBodySource</span><span class="token punctuation">(</span>rawSource<span class="token punctuation">,</span> contentLength<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">RealResponseBody</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> contentLength<span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">responseFailed</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token function">trackFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> e
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.从Response 中读取应答头部的<code>Content-Type</code></li>
<li>2.从Response 中读取应答头部的<code>Content-Length</code></li>
<li>3.openResponseBodySource 生成一个ChunkedSource 对象，这个对象调用read方法读取时候，将会根据流读取socket输入流中的内容，知道长度为消费完毕。</li>
<li>4.生成一个ResponseBodySource 对象，持有ChunkedSource读取流以及contentLength。生成RealResponseBody 对象持有ResponseBodySource对象。返回RealResponseBody。</li>
</ul>
<h2 id="Http-2-0"><a href="#Http-2-0" class="headerlink" title="Http 2.0"></a>Http 2.0</h2><p>那么我们都知道了实际上所有的Exchange对象的操作都会转移到Http1ExchangeCodec中。那么这部分我们只探索Http2ExchangeCodec 中对应相同接口都做了什么？</p>
<h3 id="Http2ExchangeCodec-writeRequestHeaders"><a href="#Http2ExchangeCodec-writeRequestHeaders" class="headerlink" title="Http2ExchangeCodec writeRequestHeaders"></a>Http2ExchangeCodec writeRequestHeaders</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">writeRequestHeaders</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

    <span class="token keyword">val</span> hasRequestBody <span class="token operator">=</span> request<span class="token punctuation">.</span>body <span class="token operator">!=</span> <span class="token keyword">null</span>
    <span class="token keyword">val</span> requestHeaders <span class="token operator">=</span> <span class="token function">http2HeadersList</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    stream <span class="token operator">=</span> http2Connection<span class="token punctuation">.</span><span class="token function">newStream</span><span class="token punctuation">(</span>requestHeaders<span class="token punctuation">,</span> hasRequestBody<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>canceled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      stream<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">closeLater</span><span class="token punctuation">(</span>ErrorCode<span class="token punctuation">.</span>CANCEL<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    stream<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span>readTimeoutMillis<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span>
    stream<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span>writeTimeoutMillis<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这里开始就和http 1.0的做法完全不一样。</p>
<ul>
<li>1.http2HeadersList 从请求对象中获取头部列表</li>
<li>2.http2Connection.newStream 生成全新的Http2Stream</li>
</ul>
<h4 id="Http2ExchangeCodec-http2HeadersList"><a href="#Http2ExchangeCodec-http2HeadersList" class="headerlink" title="Http2ExchangeCodec http2HeadersList"></a>Http2ExchangeCodec http2HeadersList</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">http2HeadersList</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>Header<span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> headers <span class="token operator">=</span> request<span class="token punctuation">.</span>headers
      <span class="token keyword">val</span> result <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>Header<span class="token operator">></span><span class="token punctuation">(</span>headers<span class="token punctuation">.</span>size <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span>
      result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">Header</span><span class="token punctuation">(</span>TARGET_METHOD<span class="token punctuation">,</span> request<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span>
      result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">Header</span><span class="token punctuation">(</span>TARGET_PATH<span class="token punctuation">,</span> RequestLine<span class="token punctuation">.</span><span class="token function">requestPath</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> host <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Host"</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>host <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">Header</span><span class="token punctuation">(</span>TARGET_AUTHORITY<span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Optional.</span>
      <span class="token punctuation">}</span>
      result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">Header</span><span class="token punctuation">(</span>TARGET_SCHEME<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until headers<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// header names must be lowercase.</span>
        <span class="token keyword">val</span> name <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>US<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!</span><span class="token keyword">in</span> HTTP_2_SKIPPED_REQUEST_HEADERS <span class="token operator">||</span>
            name <span class="token operator">==</span> TE <span class="token operator">&amp;&amp;</span> headers<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"trailers"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">Header</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> headers<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> result
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到除了头部的信息之外，还把请求行中所有的信息也保存到Header的集合中。</p>
<h4 id="Http2Connection-newStream"><a href="#Http2Connection-newStream" class="headerlink" title="Http2Connection.newStream"></a>Http2Connection.newStream</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">newStream</span><span class="token punctuation">(</span>
    requestHeaders<span class="token operator">:</span> List<span class="token operator">&lt;</span>Header<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">out</span><span class="token operator">:</span> Boolean
  <span class="token punctuation">)</span><span class="token operator">:</span> Http2Stream <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">newStream</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> requestHeaders<span class="token punctuation">,</span> <span class="token keyword">out</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">newStream</span><span class="token punctuation">(</span>
    associatedStreamId<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    requestHeaders<span class="token operator">:</span> List<span class="token operator">&lt;</span>Header<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">out</span><span class="token operator">:</span> Boolean
  <span class="token punctuation">)</span><span class="token operator">:</span> Http2Stream <span class="token punctuation">{</span>
    <span class="token keyword">val</span> outFinished <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">out</span>
    <span class="token keyword">val</span> inFinished <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">val</span> flushHeaders<span class="token operator">:</span> Boolean
    <span class="token keyword">val</span> stream<span class="token operator">:</span> Http2Stream
    <span class="token keyword">val</span> streamId<span class="token operator">:</span> Int

    <span class="token function">synchronized</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextStreamId <span class="token operator">></span> Int<span class="token punctuation">.</span>MAX_VALUE <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">shutdown</span><span class="token punctuation">(</span>REFUSED_STREAM<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isShutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token function">ConnectionShutdownException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        streamId <span class="token operator">=</span> nextStreamId
        nextStreamId <span class="token operator">+=</span> <span class="token number">2</span>
        stream <span class="token operator">=</span> <span class="token function">Http2Stream</span><span class="token punctuation">(</span>streamId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> outFinished<span class="token punctuation">,</span> inFinished<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        flushHeaders <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">out</span> <span class="token operator">||</span>
            writeBytesTotal <span class="token operator">>=</span> writeBytesMaximum <span class="token operator">||</span>
            stream<span class="token punctuation">.</span>writeBytesTotal <span class="token operator">>=</span> stream<span class="token punctuation">.</span>writeBytesMaximum
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stream<span class="token punctuation">.</span>isOpen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          streams<span class="token punctuation">[</span>streamId<span class="token punctuation">]</span> <span class="token operator">=</span> stream
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>associatedStreamId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writer<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span>outFinished<span class="token punctuation">,</span> streamId<span class="token punctuation">,</span> requestHeaders<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

        writer<span class="token punctuation">.</span><span class="token function">pushPromise</span><span class="token punctuation">(</span>associatedStreamId<span class="token punctuation">,</span> streamId<span class="token punctuation">,</span> requestHeaders<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flushHeaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> stream
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.如果累计控制的streamId 位数大于 Int.MAX_VALUE的一半，则调用shutdown 关闭上一次读取过头部信息的流</li>
<li><ol start="2">
<li>stream的id分配，其实是不断的加2为下一个新的stramID，并赋值给Http2Stream。Http2Stream保存到streams集合中</li>
</ol>
</li>
<li>3.此时传入的<code>associatedStreamId</code>为0，那么就会调用Http2writer的headers方法写入头部。</li>
</ul>
<h5 id="Http2writer的headers"><a href="#Http2writer的headers" class="headerlink" title="Http2writer的headers"></a>Http2writer的headers</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">
  <span class="token keyword">private</span> <span class="token keyword">val</span> hpackBuffer<span class="token operator">:</span> Buffer <span class="token operator">=</span> <span class="token function">Buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">val</span> hpackWriter<span class="token operator">:</span> Hpack<span class="token punctuation">.</span>Writer <span class="token operator">=</span> Hpack<span class="token punctuation">.</span><span class="token function">Writer</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token operator">=</span> hpackBuffer<span class="token punctuation">)</span>

  <span class="token annotation builtin">@Synchronized</span> <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">headers</span><span class="token punctuation">(</span>
    outFinished<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    streamId<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    headerBlock<span class="token operator">:</span> List<span class="token operator">&lt;</span>Header<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"closed"</span><span class="token punctuation">)</span>
    hpackWriter<span class="token punctuation">.</span><span class="token function">writeHeaders</span><span class="token punctuation">(</span>headerBlock<span class="token punctuation">)</span>

    <span class="token keyword">val</span> byteCount <span class="token operator">=</span> hpackBuffer<span class="token punctuation">.</span>size
    <span class="token keyword">val</span> length <span class="token operator">=</span> <span class="token function">minOf</span><span class="token punctuation">(</span>maxFrameSize<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span>
    <span class="token keyword">var</span> flags <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>byteCount <span class="token operator">==</span> length<span class="token punctuation">)</span> FLAG_END_HEADERS <span class="token keyword">else</span> <span class="token number">0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outFinished<span class="token punctuation">)</span> flags <span class="token operator">=</span> flags <span class="token operator">or</span> FLAG_END_STREAM
    <span class="token function">frameHeader</span><span class="token punctuation">(</span>
        streamId <span class="token operator">=</span> streamId<span class="token punctuation">,</span>
        length <span class="token operator">=</span> length<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        type <span class="token operator">=</span> TYPE_HEADERS<span class="token punctuation">,</span>
        flags <span class="token operator">=</span> flags
    <span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>hpackBuffer<span class="token punctuation">,</span> length<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>byteCount <span class="token operator">></span> length<span class="token punctuation">)</span> <span class="token function">writeContinuationFrames</span><span class="token punctuation">(</span>streamId<span class="token punctuation">,</span> byteCount <span class="token operator">-</span> length<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.hpackWriter把所有的头部信息写入到hpackBuffer 一个临时缓冲区中</p>
</li>
<li><p>2.frameHeader 构造头部信息写入socket的缓冲区只能够，接着把hpackBuffer中的数据接在后面写入。 这个过程中如果传输的大小刚好在最大数据帧大小内，flag设置为FLAG_END_HEADERS，否则就是0. 如果outFinished也就是从外部传递进来的标志位是true，说明客户端已经不需要往这个流传输了，那么flag就是FLAG_END_STREAM。</p>
</li>
<li><p>3.如果本次传输缓冲区的大小比最大帧数还大，那么说明还有没有传输完就调用了writeContinuationFrames方法。</p>
</li>
</ul>
<h5 id="Hpack-Writer-writeHeaders"><a href="#Hpack-Writer-writeHeaders" class="headerlink" title="Hpack.Writer writeHeaders"></a>Hpack.Writer writeHeaders</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">writeHeaders</span><span class="token punctuation">(</span>headerBlock<span class="token operator">:</span> List<span class="token operator">&lt;</span>Header<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until headerBlock<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> header <span class="token operator">=</span> headerBlock<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">val</span> name <span class="token operator">=</span> header<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">toAsciiLowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> value <span class="token operator">=</span> header<span class="token punctuation">.</span>value
        <span class="token keyword">var</span> headerIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token keyword">var</span> headerNameIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

        <span class="token keyword">val</span> staticIndex <span class="token operator">=</span> NAME_TO_FIRST_INDEX<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>staticIndex <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          headerNameIndex <span class="token operator">=</span> staticIndex <span class="token operator">+</span> <span class="token number">1</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>headerNameIndex <span class="token keyword">in</span> <span class="token number">2</span><span class="token operator">..</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>STATIC_HEADER_TABLE<span class="token punctuation">[</span>headerNameIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              headerIndex <span class="token operator">=</span> headerNameIndex
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>STATIC_HEADER_TABLE<span class="token punctuation">[</span>headerNameIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              headerIndex <span class="token operator">=</span> headerNameIndex <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>headerIndex <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token keyword">in</span> nextHeaderIndex <span class="token operator">+</span> <span class="token number">1</span> until dynamicTable<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamicTable<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">!!</span><span class="token punctuation">.</span>name <span class="token operator">==</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamicTable<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">!!</span><span class="token punctuation">.</span>value <span class="token operator">==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                headerIndex <span class="token operator">=</span> j <span class="token operator">-</span> nextHeaderIndex <span class="token operator">+</span> STATIC_HEADER_TABLE<span class="token punctuation">.</span>size
                <span class="token keyword">break</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>headerNameIndex <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                headerNameIndex <span class="token operator">=</span> j <span class="token operator">-</span> nextHeaderIndex <span class="token operator">+</span> STATIC_HEADER_TABLE<span class="token punctuation">.</span>size
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">when</span> <span class="token punctuation">{</span>
          headerIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Indexed Header Field.</span>
            <span class="token function">writeInt</span><span class="token punctuation">(</span>headerIndex<span class="token punctuation">,</span> PREFIX_7_BITS<span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          headerNameIndex <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Literal Header Field with Incremental Indexing - New Name.</span>
            <span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>
            <span class="token function">writeByteString</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
            <span class="token function">writeByteString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token function">insertIntoDynamicTable</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>Header<span class="token punctuation">.</span>PSEUDO_PREFIX<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> TARGET_AUTHORITY <span class="token operator">!=</span> name <span class="token operator">-></span> <span class="token punctuation">{</span>

            <span class="token function">writeInt</span><span class="token punctuation">(</span>headerNameIndex<span class="token punctuation">,</span> PREFIX_4_BITS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">writeByteString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Literal Header Field with Incremental Indexing - Indexed Name.</span>
            <span class="token function">writeInt</span><span class="token punctuation">(</span>headerNameIndex<span class="token punctuation">,</span> PREFIX_6_BITS<span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span>
            <span class="token function">writeByteString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token function">insertIntoDynamicTable</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程，Hpack.Writer中会持有一个很长的写死的允许解析的列表集合。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin"> <span class="token keyword">val</span> STATIC_HEADER_TABLE <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>TARGET_AUTHORITY<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>TARGET_METHOD<span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>TARGET_METHOD<span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>TARGET_PATH<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>TARGET_PATH<span class="token punctuation">,</span> <span class="token string">"/index.html"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>TARGET_SCHEME<span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>TARGET_SCHEME<span class="token punctuation">,</span> <span class="token string">"https"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>RESPONSE_STATUS<span class="token punctuation">,</span> <span class="token string">"200"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>RESPONSE_STATUS<span class="token punctuation">,</span> <span class="token string">"204"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>RESPONSE_STATUS<span class="token punctuation">,</span> <span class="token string">"206"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>RESPONSE_STATUS<span class="token punctuation">,</span> <span class="token string">"304"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>RESPONSE_STATUS<span class="token punctuation">,</span> <span class="token string">"400"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>RESPONSE_STATUS<span class="token punctuation">,</span> <span class="token string">"404"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span>RESPONSE_STATUS<span class="token punctuation">,</span> <span class="token string">"500"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"accept-charset"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"accept-encoding"</span><span class="token punctuation">,</span> <span class="token string">"gzip, deflate"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"accept-language"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"accept-ranges"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"access-control-allow-origin"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"allow"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"authorization"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"cache-control"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"content-disposition"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"content-encoding"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"content-language"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"content-length"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"content-location"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"content-range"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"content-type"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"cookie"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"etag"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"expect"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"expires"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"from"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"if-match"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"if-modified-since"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"if-none-match"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"if-range"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"if-unmodified-since"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"last-modified"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"link"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"location"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"max-forwards"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"proxy-authenticate"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"proxy-authorization"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"range"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"referer"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"refresh"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"retry-after"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"server"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"set-cookie"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"strict-transport-security"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"transfer-encoding"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"user-agent"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"vary"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"via"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"www-authenticate"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 通过列表就能知道头部中是否有符合规格的头部信息。</p>
<ul>
<li><p>1.如果不存在在这个STATIC_HEADER_TABLE全局列表中，且不再动态列表dynamicTable中，那么headerIndex为-1.此时会添加0x04,并写入对应的header的name和value。注意如果<code>writeByteString</code>使用了压缩模式，就会使用huffman算法进行压缩。最后把这个新的Header的key添加到STATIC_HEADER_TABLE</p>
</li>
<li><p>2.如果headerIndex 不为-1，那么说明从STATIC_HEADER_TABLE 或者dynamicTable 找到，那么则写入headerIndex 并且只获取8位.从协议看来服务端也有一套一样的表，可以根据index找到对应Header是什么。接下来只写入headerIndex</p>
</li>
<li><p>3.如果是<code>:</code>开头的key，但是不是<code>:authority</code>,写入对应新的解析index，以及value。</p>
</li>
<li><p>4.其他情况就是记录，依次写入headerNameIndex，value，最后添加到动态列表dynamicTable。</p>
</li>
</ul>
<p>总结一句话，所有的Header的key都被哈夫曼算法进行压缩，并保存起来。除非出现第一次或者改变等情况，才会传递对应新的value数值。</p>
<p>总结到图中就是如下：</p>
<p><img src="/images/Http2%E4%BC%A0%E9%80%81%E5%8E%8B%E7%BC%A9%E5%A4%B4%E9%83%A8.png" alt="Http2传送压缩头部.png"></p>
<h5 id="writeContinuationFrames"><a href="#writeContinuationFrames" class="headerlink" title="writeContinuationFrames"></a>writeContinuationFrames</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">writeContinuationFrames</span><span class="token punctuation">(</span>streamId<span class="token operator">:</span> Int<span class="token punctuation">,</span> byteCount<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> byteCount <span class="token operator">=</span> byteCount
    <span class="token keyword">while</span> <span class="token punctuation">(</span>byteCount <span class="token operator">></span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> length <span class="token operator">=</span> <span class="token function">minOf</span><span class="token punctuation">(</span>maxFrameSize<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span>
      byteCount <span class="token operator">-=</span> length
      <span class="token function">frameHeader</span><span class="token punctuation">(</span>
          streamId <span class="token operator">=</span> streamId<span class="token punctuation">,</span>
          length <span class="token operator">=</span> length<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          type <span class="token operator">=</span> TYPE_CONTINUATION<span class="token punctuation">,</span>
          flags <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>byteCount <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> FLAG_END_HEADERS <span class="token keyword">else</span> <span class="token number">0</span>
      <span class="token punctuation">)</span>
      sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>hpackBuffer<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/Http2%E4%BC%A0%E8%BE%93%E7%BB%AD%E4%BC%A0%E5%A4%B4%E9%83%A8%E4%BF%A1%E6%81%AF.png" alt="Http2传输续传头部信息.png"></p>
<h3 id="Http2ExchangeCodec-readResponseHeaders"><a href="#Http2ExchangeCodec-readResponseHeaders" class="headerlink" title="Http2ExchangeCodec.readResponseHeaders"></a>Http2ExchangeCodec.readResponseHeaders</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">readResponseHeaders</span><span class="token punctuation">(</span>expectContinue<span class="token operator">:</span> Boolean<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token punctuation">.</span>Builder<span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> headers <span class="token operator">=</span> stream<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">takeHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> responseBuilder <span class="token operator">=</span> <span class="token function">readHttp2HeadersList</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expectContinue <span class="token operator">&amp;&amp;</span> responseBuilder<span class="token punctuation">.</span>code <span class="token operator">==</span> HTTP_CONTINUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">null</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      responseBuilder
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心是<code>stream!!.takeHeaders</code> 读取从流中读取的头部信息缓存队列中；readHttp2HeadersList 读取响应头的内容。</p>
<h5 id="takeHeaders"><a href="#takeHeaders" class="headerlink" title="takeHeaders"></a>takeHeaders</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">takeHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Headers <span class="token punctuation">{</span>
    readTimeout<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>headersQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> errorCode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">waitForIo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      readTimeout<span class="token punctuation">.</span><span class="token function">exitAndThrowIfTimedOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>headersQueue<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> headersQueue<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> errorException <span class="token operator">?:</span> <span class="token function">StreamResetException</span><span class="token punctuation">(</span>errorCode<span class="token operator">!!</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程实际上就是一个消费者生产者模式。如果<code>headersQueue</code> 为空，则会阻塞等待<code>headersQueue</code> 中存入从流中读取到的头部结果。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">readHttp2HeadersList</span><span class="token punctuation">(</span>headerBlock<span class="token operator">:</span> Headers<span class="token punctuation">,</span> protocol<span class="token operator">:</span> Protocol<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token punctuation">.</span><span class="token function">Builder</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> statusLine<span class="token operator">:</span> StatusLine<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">val</span> headersBuilder <span class="token operator">=</span> Headers<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until headerBlock<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> name <span class="token operator">=</span> headerBlock<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">val</span> value <span class="token operator">=</span> headerBlock<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> RESPONSE_STATUS_UTF8<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          statusLine <span class="token operator">=</span> StatusLine<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"HTTP/1.1 <span class="token interpolation variable">$value</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!</span><span class="token keyword">in</span> HTTP_2_SKIPPED_RESPONSE_HEADERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          headersBuilder<span class="token punctuation">.</span><span class="token function">addLenient</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>statusLine <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">ProtocolException</span><span class="token punctuation">(</span><span class="token string">"Expected ':status' header not present"</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span>statusLine<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span>statusLine<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span>headersBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>takeHeaders 读取从Headers 对象后，把状态行，头部，信息存储到Response。结构如下图：<br><img src="/images/Http%E5%93%8D%E5%BA%94%E5%8D%8F%E8%AE%AE%E7%BB%93%E6%9E%84.png" alt="Http响应协议结构.png"></p>
<p>那么哪里进行读取呢？</p>
<h5 id="读取从服务端传递的数据"><a href="#读取从服务端传递的数据" class="headerlink" title="读取从服务端传递的数据"></a>读取从服务端传递的数据</h5><p>在<a href="https://www.jianshu.com/p/639eaac1b5eb" target="_blank" rel="noopener">OkHttp源码解析(三)</a>  中提到过，在执行到CallServerInterceptor 之前，在Http2.0协议中会通过Http2Reader 进行读取从服务端发送过来的数据。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> connectionErrorCode <span class="token operator">=</span> ErrorCode<span class="token punctuation">.</span>INTERNAL_ERROR
      <span class="token keyword">var</span> streamErrorCode <span class="token operator">=</span> ErrorCode<span class="token punctuation">.</span>INTERNAL_ERROR
      <span class="token keyword">var</span> errorException<span class="token operator">:</span> IOException<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        reader<span class="token punctuation">.</span><span class="token function">readConnectionPreface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">nextFrame</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        connectionErrorCode <span class="token operator">=</span> ErrorCode<span class="token punctuation">.</span>NO_ERROR
        streamErrorCode <span class="token operator">=</span> ErrorCode<span class="token punctuation">.</span>CANCEL
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">close</span><span class="token punctuation">(</span>connectionErrorCode<span class="token punctuation">,</span> streamErrorCode<span class="token punctuation">,</span> errorException<span class="token punctuation">)</span>
        reader<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当通过readConnectionPreface 读取完序言之后，就会不断的循环通过<code>nextFrame</code>读取服务端的内容。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">when</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      TYPE_DATA <span class="token operator">-></span> <span class="token function">readData</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_HEADERS <span class="token operator">-></span> <span class="token function">readHeaders</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_PRIORITY <span class="token operator">-></span> <span class="token function">readPriority</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_RST_STREAM <span class="token operator">-></span> <span class="token function">readRstStream</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_SETTINGS <span class="token operator">-></span> <span class="token function">readSettings</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_PUSH_PROMISE <span class="token operator">-></span> <span class="token function">readPushPromise</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_PING <span class="token operator">-></span> <span class="token function">readPing</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_GOAWAY <span class="token operator">-></span> <span class="token function">readGoAway</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_WINDOW_UPDATE <span class="token operator">-></span> <span class="token function">readWindowUpdate</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      <span class="token keyword">else</span> <span class="token operator">-></span> source<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>length<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Implementations MUST discard frames of unknown types.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>读取头部的核心就是readHeaders。</p>
<h5 id="readHeaders-读取头部信息"><a href="#readHeaders-读取头部信息" class="headerlink" title="readHeaders 读取头部信息"></a>readHeaders 读取头部信息</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">readHeaders</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> Handler<span class="token punctuation">,</span> length<span class="token operator">:</span> Int<span class="token punctuation">,</span> flags<span class="token operator">:</span> Int<span class="token punctuation">,</span> streamId<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>streamId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"PROTOCOL_ERROR: TYPE_HEADERS streamId == 0"</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> endStream <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">and</span> FLAG_END_STREAM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
    <span class="token keyword">val</span> padding <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">and</span> FLAG_PADDED <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> source<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token number">0xff</span> <span class="token keyword">else</span> <span class="token number">0</span>

    <span class="token keyword">var</span> headerBlockLength <span class="token operator">=</span> length
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">and</span> FLAG_PRIORITY <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">readPriority</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      headerBlockLength <span class="token operator">-=</span> <span class="token number">5</span> <span class="token comment" spellcheck="true">// account for above read.</span>
    <span class="token punctuation">}</span>
    headerBlockLength <span class="token operator">=</span> <span class="token function">lengthWithoutPadding</span><span class="token punctuation">(</span>headerBlockLength<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> padding<span class="token punctuation">)</span>
    <span class="token keyword">val</span> headerBlock <span class="token operator">=</span> <span class="token function">readHeaderBlock</span><span class="token punctuation">(</span>headerBlockLength<span class="token punctuation">,</span> padding<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>

    handler<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span>endStream<span class="token punctuation">,</span> streamId<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> headerBlock<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.lengthWithoutPadding 读取当前传递过来压缩的头部信息长度。</li>
<li>2.readHeaderBlock 解析数据帧的内容区域，根据前面的标志位，从而获取更新的头部信息，并且生成Header集合的</li>
<li>3.然后调用<code>handler.headers</code> 方法。这里handler 对象就是Http2Connection</li>
</ul>
<h5 id="Http2Connection-headers"><a href="#Http2Connection-headers" class="headerlink" title="Http2Connection headers"></a>Http2Connection headers</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">headers</span><span class="token punctuation">(</span>
      inFinished<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
      streamId<span class="token operator">:</span> Int<span class="token punctuation">,</span>
      associatedStreamId<span class="token operator">:</span> Int<span class="token punctuation">,</span>
      headerBlock<span class="token operator">:</span> List<span class="token operator">&lt;</span>Header<span class="token operator">></span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pushedStream</span><span class="token punctuation">(</span>streamId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pushHeadersLater</span><span class="token punctuation">(</span>streamId<span class="token punctuation">,</span> headerBlock<span class="token punctuation">,</span> inFinished<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">val</span> stream<span class="token operator">:</span> Http2Stream<span class="token operator">?</span>
      <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@Http2Connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stream <span class="token operator">=</span> <span class="token function">getStream</span><span class="token punctuation">(</span>streamId<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>stream <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// If we're shutdown, don't bother with this stream.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>isShutdown<span class="token punctuation">)</span> <span class="token keyword">return</span>

          <span class="token comment" spellcheck="true">// If the stream ID is less than the last created ID, assume it's already closed.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>streamId <span class="token operator">&lt;=</span> lastGoodStreamId<span class="token punctuation">)</span> <span class="token keyword">return</span>

          <span class="token comment" spellcheck="true">// If the stream ID is in the client's namespace, assume it's already closed.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>streamId <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> nextStreamId <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

          <span class="token comment" spellcheck="true">// Create a stream.</span>
          <span class="token keyword">val</span> headers <span class="token operator">=</span> headerBlock<span class="token punctuation">.</span><span class="token function">toHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">val</span> newStream <span class="token operator">=</span> <span class="token function">Http2Stream</span><span class="token punctuation">(</span>streamId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token label symbol">@Http2Connection</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> inFinished<span class="token punctuation">,</span> headers<span class="token punctuation">)</span>
          lastGoodStreamId <span class="token operator">=</span> streamId
          streams<span class="token punctuation">[</span>streamId<span class="token punctuation">]</span> <span class="token operator">=</span> newStream

          <span class="token comment" spellcheck="true">// Use a different task queue for each stream because they should be handled in parallel.</span>
          taskRunner<span class="token punctuation">.</span><span class="token function">newQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation variable">$connectionName</span>[<span class="token interpolation variable">$streamId</span>] onStream"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              listener<span class="token punctuation">.</span><span class="token function">onStream</span><span class="token punctuation">(</span>newStream<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Http2Connection.Listener failure for <span class="token interpolation variable">$connectionName</span>"</span><span class="token punctuation">,</span> INFO<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
              ignoreIoExceptions <span class="token punctuation">{</span>
                newStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>ErrorCode<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// Update an existing stream.</span>
      stream<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">receiveHeaders</span><span class="token punctuation">(</span>headerBlock<span class="token punctuation">.</span><span class="token function">toHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inFinished<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.如果不存在streamID 对应的 Http2Stream对象就会创造出来</li>
<li>2.调用Http2Stream的receiveHeaders</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">receiveHeaders</span><span class="token punctuation">(</span>headers<span class="token operator">:</span> Headers<span class="token punctuation">,</span> inFinished<span class="token operator">:</span> Boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">.</span><span class="token function">assertThreadDoesntHoldLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> <span class="token keyword">open</span><span class="token operator">:</span> Boolean
    <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasResponseHeaders <span class="token operator">||</span> <span class="token operator">!</span>inFinished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasResponseHeaders <span class="token operator">=</span> <span class="token boolean">true</span>
        headersQueue <span class="token operator">+=</span> headers
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span>trailers <span class="token operator">=</span> headers
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>inFinished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span>finished <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">open</span> <span class="token operator">=</span> isOpen
      <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">open</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      connection<span class="token punctuation">.</span><span class="token function">removeStream</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时就是把Headers对象设置到headersQueue中，并且调用notifyAll 唤醒在CallServerInterceptor的阻塞。</p>
<p>时刻记住，这些过程很可能是出现多个线程共用同一个流，同一个Http2Connection同时进行读取写入。那么成消费者生产者模式就十分合理了。</p>
<h3 id="Http2ExchangeCodec-createRequestBody"><a href="#Http2ExchangeCodec-createRequestBody" class="headerlink" title="Http2ExchangeCodec createRequestBody"></a>Http2ExchangeCodec createRequestBody</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">,</span> contentLength<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Sink <span class="token punctuation">{</span>
    <span class="token keyword">return</span> stream<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">getSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>很简单就是拿到Http2Stream的Sink对象，这个对象是一个<code>FramingSink</code> 。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">internal</span> <span class="token keyword">val</span> sink <span class="token operator">=</span> <span class="token function">FramingSink</span><span class="token punctuation">(</span>
      finished <span class="token operator">=</span> outFinished
  <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>那么接下来所有的对这个写入流操作就是操作这个对象。最后会被RequestBodySink包裹起来。</p>
<h3 id="FramingSink-writeTo"><a href="#FramingSink-writeTo" class="headerlink" title="FramingSink writeTo"></a>FramingSink writeTo</h3><p>当我们需要写入一个新的请求体到服务端，就会调用这个类的write方法。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
    <span class="token keyword">internal</span> <span class="token keyword">const</span> <span class="token keyword">val</span> EMIT_BUFFER_SIZE <span class="token operator">=</span> <span class="token number">16384L</span> （16kb）
  <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">write</span><span class="token punctuation">(</span>source<span class="token operator">:</span> Buffer<span class="token punctuation">,</span> byteCount<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">.</span><span class="token function">assertThreadDoesntHoldLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      sendBuffer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>sendBuffer<span class="token punctuation">.</span>size <span class="token operator">>=</span> EMIT_BUFFER_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">emitFrame</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就是往一个临时的缓冲区写入数据。如果当前的数据大于16kb大小，那么就会调用emitFrame。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">emitFrame</span><span class="token punctuation">(</span>outFinishedOnLastFrame<span class="token operator">:</span> Boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> toWrite<span class="token operator">:</span> Long
      <span class="token keyword">val</span> outFinished<span class="token operator">:</span> Boolean
      <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writeTimeout<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>writeBytesTotal <span class="token operator">>=</span> writeBytesMaximum <span class="token operator">&amp;&amp;</span>
              <span class="token operator">!</span>finished <span class="token operator">&amp;&amp;</span>
              <span class="token operator">!</span>closed <span class="token operator">&amp;&amp;</span>
              errorCode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">waitForIo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Wait until we receive a WINDOW_UPDATE for this stream.</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          writeTimeout<span class="token punctuation">.</span><span class="token function">exitAndThrowIfTimedOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token function">checkOutNotClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Kick out if the stream was reset or closed while waiting.</span>
        toWrite <span class="token operator">=</span> <span class="token function">minOf</span><span class="token punctuation">(</span>writeBytesMaximum <span class="token operator">-</span> writeBytesTotal<span class="token punctuation">,</span> sendBuffer<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
        writeBytesTotal <span class="token operator">+=</span> toWrite
        outFinished <span class="token operator">=</span> outFinishedOnLastFrame <span class="token operator">&amp;&amp;</span> toWrite <span class="token operator">==</span> sendBuffer<span class="token punctuation">.</span>size <span class="token operator">&amp;&amp;</span> errorCode <span class="token operator">==</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>

      writeTimeout<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span><span class="token function">writeData</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> outFinished<span class="token punctuation">,</span> sendBuffer<span class="token punctuation">,</span> toWrite<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        writeTimeout<span class="token punctuation">.</span><span class="token function">exitAndThrowIfTimedOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果在这个临时写入缓冲区中，已经大于<code>writeBytesMaximum</code> 写入最大的数据荷载极限，那么就会阻塞该写入流程。直到小于<code>writeBytesMaximum</code>大小。这个<code>writeBytesMaximum</code>数值是决定与上一篇文章聊到过的<code>65535</code>的初始化流窗体大小，通过<code>Http2Stream.addBytesToWriteWindow</code>在<code>65535</code>基础上进行调整。</p>
</li>
<li><p>2.接着调用<code>connection.writeData</code> 还是往socket写入数据。</p>
</li>
</ul>
<h4 id="Http2Connection往socket中写入数据"><a href="#Http2Connection往socket中写入数据" class="headerlink" title="Http2Connection往socket中写入数据"></a>Http2Connection往socket中写入数据</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">writeData</span><span class="token punctuation">(</span>
    streamId<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    outFinished<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    buffer<span class="token operator">:</span> Buffer<span class="token operator">?</span><span class="token punctuation">,</span>
    byteCount<span class="token operator">:</span> Long
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Empty data frames are not flow-controlled.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>byteCount <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      writer<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>outFinished<span class="token punctuation">,</span> streamId<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> byteCount <span class="token operator">=</span> byteCount
    <span class="token keyword">while</span> <span class="token punctuation">(</span>byteCount <span class="token operator">></span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> toWrite<span class="token operator">:</span> Int
      <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@Http2Connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>writeBytesTotal <span class="token operator">>=</span> writeBytesMaximum<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>streams<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>streamId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"stream closed"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token label symbol">@Http2Connection</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Wait until we receive a WINDOW_UPDATE.</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> InterruptedException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Retain interrupted status.</span>
          <span class="token keyword">throw</span> <span class="token function">InterruptedIOException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        toWrite <span class="token operator">=</span> <span class="token function">minOf</span><span class="token punctuation">(</span>byteCount<span class="token punctuation">,</span> writeBytesMaximum <span class="token operator">-</span> writeBytesTotal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        toWrite <span class="token operator">=</span> <span class="token function">minOf</span><span class="token punctuation">(</span>toWrite<span class="token punctuation">,</span> writer<span class="token punctuation">.</span><span class="token function">maxDataLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        writeBytesTotal <span class="token operator">+=</span> toWrite<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      byteCount <span class="token operator">-=</span> toWrite<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      writer<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>outFinished <span class="token operator">&amp;&amp;</span> byteCount <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">,</span> streamId<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> toWrite<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.校验了Http2Connection写入的总数据。注意<code>writeBytesMaximum</code> 也是在<code>Http2Stream.addBytesToWriteWindow</code> 调用时刻进行更新。如果大于这个书就会进行阻塞。</li>
<li>2.调用Http2Writer.data 写入数据。</li>
</ul>
<h6 id="Http2Writer-data"><a href="#Http2Writer-data" class="headerlink" title="Http2Writer.data"></a>Http2Writer.data</h6><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Synchronized</span> <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token keyword">data</span><span class="token punctuation">(</span>outFinished<span class="token operator">:</span> Boolean<span class="token punctuation">,</span> streamId<span class="token operator">:</span> Int<span class="token punctuation">,</span> source<span class="token operator">:</span> Buffer<span class="token operator">?</span><span class="token punctuation">,</span> byteCount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"closed"</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> flags <span class="token operator">=</span> FLAG_NONE
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outFinished<span class="token punctuation">)</span> flags <span class="token operator">=</span> flags <span class="token operator">or</span> FLAG_END_STREAM
    <span class="token function">dataFrame</span><span class="token punctuation">(</span>streamId<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> source<span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">dataFrame</span><span class="token punctuation">(</span>streamId<span class="token operator">:</span> Int<span class="token punctuation">,</span> flags<span class="token operator">:</span> Int<span class="token punctuation">,</span> buffer<span class="token operator">:</span> Buffer<span class="token operator">?</span><span class="token punctuation">,</span> byteCount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">frameHeader</span><span class="token punctuation">(</span>
        streamId <span class="token operator">=</span> streamId<span class="token punctuation">,</span>
        length <span class="token operator">=</span> byteCount<span class="token punctuation">,</span>
        type <span class="token operator">=</span> TYPE_DATA<span class="token punctuation">,</span>
        flags <span class="token operator">=</span> flags
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>byteCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token operator">!!</span><span class="token punctuation">,</span> byteCount<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意，这里会判断此时的流是否写入完毕，如果写入完毕则设置为FLAG_END_STREAM否则是FLAG_NONE。只有把流关闭的时候才是FLAG_END_STREAM。</p>
<p>此时就会写入如下数据格式:</p>
<p><img src="/images/Http2%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%B8%A7.png" alt="Http2数据类型数据帧.png"></p>
<h3 id="Http2ExchangeCodec-finishRequest"><a href="#Http2ExchangeCodec-finishRequest" class="headerlink" title="Http2ExchangeCodec finishRequest"></a>Http2ExchangeCodec finishRequest</h3><p>如果此时不需要传输请求体，就会调用finishRequest 关闭当前的Http2ExchangeCodec中对应的写入流。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">finishRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stream<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">getSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这个写入流就是<code>FramingSink</code></p>
<h4 id="FramingSink-close"><a href="#FramingSink-close" class="headerlink" title="FramingSink close"></a>FramingSink close</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">.</span><span class="token function">assertThreadDoesntHoldLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">val</span> outFinished<span class="token operator">:</span> Boolean
      <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">return</span>
        outFinished <span class="token operator">=</span> errorCode <span class="token operator">==</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sink<span class="token punctuation">.</span>finished<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">val</span> hasData <span class="token operator">=</span> sendBuffer<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0L</span>
        <span class="token keyword">val</span> hasTrailers <span class="token operator">=</span> trailers <span class="token operator">!=</span> <span class="token keyword">null</span>
        <span class="token keyword">when</span> <span class="token punctuation">{</span>
          hasTrailers <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>sendBuffer<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">emitFrame</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            connection<span class="token punctuation">.</span><span class="token function">writeHeaders</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> outFinished<span class="token punctuation">,</span> trailers<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">toHeaderList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>

          hasData <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>sendBuffer<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">emitFrame</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          outFinished <span class="token operator">-></span> <span class="token punctuation">{</span>
            connection<span class="token punctuation">.</span><span class="token function">writeData</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        closed <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      connection<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">cancelStreamIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>做的事情很简单，如果当前的写入流已经关闭了，则直接返回。没有关闭，就会把存在该缓冲区的数据全部往对端写入，并带上结束的标志位。</p>
<h3 id="Http2ExchangeCodec-openResponseBody"><a href="#Http2ExchangeCodec-openResponseBody" class="headerlink" title="Http2ExchangeCodec openResponseBody"></a>Http2ExchangeCodec openResponseBody</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">internal</span> <span class="token keyword">val</span> source <span class="token operator">=</span> <span class="token function">FramingSource</span><span class="token punctuation">(</span>
      maxByteCount <span class="token operator">=</span> connection<span class="token punctuation">.</span>okHttpSettings<span class="token punctuation">.</span>initialWindowSize<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      finished <span class="token operator">=</span> inFinished
  <span class="token punctuation">)</span>

  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">openResponseBodySource</span><span class="token punctuation">(</span>response<span class="token operator">:</span> Response<span class="token punctuation">)</span><span class="token operator">:</span> Source <span class="token punctuation">{</span>
    <span class="token keyword">return</span> stream<span class="token operator">!!</span><span class="token punctuation">.</span>source
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，实际上就是返回了一个FramingSource 对象被ResponseBodySource持有到顶层。让用户对响应体进行读取。</p>
<p>一般的当我们想要读取响应体的内容，可以直接通过ResponseBody.toString来完成,来看看这个过程都做了什么？</p>
<h3 id="ResponseBody-toString"><a href="#ResponseBody-toString" class="headerlink" title="ResponseBody.toString"></a>ResponseBody.toString</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{</span> source <span class="token operator">-></span>
    source<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span>charset <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">readBomAsCharset</span><span class="token punctuation">(</span><span class="token function">charset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个source 对象就是上一节说的FramingSource对象。注意source调用readString方法，实际上中间会有一个buffer进行承载，把source中的数据写入到中间缓冲区，最后在拷贝返回。在写入过程中，就会调用source的read方法。</p>
<p>也就是ResponseBodySource.read</p>
<h4 id="ResponseBodySource-read"><a href="#ResponseBodySource-read" class="headerlink" title="ResponseBodySource.read"></a>ResponseBodySource.read</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">read</span><span class="token punctuation">(</span>sink<span class="token operator">:</span> Buffer<span class="token punctuation">,</span> byteCount<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token punctuation">{</span>
      <span class="token function">check</span><span class="token punctuation">(</span><span class="token operator">!</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">"closed"</span> <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> read <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>invokeStartEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          invokeStartEvent <span class="token operator">=</span> <span class="token boolean">false</span>
          eventListener<span class="token punctuation">.</span><span class="token function">responseBodyStart</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">complete</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1L</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">val</span> newBytesReceived <span class="token operator">=</span> bytesReceived <span class="token operator">+</span> read
        <span class="token keyword">if</span> <span class="token punctuation">(</span>contentLength <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&amp;&amp;</span> newBytesReceived <span class="token operator">></span> contentLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token function">ProtocolException</span><span class="token punctuation">(</span><span class="token string">"expected <span class="token interpolation variable">$contentLength</span> bytes but received <span class="token interpolation variable">$newBytesReceived</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        bytesReceived <span class="token operator">=</span> newBytesReceived
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newBytesReceived <span class="token operator">==</span> contentLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">complete</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> read
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">complete</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.调用FramingSource 的 read方法</li>
<li>2.一旦读取不到数据，或者刚好长度是解析出来的响应体长度，就会执行<code>complete</code>方法。</li>
</ul>
<h4 id="FramingSource-的-read"><a href="#FramingSource-的-read" class="headerlink" title="FramingSource 的 read"></a>FramingSource 的 read</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">read</span><span class="token punctuation">(</span>sink<span class="token operator">:</span> Buffer<span class="token punctuation">,</span> byteCount<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token punctuation">{</span>
      <span class="token function">require</span><span class="token punctuation">(</span>byteCount <span class="token operator">>=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">"byteCount &lt; 0: <span class="token interpolation variable">$byteCount</span>"</span> <span class="token punctuation">}</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> tryAgain <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">var</span> readBytesDelivered <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span>
        <span class="token keyword">var</span> errorExceptionToDeliver<span class="token operator">:</span> IOException<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

        <span class="token comment" spellcheck="true">// 1. Decide what to do in a synchronized block.</span>

        <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          readTimeout<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">// Prepare to deliver an error.</span>
              errorExceptionToDeliver <span class="token operator">=</span> errorException <span class="token operator">?:</span> <span class="token function">StreamResetException</span><span class="token punctuation">(</span>errorCode<span class="token operator">!!</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"stream closed"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>readBuffer<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">// Prepare to read bytes. Start by moving them to the caller's buffer.</span>
              readBytesDelivered <span class="token operator">=</span> readBuffer<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> <span class="token function">minOf</span><span class="token punctuation">(</span>byteCount<span class="token punctuation">,</span> readBuffer<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
              readBytesTotal <span class="token operator">+=</span> readBytesDelivered

              <span class="token keyword">val</span> unacknowledgedBytesRead <span class="token operator">=</span> readBytesTotal <span class="token operator">-</span> readBytesAcknowledged
              <span class="token keyword">if</span> <span class="token punctuation">(</span>errorExceptionToDeliver <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                  unacknowledgedBytesRead <span class="token operator">>=</span> connection<span class="token punctuation">.</span>okHttpSettings<span class="token punctuation">.</span>initialWindowSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Flow control: notify the peer that we're ready for more data! Only send a</span>
                <span class="token comment" spellcheck="true">// WINDOW_UPDATE if the stream isn't in error.</span>
                connection<span class="token punctuation">.</span><span class="token function">writeWindowUpdateLater</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> unacknowledgedBytesRead<span class="token punctuation">)</span>
                readBytesAcknowledged <span class="token operator">=</span> readBytesTotal
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>finished <span class="token operator">&amp;&amp;</span> errorExceptionToDeliver <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">// Nothing to do. Wait until that changes then try again.</span>
              <span class="token function">waitForIo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              tryAgain <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            readTimeout<span class="token punctuation">.</span><span class="token function">exitAndThrowIfTimedOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 2. Do it outside of the synchronized block and timeout.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>tryAgain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>readBytesDelivered <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

          <span class="token function">updateConnectionFlowControl</span><span class="token punctuation">(</span>readBytesDelivered<span class="token punctuation">)</span>
          <span class="token keyword">return</span> readBytesDelivered
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>errorExceptionToDeliver <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

          <span class="token keyword">throw</span> errorExceptionToDeliver<span class="token operator">!!</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token comment" spellcheck="true">// This source is exhausted.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果读取缓冲区readbuffer的大小为0，但是finished 标志位为false，说明此时还没有数据读取进来，就会调用<code>waitForIo</code> 进行阻塞，直到有数据才进入下一个循环。 如果FramingSource已经关闭了则之间报错。</p>
</li>
<li><p>2.readbuffer 大于0，则从readbuffer 读取数据。每次读取的大小都会累加到<code>readBytesTotal</code>中。<code>readBytesAcknowledged</code> 则是记录上一次读取后当前缓冲区的大小。那么就有：</p>
<blockquote>
<p>本次客户端已经扩容大小(<code>readBytesTotal</code> 新的总大小 - <code>readBytesAcknowledged</code> 上次大小 ) &gt; 初始窗体大小 / 2</p>
</blockquote>
</li>
</ul>
<p>则需要调用<code>writeWindowUpdateLater</code> 告诉服务端，此时客户端的流控制窗体大小已经扩大了，服务端需要对应扩大一个<code>本次客户端已经扩容大小</code>.</p>
<p>通过这个方法，就把数据读取到参数sink中，等待okio的拷贝。</p>
<p>那么哪里真正的把数据读取到Http2Stream的readbuffer数据读取缓冲区呢？</p>
<h3 id="Http2-读取服务端的数据"><a href="#Http2-读取服务端的数据" class="headerlink" title="Http2 读取服务端的数据"></a>Http2 读取服务端的数据</h3><p>实际上还是在Http2Stream的nextFrame中进行处理的，核心就是Http2Reader.readData 方法。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">readData</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> Handler<span class="token punctuation">,</span> length<span class="token operator">:</span> Int<span class="token punctuation">,</span> flags<span class="token operator">:</span> Int<span class="token punctuation">,</span> streamId<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> inFinished <span class="token operator">=</span> flags <span class="token operator">and</span> FLAG_END_STREAM <span class="token operator">!=</span> <span class="token number">0</span>
    <span class="token keyword">val</span> gzipped <span class="token operator">=</span> flags <span class="token operator">and</span> FLAG_COMPRESSED <span class="token operator">!=</span> <span class="token number">0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gzipped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"PROTOCOL_ERROR: FLAG_COMPRESSED without SETTINGS_COMPRESS_DATA"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">val</span> padding <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">and</span> FLAG_PADDED <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> source<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token number">0xff</span> <span class="token keyword">else</span> <span class="token number">0</span>
    <span class="token keyword">val</span> dataLength <span class="token operator">=</span> <span class="token function">lengthWithoutPadding</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> padding<span class="token punctuation">)</span>

    handler<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>inFinished<span class="token punctuation">,</span> streamId<span class="token punctuation">,</span> source<span class="token punctuation">,</span> dataLength<span class="token punctuation">)</span>
    source<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>padding<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到先获取响应体的数据长度后，调用<code>ReaderRunnable</code>的data方法。</p>
<h4 id="ReaderRunnable-data"><a href="#ReaderRunnable-data" class="headerlink" title="ReaderRunnable data"></a>ReaderRunnable data</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token keyword">data</span><span class="token punctuation">(</span>
      inFinished<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
      streamId<span class="token operator">:</span> Int<span class="token punctuation">,</span>
      source<span class="token operator">:</span> BufferedSource<span class="token punctuation">,</span>
      length<span class="token operator">:</span> Int
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pushedStream</span><span class="token punctuation">(</span>streamId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pushDataLater</span><span class="token punctuation">(</span>streamId<span class="token punctuation">,</span> source<span class="token punctuation">,</span> length<span class="token punctuation">,</span> inFinished<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">val</span> dataStream <span class="token operator">=</span> <span class="token function">getStream</span><span class="token punctuation">(</span>streamId<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dataStream <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">writeSynResetLater</span><span class="token punctuation">(</span>streamId<span class="token punctuation">,</span> ErrorCode<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">)</span>
        <span class="token function">updateConnectionFlowControl</span><span class="token punctuation">(</span>length<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        source<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>length<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      dataStream<span class="token punctuation">.</span><span class="token function">receiveData</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>inFinished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dataStream<span class="token punctuation">.</span><span class="token function">receiveHeaders</span><span class="token punctuation">(</span>EMPTY_HEADERS<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.先根据streamId 查找是否有对应的Http2Stream流对象，找不到则返回服务端异常，并告诉服务端对应流的窗体大小可以设置为0</p>
</li>
<li><p>2.找到则调用Http2Stream.receiveData.如果解析的flag为<code>FLAG_END_STREAM</code>说明关闭，还会调用receiveHeaders设置一个空的Headers集合。</p>
</li>
</ul>
<h5 id="Http2Stream-receiveData"><a href="#Http2Stream-receiveData" class="headerlink" title="Http2Stream.receiveData"></a>Http2Stream.receiveData</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">receiveData</span><span class="token punctuation">(</span>source<span class="token operator">:</span> BufferedSource<span class="token punctuation">,</span> length<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">.</span><span class="token function">assertThreadDoesntHoldLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> length<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">receive</span><span class="token punctuation">(</span>source<span class="token operator">:</span> BufferedSource<span class="token punctuation">,</span> byteCount<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">.</span><span class="token function">assertThreadDoesntHoldLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">var</span> byteCount <span class="token operator">=</span> byteCount

      <span class="token keyword">while</span> <span class="token punctuation">(</span>byteCount <span class="token operator">></span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> finished<span class="token operator">:</span> Boolean
        <span class="token keyword">val</span> flowControlError<span class="token operator">:</span> Boolean
        <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          finished <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>finished
          flowControlError <span class="token operator">=</span> byteCount <span class="token operator">+</span> readBuffer<span class="token punctuation">.</span>size <span class="token operator">></span> maxByteCount
        <span class="token punctuation">}</span>

<span class="token operator">..</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// Fill the receive buffer without holding any locks.</span>
        <span class="token keyword">val</span> read <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>receiveBuffer<span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">EOFException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        byteCount <span class="token operator">-=</span> read

        <span class="token keyword">var</span> bytesDiscarded <span class="token operator">=</span> <span class="token number">0L</span>
        <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bytesDiscarded <span class="token operator">=</span> receiveBuffer<span class="token punctuation">.</span>size
            receiveBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> wasEmpty <span class="token operator">=</span> readBuffer<span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token number">0L</span>
            readBuffer<span class="token punctuation">.</span><span class="token function">writeAll</span><span class="token punctuation">(</span>receiveBuffer<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wasEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token label symbol">@Http2Stream</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.从socket读取流中读取数据到receiveBuffer 中，并拷贝到<code>readBuffer</code>中。</li>
<li>2.如果<code>readBuffer</code>之前为0，说明是从无到有的读取，就会唤醒从FrameSink中readbuffer拷贝出去操作的阻塞。</li>
</ul>
<h3 id="ResponseBodySource-complete"><a href="#ResponseBodySource-complete" class="headerlink" title="ResponseBodySource  complete"></a>ResponseBodySource  complete</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>E <span class="token operator">:</span> IOException<span class="token operator">?</span><span class="token operator">></span> <span class="token function">complete</span><span class="token punctuation">(</span>e<span class="token operator">:</span> E<span class="token punctuation">)</span><span class="token operator">:</span> E <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>completed<span class="token punctuation">)</span> <span class="token keyword">return</span> e
      completed <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token comment" spellcheck="true">// If the body is closed without reading any bytes send a responseBodyStart() now.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> invokeStartEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        invokeStartEvent <span class="token operator">=</span> <span class="token boolean">false</span>
        eventListener<span class="token punctuation">.</span><span class="token function">responseBodyStart</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">bodyComplete</span><span class="token punctuation">(</span>bytesReceived<span class="token punctuation">,</span> responseDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> requestDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> e <span class="token operator">=</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">fun</span> <span class="token operator">&lt;</span>E <span class="token operator">:</span> IOException<span class="token operator">?</span><span class="token operator">></span> <span class="token function">bodyComplete</span><span class="token punctuation">(</span>
    bytesRead<span class="token operator">:</span> Long<span class="token punctuation">,</span>
    responseDone<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    requestDone<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    e<span class="token operator">:</span> E
  <span class="token punctuation">)</span><span class="token operator">:</span> E <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">trackFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestDone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventListener<span class="token punctuation">.</span><span class="token function">requestFailed</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        eventListener<span class="token punctuation">.</span><span class="token function">requestBodyEnd</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>responseDone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventListener<span class="token punctuation">.</span><span class="token function">responseFailed</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        eventListener<span class="token punctuation">.</span><span class="token function">responseBodyEnd</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> call<span class="token punctuation">.</span><span class="token function">messageDone</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> requestDone<span class="token punctuation">,</span> responseDone<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程根据是否传入了<code>IOException</code>异常，来决定最后是返回异常的回调还正常结束的回调。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>终于吧七层拦截器全部都过了一边，实际上整个Okhttp的设计中内置的核心拦截器一共也就5个。本文就从更加宏观的角度来看看ConnectInterceptor以及CallServerInterceptor两个拦截器都做了什么？</p>
<p>先来看看Okhttp的管理活跃链接<br><img src="/images/Okhttp%E9%93%BE%E6%8E%A5%E7%AE%A1%E7%90%86.png" alt="Okhttp链接管理.png"></p>
<p>实际上是由一个RealConnectionPool 缓存所有的RealConnection。实际上对应上层来说每一个RealConnection就是代表每一个网络链接的抽象门面。</p>
<p>而实际上真正工作的是其中的Socket对象。整个socket链接大致可以分为如下几个步骤：</p>
<ul>
<li>dns lookup 把资源地址转化为ip地址</li>
<li>socket.connect 通过socket把客户端和服务端联系起来</li>
<li>socket.starthandshake</li>
<li>socket.handshake</li>
</ul>
<p>这四个步骤都是在ConnectionInterceptor 拦截器中完成。</p>
<p>虽然都是RealConnection对象，但是分发到CallServerInterceptor之前会生成一个Exchange对象，其中这个对象就会根据Http1.0/1.1 或者Http2.0 协议 对应生成不同的Http1ExchangeCodec 以及 Http2ExchangeCodec. 这两个对象就是根据协议类型对数据流进行解析。</p>
<p>无论这两个协议做了什么，都可以抽象成如下几个方法：</p>
<ul>
<li><p>1.Exchange.writeRequestHeaders http1中就是把请求行和头部写入了socket临时缓冲区；http2就是把代表Header的数据帧数写到okio临时缓冲区。</p>
</li>
<li><p>2.Exchange.readResponseHeaders http1情况下如果没有请求体，那么则是尝试的读取响应体中的状态行头部等数据；如果是http2则是等待读取从服务端传递过来的头部数据帧数据到缓存队列中。</p>
</li>
<li><p>3.Exchange.createRequestBody http1则是获取ChunkedSink一个写入流；http2则是获取一个FrameSink写入流。</p>
</li>
<li><p>4.requestBody.writeTo 往createRequestBody创建的写入流写入数据。</p>
</li>
<li><p>5.Exchange.finishRequest 把请求体等数据一口气上传到服务端</p>
</li>
<li><p>6.Exchange.openResponseBody 获取响应体的读取流保存到Response对象中。当需要获取时候，就调用toString就会读取读取流的数据转化为字符串。</p>
</li>
</ul>
<p>到这里就完成了对okhttp七层拦截器的解析。当然这几篇文章主要还是对http协议进行了考察。如果需要考察其他协议，有了这个思想基础可以自行探索。当然如果之后有兴趣，可能会单独开几篇文章来聊聊内置的其他协议。</p>
<p>我们最后再来回顾一下，整个网络请求中链接到服务器几个核心步骤：</p>
<ul>
<li>dns lookup 把资源地址转化为ip地址</li>
<li>socket.connect 通过socket把客户端和服务端联系起来</li>
<li>socket.starthandshake</li>
<li>socket.handshake</li>
</ul>
<p>下面的篇章将会着重解析这几个步骤的核心原理。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/11/29/android-chong-xue-xi-lie-networkmanagementservice-netd-zai-dns-cha-xun-de-zhi-neng/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="Android重学系列 NetworkManagementService,netd在DNS查询的职能">
                        
                        <span class="card-title">Android重学系列 NetworkManagementService,netd在DNS查询的职能</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言前四篇文章讲述了Okhttp的核心原理，得知Okhttp是基于Socket开发的，而不是基于HttpUrlConnection开发的。
其中对于客户端来说，核心有如下四个步骤：

1.dns lookup 把资源地址转化为ip地址
2.
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-11-29
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/网络编程/" class="post-category">
                                    网络编程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/网络编程/">
                        <span class="chip bg-color">网络编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/10/24/android-chong-xue-xi-lie-okhttp-yuan-ma-jie-xi-san/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Android重学系列 OkHttp源码解析(三)">
                        
                        <span class="card-title">Android重学系列 OkHttp源码解析(三)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章和大家聊了聊Okhttp前三个拦截器，本文来聊聊ConnectInterceptor 链接拦截器都负责什么职责。
本文将不会了聊自定义的网络拦截器以及自定义的用户拦截器。
阅读本文之前，最好对SSL/TLS有一定的了解,具体的
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-10-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/网络编程/" class="post-category">
                                    网络编程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/网络编程/">
                        <span class="chip bg-color">网络编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
