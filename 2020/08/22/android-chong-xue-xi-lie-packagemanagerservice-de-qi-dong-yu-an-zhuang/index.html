<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android重学系列 PackageManagerService的启动与安装(上), Android | Linux | Flutter">
    <meta name="description" content="前言PackageManagerService 是Android系统中对所有apk包的管理服务中心，之后我将成其为PMS。PMS除了管理所有已经安装好的apk包的数据，还包含了安装apk的服务，让我们一探究竟。
正文PMS的启动PMS的启动">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android重学系列 PackageManagerService的启动与安装(上) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android重学系列 PackageManagerService的启动与安装(上)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/PMS/" class="post-category">
                                PMS
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-08-22
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        10.5k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        50 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>PackageManagerService 是Android系统中对所有apk包的管理服务中心，之后我将成其为PMS。PMS除了管理所有已经安装好的apk包的数据，还包含了安装apk的服务，让我们一探究竟。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="PMS的启动"><a href="#PMS的启动" class="headerlink" title="PMS的启动"></a>PMS的启动</h2><p>PMS的启动，从SystemServer开始,更加详细的原理可以去<a href="https://www.jianshu.com/p/a59068928590" target="_blank" rel="noopener">SystemServer到Home的启动</a>下阅读：</p>
<p>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/java/com/android/server/SystemServer.java" target="_blank" rel="noopener">SystemServer.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mPackageManagerService <span class="token operator">=</span> PackageManagerService<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">,</span> installer<span class="token punctuation">,</span>
                mFactoryTestMode <span class="token operator">!=</span> FactoryTest<span class="token punctuation">.</span>FACTORY_TEST_OFF<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mFirstBoot <span class="token operator">=</span> mPackageManagerService<span class="token punctuation">.</span><span class="token function">isFirstBoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOnlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mPackageManagerService<span class="token punctuation">.</span><span class="token function">updatePackagesIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reportWtf</span><span class="token punctuation">(</span><span class="token string">"update packages"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mPackageManagerService<span class="token punctuation">.</span><span class="token function">performFstrimIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reportWtf</span><span class="token punctuation">(</span><span class="token string">"performing fstrim"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mPackageManagerService<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mActivityManagerService<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mPackageManagerService<span class="token punctuation">.</span><span class="token function">waitForAppDataPrepared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在SystemServer的启动依照如下顺序：</p>
<ul>
<li>1.PackageManagerService.main 将安装服务Intstaller传入，并实例化PMS</li>
<li>2.mPackageManagerService.updatePackagesIfNeeded</li>
<li>3.mPackageManagerService.performFstrimIfNeeded</li>
<li>4.mPackageManagerService. systemReady</li>
<li>5.mPackageManagerService. waitForAppDataPrepared</li>
</ul>
<h3 id="PackageManagerService-main"><a href="#PackageManagerService-main" class="headerlink" title="PackageManagerService.main"></a>PackageManagerService.main</h3><p>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/" target="_blank" rel="noopener">pm</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java" target="_blank" rel="noopener">PackageManagerService.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> PackageManagerService <span class="token function">main</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        PackageManagerService m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageManagerService</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> installer<span class="token punctuation">,</span>
                factoryTest<span class="token punctuation">,</span> onlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        m<span class="token punctuation">.</span><span class="token function">enableSystemUserPackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> PackageManagerNative pmn <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">PackageManagerNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"package_native"</span><span class="token punctuation">,</span> pmn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在PMS的构造函数中，完成了两个对象的实例化，并加入到ServiceManager中。</p>
<ul>
<li>PackageManagerService</li>
<li>PackageManagerNative PackageManagerNative 是PMS的Binder接口对象，我们可以不用看，主要看看PMS本身的实例化都做了什么。</li>
</ul>
<h4 id="PackageManagerService的实例化"><a href="#PackageManagerService的实例化" class="headerlink" title="PackageManagerService的实例化"></a>PackageManagerService的实例化</h4><p>整个构造函数方法很长，我们拆分为几段和大家聊聊：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">PackageManagerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LockGuard<span class="token punctuation">.</span><span class="token function">installLock</span><span class="token punctuation">(</span>mPackages<span class="token punctuation">,</span> LockGuard<span class="token punctuation">.</span>INDEX_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>

        mFactoryTest <span class="token operator">=</span> factoryTest<span class="token punctuation">;</span>
        mOnlyCore <span class="token operator">=</span> onlyCore<span class="token punctuation">;</span>
        mMetrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInstaller <span class="token operator">=</span> installer<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Create sub-components that provide services / data. Order here is important.</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Expose private service for system components to use.</span>
            LocalServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>
                    PackageManagerInternal<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PackageManagerInternalImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sUserManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserManagerService</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">UserDataPreparer</span><span class="token punctuation">(</span>mInstaller<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">,</span> mContext<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">,</span> mPackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPermissionManager <span class="token operator">=</span> PermissionManagerService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">DefaultPermissionGrantedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDefaultRuntimePermissionsGranted</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                mSettings<span class="token punctuation">.</span><span class="token function">onDefaultRuntimePermissionsGrantedLPr</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> mPackages <span class="token comment" spellcheck="true">/*externalLock*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mDefaultPermissionPolicy <span class="token operator">=</span> mPermissionManager<span class="token punctuation">.</span><span class="token function">getDefaultPermissionGrantPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mSettings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Settings</span><span class="token punctuation">(</span>mPermissionManager<span class="token punctuation">.</span><span class="token function">getPermissionSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mPackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.system"</span><span class="token punctuation">,</span> Process<span class="token punctuation">.</span>SYSTEM_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.phone"</span><span class="token punctuation">,</span> RADIO_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.log"</span><span class="token punctuation">,</span> LOG_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.nfc"</span><span class="token punctuation">,</span> NFC_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.bluetooth"</span><span class="token punctuation">,</span> BLUETOOTH_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.shell"</span><span class="token punctuation">,</span> SHELL_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.se"</span><span class="token punctuation">,</span> SE_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.实例化DisplayMetrics对象，这个对象出现过很多次，里面包含了Display的屏幕信息</p>
</li>
<li><p>2.实例化一个PackageManagerInternalImpl对象，这个对象将会作为本地的服务对外提供一些PMS的功能</p>
</li>
<li><p>3.实例化UserManagerService 用户管理服务。在Android系统中是一个多用户系统，每一个应用就代表一个用户。而这个服务其实就是管理每一个应用用户相关的权限和信息。</p>
</li>
<li><p>4.实例化PermissionManagerService 动态权限服务，所有的动态权限最终都会到这个服务下进行权限的设置操作，把权限相关的信息写入到一个名字为”package-perms-“+userId的文件中。</p>
</li>
<li><p>5.实例化一个关键的对象，Settings对象。这个对象管理了开机时候需要读取的文件，如记录每一个安装的apk包中所有组件的packages.list，如记录每一个应用动态权限文件。</p>
</li>
<li><p>6.Settings将会添加如下几个公共用户id:</p>
<ul>
<li>SYSTEM_UID 系统</li>
<li>RADIO_UID 电话</li>
<li>LOG_UID 打印</li>
<li>NFC_UID NFC设备</li>
<li>BLUETOOTH_UID 蓝牙设备</li>
<li>SHELL_UID shell 命令</li>
<li>SE_UID selinux</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYSTEM_UID <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> PHONE_UID <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHELL_UID <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> LOG_UID <span class="token operator">=</span> <span class="token number">1007</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NFC_UID <span class="token operator">=</span> <span class="token number">1027</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> BLUETOOTH_UID <span class="token operator">=</span> <span class="token number">1002</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SE_UID <span class="token operator">=</span> <span class="token number">1068</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们来看看核心对象Settings是怎么实现的。至于UserManagerService，PermissionManagerService等暂时不再讨论范围内。</p>
<h5 id="Settings-初始化"><a href="#Settings-初始化" class="headerlink" title="Settings 初始化"></a>Settings 初始化</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/" target="_blank" rel="noopener">pm</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/Settings.java" target="_blank" rel="noopener">Settings.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token function">Settings</span><span class="token punctuation">(</span>PermissionSettings permissions<span class="token punctuation">,</span> Object lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getDataDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">Settings</span><span class="token punctuation">(</span>File dataDir<span class="token punctuation">,</span> PermissionSettings permission<span class="token punctuation">,</span> Object lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mLock <span class="token operator">=</span> lock<span class="token punctuation">;</span>
        mPermissions <span class="token operator">=</span> permission<span class="token punctuation">;</span>
        mRuntimePermissionsPersistence <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimePermissionPersistence</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mSystemDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>dataDir<span class="token punctuation">,</span> <span class="token string">"system"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSystemDir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileUtils<span class="token punctuation">.</span><span class="token function">setPermissions</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                FileUtils<span class="token punctuation">.</span>S_IRWXU<span class="token operator">|</span>FileUtils<span class="token punctuation">.</span>S_IRWXG
                <span class="token operator">|</span>FileUtils<span class="token punctuation">.</span>S_IROTH<span class="token operator">|</span>FileUtils<span class="token punctuation">.</span>S_IXOTH<span class="token punctuation">,</span>
                <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSettingsFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBackupSettingsFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages-backup.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPackageListFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages.list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileUtils<span class="token punctuation">.</span><span class="token function">setPermissions</span><span class="token punctuation">(</span>mPackageListFilename<span class="token punctuation">,</span> <span class="token number">0640</span><span class="token punctuation">,</span> SYSTEM_UID<span class="token punctuation">,</span> PACKAGE_INFO_GID<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> File kernelDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"/config/sdcardfs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mKernelMappingFilename <span class="token operator">=</span> kernelDir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> kernelDir <span class="token operator">:</span> null<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Deprecated: Needed for migration</span>
        mStoppedPackagesFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages-stopped.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBackupStoppedPackagesFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages-stopped-backup.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.整个PMS的Settings 也就是设置相关的文件都保存在根目录<code>/data</code> 文件夹下。</p>
</li>
<li><p>2.接着在data文件夹下创建一个system文件夹’/data/system’，并为这个文件夹设置只有本进程用户能读写执行，同一个进程用户组也能读写执行，其他进程组只能读或者执行，定义如下：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IRWXU <span class="token operator">=</span> <span class="token number">00700</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IRUSR <span class="token operator">=</span> <span class="token number">00400</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IWUSR <span class="token operator">=</span> <span class="token number">00200</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IXUSR <span class="token operator">=</span> <span class="token number">00100</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IRWXG <span class="token operator">=</span> <span class="token number">00070</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IRGRP <span class="token operator">=</span> <span class="token number">00040</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IWGRP <span class="token operator">=</span> <span class="token number">00020</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IXGRP <span class="token operator">=</span> <span class="token number">00010</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IRWXO <span class="token operator">=</span> <span class="token number">00007</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IROTH <span class="token operator">=</span> <span class="token number">00004</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IWOTH <span class="token operator">=</span> <span class="token number">00002</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> S_IXOTH <span class="token operator">=</span> <span class="token number">00001</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>3.在’/data/system’ 下创建一个配置文件<code>packages.xml</code>，以及一个备份的配置文件<code>packages-backup.xml</code>,该文件将会存储每一个apk包的java代码的文件夹以及so库的文件夹位置</p>
</li>
<li><p>4.创建缓存所有应用相关信息的<code>packages.list</code>文件，并且设置当前的权限是0640，也就是本进程用户能读写，同一个进程(用户)组只能读，其他进程没有任何权限.</p>
</li>
<li><p>5.判断<code>/config/sdcardfs</code>文件是否存在，存在则mKernelMappingFilename</p>
</li>
<li><p>6.<code>packages-stopped.xml</code>维护的是被停掉的应用,<code>packages-stopped-backup.xml</code>则是它的备份信息。</p>
</li>
</ul>
<p>本文关注的重点是关于包存储信息<code>packages.list</code>以及<code>packages.xml</code>，我们扒一扒这文件中存储的是什么东西？</p>
<h5 id="packages-list文件内容"><a href="#packages-list文件内容" class="headerlink" title="packages.list文件内容"></a>packages.list文件内容</h5><p>注意在Android 9.0中，已经没有权限打开这个权限。因此我将打开低版本Android 4.3中缓存的数据作为例子：<br>这里是<code>packages.list</code>文件内容：</p>
<pre><code>com.google.android.location 10018 0 /data/data/com.google.android.location default
com.android.soundrecorder 10038 0 /data/data/com.android.soundrecorder release
com.android.sdksetup 10036 0 /data/data/com.android.sdksetup platform
com.android.defcontainer 10010 0 /data/data/com.android.defcontainer platform
com.android.launcher 10022 0 /data/data/com.android.launcher shared
com.android.smoketest 10047 0 /data/data/com.android.smoketest default
com.android.quicksearchbox 10035 0 /data/data/com.android.quicksearchbox shared
com.android.contacts 10000 0 /data/data/com.android.contacts shared
....</code></pre><p>能看到在<code>packages.list</code>可以把这个数据分为如下几个部分：</p>
<ul>
<li><code>com.google.android.location</code> 包名</li>
<li><code>10018</code> 这个应用对应的userId，也正是因为记录当前的userId，所以每一次才能保证userId是一致的，保证了在Android系统中可以通过userId正确的找到应用</li>
<li><code>0</code>当前是否是debug模式，由AndroidManifest.xml中是否设置了<code>android:debuggable</code></li>
<li><code>/data/data/com.google.android.location</code> 确定了当前的应用存储数据的目录</li>
<li><code>default</code> / <code>release</code> / <code>platform</code> / <code>shared</code> 这些字符串为在<code>mac_permission.xml</code>为每一个进程定义好的seinfo标签，seinfo不是描述文件的安全性，而是用来在<code>seapp_contexts</code>文件中查找对应的类型对象。</li>
</ul>
<p>mac_permission.xml如下设置：</p>
<pre><code>&lt;signer signature="@PLATFORM" &gt;
  &lt;seinfo value="platform" /&gt;
&lt;/signer&gt;

&lt;!-- Media key in AOSP --&gt;
&lt;signer signature="@MEDIA" &gt;
  &lt;seinfo value="media" /&gt;
&lt;/signer&gt;</code></pre><p>那么在seapp_contexts文件中有:<br>···java<br>user=_app seinfo=platform domain=platform_app type=app_data_file levelFrom=user<br>···</p>
<p>当 PackageManagerService 安装 App 的时候，它就会根据其签名或者包名查找到对应的 seinfo，并且将这个 seinfo 传递给另外一个守护进程 installed。</p>
<p>这部分属于SELinux的内容了，感兴趣的可以去阅读这一篇文章：<a href="https://blog.csdn.net/qq_19923217/article/details/81240027" target="_blank" rel="noopener">SELinux的介绍</a>。总之一句话就是，SELinux就是控制了不同权限的资源只能由对应的不同权限的进程才能访问。</p>
<h5 id="packages-xml-内容"><a href="#packages-xml-内容" class="headerlink" title="packages.xml 内容"></a>packages.xml 内容</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">'1.0'</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span> standalone<span class="token operator">=</span><span class="token string">'yes'</span> <span class="token operator">?</span><span class="token operator">></span>
<span class="token operator">&lt;</span>packages<span class="token operator">></span>
  <span class="token operator">&lt;</span>version sdkVersion<span class="token operator">=</span><span class="token string">"xx"</span> databaseVersion<span class="token operator">=</span><span class="token string">"xx"</span> fingerprint<span class="token operator">=</span><span class="token string">"xxx"</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>version volumeUuid<span class="token operator">=</span><span class="token string">"xxx"</span> sdkVersion<span class="token operator">=</span><span class="token string">"xx"</span> databaseVersion<span class="token operator">=</span><span class="token string">"xx"</span> fingerprint<span class="token operator">=</span><span class="token string">"xxx"</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>permission<span class="token operator">-</span>trees<span class="token operator">></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>permission<span class="token operator">-</span>trees<span class="token operator">></span>
  <span class="token operator">&lt;</span>permissions<span class="token operator">></span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>permissions<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token keyword">package</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">package</span><span class="token operator">></span>

  <span class="token operator">&lt;</span>shared<span class="token operator">-</span>user <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>shared<span class="token operator">-</span>user<span class="token operator">></span>

<span class="token operator">&lt;</span>packages<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在packages大标签中，分为如下几个部分：</p>
<ul>
<li><p>permissions  里面包含如<code>&lt;item name="android.permission.ACCESS_NETWORK_STATE" package="android" /&gt;</code> 。permissions定义了所有在Android系统中当前的系统和App权限。可以分为两个两类：系统和App应用拥有的权限</p>
</li>
<li><p>package 代表了每一个安装在系统中App的应用。</p>
<pre class="line-numbers language-xml"><code class="language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>package</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.google.android.location<span class="token punctuation">"</span></span> <span class="token attr-name">codePath</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/system/app/NetworkLocation.apk<span class="token punctuation">"</span></span> <span class="token attr-name">nativeLibraryPath</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/data/app-lib/NetworkLocation<span class="token punctuation">"</span></span> <span class="token attr-name">flags</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>4767301<span class="token punctuation">"</span></span> <span class="token attr-name">ft</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>15b3647e0e0<span class="token punctuation">"</span></span> <span class="token attr-name">it</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>15b3647e0e0<span class="token punctuation">"</span></span> <span class="token attr-name">ut</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>15b3647e0e0<span class="token punctuation">"</span></span> <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1110<span class="token punctuation">"</span></span> <span class="token attr-name">sharedUserId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10018<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sigs</span> <span class="token attr-name">count</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cert</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>30820....<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sigs</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>package</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该package标签包含了如下内容：</p>
<ul>
<li>1.<code>name</code> 包名</li>
<li>2.<code>codePath</code> apk安装路径.主要是<code>/system/app</code>和<code>/data/app</code>两种</li>
<li>3.<code>nativeLibraryPath</code> 是so文件保存的位置</li>
<li>4.<code>userId</code> 是当前应用的userId</li>
<li>5.<code>sigs</code> 签名内容</li>
</ul>
</li>
<li><p>shared-user标签包含如下内容</p>
<pre><code>  &lt;shared-user name="com.google.android.apps.maps" userId="10026"&gt;
      &lt;sigs count="1"&gt;
          &lt;cert index="0" /&gt;
      &lt;/sigs&gt;
      &lt;perms&gt;
          &lt;item name="android.permission.NFC" /&gt;
          &lt;item name="android.permission.READ_EXTERNAL_STORAGE" /&gt;
          &lt;item name="android.permission.USE_CREDENTIALS" /&gt;
          &lt;item name="android.permission.WRITE_EXTERNAL_STORAGE" /&gt;
          &lt;item name="android.permission.ACCESS_WIFI_STATE" /&gt;
          &lt;item name="android.permission.ACCESS_COARSE_LOCATION" /&gt;
          &lt;item name="android.permission.GET_ACCOUNTS" /&gt;
          &lt;item name="com.google.android.providers.gsf.permission.READ_GSERVICES" /&gt;
          &lt;item name="android.permission.DISABLE_KEYGUARD" /&gt;
          &lt;item name="android.permission.INTERNET" /&gt;
          &lt;item name="android.permission.ACCESS_FINE_LOCATION" /&gt;
          &lt;item name="android.permission.MANAGE_ACCOUNTS" /&gt;
          &lt;item name="android.permission.VIBRATE" /&gt;
          &lt;item name="android.permission.ACCESS_NETWORK_STATE" /&gt;
      &lt;/perms&gt;
  &lt;/shared-user&gt;</code></pre><p><code>shared-user</code>这标签就是指能够访问共享的进程。 <code>com.google.android.apps.maps</code>就是这个共享进程的包名，userId 是指当前进程的userId，以及perms是指这个进程中的权限</p>
</li>
</ul>
<h4 id="PMS实例化第二段"><a href="#PMS实例化第二段" class="headerlink" title="PMS实例化第二段"></a>PMS实例化第二段</h4><pre class="line-numbers language-java"><code class="language-java">        mPackageDexOptimizer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageDexOptimizer</span><span class="token punctuation">(</span>installer<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">,</span> context<span class="token punctuation">,</span>
                <span class="token string">"*dexopt*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DexManager<span class="token punctuation">.</span>Listener dexManagerListener <span class="token operator">=</span> DexLogger<span class="token punctuation">.</span><span class="token function">getListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
                installer<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDexManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexManager</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> mPackageDexOptimizer<span class="token punctuation">,</span> installer<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">,</span>
                dexManagerListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mArtManagerService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArtManagerService</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> installer<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mMoveCallbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MoveCallbacks</span><span class="token punctuation">(</span>FgThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mOnPermissionChangeListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OnPermissionChangeListeners</span><span class="token punctuation">(</span>
                FgThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">getDefaultDisplayMetrics</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>


        SystemConfig systemConfig <span class="token operator">=</span> SystemConfig<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mAvailableFeatures <span class="token operator">=</span> systemConfig<span class="token punctuation">.</span><span class="token function">getAvailableFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        mProtectedPackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProtectedPackages</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mHandlerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceThread</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span>
                    Process<span class="token punctuation">.</span>THREAD_PRIORITY_BACKGROUND<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*allowIo*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mHandlerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageHandler</span><span class="token punctuation">(</span>mHandlerThread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mProcessLoggingHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessLoggingHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Watchdog<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addThread</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">,</span> WATCHDOG_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstantAppRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstantAppRegistry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            ArrayMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> libConfig <span class="token operator">=</span> systemConfig<span class="token punctuation">.</span><span class="token function">getSharedLibraries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> builtInLibCount <span class="token operator">=</span> libConfig<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> builtInLibCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String name <span class="token operator">=</span> libConfig<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String path <span class="token operator">=</span> libConfig<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">addSharedLibraryLPw</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> null<span class="token punctuation">,</span> name<span class="token punctuation">,</span> SharedLibraryInfo<span class="token punctuation">.</span>VERSION_UNDEFINED<span class="token punctuation">,</span>
                        SharedLibraryInfo<span class="token punctuation">.</span>TYPE_BUILTIN<span class="token punctuation">,</span> PLATFORM_PACKAGE_NAME<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            SELinuxMMAC<span class="token punctuation">.</span><span class="token function">readInstallPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            FallbackCategoryProvider<span class="token punctuation">.</span><span class="token function">loadFallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            mFirstBoot <span class="token operator">=</span> <span class="token operator">!</span>mSettings<span class="token punctuation">.</span><span class="token function">readLPw</span><span class="token punctuation">(</span>sUserManager<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">int</span> packageSettingCount <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> packageSettingCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isExternal</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ps<span class="token punctuation">.</span>codePath <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>ps<span class="token punctuation">.</span>codePath<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mSettings<span class="token punctuation">.</span><span class="token function">enableSystemPackageLPw</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mFirstBoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">requestCopyPreoptedFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>       
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.构造了一个PackageDexOptimizer对象，这个对象将会操作Installer对象，对dex文件进行优化成odex文件。odex文件是经过dex文件的优化，进行一些提前的校验，切换18种指令为更加高效的指令，构建vtable 虚方法table等。之后有机会会解析dex2oat,实际上其实dex2oat 几乎也完成了dexopt的工作。</p>
</li>
<li><p>2.构造了DexManager对象，用于控制PackageDexOptimizer对象,是Dex优化管理器。</p>
</li>
<li><p>3.构建ArtManagerService对象，这是一个Binder对象。开放给其他服务,在运行时进行art编译处理。</p>
</li>
<li><p>4.创建一个ServiceThread对象，这是一个HandlerThread对象。这就是一个带着Looper的线程，可以把Looper赋值给PackageHandler，创建PMS中的异步线程Handler对象。</p>
</li>
<li><p>5.创建一个WatchDog，监听PMS的死锁等情况</p>
</li>
<li><p>6.从系统配置systemConfig中，获取系统允许共享出来的共享库，保存在mSharedLibraries中。</p>
</li>
<li><p>7.调用readLPw读取保存在系统中所有安装的packages.xml的包中所有的信息，通过返回值确定是否是第一次启动PMS。读取完所有的所有的包后，从Settings的包集合判断这些包中是否还包含代码路径，调用enableSystemPackageLPw方法，处理是否是保存在mDisabledSysPackages集合中，也就是禁止使用的系统应用，如果存在则重新添加，不存则返回。</p>
</li>
<li><p>8.如果是第一次启动PMS，则调用requestCopyPreoptedFiles方法。</p>
</li>
</ul>
<p>核心方法是readLPw。</p>
<h5 id="Settings-readLPw"><a href="#Settings-readLPw" class="headerlink" title="Settings readLPw"></a>Settings readLPw</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/" target="_blank" rel="noopener">pm</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/Settings.java" target="_blank" rel="noopener">Settings.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">readLPw</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> List<span class="token operator">&lt;</span>UserInfo<span class="token operator">></span> users<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        FileInputStream str <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBackupSettingsFilename<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>mBackupSettingsFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mReadMessages<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Reading from backup settings file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                PackageManagerService<span class="token punctuation">.</span><span class="token function">reportSettingsProblem</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>
                        <span class="token string">"Need to read from backup settings file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mSettingsFilename<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    mSettingsFilename<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// We'll try for the normal settings file.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mPendingPackages<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPastSignatures<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mKeySetRefs<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInstallerPackages<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSettingsFilename<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mReadMessages<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"No settings file found\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    PackageManagerService<span class="token punctuation">.</span><span class="token function">reportSettingsProblem</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>
                            <span class="token string">"No settings file; creating initial state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token function">findOrCreateVersion</span><span class="token punctuation">(</span>StorageManager<span class="token punctuation">.</span>UUID_PRIVATE_INTERNAL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forceCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">findOrCreateVersion</span><span class="token punctuation">(</span>StorageManager<span class="token punctuation">.</span>UUID_PRIMARY_PHYSICAL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forceCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>mSettingsFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            XmlPullParser parser <span class="token operator">=</span> Xml<span class="token punctuation">.</span><span class="token function">newPullParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parser<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> type<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>START_TAG
                    <span class="token operator">&amp;&amp;</span> type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>START_TAG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span> outerDepth <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> outerDepth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>TEXT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                String tagName <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">readPackageLPw</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"permission-trees"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"shared-user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"preferred-packages"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"preferred-activities"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_PERSISTENT_PREFERRED_ACTIVITIES<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_CROSS_PROFILE_INTENT_FILTERS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_DEFAULT_BROWSER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"updated-package"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"cleaning-package"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"renamed-package"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"restored-ivi"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"last-platform-version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"database-version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"verifier"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>TAG_READ_EXTERNAL_STORAGE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"keyset-settings"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>TAG_VERSION<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            str<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XmlPullParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageManagerService<span class="token punctuation">.</span>CLEAR_RUNTIME_PERMISSIONS_ON_UPGRADE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> VersionInfo internal <span class="token operator">=</span> <span class="token function">getInternalVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Build<span class="token punctuation">.</span>FINGERPRINT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>internal<span class="token punctuation">.</span>fingerprint<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>UserInfo user <span class="token operator">:</span> users<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mRuntimePermissionsPersistence<span class="token punctuation">.</span><span class="token function">deleteUserRuntimePermissionsFile</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> mPendingPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PackageSetting p <span class="token operator">=</span> mPendingPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> sharedUserId <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">getSharedUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Object idObj <span class="token operator">=</span> <span class="token function">getUserIdLPr</span><span class="token punctuation">(</span>sharedUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>idObj <span class="token keyword">instanceof</span> <span class="token class-name">SharedUserSetting</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> SharedUserSetting sharedUser <span class="token operator">=</span> <span class="token punctuation">(</span>SharedUserSetting<span class="token punctuation">)</span> idObj<span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>sharedUser <span class="token operator">=</span> sharedUser<span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>appId <span class="token operator">=</span> sharedUser<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
                <span class="token function">addPackageSettingLPw</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> sharedUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>idObj <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mPendingPackages<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBackupStoppedPackagesFilename<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> mStoppedPackagesFilename<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Read old file</span>
            <span class="token function">readStoppedLPw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mBackupStoppedPackagesFilename<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mStoppedPackagesFilename<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Migrate to new file format</span>
            <span class="token function">writePackageRestrictionsLPr</span><span class="token punctuation">(</span>UserHandle<span class="token punctuation">.</span>USER_SYSTEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>UserInfo user <span class="token operator">:</span> users<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">readPackageRestrictionsLPr</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>UserInfo user <span class="token operator">:</span> users<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mRuntimePermissionsPersistence<span class="token punctuation">.</span><span class="token function">readStateForUserSyncLPr</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">final</span> Iterator<span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span> disabledIt <span class="token operator">=</span> mDisabledSysPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>disabledIt<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PackageSetting disabledPs <span class="token operator">=</span> disabledIt<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Object id <span class="token operator">=</span> <span class="token function">getUserIdLPr</span><span class="token punctuation">(</span>disabledPs<span class="token punctuation">.</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> id <span class="token keyword">instanceof</span> <span class="token class-name">SharedUserSetting</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                disabledPs<span class="token punctuation">.</span>sharedUser <span class="token operator">=</span> <span class="token punctuation">(</span>SharedUserSetting<span class="token punctuation">)</span> id<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mReadMessages<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Read completed successfully: "</span> <span class="token operator">+</span> mPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" packages, "</span>
                <span class="token operator">+</span> mSharedUsers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" shared uids\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">writeKernelMappingLPr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.首先尝试的查找是否有备份的package.xml数据，存在则说明可能发生过错误，则读取备份文件中的FileStream。并删除了package.xml原来文件</p>
</li>
<li><p>2.不存备份文件，则直接读取packages.xml的FileStream。</p>
</li>
<li><p>3.在这个过程中，就能看到就是一个简单的解析xml文件的过程，每遇到一个标签就进行对应的解析行为。如package信息，权限信息等。</p>
</li>
<li><p>解析完所有的信息后，并开始处理mPendingPackages数据。最后再检测是否存在备份文件或者packages-stopped.xml ，存在两者其一，则读取packages-stopped.xml中的数据，并把备份数据重新写入到新的packages.xml文件中。</p>
</li>
</ul>
<p>值得注意的是解析标签<code>package</code>,在介些这个标签的时候执行了<code>readPackageLPw</code>方法对<code>package</code>标签进一步的解析：</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                packageSetting <span class="token operator">=</span> <span class="token function">addPackageLPw</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> realName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>codePathStr<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>resourcePathStr<span class="token punctuation">)</span><span class="token punctuation">,</span> legacyNativeLibraryPathStr<span class="token punctuation">,</span> primaryCpuAbiString<span class="token punctuation">,</span>
                        secondaryCpuAbiString<span class="token punctuation">,</span> cpuAbiOverrideString<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> versionCode<span class="token punctuation">,</span> pkgFlags<span class="token punctuation">,</span>
                        pkgPrivateFlags<span class="token punctuation">,</span> parentPackageName<span class="token punctuation">,</span> null <span class="token comment" spellcheck="true">/*childPackageNames*/</span><span class="token punctuation">,</span>
                        null <span class="token comment" spellcheck="true">/*usesStaticLibraries*/</span><span class="token punctuation">,</span> null <span class="token comment" spellcheck="true">/*usesStaticLibraryVersions*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    packageSetting<span class="token punctuation">.</span><span class="token function">setTimeStamp</span><span class="token punctuation">(</span>timeStamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    packageSetting<span class="token punctuation">.</span>firstInstallTime <span class="token operator">=</span> firstInstallTime<span class="token punctuation">;</span>
                    packageSetting<span class="token punctuation">.</span>lastUpdateTime <span class="token operator">=</span> lastUpdateTime<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用addPackageLPw添加到缓存中。</p>
<h6 id="addPackageLPw"><a href="#addPackageLPw" class="headerlink" title="addPackageLPw"></a>addPackageLPw</h6><pre class="line-numbers language-java"><code class="language-java">    PackageSetting <span class="token function">addPackageLPw</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> String realName<span class="token punctuation">,</span> File codePath<span class="token punctuation">,</span> File resourcePath<span class="token punctuation">,</span>
            String legacyNativeLibraryPathString<span class="token punctuation">,</span> String primaryCpuAbiString<span class="token punctuation">,</span>
            String secondaryCpuAbiString<span class="token punctuation">,</span> String cpuAbiOverrideString<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">long</span> vc<span class="token punctuation">,</span> <span class="token keyword">int</span>
            pkgFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> pkgPrivateFlags<span class="token punctuation">,</span> String parentPackageName<span class="token punctuation">,</span>
            List<span class="token operator">&lt;</span>String<span class="token operator">></span> childPackageNames<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> usesStaticLibraries<span class="token punctuation">,</span>
            <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> usesStaticLibraryNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PackageSetting p <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>appId <span class="token operator">==</span> uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> p<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            PackageManagerService<span class="token punctuation">.</span><span class="token function">reportSettingsProblem</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span>
                    <span class="token string">"Adding duplicate package, keeping first: "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageSetting</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> realName<span class="token punctuation">,</span> codePath<span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span>
                legacyNativeLibraryPathString<span class="token punctuation">,</span> primaryCpuAbiString<span class="token punctuation">,</span> secondaryCpuAbiString<span class="token punctuation">,</span>
                cpuAbiOverrideString<span class="token punctuation">,</span> vc<span class="token punctuation">,</span> pkgFlags<span class="token punctuation">,</span> pkgPrivateFlags<span class="token punctuation">,</span> parentPackageName<span class="token punctuation">,</span>
                childPackageNames<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*userId*/</span><span class="token punctuation">,</span> usesStaticLibraries<span class="token punctuation">,</span> usesStaticLibraryNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span>appId <span class="token operator">=</span> uid<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addUserIdLPw</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> p<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，就是根据当前的路径名，资源文件路径，代码文件路径，so库路径生成一个App应用PackageSetting的配置内存文件，保存到mPackages中。</p>
<h4 id="PMS-实例化第三段"><a href="#PMS-实例化第三段" class="headerlink" title="PMS 实例化第三段"></a>PMS 实例化第三段</h4><pre class="line-numbers language-java"><code class="language-java">            <span class="token keyword">final</span> String bootClassPath <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"BOOTCLASSPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> String systemServerClassPath <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"SYSTEMSERVERCLASSPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            File frameworkDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"framework"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> VersionInfo ver <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getInternalVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mIsUpgrade <span class="token operator">=</span> <span class="token operator">!</span>Build<span class="token punctuation">.</span>FINGERPRINT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ver<span class="token punctuation">.</span>fingerprint<span class="token punctuation">)</span><span class="token punctuation">;</span>


            mPromoteSystemApps <span class="token operator">=</span>
                    mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>LOLLIPOP_MR1<span class="token punctuation">;</span>


            mIsPreNUpgrade <span class="token operator">=</span> mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N<span class="token punctuation">;</span>

            mIsPreNMR1Upgrade <span class="token operator">=</span> mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N_MR1<span class="token punctuation">;</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPromoteSystemApps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            mCacheDir <span class="token operator">=</span> <span class="token function">preparePackageParserCache</span><span class="token punctuation">(</span>mIsUpgrade<span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token keyword">int</span> scanFlags <span class="token operator">=</span> SCAN_BOOTING <span class="token operator">|</span> SCAN_INITIAL<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade <span class="token operator">||</span> mFirstBoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                scanFlags <span class="token operator">=</span> scanFlags <span class="token operator">|</span> SCAN_FIRST_BOOT_OR_UPGRADE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>


            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>VENDOR_OVERLAY_DIR<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>PRODUCT_OVERLAY_DIR<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_PRODUCT<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mParallelPackageParserCallback<span class="token punctuation">.</span><span class="token function">findStaticOverlayPackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>frameworkDir<span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_NO_DEX
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> File privilegedAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"priv-app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>privilegedAppDir<span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token keyword">final</span> File systemAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>systemAppDir<span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            File privilegedVendorAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getVendorDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"priv-app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                privilegedVendorAppDir <span class="token operator">=</span> privilegedVendorAppDir<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// failed to look up canonical path, continue with original one</span>
            <span class="token punctuation">}</span>
            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>privilegedVendorAppDir<span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_VENDOR
                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Collect ordinary vendor packages.</span>
            File vendorAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getVendorDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                vendorAppDir <span class="token operator">=</span> vendorAppDir<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// failed to look up canonical path, continue with original one</span>
            <span class="token punctuation">}</span>
            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>vendorAppDir<span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            File privilegedOdmAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getOdmDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">"priv-app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                privilegedOdmAppDir <span class="token operator">=</span> privilegedOdmAppDir<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// failed to look up canonical path, continue with original one</span>
            <span class="token punctuation">}</span>
            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>privilegedOdmAppDir<span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_VENDOR
                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            File odmAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getOdmDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                odmAppDir <span class="token operator">=</span> odmAppDir<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// failed to look up canonical path, continue with original one</span>
            <span class="token punctuation">}</span>
            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>odmAppDir<span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Collect all OEM packages.</span>
            <span class="token keyword">final</span> File oemAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getOemDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>oemAppDir<span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_OEM<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            File privilegedProductAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getProductDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"priv-app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                privilegedProductAppDir <span class="token operator">=</span> privilegedProductAppDir<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// failed to look up canonical path, continue with original one</span>
            <span class="token punctuation">}</span>
            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>privilegedProductAppDir<span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_PRODUCT
                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            File productAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getProductDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                productAppDir <span class="token operator">=</span> productAppDir<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// failed to look up canonical path, continue with original one</span>
            <span class="token punctuation">}</span>
            <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>productAppDir<span class="token punctuation">,</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_PRODUCT<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解析来这一段的工作实际上就是给第三方厂商的提供的包名应用，提供的服务通过scanDirTracedLI方法，把整个包的数据解析扫描到PMS的内存。</p>
<p>这里就有如下几个大目录：</p>
<ul>
<li><p>1.mCacheDir 首先通过preparePackageParserCache方法获取当前PMS下扫描结果的缓存目录：<code>/data/system/package_cache/</code> 所有的包扫描的结果都会缓存到这里</p>
</li>
<li><p>2.<code>/vendor/overlay</code></p>
</li>
<li><p>3.<code>/product/overlay</code>  第2和第3点都是第三方厂商提供的资源复写目录</p>
</li>
<li><p>4.<code>/system/framework</code> Android系统framework层内置提供的java的核心jar包，odex等</p>
</li>
<li><p>5.<code>/system/priv-app</code>,<code>/system/app</code> ,这里面提供了Android系统或者厂商默认的系统应用</p>
</li>
<li><p>6.<code>/vendor/priv-app</code>,<code>/vendor/app</code> 这是交给硬件厂商的目录，允许他们内置内置一些系统应用服务。我之前常说的hal层，就是在这个vendor目录安装提供的。</p>
</li>
<li><p>7.<code>/odm/priv-app</code>,<code>/odm/app</code> 可以看作是vendor目录的一种延伸。</p>
</li>
</ul>
<blockquote>
<p>原始设计制造商 (ODM) 能够为其特定设备（开发板）自定义系统芯片 (SoC) 供应商板级支持包 (BSP).这样，他们就可以为板级组件、板级守护进程或者其基于硬件抽象层 (HAL) 的自有功能实现内核模块。他们可能还需要替换或自定义 SoC 组件。</p>
</blockquote>
<p>我们不是搞hal层的，没必要进一步探讨了。</p>
<ul>
<li>8.<code>/oem/app</code> ，<code>/product/priv-app</code>,<code>/product/app</code>  </li>
</ul>
<blockquote>
<p>OEM 会自定义 AOSP 系统映像，以实现自己的功能并满足运营商的要求</p>
</blockquote>
<p>product分区则是从Android 9.0开始支持的分区。oem是老版本的product分区，product可以依赖oem分区。product可以多次刷新，oem不可刷新只能出厂一次。这两个分区就是支持自定义 AOSP 系统映像，product的分区出现能够更加灵活多语言多地区的系统映像。</p>
<p>能发现每一个目录下，都调用了整个PMS最核心的方法scanDirTracedLI 对apk，jar包的解析方法。</p>
<p>scanDirTracedLI这个方法我们稍后再看，现在我们可以得知这个方法执行后，PMS就能知道安装apk包中具体的信息了，并把解析出来的PackageParser.Package对象保存在PMS全局变量mPackages中</p>
<h4 id="PMS-第四段"><a href="#PMS-第四段" class="headerlink" title="PMS 第四段"></a>PMS 第四段</h4><pre class="line-numbers language-java"><code class="language-java">
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> possiblyDeletedUpdatedSystemApps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> stubSystemApps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOnlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">final</span> Iterator<span class="token operator">&lt;</span>PackageParser<span class="token punctuation">.</span>Package<span class="token operator">></span> pkgIterator <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>pkgIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package pkg <span class="token operator">=</span> pkgIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>isStub<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        stubSystemApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">final</span> Iterator<span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span> psit <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>psit<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    PackageSetting ps <span class="token operator">=</span> psit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>pkgFlags <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package scannedPkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>scannedPkg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSettings<span class="token punctuation">.</span><span class="token function">isDisabledSystemPackageLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token function">removePackageLI</span><span class="token punctuation">(</span>scannedPkg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            mExpectingBetter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">,</span> ps<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSettings<span class="token punctuation">.</span><span class="token function">isDisabledSystemPackageLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        psit<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                        <span class="token keyword">final</span> PackageSetting disabledPs <span class="token operator">=</span>
                                mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>disabledPs<span class="token punctuation">.</span>codePath <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>disabledPs<span class="token punctuation">.</span>codePath<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">||</span> disabledPs<span class="token punctuation">.</span>pkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            possiblyDeletedUpdatedSystemApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//delete tmp files</span>
            <span class="token function">deleteTempPackageFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOnlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>sAppInstallDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scanFlags <span class="token operator">|</span> SCAN_REQUIRE_KNOWN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>sDrmAppPrivateInstallDir<span class="token punctuation">,</span> mDefParseFlags
                        <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_FORWARD_LOCK<span class="token punctuation">,</span>
                        scanFlags <span class="token operator">|</span> SCAN_REQUIRE_KNOWN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span>String deletedAppName <span class="token operator">:</span> possiblyDeletedUpdatedSystemApps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    PackageParser<span class="token punctuation">.</span>Package deletedPkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mSettings<span class="token punctuation">.</span><span class="token function">removeDisabledSystemPackageLPw</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> String msg<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>deletedPkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                        msg <span class="token operator">=</span> <span class="token string">"Updated system package + "</span> <span class="token operator">+</span> deletedAppName
                                <span class="token operator">+</span> <span class="token string">" no longer exists; revoking system privileges"</span><span class="token punctuation">;</span>


                        <span class="token keyword">final</span> PackageSetting deletedPs <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        deletedPkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">;</span>
                        deletedPs<span class="token punctuation">.</span>pkgFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>WARN<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>


                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> String packageName <span class="token operator">=</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPackages<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> File scanFile <span class="token operator">=</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>


                        <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> reparseFlags<span class="token punctuation">;</span>
                        <span class="token keyword">final</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> rescanFlags<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            reparseFlags <span class="token operator">=</span>
                                    mDefParseFlags <span class="token operator">|</span>
                                    PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                            rescanFlags <span class="token operator">=</span>
                                    scanFlags
                                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>systemAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            reparseFlags <span class="token operator">=</span>
                                    mDefParseFlags <span class="token operator">|</span>
                                    PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                            rescanFlags <span class="token operator">=</span>
                                    scanFlags
                                    <span class="token operator">|</span> SCAN_AS_SYSTEM<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedVendorAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span>
                                <span class="token operator">||</span> FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedOdmAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            reparseFlags <span class="token operator">=</span>
                                    mDefParseFlags <span class="token operator">|</span>
                                    PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                            rescanFlags <span class="token operator">=</span>
                                    scanFlags
                                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                                    <span class="token operator">|</span> SCAN_AS_VENDOR
                                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>vendorAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span>
                                <span class="token operator">||</span> FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>odmAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            reparseFlags <span class="token operator">=</span>
                                    mDefParseFlags <span class="token operator">|</span>
                                    PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                            rescanFlags <span class="token operator">=</span>
                                    scanFlags
                                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                                    <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>oemAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            reparseFlags <span class="token operator">=</span>
                                    mDefParseFlags <span class="token operator">|</span>
                                    PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                            rescanFlags <span class="token operator">=</span>
                                    scanFlags
                                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                                    <span class="token operator">|</span> SCAN_AS_OEM<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedProductAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            reparseFlags <span class="token operator">=</span>
                                    mDefParseFlags <span class="token operator">|</span>
                                    PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                            rescanFlags <span class="token operator">=</span>
                                    scanFlags
                                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                                    <span class="token operator">|</span> SCAN_AS_PRODUCT
                                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>productAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            reparseFlags <span class="token operator">=</span>
                                    mDefParseFlags <span class="token operator">|</span>
                                    PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                            rescanFlags <span class="token operator">=</span>
                                    scanFlags
                                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                                    <span class="token operator">|</span> SCAN_AS_PRODUCT<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Ignoring unexpected fallback path "</span> <span class="token operator">+</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        mSettings<span class="token punctuation">.</span><span class="token function">enableSystemPackageLPw</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token function">scanPackageTracedLI</span><span class="token punctuation">(</span>scanFile<span class="token punctuation">,</span> reparseFlags<span class="token punctuation">,</span> rescanFlags<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to parse original system package: "</span>
                                    <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token function">decompressSystemApplications</span><span class="token punctuation">(</span>stubSystemApps<span class="token punctuation">,</span> scanFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> cachedNonSystemApps <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span>sCachedPackageReadCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">-</span> cachedSystemApps<span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">long</span> dataScanTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> systemScanTime <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> dataPackagesCount <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> systemPackagesCount<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade <span class="token operator">&amp;&amp;</span> dataPackagesCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    MetricsLogger<span class="token punctuation">.</span><span class="token function">histogram</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"ota_package_manager_data_app_avg_scan_time"</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> dataScanTime<span class="token punctuation">)</span> <span class="token operator">/</span> dataPackagesCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            mExpectingBetter<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            mStorageManagerPackage <span class="token operator">=</span> <span class="token function">getStorageManagerPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            mSetupWizardPackage <span class="token operator">=</span> <span class="token function">getSetupWizardPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mProtectedFilters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span>ActivityIntentInfo filter <span class="token operator">:</span> mProtectedFilters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mSetupWizardPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    filter<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            mSystemTextClassifierPackage <span class="token operator">=</span> <span class="token function">getSystemTextClassifierPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mDeferProtectedFilters <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mProtectedFilters<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">updateAllSharedLibrariesLPw</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            mPackageUsage<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mCompilerStats<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            mPrepareAppDataFuture <span class="token operator">=</span> SystemServerInitThreadPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                TimingsTraceLog traceLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimingsTraceLog</span><span class="token punctuation">(</span><span class="token string">"SystemServerTimingAsync"</span><span class="token punctuation">,</span>
                        Trace<span class="token punctuation">.</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                traceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">"AppDataFixup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mInstaller<span class="token punctuation">.</span><span class="token function">fixupAppData</span><span class="token punctuation">(</span>StorageManager<span class="token punctuation">.</span>UUID_PRIVATE_INTERNAL<span class="token punctuation">,</span>
                            StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_DE <span class="token operator">|</span> StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_CE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstallerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Trouble fixing GIDs"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                traceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                traceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">"AppDataPrepare"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deferPackages <span class="token operator">==</span> null <span class="token operator">||</span> deferPackages<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>String pkgName <span class="token operator">:</span> deferPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    PackageParser<span class="token punctuation">.</span>Package pkg <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getPackageLPr</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> ps<span class="token punctuation">.</span><span class="token function">getInstalled</span><span class="token punctuation">(</span>UserHandle<span class="token punctuation">.</span>USER_SYSTEM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            pkg <span class="token operator">=</span> ps<span class="token punctuation">.</span>pkg<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">prepareAppDataAndMigrateLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_SYSTEM<span class="token punctuation">,</span> storageFlags<span class="token punctuation">,</span>
                                    <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* maybeMigrateAppData */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        count<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                traceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Deferred reconcileAppsData finished "</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">" packages"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"prepareAppData"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mSettings<span class="token punctuation">.</span><span class="token function">writeLPr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


            <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>PackageInfo<span class="token operator">>></span> userPackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> currentUserIds <span class="token operator">=</span> UserManagerService<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> userId <span class="token operator">:</span> currentUserIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                userPackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token function">getInstalledPackages</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/*flags*/</span> <span class="token number">0</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mDexManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>userPackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                MetricsLogger<span class="token punctuation">.</span><span class="token function">histogram</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"ota_package_manager_init_time"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// synchronized (mPackages)</span>
        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// synchronized (mInstallLock)</span>


        Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mInstaller<span class="token punctuation">.</span><span class="token function">setWarnIfHeld</span><span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.扫描所以在上面安装好系统apk等文件，查找哪些系统禁止的包名，则调用removePackageLI从缓存中移除。删除所有的临时包文件</p>
</li>
<li><p>2.接下来扫描我们应用开发最重要的2个目录：<code>/data/app</code>,<code>/data/app-private</code>.</p>
</li>
</ul>
<p><code>/data/app</code> 是app安装的路径。所有的app都会安装到这个目录下，可以进进一步的通过对应的包名找到我们的apk应用中的代码等数据。<code>/data/app-private</code>这是每一个应用存储除了代码和资源的其他私密数据。</p>
<ul>
<li><p>3.在扫描app安装目录之后，遍历possiblyDeletedUpdatedSystemApps，看看有没有那个apk是需要删除，则调用removeDisabledSystemPackageLPw 从系统配置中移除。这个possiblyDeletedUpdatedSystemApps集合就是系统设置的禁用包集合</p>
</li>
<li><p>4.扫描mExpectingBetter集合中保存的apk包。这个集合说明的是app中有更加新的版本，期望进行更新，所以会进行扫描替换原来的app应用</p>
</li>
<li><p>5.调用Settings的writeLPr方法。更新<code>package.list</code>中的安装包数据列表。</p>
</li>
<li><p>6.通过SystemServerInitThreadPool启动一个特殊的线程池，赋值为mPrepareAppDataFuture对象。执行了如下内容：</p>
<ul>
<li><p>1.调用了Installd的fixupAppData方法,创建一个<code>/data/user/用户id</code>和<code>/data/data</code>目录，这个目录由StoreManagerService进行管理。这里要和每一个应用的userId要区分开，其实是指登陆Android不同的用户。也就是我们常见的<code>/data/user/0</code>.<code>/data/user/用户id</code>是<code>/data/data</code>的软链接。不同的用户id只能访问到不同userid对应的app安装内容。可以认为其实每一个app安装的实际路径是<code>/data/user/用户ID/包名/</code>。而我们常见到的<code>/data/data/包名</code>其实是他的软连接。</p>
</li>
<li><p>2.调用prepareAppDataAndMigrateLIF方法，准备应用数据。最终会调用到prepareAppDataLeafLIF方法中：</p>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">prepareAppDataLeafLIF</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ceDataInode <span class="token operator">=</span> mInstaller<span class="token punctuation">.</span><span class="token function">createAppData</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">,</span> packageName<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                    appId<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span> app<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstallerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade <span class="token operator">||</span> mFirstBoot <span class="token operator">||</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> UserHandle<span class="token punctuation">.</span>USER_SYSTEM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mArtManagerService<span class="token punctuation">.</span><span class="token function">prepareAppProfiles</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">prepareAppDataContentsLeafLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.Installer的createAppData 实际上就是遍历所有的包名，为每一个包名创建一个<code>cache</code>以及<code>code_cache</code>的目录，用于缓存编译优化后的结果。</p>
<ul>
<li>2.prepareAppProfiles，这个方法最后调用了IInstalld的prepareAppProfile方法，并且调用保存在<code>/system/bin/profman</code> 这个程序，在程序目录下生成一个<code>.prof</code>文件，这个文件可以加速dex2oat编译优化的速度。</li>
</ul>
</li>
</ul>
<ul>
<li>3.prepareAppDataContentsLeafLIF 核心就是调用了IInstalld的linkNativeLibraryDirectory。其实就是把app的安装so库的目录<code>/data/data/包名/lib</code>和<code>/data/user/用户id/包名/lib</code>链接上。</li>
</ul>
<ul>
<li>7.初始化数据存储服务，InstantApp的扫描，以及让DexManager检查持有每一个分配了用户id的应用的代码路径，保存在PackageDexUsage中。</li>
</ul>
<p>到这里PMS的实例化，大体上都过了一遍，能看到实际上PMS就是在引导时候，把所有之后Android需要使用的代码包都进行了扫描，并且加载了所有包的配置等文件。其中扫描最为重要，扫描核心方法就是scanDirTracedLI。</p>
<p>暂且放一放，我们继续走PMS初始化流程，我们最后回头看看这个方法都做了什么？</p>
<h3 id="PMS-updatePackagesIfNeeded"><a href="#PMS-updatePackagesIfNeeded" class="headerlink" title="PMS updatePackagesIfNeeded"></a>PMS updatePackagesIfNeeded</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updatePackagesIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enforceSystemOrRoot</span><span class="token punctuation">(</span><span class="token string">"Only the system can request package update"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">boolean</span> causeUpgrade <span class="token operator">=</span> <span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">boolean</span> causeFirstBoot <span class="token operator">=</span> <span class="token function">isFirstBoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> mIsPreNUpgrade<span class="token punctuation">;</span>


        <span class="token keyword">boolean</span> causePrunedCache <span class="token operator">=</span> VMRuntime<span class="token punctuation">.</span><span class="token function">didPruneDalvikCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>causeUpgrade <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>causeFirstBoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>causePrunedCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        List<span class="token operator">&lt;</span>PackageParser<span class="token punctuation">.</span>Package<span class="token operator">></span> pkgs<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pkgs <span class="token operator">=</span> PackageManagerServiceUtils<span class="token punctuation">.</span><span class="token function">getPackagesForDexopt</span><span class="token punctuation">(</span>mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">long</span> startTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> stats <span class="token operator">=</span> <span class="token function">performDexOptUpgrade</span><span class="token punctuation">(</span>pkgs<span class="token punctuation">,</span> mIsPreNUpgrade <span class="token comment" spellcheck="true">/* showDialog */</span><span class="token punctuation">,</span>
                    causeFirstBoot <span class="token operator">?</span> REASON_FIRST_BOOT <span class="token operator">:</span> REASON_BOOT<span class="token punctuation">,</span>
                    <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* bootComplete */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面做了两件事情：</p>
<ul>
<li><p>1.PackageManagerServiceUtils的getPackagesForDexopt方法，对需要在开机时候进行dexopt优化的apk包进行优化。此时会对PMS有一个dex优化的优先级顺序，其顺序依次为：</p>
<ul>
<li>1.coreApp 也就是系统核心app服务的包最早进行优化</li>
<li>2.其次是哪些需要接受<code>Intent.ACTION_PRE_BOOT_COMPLETED</code>的广播接受者对应的apk包</li>
<li>3.还有被前两种apk依赖的代码 apk包</li>
</ul>
</li>
<li><p>2.最终循环调用performDexOptUpgrade。其中PackageDexOptimizer对象的performDexOpt方法。这个方法最终会调用Installer的dexopt方法，通知Intsalld服务，也是一个Binder对象，跨进程通信到Intsalld服务执行dexopt，对dex文件进行优化</p>
</li>
</ul>
<p>更加详细的超出本文讨论范围，之后有空在聊dex2oat的时候一起聊了。</p>
<h3 id="PMS-performFstrimIfNeeded"><a href="#PMS-performFstrimIfNeeded" class="headerlink" title="PMS performFstrimIfNeeded"></a>PMS performFstrimIfNeeded</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performFstrimIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enforceSystemOrRoot</span><span class="token punctuation">(</span><span class="token string">"Only the system can request fstrim"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            IStorageManager sm <span class="token operator">=</span> PackageHelper<span class="token punctuation">.</span><span class="token function">getStorageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> doTrim <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> interval <span class="token operator">=</span> android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>Settings<span class="token punctuation">.</span>Global<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>
                        mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>Settings<span class="token punctuation">.</span>Global<span class="token punctuation">.</span>FSTRIM_MANDATORY_INTERVAL<span class="token punctuation">,</span>
                        DEFAULT_MANDATORY_FSTRIM_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>interval <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> timeSinceLast <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sm<span class="token punctuation">.</span><span class="token function">lastMaintenance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeSinceLast <span class="token operator">></span> interval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        doTrim <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>doTrim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">boolean</span> dexOptDialogShown<span class="token punctuation">;</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        dexOptDialogShown <span class="token operator">=</span> mDexOptDialogShown<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFirstBoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dexOptDialogShown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">showBootMessage</span><span class="token punctuation">(</span>
                                    mContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>
                                            R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>android_upgrading_fstrim<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    sm<span class="token punctuation">.</span><span class="token function">runMaintenance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里只做了一件事情：获取StorageManagerService对象，判断此时的时间和上一次操作Android系统的存储磁盘最晚的时间差是多少。默认是超过了3天，则调用StorageManagerService的runMaintenance方法，删除哪些不再有效的数据(注意在操作系统中，文件删除不是立即从磁盘中删除，而是把磁盘中的block中的数据，打上一个标记允许其他数据覆盖)。 之后有机会，会在Linux内核中和大家聊聊整个Linux如何管理磁盘的。</p>
<h3 id="PMS-systemReady"><a href="#PMS-systemReady" class="headerlink" title="PMS systemReady"></a>PMS systemReady</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enforceSystemOrRoot</span><span class="token punctuation">(</span><span class="token string">"Only the system can claim the system is ready"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mSystemReady <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ContentResolver resolver <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ContentObserver co <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContentObserver</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onChange</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> selfChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mWebInstantAppsDisabled <span class="token operator">=</span>
                        <span class="token punctuation">(</span>Global<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>resolver<span class="token punctuation">,</span> Global<span class="token punctuation">.</span>ENABLE_EPHEMERAL_FEATURE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                                <span class="token punctuation">(</span>Secure<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>resolver<span class="token punctuation">,</span> Secure<span class="token punctuation">.</span>INSTANT_APPS_ENABLED<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerContentObserver</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>Settings<span class="token punctuation">.</span>Global
                        <span class="token punctuation">.</span><span class="token function">getUriFor</span><span class="token punctuation">(</span>Global<span class="token punctuation">.</span>ENABLE_EPHEMERAL_FEATURE<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token boolean">false</span><span class="token punctuation">,</span> co<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_SYSTEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerContentObserver</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>Settings<span class="token punctuation">.</span>Secure
                        <span class="token punctuation">.</span><span class="token function">getUriFor</span><span class="token punctuation">(</span>Secure<span class="token punctuation">.</span>INSTANT_APPS_ENABLED<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> co<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_SYSTEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        co<span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        sUserManager<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// If we upgraded grant all default permissions before kicking off.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> userId <span class="token operator">:</span> grantPermissionsUserIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mDefaultPermissionPolicy<span class="token punctuation">.</span><span class="token function">grantDefaultPermissions</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>grantPermissionsUserIds <span class="token operator">==</span> EMPTY_INT_ARRAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
mDefaultPermissionPolicy<span class="token punctuation">.</span><span class="token function">scheduleReadDefaultPermissionExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPermissionManager<span class="token punctuation">.</span><span class="token function">updateAllPermissions</span><span class="token punctuation">(</span>
                    StorageManager<span class="token punctuation">.</span>UUID_PRIVATE_INTERNAL<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mPermissionCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Kick off any messages waiting for system ready</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPostSystemReadyMessages <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Message msg <span class="token operator">:</span> mPostSystemReadyMessages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                msg<span class="token punctuation">.</span><span class="token function">sendToTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mPostSystemReadyMessages <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Watch for external volumes that come and go over time</span>
        <span class="token keyword">final</span> StorageManager storage <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>StorageManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        storage<span class="token punctuation">.</span><span class="token function">registerListener</span><span class="token punctuation">(</span>mStorageListener<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mInstallerService<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDexManager<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPackageDexOptimizer<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        StorageManagerInternal StorageManagerInternal <span class="token operator">=</span> LocalServices<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>
                StorageManagerInternal<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        StorageManagerInternal<span class="token punctuation">.</span><span class="token function">addExternalStoragePolicy</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">StorageManagerInternal<span class="token punctuation">.</span>ExternalStorageMountPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMountMode</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span> String packageName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Process<span class="token punctuation">.</span><span class="token function">isIsolated</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> Zygote<span class="token punctuation">.</span>MOUNT_EXTERNAL_NONE<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkUidPermission</span><span class="token punctuation">(</span>READ_EXTERNAL_STORAGE<span class="token punctuation">,</span> uid<span class="token punctuation">)</span> <span class="token operator">==</span> PERMISSION_DENIED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> Zygote<span class="token punctuation">.</span>MOUNT_EXTERNAL_DEFAULT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkUidPermission</span><span class="token punctuation">(</span>WRITE_EXTERNAL_STORAGE<span class="token punctuation">,</span> uid<span class="token punctuation">)</span> <span class="token operator">==</span> PERMISSION_DENIED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> Zygote<span class="token punctuation">.</span>MOUNT_EXTERNAL_READ<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> Zygote<span class="token punctuation">.</span>MOUNT_EXTERNAL_WRITE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasExternalStorage</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span> String packageName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Now that we're mostly running, clean up stale users and apps</span>
        sUserManager<span class="token punctuation">.</span><span class="token function">reconcileUsers</span><span class="token punctuation">(</span>StorageManager<span class="token punctuation">.</span>UUID_PRIVATE_INTERNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reconcileApps</span><span class="token punctuation">(</span>StorageManager<span class="token punctuation">.</span>UUID_PRIVATE_INTERNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mPermissionManager<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstantAppResolverConnection <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mContext<span class="token punctuation">.</span><span class="token function">registerReceiver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BroadcastReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mInstantAppResolverConnection<span class="token punctuation">.</span><span class="token function">optimisticBind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mContext<span class="token punctuation">.</span><span class="token function">unregisterReceiver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_BOOT_COMPLETED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.设置了两个两个CP组件的数据变化监听者，分别是<code>Global.ENABLE_EPHEMERAL_FEATURE</code>以及<code>Secure.INSTANT_APPS_ENABLED</code>  </li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String ENABLE_EPHEMERAL_FEATURE <span class="token operator">=</span> <span class="token string">"enable_ephemeral_feature"</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String INSTANT_APPS_ENABLED <span class="token operator">=</span> <span class="token string">"instant_apps_enabled"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这两个标志位共同决定了mWebInstantAppsDisabled 也就是Web的InstantApp是否可以生效。</p>
<ul>
<li><p>2.调用UserManager的systemReady</p>
</li>
<li><p>3.注册了StorageManager的监听</p>
</li>
<li><p>4.PackageInstallerService 的systemReady</p>
</li>
<li><p>5.DexManager的systemReady</p>
</li>
<li><p>6.PackageDexOptimizer的systemReady</p>
</li>
<li><p>7.PermissionManagerService的systemReady</p>
</li>
<li><p>8.注册一个<code>Intent.ACTION_BOOT_COMPLETED</code> 系统系统启动完成的广播</p>
</li>
</ul>
<h3 id="PMS-waitForAppDataPrepared"><a href="#PMS-waitForAppDataPrepared" class="headerlink" title="PMS waitForAppDataPrepared"></a>PMS waitForAppDataPrepared</h3><p>当AMS调用了systemReady之后，说明Android系统其实可以启动第一个App也就是桌面应用了，但是此时会调用waitForAppDataPrepared等待PMS的一些事务完成。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">waitForAppDataPrepared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPrepareAppDataFuture <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ConcurrentUtils<span class="token punctuation">.</span><span class="token function">waitForFutureNoInterrupt</span><span class="token punctuation">(</span>mPrepareAppDataFuture<span class="token punctuation">,</span> <span class="token string">"wait for prepareAppData"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPrepareAppDataFuture <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实就是等待mPrepareAppDataFuture的完成。而这个对象在PMS的实例化小结聊过，其实就是为每一个应用包创建对应的软连接和目录。</p>
<h3 id="PMS-scanDirTracedLI-扫描应用的原理"><a href="#PMS-scanDirTracedLI-扫描应用的原理" class="headerlink" title="PMS scanDirTracedLI 扫描应用的原理"></a>PMS scanDirTracedLI 扫描应用的原理</h3><p>对于PMS的启动有了一个总体的概括之后，我们来看看PMS中最为的核心方法没有之一的scanDirTracedLI中做了什么？怎么解析apk包的。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scanDirLI</span><span class="token punctuation">(</span>File scanDir<span class="token punctuation">,</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> scanDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">(</span>ParallelPackageParser parallelPackageParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParallelPackageParser</span><span class="token punctuation">(</span>
                mSeparateProcesses<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">,</span> mMetrics<span class="token punctuation">,</span> mCacheDir<span class="token punctuation">,</span>
                mParallelPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Submit files for parsing in parallel</span>
            <span class="token keyword">int</span> fileCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPackage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">isApkFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>PackageInstallerService<span class="token punctuation">.</span><span class="token function">isStageName</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isPackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Ignore entries which are not packages</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                parallelPackageParser<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fileCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> fileCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> fileCount<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ParallelPackageParser<span class="token punctuation">.</span>ParseResult parseResult <span class="token operator">=</span> parallelPackageParser<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Throwable throwable <span class="token operator">=</span> parseResult<span class="token punctuation">.</span>throwable<span class="token punctuation">;</span>
                <span class="token keyword">int</span> errorCode <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isStaticSharedLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">renameStaticSharedLibraryPackage</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                                    currentTime<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token keyword">instanceof</span> <span class="token class-name">PackageParser<span class="token punctuation">.</span>PackageParserException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    PackageParser<span class="token punctuation">.</span>PackageParserException e <span class="token operator">=</span> <span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>PackageParserException<span class="token punctuation">)</span>
                            throwable<span class="token punctuation">;</span>
                    errorCode <span class="token operator">=</span> e<span class="token punctuation">.</span>error<span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// Delete invalid userdata apps</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_AS_SYSTEM<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                        errorCode <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">removeCodePathLI</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>scanFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>把mCacheDir作为参数，构造了一个ParallelPackageParser 并行执行的包解析器。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ParallelPackageParser</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> QUEUE_CAPACITY <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_THREADS <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> mSeparateProcesses<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> mOnlyCore<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> DisplayMetrics mMetrics<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> File mCacheDir<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Callback mPackageParserCallback<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">volatile</span> String mInterruptedInThread<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> BlockingQueue<span class="token operator">&lt;</span>ParseResult<span class="token operator">></span> mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>QUEUE_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> ExecutorService mService <span class="token operator">=</span> ConcurrentUtils<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>MAX_THREADS<span class="token punctuation">,</span>
          <span class="token string">"package-parsing-thread"</span><span class="token punctuation">,</span> Process<span class="token punctuation">.</span>THREAD_PRIORITY_FOREGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">ParallelPackageParser</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> separateProcesses<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCoreApps<span class="token punctuation">,</span>
          DisplayMetrics metrics<span class="token punctuation">,</span> File cacheDir<span class="token punctuation">,</span> PackageParser<span class="token punctuation">.</span>Callback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mSeparateProcesses <span class="token operator">=</span> separateProcesses<span class="token punctuation">;</span>
      mOnlyCore <span class="token operator">=</span> onlyCoreApps<span class="token punctuation">;</span>
      mMetrics <span class="token operator">=</span> metrics<span class="token punctuation">;</span>
      mCacheDir <span class="token operator">=</span> cacheDir<span class="token punctuation">;</span>
      mPackageParserCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在ParallelPackageParser中存在一个名字为<code>package-parsing-thread</code>的线程池，而这个线程吃最大并行数量为4.以及一个ArrayBlockingQueue，这个同步阻塞队列大小为10.</p>
</li>
<li><p>2.遍历该目录所有的文件，如果判断是可以进行解析的apk包，则调用submit方法，为ParallelPackageParser提交一个解析任务。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submit</span><span class="token punctuation">(</span>File scanFile<span class="token punctuation">,</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
          ParseResult pr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParseResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              pp<span class="token punctuation">.</span><span class="token function">setSeparateProcesses</span><span class="token punctuation">(</span>mSeparateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>
              pp<span class="token punctuation">.</span><span class="token function">setOnlyCoreApps</span><span class="token punctuation">(</span>mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>
              pp<span class="token punctuation">.</span><span class="token function">setDisplayMetrics</span><span class="token punctuation">(</span>mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
              pp<span class="token punctuation">.</span><span class="token function">setCacheDir</span><span class="token punctuation">(</span>mCacheDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
              pp<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>mPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
              pr<span class="token punctuation">.</span>scanFile <span class="token operator">=</span> scanFile<span class="token punctuation">;</span>
              pr<span class="token punctuation">.</span>pkg <span class="token operator">=</span> <span class="token function">parsePackage</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> scanFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              mQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pr<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当在线程中开始执行的时候，就会实例化一个新的PackageParser对象，并且调用parsePackage方法执行解析，最后把解析的结果放在ArrayBlockingQueue中，等待获取。ArrayBlockingQueue这个队列很简单，就是一个生产者消费者模式，当没数据想取出的时候会被阻塞，等到数据加入后唤醒。当想要放入任务进行消费，但是满了，就会阻塞不允许放入任务。</p>
</li>
</ul>
<p>而parsePackage方法会调用PackageParser.parsePackage.</p>
<h4 id="PackageParser-parsePackage"><a href="#PackageParser-parsePackage" class="headerlink" title="PackageParser parsePackage"></a>PackageParser parsePackage</h4><p>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/pm/" target="_blank" rel="noopener">pm</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/pm/PackageParser.java" target="_blank" rel="noopener">PackageParser.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> Package <span class="token function">parsePackage</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useCaches<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>
        Package parsed <span class="token operator">=</span> useCaches <span class="token operator">?</span> <span class="token function">getCachedResult</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> parsed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageFile<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parsed <span class="token operator">=</span> <span class="token function">parseClusterPackage</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            parsed <span class="token operator">=</span> <span class="token function">parseMonolithicPackage</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">long</span> cacheTime <span class="token operator">=</span> LOG_PARSE_TIMINGS <span class="token operator">?</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">cacheResult</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> parsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> parsed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.首先尝试的通过getCachedResult获取是否已经有解析好的缓存数据，有则直接返回Package</li>
<li>2.没有缓存，则判断当前的packageFile是文件夹还是文件：<ul>
<li>1.是文件夹则调用parseClusterPackage方法</li>
<li>2.是文件则调用parseMonolithicPackage方法</li>
</ul>
</li>
<li>3.最后通过cacheResult 缓存下来。</li>
</ul>
<p>我们先跳过缓存的逻辑看看PackageParser是怎么解析的。由于一般存在<code>data/app</code>下都是一个apk文件，所以我们以parseMonolithicPackage为例子</p>
<h5 id="PackageParser-parseMonolithicPackage"><a href="#PackageParser-parseMonolithicPackage" class="headerlink" title="PackageParser parseMonolithicPackage"></a>PackageParser parseMonolithicPackage</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> Package <span class="token function">parseMonolithicPackage</span><span class="token punctuation">(</span>File apkFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> PackageLite lite <span class="token operator">=</span> <span class="token function">parseMonolithicPackageLite</span><span class="token punctuation">(</span>apkFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> SplitAssetLoader assetLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSplitAssetLoader</span><span class="token punctuation">(</span>lite<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>apkFile<span class="token punctuation">,</span> assetLoader<span class="token punctuation">.</span><span class="token function">getBaseAssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setCodePath</span><span class="token punctuation">(</span>apkFile<span class="token punctuation">.</span><span class="token function">getCanonicalPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setUse32bitAbi</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>use32bitAbi<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>assetLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先构造一个DefaultSplitAssetLoader对象，这个对象实际上就是通过ApkAssets进行解析，并获取AssetsManager对象。关于AssetsManager相关的原理可以阅读<a href="https://www.jianshu.com/p/817a787910f2" target="_blank" rel="noopener"> 资源管理系统系列文章</a>。</p>
<p>调用parseBaseApk解析apk.</p>
<h5 id="PackageParser-parseBaseApk"><a href="#PackageParser-parseBaseApk" class="headerlink" title="PackageParser parseBaseApk"></a>PackageParser parseBaseApk</h5><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String ANDROID_MANIFEST_FILENAME <span class="token operator">=</span> <span class="token string">"AndroidManifest.xml"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> Package <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>File apkFile<span class="token punctuation">,</span> AssetManager assets<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> String apkPath <span class="token operator">=</span> apkFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String volumeUuid <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>apkPath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>MNT_EXPAND<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> end <span class="token operator">=</span> apkPath<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> MNT_EXPAND<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            volumeUuid <span class="token operator">=</span> apkPath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>MNT_EXPAND<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>
        mArchiveSourcePath <span class="token operator">=</span> apkFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        XmlResourceParser parser <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> cookie <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">findCookieForPath</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            parser <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">openXmlResourceParser</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> ANDROID_MANIFEST_FILENAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Resources res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resources</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> mMetrics<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            pkg<span class="token punctuation">.</span><span class="token function">setVolumeUuid</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setApplicationVolumeUuid</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setBaseCodePath</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setSigningDetails</span><span class="token punctuation">(</span>SigningDetails<span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，就是通过findCookieForPath找到apk缓存对应的cookieId，并以此为索引，调用AssetManager.openXmlResourceParser方法，打开AndroidManifest.xml的流，等待后面parseBaseApk的解析</p>
<h5 id="parseBaseApk"><a href="#parseBaseApk" class="headerlink" title="parseBaseApk"></a>parseBaseApk</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> Package <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>String apkPath<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span> XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span> <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> String splitName<span class="token punctuation">;</span>
        <span class="token keyword">final</span> String pkgName<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Pair<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> packageSplit <span class="token operator">=</span> <span class="token function">parsePackageSplitNames</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkgName <span class="token operator">=</span> packageSplit<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
            splitName <span class="token operator">=</span> packageSplit<span class="token punctuation">.</span>second<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>splitName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> overlayPaths <span class="token operator">=</span> mCallback<span class="token punctuation">.</span><span class="token function">getOverlayPaths</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span> apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>overlayPaths <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> overlayPaths<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>String overlayPath <span class="token operator">:</span> overlayPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    res<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addOverlayPath</span><span class="token punctuation">(</span>overlayPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        TypedArray sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest<span class="token punctuation">)</span><span class="token punctuation">;</span>

        pkg<span class="token punctuation">.</span>mVersionCode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_versionCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span>mVersionCodeMajor <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_versionCodeMajor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">setVersionCode</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span><span class="token function">getLongVersionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span>baseRevisionCode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_revisionCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_versionName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mVersionName<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pkg<span class="token punctuation">.</span>coreApp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeBooleanValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"coreApp"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        pkg<span class="token punctuation">.</span>mCompileSdkVersion <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_compileSdkVersion<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>compileSdkVersion <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mCompileSdkVersion<span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_compileSdkVersionCodename<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>compileSdkVersionCodename <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename<span class="token punctuation">;</span>

        sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">parseBaseApkCommon</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> null<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.生成Package对象，获取包名以及<split> 标签做的AndroidManifest分割部分(这种很少用，其实就是bundle模块，允许动态切割资源和包，分配提交市场)。</split></p>
</li>
<li><p>2.从<code>AndroidManifest</code>解析出版本名，版本号等常用参数设置到App应用中。</p>
</li>
<li><p>3.parseBaseApkCommon进行解析Application标签，uses-permission等同等级数据。</p>
<pre class="line-numbers language-java"><code class="language-java">          <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_APPLICATION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>foundApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>RIGID_PARSER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"&lt;manifest> has more than one &lt;application>"</span><span class="token punctuation">;</span>
                      mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                      <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"&lt;manifest> has more than one &lt;application>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">continue</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>

              foundApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parseBaseApplication</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> null<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里进行了Application数目的校验，只允许一个存在。接着开始解析parseBaseApplication中的组件信息。</p>
</li>
</ul>
<h6 id="parseBaseApplication"><a href="#parseBaseApplication" class="headerlink" title="parseBaseApplication"></a>parseBaseApplication</h6><p>这个方法很长，解析所有在Application标签的参数，我们重点关注四大组件是如何解析的</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseBaseApplication</span><span class="token punctuation">(</span>Package owner<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span>
            XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> ApplicationInfo ai <span class="token operator">=</span> owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">;</span>
        <span class="token keyword">final</span> String pkgName <span class="token operator">=</span> owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>

        TypedArray sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> innerDepth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>TEXT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            String tagName <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Activity a <span class="token operator">=</span> <span class="token function">parseActivity</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        owner<span class="token punctuation">.</span>baseHardwareAccelerated<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                hasActivityOrder <span class="token operator">|=</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>order <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                owner<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"receiver"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Activity a <span class="token operator">=</span> <span class="token function">parseActivity</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">,</span>
                        <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                hasReceiverOrder <span class="token operator">|=</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>order <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                owner<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"service"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Service s <span class="token operator">=</span> <span class="token function">parseService</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                hasServiceOrder <span class="token operator">|=</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>order <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                owner<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"provider"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Provider p <span class="token operator">=</span> <span class="token function">parseProvider</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                owner<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.解析<code>activity</code>标签：parseActivity解析出了一个Activity对象，保存到Package的activities集合中</li>
<li>2.解析<code>receiver</code>标签: 还是调用parseActivity方法，解析了一个Activity，保存到Package的receivers集合中</li>
<li>3.解析<code>service</code>标签: 调用了parseService方法，解析出了Service，保存到Package的services集合中</li>
<li>4.解析<code>provider</code>标签: 调用了parseProvider方法，解析出了Provider，保存到Package的providers集合中</li>
</ul>
<p>这四个方法没什么好说的，都是很简单的解析xml中的内容，接着设置到了对应的结构对象中并返回。</p>
<h4 id="PackageParser缓存原理"><a href="#PackageParser缓存原理" class="headerlink" title="PackageParser缓存原理"></a>PackageParser缓存原理</h4><p>每一次解析完成之前都会有进行缓存校验和获取。因为每一次解析apk包中的  <code>AndroidManifest.xml</code>确实比较耗时。</p>
<p>获取和存储分别由两个方法完成：</p>
<pre class="line-numbers language-java"><code class="language-java">Package parsed <span class="token operator">=</span> useCaches <span class="token operator">?</span> <span class="token function">getCachedResult</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token function">cacheResult</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> parsed<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们先来看看cacheResult是怎么存储的。</p>
<h5 id="PackageParser-cacheResult"><a href="#PackageParser-cacheResult" class="headerlink" title="PackageParser cacheResult"></a>PackageParser cacheResult</h5><pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">private</span> String <span class="token function">getCacheKey</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cacheResult</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> Package parsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCacheDir <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> String cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> File cacheFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mCacheDir<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cacheEntry <span class="token operator">=</span> <span class="token function">toCacheEntry</span><span class="token punctuation">(</span>parsed<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheEntry <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">(</span>FileOutputStream fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>cacheFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>cacheEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cacheFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Error saving package cache."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>通过getCacheKey构建出来的key为<code>包名_flag</code>,也就是<code>包名_0</code>，并在<code>/data/system/package_cache/</code>生成一个对应的文件，也就是<code>/data/system/package_cache/包名_0</code>.</p>
</li>
<li><p>通过toCacheEntry方法，获取获取Package所有的内容，如果为空则返回。</p>
</li>
<li><p>不为空，则通过FileOutputStream把Package存储好的二进制数据全部写到<code>/data/system/package_cache/包名_0</code>文件中。</p>
</li>
</ul>
<p>toCacheEntry系统如何快速获取该文件中所有的内容呢？</p>
<h5 id="toCacheEntry"><a href="#toCacheEntry" class="headerlink" title="toCacheEntry"></a>toCacheEntry</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">toCacheEntry</span><span class="token punctuation">(</span>Package pkg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">toCacheEntryStatic</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/** static version of {@link #toCacheEntry} for unit tests. */</span>
    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">toCacheEntryStatic</span><span class="token punctuation">(</span>Package pkg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> Parcel p <span class="token operator">=</span> Parcel<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> WriteHelper helper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteHelper</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

        pkg<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/* flags */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        helper<span class="token punctuation">.</span><span class="token function">finishAndUninstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serialized <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">marshall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> serialized<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很有趣：</p>
<ul>
<li><p>1.就是通过Parcel，把package写入到Parcel中。</p>
</li>
<li><p>2.调用了WriteHelper的finishAndUninstall方法。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WriteHelper</span> <span class="token keyword">extends</span> <span class="token class-name">Parcel<span class="token punctuation">.</span>ReadWriteHelper</span> <span class="token punctuation">{</span>
      <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">></span> mStrings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> mIndexes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> Parcel mParcel<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> mStartPos<span class="token punctuation">;</span>

      <span class="token keyword">public</span> <span class="token function">WriteHelper</span><span class="token punctuation">(</span>Parcel p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          mParcel <span class="token operator">=</span> p<span class="token punctuation">;</span>
          mStartPos <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">dataPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          mParcel<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// We come back later here and write the pool position.</span>

          mParcel<span class="token punctuation">.</span><span class="token function">setReadWriteHelper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeString</span><span class="token punctuation">(</span>Parcel p<span class="token punctuation">,</span> String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">final</span> Integer cur <span class="token operator">=</span> mIndexes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">// String already in the pool. Just write the index.</span>
              p<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Already in the pool.</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Duplicate '"</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">"' at "</span> <span class="token operator">+</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> mStrings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              mIndexes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
              mStrings<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

              p<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">finishAndUninstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// Uninstall first, so that writeStringList() uses the native writeString.</span>
          mParcel<span class="token punctuation">.</span><span class="token function">setReadWriteHelper</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">final</span> <span class="token keyword">int</span> poolPosition <span class="token operator">=</span> mParcel<span class="token punctuation">.</span><span class="token function">dataPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          mParcel<span class="token punctuation">.</span><span class="token function">writeStringList</span><span class="token punctuation">(</span>mStrings<span class="token punctuation">)</span><span class="token punctuation">;</span>

          mParcel<span class="token punctuation">.</span><span class="token function">setDataPosition</span><span class="token punctuation">(</span>mStartPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
          mParcel<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>poolPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>

          mParcel<span class="token punctuation">.</span><span class="token function">setDataPosition</span><span class="token punctuation">(</span>mParcel<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Wrote "</span> <span class="token operator">+</span> mStrings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" strings"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>注意因为这里设置了setReadWriteHelper。在Package对象中调用writeToParcel全是writeString，此时调用的是WriteHelper的writeString。所有的数据都将写入到mStrings中。此时调用finishAndUninstall，把list中所有的String统一写入到Parcel中。</p>
<ul>
<li><p>3.调用了Parcel的marshall方法,核心方法如下</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">static</span> jbyteArray <span class="token function">android_os_Parcel_marshall</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass clazz<span class="token punctuation">,</span> jlong nativePtr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  Parcel<span class="token operator">*</span> parcel <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>Parcel<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>nativePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parcel <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  jbyteArray ret <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewByteArray</span><span class="token punctuation">(</span>parcel<span class="token operator">-</span><span class="token operator">></span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> NULL<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
      jbyte<span class="token operator">*</span> array <span class="token operator">=</span> <span class="token punctuation">(</span>jbyte<span class="token operator">*</span><span class="token punctuation">)</span>env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetPrimitiveArrayCritical</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>array <span class="token operator">!=</span> NULL<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
          <span class="token function">memcpy</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> parcel<span class="token operator">-</span><span class="token operator">></span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parcel<span class="token operator">-</span><span class="token operator">></span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          env<span class="token operator">-</span><span class="token operator">></span><span class="token function">ReleasePrimitiveArrayCritical</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> array<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>就是在jni中通过memcpy，把数据全部拷贝到java层并返回。</p>
</li>
</ul>
<p>同理，我们来看看PackageParser是怎么读取数据的。</p>
<h4 id="PackageParser-getCachedResult"><a href="#PackageParser-getCachedResult" class="headerlink" title="PackageParser getCachedResult"></a>PackageParser getCachedResult</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> Package <span class="token function">getCachedResult</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCacheDir <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> String cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> File cacheFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mCacheDir<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isCacheUpToDate</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> cacheFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> IoUtils<span class="token punctuation">.</span><span class="token function">readFileAsByteArray</span><span class="token punctuation">(</span>cacheFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Package p <span class="token operator">=</span> <span class="token function">fromCacheEntry</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> overlayApks <span class="token operator">=</span> mCallback<span class="token punctuation">.</span><span class="token function">getOverlayApks</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>overlayApks <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> overlayApks<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>String overlayApk <span class="token operator">:</span> overlayApks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// If a static RRO is updated, return null.</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isCacheUpToDate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>overlayApk<span class="token punctuation">)</span><span class="token punctuation">,</span> cacheFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            cacheFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.能看到同样是构造了<code>/data/system/package_cache/包名_0</code>文件</p>
</li>
<li><p>2.isCacheUpToDate 判断当前的缓存文件是否过期了。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isCacheUpToDate</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> File cacheFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>

          <span class="token keyword">final</span> StructStat pkg <span class="token operator">=</span> android<span class="token punctuation">.</span>system<span class="token punctuation">.</span>Os<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">final</span> StructStat cache <span class="token operator">=</span> android<span class="token punctuation">.</span>system<span class="token punctuation">.</span>Os<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>cacheFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> pkg<span class="token punctuation">.</span>st_mtime <span class="token operator">&lt;</span> cache<span class="token punctuation">.</span>st_mtime<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ee<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>ee<span class="token punctuation">.</span>errno <span class="token operator">!=</span> OsConstants<span class="token punctuation">.</span>ENOENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token string">"Error while stating package cache : "</span><span class="token punctuation">,</span> ee<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>很简单，就是检查apk本身安装的时间，和缓存本身的时间哪个更加老。如果缓存更新。，说明当前的缓存有效。更老了，说明apk版本安装更新了，需要重新读取了</p>
<ul>
<li>3.readFileAsByteArray 读取文件中所有的内容，并调用fromCacheEntry方法逆向转化为package对象。接着检查overlayapk的的时效和当前的缓存相比较。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到这里就把PMS的启动原理大体上和大家聊完了。老规矩，先上时序图<br><img src="/images/PMS%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png" alt="PMS启动流程.png"></p>
<p>在PMS初始化中做了如下的事情：</p>
<ul>
<li>1.实例化Settings PMS的配置对象，内含<code>packages.list</code>和<code>packages.xml</code>.<ul>
<li>1.1.<code>packages.list</code>记录了Android系统中安装的应用列表以及对应的userID</li>
<li>2.2.<code>packages.xml</code>记录了每一个安装包的名字，代码路径，so路径，签名等信息</li>
</ul>
</li>
</ul>
<ul>
<li><p>2.对整个Android系统进行分区，扫描分区中所有的尝试提供的服务以及App安装的包，分为如下区域</p>
</li>
<li><p>2.1.<code>/data/system/package_cache/</code> 所有的包扫描的结果都会缓存到这里,每一个结果的缓存为<code>/data/system/package_cache/包名_0</code></p>
<ul>
<li><p>2.2.<code>/vendor/overlay</code></p>
</li>
<li><p>2.3.<code>/product/overlay</code>  第2和第3点都是第三方厂商提供的资源复写目录</p>
</li>
<li><p>2.4.<code>/system/framework</code> Android系统framework层内置提供的java的核心jar包，odex等</p>
</li>
<li><p>2.5.<code>/system/priv-app</code>,<code>/system/app</code> ,这里面提供了Android系统或者厂商默认的系统应用</p>
</li>
<li><p>2.6.<code>/vendor/priv-app</code>,<code>/vendor/app</code> 这是交给硬件厂商的目录，允许他们内置内置一些系统应用服务。我之前常说的hal层，就是在这个vendor目录安装提供的。</p>
</li>
<li><p>2.7.<code>/odm/priv-app</code>,<code>/odm/app</code> 可以看作是vendor目录的一种延伸。</p>
</li>
<li><p>2.8.<code>/oem/app</code> ，<code>/product/priv-app</code>,<code>/product/app</code>  </p>
</li>
<li><p>2.9.<code>/data/app</code>,<code>/data/app-private</code>.所有的应用apk对象都会拷贝到<code>/data/app</code></p>
</li>
<li><p>2.10.通过Installd. fixupAppData 在<code>/data/user/用户ID/包名/</code>下构造每一个安装后真正的数据保存路径，并把这个目录链接到<code>/data/data/包名</code>中</p>
</li>
<li><p>2.11.Installd.createAppData  为每一个包名下创建<code>/data/user/用户ID/包名/cache</code> 或<code>/data/user/用户ID/包名/code_cache</code>.用于缓存安装过程中编译优化好的文件，如art，odex，vdex,dex等等</p>
</li>
<li><p>2.12. prepareAppDataContentsLeafLIF 会调用Installd. linkNativeLibraryDirectory创建每一个应用so库的扫描目录<code>/data/user/用户id/包名/lib</code>。并把这个目录链接到<code>/data/data/包名/lib</code>中</p>
</li>
<li><p>2.13.还会调用<code>/system/bin/profman</code> 程序生成每一个应用包名的<code>/data/data/包名/包名.prof</code>文件用于加速后面的dex2oat的编译优化。</p>
</li>
</ul>
</li>
<li><p>3.在扫描的过程中，就以我们开发安装的应用微粒子。会从<code>/data/app</code>目录下取出apk文件，拿到其中的<code>AndroidManifest.xml</code>，解析里面所有的组件和标签并保存到package对象。并把这个package对象通过Parcel进行序列化，保存到<code>data/system/package_cache/包名_0</code>中。</p>
</li>
</ul>
<p>下一次就会优先从这个缓存中获取，直到出现缓存的文件的修改日期时间比<code>/data/app</code>中保存的apk文件修改时间早，说明apk发生了版本更新，才会重新从<code>/data/app</code>中读取。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/08/31/android-chong-xue-xi-lie-packagemanagerservice-de-qi-dong-yu-an-zhuang-xia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="Android重学系列 PackageManagerService的启动与安装(下)">
                        
                        <span class="card-title">Android重学系列 PackageManagerService的启动与安装(下)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言 之前和大家聊完了PMS的启动原理，本文继续介绍当进行安装的时候，PMS做了什么事情。
正文先来看看在Android 中如何吊起安装界面：
 public static void installApk(Context context, 
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-08-31
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/PMS/" class="post-category">
                                    PMS
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/08/15/android-chong-xue-xi-lie-contentprovider-qi-dong-yuan-li/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="Android重学系列 ContentProvider 启动原理">
                        
                        <span class="card-title">Android重学系列 ContentProvider 启动原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言终于来到了四大组件的最后一个了，ContentProvider(之后简称CP)开发中用的不是很多，但这不代表这不重要。很多开源库不少巧妙的思路就是借用CP巧妙实现的，如头条的AutoSize是如何自动获取Context的，360的ReP
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-08-15
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-Framework/" class="post-category">
                                    Android Framework
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
