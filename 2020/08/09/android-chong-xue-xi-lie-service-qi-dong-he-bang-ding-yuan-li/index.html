<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android重学系列 Service 启动和绑定原理, Android | Linux | Flutter">
    <meta name="description" content="前言我们已经了解了BroadcastReceiver的原理，我们再来看看四大组件之一的Service是怎么启动的，以及怎么运行的原理。
正文启动Service的入口就是startService和bindService方法。我们先来看看sta">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android重学系列 Service 启动和绑定原理 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android重学系列 Service 启动和绑定原理
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android-Framework/" class="post-category">
                                Android Framework
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-08-09
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        10.1k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        48 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们已经了解了BroadcastReceiver的原理，我们再来看看四大组件之一的Service是怎么启动的，以及怎么运行的原理。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>启动Service的入口就是startService和bindService方法。我们先来看看startService在ContextImpl中做了什么。</p>
<h2 id="startService原理"><a href="#startService原理" class="headerlink" title="startService原理"></a>startService原理</h2><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ContextImpl.java" target="_blank" rel="noopener">ContextImpl.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ComponentName <span class="token function">startService</span><span class="token punctuation">(</span>Intent service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warnIfCallingFromSystemProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">startServiceCommon</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ComponentName <span class="token function">startForegroundService</span><span class="token punctuation">(</span>Intent service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warnIfCallingFromSystemProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">startServiceCommon</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> mUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> ComponentName <span class="token function">startServiceCommon</span><span class="token punctuation">(</span>Intent service<span class="token punctuation">,</span> <span class="token keyword">boolean</span> requireForeground<span class="token punctuation">,</span>
            UserHandle user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">validateServiceIntent</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ComponentName cn <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>
                mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span>
                            <span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requireForeground<span class="token punctuation">,</span>
                            <span class="token function">getOpPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cn <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cn<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>
                            <span class="token string">"Not allowed to start service "</span> <span class="token operator">+</span> service
                            <span class="token operator">+</span> <span class="token string">" without permission "</span> <span class="token operator">+</span> cn<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cn<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"!!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>
                            <span class="token string">"Unable to start service "</span> <span class="token operator">+</span> service
                            <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> cn<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cn<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                            <span class="token string">"Not allowed to start service "</span> <span class="token operator">+</span> service <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> cn<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token keyword">return</span> cn<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时调用的就是AMS的startService方法。</p>
<h2 id="AMS-startService"><a href="#AMS-startService" class="headerlink" title="AMS startService"></a>AMS startService</h2><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> ComponentName <span class="token function">startService</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span> Intent service<span class="token punctuation">,</span>
            String resolvedType<span class="token punctuation">,</span> <span class="token keyword">boolean</span> requireForeground<span class="token punctuation">,</span> String callingPackage<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> TransactionTooLargeException <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> callingPid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ComponentName res<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                res <span class="token operator">=</span> mServices<span class="token punctuation">.</span><span class="token function">startServiceLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> service<span class="token punctuation">,</span>
                        resolvedType<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                        requireForeground<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>mServices是一个ActiveServices对象。这个对象是在AMS的构造函数中初始化好的。</p>
<p>这里调用了ActiveServices的startServiceLocked。</p>
<h3 id="ActiveServices-startServiceLocked"><a href="#ActiveServices-startServiceLocked" class="headerlink" title="ActiveServices startServiceLocked"></a>ActiveServices startServiceLocked</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActiveServices.java" target="_blank" rel="noopener">ActiveServices.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    ComponentName <span class="token function">startServiceLocked</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span> Intent service<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span>
            <span class="token keyword">int</span> callingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fgRequired<span class="token punctuation">,</span> String callingPackage<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> TransactionTooLargeException <span class="token punctuation">{</span>


        <span class="token keyword">final</span> <span class="token keyword">boolean</span> callerFg<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ProcessRecord callerApp <span class="token operator">=</span> mAm<span class="token punctuation">.</span><span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>

            callerFg <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>setSchedGroup <span class="token operator">!=</span> ProcessList<span class="token punctuation">.</span>SCHED_GROUP_BACKGROUND<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            callerFg <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ServiceLookupResult res <span class="token operator">=</span>
            <span class="token function">retrieveServiceLocked</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span>
                    callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> callerFg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>record <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span><span class="token string">"!"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>permission <span class="token operator">!=</span> null
                    <span class="token operator">?</span> res<span class="token punctuation">.</span>permission <span class="token operator">:</span> <span class="token string">"private to package"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ServiceRecord r <span class="token operator">=</span> res<span class="token punctuation">.</span>record<span class="token punctuation">;</span>

 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unscheduleServiceRestartLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>lastActivity <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>startRequested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>delayedStop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>fgRequired <span class="token operator">=</span> fgRequired<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>pendingStarts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServiceRecord<span class="token punctuation">.</span>StartItem</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">makeNextStartId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                service<span class="token punctuation">,</span> neededGrants<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fgRequired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
mAm<span class="token punctuation">.</span>mAppOpsService<span class="token punctuation">.</span><span class="token function">startOperation</span><span class="token punctuation">(</span>AppOpsManager<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>mAm<span class="token punctuation">.</span>mAppOpsService<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    AppOpsManager<span class="token punctuation">.</span>OP_START_FOREGROUND<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> ServiceMap smap <span class="token operator">=</span> <span class="token function">getServiceMapLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> addToStarting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callerFg <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fgRequired <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>app <span class="token operator">==</span> null
                <span class="token operator">&amp;&amp;</span> mAm<span class="token punctuation">.</span>mUserController<span class="token punctuation">.</span><span class="token function">hasStartedUserState</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
        ComponentName cmp <span class="token operator">=</span> <span class="token function">startServiceInnerLocked</span><span class="token punctuation">(</span>smap<span class="token punctuation">,</span> service<span class="token punctuation">,</span> r<span class="token punctuation">,</span> callerFg<span class="token punctuation">,</span> addToStarting<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心流程有如下三个：</p>
<ul>
<li>1.retrieveServiceLocked 从ActiveServices中获取ServiceLookupResult 需要启动Service对象</li>
<li>2.往ServiceRecord对象的pendingStarts几个中添加一个ServiceRecord.StartItem对象。而这个对象就是之后Service声明周期中onCommandStart的回调参数</li>
<li>3.startServiceInnerLocked 执行Service的启动的流程。</li>
</ul>
<p>注意这里addToStarting是一个比较关键的判断，addToStarting默认为false。</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callerFg <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fgRequired <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>app <span class="token operator">==</span> null
                <span class="token operator">&amp;&amp;</span> mAm<span class="token punctuation">.</span>mUserController<span class="token punctuation">.</span><span class="token function">hasStartedUserState</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ProcessRecord proc <span class="token operator">=</span> mAm<span class="token punctuation">.</span><span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>proc <span class="token operator">==</span> null <span class="token operator">||</span> proc<span class="token punctuation">.</span>curProcState <span class="token operator">></span> ActivityManager<span class="token punctuation">.</span>PROCESS_STATE_RECEIVER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>delayed<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">return</span> r<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>smap<span class="token punctuation">.</span>mStartingBackground<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> mMaxStartingBackground<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    smap<span class="token punctuation">.</span>mDelayedStartList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>delayed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> r<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                addToStarting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>curProcState <span class="token operator">>=</span> ActivityManager<span class="token punctuation">.</span>PROCESS_STATE_SERVICE<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                addToStarting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_DELAYED_STARTS<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_DELAYED_STARTS<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果此时不是启动前台服务，则需要进一步进行处理。如果ProcessRecord为空或者curProcState大于PROCESS_STATE_RECEIVER这个优先级数值；也就是优先级更小。</p>
<p>为了避免此时App应用是没有任何的前台ui，或者App应用还没有声明。避免有的App通过startService进行应用的包活或者拉起应用。就会进行如下能够存在的最大后台服务数量，则放入mDelayedStartList中进行延时启动后台服务，现在直接返回了。</p>
<p>不然则说明能够允许启动后台服务， 就设置为addToStarting为true。</p>
<h3 id="ActiveServices-retrieveServiceLocked"><a href="#ActiveServices-retrieveServiceLocked" class="headerlink" title="ActiveServices  retrieveServiceLocked"></a>ActiveServices  retrieveServiceLocked</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> ServiceLookupResult <span class="token function">retrieveServiceLocked</span><span class="token punctuation">(</span>Intent service<span class="token punctuation">,</span>
            String resolvedType<span class="token punctuation">,</span> String callingPackage<span class="token punctuation">,</span> <span class="token keyword">int</span> callingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> createIfNeeded<span class="token punctuation">,</span> <span class="token keyword">boolean</span> callingFromFg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isBindExternal<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> allowInstant<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ServiceRecord r <span class="token operator">=</span> null<span class="token punctuation">;</span>


        userId <span class="token operator">=</span> mAm<span class="token punctuation">.</span>mUserController<span class="token punctuation">.</span><span class="token function">handleIncomingUser</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                ActivityManagerService<span class="token punctuation">.</span>ALLOW_NON_FULL_IN_PROFILE<span class="token punctuation">,</span> <span class="token string">"service"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ServiceMap smap <span class="token operator">=</span> <span class="token function">getServiceMapLocked</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ComponentName comp <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r <span class="token operator">=</span> smap<span class="token punctuation">.</span>mServicesByName<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>comp<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isBindExternal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Intent<span class="token punctuation">.</span>FilterComparison filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent<span class="token punctuation">.</span>FilterComparison</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r <span class="token operator">=</span> smap<span class="token punctuation">.</span>mServicesByIntent<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ServiceInfo<span class="token punctuation">.</span>FLAG_EXTERNAL_SERVICE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>callingPackage<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            r <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> flags <span class="token operator">=</span> ActivityManagerService<span class="token punctuation">.</span>STOCK_PM_FLAGS
                        <span class="token operator">|</span> PackageManager<span class="token punctuation">.</span>MATCH_DEBUG_TRIAGED_MISSING<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>allowInstant<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    flags <span class="token operator">|=</span> PackageManager<span class="token punctuation">.</span>MATCH_INSTANT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                ResolveInfo rInfo <span class="token operator">=</span> mAm<span class="token punctuation">.</span><span class="token function">getPackageManagerInternalLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolveService</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span>
                        resolvedType<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ServiceInfo sInfo <span class="token operator">=</span>
                    rInfo <span class="token operator">!=</span> null <span class="token operator">?</span> rInfo<span class="token punctuation">.</span>serviceInfo <span class="token operator">:</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ComponentName name <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                        sInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> sInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ServiceInfo<span class="token punctuation">.</span>FLAG_EXTERNAL_SERVICE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>isBindExternal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sInfo<span class="token punctuation">.</span>exported<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ServiceInfo<span class="token punctuation">.</span>FLAG_ISOLATED_PROCESS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token punctuation">}</span>

                        ApplicationInfo aInfo <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>
                                callingPackage<span class="token punctuation">,</span> ActivityManagerService<span class="token punctuation">.</span>STOCK_PM_FLAGS<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        sInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceInfo</span><span class="token punctuation">(</span>sInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        sInfo<span class="token punctuation">.</span>applicationInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationInfo</span><span class="token punctuation">(</span>sInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        sInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName <span class="token operator">=</span> aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
                        sInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">=</span> aInfo<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
                        name <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        service<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isBindExternal<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAm<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span>sInfo<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> sInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span>
                            sInfo<span class="token punctuation">.</span>name<span class="token punctuation">,</span> sInfo<span class="token punctuation">.</span>flags<span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> mAm<span class="token punctuation">.</span><span class="token function">isValidSingletonCall</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> sInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        userId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        smap <span class="token operator">=</span> <span class="token function">getServiceMapLocked</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    sInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceInfo</span><span class="token punctuation">(</span>sInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sInfo<span class="token punctuation">.</span>applicationInfo <span class="token operator">=</span> mAm<span class="token punctuation">.</span><span class="token function">getAppInfoForUser</span><span class="token punctuation">(</span>sInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                r <span class="token operator">=</span> smap<span class="token punctuation">.</span>mServicesByName<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> createIfNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> Intent<span class="token punctuation">.</span>FilterComparison filter
                            <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent<span class="token punctuation">.</span>FilterComparison</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">cloneFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> ServiceRestarter res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceRestarter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> BatteryStatsImpl<span class="token punctuation">.</span>Uid<span class="token punctuation">.</span>Pkg<span class="token punctuation">.</span>Serv ss<span class="token punctuation">;</span>
                    <span class="token keyword">final</span> BatteryStatsImpl stats <span class="token operator">=</span> mAm<span class="token punctuation">.</span>mBatteryStatsService<span class="token punctuation">.</span><span class="token function">getActiveStatistics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>stats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ss <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">getServiceStatsLocked</span><span class="token punctuation">(</span>
                                sInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> sInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                                sInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceRecord</span><span class="token punctuation">(</span>mAm<span class="token punctuation">,</span> ss<span class="token punctuation">,</span> name<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> sInfo<span class="token punctuation">,</span> callingFromFg<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    res<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    smap<span class="token punctuation">.</span>mServicesByName<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    smap<span class="token punctuation">.</span>mServicesByIntent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>mPendingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> ServiceRecord pr <span class="token operator">=</span> mPendingServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>pr<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">==</span> sInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid
                                <span class="token operator">&amp;&amp;</span> pr<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            mPendingServices<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// pm is in same process, this will never happen.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServiceLookupResult</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.通过UserController.handleIncomingUser获取的userId，从getServiceMapLocked方法通过userId中获取ServiceMap对象。这个对象保存了已经启动过所有的Service对象。</p>
<ul>
<li>1.1.ServiceMap保存如下几种用于查询映射结构:<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">final</span> ArrayMap<span class="token operator">&lt;</span>ComponentName<span class="token punctuation">,</span> ServiceRecord<span class="token operator">></span> mServicesByName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> ArrayMap<span class="token operator">&lt;</span>Intent<span class="token punctuation">.</span>FilterComparison<span class="token punctuation">,</span> ServiceRecord<span class="token operator">></span> mServicesByIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
通过ComponentName也就是包名和类名查找ServiceRecord；通过Intent意图过滤找到ServiceRecord。·</li>
<li>1.2.如果能够获取到，则直接获取ServiceMap中的ServiceRecord对象，并包裹成ServiceLookupResult对象返回。</li>
</ul>
</li>
<li><p>2.如果Intent中的ComponentName不为空，ServiceMap则通过ComponentName查询缓存ServiceRecord。</p>
</li>
<li><p>3.如果还是找不到，且isBindExternal为false(此时就是false)，则通过过滤条件从ServiceMap查找缓存ServiceRecord。</p>
</li>
<li><p>4.如果设置了FLAG_EXTERNAL_SERVICE，且ServiceRecord找到了，但是此时ServiceRecord中的包名和调用方的包名不一致，则把找到的缓存ServiceRecord设置为空。如果设置了FLAG_EXTERNAL_SERVICE这个flag，也就是设置了<code>android:externalService</code>这个xml标签。这个标签代表了Service可以绑定调用方的进程；因此这个标志位支持跨进程绑定但是不支持跨包绑定。</p>
</li>
<li><p>5.如果找不到ServiceRecord，那么需要新建一个ServiceRecord。</p>
<ul>
<li><p>5.1.先通过PMS的resolveService方法，从PMS中获取一个ResolveInfo对象。这个对象能够获取安装时候通过解析AndroidManifest.xml到的ServiceInfo对象。</p>
</li>
<li><p>5.2.并且isBindExternal为true。此时会封装一个新的ServiceInfo，并且通过Intent的setComponent，获取此时真正需要启动Service对应的包名和类名。在这里isBindExternal为false，startService并不会走这个逻辑。</p>
</li>
<li><p>5.3.因为可能会在5.2的时候获取真实需要启动的包名，此时再通过mServicesByName找一次是否能找到缓存的Service。</p>
</li>
<li><p>5.4.到了这个步骤说明真的找不到了ServiceRecord对象。先生成Intent.FilterComparison对象。把ComponentName作为key和ServiceRecord作为value保存到mServicesByName；把Intent.FilterComparison作为key，ServiceRecord作为value保存到mServicesByIntent。</p>
</li>
<li><p>5.5.如果在mPendingServices队列中发现了这个需要新生成的Service对象对应的包名类名，就从mPendingServices中移除一样的包名类名。</p>
</li>
<li><p>5.6.最后校验权限返回ServiceLookupResult。</p>
</li>
</ul>
</li>
</ul>
<h3 id="ActiveServices-startServiceInnerLocked"><a href="#ActiveServices-startServiceInnerLocked" class="headerlink" title="ActiveServices startServiceInnerLocked"></a>ActiveServices startServiceInnerLocked</h3><pre class="line-numbers language-java"><code class="language-java">    ComponentName <span class="token function">startServiceInnerLocked</span><span class="token punctuation">(</span>ServiceMap smap<span class="token punctuation">,</span> Intent service<span class="token punctuation">,</span> ServiceRecord r<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> callerFg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> addToStarting<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransactionTooLargeException <span class="token punctuation">{</span>
        ServiceState stracker <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stracker <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stracker<span class="token punctuation">.</span><span class="token function">setStarted</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> mAm<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">.</span><span class="token function">getMemFactorLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>callStart <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>stats<span class="token punctuation">.</span><span class="token function">getBatteryStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>stats<span class="token punctuation">.</span><span class="token function">startRunningLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String error <span class="token operator">=</span> <span class="token function">bringUpServiceLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callerFg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span><span class="token string">"!!"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>startRequested <span class="token operator">&amp;&amp;</span> addToStarting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> first <span class="token operator">=</span> smap<span class="token punctuation">.</span>mStartingBackground<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
            smap<span class="token punctuation">.</span>mStartingBackground<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>startingBgTimeout <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> mAm<span class="token punctuation">.</span>mConstants<span class="token punctuation">.</span>BG_START_TIMEOUT<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                smap<span class="token punctuation">.</span><span class="token function">rescheduleDelayedStartsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>callerFg <span class="token operator">||</span> r<span class="token punctuation">.</span>fgRequired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            smap<span class="token punctuation">.</span><span class="token function">ensureNotStartingBackgroundLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> r<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心方法是bringUpServiceLocked。如果bringUpServiceLocked返回了异常，就返回一个特殊的ComponentName对象。</p>
<p>addToStarting为true，说明此时是一个能够启动的后台服务，则ServiceRecord添加到mStartingBackground中。如果mStartingBackground的数量为0，则直接调用ServiceMap的rescheduleDelayedStartsLocked启动后台服务。</p>
<h4 id="ActiveServices-bringUpServiceLocked"><a href="#ActiveServices-bringUpServiceLocked" class="headerlink" title="ActiveServices bringUpServiceLocked"></a>ActiveServices bringUpServiceLocked</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> String <span class="token function">bringUpServiceLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> intentFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> execInFg<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> whileRestarting<span class="token punctuation">,</span> <span class="token keyword">boolean</span> permissionsReviewRequired<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> TransactionTooLargeException <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sendServiceArgsLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> execInFg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>whileRestarting <span class="token operator">&amp;&amp;</span> mRestartingServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRestartingServices<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">clearRestartingIfNeededLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>delayed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">getServiceMapLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span>mDelayedStartList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>delayed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAm<span class="token punctuation">.</span>mUserController<span class="token punctuation">.</span><span class="token function">hasStartedUserState</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token function">bringDownServiceLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPackageStoppedState</span><span class="token punctuation">(</span>
                    r<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isolated <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ServiceInfo<span class="token punctuation">.</span>FLAG_ISOLATED_PROCESS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String procName <span class="token operator">=</span> r<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>
        String hostingType <span class="token operator">=</span> <span class="token string">"service"</span><span class="token punctuation">;</span>
        ProcessRecord app<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            app <span class="token operator">=</span> mAm<span class="token punctuation">.</span><span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>procName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>longVersionCode<span class="token punctuation">,</span> mAm<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">realStartServiceLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">,</span> execInFg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionTooLargeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            app <span class="token operator">=</span> r<span class="token punctuation">.</span>isolatedProc<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>WebViewZygote<span class="token punctuation">.</span><span class="token function">isMultiprocessEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>WebViewZygote<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                hostingType <span class="token operator">=</span> <span class="token string">"webview_service"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>permissionsReviewRequired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>app<span class="token operator">=</span>mAm<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>procName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> intentFlags<span class="token punctuation">,</span>
                    hostingType<span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> isolated<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token function">bringDownServiceLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isolated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>isolatedProc <span class="token operator">=</span> app<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>fgRequired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAm<span class="token punctuation">.</span><span class="token function">tempWhitelistUidLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
                    SERVICE_START_FOREGROUND_TIMEOUT<span class="token punctuation">,</span> <span class="token string">"fg-service-launch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPendingServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>delayedStop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>delayedStop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>startRequested<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">stopServiceLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果ServiceRecord已经保存了app远程端的Binder对象，说明该Service已经启动过了，则直接执行sendServiceArgsLocked执行Service的其他声明周期。</p>
</li>
<li><p>2.如果ServiceRecord的delay属性为true，则从mDelayedStartList移除该ServiceRecord，delay设置为true。说明此时开始启动服务了。</p>
</li>
<li><p>3.如果AndroidManifest中的service标签设置了<code>android:isolatedProcess</code>,说明这个Service需要启动在另一个隔离的进程中执行。我们先只考虑false的情况，此时说明是app在app进程中启动Service。</p>
<ul>
<li>3.1.getProcessRecordLocked获取当前App进程的ProcessRecord，如果ProcessRecord不为空，则说明该进程已经启动了。此时为ProcessRecord的addPackage后，调用realStartServiceLocked 启动Service。</li>
</ul>
</li>
<li><p>4.如果<code>android:isolatedProcess</code>为true，说明每一次启动Service都应该是一个新的隔离进程。把ServiceRecord设置给app。那么app这个ProcessRecord对象就是空，此时permissionsReviewRequired就是false。每执行一次这个startProcessLocked方法，说明<code>android:isolatedProcess</code>标志为每一次都是启动app进程对象。</p>
<ul>
<li>4.1.调用一次bringDownServiceLocked方法</li>
<li>4.2.mPendingServices如果不包含需要启动的ServiceRecord，则添加到mPendingService中保存。</li>
</ul>
</li>
</ul>
<h5 id="realStartServiceLocked"><a href="#realStartServiceLocked" class="headerlink" title="realStartServiceLocked"></a>realStartServiceLocked</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">realStartServiceLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span>
            ProcessRecord app<span class="token punctuation">,</span> <span class="token keyword">boolean</span> execInFg<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span>app <span class="token operator">=</span> app<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>restartTime <span class="token operator">=</span> r<span class="token punctuation">.</span>lastActivity <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> newService <span class="token operator">=</span> app<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> execInFg<span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mAm<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateServiceForegroundLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* oomAdj= */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mAm<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> created <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>stats<span class="token punctuation">.</span><span class="token function">getBatteryStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>stats<span class="token punctuation">.</span><span class="token function">startLaunchedLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mAm<span class="token punctuation">.</span><span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                                 PackageManager<span class="token punctuation">.</span>NOTIFY_PACKAGE_USE_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">forceProcessStateUpTo</span><span class="token punctuation">(</span>ActivityManager<span class="token punctuation">.</span>PROCESS_STATE_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleCreateService</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">,</span>
                    mAm<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span><span class="token function">postNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            created <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DeadObjectException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Application dead when creating service "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mAm<span class="token punctuation">.</span><span class="token function">appDiedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>created<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Keep the executeNesting count accurate.</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> inDestroying <span class="token operator">=</span> mDestroyingServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> inDestroying<span class="token punctuation">,</span> inDestroying<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Cleanup.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    app<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>app <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// Retry.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inDestroying<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">scheduleServiceRestartLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>whitelistManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            app<span class="token punctuation">.</span>whitelistManager <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">requestServiceBindingsLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> execInFg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">updateServiceClientActivitiesLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>startRequested <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>callStart <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>pendingStarts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>pendingStarts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServiceRecord<span class="token punctuation">.</span>StartItem</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">makeNextStartId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">sendServiceArgsLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> execInFg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>delayed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">getServiceMapLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span>mDelayedStartList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>delayed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>delayedStop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>delayedStop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>startRequested<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">stopServiceLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.启动Service前，先把ServiceRecord添加到ProcessRecord的services集合，说明这个Service正在运行了。bumpServiceExecutingLocked埋入Service的ANR消息，更新当前App应用的adj优先级</li>
<li>2.跨进程调用App端的ApplicationThread的scheduleCreateService方法，创建Service对象，执行onCreate</li>
<li>3.如果创建的过程中失败了，说明可能App端要么死掉，要么就是创建过程发生了异常，此时会调用serviceDoneExecutingLocked方法，执行Service的完成事务的任务。</li>
<li>4.如果发现保存已经销毁的Service对象集合mDestroyingServices并没有这个Service，就会再一次的尝试启动。</li>
<li>5.requestServiceBindingLocked 执行服务绑定的Connection对象。注意此时是startService，因此不会有任何挂载的Connection对象。只有bindService才会执行。</li>
<li>6.sendServiceArgsLocked 执行Service发送数据</li>
<li>7.移除mDelayedStartList中的ServiceRecord</li>
</ul>
<p>这几个关键的步骤，让我们依次的考察，先来看看scheduleCreateService中做了什么。</p>
<h4 id="bumpServiceExecutingLocked"><a href="#bumpServiceExecutingLocked" class="headerlink" title="bumpServiceExecutingLocked"></a>bumpServiceExecutingLocked</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fg<span class="token punctuation">,</span> String why<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">boolean</span> timeoutNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mAm<span class="token punctuation">.</span>mBootPhase <span class="token operator">&lt;</span> SystemService<span class="token punctuation">.</span>PHASE_THIRD_PARTY_APPS_CAN_START<span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pid <span class="token operator">==</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Process<span class="token punctuation">.</span><span class="token function">myPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            timeoutNeeded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeNesting <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>executeFg <span class="token operator">=</span> fg<span class="token punctuation">;</span>
            ServiceState stracker <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stracker <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stracker<span class="token punctuation">.</span><span class="token function">setExecuting</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> mAm<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">.</span><span class="token function">getMemFactorLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg <span class="token operator">|=</span> fg<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutNeeded <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> fg <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>executeFg <span class="token operator">|=</span> fg<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>executeNesting<span class="token operator">++</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>executingStart <span class="token operator">=</span> now<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果第一次启动就走第一个if的分支：</p>
<ul>
<li>1.ProcessRecord的executingServices 正在执行任务的Service集合添加ServiceRecord对象</li>
<li>2.执行scheduleServiceTimeoutLocked ANR超时埋点。</li>
</ul>
<h6 id="scheduleServiceTimeoutLocked"><a href="#scheduleServiceTimeoutLocked" class="headerlink" title="scheduleServiceTimeoutLocked"></a>scheduleServiceTimeoutLocked</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>ProcessRecord proc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> proc<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Message msg <span class="token operator">=</span> mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>
                ActivityManagerService<span class="token punctuation">.</span>SERVICE_TIMEOUT_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> proc<span class="token punctuation">;</span>
        mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span>
                proc<span class="token punctuation">.</span>execServicesFg <span class="token operator">?</span> SERVICE_TIMEOUT <span class="token operator">:</span> SERVICE_BACKGROUND_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到和BroadcastReceiver的ANR思路一样，通过一个延时的Handler，如果达到时间了还没有移除这个Handler消息则报ANR异常。</p>
<p>这里根据启动前台和后台分为两种超时时间：</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// How long we wait for a service to finish executing.</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SERVICE_TIMEOUT <span class="token operator">=</span> <span class="token number">20</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// How long we wait for a service to finish executing.</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SERVICE_BACKGROUND_TIMEOUT <span class="token operator">=</span> SERVICE_TIMEOUT <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// How long the startForegroundService() grace period is to get around to</span>
    <span class="token comment" spellcheck="true">// calling startForeground() before we ANR + stop it.</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SERVICE_START_FOREGROUND_TIMEOUT <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>前台分别是10秒，后台服务不属于后台进程组(判断adj是否在SCHED_GROUP_BACKGROUND)是20秒，后台服务属于后台进程组 200秒。</p>
<h4 id="ApplicationThread-scheduleCreateService"><a href="#ApplicationThread-scheduleCreateService" class="headerlink" title="ApplicationThread scheduleCreateService"></a>ApplicationThread scheduleCreateService</h4><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">scheduleCreateService</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">,</span>
                ServiceInfo info<span class="token punctuation">,</span> CompatibilityInfo compatInfo<span class="token punctuation">,</span> <span class="token keyword">int</span> processState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">updateProcessState</span><span class="token punctuation">(</span>processState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            CreateServiceData s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateServiceData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            s<span class="token punctuation">.</span>token <span class="token operator">=</span> token<span class="token punctuation">;</span>
            s<span class="token punctuation">.</span>info <span class="token operator">=</span> info<span class="token punctuation">;</span>
            s<span class="token punctuation">.</span>compatInfo <span class="token operator">=</span> compatInfo<span class="token punctuation">;</span>

            <span class="token function">sendMessage</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>CREATE_SERVICE<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>把数据封装成CreateServiceData后，通过Handler调用如下方法：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleCreateService</span><span class="token punctuation">(</span>CreateServiceData data<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">unscheduleGcIdler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        LoadedApk packageInfo <span class="token operator">=</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span>
                data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Service service <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader cl <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            service <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getAppFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">instantiateService</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">,</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ContextImpl context <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> packageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Application app <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">,</span> data<span class="token punctuation">.</span>token<span class="token punctuation">,</span> app<span class="token punctuation">,</span>
                    ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mServices<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>token<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serviceDoneExecuting</span><span class="token punctuation">(</span>
                        data<span class="token punctuation">.</span>token<span class="token punctuation">,</span> SERVICE_DONE_EXECUTING_ANON<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.通过AppComponentFactory反射创建一个全新的Service对象</li>
<li>2.通过ContextImpl.createAppContext 创建一个新的Context。</li>
<li>3.获取LoadedApk中的Application对象，调用Service的attach方法绑定Context。</li>
<li>4.调用Service的onCreate方法</li>
<li>5.Service以ServiceRecord的token为key缓存到mServices这个Map对象中中</li>
<li>5.调用AMS的serviceDoneExecuting方法。</li>
</ul>
<p>透三点的核心原理可以看我写的的Application创建和BroadcastReceiver原理两篇文章。来看看Service中都做了什么？</p>
<h5 id="Service-attach"><a href="#Service-attach" class="headerlink" title="Service attach"></a>Service attach</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span>
            Context context<span class="token punctuation">,</span>
            ActivityThread thread<span class="token punctuation">,</span> String className<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span>
            Application application<span class="token punctuation">,</span> Object activityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">attachBaseContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mThread <span class="token operator">=</span> thread<span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// NOTE:  unused - remove?</span>
        mClassName <span class="token operator">=</span> className<span class="token punctuation">;</span>
        mToken <span class="token operator">=</span> token<span class="token punctuation">;</span>
        mApplication <span class="token operator">=</span> application<span class="token punctuation">;</span>
        mActivityManager <span class="token operator">=</span> <span class="token punctuation">(</span>IActivityManager<span class="token punctuation">)</span>activityManager<span class="token punctuation">;</span>
        mStartCompatibility <span class="token operator">=</span> <span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>targetSdkVersion
                <span class="token operator">&lt;</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>ECLAIR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单就是保存了传递过来的参数，值得注意的是这个IBinder对象其实就是指ServiceRecord对象。</p>
<p>接着执行Service.onCreate这个空实现的方法。</p>
<h5 id="AMS-serviceDoneExecuting"><a href="#AMS-serviceDoneExecuting" class="headerlink" title="AMS serviceDoneExecuting"></a>AMS serviceDoneExecuting</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serviceDoneExecuting</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">,</span> <span class="token keyword">int</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mServices<span class="token punctuation">.</span><span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ServiceRecord<span class="token punctuation">)</span>token<span class="token punctuation">,</span> type<span class="token punctuation">,</span> startId<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>本质上还是调用了ActiveServices的serviceDoneExecutingLocked方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">,</span> <span class="token keyword">int</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> inDestroying <span class="token operator">=</span> mDestroyingServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> ActivityThread<span class="token punctuation">.</span>SERVICE_DONE_EXECUTING_START<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> ActivityThread<span class="token punctuation">.</span>SERVICE_DONE_EXECUTING_STOP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeNesting <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> inDestroying<span class="token punctuation">,</span> inDestroying<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>type是SERVICE_DONE_EXECUTING_ANON，所不会做更多的处理。 最后执行了serviceDoneExecutingLocked方法。</p>
<h6 id="ActiveServices-serviceDoneExecutingLocked"><a href="#ActiveServices-serviceDoneExecutingLocked" class="headerlink" title="ActiveServices serviceDoneExecutingLocked"></a>ActiveServices serviceDoneExecutingLocked</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> inDestroying<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        r<span class="token punctuation">.</span>executeNesting<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeNesting <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span>SERVICE_TIMEOUT_MSG<span class="token punctuation">,</span> r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeFg<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>executeFg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>inDestroying<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    mDestroyingServices<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mAm<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            r<span class="token punctuation">.</span>executeFg <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>tracker <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>tracker<span class="token punctuation">.</span><span class="token function">setExecuting</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mAm<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">.</span><span class="token function">getMemFactorLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span>tracker<span class="token punctuation">.</span><span class="token function">clearCurrentOwner</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>tracker <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>whitelistManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">updateWhitelistManagerLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                r<span class="token punctuation">.</span>app <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.executeNesting 递减一之后小于等于0，说明该ServiceRecord只执行了一次启动。接着移除executingServices中的ServiceRecord，说明正在执行的Service已经处理完毕了。</li>
<li>2.如果executingServices大小为0，则移除ActivityManagerService.SERVICE_TIMEOUT_MSG这个Handler消息，也就是拆开了ANR的消息</li>
<li>3.如果执行的是结束Service的方法，则从ProcessRecord的services移除ServiceRecord。</li>
</ul>
<h4 id="ActiveServices-sendServiceArgsLocked"><a href="#ActiveServices-sendServiceArgsLocked" class="headerlink" title="ActiveServices sendServiceArgsLocked"></a>ActiveServices sendServiceArgsLocked</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">sendServiceArgsLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> execInFg<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> oomAdjusted<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransactionTooLargeException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> r<span class="token punctuation">.</span>pendingStarts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ArrayList<span class="token operator">&lt;</span>ServiceStartArgs<span class="token operator">></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>pendingStarts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ServiceRecord<span class="token punctuation">.</span>StartItem si <span class="token operator">=</span> r<span class="token punctuation">.</span>pendingStarts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">.</span>intent <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> N <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            si<span class="token punctuation">.</span>deliveredTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>deliveredStarts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
            si<span class="token punctuation">.</span>deliveryCount<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> execInFg<span class="token punctuation">,</span> <span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oomAdjusted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                oomAdjusted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                mAm<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>fgRequired <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>fgWaiting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>isForeground<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">scheduleServiceForegroundTransitionTimeoutLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span>fgRequired <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">.</span>deliveryCount <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                flags <span class="token operator">|=</span> Service<span class="token punctuation">.</span>START_FLAG_RETRY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">.</span>doneExecutingCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                flags <span class="token operator">|=</span> Service<span class="token punctuation">.</span>START_FLAG_REDELIVERY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServiceStartArgs</span><span class="token punctuation">(</span>si<span class="token punctuation">.</span>taskRemoved<span class="token punctuation">,</span> si<span class="token punctuation">.</span>id<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> si<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ParceledListSlice<span class="token operator">&lt;</span>ServiceStartArgs<span class="token operator">></span> slice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParceledListSlice</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        slice<span class="token punctuation">.</span><span class="token function">setInlineCountLimit</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Exception caughtException <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleServiceArgs</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> slice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionTooLargeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            caughtException <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            caughtException <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unexpected exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            caughtException <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.遍历所有保存在ServiceRecord.pendingStarts中的ServiceRecord.StartItem对象，把ServiceRecord.StartItem保存到ServiceRecord的deliveredStarts中，说明这些数据正在分发。<ul>
<li>1.1.调用bumpServiceExecutingLocked方法继续埋下ANR的Handler定时消息</li>
<li>1.2.更新当前进程的adj应用优先级</li>
<li>1.3.以ServiceRecord.StartItem的Intent,flag,id构成用于在App端分发ServiceStartArgs对象，并保存到slice这个ParceledListSlice<servicestartargs>对象中.</servicestartargs></li>
<li>1.4.跨进程通信，调用ApplicationThread的scheduleServiceArgs方法。</li>
</ul>
</li>
</ul>
<h4 id="ActivityThread-scheduleServiceArgs"><a href="#ActivityThread-scheduleServiceArgs" class="headerlink" title="ActivityThread scheduleServiceArgs"></a>ActivityThread scheduleServiceArgs</h4><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">scheduleServiceArgs</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">,</span> ParceledListSlice args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            List<span class="token operator">&lt;</span>ServiceStartArgs<span class="token operator">></span> list <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ServiceStartArgs ssa <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ServiceArgsData s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceArgsData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                s<span class="token punctuation">.</span>token <span class="token operator">=</span> token<span class="token punctuation">;</span>
                s<span class="token punctuation">.</span>taskRemoved <span class="token operator">=</span> ssa<span class="token punctuation">.</span>taskRemoved<span class="token punctuation">;</span>
                s<span class="token punctuation">.</span>startId <span class="token operator">=</span> ssa<span class="token punctuation">.</span>startId<span class="token punctuation">;</span>
                s<span class="token punctuation">.</span>flags <span class="token operator">=</span> ssa<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
                s<span class="token punctuation">.</span>args <span class="token operator">=</span> ssa<span class="token punctuation">.</span>args<span class="token punctuation">;</span>

                <span class="token function">sendMessage</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>SERVICE_ARGS<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法不断的循环遍历List<servicestartargs>分发SERVICE_ARGS消息，这个消息通过主线程的Looper调用handleServiceArgs。</servicestartargs></p>
<h6 id="handleServiceArgs"><a href="#handleServiceArgs" class="headerlink" title="handleServiceArgs"></a>handleServiceArgs</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleServiceArgs</span><span class="token punctuation">(</span>ServiceArgsData data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Service s <span class="token operator">=</span> mServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>args <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    data<span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    data<span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> res<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>taskRemoved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    res <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">onStartCommand</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>args<span class="token punctuation">,</span> data<span class="token punctuation">.</span>flags<span class="token punctuation">,</span> data<span class="token punctuation">.</span>startId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    s<span class="token punctuation">.</span><span class="token function">onTaskRemoved</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    res <span class="token operator">=</span> Service<span class="token punctuation">.</span>START_TASK_REMOVED_COMPLETE<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                QueuedWork<span class="token punctuation">.</span><span class="token function">waitToFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serviceDoneExecuting</span><span class="token punctuation">(</span>
                            data<span class="token punctuation">.</span>token<span class="token punctuation">,</span> SERVICE_DONE_EXECUTING_START<span class="token punctuation">,</span> data<span class="token punctuation">.</span>startId<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">ensureJitEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.从mServices获取到已经实例化的Service对象，如果ServiceArgsData的taskRemoved为false(都为false，除非是进程销毁时候才会出现taskRemoved是true)，则回调Service的onStartCommand；否则则回调onTaskRemoved方法</li>
<li>2.QueuedWork调用waitToFinish方法，阻塞SharePreference把所有的数据写入到磁盘中。</li>
<li>3.serviceDoneExecuting 移除ANR超时消息</li>
</ul>
<h2 id="bindService-原理"><a href="#bindService-原理" class="headerlink" title="bindService 原理"></a>bindService 原理</h2><p>bindService在开发中用的不是很多，这里稍微提一下他的使用。<br>首先申明一个ServiceConnection对象，用于绑定服务端的Service。</p>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">private</span> ServiceConnection conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder binder<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            MyBinder myBinder <span class="token operator">=</span> MyBinder<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>binder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service <span class="token operator">=</span> myBinder<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> num <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getRandomNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isBound <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">            Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TestService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">bindService</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> BIND_AUTO_CREATE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>调用bindService的方法绑定到某个Service中。当服务端的service成功回调onBind方法，我们只需要返回对应的Binder对象。就能使用调用bindService的客户端在ServiceConnection的onServiceConnected的回调中获得Binder对象。</p>
<p>之后就能通过这个Binder调用本进程或者其他进程的的方法了。实际上我们可以把这个过程看成一个多对多的服务-客户端模型。多个客户端通过Binder向多服务端Service通信，每一次我们都可以通过ComponentName判断不同服务返回来的Binder对象。</p>
<h3 id="bindService的入口-bindServiceCommon"><a href="#bindService的入口-bindServiceCommon" class="headerlink" title="bindService的入口  bindServiceCommon"></a>bindService的入口  bindServiceCommon</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">bindServiceCommon</span><span class="token punctuation">(</span>Intent service<span class="token punctuation">,</span> ServiceConnection conn<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> Handler
            handler<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        IServiceConnection sd<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"connection is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sd <span class="token operator">=</span> mPackageInfo<span class="token punctuation">.</span><span class="token function">getServiceDispatcher</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token function">getOuterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Not supported in system context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">validateServiceIntent</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            IBinder token <span class="token operator">=</span> <span class="token function">getActivityToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>BIND_AUTO_CREATE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mPackageInfo <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> mPackageInfo<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>targetSdkVersion
                    <span class="token operator">&lt;</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>ICE_CREAM_SANDWICH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                flags <span class="token operator">|=</span> BIND_WAIVE_PRIORITY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            service<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindService</span><span class="token punctuation">(</span>
                mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getActivityToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">,</span>
                service<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                sd<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token function">getOpPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>
                        <span class="token string">"Not allowed to bind to service "</span> <span class="token operator">+</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.作为参数的ServiceConnection不能为空。</li>
<li>2.通过LoadedApk的getServiceDispatcher方法把ServiceConnection转化IServiceConnection对象。</li>
<li>3.调用AMS的bindService方法。</li>
</ul>
<h3 id="LoadedApk-getServiceDispatcher"><a href="#LoadedApk-getServiceDispatcher" class="headerlink" title="LoadedApk getServiceDispatcher"></a>LoadedApk getServiceDispatcher</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> IServiceConnection <span class="token function">getServiceDispatcher</span><span class="token punctuation">(</span>ServiceConnection c<span class="token punctuation">,</span>
            Context context<span class="token punctuation">,</span> Handler handler<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LoadedApk<span class="token punctuation">.</span>ServiceDispatcher sd <span class="token operator">=</span> null<span class="token punctuation">;</span>
            ArrayMap<span class="token operator">&lt;</span>ServiceConnection<span class="token punctuation">,</span> LoadedApk<span class="token punctuation">.</span>ServiceDispatcher<span class="token operator">></span> map <span class="token operator">=</span> mServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sd <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sd <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceDispatcher</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> context<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mServices<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                sd<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> sd<span class="token punctuation">.</span><span class="token function">getIServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面很简单，和BroadcastReceiver的思路很像。动态注册的BroadcastReceiver会封装成一个ReceiverDispatcher，而这里把ServiceConnection封装成LoadedApk.ServiceDispatcher对象。</p>
<p>并且会把ServiceDispatcher作为value，ServiceConnection作为key缓存一个map中。并且以context为key，把这个临时的map作为value缓存起来。这样一个Context就映射有了多个ServiceDispatcher对象，也就可以注册多个监听被绑定Service状态的监听者了。</p>
<h3 id="核心对象ServiceDispatcher的介绍"><a href="#核心对象ServiceDispatcher的介绍" class="headerlink" title="核心对象ServiceDispatcher的介绍"></a>核心对象ServiceDispatcher的介绍</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ServiceDispatcher</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> ServiceDispatcher<span class="token punctuation">.</span>InnerConnection mIServiceConnection<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> ServiceConnection mConnection<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> Context mContext<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> Handler mActivityThread<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> ServiceConnectionLeaked mLocation<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> mFlags<span class="token punctuation">;</span>

        <span class="token keyword">private</span> RuntimeException mUnbindLocation<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">boolean</span> mForgotten<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionInfo</span> <span class="token punctuation">{</span>
            IBinder binder<span class="token punctuation">;</span>
            IBinder<span class="token punctuation">.</span>DeathRecipient deathMonitor<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InnerConnection</span> <span class="token keyword">extends</span> <span class="token class-name">IServiceConnection<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> WeakReference<span class="token operator">&lt;</span>LoadedApk<span class="token punctuation">.</span>ServiceDispatcher<span class="token operator">></span> mDispatcher<span class="token punctuation">;</span>

            <span class="token function">InnerConnection</span><span class="token punctuation">(</span>LoadedApk<span class="token punctuation">.</span>ServiceDispatcher sd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span>LoadedApk<span class="token punctuation">.</span>ServiceDispatcher<span class="token operator">></span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dead<span class="token punctuation">)</span>
                    <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
                LoadedApk<span class="token punctuation">.</span>ServiceDispatcher sd <span class="token operator">=</span> mDispatcher<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sd <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sd<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> dead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayMap<span class="token operator">&lt;</span>ComponentName<span class="token punctuation">,</span> ServiceDispatcher<span class="token punctuation">.</span>ConnectionInfo<span class="token operator">></span> mActiveConnections
            <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span>ComponentName<span class="token punctuation">,</span> ServiceDispatcher<span class="token punctuation">.</span>ConnectionInfo<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">ServiceDispatcher</span><span class="token punctuation">(</span>ServiceConnection conn<span class="token punctuation">,</span>
                Context context<span class="token punctuation">,</span> Handler activityThread<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mIServiceConnection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InnerConnection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mConnection <span class="token operator">=</span> conn<span class="token punctuation">;</span>
            mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
            mActivityThread <span class="token operator">=</span> activityThread<span class="token punctuation">;</span>
            mLocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConnectionLeaked</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mLocation<span class="token punctuation">.</span><span class="token function">fillInStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mFlags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        ServiceConnectionLeaked <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mLocation<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ServiceConnection <span class="token function">getServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mConnection<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        IServiceConnection <span class="token function">getIServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mIServiceConnection<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityThread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mActivityThread<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RunConnection</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> dead<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">doConnected</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> dead<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">death</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityThread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mActivityThread<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RunConnection</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">doDeath</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doConnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ServiceDispatcher<span class="token punctuation">.</span>ConnectionInfo old<span class="token punctuation">;</span>
            ServiceDispatcher<span class="token punctuation">.</span>ConnectionInfo info<span class="token punctuation">;</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mForgotten<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                old <span class="token operator">=</span> mActiveConnections<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> old<span class="token punctuation">.</span>binder <span class="token operator">==</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    info<span class="token punctuation">.</span>binder <span class="token operator">=</span> service<span class="token punctuation">;</span>
                    info<span class="token punctuation">.</span>deathMonitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeathMonitor</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        service<span class="token punctuation">.</span><span class="token function">linkToDeath</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>deathMonitor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mActiveConnections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        mActiveConnections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mActiveConnections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    old<span class="token punctuation">.</span>binder<span class="token punctuation">.</span><span class="token function">unlinkToDeath</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span>deathMonitor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mConnection<span class="token punctuation">.</span><span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mConnection<span class="token punctuation">.</span><span class="token function">onBindingDied</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mConnection<span class="token punctuation">.</span><span class="token function">onServiceConnected</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                mConnection<span class="token punctuation">.</span><span class="token function">onNullBinding</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doDeath</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ConnectionInfo old <span class="token operator">=</span> mActiveConnections<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> null <span class="token operator">||</span> old<span class="token punctuation">.</span>binder <span class="token operator">!=</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Death for someone different than who we last</span>
                    <span class="token comment" spellcheck="true">// reported...  just ignore it.</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mActiveConnections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                old<span class="token punctuation">.</span>binder<span class="token punctuation">.</span><span class="token function">unlinkToDeath</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span>deathMonitor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mConnection<span class="token punctuation">.</span><span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RunConnection</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
            <span class="token function">RunConnection</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">,</span> <span class="token keyword">int</span> command<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mName <span class="token operator">=</span> name<span class="token punctuation">;</span>
                mService <span class="token operator">=</span> service<span class="token punctuation">;</span>
                mCommand <span class="token operator">=</span> command<span class="token punctuation">;</span>
                mDead <span class="token operator">=</span> dead<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mCommand <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">doConnected</span><span class="token punctuation">(</span>mName<span class="token punctuation">,</span> mService<span class="token punctuation">,</span> mDead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mCommand <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">doDeath</span><span class="token punctuation">(</span>mName<span class="token punctuation">,</span> mService<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> ComponentName mName<span class="token punctuation">;</span>
            <span class="token keyword">final</span> IBinder mService<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> mCommand<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> mDead<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DeathMonitor</span> <span class="token keyword">implements</span> <span class="token class-name">IBinder<span class="token punctuation">.</span>DeathRecipient</span>
        <span class="token punctuation">{</span>
            <span class="token function">DeathMonitor</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mName <span class="token operator">=</span> name<span class="token punctuation">;</span>
                mService <span class="token operator">=</span> service<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">binderDied</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">death</span><span class="token punctuation">(</span>mName<span class="token punctuation">,</span> mService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> ComponentName mName<span class="token punctuation">;</span>
            <span class="token keyword">final</span> IBinder mService<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个类我们可以对照BroadcastReceiver的原理进行对照学习。</p>
<ul>
<li>ServiceDispatcher.InnerConnection 这个InnerConnection对象是用于监听被绑定服务的状态，是一个Binder对象，也就说可以跨进程监听被绑定的服务状态。</li>
</ul>
<p>一旦ServiceConnection的声明周期发生了变化，InnerConnection首先会得知状态的变化，从而回调ServiceDispatcher进行处理。</p>
<ul>
<li>ServiceDispatcher 是整个Service分发ServiceConnection事件的核心。注意，它持有3个关键对象：<ul>
<li>mIServiceConnection 代表当前ServiceDispatcher对象对应的Binder对象</li>
<li>mActiveConnections 集合。每一次当一个新的Service返回了绑定成功的消息后，就会把这个Service的类名等信息保存到mActiveConnections中。</li>
<li>mConnection 就是bindService注册进来的监听者，每当被绑定的Service发生了变化，就会通过这个接口回调。</li>
</ul>
</li>
</ul>
<h3 id="AMS-bindService"><a href="#AMS-bindService" class="headerlink" title="AMS bindService"></a>AMS bindService</h3><pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">bindService</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span> Intent service<span class="token punctuation">,</span>
            String resolvedType<span class="token punctuation">,</span> IServiceConnection connection<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String callingPackage<span class="token punctuation">,</span>
            <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransactionTooLargeException <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mServices<span class="token punctuation">.</span><span class="token function">bindServiceLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> token<span class="token punctuation">,</span> service<span class="token punctuation">,</span>
                    resolvedType<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是调用了ActiveServices的bindServiceLocked方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">int</span> <span class="token function">bindServiceLocked</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span> Intent service<span class="token punctuation">,</span>
            String resolvedType<span class="token punctuation">,</span> <span class="token keyword">final</span> IServiceConnection connection<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
            String callingPackage<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransactionTooLargeException <span class="token punctuation">{</span>

        <span class="token keyword">final</span> ProcessRecord callerApp <span class="token operator">=</span> mAm<span class="token punctuation">.</span><span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ActivityRecord activity <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            activity <span class="token operator">=</span> ActivityRecord<span class="token punctuation">.</span><span class="token function">isInStackLocked</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        ServiceLookupResult res <span class="token operator">=</span>
            <span class="token function">retrieveServiceLocked</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> callerFg<span class="token punctuation">,</span> isBindExternal<span class="token punctuation">,</span> allowInstant<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>record <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ServiceRecord s <span class="token operator">=</span> res<span class="token punctuation">.</span>record<span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> permissionsReviewRequired <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//此时config_permissionReviewRequired 是false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAm<span class="token punctuation">.</span>mPermissionReviewRequired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            AppBindRecord b <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">retrieveAppBindingLocked</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> callerApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ConnectionRecord c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionRecord</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> activity<span class="token punctuation">,</span>
                    connection<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> clientLabel<span class="token punctuation">,</span> clientIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>

            IBinder binder <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ArrayList<span class="token operator">&lt;</span>ConnectionRecord<span class="token operator">></span> clist <span class="token operator">=</span> s<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>binder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clist <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                clist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>ConnectionRecord<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                s<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>binder<span class="token punctuation">,</span> clist<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            clist<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            b<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>activity<span class="token punctuation">.</span>connections <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    activity<span class="token punctuation">.</span>connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>ConnectionRecord<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                activity<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            b<span class="token punctuation">.</span>client<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>Context<span class="token punctuation">.</span>BIND_ABOVE_CLIENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span>client<span class="token punctuation">.</span>hasAboveClient <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>Context<span class="token punctuation">.</span>BIND_ALLOW_WHITELIST_MANAGEMENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                s<span class="token punctuation">.</span>whitelistManager <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">updateServiceClientActivitiesLocked</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>app<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            clist <span class="token operator">=</span> mServiceConnections<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>binder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clist <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                clist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>ConnectionRecord<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mServiceConnections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>binder<span class="token punctuation">,</span> clist<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            clist<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>Context<span class="token punctuation">.</span>BIND_AUTO_CREATE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                s<span class="token punctuation">.</span>lastActivity <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bringUpServiceLocked</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callerFg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        permissionsReviewRequired<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>Context<span class="token punctuation">.</span>BIND_TREAT_LIKE_ACTIVITY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    s<span class="token punctuation">.</span>app<span class="token punctuation">.</span>treatLikeActivity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>whitelistManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    s<span class="token punctuation">.</span>app<span class="token punctuation">.</span>whitelistManager <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mAm<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>app<span class="token punctuation">,</span> s<span class="token punctuation">.</span>app<span class="token punctuation">.</span>hasClientActivities
                        <span class="token operator">||</span> s<span class="token punctuation">.</span>app<span class="token punctuation">.</span>treatLikeActivity<span class="token punctuation">,</span> b<span class="token punctuation">.</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAm<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>intent<span class="token punctuation">.</span>received<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    c<span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">,</span> b<span class="token punctuation">.</span>intent<span class="token punctuation">.</span>binder<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>intent<span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>intent<span class="token punctuation">.</span>doRebind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">requestServiceBindingLocked</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> b<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> callerFg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">.</span>intent<span class="token punctuation">.</span>requested<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">requestServiceBindingLocked</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> b<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> callerFg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">getServiceMapLocked</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ensureNotStartingBackgroundLocked</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.ServiceRecord调用retrieveAppBindingLocked 根据当前的ServiceRecord,Intent 生成一个IntentBindRecord对象后，以Intent.FilterComparison为key，IntentBindRecord为value保存到ServiceRecord的bindings中。如果bindings通过IntentFilter找到对应存在的IntentBindRecord则直接获取。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">final</span> ArrayMap<span class="token operator">&lt;</span>Intent<span class="token punctuation">.</span>FilterComparison<span class="token punctuation">,</span> IntentBindRecord<span class="token operator">></span> bindings
          <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span>Intent<span class="token punctuation">.</span>FilterComparison<span class="token punctuation">,</span> IntentBindRecord<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> AppBindRecord <span class="token function">retrieveAppBindingLocked</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span>
          ProcessRecord app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Intent<span class="token punctuation">.</span>FilterComparison filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent<span class="token punctuation">.</span>FilterComparison</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      IntentBindRecord i <span class="token operator">=</span> bindings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          i <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentBindRecord</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
          bindings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      AppBindRecord a <span class="token operator">=</span> i<span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> a<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppBindRecord</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
      i<span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> a<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在从IntentBindRecord的apps集合中查找AppBindRecord对象，找到返回，找不到则生成全新返回。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">final</span> ArrayMap<span class="token operator">&lt;</span>ProcessRecord<span class="token punctuation">,</span> AppBindRecord<span class="token operator">></span> apps
          <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span>ProcessRecord<span class="token punctuation">,</span> AppBindRecord<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>如果能够从bindings集合，通过意图过滤找到对应的IntentBindRecord，又通过IntentBindRecord的apps集合，通过ProcessRecord找到AppBindRecord对象。</p>
<p>而AppBindRecord这个对象最终会保存了所有的IServiceConnection。通过这样的关系就能通过Intent意图和ProcessRecord进程对象找到需要发送绑定监听对象。</p>
<ul>
<li><p>2.retrieveServiceLocked 从ServiceMap或者PMS中解析出需要绑定或者启动的ServiceRecord对象，并包裹成ServiceLookupResult对象返回。</p>
</li>
<li><p>3.把IServiceConnection通过ConnectionRecord包裹起来。并且获取ServiceRecord中的connections这个ArrayMap集合。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">final</span> ArrayMap<span class="token operator">&lt;</span>IBinder<span class="token punctuation">,</span> ArrayList<span class="token operator">&lt;</span>ConnectionRecord<span class="token operator">>></span> connections
          <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span>IBinder<span class="token punctuation">,</span> ArrayList<span class="token operator">&lt;</span>ConnectionRecord<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在每一个ServiceRecord中，以IBinder对象为key(也就是IServiceConnection)，并且保存以ConnectionRecord集合为value。保存一个Binder对应多个ServiceDispatcher的情况。</p>
</li>
</ul>
<p>最后把这个包装了IServiceConnection的ConnectionRecord保存到connections的value的list中。</p>
<ul>
<li><p>4.AppBinderRecord的connections集合也保存了ConnectionRecord对象。</p>
</li>
<li><p>5.如果当前调用bindService的ContextImpl是一个Activity，那么就会在对应的ActivityToken的HashSet<connectionrecord>中保存ConnectionRecord。</connectionrecord></p>
</li>
<li><p>6.在ProcessRecord创建或者获取ArraySet<connectionrecord>对象，并把新的ConnectionRecord保存到这个Set中。</connectionrecord></p>
</li>
<li><p>7.同样在ActiveServices中有一个和ServiceRecord相同的connections集合。</p>
</li>
<li><p>8.如果打开了Context.BIND_AUTO_CREATE这标志位，说明此时bindService执行中发现Service没有启动，则调用bringUpServiceLocked进行启动Service。如果bringUpServiceLocked成功的启动了Service，就不继续走下面的逻辑，直接返回了。</p>
</li>
<li><p>9.下面就是Service默认是已经创建，Service的进程存活，且IntentBindRecord的receiver为true。则会调用ConnectionRecord中的IServiceConnection这个Binder对象的跨进程方法connected，也就是调用ServiceDispatcher的InnerConnection的connected方法。</p>
</li>
</ul>
<p>我们来考察一下之前在bringUpServiceLocked中忽略过的绑定Service逻辑，也就是在realStartServiceLocked调用的requestServiceBindingLocked方法。</p>
<h4 id="requestServiceBindingLocked"><a href="#requestServiceBindingLocked" class="headerlink" title="requestServiceBindingLocked"></a>requestServiceBindingLocked</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">requestServiceBindingsLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> execInFg<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> TransactionTooLargeException <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>r<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            IntentBindRecord ibr <span class="token operator">=</span> r<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">requestServiceBindingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ibr<span class="token punctuation">,</span> execInFg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上那个就是获取ServiceRecord中所有的IntentBindRecord，调用requestServiceBindingLocked方法进行绑定。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">requestServiceBindingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> IntentBindRecord i<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> execInFg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> rebind<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransactionTooLargeException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">==</span> null <span class="token operator">||</span> r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>i<span class="token punctuation">.</span>requested <span class="token operator">||</span> rebind<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> execInFg<span class="token punctuation">,</span> <span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">forceProcessStateUpTo</span><span class="token punctuation">(</span>ActivityManager<span class="token punctuation">.</span>PROCESS_STATE_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleBindService</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> i<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rebind<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rebind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    i<span class="token punctuation">.</span>requested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                i<span class="token punctuation">.</span>hasBound <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                i<span class="token punctuation">.</span>doRebind <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionTooLargeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心方法就是跨进程调用ApplicationThread的scheduleBindService方法。</p>
<h4 id="ActivityThread-handleBindService"><a href="#ActivityThread-handleBindService" class="headerlink" title="ActivityThread handleBindService"></a>ActivityThread handleBindService</h4><p>这个方法会通过ActivityThread主线程handler发送绑定服务的消息，也就是handleBindService</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleBindService</span><span class="token punctuation">(</span>BindServiceData data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Service s <span class="token operator">=</span> mServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>rebind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        IBinder binder <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">onBind</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">publishService</span><span class="token punctuation">(</span>
                                data<span class="token punctuation">.</span>token<span class="token punctuation">,</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> binder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        s<span class="token punctuation">.</span><span class="token function">onRebind</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serviceDoneExecuting</span><span class="token punctuation">(</span>
                                data<span class="token punctuation">.</span>token<span class="token punctuation">,</span> SERVICE_DONE_EXECUTING_ANON<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">ensureJitEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.调用Service的onBind方法，获取从Service中返回的允许客户端操作的Binder对象。跨进程调用AMS的publishService方法，把需要返回的Binder返回给客户端。</li>
<li>2.如果从BindServiceData中判断到当前的Service需要重新绑定则回调onRebind方法。调用serviceDoneExecuting方法告诉AMS已经接受了当前的执行任务。从而拆下ANR消息。</li>
</ul>
<h4 id="AMS-publishService"><a href="#AMS-publishService" class="headerlink" title="AMS publishService"></a>AMS publishService</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publishService</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span> IBinder service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            mServices<span class="token punctuation">.</span><span class="token function">publishServiceLocked</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ServiceRecord<span class="token punctuation">)</span>token<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">publishServiceLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span> IBinder service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Intent<span class="token punctuation">.</span>FilterComparison filter
                        <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent<span class="token punctuation">.</span>FilterComparison</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                IntentBindRecord b <span class="token operator">=</span> r<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>b<span class="token punctuation">.</span>received<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    b<span class="token punctuation">.</span>binder <span class="token operator">=</span> service<span class="token punctuation">;</span>
                    b<span class="token punctuation">.</span>requested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    b<span class="token punctuation">.</span>received <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> conni<span class="token operator">=</span>r<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> conni<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> conni<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ArrayList<span class="token operator">&lt;</span>ConnectionRecord<span class="token operator">></span> clist <span class="token operator">=</span> r<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>conni<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>clist<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ConnectionRecord c <span class="token operator">=</span> clist<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filter<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>binding<span class="token punctuation">.</span>intent<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                c<span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> mDestroyingServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>此时就会获得Intent的意图，通过ServiceRecord的bindings中找到IntentBindRecord，IntentBindRecord设置receiver为true。</p>
</li>
<li><p>遍历ServiceRecord的connections集合中所有的ConnectionRecord，如果发现Service的Intent意图过滤不匹配则进入下一个loop中；如果符合意图，则调用ConnectionRecord的IServiceConnection的connected方法。这个方法就会跨进程调用的ServiceDisptacher中InnerConnection的connected方法,把从Service的onBind返回的Binder对象传递到InnerConnection中。</p>
</li>
<li><p>serviceDoneExecutingLocked 执行完成任务行为，拆除Service的ANR消息。</p>
</li>
</ul>
<h3 id="InnerConnection-接受connect的行为"><a href="#InnerConnection-接受connect的行为" class="headerlink" title="InnerConnection 接受connect的行为"></a>InnerConnection 接受connect的行为</h3><pre class="line-numbers language-java"><code class="language-java">
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dead<span class="token punctuation">)</span>
                    <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
                LoadedApk<span class="token punctuation">.</span>ServiceDispatcher sd <span class="token operator">=</span> mDispatcher<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sd <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sd<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> dead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当InnerConnection接受到了connected的调用，这里就会调用ServiceDispatcher的connected，把IBinder传递过来。注意这个IBinder就是从Service的onBind方法返回的Binder对象。</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityThread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mActivityThread<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RunConnection</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> dead<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">doConnected</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> dead<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是调用doConnected，或者调用RunConnection Runnable对象执行其中的run方法。</p>
<h5 id="RunConnection-run"><a href="#RunConnection-run" class="headerlink" title="RunConnection run"></a>RunConnection run</h5><pre class="line-numbers language-java"><code class="language-java">            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mCommand <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">doConnected</span><span class="token punctuation">(</span>mName<span class="token punctuation">,</span> mService<span class="token punctuation">,</span> mDead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mCommand <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">doDeath</span><span class="token punctuation">(</span>mName<span class="token punctuation">,</span> mService<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里根据mCommand来执行doConnected进行ServiceConnection的绑定回调还是解绑回调。</p>
<p>这里是绑定，mCommand也为1。我们直接看doConnected。</p>
<h6 id="ServiceDispatcher-doConnected"><a href="#ServiceDispatcher-doConnected" class="headerlink" title="ServiceDispatcher doConnected"></a>ServiceDispatcher doConnected</h6><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doConnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ServiceDispatcher<span class="token punctuation">.</span>ConnectionInfo old<span class="token punctuation">;</span>
            ServiceDispatcher<span class="token punctuation">.</span>ConnectionInfo info<span class="token punctuation">;</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                old <span class="token operator">=</span> mActiveConnections<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> old<span class="token punctuation">.</span>binder <span class="token operator">==</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    info<span class="token punctuation">.</span>binder <span class="token operator">=</span> service<span class="token punctuation">;</span>
                    info<span class="token punctuation">.</span>deathMonitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeathMonitor</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        service<span class="token punctuation">.</span><span class="token function">linkToDeath</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>deathMonitor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mActiveConnections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mActiveConnections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mActiveConnections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    old<span class="token punctuation">.</span>binder<span class="token punctuation">.</span><span class="token function">unlinkToDeath</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span>deathMonitor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mConnection<span class="token punctuation">.</span><span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mConnection<span class="token punctuation">.</span><span class="token function">onBindingDied</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mConnection<span class="token punctuation">.</span><span class="token function">onServiceConnected</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                mConnection<span class="token punctuation">.</span><span class="token function">onNullBinding</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.把传递给客户端的Binder 封装到ConnectionInfo中。如果通过ComponentName查找到，本次发送给客户端的Binder和上一次的对象一致则直接返回。</p>
</li>
<li><p>2.为当前的Binder通过linkToDeath绑定Binder的死亡监听。如果这个发送给客户端操作的Binder对象死亡了，则会回调DeathMonitor，移除mActiveConnections中的对应Service名字的ConnectionInfo。这样就移除了还在活跃的Binder的缓存对象。</p>
</li>
<li><p>3.mActiveConnections 根据当前传递过来的Service的ComponentName为key，保存ConnectionInfo。</p>
</li>
<li><p>4.如果上一次的Binder对象不为空则解绑死亡监听，先回调onServiceDisconnected方法，告诉这个Binder已经解开了链接。如果此时Serice还是经历了stop的方法需要销毁了，还会执行onBindingDied方法，告诉客户端，远程端已经死亡了。</p>
</li>
<li><p>5.如果是新的不同对象，则会调用onServiceConnected分发Binder对象，告诉客户端已经绑定了。</p>
</li>
</ul>
<h2 id="Service的销毁"><a href="#Service的销毁" class="headerlink" title="Service的销毁"></a>Service的销毁</h2><p>Service还能通过stopService结束当前的服务。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">stopServiceCommon</span><span class="token punctuation">(</span>Intent service<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">validateServiceIntent</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stopService</span><span class="token punctuation">(</span>
                mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">,</span>
                service<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>
                        <span class="token string">"Not allowed to stop service "</span> <span class="token operator">+</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是调用AMS的stopService方法。而这个方法实际上就是调用ActiveServices的stopService方法。</p>
<h4 id="ActiveServices-stopServiceLocked"><a href="#ActiveServices-stopServiceLocked" class="headerlink" title="ActiveServices stopServiceLocked"></a>ActiveServices stopServiceLocked</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">stopServiceLocked</span><span class="token punctuation">(</span>ServiceRecord service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">bringDownServiceIfNeededLocked</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bringDownServiceIfNeededLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> knowConn<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> hasConn<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">bringDownServiceLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是bringDownServiceLocked方法。</p>
<h5 id="bringDownServiceLocked"><a href="#bringDownServiceLocked" class="headerlink" title="bringDownServiceLocked"></a>bringDownServiceLocked</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bringDownServiceLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> conni<span class="token operator">=</span>r<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> conni<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> conni<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ArrayList<span class="token operator">&lt;</span>ConnectionRecord<span class="token operator">></span> c <span class="token operator">=</span> r<span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>conni<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>c<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ConnectionRecord cr <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

                cr<span class="token punctuation">.</span>serviceDead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    cr<span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>r<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                IntentBindRecord ibr <span class="token operator">=</span> r<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>ibr<span class="token punctuation">.</span>hasBound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"bring down unbind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mAm<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        ibr<span class="token punctuation">.</span>hasBound <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        ibr<span class="token punctuation">.</span>requested <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleUnbindService</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>
                                ibr<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">serviceProcessGoneLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>fgRequired<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            r<span class="token punctuation">.</span>fgRequired <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>fgWaiting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mAm<span class="token punctuation">.</span>mAppOpsService<span class="token punctuation">.</span><span class="token function">finishOperation</span><span class="token punctuation">(</span>AppOpsManager<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>mAm<span class="token punctuation">.</span>mAppOpsService<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    AppOpsManager<span class="token punctuation">.</span>OP_START_FOREGROUND<span class="token punctuation">,</span> r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>
                    ActivityManagerService<span class="token punctuation">.</span>SERVICE_FOREGROUND_TIMEOUT_MSG<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>


        r<span class="token punctuation">.</span>destroyTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">final</span> ServiceMap smap <span class="token operator">=</span> <span class="token function">getServiceMapLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServiceRecord found <span class="token operator">=</span> smap<span class="token punctuation">.</span>mServicesByName<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        smap<span class="token punctuation">.</span>mServicesByIntent<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>totalRestartCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">unscheduleServiceRestartLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>mPendingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mPendingServices<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">updateServiceForegroundLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"destroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mDestroyingServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>destroying <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    mAm<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleStopService</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token function">serviceProcessGoneLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程很简单，可以根据三个循环分为三个部分：</p>
<ul>
<li><p>1.在销毁之前，遍历ServiceRecord中所有的InnerConnection远程链接，并且调用connected方法，传递一个空的Binder对象，销毁存储在LoadedApk.ServiceDispatcher活跃的绑定监听。</p>
</li>
<li><p>2.遍历ServiceRecord所有的bindings存储的绑定的IntentBindRecord。先调用bumpServiceExecutingLocked埋下一个ANR消息。并且跨进程调用对应进程的scheduleUnbindService方法，把IntentBindRecord中存储的启动的意图传递过去。</p>
</li>
<li><p>3.如果是前台的服务还会移除SERVICE_FOREGROUND_TIMEOUT_MSG，前台服务执行任务超时ANR。</p>
</li>
<li><p>4.如果进程还存活，则bumpServiceExecutingLocked埋下销毁Service的ANR。更新进程的adj优先级后，跨进程调用scheduleStopService方法。</p>
</li>
</ul>
<p>我们来看看在ApplicationThread中的scheduleUnbindService和scheduleStopService。</p>
<h4 id="ActivityThread-handleUnbindService"><a href="#ActivityThread-handleUnbindService" class="headerlink" title="ActivityThread handleUnbindService"></a>ActivityThread handleUnbindService</h4><p>scheduleUnbindService最后会调用scheduleUnbindService方法。</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleUnbindService</span><span class="token punctuation">(</span>BindServiceData data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Service s <span class="token operator">=</span> mServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> doRebind <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">onUnbind</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>doRebind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unbindFinished</span><span class="token punctuation">(</span>
                                data<span class="token punctuation">.</span>token<span class="token punctuation">,</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> doRebind<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serviceDoneExecuting</span><span class="token punctuation">(</span>
                                data<span class="token punctuation">.</span>token<span class="token punctuation">,</span> SERVICE_DONE_EXECUTING_ANON<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从mServices缓存中获取Service对象，并执行onUnbind方法回调。如果onUnbind返回true说明需要重新绑定，则调用unbindFinished方法；否则则调用serviceDoneExecuting完成当前任务的执行。</p>
<h4 id="ActivityThread-handleStopService"><a href="#ActivityThread-handleStopService" class="headerlink" title="ActivityThread handleStopService"></a>ActivityThread handleStopService</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleStopService</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Service s <span class="token operator">=</span> mServices<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>

                s<span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                s<span class="token punctuation">.</span><span class="token function">detachAndCleanUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Context context <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> String who <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>ContextImpl<span class="token punctuation">)</span> context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleFinalCleanup</span><span class="token punctuation">(</span>who<span class="token punctuation">,</span> <span class="token string">"Service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                QueuedWork<span class="token punctuation">.</span><span class="token function">waitToFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serviceDoneExecuting</span><span class="token punctuation">(</span>
                            token<span class="token punctuation">,</span> SERVICE_DONE_EXECUTING_STOP<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.调用Service的onDestroy方法</li>
<li>2.Service的detachAndCleanUp  销毁保存在Service中的ServiceRecord这个Binder对象</li>
<li>3.QueuedWork 等待SP的写入消息的落盘</li>
<li>4.serviceDoneExecuting 通知ActiveServices的移除销毁ANR的Handler消息</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Service的启动原理实际上很简单，我这边分为startService和bindService两个方法将进行总结。</p>
<p>startService实际上和bindService执行流程十分相似。只是bindService多执行了几个步骤，直接上bindService和stopService的时序图:<br><img src="/images/Service.png" alt="Service.png"></p>
<h3 id="bindService-与-startService"><a href="#bindService-与-startService" class="headerlink" title="bindService 与 startService"></a>bindService 与 startService</h3><p>bindService绑定服务，如果在bindService方法就是BIND_AUTO_CREATE的标志位，就会包含了startService的逻辑。这里就用BIND_AUTO_CREATE的逻辑来统一说说整个流程都做了什么。</p>
<ul>
<li><p>1.在bindService进入AMS之前，就会调用LoadedApk.getServiceDispatcher获取一个ServiceDispatcher对象。</p>
<ul>
<li>1.1.而ServiceDispatcher这个对象包含了一个InnerConnection Binder对象。这个对象是用于直接沟通AMS的那边的回调，直接回调到ServiceConnection中。</li>
<li>1.2.ServiceDispatcher中本身就有mServices缓存，它缓存了已经启动过的ServiceDispatcher。是以当前ContextImpl为value，以<code>ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;</code>为value的Map。这样就会在同一个上下文中创建相同的服务分发者。</li>
</ul>
</li>
<li><p>2.进入AMS后，首先会通过<code>retrieveServiceLocked</code>从AMS中查找两个级别的缓存，一个是缓存在AMS中的缓存，一个是缓存在PMS的缓存。</p>
<ul>
<li>2.1.AMS的缓存的缓存中又分为两个缓存。一个是通过类名+包名查找ServiceRecord；一个是通过意图过滤器查找Service。</li>
<li>2.2.PMS中则是通过解析apk的AndroidManifest.xml的xml标签获得的。</li>
</ul>
</li>
<li><p>3.如果发现ServiceRecord已经绑定了ProcessRecord说明已经启动过了，则调用scheduleServiceArgs，触发Service的onStartCommand返回。</p>
</li>
<li><p>4.如果发现没有绑定过则说明需要启动过，则scheduleCreateService，调用ActivityThread的handleCreateService，依次执行Service的attach方法绑定ServiceRecord以及onCreate方法，并把新的Service缓存起来。</p>
</li>
<li><p>5.在AMS的<code>bindServiceLocked</code>中，会把IServiceConnection绑定到ServiceRecord的<code>ArrayMap&lt;Intent.FilterComparison, IntentBindRecord&gt;  bindings</code>集合中。注意在IntentBindRecord集合中就保存了一个特殊的集合<code>ArrayMap&lt;ProcessRecord, AppBindRecord&gt;</code>，而AppBindRecord实际上就是持有了核心的ConnectionRecord集合。而ConnectionRecord就是正在的持有IServiceConnection。</p>
</li>
</ul>
<p>弄的这么复杂，Google官方实际上指向做一件事：可以通过意图确定当前缓存的IServiceConnection 所指向的客户端进程，客户端的监听Service绑定接口对象。</p>
<ul>
<li><p>6.<code>requestServiceBindingsLocked</code>方法会遍历所有绑定在ServiceRecord的binding集合，并且调用每一个ServiceRecord对应的Service的onBind的方法。</p>
</li>
<li><p>7.onBind返回 Service服务端允许客户端操作的Binder对象，则调用AMS的publishService。在AMS中则会查找ServiceRecord的bindings集合，遍历每一个IServiceConnection.connected 尝试回调在<code>bindService</code>方法中绑定的ServiceConnection接口。</p>
</li>
<li><p>8.IServiceConnection Binder对象在客户端实际上对应就是<code>ServiceDispatcher</code>中的<code>InnerConnection</code>对象。这个对象在<code>connected</code>方法会调用<code>RunConnection</code>的run方法，他会调用ActivityThread的Handler中执行<code>doConnected</code>把服务端分发过来Binder缓存到mActiveConnections，最后回调<code>ServiceConnection.onServiceConnected</code></p>
</li>
<li><p>9.当启动和绑定都完成后，就会调用<code>sendServiceArgsLocked</code>方法。这个方法就是调用<code>ActivityThread. scheduleServiceArgs</code>方法。而这个方法最终调用Service的onStartCommand方法。注意这里分发的Intent就是之前启动service的Intent。当然onStartCommand会根据返回值在serviceDoneExecuting方法中决定了当Service执行完onStartCommand是否需要重启：</p>
</li>
<li><p>START_STICKY 如果Service调用了onStartCommand之后被销毁，会重新启动，如果中间没任何命令传递给Service，此时Intent为null。</p>
</li>
<li><p>START_NOT_STICKY 如果Service调用了onStartCommand之后被销毁，不会重启。</p>
</li>
<li><p>START_REDELIVER_INTENT 如果Service调用了onStartCommand之后被销毁，会重新启动，如果中间没任何命令传递给Service，此时Intent为初始数。</p>
</li>
<li><p>START_STICKY_COMPATIBILITY 兼容模式，不保证onStartCommand之后销毁会重启。</p>
</li>
</ul>
<p>在这个过程中又几个比较重要的缓存对象：</p>
<p><img src="/images/Service%E7%BC%93%E5%AD%98%E5%9B%BE%E8%A7%A3.png" alt="Service缓存图解.png"></p>
<h3 id="Service销毁"><a href="#Service销毁" class="headerlink" title="Service销毁"></a>Service销毁</h3><p>在<code>bringDownServiceLocked</code>做了三件事情:</p>
<ul>
<li>1.调用所有ServiceConnection的回调，回调onServiceDisconnected方法，并从活跃的Binder集合中移除</li>
<li>2.回调Service的onUnBind方法</li>
<li>3.回调Service的onDestroy方法和detachAndCleanUp销毁ServiceRecord</li>
</ul>
<h3 id="Service-的ANR与注意"><a href="#Service-的ANR与注意" class="headerlink" title="Service 的ANR与注意"></a>Service 的ANR与注意</h3><p>Service的ANR实际上是由<code>bumpServiceExecutingLocked</code>方法埋下的一个超时的ANR，超时时间根据是启动后台服务还是前台服务：</p>
<ul>
<li>前台服务是10秒</li>
<li>后台服务 不过进程不是在ProcessList.SCHED_GROUP_BACKGROUND进程组中是 20秒</li>
<li>后台服务 不过进程在ProcessList.SCHED_GROUP_BACKGROUND进程组中是 200秒</li>
</ul>
<p>当每一个Service执行完一个任务之后，都会执行serviceDoneExecutingLocked方法，把ActiveServices中的Handler的ANR倒计时消息移除。</p>
<p>有一点比较有意思的一点，启动服务有一个常见的问题，当通过startService启动Service的时候，会爆出错误。</p>
<pre class="line-numbers language-java"><code class="language-java">  Not allowed to start service Intent<span class="token punctuation">{</span>xxxx<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>禁止打开后台服务。在上面也有体现：如果startService返回的包名不是正常的包名而是一个<code>?</code>则会爆出这种错误。</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">if</span> <span class="token punctuation">(</span>forcedStandby <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>startRequested <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fgRequired<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Before going further -- if this app is not allowed to start services in the</span>
            <span class="token comment" spellcheck="true">// background, then at this point we aren't going to let it period.</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> allowed <span class="token operator">=</span> mAm<span class="token punctuation">.</span><span class="token function">getAppStartModeLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> forcedStandby<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>allowed <span class="token operator">!=</span> ActivityManager<span class="token punctuation">.</span>APP_START_MODE_NORMAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                UidRecord uidRec <span class="token operator">=</span> mAm<span class="token punctuation">.</span>mActiveUids<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">,</span> <span class="token string">"app is in background uid "</span> <span class="token operator">+</span> uidRec<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到如果此时fgRequired为false也就是非前台服务，会走入getAppStartModeLocked的校验。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">int</span> <span class="token function">getAppStartModeLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span> String packageName<span class="token punctuation">,</span> <span class="token keyword">int</span> packageTargetSdk<span class="token punctuation">,</span>
            <span class="token keyword">int</span> callingPid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> alwaysRestrict<span class="token punctuation">,</span> <span class="token keyword">boolean</span> disabledOnly<span class="token punctuation">,</span> <span class="token keyword">boolean</span> forcedStandby<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        UidRecord uidRec <span class="token operator">=</span> mActiveUids<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>uidRec <span class="token operator">==</span> null <span class="token operator">||</span> alwaysRestrict <span class="token operator">||</span> forcedStandby <span class="token operator">||</span> uidRec<span class="token punctuation">.</span>idle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> ephemeral<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> startMode <span class="token operator">=</span> <span class="token punctuation">(</span>alwaysRestrict<span class="token punctuation">)</span>
                        <span class="token operator">?</span> <span class="token function">appRestrictedInBackgroundLocked</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> packageName<span class="token punctuation">,</span> packageTargetSdk<span class="token punctuation">)</span>
                        <span class="token operator">:</span> <span class="token function">appServicesRestrictedInBackgroundLocked</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> packageName<span class="token punctuation">,</span>
                                packageTargetSdk<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> startMode<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>APP_START_MODE_NORMAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>mActiveUids收集的是启动的活跃应用进程uid。</p>
<ul>
<li>uidRec为空，必定是没有启动或者是后台进程</li>
<li>uidRec.idle为true，说明此时是启动过了但是呆在了后台超过60秒，从前台变化为后台进程。</li>
</ul>
<p>这两个情况都会appServicesRestrictedInBackgroundLocked进行校验：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">int</span> <span class="token function">appRestrictedInBackgroundLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span> String packageName<span class="token punctuation">,</span> <span class="token keyword">int</span> packageTargetSdk<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageTargetSdk <span class="token operator">>=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>O<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>APP_START_MODE_DELAYED_RIGID<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> appop <span class="token operator">=</span> mAppOpsService<span class="token punctuation">.</span><span class="token function">noteOperation</span><span class="token punctuation">(</span>AppOpsManager<span class="token punctuation">.</span>OP_RUN_IN_BACKGROUND<span class="token punctuation">,</span>
                uid<span class="token punctuation">,</span> packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>appop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> AppOpsManager<span class="token punctuation">.</span>MODE_ALLOWED<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// If force-background-check is enabled, restrict all apps that aren't whitelisted.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mForceBackgroundCheck <span class="token operator">&amp;&amp;</span>
                        <span class="token operator">!</span>UserHandle<span class="token punctuation">.</span><span class="token function">isCore</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                        <span class="token operator">!</span><span class="token function">isOnDeviceIdleWhitelistLocked</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/*allowExceptIdleToo=*/</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>APP_START_MODE_DELAYED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>校验出了不在白名单中，就会返回APP_START_MODE_DELAYED。此时不是APP_START_MODE_NORMAL就会返回带了<code>?</code>的包名从而报错。</p>
<p>一般的，我们还会作如下处理从startService改成startForegroundService。但是这样就又爆出了全新的错误。</p>
<pre class="line-numbers language-java"><code class="language-java">Context<span class="token punctuation">.</span><span class="token function">startForegroundService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> did not then call Service<span class="token punctuation">.</span><span class="token function">startForeground</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ActivityThread$H<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2204</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>写高版本的service 稍不注意都会遇到这种情况。这是因为你没有在Service中使用startForeground方法。如果我们超过10秒没有一般我们都会使用startForeground启动一个通知，告诉用户正在前台运行。</p>
<p>而startForeground实际上是移除超时ANR的行为。</p>
<p>但是有时候，就算startForeground还是会报错，即使把时机尽可能的提前了，放在了onCreate中，还是会报错了。</p>
<p>我们能够看到实际上这个过程中每当执行完Service的onStartCommand，就会等待SP写入到磁盘的阻塞，也有可能是这个时候的写入时间过长了导致的ANR,详情可看<a href="https://www.jianshu.com/p/ca1a2129523b" target="_blank" rel="noopener">SharedPreferences源码解析</a>。</p>
<p>另一种可能就是因为整个流程都是在主线程中执行的，看看主线程有没有其他太过耗时的行为，导致来不及移除前台服务的ANR消息。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>到这里Service已经全部解析了，接下来我们来看看四大组件最后一个ContentProvider。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/08/15/android-chong-xue-xi-lie-contentprovider-qi-dong-yuan-li/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="Android重学系列 ContentProvider 启动原理">
                        
                        <span class="card-title">Android重学系列 ContentProvider 启动原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言终于来到了四大组件的最后一个了，ContentProvider(之后简称CP)开发中用的不是很多，但这不代表这不重要。很多开源库不少巧妙的思路就是借用CP巧妙实现的，如头条的AutoSize是如何自动获取Context的，360的ReP
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-08-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-Framework/" class="post-category">
                                    Android Framework
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/08/01/android-chong-xue-xi-lie-broadcastreceiver-yuan-li/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="Android重学系列 BroadcastReceiver原理">
                        
                        <span class="card-title">Android重学系列 BroadcastReceiver原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言之前把Activity中View的绘制流程和IMS触点监听，来聊聊BroadcastReceiver中的原理。
正文BroadcastReceiver是广播监听器，一般是用于监听来自App内部或者外部的消息。广播的监听器一般分为2种注册
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-08-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-Framework/" class="post-category">
                                    Android Framework
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
