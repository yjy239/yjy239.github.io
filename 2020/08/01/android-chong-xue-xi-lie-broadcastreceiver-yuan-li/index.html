<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android重学系列 BroadcastReceiver原理, Android | Linux | Flutter">
    <meta name="description" content="前言之前把Activity中View的绘制流程和IMS触点监听，来聊聊BroadcastReceiver中的原理。
正文BroadcastReceiver是广播监听器，一般是用于监听来自App内部或者外部的消息。广播的监听器一般分为2种注册">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android重学系列 BroadcastReceiver原理 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/11.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android重学系列 BroadcastReceiver原理
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android-Framework/" class="post-category">
                                Android Framework
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-08-01
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        10.6k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        51 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前把Activity中View的绘制流程和IMS触点监听，来聊聊BroadcastReceiver中的原理。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>BroadcastReceiver是广播监听器，一般是用于监听来自App内部或者外部的消息。广播的监听器一般分为2种注册方式：</p>
<ul>
<li>使用registerReceiver动态注册BroadcastReceiver</li>
<li>在AndroidManifest.xml中注册好BroadcastReceiver</li>
</ul>
<p>简单的用法就不必多看，我们先来看看动态注册的核心原理。</p>
<h2 id="BroadcastReceiver-动态注册"><a href="#BroadcastReceiver-动态注册" class="headerlink" title="BroadcastReceiver 动态注册"></a>BroadcastReceiver 动态注册</h2><p>方法入口是registerReceiver。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ContextImpl.java" target="_blank" rel="noopener">ContextImpl.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Intent <span class="token function">registerReceiver</span><span class="token punctuation">(</span>BroadcastReceiver receiver<span class="token punctuation">,</span> IntentFilter filter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Intent <span class="token function">registerReceiver</span><span class="token punctuation">(</span>BroadcastReceiver receiver<span class="token punctuation">,</span> IntentFilter filter<span class="token punctuation">,</span>
            <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Intent <span class="token function">registerReceiver</span><span class="token punctuation">(</span>BroadcastReceiver receiver<span class="token punctuation">,</span> IntentFilter filter<span class="token punctuation">,</span>
            String broadcastPermission<span class="token punctuation">,</span> Handler scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">registerReceiverInternal</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                filter<span class="token punctuation">,</span> broadcastPermission<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span> <span class="token function">getOuterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Intent <span class="token function">registerReceiver</span><span class="token punctuation">(</span>BroadcastReceiver receiver<span class="token punctuation">,</span> IntentFilter filter<span class="token punctuation">,</span>
            String broadcastPermission<span class="token punctuation">,</span> Handler scheduler<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">registerReceiverInternal</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                filter<span class="token punctuation">,</span> broadcastPermission<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span> <span class="token function">getOuterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> Intent <span class="token function">registerReceiverInternal</span><span class="token punctuation">(</span>BroadcastReceiver receiver<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span>
            IntentFilter filter<span class="token punctuation">,</span> String broadcastPermission<span class="token punctuation">,</span>
            Handler scheduler<span class="token punctuation">,</span> Context context<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        IIntentReceiver rd <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageInfo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> context <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    scheduler <span class="token operator">=</span> mMainThread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                rd <span class="token operator">=</span> mPackageInfo<span class="token punctuation">.</span><span class="token function">getReceiverDispatcher</span><span class="token punctuation">(</span>
                    receiver<span class="token punctuation">,</span> context<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span>
                    mMainThread<span class="token punctuation">.</span><span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> Intent intent <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerReceiver</span><span class="token punctuation">(</span>
                    mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mBasePackageName<span class="token punctuation">,</span> rd<span class="token punctuation">,</span> filter<span class="token punctuation">,</span>
                    broadcastPermission<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> intent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>大致上分为2个步骤：</p>
<ul>
<li>调用LoadedApk的getReceiverDispatcher方法获取IIntentReceiver对象</li>
<li>调用AMS的服务端的registerReceiver方法，把IIntentReceiver作为参数设置进去启动。</li>
</ul>
<h3 id="LoadedApk-getReceiverDispatcher"><a href="#LoadedApk-getReceiverDispatcher" class="headerlink" title="LoadedApk getReceiverDispatcher"></a>LoadedApk getReceiverDispatcher</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> IIntentReceiver <span class="token function">getReceiverDispatcher</span><span class="token punctuation">(</span>BroadcastReceiver r<span class="token punctuation">,</span>
            Context context<span class="token punctuation">,</span> Handler handler<span class="token punctuation">,</span>
            Instrumentation instrumentation<span class="token punctuation">,</span> <span class="token keyword">boolean</span> registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mReceivers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher rd <span class="token operator">=</span> null<span class="token punctuation">;</span>
            ArrayMap<span class="token operator">&lt;</span>BroadcastReceiver<span class="token punctuation">,</span> LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher<span class="token operator">></span> map <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                map <span class="token operator">=</span> mReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    rd <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rd <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                rd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReceiverDispatcher</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> context<span class="token punctuation">,</span> handler<span class="token punctuation">,</span>
                        instrumentation<span class="token punctuation">,</span> registered<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span>BroadcastReceiver<span class="token punctuation">,</span> LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mReceivers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> rd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                rd<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            rd<span class="token punctuation">.</span>mForgotten <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> rd<span class="token punctuation">.</span><span class="token function">getIIntentReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中能看到在LoadApk中缓存了一个mReceivers的Map对象。mReceivers对象实际上缓存了ArrayMap对象。这个ArrayMap对象一个BroadcastReceiver对象对应一个ReceiverDispatcher。</p>
<p>这样就能通过当前注册的上下文Context，找到缓存的BroadcastReceiver，进一步找到缓存的ReceiverDispatcher。</p>
<p>当缓存的map中不存在对应的ReceiverDispatcher，那就需要生成一个新的ReceiverDispatcher保存到map中。</p>
<p>ReceiverDispatcher是做什么的呢？顾名思义，实际上是BroadcastReceiver的广播事件分发者。</p>
<p>拿到ReceiverDispatcher后，返回ReceiverDispatcher中的IIntentReceiver这个Binder远程端对象</p>
<h4 id="ReceiverDispatcher-广播事件分发者介绍"><a href="#ReceiverDispatcher-广播事件分发者介绍" class="headerlink" title="ReceiverDispatcher 广播事件分发者介绍"></a>ReceiverDispatcher 广播事件分发者介绍</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ReceiverDispatcher</span> <span class="token punctuation">{</span>

        <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InnerReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">IIntentReceiver<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> WeakReference<span class="token operator">&lt;</span>LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher<span class="token operator">></span> mDispatcher<span class="token punctuation">;</span>
            <span class="token keyword">final</span> LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher mStrongRef<span class="token punctuation">;</span>

            <span class="token function">InnerReceiver</span><span class="token punctuation">(</span>LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher rd<span class="token punctuation">,</span> <span class="token keyword">boolean</span> strong<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span>LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher<span class="token operator">></span><span class="token punctuation">(</span>rd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mStrongRef <span class="token operator">=</span> strong <span class="token operator">?</span> rd <span class="token operator">:</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performReceive</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String data<span class="token punctuation">,</span>
                    Bundle extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher rd<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Log<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Null intent received"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    rd <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    rd <span class="token operator">=</span> mDispatcher<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>rd <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    rd<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span>
                            ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                    IActivityManager mgr <span class="token operator">=</span> ActivityManagerNative<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>extras <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            extras<span class="token punctuation">.</span><span class="token function">setAllowFds</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        mgr<span class="token punctuation">.</span><span class="token function">finishReceiver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> IIntentReceiver<span class="token punctuation">.</span>Stub mIIntentReceiver<span class="token punctuation">;</span>
        <span class="token keyword">final</span> BroadcastReceiver mReceiver<span class="token punctuation">;</span>
        <span class="token keyword">final</span> Context mContext<span class="token punctuation">;</span>
        <span class="token keyword">final</span> Handler mActivityThread<span class="token punctuation">;</span>
        <span class="token keyword">final</span> Instrumentation mInstrumentation<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> mRegistered<span class="token punctuation">;</span>
        <span class="token keyword">final</span> IntentReceiverLeaked mLocation<span class="token punctuation">;</span>
        RuntimeException mUnregisterLocation<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> mForgotten<span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver<span class="token punctuation">.</span>PendingResult</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
            <span class="token keyword">private</span> Intent mCurIntent<span class="token punctuation">;</span>
            <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> mOrdered<span class="token punctuation">;</span>
            <span class="token keyword">private</span> <span class="token keyword">boolean</span> mDispatched<span class="token punctuation">;</span>

            <span class="token keyword">public</span> <span class="token function">Args</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String resultData<span class="token punctuation">,</span> Bundle resultExtras<span class="token punctuation">,</span>
                    <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">super</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span>
                        mRegistered <span class="token operator">?</span> TYPE_REGISTERED <span class="token operator">:</span> TYPE_UNREGISTERED<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
                        sticky<span class="token punctuation">,</span> mIIntentReceiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendingUser<span class="token punctuation">,</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mCurIntent <span class="token operator">=</span> intent<span class="token punctuation">;</span>
                mOrdered <span class="token operator">=</span> ordered<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> BroadcastReceiver receiver <span class="token operator">=</span> mReceiver<span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> ordered <span class="token operator">=</span> mOrdered<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">final</span> IActivityManager mgr <span class="token operator">=</span> ActivityManagerNative<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> Intent intent <span class="token operator">=</span> mCurIntent<span class="token punctuation">;</span>

                mCurIntent <span class="token operator">=</span> null<span class="token punctuation">;</span>
                mDispatched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">==</span> null <span class="token operator">||</span> intent <span class="token operator">==</span> null <span class="token operator">||</span> mForgotten<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    ClassLoader cl <span class="token operator">=</span>  mReceiver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    receiver<span class="token punctuation">.</span><span class="token function">setPendingResult</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    receiver<span class="token punctuation">.</span><span class="token function">onReceive</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">getPendingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">ReceiverDispatcher</span><span class="token punctuation">(</span>BroadcastReceiver receiver<span class="token punctuation">,</span> Context context<span class="token punctuation">,</span>
                Handler activityThread<span class="token punctuation">,</span> Instrumentation instrumentation<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>activityThread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"Handler must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mIIntentReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InnerReceiver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">!</span>registered<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mReceiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span>
            mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
            mActivityThread <span class="token operator">=</span> activityThread<span class="token punctuation">;</span>
            mInstrumentation <span class="token operator">=</span> instrumentation<span class="token punctuation">;</span>
            mRegistered <span class="token operator">=</span> registered<span class="token punctuation">;</span>
            mLocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentReceiverLeaked</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mLocation<span class="token punctuation">.</span><span class="token function">fillInStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        IntentReceiverLeaked <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mLocation<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        BroadcastReceiver <span class="token function">getIntentReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mReceiver<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        IIntentReceiver <span class="token function">getIIntentReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mIIntentReceiver<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">setUnregisterLocation</span><span class="token punctuation">(</span>RuntimeException ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mUnregisterLocation <span class="token operator">=</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        RuntimeException <span class="token function">getUnregisterLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mUnregisterLocation<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performReceive</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String data<span class="token punctuation">,</span>
                Bundle extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> Args args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
                    sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>mActivityThread<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    IActivityManager mgr <span class="token operator">=</span> ActivityManagerNative<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    args<span class="token punctuation">.</span><span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在ReceiverDispatcher中，能看到两个内部类：</p>
<ul>
<li>InnerReceiver</li>
<li>Args</li>
</ul>
<p>实际上，如果跟着我写的系列一直阅读过来的读者，就能理解明白他们之间的联系。</p>
<ul>
<li><p>InnerReceiver 是Binder的客户端(远程端)直接接收Binder传递过来的消息。他持有了ReceiverDispatcher对象。一旦接收到消息后调用ReceiverDispatcher. performReceive。</p>
</li>
<li><p>Args对象是一个BroadcastReceiver.PendingResult也是一个Runnable对象。每当ReceiverDispatcher执行了performReceive方法。Args会执行mActivityThread的post方法执行Args中的Runnable方法。在这个方法中执行BroadcastReceiver的实例化以及调用onReceive方法。</p>
</li>
</ul>
<h3 id="AMS-registerReceiver"><a href="#AMS-registerReceiver" class="headerlink" title="AMS registerReceiver"></a>AMS registerReceiver</h3><p>至ActivityManager的registerReceiver于怎么通过Binder查找到AMS的registerReceiver方法并执行。可以阅读我写的Binder系列文章和Activity启动系列文章。本文就不多赘述了，我们直接到AMS中看看原理。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java" target="_blank" rel="noopener">ActivityManagerService.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> Intent <span class="token function">registerReceiver</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span> String callerPackage<span class="token punctuation">,</span>
            IIntentReceiver receiver<span class="token punctuation">,</span> IntentFilter filter<span class="token punctuation">,</span> String permission<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span>
            <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">"registerReceiver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ArrayList<span class="token operator">&lt;</span>Intent<span class="token operator">></span> stickyIntents <span class="token operator">=</span> null<span class="token punctuation">;</span>
        ProcessRecord callerApp <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> visibleToInstantApps
                <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Context<span class="token punctuation">.</span>RECEIVER_VISIBLE_TO_INSTANT_APPS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> callingUid<span class="token punctuation">;</span>
        <span class="token keyword">int</span> callingPid<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> instantApp<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                callerApp <span class="token operator">=</span> <span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid <span class="token operator">!=</span> SYSTEM_UID <span class="token operator">&amp;&amp;</span>
                        <span class="token operator">!</span>callerApp<span class="token punctuation">.</span>pkgList<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>callerPackage<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                        <span class="token operator">!</span><span class="token string">"android"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>callerPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
                callingUid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
                callingPid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                callerPackage <span class="token operator">=</span> null<span class="token punctuation">;</span>
                callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                callingPid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            instantApp <span class="token operator">=</span> <span class="token function">isInstantApp</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userId <span class="token operator">=</span> mUserController<span class="token punctuation">.</span><span class="token function">handleIncomingUser</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    ALLOW_FULL_ONLY<span class="token punctuation">,</span> <span class="token string">"registerReceiver"</span><span class="token punctuation">,</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Iterator<span class="token operator">&lt;</span>String<span class="token operator">></span> actions <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">actionsIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>actions <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ArrayList<span class="token operator">&lt;</span>String<span class="token operator">></span> noAction <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                noAction<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                actions <span class="token operator">=</span> noAction<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> userIds <span class="token operator">=</span> <span class="token punctuation">{</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String action <span class="token operator">=</span> actions<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> id <span class="token operator">:</span> userIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ArrayMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ArrayList<span class="token operator">&lt;</span>Intent<span class="token operator">>></span> stickies <span class="token operator">=</span> mStickyBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>stickies <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ArrayList<span class="token operator">&lt;</span>Intent<span class="token operator">></span> intents <span class="token operator">=</span> stickies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>intents <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>stickyIntents <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                stickyIntents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Intent<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            stickyIntents<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>intents<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        ArrayList<span class="token operator">&lt;</span>Intent<span class="token operator">></span> allSticky <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stickyIntents <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ContentResolver resolver <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> N <span class="token operator">=</span> stickyIntents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Intent intent <span class="token operator">=</span> stickyIntents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>instantApp <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>resolver<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> TAG<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>allSticky <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        allSticky <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Intent<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    allSticky<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        Intent sticky <span class="token operator">=</span> allSticky <span class="token operator">!=</span> null <span class="token operator">?</span> allSticky<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> sticky<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>callerApp<span class="token punctuation">.</span>thread <span class="token operator">==</span> null
                    <span class="token operator">||</span> callerApp<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> caller<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ReceiverList rl <span class="token operator">=</span> mRegisteredReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rl <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                rl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReceiverList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                        userId<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> totalReceiversForApp <span class="token operator">=</span> rl<span class="token punctuation">.</span>app<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>totalReceiversForApp <span class="token operator">>=</span> MAX_RECEIVERS_ALLOWED_PER_APP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span>
                    rl<span class="token punctuation">.</span>app<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">linkToDeath</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> sticky<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    rl<span class="token punctuation">.</span>linkedToDeath <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mRegisteredReceivers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">.</span>uid <span class="token operator">!=</span> callingUid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">.</span>pid <span class="token operator">!=</span> callingPid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">.</span>userId <span class="token operator">!=</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            BroadcastFilter bf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> rl<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span>
                    permission<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> instantApp<span class="token punctuation">,</span> visibleToInstantApps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">.</span><span class="token function">containsFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                rl<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bf<span class="token punctuation">)</span><span class="token punctuation">;</span>

                mReceiverResolver<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>bf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span>allSticky <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ArrayList receivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bf<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> stickyCount <span class="token operator">=</span> allSticky<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> stickyCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Intent intent <span class="token operator">=</span> allSticky<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    BroadcastQueue queue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    BroadcastRecord r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                            null<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> OP_NONE<span class="token punctuation">,</span> null<span class="token punctuation">,</span> receivers<span class="token punctuation">,</span>
                            null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    queue<span class="token punctuation">.</span><span class="token function">enqueueParallelBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    queue<span class="token punctuation">.</span><span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> sticky<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个方法中分为三个大部分：</p>
<ul>
<li><p>1.mStickyBroadcasts获取所有粘性广播的过滤IntentFilter并保存在stickyIntents中。如果传递下来的Intent的监听对象也是符合IntentFilter中的过滤条件则添加到allSticky。说明当前BroadcastReceiver符合粘性广播分发的条件。</p>
</li>
<li><p>2.如果broadcastReceiver 是第一次添加，那么会先把IIntentReceiver封装成ReceiverList对象。并且把ReceiverList添加到ProcessRecord中到receivers 中,这是一个ReceiverList的ArrayList对象。最后把IIntentReceiver的服务端作为key，ReceiverList为value保存在mRegisteredReceivers中。</p>
</li>
<li><p>3.此时会根据ReceiverList以及IntentFilter生成一个BroadcastFilter对象。这样BroadcastFilter就持有了一个广播接受者的客户端对象以及过滤接收条件。并把BroadcastFilter保存到mReceiverResolver中。之后需要查询就能从mReceiverResolver对象中直接查到需要分发的对象以及过滤条件。/</p>
</li>
<li><p>4.如果allSticky不为空，则通过broadcastQueueForIntent获取BroadcastQueue对象，通过BroadcastQueue进行消息的分发。这里的逻辑我们先放一放。</p>
</li>
</ul>
<p>不过能从这里看到一个和EventBus设计几乎一致的地方。粘性事件的设计。粘性事件可以向没有注册BroadcastReceiver静态注册发送事件，一旦注册了，和普通的BroadcastReceiver不同的是不会出现事件丢失，而是进行分发。</p>
<p>到这里IIntentReceiver就保存到了AMS的mRegisteredReceivers这个map中缓存起来。</p>
<h3 id="BroadcastReceiver静态注册"><a href="#BroadcastReceiver静态注册" class="headerlink" title="BroadcastReceiver静态注册"></a>BroadcastReceiver静态注册</h3><p>BroadcastReceiver的静态注册，就是在AndroidManifest中静态注册好。在早期的Android版本中，Android可以通过这种静态注册监听一些开机等特殊监听。</p>
<p>那么我们可以猜测Android什么实例化好BroadcastReceiver，应该是安装的时候就保存好了。</p>
<h4 id="BroadcastReceiver安装解析"><a href="#BroadcastReceiver安装解析" class="headerlink" title="BroadcastReceiver安装解析"></a>BroadcastReceiver安装解析</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/pm/" target="_blank" rel="noopener">pm</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/pm/PackageParser.java" target="_blank" rel="noopener">PackageParser.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseBaseApplication</span><span class="token punctuation">(</span>Package owner<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span>
            XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Activity a <span class="token operator">=</span> <span class="token function">parseActivity</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        owner<span class="token punctuation">.</span>baseHardwareAccelerated<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                hasActivityOrder <span class="token operator">|=</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>order <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                owner<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"receiver"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Activity a <span class="token operator">=</span> <span class="token function">parseActivity</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">,</span>
                        <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                hasReceiverOrder <span class="token operator">|=</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>order <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                owner<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PMS(PackageManagerService)安装系统的时候，会通过scanPakageLi方法调用PakcageParser对apk包进行解析。上面的代码段就是解析AndroidManifest.xml中找到receiver的xml的节点后，生成一个Activity对象保存到Package的receivers集合中。</p>
<p>此时在SystemServer进程中就持有了静态注册好的BroadcastReceiver对象了。</p>
<p>详细的，我们放到后面的PMS专题来聊聊。</p>
<h3 id="BroadcastReceiver的发送原理"><a href="#BroadcastReceiver的发送原理" class="headerlink" title="BroadcastReceiver的发送原理"></a>BroadcastReceiver的发送原理</h3><p>BroadcastReceiver的发送一般是通过sendBroadcast发送一个广播后，在BroadcastReceiver的onReceiver中接收到。让我们来考察sendBroadcast方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendBroadcast</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warnIfCallingFromSystemProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String resolvedType <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">broadcastIntent</span><span class="token punctuation">(</span>
                    mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                    Activity<span class="token punctuation">.</span>RESULT_OK<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> AppOpsManager<span class="token punctuation">.</span>OP_NONE<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心的方法就是AMS的broadcastIntent方法。</p>
<h4 id="AMS-broadcastIntent"><a href="#AMS-broadcastIntent" class="headerlink" title="AMS broadcastIntent"></a>AMS broadcastIntent</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">broadcastIntent</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span>
            Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span> IIntentReceiver resultTo<span class="token punctuation">,</span>
            <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String resultData<span class="token punctuation">,</span> Bundle resultExtras<span class="token punctuation">,</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> requiredPermissions<span class="token punctuation">,</span> <span class="token keyword">int</span> appOp<span class="token punctuation">,</span> Bundle bOptions<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> serialized<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">"broadcastIntent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            intent <span class="token operator">=</span> <span class="token function">verifyBroadcastLocked</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> ProcessRecord callerApp <span class="token operator">=</span> <span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> callingPid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">broadcastIntentLocked</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">,</span>
                    callerApp <span class="token operator">!=</span> null <span class="token operator">?</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName <span class="token operator">:</span> null<span class="token punctuation">,</span>
                    intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span>
                    requiredPermissions<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span> serialized<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span>
                    callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心是通过当前的IApplicationThread获取到ProcessRecord进程信息后，调用<br>broadcastIntentLocked方法。</p>
<h4 id="AMS-broadcastIntentLocked"><a href="#AMS-broadcastIntentLocked" class="headerlink" title="AMS broadcastIntentLocked"></a>AMS broadcastIntentLocked</h4><p>我们把这个方法分为四个部分来考察。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">broadcastIntentLocked</span><span class="token punctuation">(</span>ProcessRecord callerApp<span class="token punctuation">,</span>
            String callerPackage<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span>
            IIntentReceiver resultTo<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String resultData<span class="token punctuation">,</span>
            Bundle resultExtras<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> requiredPermissions<span class="token punctuation">,</span> <span class="token keyword">int</span> appOp<span class="token punctuation">,</span> Bundle bOptions<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> callingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> callerInstantApp <span class="token operator">=</span> <span class="token function">isInstantApp</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>callerInstantApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            intent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_EXCLUDE_STOPPED_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mProcessesReady <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_BOOT_UPGRADE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REGISTERED_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        userId <span class="token operator">=</span> mUserController<span class="token punctuation">.</span><span class="token function">handleIncomingUser</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                ALLOW_NON_FULL<span class="token punctuation">,</span> <span class="token string">"broadcast"</span><span class="token punctuation">,</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> String action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sticky<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            ArrayMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ArrayList<span class="token operator">&lt;</span>Intent<span class="token operator">>></span> stickies <span class="token operator">=</span> mStickyBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stickies <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stickies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mStickyBroadcasts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> stickies<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ArrayList<span class="token operator">&lt;</span>Intent<span class="token operator">></span> list <span class="token operator">=</span> stickies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stickies<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> stickiesCount <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> i<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> stickiesCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">filterEquals</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// This sticky already exists, replace it.</span>
                    list<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> stickiesCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> ActivityManager<span class="token punctuation">.</span>BROADCAST_SUCCESS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在第一段代码中，做了如下的事情：</p>
<ul>
<li>判断当前的App是否是Instant App。如果是，则关闭FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS标志位。说明Instant App是不能接收Broadcast广播的。关于什么是Instant App，可以阅读<a href="https://www.jianshu.com/p/b66535262dfb" target="_blank" rel="noopener">https://www.jianshu.com/p/b66535262dfb</a>这篇文章。可以当成一个缩减版本的应用。</li>
</ul>
<ul>
<li><p>默认给Intent添加一个FLAG_EXCLUDE_STOPPED_PACKAGES，不允许发送消息给还没有启动的App。</p>
</li>
<li><p>如果AMS还没有启动完毕，且FLAG_RECEIVER_BOOT_UPGRADE没有打开。说明此时发送的消息是普通广播不是什么开机广播。此时可能PMS也没有准备好，因此添加FLAG_RECEIVER_REGISTERED_ONLY，只发送给那些动态注册的广播接收者。</p>
</li>
</ul>
<ul>
<li>获取保存在mStickyBroadcasts中的需要分发的广播Intent。如果当前发送的是粘性广播。则会先保存到mStickyBroadcasts这个ArrayMap中，保证发送的广播找不到符合的广播接收者也不会丢失。</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            users <span class="token operator">=</span> mUserController<span class="token punctuation">.</span><span class="token function">getStartedUserArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>userId<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        List receivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>BroadcastFilter<span class="token operator">></span> registeredReceivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REGISTERED_ONLY<span class="token punctuation">)</span>
                 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            receivers <span class="token operator">=</span> <span class="token function">collectReceiverComponents</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> users<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> UserHandle<span class="token punctuation">.</span>USER_ALL <span class="token operator">&amp;&amp;</span> callingUid <span class="token operator">==</span> SHELL_UID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> users<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mUserController<span class="token punctuation">.</span><span class="token function">hasUserRestriction</span><span class="token punctuation">(</span>
                            UserManager<span class="token punctuation">.</span>DISALLOW_DEBUGGING_FEATURES<span class="token punctuation">,</span> users<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    List<span class="token operator">&lt;</span>BroadcastFilter<span class="token operator">></span> registeredReceiversForUser <span class="token operator">=</span>
                            mReceiverResolver<span class="token punctuation">.</span><span class="token function">queryIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span>
                                    resolvedType<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*defaultOnly*/</span><span class="token punctuation">,</span> users<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>registeredReceivers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        registeredReceivers <span class="token operator">=</span> registeredReceiversForUser<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>registeredReceiversForUser <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        registeredReceivers<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>registeredReceiversForUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                registeredReceivers <span class="token operator">=</span> mReceiverResolver<span class="token punctuation">.</span><span class="token function">queryIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span>
                        resolvedType<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*defaultOnly*/</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果关闭FLAG_RECEIVER_REGISTERED_ONLY标志位，则调用collectReceiverComponents获取静态广播的集合。这个标志位代表只发送给动态注册的广播。</p>
</li>
<li><p>2.如果Intent没有设置getComponent目标，则从mReceiverResolver中获取当前应用对应userId的所有广播保存到registeredReceivers这个BroadcastFilter集合中。</p>
</li>
</ul>
<p>核心来看看collectReceiverComponents是怎么获取静态广播接收器以及mReceiverResolver是如何获取动态广播接收器的。</p>
<h5 id="collectReceiverComponents-查找静态广播接受者"><a href="#collectReceiverComponents-查找静态广播接受者" class="headerlink" title="collectReceiverComponents 查找静态广播接受者"></a>collectReceiverComponents 查找静态广播接受者</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span> <span class="token function">collectReceiverComponents</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span>
            <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> pmFlags <span class="token operator">=</span> STOCK_PM_FLAGS <span class="token operator">|</span> MATCH_DEBUG_TRIAGED_MISSING<span class="token punctuation">;</span>

        List<span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span> receivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            HashSet<span class="token operator">&lt;</span>ComponentName<span class="token operator">></span> singleUserReceivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> scannedFirstReceivers <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> user <span class="token operator">:</span> users<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>callingUid <span class="token operator">==</span> SHELL_UID
                        <span class="token operator">&amp;&amp;</span> mUserController<span class="token punctuation">.</span><span class="token function">hasUserRestriction</span><span class="token punctuation">(</span>
                                UserManager<span class="token punctuation">.</span>DISALLOW_DEBUGGING_FEATURES<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isPermittedShellBroadcast</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                List<span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span> newReceivers <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">queryIntentReceivers</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> pmFlags<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> UserHandle<span class="token punctuation">.</span>USER_SYSTEM <span class="token operator">&amp;&amp;</span> newReceivers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>newReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ResolveInfo ri <span class="token operator">=</span> newReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ActivityInfo<span class="token punctuation">.</span>FLAG_SYSTEM_USER_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            newReceivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            i<span class="token operator">--</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newReceivers <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> newReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    newReceivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>receivers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    receivers <span class="token operator">=</span> newReceivers<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newReceivers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scannedFirstReceivers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        scannedFirstReceivers <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ResolveInfo ri <span class="token operator">=</span> receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ActivityInfo<span class="token punctuation">.</span>FLAG_SINGLE_USER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                ComponentName cn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                                        ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>singleUserReceivers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    singleUserReceivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>ComponentName<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                singleUserReceivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>newReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ResolveInfo ri <span class="token operator">=</span> newReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ActivityInfo<span class="token punctuation">.</span>FLAG_SINGLE_USER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ComponentName cn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                                    ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> ri<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>singleUserReceivers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                singleUserReceivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>ComponentName<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>singleUserReceivers<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                singleUserReceivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> receivers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.先通过PMS的queryIntentReceivers方法从PMS中获取所有符合当前Intent设置的Action等条件和userId的ResolveInfo对象保存到newReceivers集合中。</p>
</li>
<li><p>2.如果userId不是UserHandle.USER_SYSTEM(不是系统)，则遍历newReceivers集合，移除掉所有打开了FLAG_SYSTEM_USER_ONLY的广播接受者。因为不是系统应用也发送不到系统的广播接受者。</p>
</li>
<li><p>3.注意这里面获取的userId的数组。而这个数组只有两种情况，一种是UserHandle.USER_ALL也就是所有启动的应用(现在Android已经变成了一个user对应一个应用了)，一种就是当前userId对应的应用。</p>
<ul>
<li>如果当前遍历所有用户中的id中所有的广播接受者有设置了FLAG_SINGLE_USER，也就是在AndroidManifest中设置了singleUser标志位，说明全局只有一个广播接受者。在这个过程只会对第一个userId数组中做一次校验(这里是指系统的userID)，就会把ComponentName添加到singleUserReceivers中。</li>
<li>遍历每一个userId中所有的广播接受者，并把ComponentName添加到singleUserReceivers中，以及ResolveInfo保存到receivers中。</li>
</ul>
</li>
</ul>
<p>最后把receivers返回。</p>
<p>这段代码中的核心就是PMS的queryIntentReceivers，是怎么查询的。</p>
<h6 id="PMS-queryIntentReceivers"><a href="#PMS-queryIntentReceivers" class="headerlink" title="PMS queryIntentReceivers"></a>PMS queryIntentReceivers</h6><pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">private</span> <span class="token annotation punctuation">@NonNull</span> List<span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span> <span class="token function">queryIntentReceiversInternal</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span>
            String resolvedType<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowDynamicSplits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sUserManager<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPermissionManager<span class="token punctuation">.</span><span class="token function">enforceCrossUserPermission</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*requireFullPermission*/</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*checkShell*/</span><span class="token punctuation">,</span>
                <span class="token string">"query intent receivers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String instantAppPkgName <span class="token operator">=</span> <span class="token function">getInstantAppPackageName</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        flags <span class="token operator">=</span> <span class="token function">updateFlagsForResolve</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*includeInstantApps*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ComponentName comp <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                intent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                comp <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ActivityInfo ai <span class="token operator">=</span> <span class="token function">getReceiverInfo</span><span class="token punctuation">(</span>comp<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ai <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">final</span> <span class="token keyword">boolean</span> matchInstantApp <span class="token operator">=</span>
                        <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>MATCH_INSTANT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> matchVisibleToInstantAppOnly <span class="token operator">=</span>
                        <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>MATCH_VISIBLE_TO_INSTANT_APP_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> matchExplicitlyVisibleOnly <span class="token operator">=</span>
                        <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>MATCH_EXPLICITLY_VISIBLE_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isCallerInstantApp <span class="token operator">=</span>
                        instantAppPkgName <span class="token operator">!=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTargetSameInstantApp <span class="token operator">=</span>
                        comp<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>instantAppPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTargetInstantApp <span class="token operator">=</span>
                        <span class="token punctuation">(</span>ai<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags
                                <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_INSTANT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTargetVisibleToInstantApp <span class="token operator">=</span>
                        <span class="token punctuation">(</span>ai<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ActivityInfo<span class="token punctuation">.</span>FLAG_VISIBLE_TO_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTargetExplicitlyVisibleToInstantApp <span class="token operator">=</span>
                        isTargetVisibleToInstantApp
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ai<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ActivityInfo<span class="token punctuation">.</span>FLAG_IMPLICITLY_VISIBLE_TO_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTargetHiddenFromInstantApp <span class="token operator">=</span>
                        <span class="token operator">!</span>isTargetVisibleToInstantApp
                        <span class="token operator">||</span> <span class="token punctuation">(</span>matchExplicitlyVisibleOnly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isTargetExplicitlyVisibleToInstantApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> blockResolution <span class="token operator">=</span>
                        <span class="token operator">!</span>isTargetSameInstantApp
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>matchInstantApp <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isCallerInstantApp <span class="token operator">&amp;&amp;</span> isTargetInstantApp<span class="token punctuation">)</span>
                                <span class="token operator">||</span> <span class="token punctuation">(</span>matchVisibleToInstantAppOnly <span class="token operator">&amp;&amp;</span> isCallerInstantApp
                                        <span class="token operator">&amp;&amp;</span> isTargetHiddenFromInstantApp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blockResolution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ResolveInfo ri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResolveInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ri<span class="token punctuation">.</span>activityInfo <span class="token operator">=</span> ai<span class="token punctuation">;</span>
                    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token function">applyPostResolutionFilter</span><span class="token punctuation">(</span>
                    list<span class="token punctuation">,</span> instantAppPkgName<span class="token punctuation">,</span> allowDynamicSplits<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                    intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// reader</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String pkgName <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> List<span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span> result <span class="token operator">=</span>
                        mReceivers<span class="token punctuation">.</span><span class="token function">queryIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">applyPostResolutionFilter</span><span class="token punctuation">(</span>
                        result<span class="token punctuation">,</span> instantAppPkgName<span class="token punctuation">,</span> allowDynamicSplits<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                        intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package pkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> List<span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span> result <span class="token operator">=</span> mReceivers<span class="token punctuation">.</span><span class="token function">queryIntentForPackage</span><span class="token punctuation">(</span>
                        intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> pkg<span class="token punctuation">.</span>receivers<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">applyPostResolutionFilter</span><span class="token punctuation">(</span>
                        result<span class="token punctuation">,</span> instantAppPkgName<span class="token punctuation">,</span> allowDynamicSplits<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                        intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果ComponentName中不为空，有目标的包名字或者目标的类名，则getReceiverInfo获取ActivityInfo对象。声明一个ResolveInfo对象，添加到list中。</p>
</li>
<li><p>2.尝试的从Intent中获取PackageName，如果PackageName为空，则mReceivers从mReceivers的queryIntent方法中获取ResolveInfo集合，并返回</p>
</li>
<li><p>3.如果packageName不为空，则mReceivers的queryIntentForPackage根据当前的包名获取ResolveInfo。</p>
</li>
</ul>
<p>在PMS中，有两种搜寻方法一种是从mReceivers这个ActivityIntentResolver集合中获取，一种是知道了目标对象调用getReceiverInfo方法获取。</p>
<h6 id="getReceiverInfo"><a href="#getReceiverInfo" class="headerlink" title="getReceiverInfo"></a>getReceiverInfo</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> ActivityInfo <span class="token function">getReceiverInfo</span><span class="token punctuation">(</span>ComponentName component<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sUserManager<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        flags <span class="token operator">=</span> <span class="token function">updateFlagsForComponent</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPermissionManager<span class="token punctuation">.</span><span class="token function">enforceCrossUserPermission</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* requireFullPermission */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* checkShell */</span><span class="token punctuation">,</span> <span class="token string">"get receiver info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageParser<span class="token punctuation">.</span>Activity a <span class="token operator">=</span> mReceivers<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mSettings<span class="token punctuation">.</span><span class="token function">isEnabledAndMatchLPr</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>info<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">filterAppAccessLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> component<span class="token punctuation">,</span> TYPE_RECEIVER<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> PackageParser<span class="token punctuation">.</span><span class="token function">generateActivityInfo</span><span class="token punctuation">(</span>
                        a<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> ps<span class="token punctuation">.</span><span class="token function">readUserState</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个过程中是也是从mReceivers中的mActivities对象根据component直接获得对应的PackageParser.Activity，进而获取ActivityInfo对象。</p>
<p>mReceivers中是什么时候添加这些对象的呢？实际上就是静态注册时候执行完扫描AndroidManifest之后返回了Package对象后，添加到mReceivers中。</p>
<h6 id="ActivityIntentResolver-queryIntent-查询符合过滤条件的BroadcastReceiver"><a href="#ActivityIntentResolver-queryIntent-查询符合过滤条件的BroadcastReceiver" class="headerlink" title="ActivityIntentResolver queryIntent 查询符合过滤条件的BroadcastReceiver"></a>ActivityIntentResolver queryIntent 查询符合过滤条件的BroadcastReceiver</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityIntentResolver</span>
            <span class="token keyword">extends</span> <span class="token class-name">IntentResolver</span><span class="token operator">&lt;</span>PackageParser<span class="token punctuation">.</span>ActivityIntentInfo<span class="token punctuation">,</span> ResolveInfo<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> List<span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span> <span class="token function">queryIntent</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> defaultOnly<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sUserManager<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            mFlags <span class="token operator">=</span> <span class="token punctuation">(</span>defaultOnly <span class="token operator">?</span> PackageManager<span class="token punctuation">.</span>MATCH_DEFAULT_ONLY <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">queryIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> defaultOnly<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> List<span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span> <span class="token function">queryIntent</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
                <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sUserManager<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            mFlags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">queryIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>MATCH_DEFAULT_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程核心还是调用了父类IntentResolver的queryIntent方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>R<span class="token operator">></span> <span class="token function">queryIntent</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span> <span class="token keyword">boolean</span> defaultOnly<span class="token punctuation">,</span>
            <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String scheme <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ArrayList<span class="token operator">&lt;</span>R<span class="token operator">></span> finalList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>R<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> debug <span class="token operator">=</span> localLOGV <span class="token operator">||</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_DEBUG_LOG_RESOLUTION<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        F<span class="token punctuation">[</span><span class="token punctuation">]</span> firstTypeCut <span class="token operator">=</span> null<span class="token punctuation">;</span>
        F<span class="token punctuation">[</span><span class="token punctuation">]</span> secondTypeCut <span class="token operator">=</span> null<span class="token punctuation">;</span>
        F<span class="token punctuation">[</span><span class="token punctuation">]</span> thirdTypeCut <span class="token operator">=</span> null<span class="token punctuation">;</span>
        F<span class="token punctuation">[</span><span class="token punctuation">]</span> schemeCut <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedType <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> slashpos <span class="token operator">=</span> resolvedType<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slashpos <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> String baseType <span class="token operator">=</span> resolvedType<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> slashpos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>baseType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedType<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> slashpos<span class="token operator">+</span><span class="token number">2</span>
                            <span class="token operator">||</span> resolvedType<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>slashpos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        firstTypeCut <span class="token operator">=</span> mTypeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        secondTypeCut <span class="token operator">=</span> mWildTypeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>baseType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                        firstTypeCut <span class="token operator">=</span> mBaseTypeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>baseType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        secondTypeCut <span class="token operator">=</span> mWildTypeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>baseType<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>

                    thirdTypeCut <span class="token operator">=</span> mWildTypeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Third type cut: "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>thirdTypeCut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    firstTypeCut <span class="token operator">=</span> mTypedActionToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>scheme <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            schemeCut <span class="token operator">=</span> mSchemeToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedType <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> scheme <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            firstTypeCut <span class="token operator">=</span> mActionToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        FastImmutableArraySet<span class="token operator">&lt;</span>String<span class="token operator">></span> categories <span class="token operator">=</span> <span class="token function">getFastIntentCategories</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTypeCut <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">buildResolveList</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> defaultOnly<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    scheme<span class="token punctuation">,</span> firstTypeCut<span class="token punctuation">,</span> finalList<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>secondTypeCut <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">buildResolveList</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> defaultOnly<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    scheme<span class="token punctuation">,</span> secondTypeCut<span class="token punctuation">,</span> finalList<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thirdTypeCut <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">buildResolveList</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> defaultOnly<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    scheme<span class="token punctuation">,</span> thirdTypeCut<span class="token punctuation">,</span> finalList<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schemeCut <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">buildResolveList</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> defaultOnly<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    scheme<span class="token punctuation">,</span> schemeCut<span class="token punctuation">,</span> finalList<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">filterResults</span><span class="token punctuation">(</span>finalList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sortResults</span><span class="token punctuation">(</span>finalList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> finalList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.第一个resolvedType不为null的逻辑中，实际上判断的是Intent中MIME数据符合的IntentFilter</li>
<li>2.判断scheme也就是协议头符合当前Intent的IntentFilter</li>
<li>3.如果没有MIME和scheme，则尝试查找那些匹配Intent中Action的IntentFilter</li>
<li>4.获取所有的categories，最后根据上面三个判断以及categories通过buildResolveList最终构造成返回结果IntentFilter集合。</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildResolveList</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> FastImmutableArraySet<span class="token operator">&lt;</span>String<span class="token operator">></span> categories<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> debug<span class="token punctuation">,</span> <span class="token keyword">boolean</span> defaultOnly<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span> String scheme<span class="token punctuation">,</span>
            F<span class="token punctuation">[</span><span class="token punctuation">]</span> src<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>R<span class="token operator">></span> dest<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> String action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Uri data <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String packageName <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> excludingStopped <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">isExcludingStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> src <span class="token operator">!=</span> null <span class="token operator">?</span> src<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> hasNonDefaults <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        F filter<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>filter<span class="token operator">=</span>src<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> match<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            match <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> scheme<span class="token punctuation">,</span> data<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> TAG<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>defaultOnly <span class="token operator">||</span> filter<span class="token punctuation">.</span><span class="token function">hasCategory</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>CATEGORY_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> R oneResult <span class="token operator">=</span> <span class="token function">newResult</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> match<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>oneResult <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        dest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>oneResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    hasNonDefaults <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心代码还是遍历上一个代码段筛选出来的IntentFilter，调用IntentFilter的match方法判断是否匹配。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">match</span><span class="token punctuation">(</span>ContentResolver resolver<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> resolve<span class="token punctuation">,</span> String logTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String type <span class="token operator">=</span> resolve <span class="token operator">?</span> intent<span class="token punctuation">.</span><span class="token function">resolveType</span><span class="token punctuation">(</span>resolver<span class="token punctuation">)</span> <span class="token operator">:</span> intent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">match</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> intent<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">.</span><span class="token function">getCategories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">match</span><span class="token punctuation">(</span>String action<span class="token punctuation">,</span> String type<span class="token punctuation">,</span> String scheme<span class="token punctuation">,</span>
            Uri data<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>String<span class="token operator">></span> categories<span class="token punctuation">,</span> String logTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">matchAction</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> NO_MATCH_ACTION<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> dataMatch <span class="token operator">=</span> <span class="token function">matchData</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> scheme<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataMatch <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> dataMatch<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        String categoryMismatch <span class="token operator">=</span> <span class="token function">matchCategories</span><span class="token punctuation">(</span>categories<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>categoryMismatch <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> NO_MATCH_CATEGORY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">return</span> dataMatch<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>依次匹配了action，type，scheme，data，categories。我们从整个代码逻辑链上思考，就能明白Androidmanifest中IntentFilter的匹配规则：</p>
<ul>
<li><p>如果想要IntentFilter，意图过滤生效。满足三个条件之一，一个是必须存在Intent的action，另一个是getContentReslover的字符串不为空，最后一个是scheme不为空。这决定了解析是否能拆分出四个子部分进行匹配</p>
</li>
<li><p>categories并非是必须的，就算没有也可以通过action，data，scheme，type进行匹配。</p>
</li>
<li><p>当存在action，就会从中获取所有符合条件的所有ActivityIntentInfo对象，在此基础上，对依次对data，categories进行匹配。如果data匹配成功了就直接返回，如果data匹配失败了就会尝试匹配categories。</p>
</li>
</ul>
<p>如果存在多个data只需要匹配其中一个data返回即可。</p>
<h3 id="2种发送广播类型"><a href="#2种发送广播类型" class="headerlink" title="2种发送广播类型"></a>2种发送广播类型</h3><h5 id="发送并行广播"><a href="#发送并行广播" class="headerlink" title="发送并行广播"></a>发送并行广播</h5><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">final</span> <span class="token keyword">boolean</span> replacePending <span class="token operator">=</span>
                <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REPLACE_PENDING<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>


        <span class="token keyword">int</span> NR <span class="token operator">=</span> registeredReceivers <span class="token operator">!=</span> null <span class="token operator">?</span> registeredReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ordered <span class="token operator">&amp;&amp;</span> NR <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>isCallerSystem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">checkBroadcastFromSystem</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                        isProtectedBroadcast<span class="token punctuation">,</span> registeredReceivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> BroadcastQueue queue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            BroadcastRecord r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span>
                    callerPackage<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callerInstantApp<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    requiredPermissions<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> brOptions<span class="token punctuation">,</span> registeredReceivers<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span>
                    resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">boolean</span> replaced <span class="token operator">=</span> replacePending
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">replaceParallelBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>replaced<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                queue<span class="token punctuation">.</span><span class="token function">enqueueParallelBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                queue<span class="token punctuation">.</span><span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            registeredReceivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
            NR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.如果当前动态注册的广播接受者不为0，且不是有序广播。</li>
<li>2.通过broadcastQueueForIntent获取BroadcastQueue对象。</li>
<li>3.根据动态注册的广播接受者，生成BroadcastRecord对象。</li>
<li>4.如果FLAG_RECEIVER_REPLACE_PENDING关闭并且BroadcastQueue校验当前的BroadcastRecord不需要替换，则调用enqueueParallelBroadcastLocked进入并行队列，接着调用scheduleBroadcastsLocked执行发送。</li>
</ul>
<p>核心方法有如下几个：</p>
<ul>
<li>broadcastQueueForIntent<ul>
<li>enqueueParallelBroadcastLocked</li>
<li>scheduleBroadcastsLocked</li>
</ul>
</li>
</ul>
<p>让我们来一一考察。</p>
<h5 id="broadcastQueueForIntent"><a href="#broadcastQueueForIntent" class="headerlink" title="broadcastQueueForIntent"></a>broadcastQueueForIntent</h5><pre class="line-numbers language-java"><code class="language-java">    BroadcastQueue <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isFg <span class="token operator">=</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_RECEIVER_FOREGROUND<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>isFg<span class="token punctuation">)</span> <span class="token operator">?</span> mFgBroadcastQueue <span class="token operator">:</span> mBgBroadcastQueue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据Intent是否开启FLAG_RECEIVER_FOREGROUND，则返回前台广播队列，否则返回后台队列。这两个方法的初始化时机在AMS的构造函数中：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> BROADCAST_FG_TIMEOUT <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> BROADCAST_BG_TIMEOUT <span class="token operator">=</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>

        mFgBroadcastQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mHandler<span class="token punctuation">,</span>
                <span class="token string">"foreground"</span><span class="token punctuation">,</span> BROADCAST_FG_TIMEOUT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBgBroadcastQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mHandler<span class="token punctuation">,</span>
                <span class="token string">"background"</span><span class="token punctuation">,</span> BROADCAST_BG_TIMEOUT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBroadcastQueues<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> mFgBroadcastQueue<span class="token punctuation">;</span>
        mBroadcastQueues<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> mBgBroadcastQueue<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>都是BroadcastQueue对象，只是两者之间的超时时间一个是10秒，一个是60秒,最后一个蚕食后台为true。</p>
<h6 id="BroadcastQueue"><a href="#BroadcastQueue" class="headerlink" title="BroadcastQueue"></a>BroadcastQueue</h6><p>文件：<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/BroadcastQueue.java" target="_blank" rel="noopener">BroadcastQueue.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token function">BroadcastQueue</span><span class="token punctuation">(</span>ActivityManagerService service<span class="token punctuation">,</span> Handler handler<span class="token punctuation">,</span>
            String name<span class="token punctuation">,</span> <span class="token keyword">long</span> timeoutPeriod<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowDelayBehindServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mService <span class="token operator">=</span> service<span class="token punctuation">;</span>
        mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mQueueName <span class="token operator">=</span> name<span class="token punctuation">;</span>
        mTimeoutPeriod <span class="token operator">=</span> timeoutPeriod<span class="token punctuation">;</span>
        mDelayBehindServices <span class="token operator">=</span> allowDelayBehindServices<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>BroadcastQueue中共用了AMS的Looper构造了一个Handler对象。<br>mDelayBehindServices而这个标志位代表了是否是后台执行发送广播。</p>
<h6 id="BroadcastQueue-enqueueParallelBroadcastLocked"><a href="#BroadcastQueue-enqueueParallelBroadcastLocked" class="headerlink" title="BroadcastQueue enqueueParallelBroadcastLocked"></a>BroadcastQueue enqueueParallelBroadcastLocked</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueueParallelBroadcastLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enqueueBroadcastHelper</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">enqueueBroadcastHelper</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span>enqueueClockTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>Trace<span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Trace<span class="token punctuation">.</span><span class="token function">asyncTraceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span>
                <span class="token function">createBroadcastTraceTitle</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> BroadcastRecord<span class="token punctuation">.</span>DELIVERY_PENDING<span class="token punctuation">)</span><span class="token punctuation">,</span>
                System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，其实就是把BroadcastRecord添加到mParallelBroadcasts队列中。</p>
<p>scheduleBroadcastsLocked这个方法我们最后再来考察</p>
<h4 id="发送有序广播"><a href="#发送有序广播" class="headerlink" title="发送有序广播"></a>发送有序广播</h4><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">int</span> ir <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>receivers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            String skipPackages<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_PACKAGE_ADDED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_RESTARTED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> Intent<span class="token punctuation">.</span>ACTION_PACKAGE_DATA_CLEARED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Uri data <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    String pkgName <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        skipPackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> pkgName <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_EXTERNAL_APPLICATIONS_AVAILABLE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                skipPackages <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getStringArrayExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_CHANGED_PACKAGE_LIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>skipPackages <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>skipPackages<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>String skipPackage <span class="token operator">:</span> skipPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>skipPackage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> NT <span class="token operator">=</span> receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> it<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> it<span class="token operator">&lt;</span>NT<span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ResolveInfo curt <span class="token operator">=</span> <span class="token punctuation">(</span>ResolveInfo<span class="token punctuation">)</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>curt<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>skipPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                receivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                it<span class="token operator">--</span><span class="token punctuation">;</span>
                                NT<span class="token operator">--</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span> NT <span class="token operator">=</span> receivers <span class="token operator">!=</span> null <span class="token operator">?</span> receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> it <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            ResolveInfo curt <span class="token operator">=</span> null<span class="token punctuation">;</span>
            BroadcastFilter curr <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">&lt;</span> NT <span class="token operator">&amp;&amp;</span> ir <span class="token operator">&lt;</span> NR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curt <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    curt <span class="token operator">=</span> <span class="token punctuation">(</span>ResolveInfo<span class="token punctuation">)</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curr <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    curr <span class="token operator">=</span> registeredReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curr<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> curt<span class="token punctuation">.</span>priority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ir<span class="token operator">++</span><span class="token punctuation">;</span>
                    curr <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    it<span class="token operator">++</span><span class="token punctuation">;</span>
                    NT<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Skip to the next ResolveInfo in the final list.</span>
                    it<span class="token operator">++</span><span class="token punctuation">;</span>
                    curt <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ir <span class="token operator">&lt;</span> NR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>receivers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                receivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registeredReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ir<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isCallerSystem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkBroadcastFromSystem</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                    isProtectedBroadcast<span class="token punctuation">,</span> receivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>receivers <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> resultTo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BroadcastQueue queue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            BroadcastRecord r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span>
                    callerPackage<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callerInstantApp<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    requiredPermissions<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> brOptions<span class="token punctuation">,</span> receivers<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span>
                    resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token keyword">final</span> BroadcastRecord oldRecord <span class="token operator">=</span>
                    replacePending <span class="token operator">?</span> queue<span class="token punctuation">.</span><span class="token function">replaceOrderedBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRecord <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRecord<span class="token punctuation">.</span>resultTo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> BroadcastQueue oldQueue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>oldRecord<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        oldQueue<span class="token punctuation">.</span><span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>oldRecord<span class="token punctuation">.</span>callerApp<span class="token punctuation">,</span> oldRecord<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span>
                                oldRecord<span class="token punctuation">.</span>intent<span class="token punctuation">,</span>
                                Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                                <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> oldRecord<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                queue<span class="token punctuation">.</span><span class="token function">enqueueOrderedBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                queue<span class="token punctuation">.</span><span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REGISTERED_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// This was an implicit broadcast... let's record it for posterity.</span>
                <span class="token function">addBroadcastStatLocked</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程实际上是把静态注册的广播接受者和动态广播接受者合并到一个队列。<br>在这段代码开始之前：</p>
<ul>
<li><p>receivers保存的是静态注册的广播接受者</p>
</li>
<li><p>registeredReceivers保存的是动态注册的广播接受者</p>
</li>
<li><p>1.receivers不为空，第一部分实际上就是处理Intent.ACTION_PACKAGE_ADDED的情况。这个Intent标志位代表了有新的app包安装好了。此时会剔除这些Intent对应的应用的包名中的receivers静态注册广播接受者集合。避免的是一安装了就被广播流氓的拉起应用。</p>
<ul>
<li>第二部分就是把动态注册广播和静态注册的广播接受者比较优先级，根据Priority从小到大排序，同一个级别的动态接受者必定在静态接受者的receivers下标的后方。</li>
<li>把剩余的动态注册的广播接受者放在最后。</li>
</ul>
</li>
</ul>
<p>这得益于receivers本身没有确定好泛型，可以存入任意的Object</p>
<ul>
<li>2.broadcastQueueForIntent 获取对应的BroadcastQueue；</li>
<li>3.根据receivers生成BroadcastRecord对象</li>
<li>4.enqueueOrderedBroadcastLocked 把BroadcastRecord存入BroadcastRecord中的队列。</li>
<li>5.scheduleBroadcastsLocked 执行发送行为。</li>
</ul>
<p>来看看和并行发送广播中存入队列方法不同的enqueueOrderedBroadcastLocked。</p>
<h5 id="BroadcastQueue-enqueueOrderedBroadcastLocked"><a href="#BroadcastQueue-enqueueOrderedBroadcastLocked" class="headerlink" title="BroadcastQueue enqueueOrderedBroadcastLocked"></a>BroadcastQueue enqueueOrderedBroadcastLocked</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueueOrderedBroadcastLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enqueueBroadcastHelper</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，就是保存到mOrderedBroadcasts这个ArrayList中。</p>
<p>最后我们考察scheduleBroadcastsLocked方法。</p>
<h4 id="scheduleBroadcastsLocked-发送广播"><a href="#scheduleBroadcastsLocked-发送广播" class="headerlink" title="scheduleBroadcastsLocked 发送广播"></a>scheduleBroadcastsLocked 发送广播</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBroadcastsScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>BROADCAST_INTENT_MSG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单通过Hander发送了一个BROADCAST_INTENT_MSG消息</p>
<h5 id="BroadcastHandler"><a href="#BroadcastHandler" class="headerlink" title="BroadcastHandler"></a>BroadcastHandler</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">BroadcastHandler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> BROADCAST_INTENT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>

                    <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> BROADCAST_TIMEOUT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到BroadcastHandler中处理了两个消息：</p>
<ul>
<li>1.processNextBroadcast 发送广播行为</li>
<li>2.broadcastTimeoutLocked 发送广播超时</li>
</ul>
<p>注意broadcastTimeoutLocked这个方法是最后是否爆出ANR是由BroadcastQueue构造函数决定的分别是10秒，60秒。</p>
<p>我们重点关注processNextBroadcast中的核心方法。</p>
<h5 id="processNextBroadcast"><a href="#processNextBroadcast" class="headerlink" title="processNextBroadcast"></a>processNextBroadcast</h5><p>我这里把这个方法分为三个部分尽心考察</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcastLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> skipOomAdj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        BroadcastRecord r<span class="token punctuation">;</span>


        mService<span class="token punctuation">.</span><span class="token function">updateCpuStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r <span class="token operator">=</span> mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>dispatchTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>dispatchClockTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Object target <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token punctuation">(</span>BroadcastFilter<span class="token punctuation">)</span>target<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">addBroadcastToHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Now take care of the next serialized one...</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingBroadcast <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">boolean</span> isDead<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mPidsSelfLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ProcessRecord proc <span class="token operator">=</span> mService<span class="token punctuation">.</span>mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                            mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    isDead <span class="token operator">=</span> proc <span class="token operator">==</span> null <span class="token operator">||</span> proc<span class="token punctuation">.</span>crashing<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ProcessRecord proc <span class="token operator">=</span> mService<span class="token punctuation">.</span>mProcessNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                        mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                isDead <span class="token operator">=</span> proc <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>proc<span class="token punctuation">.</span>pendingStart<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDead<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mPendingBroadcast<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                mPendingBroadcast<span class="token punctuation">.</span>nextReceiver <span class="token operator">=</span> mPendingBroadcastRecvIndex<span class="token punctuation">;</span>
                mPendingBroadcast <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.遍历保存在mParallelBroadcasts 这个ArrayList中的并行发送广播队列。获取mParallelBroadcasts中的receivers动态注册的广播对象。</li>
<li>2.调用deliverToRegisteredReceiverLocked方法，把receiver对象强转为BroadcastFIlter进行跨进程的发送。</li>
<li>3.mPendingBroadcast 是上一次执行完processNextBroadcastLocked方法，本次即将发送的对象。此时校验在本次准备发送mPendingBroadcast对应的广播接受者之前，判断广播接受者所在的进程是否还存活。</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">boolean</span> looped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mService<span class="token punctuation">.</span><span class="token function">scheduleAppGcsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>looped<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            r <span class="token operator">=</span> mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> forceReceive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> numReceivers <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mProcessesReady <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numReceivers <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span>now <span class="token operator">></span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>mTimeoutPeriod<span class="token operator">*</span>numReceivers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                    forceReceive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">==</span> null <span class="token operator">||</span> r<span class="token punctuation">.</span>nextReceiver <span class="token operator">>=</span> numReceivers
                    <span class="token operator">||</span> r<span class="token punctuation">.</span>resultAbort <span class="token operator">||</span> forceReceive<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>resultTo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>

                        <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>callerApp<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span>
                            r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        r<span class="token punctuation">.</span>resultTo <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        r<span class="token punctuation">.</span>resultTo <span class="token operator">=</span> null<span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>


                <span class="token function">cancelBroadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


                <span class="token function">addBroadcastToHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_REGISTERED_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    mService<span class="token punctuation">.</span><span class="token function">addBroadcastStatLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>callerPackage<span class="token punctuation">,</span>
                            r<span class="token punctuation">.</span>manifestCount<span class="token punctuation">,</span> r<span class="token punctuation">.</span>manifestSkipCount<span class="token punctuation">,</span> r<span class="token punctuation">.</span>finishTime<span class="token operator">-</span>r<span class="token punctuation">.</span>dispatchTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                r <span class="token operator">=</span> null<span class="token punctuation">;</span>
                looped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>遍历了之前添加到mOrderedBroadcasts的序列发送广播队列中，在这个过程做了三件事情：</p>
<ul>
<li>1.mOrderedBroadcasts取出第一个BroadcastRecord对象。BroadcastRecord中持有了所有需要分发的广播接受者集合receiver。判断到当前分发时间点进行超时判断：<blockquote>
<p>当前时间 &gt;  分发的时间点 + 2 * 当前BroadcastQueue的超时时间 * 广播接受者数量</p>
</blockquote>
</li>
</ul>
<p>这个阈值代表了当前必定有广播接受者执行超时了。</p>
<ul>
<li><p>2.如果此时广播遍历所有的BroadcastRecord，发现BroadcastRecord的没有待分发的广播接受者，且resultTo不为空，则调用performReceiveLocked方法进行广播的分发。</p>
<ul>
<li>2.1.cancelBroadcastTimeoutLocked 取消BroadcastReceiver中Handler预设的ANR炸弹。也就是移除BROADCAST_TIMEOUT_MSG消息。addBroadcastToHistoryLocked把BroadcastRecord添加在历史队列中。mOrderedBroadcasts移除当前的BroadcastRecord。跳出遍历的循环。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">
        <span class="token keyword">int</span> recIdx <span class="token operator">=</span> r<span class="token punctuation">.</span>nextReceiver<span class="token operator">++</span><span class="token punctuation">;</span>


        r<span class="token punctuation">.</span>receiverTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>recIdx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>dispatchTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>dispatchClockTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> mPendingBroadcastTimeoutMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime <span class="token operator">+</span> mTimeoutPeriod<span class="token punctuation">;</span>

            <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> BroadcastOptions brOptions <span class="token operator">=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">;</span>
        <span class="token keyword">final</span> Object nextReceiver <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextReceiver <span class="token keyword">instanceof</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            BroadcastFilter filter <span class="token operator">=</span> <span class="token punctuation">(</span>BroadcastFilter<span class="token punctuation">)</span>nextReceiver<span class="token punctuation">;</span>

            <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receiver <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>brOptions <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> brOptions<span class="token punctuation">.</span><span class="token function">getTemporaryAppWhitelistDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">scheduleTempWhitelistLocked</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>owningUid<span class="token punctuation">,</span>
                            brOptions<span class="token punctuation">.</span><span class="token function">getTemporaryAppWhitelistDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ResolveInfo info <span class="token operator">=</span>
            <span class="token punctuation">(</span>ResolveInfo<span class="token punctuation">)</span>nextReceiver<span class="token punctuation">;</span>
        ComponentName component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>crashing<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>callingUid <span class="token operator">!=</span> Process<span class="token punctuation">.</span>SYSTEM_UID <span class="token operator">&amp;&amp;</span> isSingleton
                <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span><span class="token function">isValidSingletonCall</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>callingUid<span class="token punctuation">,</span> receiverUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            info<span class="token punctuation">.</span>activityInfo <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getActivityInfoForUser</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String targetProcess <span class="token operator">=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>
        ProcessRecord app <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>
                info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>skip<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            r<span class="token punctuation">.</span>delivery<span class="token punctuation">[</span>recIdx<span class="token punctuation">]</span> <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>DELIVERY_SKIPPED<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> null<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>curFilter <span class="token operator">=</span> null<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>manifestSkipCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>manifestCount<span class="token operator">++</span><span class="token punctuation">;</span>

        r<span class="token punctuation">.</span>delivery<span class="token punctuation">[</span>recIdx<span class="token punctuation">]</span> <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>DELIVERY_DELIVERED<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>APP_RECEIVE<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>curComponent <span class="token operator">=</span> component<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>curReceiver <span class="token operator">=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>brOptions <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> brOptions<span class="token punctuation">.</span><span class="token function">getTemporaryAppWhitelistDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">scheduleTempWhitelistLocked</span><span class="token punctuation">(</span>receiverUid<span class="token punctuation">,</span>
                    brOptions<span class="token punctuation">.</span><span class="token function">getTemporaryAppWhitelistDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPackageStoppedState</span><span class="token punctuation">(</span>
                    r<span class="token punctuation">.</span>curComponent<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>callingUid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>app<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                        info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>versionCode<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">,</span> skipOomAdj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token function">logBroadcastReceiverDiscardLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token operator">=</span>mService<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>
                info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> Intent<span class="token punctuation">.</span>FLAG_FROM_BACKGROUND<span class="token punctuation">,</span>
                <span class="token string">"broadcast"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curComponent<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_BOOT_UPGRADE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token function">logBroadcastReceiverDiscardLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mPendingBroadcast <span class="token operator">=</span> r<span class="token punctuation">;</span>
        mPendingBroadcastRecvIndex <span class="token operator">=</span> recIdx<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时已经从mOrderedBroadcasts取出第一个BroadcastRecord对象到r中。<br>在这个过程中BroadcastRecord的recIdx记录的是当前已经遍历到了BroadcastRecord中receiver哪一个广播接受者。每一次都是先获取index，再+1.</p>
<ul>
<li><p>1.如果当前的是BroadcastFilter，也就是动态注册的广播接受者。就会调用deliverToRegisteredReceiverLocked分发广播。并且调用scheduleBroadcastsLocked方法，进入方法递归，继续执行Handler中的发送广播的handler消息。不断的通过handler循环执行当前processNextBroadcastLocked方法，知道把BroadcastFilter中所有的receiver执行完</p>
</li>
<li><p>2.不是BroadcastFilter对象，说明是静态注册的广播对象。此时会先从ResolveInfo获取包名和分发的类名。</p>
<ul>
<li>2.1.校验权限没有问题，且是安装的包或者是系统应用。继续通过AMS的getProcessRecordLocked获取当前进程对象ProcessRecord。</li>
<li>2.2.如果当前的静态广播因为权限等问题需要跳过分发，则直接执行scheduleBroadcastsLocked方法。</li>
<li>2.3.如果当前的广播需要分发的进程还存活，则调用processCurBroadcastLocked方法进行分发。</li>
<li>2.4.此时说明接受的广播进程并没有启动，就需要AMS的startProcessLocked启动完进程后，再调用scheduleBroadcastsLocked进入下一个looper进行分发。</li>
</ul>
</li>
</ul>
<p>真正跨进程分发广播的行为方法有两个：</p>
<ul>
<li>1.deliverToRegisteredReceiverLocked 跨进程分发动态注册的广播</li>
<li>2.processCurBroadcastLocked 跨进程分发静态注册的广播</li>
<li>3.performReceiveLocked 根据进程直接分发广播</li>
</ul>
<h4 id="deliverToRegisteredReceiverLocked-跨进程分发动态注册的广播"><a href="#deliverToRegisteredReceiverLocked-跨进程分发动态注册的广播" class="headerlink" title="deliverToRegisteredReceiverLocked 跨进程分发动态注册的广播"></a>deliverToRegisteredReceiverLocked 跨进程分发动态注册的广播</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">,</span>
            BroadcastFilter filter<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> skip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        r<span class="token punctuation">.</span>delivery<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>DELIVERY_DELIVERED<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>curFilter <span class="token operator">=</span> filter<span class="token punctuation">;</span>
            filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>curBroadcast <span class="token operator">=</span> r<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>CALL_IN_RECEIVE<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">;</span>
                filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">.</span>curReceivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">.</span>inFullBackup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">,</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>receiver<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> r<span class="token punctuation">.</span>initialSticky<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>CALL_DONE_RECEIVE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.先更新进程中OomAdj的进程优先级</li>
<li>2.从filter中找到对应的进程，调用performReceiveLocked进行分发。</li>
</ul>
<h4 id="processCurBroadcastLocked-跨进程分发静态注册的广播"><a href="#processCurBroadcastLocked-跨进程分发静态注册的广播" class="headerlink" title="processCurBroadcastLocked 跨进程分发静态注册的广播"></a>processCurBroadcastLocked 跨进程分发静态注册的广播</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">,</span>
            ProcessRecord app<span class="token punctuation">,</span> <span class="token keyword">boolean</span> skipOomAdj<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>inFullBackup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">skipReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> app<span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>curReceivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">forceProcessStateUpTo</span><span class="token punctuation">(</span>ActivityManager<span class="token punctuation">.</span>PROCESS_STATE_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skipOomAdj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span><span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      PackageManager<span class="token punctuation">.</span>NOTIFY_PACKAGE_USE_BROADCAST_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleReceiver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">,</span>
                    mService<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>

            started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>started<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> null<span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> null<span class="token punctuation">;</span>
                app<span class="token punctuation">.</span>curReceivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，此时就是直接从BroadcastRecord中保存了的Intent消息发送到App进程的ActivityThread中的ApplicationThread的scheduleReceiver方法。</p>
<h4 id="performReceiveLocked-根据进程直接分发广播"><a href="#performReceiveLocked-根据进程直接分发广播" class="headerlink" title="performReceiveLocked 根据进程直接分发广播"></a>performReceiveLocked 根据进程直接分发广播</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">,</span> IIntentReceiver receiver<span class="token punctuation">,</span>
            Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String data<span class="token punctuation">,</span> Bundle extras<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleRegisteredReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span>
                            data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">,</span> app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        app<span class="token punctuation">.</span><span class="token function">scheduleCrash</span><span class="token punctuation">(</span><span class="token string">"can't deliver broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token string">"app.thread must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            receiver<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
                    sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法调用了App进程的ActivityThread的scheduleRegisteredReceiver方法。如果App进程已经不存在了则调用receiver的performReceive方法，也就是在SystemServer进程处理广播消息。</p>
<p>能发现在App进程有两个入口分别处理广播消息。</p>
<h4 id="ActivityThread-scheduleRegisteredReceiver-处理动态注册广播"><a href="#ActivityThread-scheduleRegisteredReceiver-处理动态注册广播" class="headerlink" title="ActivityThread scheduleRegisteredReceiver 处理动态注册广播"></a>ActivityThread scheduleRegisteredReceiver 处理动态注册广播</h4><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleRegisteredReceiver</span><span class="token punctuation">(</span>IIntentReceiver receiver<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span>
                <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String dataStr<span class="token punctuation">,</span> Bundle extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">,</span> <span class="token keyword">int</span> processState<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
            <span class="token function">updateProcessState</span><span class="token punctuation">(</span>processState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            receiver<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> dataStr<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
                    sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法实际上就是专门处理动态注册的广播接受者。把BroadcastFilter中的IIntentReceiver对象带过来。并直接执行IIntentReceiver的performReceive方法。</p>
<p>关于这个方法的原理在动态注册介绍的时候已经说过了，最后会走到下面这个方法：</p>
<pre class="line-numbers language-java"><code class="language-java">            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> BroadcastReceiver receiver <span class="token operator">=</span> mReceiver<span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> ordered <span class="token operator">=</span> mOrdered<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">final</span> IActivityManager mgr <span class="token operator">=</span> ActivityManagerNative<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> Intent intent <span class="token operator">=</span> mCurIntent<span class="token punctuation">;</span>

                mCurIntent <span class="token operator">=</span> null<span class="token punctuation">;</span>
                mDispatched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">==</span> null <span class="token operator">||</span> intent <span class="token operator">==</span> null <span class="token operator">||</span> mForgotten<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    ClassLoader cl <span class="token operator">=</span>  mReceiver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    receiver<span class="token punctuation">.</span><span class="token function">setPendingResult</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    receiver<span class="token punctuation">.</span><span class="token function">onReceive</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">getPendingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意此时的Context是当前申请的Activity的ContextImpl。此时会获取ClassLoader设置在Intent中，并调用动态注册的BroadcastReceiver的onReceive方法，把Intent和context一起传入。</p>
<h4 id="ActivityThread-scheduleReceiver-处理静态注册广播"><a href="#ActivityThread-scheduleReceiver-处理静态注册广播" class="headerlink" title="ActivityThread scheduleReceiver 处理静态注册广播"></a>ActivityThread scheduleReceiver 处理静态注册广播</h4><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">scheduleReceiver</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> ActivityInfo info<span class="token punctuation">,</span>
                CompatibilityInfo compatInfo<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String data<span class="token punctuation">,</span> Bundle extras<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> sync<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">,</span> <span class="token keyword">int</span> processState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">updateProcessState</span><span class="token punctuation">(</span>processState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ReceiverData r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReceiverData</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span>
                    sync<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mAppThread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>info <span class="token operator">=</span> info<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>compatInfo <span class="token operator">=</span> compatInfo<span class="token punctuation">;</span>
            <span class="token function">sendMessage</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>RECEIVER<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时很简单，把从AMS来的数据封装成ReceiverData，在ActivityThreade的主Looper中分发RECEIVER消息。</p>
<pre class="line-numbers language-java"><code class="language-java">                <span class="token keyword">case</span> RECEIVER<span class="token operator">:</span>
                    <span class="token function">handleReceiver</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ReceiverData<span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>核心方法调用了handleReceiver方法。</p>
<h5 id="handleReceiver"><a href="#handleReceiver" class="headerlink" title="handleReceiver"></a>handleReceiver</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleReceiver</span><span class="token punctuation">(</span>ReceiverData data<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">unscheduleGcIdler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String component <span class="token operator">=</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        LoadedApk packageInfo <span class="token operator">=</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span>
                data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Application app<span class="token punctuation">;</span>
        BroadcastReceiver receiver<span class="token punctuation">;</span>
        ContextImpl context<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            app <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context <span class="token operator">=</span> <span class="token punctuation">(</span>ContextImpl<span class="token punctuation">)</span> app<span class="token punctuation">.</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                context <span class="token operator">=</span> <span class="token punctuation">(</span>ContextImpl<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">createContextForSplit</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader cl <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            receiver <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getAppFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">instantiateReceiver</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">,</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            sCurrentBroadcastIntent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            receiver<span class="token punctuation">.</span><span class="token function">setPendingResult</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            receiver<span class="token punctuation">.</span><span class="token function">onReceive</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getReceiverRestrictedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data<span class="token punctuation">.</span><span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">"Unable to start receiver "</span> <span class="token operator">+</span> component
                    <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            sCurrentBroadcastIntent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">getPendingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里有很多关于LoadedApk的操作。具体的解析可以阅读<a href="https://www.jianshu.com/p/2b1d43ffeba6" target="_blank" rel="noopener">ActivityThread的初始化</a>.</p>
<p>执行了如下方法：</p>
<ul>
<li>1.从LoadedApk获取缓存的Application对象</li>
<li>2.获取Application的Context</li>
<li>3.通过LoadedApk的AppComponentFactory创建一个BroadcastReceiver。</li>
<li>4.调用BroadcastReceiver的onReceive方法</li>
<li>5.调用ReceiverData返回消息。</li>
</ul>
<p>重点来看看AppComponentFactory是如何创建BroadcastReceiver。</p>
<h6 id="AppComponentFactory-instantiateReceiver"><a href="#AppComponentFactory-instantiateReceiver" class="headerlink" title="AppComponentFactory instantiateReceiver"></a>AppComponentFactory instantiateReceiver</h6><p>其实Androidx也有重写这个AppComponentFactory对象</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token annotation punctuation">@NonNull</span> BroadcastReceiver <span class="token function">instantiateReceiver</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> ClassLoader cl<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> String className<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Intent intent<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> InstantiationException<span class="token punctuation">,</span> IllegalAccessException<span class="token punctuation">,</span> ClassNotFoundException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>BroadcastReceiver<span class="token punctuation">)</span> cl<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单就是反射实例化。</p>
<h4 id="ReceiverData-返回发送成功"><a href="#ReceiverData-返回发送成功" class="headerlink" title="ReceiverData 返回发送成功"></a>ReceiverData 返回发送成功</h4><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mType <span class="token operator">==</span> TYPE_COMPONENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>QueuedWork<span class="token punctuation">.</span><span class="token function">hasPendingWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    QueuedWork<span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrderedHint <span class="token operator">&amp;&amp;</span> mType <span class="token operator">!=</span> TYPE_UNREGISTERED<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">final</span> IActivityManager mgr <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendFinished</span><span class="token punctuation">(</span>IActivityManager am<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mFinished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Broadcast already finished"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mFinished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mResultExtras <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mResultExtras<span class="token punctuation">.</span><span class="token function">setAllowFds</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrderedHint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        am<span class="token punctuation">.</span><span class="token function">finishReceiver</span><span class="token punctuation">(</span>mToken<span class="token punctuation">,</span> mResultCode<span class="token punctuation">,</span> mResultData<span class="token punctuation">,</span> mResultExtras<span class="token punctuation">,</span>
                                mAbortBroadcast<span class="token punctuation">,</span> mFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        am<span class="token punctuation">.</span><span class="token function">finishReceiver</span><span class="token punctuation">(</span>mToken<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程就是调用了AMS的finishReceiver方法。</p>
<h6 id="AMS-finishReceiver"><a href="#AMS-finishReceiver" class="headerlink" title="AMS finishReceiver"></a>AMS finishReceiver</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">finishReceiver</span><span class="token punctuation">(</span>IBinder who<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> String resultData<span class="token punctuation">,</span>
            Bundle resultExtras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resultAbort<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BROADCAST<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_BROADCAST<span class="token punctuation">,</span> <span class="token string">"Finish receiver: "</span> <span class="token operator">+</span> who<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Refuse possible leaked file descriptors</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultExtras <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> resultExtras<span class="token punctuation">.</span><span class="token function">hasFileDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"File descriptors passed in Bundle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> doNext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            BroadcastRecord r<span class="token punctuation">;</span>

            <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                BroadcastQueue queue <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_RECEIVER_FOREGROUND<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                        <span class="token operator">?</span> mFgBroadcastQueue <span class="token operator">:</span> mBgBroadcastQueue<span class="token punctuation">;</span>
                r <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">getMatchingOrderedReceiver</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    doNext <span class="token operator">=</span> r<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span>
                        resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span> resultAbort<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>doNext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">processNextBroadcastLocked</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/*fromMsg=*/</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/*skipOomAdj=*/</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">trimApplicationsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>调用BroadcastQueue的finishReceiverLocked方法，告诉BroadcastQueue对应的广播已经处理完了。</li>
<li>通过finishReceiverLocked判断是否还有需要处理的BroadcastRecord，如果有则processNextBroadcastLocked继续处理所有的并行消息和有序消息。</li>
</ul>
<h6 id="BroadcastQueue-finishReceiverLocked"><a href="#BroadcastQueue-finishReceiverLocked" class="headerlink" title="BroadcastQueue finishReceiverLocked"></a>BroadcastQueue finishReceiverLocked</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span>
            String resultData<span class="token punctuation">,</span> Bundle resultExtras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resultAbort<span class="token punctuation">,</span> <span class="token keyword">boolean</span> waitForServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> state <span class="token operator">=</span> r<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
        <span class="token keyword">final</span> ActivityInfo receiver <span class="token operator">=</span> r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>

        r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> null<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>curReceivers<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>curReceivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>curFilter <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>curFilter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>curBroadcast <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>curFilter <span class="token operator">=</span> null<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>curReceiver <span class="token operator">=</span> null<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> null<span class="token punctuation">;</span>
        mPendingBroadcast <span class="token operator">=</span> null<span class="token punctuation">;</span>

        r<span class="token punctuation">.</span>resultCode <span class="token operator">=</span> resultCode<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>resultData <span class="token operator">=</span> resultData<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>resultExtras <span class="token operator">=</span> resultExtras<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultAbort <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_NO_ABORT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>resultAbort <span class="token operator">=</span> resultAbort<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>resultAbort <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>waitForServices <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>curComponent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>mDelayBehindServices
                <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ActivityInfo nextReceiver<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextReceiver <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Object obj <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                nextReceiver <span class="token operator">=</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>ActivityInfo<span class="token punctuation">)</span>obj <span class="token operator">:</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                nextReceiver <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">==</span> null <span class="token operator">||</span> nextReceiver <span class="token operator">==</span> null
                    <span class="token operator">||</span> receiver<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">!=</span> nextReceiver<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid
                    <span class="token operator">||</span> <span class="token operator">!</span>receiver<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>nextReceiver<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mServices<span class="token punctuation">.</span><span class="token function">hasBackgroundServicesLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>WAITING_SERVICES<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span>curComponent <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">return</span> state <span class="token operator">==</span> BroadcastRecord<span class="token punctuation">.</span>APP_RECEIVE
                <span class="token operator">||</span> state <span class="token operator">==</span> BroadcastRecord<span class="token punctuation">.</span>CALL_DONE_RECEIVE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.清除ProcessRecord中的curReceivers保存的BroadcastRecord</li>
<li>2.清除BroadcastRecord中的ReceiverList，mPendingBroadcast</li>
<li>3.注意在分发有序广播分发已经给了BroadcastRecord的state设置为BroadcastRecord.APP_RECEIVE;换句话说，只要接下来的BroadcastQueue的有序广播消息不为空，那么这个方法一般返回为true。让BroadcastQueue继续分发广播消息。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>先来看看BroadcastReceiver的注册流程。</p>
<p>BroadcastReceiver分为静态注册和动态注册：</p>
<ul>
<li><p>BroadcastReceiver的静态注册，本质上就是在安装过程中AndroidManifest解析后把解析到的receiver数据保存ActivityInfo到PMS中。当需要查询的时候就会封装成ResolveInfo保存到</p>
</li>
<li><p>BroadcastReceiver的动态注册，本质上就是把BroadcastReceiver转化为ReceiverDispatcher。如果获取ReceiverDispatcher发现在LoadedApk对象中的mReceivers缓存中已经保存了，则直接返回。</p>
<ul>
<li>ReceiverDispatcher中IIntentReceiver一个Binder对象，并把这个对象跨进程传输到AMS中。在AMS中先把这个对象封装成ReceiverList；</li>
<li>接着和IntentFilter进一步保存BroadcastFilter。</li>
<li>这样动态注册的BroadcastReceiver的对象就持有了当前广播接受者的类以及过滤条件。最后把BroadcastFilter保存到mReceiverResolver中。mReceiverResolver是一个ActivityIntentResolver。</li>
<li>在这个过程会检测粘性广播，每一次注册之后会检测所有符合条件的粘性广播接受者并分发。注意粘性广播都是分发给动态注册的广播，也只有动态注册才会出现分发广播的时候还不存在。</li>
</ul>
</li>
</ul>
<p>下面是总结的图:<br><img src="/images/BroadcastReceiver.png" alt="BroadcastReceiver.png"></p>
<p>结合上面总结的图，我们来总结发送广播，BroadcastReceiver 接受的过程。</p>
<p>就是专门处理如下三个函数的逻辑：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">sendBroadcast</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequiresPermission</span> Intent intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">sendOrderedBroadcast</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequiresPermission</span> Intent intent<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> String receiverPermission<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.发送广播后，调用了broadcastIntent进行分发广播。发现此时的广播消息是粘性消息，先把广播保存起来</p>
</li>
<li><p>2.如果当前的Intent的flag设置了FLAG_RECEIVER_REGISTERED_ONLY，说明只会获取动态注册的广播，就不会从PMS中查找符合过滤条件静态注册的广播放到receiver集合中</p>
</li>
<li><p>3.接着从ActivityIntentResolver获取符合当前IntentFilter也就是符合过滤条件动态注册的广播接受者，放入registeredReceivers集合中</p>
</li>
<li><p>4.如果当前发送的广播消息是非有序，则把当前从registeredReceivers集合中查找到符合条件的BroadcastFilter添加通过enqueueParallelBroadcastLocked到BroadcastQueue的并发队列中；并且调用scheduleBroadcastsLocked让BroadcastQueue中Handler执行发送消息方法processNextBroadcast。</p>
</li>
<li><p>5.接着把获取到的静态广播接受者和动态广播接受者合并到一个队列receivers，并且包装receivers生成BroadcastRecord对象通过enqueueOrderedBroadcastLocked放入BroadcastQueue有序队列中，通过scheduleBroadcastsLocked调用Handler的发送消息方法processNextBroadcast。</p>
</li>
<li><p>6.通过Handler唤醒的BroadcastHandler，遍历保存在mParallelBroadcasts 这个ArrayList中的并行发送广播队列。</p>
<ul>
<li>获取mParallelBroadcasts中的receivers动态注册的广播对象BroadcastFilter，并且最后都调用跨进程调用方法scheduleReceiver通知ApplicationThread的scheduleRegisteredReceiver方法。</li>
<li>scheduleRegisteredReceiver则会调用传递进来的IIntentReceiver这个Binder对象，并通过他执行BroadcastReceiver的onReceiver。</li>
</ul>
</li>
</ul>
<ul>
<li><p>7.遍历保存在mOrderedBroadcasts中的广播接受者有序队列。如果当前元素是BroadcastReceiver说明是动态注册的广播接受者，将会重复第6点的逻辑。  </p>
<ul>
<li>如果当前元素ResolveInfo说明是静态注册的广播接受者，最后会调用ApplicationThread的scheduleReceiver方法。</li>
<li>scheduleReceiver会通过App的主线程的Looper执行handleReceiver方法，每一次都生成一个新的BroadcastReceiver，把广播消息发送给BroadcastReceiver的onReceive方法。</li>
</ul>
</li>
<li><p>8.当每一次广播执行完了都会执行BroadcastReceiver.PendingResult的sendFinished方法。而这个方法会清除一些在BroadcastQueue的残留属性之外还会询问是否有需要消息的有序消息，如果是则继续执行processNextBroadcast。</p>
</li>
</ul>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>值得注意的是在Android高版本如果在Intent不设置好Package，不会发现AMS拒绝发送这条广播到对应的广播接受者。</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> allowed <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getAppStartModeLocked</span><span class="token punctuation">(</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>allowed <span class="token operator">!=</span> ActivityManager<span class="token punctuation">.</span>APP_START_MODE_NORMAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// We won't allow this receiver to be launched if the app has been</span>
                <span class="token comment" spellcheck="true">// completely disabled from launches, or it was not explicitly sent</span>
                <span class="token comment" spellcheck="true">// to it and the app is in a state that should not receive it</span>
                <span class="token comment" spellcheck="true">// (depending on how getAppStartModeLocked has determined that).</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>allowed <span class="token operator">==</span> ActivityManager<span class="token punctuation">.</span>APP_START_MODE_DISABLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Background execution disabled: receiving "</span>
                            <span class="token operator">+</span> r<span class="token punctuation">.</span>intent <span class="token operator">+</span> <span class="token string">" to "</span>
                            <span class="token operator">+</span> component<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_EXCLUDE_BACKGROUND<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token operator">||</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null
                            <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null
                            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token operator">&amp;</span> Intent<span class="token punctuation">.</span>FLAG_RECEIVER_INCLUDE_BACKGROUND<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSignaturePerm</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>requiredPermissions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mService<span class="token punctuation">.</span><span class="token function">addBackgroundCheckViolationLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            component<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Background execution not allowed: receiving "</span>
                            <span class="token operator">+</span> r<span class="token punctuation">.</span>intent <span class="token operator">+</span> <span class="token string">" to "</span>
                            <span class="token operator">+</span> component<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一般会爆出下面这个分支的异常，从而跳出当前分发逻辑。一般就是因为在这个过程校验了Intent的getPackage和getComponent都为空且没有打开FLAG_RECEIVER_INCLUDE_BACKGROUND的flag；或者打开了FLAG_RECEIVER_EXCLUDE_BACKGROUND。</p>
<p>这两个标志位处理了该消息是否包含了后台Receiver。注意这里的后台是相对，对于Intent来说只要没有知道他的包名或者Component。和发送的时候添加Intent.FLAG_RECEIVER_FOREGROUND不是一样的意思。</p>
<blockquote>
<p>FLAG_RECEIVER_FOREGROUND 当发送广播的时候设置了这个标志，会允许接收者以前台的优先级运行，有更短的时间间隔。正常广播的接受者是后台优先级，不会被自动提升。</p>
</blockquote>
<p>为了适配BroadcastReceiver，我们必须添加好包名避免出现问题。或者添加：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">int</span> ent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token number">0x01000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>也就是FLAG_RECEIVER_INCLUDE_BACKGROUND才会正常。</p>
<p>这个坑在我为公司编写根据渠道自动切换推送库踩过，这里提示一下。</p>
<h3 id="Intent的意图过滤原理"><a href="#Intent的意图过滤原理" class="headerlink" title="Intent的意图过滤原理"></a>Intent的意图过滤原理</h3><ul>
<li><p>如果想要IntentFilter，意图过滤生效。满足三个条件之一，一个是必须存在Intent的action，另一个是getContentReslover的字符串不为空，最后一个是scheme不为空。这决定了解析是否能拆分出四个子部分进行匹配</p>
</li>
<li><p>categories并非是必须的，就算没有也可以通过action，data，scheme，type进行匹配。</p>
</li>
<li><p>当存在action，就会从中获取所有符合条件的所有ActivityIntentInfo对象，在此基础上，对依次对data，categories进行匹配。如果data匹配成功了就直接返回，如果data匹配失败了就会尝试匹配categories。</p>
</li>
</ul>
<p>如果存在多个data只需要匹配其中一个data返回即可。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/08/09/android-chong-xue-xi-lie-service-qi-dong-he-bang-ding-yuan-li/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="Android重学系列 Service 启动和绑定原理">
                        
                        <span class="card-title">Android重学系列 Service 启动和绑定原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言我们已经了解了BroadcastReceiver的原理，我们再来看看四大组件之一的Service是怎么启动的，以及怎么运行的原理。
正文启动Service的入口就是startService和bindService方法。我们先来看看sta
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-08-09
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-Framework/" class="post-category">
                                    Android Framework
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/07/26/android-chong-xue-xi-lie-ims-yu-shi-jian-fen-fa-xia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="Android重学系列 IMS与事件分发(下)">
                        
                        <span class="card-title">Android重学系列 IMS与事件分发(下)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章和大家聊到了IMS在SystemServer进程native层中的原理，本文来聊聊App进程是怎么监听IMS分发出来的输入信号的.
正文还记得我写过WMS系列文章WMS在Activity启动中的职责 添加窗体(三)中，提到了A
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-07-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/IMS/" class="post-category">
                                    IMS
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
