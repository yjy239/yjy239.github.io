<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android重学系列 ContentProvider 启动原理, Android | Linux | Flutter">
    <meta name="description" content="前言终于来到了四大组件的最后一个了，ContentProvider(之后简称CP)开发中用的不是很多，但这不代表这不重要。很多开源库不少巧妙的思路就是借用CP巧妙实现的，如头条的AutoSize是如何自动获取Context的，360的ReP">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android重学系列 ContentProvider 启动原理 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/2.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android重学系列 ContentProvider 启动原理
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android-Framework/" class="post-category">
                                Android Framework
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-08-15
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        6.6k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        30 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>终于来到了四大组件的最后一个了，ContentProvider(之后简称CP)开发中用的不是很多，但这不代表这不重要。很多开源库不少巧妙的思路就是借用CP巧妙实现的，如头条的AutoSize是如何自动获取Context的，360的RePlugin是如何管理异步进程的Binder对象。还有比如说插件化管理多个LoadedApk对象，也是从CP的源码中汲取灵感。</p>
<p>当然我们常用的手段都是把CP作为开放给另一个进程或者服务的查询接口。先来看看怎么使用的。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCP</span> <span class="token keyword">extends</span> <span class="token class-name">ContentProvider</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Cursor <span class="token function">query</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Uri uri<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> projection<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String selection<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String sortOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">getType</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Uri <span class="token function">insert</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Uri uri<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ContentValues values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Uri uri<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String selection<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Uri uri<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ContentValues values<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String selection<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先继承ContentProvider，实现自己的增删查改四个接口。来处理自己可以允许外部操作的数据。一般为SQLite 数据库等敏感数据，从而做到隔离的目的。</p>
<p>接着在在AndroidManifest中声明:</p>
<pre class="line-numbers language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>provider</span>
            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MyCP<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>authorities</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.example.data<span class="token punctuation">"</span></span>
            <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样就能让外部的应用，或者本进程应用进行访问通过android:authorities进行访问这个CP中对外开放的数据了。</p>
<p>注意CP支持跨进程，跨应用查询数据，这是怎么做到的呢？本文就来重点探索。</p>
<h2 id="本进程启动时的CP启动"><a href="#本进程启动时的CP启动" class="headerlink" title="本进程启动时的CP启动"></a>本进程启动时的CP启动</h2><p>在我写的<a href="https://www.jianshu.com/p/2b1d43ffeba6" target="_blank" rel="noopener">ActivityThread的初始化</a>一文中，handleBindApplication方法中，有这么一段：</p>
<pre class="line-numbers language-java"><code class="language-java">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">installContentProviders</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mH<span class="token punctuation">.</span><span class="token function">sendEmptyMessageDelayed</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>ENABLE_JIT<span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当执行绑定Application的时候，会调用installContentProviders方法。获取AppBindData中所有的从PMS中解析出来来自apk包中所有的ProviderInfo信息，也就是AndroidManifest中所有注册在xml中ContentProvider。</p>
<h3 id="installContentProviders"><a href="#installContentProviders" class="headerlink" title="installContentProviders"></a>installContentProviders</h3><pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installContentProviders</span><span class="token punctuation">(</span>
            Context context<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>ProviderInfo<span class="token operator">></span> providers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>ContentProviderHolder<span class="token operator">></span> results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>ProviderInfo cpi <span class="token operator">:</span> providers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ContentProviderHolder cph <span class="token operator">=</span> <span class="token function">installProvider</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> null<span class="token punctuation">,</span> cpi<span class="token punctuation">,</span>
                    <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*noisy*/</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*noReleaseNeeded*/</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*stable*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cph <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cph<span class="token punctuation">.</span>noReleaseNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                results<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cph<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">publishContentProviders</span><span class="token punctuation">(</span>
                <span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.遍历每一个ProviderInfo，并且调用installProvider生成对应ContentProvider</li>
<li>2.跨进程调用AMS的publishContentProviders方法。</li>
</ul>
<h4 id="installProvider-生成ContentProvider"><a href="#installProvider-生成ContentProvider" class="headerlink" title="installProvider 生成ContentProvider"></a>installProvider 生成ContentProvider</h4><p>注意这个方法由于支持不同的应用CP的创建，这里的Context不一定是本进程，ContentProviderHolder包含的进程信息也不一定的本进程，因此会做重要的特殊处理：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> ContentProviderHolder <span class="token function">installProvider</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span>
            ContentProviderHolder holder<span class="token punctuation">,</span> ProviderInfo info<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> noisy<span class="token punctuation">,</span> <span class="token keyword">boolean</span> noReleaseNeeded<span class="token punctuation">,</span> <span class="token keyword">boolean</span> stable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ContentProvider localProvider <span class="token operator">=</span> null<span class="token punctuation">;</span>
        IContentProvider provider<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> null <span class="token operator">||</span> holder<span class="token punctuation">.</span>provider <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            Context c <span class="token operator">=</span> null<span class="token punctuation">;</span>
            ApplicationInfo ai <span class="token operator">=</span> info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                c <span class="token operator">=</span> context<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mInitialApplication <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                    mInitialApplication<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                c <span class="token operator">=</span> mInitialApplication<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    c <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createPackageContext</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                            Context<span class="token punctuation">.</span>CONTEXT_INCLUDE_CODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManager<span class="token punctuation">.</span>NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Ignore</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>splitName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    c <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">createContextForSplit</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>splitName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader cl <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                LoadedApk packageInfo <span class="token operator">=</span> <span class="token function">peekPackageInfo</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    packageInfo <span class="token operator">=</span> <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                localProvider <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getAppFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">instantiateProvider</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                provider <span class="token operator">=</span> localProvider<span class="token punctuation">.</span><span class="token function">getIContentProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>provider <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                localProvider<span class="token punctuation">.</span><span class="token function">attachInfo</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            provider <span class="token operator">=</span> holder<span class="token punctuation">.</span>provider<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        ContentProviderHolder retHolder<span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mProviderMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            IBinder jBinder <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localProvider <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ComponentName cname <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ProviderClientRecord pr <span class="token operator">=</span> mLocalProvidersByName<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cname<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    provider <span class="token operator">=</span> pr<span class="token punctuation">.</span>mProvider<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContentProviderHolder</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    holder<span class="token punctuation">.</span>provider <span class="token operator">=</span> provider<span class="token punctuation">;</span>
                    holder<span class="token punctuation">.</span>noReleaseNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    pr <span class="token operator">=</span> <span class="token function">installProviderAuthoritiesLocked</span><span class="token punctuation">(</span>provider<span class="token punctuation">,</span> localProvider<span class="token punctuation">,</span> holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mLocalProviders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>jBinder<span class="token punctuation">,</span> pr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mLocalProvidersByName<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cname<span class="token punctuation">,</span> pr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                retHolder <span class="token operator">=</span> pr<span class="token punctuation">.</span>mHolder<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> retHolder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果此时ContentProviderHolder为空，或者ContentProviderHolder中的CP为空，说明需要初始化。会根据ProviderInfo中保存的包名信息创造如下三种Context：</p>
<ul>
<li>1.1.如果包名和下传的Context 上下文的包名一致，CP则使用这个Context创建</li>
<li>1.2.如果Context不一致，则判断执行的当前进程的包名和ProviderInfo的包名是否一致，一致则取mInitialApplication当前进程的Application的Context为CP的上下文</li>
<li>1.3.剩下的情况就是，为CP对应的包名创建一个自己的上下文Context对象。</li>
</ul>
</li>
<li><p>2.从LoadedApk的缓存中获取是否有加载的其他apk的包名对应的LoadedApk对象。LoadedApk其实就是指Apk加载到内存后的对象，详细可以阅读<a href="https://www.jianshu.com/p/2b1d43ffeba6" target="_blank" rel="noopener">ActivityThread的初始化</a>。找不到则使用系统Context的包名的LoadedApk对象。使用LoadedApk的AppFactory反射实例化ContentProvider对象。</p>
</li>
<li><p>3.获取ContentProvider中的IContentProvider对象，并调用ContentProvider的attachInfo方法。</p>
</li>
<li><p>4.如果此时创建出来的CP不为空。</p>
<ul>
<li>4.1.通过当前CP的包名信息ComponentName从缓存mLocalProvidersByName获取ProviderClientRecord对象。<ul>
<li>4.1.1.如果能从缓存中获取，IContentProvider则获取ProviderClientRecord中的mProvider对象。</li>
<li>4.1.2.如果无法从缓存中获取，则新创建ContentProviderHolder对象，并为该对象赋值CP的IContentProvider Binder对象。</li>
<li>4.1.3.installProviderAuthoritiesLocked 使用 IContentProvider，CP创建ProviderClientRecord，最后把ProviderClientRecord缓存到mLocalProvidersByName中。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>来看看ContentProvider的attachInfo，以及installProviderAuthoritiesLocked。</p>
<p>有一个核心的方法，getIContentProvider方法获取IContentProvider Binder对象，先来看看这个方法做了什么？</p>
<h4 id="位于ContentProvider中的Binder对象-Transport"><a href="#位于ContentProvider中的Binder对象-Transport" class="headerlink" title="位于ContentProvider中的Binder对象 Transport"></a>位于ContentProvider中的Binder对象 Transport</h4><pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">private</span> Transport mTransport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> IContentProvider <span class="token function">getIContentProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mTransport<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个对象实际上就是Transport。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Transport</span> <span class="token keyword">extends</span> <span class="token class-name">ContentProviderNative</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>他实际上就是一个派生于ContentProviderNative的Transport对象。所有跨进程通信都是通过这个内部类，通信外部的ContentProvider的。</p>
<h4 id="ContentProvider-attachInfo"><a href="#ContentProvider-attachInfo" class="headerlink" title="ContentProvider attachInfo"></a>ContentProvider attachInfo</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">attachInfo</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ProviderInfo info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">attachInfo</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> info<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attachInfo</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ProviderInfo info<span class="token punctuation">,</span> <span class="token keyword">boolean</span> testing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mNoPerms <span class="token operator">=</span> testing<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * Only allow it to be set once, so after the content service gives
         * this to us clients can't change it.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mContext <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mTransport<span class="token punctuation">.</span>mAppOpsManager <span class="token operator">=</span> <span class="token punctuation">(</span>AppOpsManager<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>
                        Context<span class="token punctuation">.</span>APP_OPS_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mMyUid <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">myUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>info <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setReadPermission</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>readPermission<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setWritePermission</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>writePermission<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setPathPermissions</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>pathPermissions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mExported <span class="token operator">=</span> info<span class="token punctuation">.</span>exported<span class="token punctuation">;</span>
                mSingleUser <span class="token operator">=</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ProviderInfo<span class="token punctuation">.</span>FLAG_SINGLE_USER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token function">setAuthorities</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>authority<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ContentProvider<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里面做了两件很重要的事情：</p>
<ul>
<li>1.从PMS解析出来的ProviderInfo中获取装载CP的权限</li>
<li>2.调用ContentProvider的onCreate方法。</li>
</ul>
<h4 id="ActivityThread-installProviderAuthoritiesLocked"><a href="#ActivityThread-installProviderAuthoritiesLocked" class="headerlink" title="ActivityThread installProviderAuthoritiesLocked"></a>ActivityThread installProviderAuthoritiesLocked</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> ProviderClientRecord <span class="token function">installProviderAuthoritiesLocked</span><span class="token punctuation">(</span>IContentProvider provider<span class="token punctuation">,</span>
            ContentProvider localProvider<span class="token punctuation">,</span> ContentProviderHolder holder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> String auths<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> holder<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>provider <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// If this provider is hosted by the core OS and cannot be upgraded,</span>
            <span class="token comment" spellcheck="true">// then I guess we're okay doing blocking calls to it.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String auth <span class="token operator">:</span> auths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> ContactsContract<span class="token punctuation">.</span>AUTHORITY<span class="token operator">:</span>
                    <span class="token keyword">case</span> CallLog<span class="token punctuation">.</span>AUTHORITY<span class="token operator">:</span>
                    <span class="token keyword">case</span> CallLog<span class="token punctuation">.</span>SHADOW_AUTHORITY<span class="token operator">:</span>
                    <span class="token keyword">case</span> BlockedNumberContract<span class="token punctuation">.</span>AUTHORITY<span class="token operator">:</span>
                    <span class="token keyword">case</span> CalendarContract<span class="token punctuation">.</span>AUTHORITY<span class="token operator">:</span>
                    <span class="token keyword">case</span> Downloads<span class="token punctuation">.</span>Impl<span class="token punctuation">.</span>AUTHORITY<span class="token operator">:</span>
                    <span class="token keyword">case</span> <span class="token string">"telephony"</span><span class="token operator">:</span>
                        Binder<span class="token punctuation">.</span><span class="token function">allowBlocking</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> ProviderClientRecord pcr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProviderClientRecord</span><span class="token punctuation">(</span>
                auths<span class="token punctuation">,</span> provider<span class="token punctuation">,</span> localProvider<span class="token punctuation">,</span> holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String auth <span class="token operator">:</span> auths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ProviderKey key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProviderKey</span><span class="token punctuation">(</span>auth<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ProviderClientRecord existing <span class="token operator">=</span> mProviderMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>existing <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mProviderMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> pcr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pcr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.如果当前的CP中的权限是：联系方式，下载，日历等，则说明这个CP是由系统托管且不能升级，则允许阻塞调用。</li>
<li>2.创建一个ProviderClientRecord对象，获取当前CP中所有的权限和当前userID生成一个Key，保存到mProviderMap中。</li>
</ul>
<p>这个缓存相当于可以通过CP的权限协议，快速找到ProviderClientRecord对象。</p>
<h3 id="AMS-publishContentProviders"><a href="#AMS-publishContentProviders" class="headerlink" title="AMS publishContentProviders"></a>AMS publishContentProviders</h3><p>当App端生成并保存好缓存后，则调用AMS的publishContentProviders。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">publishContentProviders</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span>
            List<span class="token operator">&lt;</span>ContentProviderHolder<span class="token operator">></span> providers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>providers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ProcessRecord r <span class="token operator">=</span> <span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> providers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ContentProviderHolder src <span class="token operator">=</span> providers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>src <span class="token operator">==</span> null <span class="token operator">||</span> src<span class="token punctuation">.</span>info <span class="token operator">==</span> null <span class="token operator">||</span> src<span class="token punctuation">.</span>provider <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ContentProviderRecord dst <span class="token operator">=</span> r<span class="token punctuation">.</span>pubProviders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>dst <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ComponentName comp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>dst<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mProviderMap<span class="token punctuation">.</span><span class="token function">putProviderByClass</span><span class="token punctuation">(</span>comp<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    String names<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> dst<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> names<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mProviderMap<span class="token punctuation">.</span><span class="token function">putProviderByName</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">int</span> launchingCount <span class="token operator">=</span> mLaunchingProviders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> j<span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> wasInLaunchingProviders <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> launchingCount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLaunchingProviders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">==</span> dst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mLaunchingProviders<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            wasInLaunchingProviders <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            j<span class="token operator">--</span><span class="token punctuation">;</span>
                            launchingCount<span class="token operator">--</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>wasInLaunchingProviders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        dst<span class="token punctuation">.</span>provider <span class="token operator">=</span> src<span class="token punctuation">.</span>provider<span class="token punctuation">;</span>
                        dst<span class="token punctuation">.</span>proc <span class="token operator">=</span> r<span class="token punctuation">;</span>
                        dst<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">maybeUpdateProviderUsageStatsLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> src<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                            src<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>mProviderMap 中做了两级缓存：</li>
</ol>
<ul>
<li>1.1.以当前的实例化好的CP包名为key，把保存在ContentProviderHolder的ContentProviderRecord保存起来。</li>
<li>1.2.以当前的实例化好的CP权限协议为key，把保存在ContentProviderHolder的ContentProviderRecord保存起来。</li>
</ul>
</li>
<li><p>2.如果mLaunchingProviders 不为空，且当前启动的CP是正在启动的mLaunchingProviders中一员，则移除CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG这个CP的ANR消息。这个时间是10秒。埋入的时机是进入attachApplicationLocked方法，也就是跨进程调用Activitythread的bindApplication之前：</p>
<pre class="line-numbers language-java"><code class="language-java">      List<span class="token operator">&lt;</span>ProviderInfo<span class="token operator">></span> providers <span class="token operator">=</span> normalMode <span class="token operator">?</span> <span class="token function">generateApplicationProvidersLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>providers <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">checkAppInLaunchingProvidersLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
          msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> app<span class="token punctuation">;</span>
          mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> CONTENT_PROVIDER_PUBLISH_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>3.更新App应用的adj优先级。</p>
</li>
</ul>
<p>正是因为在App进程调用Application的onCreate之后会尝试启动本进程中的CP组件，所以想头条的AndroidAutoSize才能没有在Application中写注册代码就能获取到当前应用的上下文。</p>
<h2 id="通过getContentResolver-创建CP"><a href="#通过getContentResolver-创建CP" class="headerlink" title="通过getContentResolver 创建CP"></a>通过getContentResolver 创建CP</h2><p>通过getContentResolver 获取CP对象是我们更加常用的方式。一般使用方法如下：</p>
<pre class="line-numbers language-java"><code class="language-java"> Cursor cursor <span class="token operator">=</span> null<span class="token punctuation">;</span>
cursor <span class="token operator">=</span> <span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>ContactsContract<span class="token punctuation">.</span>CommonDataKinds<span class="token punctuation">.</span>Phone<span class="token punctuation">.</span>CONTENT_URI<span class="token punctuation">,</span>
                null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>通过getContentResolver获取到CP对象后，调用query查询本进程或者其他进程通过CP开放的数据(一般来说就是数据库的数据)。通过Cursor 游标遍历获取的数据集中的数据。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> ContentResolver <span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mContentResolver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>那么mContentResolver这个对象又是从哪里什么时候创建的呢？</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token function">ContextImpl</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> ContextImpl container<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> ActivityThread mainThread<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> LoadedApk packageInfo<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String splitName<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> IBinder activityToken<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mContentResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContentResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mainThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上我们操作的就是ApplicationContentResolver对象,这个对象继承于ContentResolver。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContentResolver</span> <span class="token keyword">extends</span> <span class="token class-name">ContentResolver</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们先跟着ContentResolver的query，看看它做了什么事情</p>
<h3 id="ContentResolver-query"><a href="#ContentResolver-query" class="headerlink" title="ContentResolver query"></a>ContentResolver query</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> Cursor <span class="token function">query</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequiresPermission</span><span class="token punctuation">.</span>Read <span class="token annotation punctuation">@NonNull</span> Uri uri<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> projection<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String selection<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String sortOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">query</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> selection<span class="token punctuation">,</span> selectionArgs<span class="token punctuation">,</span> sortOrder<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> Cursor <span class="token function">query</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequiresPermission</span><span class="token punctuation">.</span>Read <span class="token annotation punctuation">@NonNull</span> Uri uri<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> projection<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String selection<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String sortOrder<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> CancellationSignal cancellationSignal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Bundle queryArgs <span class="token operator">=</span> <span class="token function">createSqlQueryBundle</span><span class="token punctuation">(</span>selection<span class="token punctuation">,</span> selectionArgs<span class="token punctuation">,</span> sortOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">query</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> queryArgs<span class="token punctuation">,</span> cancellationSignal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> Cursor <span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token annotation punctuation">@RequiresPermission</span><span class="token punctuation">.</span>Read <span class="token annotation punctuation">@NonNull</span> Uri uri<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> projection<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Bundle queryArgs<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> CancellationSignal cancellationSignal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token string">"uri"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        IContentProvider unstableProvider <span class="token operator">=</span> <span class="token function">acquireUnstableProvider</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>unstableProvider <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        IContentProvider stableProvider <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Cursor qCursor <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                qCursor <span class="token operator">=</span> unstableProvider<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>mPackageName<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> projection<span class="token punctuation">,</span>
                        queryArgs<span class="token punctuation">,</span> remoteCancellationSignal<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DeadObjectException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token function">unstableProviderDied</span><span class="token punctuation">(</span>unstableProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
                stableProvider <span class="token operator">=</span> <span class="token function">acquireProvider</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stableProvider <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                qCursor <span class="token operator">=</span> stableProvider<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
                        mPackageName<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> queryArgs<span class="token punctuation">,</span> remoteCancellationSignal<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>qCursor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>


            qCursor<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> durationMillis <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">final</span> IContentProvider provider <span class="token operator">=</span> <span class="token punctuation">(</span>stableProvider <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> stableProvider
                    <span class="token operator">:</span> <span class="token function">acquireProvider</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> CursorWrapperInner wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CursorWrapperInner</span><span class="token punctuation">(</span>qCursor<span class="token punctuation">,</span> provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stableProvider <span class="token operator">=</span> null<span class="token punctuation">;</span>
            qCursor <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">return</span> wrapper<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>qCursor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                qCursor<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cancellationSignal <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cancellationSignal<span class="token punctuation">.</span><span class="token function">setRemote</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>unstableProvider <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">releaseUnstableProvider</span><span class="token punctuation">(</span>unstableProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stableProvider <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">releaseProvider</span><span class="token punctuation">(</span>stableProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.acquireUnstableProvider 先获取一个先从ActivityThread中获取一个IContentProvider Binder对象</p>
</li>
<li><p>2.调用IContentProvider的query方法。</p>
</li>
<li><p>3.如果query方法爆出了Binder死亡异常的错误，先调用unstableProviderDied销毁原来的对象，再一次调用acquireProvider方法获取IContentProvider对象，再进行一次query的方法，查询数据结果。</p>
</li>
<li><p>4.stableProvider为空，也就说没有经过弥补查询的过程，则调用acquireProvider获取IContentProvider对象，并把获取到的数据浮标Cursor和IContentProvider封装成CursorWrapperInner返回。</p>
</li>
<li><p>5.如果stableProvider不为空，说明出现过异常，弥补了异常，直接使用stableProvider封装成CursorWrapperInner返回。</p>
</li>
</ul>
<p>核心的方法有三个：</p>
<ul>
<li>1.acquireUnstableProvider 获取IContentProvider</li>
<li>2.acquireProvider 获取IContentProvider</li>
<li>3.IContentProvider的query方法。</li>
</ul>
<h4 id="acquireProvider和acquireUnstableProvider"><a href="#acquireProvider和acquireUnstableProvider" class="headerlink" title="acquireProvider和acquireUnstableProvider"></a>acquireProvider和acquireUnstableProvider</h4><p>在ContentResolver中：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> IContentProvider <span class="token function">acquireUnstableProvider</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCHEME_CONTENT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String auth <span class="token operator">=</span> uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>auth <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">acquireUnstableProvider</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> IContentProvider <span class="token function">acquireProvider</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCHEME_CONTENT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> String auth <span class="token operator">=</span> uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>auth <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">acquireProvider</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心的实现还是它的派生类ApplicationContentResolver</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> IContentProvider <span class="token function">acquireUnstableProvider</span><span class="token punctuation">(</span>Context c<span class="token punctuation">,</span> String auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mMainThread<span class="token punctuation">.</span><span class="token function">acquireProvider</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>
                    ContentProvider<span class="token punctuation">.</span><span class="token function">getAuthorityWithoutUserId</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">resolveUserIdFromAuthority</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> IContentProvider <span class="token function">acquireProvider</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> String auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mMainThread<span class="token punctuation">.</span><span class="token function">acquireProvider</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>
                    ContentProvider<span class="token punctuation">.</span><span class="token function">getAuthorityWithoutUserId</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">resolveUserIdFromAuthority</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这两个方法最后都是调用了ActivityThread的acquireProvider方法。</p>
<h5 id="ActivityThread-acquireProvider"><a href="#ActivityThread-acquireProvider" class="headerlink" title="ActivityThread acquireProvider"></a>ActivityThread acquireProvider</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> IContentProvider <span class="token function">acquireProvider</span><span class="token punctuation">(</span>
            Context c<span class="token punctuation">,</span> String auth<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> stable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> IContentProvider provider <span class="token operator">=</span> <span class="token function">acquireExistingProvider</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> auth<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> stable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>provider <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> provider<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        ContentProviderHolder holder <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getGetProviderLock</span><span class="token punctuation">(</span>auth<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                holder <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContentProvider</span><span class="token punctuation">(</span>
                        <span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> stable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to find provider info for "</span> <span class="token operator">+</span> auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        holder <span class="token operator">=</span> <span class="token function">installProvider</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> holder<span class="token punctuation">,</span> holder<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
                <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*noisy*/</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span>noReleaseNeeded<span class="token punctuation">,</span> stable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> holder<span class="token punctuation">.</span>provider<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> Object <span class="token function">getGetProviderLock</span><span class="token punctuation">(</span>String auth<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> ProviderKey key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProviderKey</span><span class="token punctuation">(</span>auth<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGetProviderLocks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Object lock <span class="token operator">=</span> mGetProviderLocks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lock <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lock <span class="token operator">=</span> key<span class="token punctuation">;</span>
                mGetProviderLocks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> lock<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.首先通过acquireExistingProvider 使用CP的uri权限获取已经保存在mProviderMap缓存好的IContentProvider对象，增加引用计数。如果找到了IContentProvider对象，则直接返回。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">final</span> IContentProvider <span class="token function">acquireExistingProvider</span><span class="token punctuation">(</span>
          Context c<span class="token punctuation">,</span> String auth<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> stable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mProviderMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">final</span> ProviderKey key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProviderKey</span><span class="token punctuation">(</span>auth<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">final</span> ProviderClientRecord pr <span class="token operator">=</span> mProviderMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pr <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> null<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          IContentProvider provider <span class="token operator">=</span> pr<span class="token punctuation">.</span>mProvider<span class="token punctuation">;</span>
          IBinder jBinder <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>jBinder<span class="token punctuation">.</span><span class="token function">isBinderAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

              <span class="token function">handleUnstableProviderDiedLocked</span><span class="token punctuation">(</span>jBinder<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> null<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          ProviderRefCount prc <span class="token operator">=</span> mProviderRefCountMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>jBinder<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>prc <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">incProviderRefLocked</span><span class="token punctuation">(</span>prc<span class="token punctuation">,</span> stable<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> provider<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>2.如果当前进程不存在一个IContentProvider对象，说明当前CP对象是其他进程提供的，或者是当前的进程还有启动这个CP对象。那么通过auth从mGetProviderLocks获取一个互斥锁，通过AMS跨进程获取ContentProviderHolder对象，接着通过installProvider把这个CP对象装载在本进程中。</p>
</li>
</ul>
<h4 id="AMS-getContentProvider"><a href="#AMS-getContentProvider" class="headerlink" title="AMS getContentProvider"></a>AMS getContentProvider</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> ContentProviderHolder <span class="token function">getContentProvider</span><span class="token punctuation">(</span>
            IApplicationThread caller<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> stable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">"getContentProvider"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token function">getContentProviderImpl</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> name<span class="token punctuation">,</span> null<span class="token punctuation">,</span> stable<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从AMS获取一个ContentProviderHolder对象核心还是getContentProviderImpl</p>
<h5 id="getContentProviderImpl"><a href="#getContentProviderImpl" class="headerlink" title="getContentProviderImpl"></a>getContentProviderImpl</h5><p>下面这个方法很长，我们分为几个阶段来聊聊。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> ContentProviderHolder <span class="token function">getContentProviderImpl</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span>
            String name<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span> <span class="token keyword">boolean</span> stable<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ContentProviderRecord cpr<span class="token punctuation">;</span>
        ContentProviderConnection conn <span class="token operator">=</span> null<span class="token punctuation">;</span>
        ProviderInfo cpi <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            ProcessRecord r <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r <span class="token operator">=</span> <span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> checkCrossUser <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>



            cpr <span class="token operator">=</span> mProviderMap<span class="token punctuation">.</span><span class="token function">getProviderByName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">boolean</span> providerRunning <span class="token operator">=</span> cpr <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cpr<span class="token punctuation">.</span>proc <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cpr<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>killed<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>providerRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cpi <span class="token operator">=</span> cpr<span class="token punctuation">.</span>info<span class="token punctuation">;</span>
                String msg<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cpr<span class="token punctuation">.</span><span class="token function">canRunHere</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    holder<span class="token punctuation">.</span>provider <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> holder<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">resolveContentProvider</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*flags*/</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                conn <span class="token operator">=</span> <span class="token function">incProviderCountLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> cpr<span class="token punctuation">,</span> token<span class="token punctuation">,</span> stable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>conn<span class="token punctuation">.</span>stableCount<span class="token operator">+</span>conn<span class="token punctuation">.</span>unstableCount<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>proc <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>setAdj <span class="token operator">&lt;=</span> ProcessList<span class="token punctuation">.</span>PERCEPTIBLE_APP_ADJ<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>proc<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> verifiedAdj <span class="token operator">=</span> cpr<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>verifiedAdj<span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>proc<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>success <span class="token operator">&amp;&amp;</span> verifiedAdj <span class="token operator">!=</span> cpr<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>setAdj <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isProcessAliveLocked</span><span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>proc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">maybeUpdateProviderUsageStatsLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> cpr<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li><p>首先先从mProviderMap，通过权限名和userId查找AMS中已经启动的ContentProviderRecord对象。注意在ProviderMap有4层缓存：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ContentProviderRecord<span class="token operator">></span> mSingletonByName
       <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ContentProviderRecord<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> HashMap<span class="token operator">&lt;</span>ComponentName<span class="token punctuation">,</span> ContentProviderRecord<span class="token operator">></span> mSingletonByClass
       <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>ComponentName<span class="token punctuation">,</span> ContentProviderRecord<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> SparseArray<span class="token operator">&lt;</span>HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ContentProviderRecord<span class="token operator">>></span> mProvidersByNamePerUser
       <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparseArray</span><span class="token operator">&lt;</span>HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ContentProviderRecord<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> SparseArray<span class="token operator">&lt;</span>HashMap<span class="token operator">&lt;</span>ComponentName<span class="token punctuation">,</span> ContentProviderRecord<span class="token operator">>></span> mProvidersByClassPerUser
       <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparseArray</span><span class="token operator">&lt;</span>HashMap<span class="token operator">&lt;</span>ComponentName<span class="token punctuation">,</span> ContentProviderRecord<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能通过Class的包名查找ContentProviderRecord，能直接通过name也就是CP的权限名查找ContentProviderRecord。</p>
</li>
</ol>
</li>
</ul>
<p>如果在这两个缓存中找不到，说明ContentProviderRecord对象会根据userID作为key 保存在SparseArray集合中。可以通过userId在对应的应用查找启动过的CP对象</p>
<p>注意此时调用query的时候传入的是一个uri格式，会获取uri的authority部分作为线索在AMS中查找缓存。同样的userId也是从authority中获取。也就是说如果想要对着某一个userID的缓存下查询CP对象,权限就要符合下面的格式:</p>
<pre class="line-numbers language-java"><code class="language-java">userId<span class="token annotation punctuation">@authority</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>会截取@之前的数字作为userId。</p>
<p>接下来就会根据ProviderMap的结果，得到此时需要当前需要访问的CP是否还存活？</p>
<h6 id="CP-对象存活"><a href="#CP-对象存活" class="headerlink" title="CP 对象存活"></a>CP 对象存活</h6><pre class="line-numbers language-java"><code class="language-java">            <span class="token keyword">if</span> <span class="token punctuation">(</span>providerRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cpi <span class="token operator">=</span> cpr<span class="token punctuation">.</span>info<span class="token punctuation">;</span>
                String msg<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cpr<span class="token punctuation">.</span><span class="token function">canRunHere</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    ContentProviderHolder holder <span class="token operator">=</span> cpr<span class="token punctuation">.</span><span class="token function">newHolder</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    holder<span class="token punctuation">.</span>provider <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> holder<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">resolveContentProvider</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*flags*/</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


                conn <span class="token operator">=</span> <span class="token function">incProviderCountLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> cpr<span class="token punctuation">,</span> token<span class="token punctuation">,</span> stable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>conn<span class="token punctuation">.</span>stableCount<span class="token operator">+</span>conn<span class="token punctuation">.</span>unstableCount<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>proc <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>setAdj <span class="token operator">&lt;=</span> ProcessList<span class="token punctuation">.</span>PERCEPTIBLE_APP_ADJ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>proc<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> verifiedAdj <span class="token operator">=</span> cpr<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>verifiedAdj<span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>proc<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.则调用ContentProviderRecord.canRunHere,校验CP对象是否能在调用方的进程运行</p>
</li>
<li><p>2.如果可以则ContentProviderRecord.newHolder 生成一个ContentProviderHolder，设置其中的provider为空返回。</p>
</li>
<li><p>3.增加引用计数，更新进程的adj优先级</p>
</li>
</ul>
<h6 id="ContentProviderRecord-canRunHere"><a href="#ContentProviderRecord-canRunHere" class="headerlink" title="ContentProviderRecord canRunHere"></a>ContentProviderRecord canRunHere</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canRunHere</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>multiprocess <span class="token operator">||</span> info<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> uid <span class="token operator">==</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>是否允许运行在当前进程，满足两个条件其一即可：</p>
<ul>
<li>1.<code>android:multiprocess="true"</code>在AndroidManifest中打开这个设置，允许CP在另外一个进程运行</li>
<li>2.uid一致且进程名一致</li>
</ul>
<p>如果是允许多进程执行，那就不关心这个CP运行在哪一个进程了，直接返回ContentProviderHolder。注意如果android:multiprocess没有打开，就如同系统查询手机联系人一样：</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token operator">&lt;</span>provider android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"CallLogProvider"</span>
            android<span class="token operator">:</span>authorities<span class="token operator">=</span><span class="token string">"call_log"</span>
            android<span class="token operator">:</span>syncable<span class="token operator">=</span><span class="token string">"false"</span> android<span class="token operator">:</span>multiprocess<span class="token operator">=</span><span class="token string">"false"</span>
            android<span class="token operator">:</span>exported<span class="token operator">=</span><span class="token string">"true"</span>
            android<span class="token operator">:</span>readPermission<span class="token operator">=</span><span class="token string">"android.permission.READ_CALL_LOG"</span>
            android<span class="token operator">:</span>writePermission<span class="token operator">=</span><span class="token string">"android.permission.WRITE_CALL_LOG"</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>provider<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>它不允许多进程运行，必须是当前进程执行。那么会直接到了方法最底部直接调用ContentProviderRecord.newHolder返回，不同的是传入了ContentProviderConnection</p>
<h6 id="ContentProviderRecord-newHolder"><a href="#ContentProviderRecord-newHolder" class="headerlink" title="ContentProviderRecord newHolder"></a>ContentProviderRecord newHolder</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> ContentProviderHolder <span class="token function">newHolder</span><span class="token punctuation">(</span>ContentProviderConnection conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ContentProviderHolder holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContentProviderHolder</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        holder<span class="token punctuation">.</span>provider <span class="token operator">=</span> provider<span class="token punctuation">;</span>
        holder<span class="token punctuation">.</span>noReleaseNeeded <span class="token operator">=</span> noReleaseNeeded<span class="token punctuation">;</span>
        holder<span class="token punctuation">.</span>connection <span class="token operator">=</span> conn<span class="token punctuation">;</span>
        <span class="token keyword">return</span> holder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>返回了IContentProvider对象以及传入一个ContentProviderConnection对象，此时是空，我们暂时不去考虑。</p>
<h5 id="CP对象还没有启动"><a href="#CP对象还没有启动" class="headerlink" title="CP对象还没有启动"></a>CP对象还没有启动</h5><p>如果通过权限没办法找到对应的ContentProviderRecord对象，说明很可能没有启动.</p>
<pre class="line-numbers language-java"><code class="language-java">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>providerRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>

                    cpi <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                        <span class="token function">resolveContentProvider</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>
                            STOCK_PM_FLAGS <span class="token operator">|</span> PackageManager<span class="token punctuation">.</span>GET_URI_PERMISSION_PATTERNS<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cpi <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">boolean</span> singleton <span class="token operator">=</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span>cpi<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> cpi<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span>
                        cpi<span class="token punctuation">.</span>name<span class="token punctuation">,</span> cpi<span class="token punctuation">.</span>flags<span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token function">isValidSingletonCall</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> cpi<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    userId <span class="token operator">=</span> UserHandle<span class="token punctuation">.</span>USER_SYSTEM<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                cpi<span class="token punctuation">.</span>applicationInfo <span class="token operator">=</span> <span class="token function">getAppInfoForUser</span><span class="token punctuation">(</span>cpi<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>


                String msg<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>msg <span class="token operator">=</span> <span class="token function">checkContentProviderPermissionLocked</span><span class="token punctuation">(</span>cpi<span class="token punctuation">,</span> r<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token operator">!</span>singleton<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>


                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mProcessesReady
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cpi<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                            <span class="token string">"Attempt to launch content provider before system ready"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                ComponentName comp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>cpi<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> cpi<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                cpr <span class="token operator">=</span> mProviderMap<span class="token punctuation">.</span><span class="token function">getProviderByClass</span><span class="token punctuation">(</span>comp<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">boolean</span> firstClass <span class="token operator">=</span> cpr <span class="token operator">==</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>firstClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> ident <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>

                        ApplicationInfo ai <span class="token operator">=</span>
                            AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                                <span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>
                                        cpi<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                                        STOCK_PM_FLAGS<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ai <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        ai <span class="token operator">=</span> <span class="token function">getAppInfoForUser</span><span class="token punctuation">(</span>ai<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cpr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContentProviderRecord</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cpi<span class="token punctuation">,</span> ai<span class="token punctuation">,</span> comp<span class="token punctuation">,</span> singleton<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// pm is in same process, this will never happen.</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cpr<span class="token punctuation">.</span><span class="token function">canRunHere</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> cpr<span class="token punctuation">.</span><span class="token function">newHolder</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> mLaunchingProviders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> i<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mLaunchingProviders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> cpr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>


                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> N<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        ProcessRecord proc <span class="token operator">=</span> <span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>
                                cpi<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> cpr<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>proc <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> proc<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>proc<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>proc<span class="token punctuation">.</span>pubProviders<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>cpi<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                                proc<span class="token punctuation">.</span>pubProviders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cpi<span class="token punctuation">.</span>name<span class="token punctuation">,</span> cpr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                    proc<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleInstallProvider</span><span class="token punctuation">(</span>cpi<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                            proc <span class="token operator">=</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>cpi<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>
                                    cpr<span class="token punctuation">.</span>appInfo<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"content provider"</span><span class="token punctuation">,</span>
                                    <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>cpi<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                                            cpi<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span>proc <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        cpr<span class="token punctuation">.</span>launchingApp <span class="token operator">=</span> proc<span class="token punctuation">;</span>
                        mLaunchingProviders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cpr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>firstClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mProviderMap<span class="token punctuation">.</span><span class="token function">putProviderByClass</span><span class="token punctuation">(</span>comp<span class="token punctuation">,</span> cpr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                mProviderMap<span class="token punctuation">.</span><span class="token function">putProviderByName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cpr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                conn <span class="token operator">=</span> <span class="token function">incProviderCountLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> cpr<span class="token punctuation">,</span> token<span class="token punctuation">,</span> stable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    conn<span class="token punctuation">.</span>waiting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token function">grantEphemeralAccessLocked</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> null <span class="token comment" spellcheck="true">/*intent*/</span><span class="token punctuation">,</span>
                    cpi<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.首先resolveContentProvider从PMS中获取AndroidManifest中解析出对应的ProviderInfo对象。</p>
</li>
<li><p>2.通过ProviderInfo，获取其中的包名和类名,判断是否希望启动系统唯一的CP独享,但是发现运行的程序不是系统且没有运行则会报错。</p>
</li>
<li><p>3.根据ProviderInfo中保存的包名和类名从ProviderMap中查找是否有启动过的ContentProviderRecord对象。</p>
</li>
<li><p>4.通过AMS获取ProviderInfo的应用信息，根据应用信息和ProviderInfo生成ContentProviderRecord对象。接着校验ContentProviderRecord是否可以在调用进程运行，如果可以则返回ContentProviderHolder，在App进程生成CP对象。</p>
</li>
<li><p>5.接下来就是如果不可以在调用进程运行，说明此时这个不是该应用的CP注册没有打开多进程的标志。</p>
<ul>
<li>5.1.那么遍历mLaunchingProviders中是否存在现在需要启动的ContentProviderRecord对象。<ul>
<li>5.1.1.如果有，说明正在启动的CP对应的进程正在启动或者进程还在存活正在装载CP对象，此时则直接返回ContentProviderHolder。</li>
</ul>
</li>
</ul>
</li>
<li><p>6.如果没有在mLaunchingProviders找到CP对应的进程正在启动，进一步的判断这个进程是否还存活：</p>
<ul>
<li>6.1.如果当前的进程还存活，进程对象ProcessRecord的pubProviders保存当前的ProviderInfo的包名，并且调用scheduleInstallProvider方法。</li>
<li>6.2.如果当前进程已经死亡了，那么就会调用startProcessLocked，先启动进程，接着mLaunchingProviders保存当前的ContentProviderRecord，mProviderMap根据权限保存当前的ContentProviderRecord对象，接着执行下面这段代码：</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>cpr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>provider <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cpr<span class="token punctuation">.</span>launchingApp <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        conn<span class="token punctuation">.</span>waiting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    cpr<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        conn<span class="token punctuation">.</span>waiting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cpr <span class="token operator">!=</span> null <span class="token operator">?</span> cpr<span class="token punctuation">.</span><span class="token function">newHolder</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一段代码很简单，如果是因为启动CP对象，而需要启动的进程，就会把ContentProviderRecord作为Montor监控器，阻塞这个线程，等待CP所属的进程启动完成。</p>
<p>对于CP还没有运行起来，这里就分为两个大逻辑：</p>
<ul>
<li>1.CP所属进程还存活，就会调用scheduleInstallProvider安装CP对象</li>
<li>2.CP的进程不存活，则会阻塞当前的进程，知道进程启动成功后唤醒，才会继续返回方法。</li>
</ul>
<p>返回之后调用installProvider方法</p>
<h5 id="ActivityThread-scheduleInstallProvider"><a href="#ActivityThread-scheduleInstallProvider" class="headerlink" title="ActivityThread scheduleInstallProvider"></a>ActivityThread scheduleInstallProvider</h5><p>这个方法最后调用handleInstallProvider方法</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleInstallProvider</span><span class="token punctuation">(</span>ProviderInfo info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> StrictMode<span class="token punctuation">.</span>ThreadPolicy oldPolicy <span class="token operator">=</span> StrictMode<span class="token punctuation">.</span><span class="token function">allowThreadDiskWrites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">installContentProviders</span><span class="token punctuation">(</span>mInitialApplication<span class="token punctuation">,</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            StrictMode<span class="token punctuation">.</span><span class="token function">setThreadPolicy</span><span class="token punctuation">(</span>oldPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="CP所属的App进程启动后唤醒，AMS的阻塞"><a href="#CP所属的App进程启动后唤醒，AMS的阻塞" class="headerlink" title="CP所属的App进程启动后唤醒，AMS的阻塞"></a>CP所属的App进程启动后唤醒，AMS的阻塞</h5><p>这一段其实就是当App进程启动后，调用installProvider装载好CP之后，调用publishContentProviders方法，跨进程调用AMS的publishContentProviders：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">publishContentProviders</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span>
            List<span class="token operator">&lt;</span>ContentProviderHolder<span class="token operator">></span> providers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>providers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">"publishContentProviders"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> providers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dst <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">int</span> launchingCount <span class="token operator">=</span> mLaunchingProviders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> j<span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> wasInLaunchingProviders <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> launchingCount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLaunchingProviders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">==</span> dst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mLaunchingProviders<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            wasInLaunchingProviders <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            j<span class="token operator">--</span><span class="token punctuation">;</span>
                            launchingCount<span class="token operator">--</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>wasInLaunchingProviders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        dst<span class="token punctuation">.</span>provider <span class="token operator">=</span> src<span class="token punctuation">.</span>provider<span class="token punctuation">;</span>
                        dst<span class="token punctuation">.</span>proc <span class="token operator">=</span> r<span class="token punctuation">;</span>
                        dst<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>就是在这里，当CP所属进程绑定好Application之后，publishContentProviders查询之前在getContentProviderImpl添加到mLaunchingProviders集合中的ContentProviderRecord对象。调用ContentProviderRecord的notifyAll，唤醒还在等待的调用端。</p>
<ul>
<li>2.接着通过Context中的ClassLoader，反射生成CP对象。注意这里反射的时候是使用系统Context的AppFactory，也就是说无法使用自定义的AppFactory做特殊处理。</li>
</ul>
<ul>
<li>3.最后保存到本地缓存mLocalProviders中，并生成新的ContentProviderHolder返回给AMS中进行缓存。</li>
</ul>
<p>这个过程是不是很熟悉，其实就是插件化的核心原理，关于插件化的原理可以阅读我写的<a href="https://www.jianshu.com/p/d824056f510b" target="_blank" rel="noopener">横向浅析Small,RePlugin两个插件化框架</a>实际上就是从这里获取到灵感的。</p>
<h4 id="CP-调用query查询数据"><a href="#CP-调用query查询数据" class="headerlink" title="CP 调用query查询数据"></a>CP 调用query查询数据</h4><p>我们继续<code>getContentResolve().query</code>方法的流程，当准备好之后CP对象后，就调用ContentProvider中的Transport对象的query方法进行查询：</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> Cursor <span class="token function">query</span><span class="token punctuation">(</span>String callingPkg<span class="token punctuation">,</span> Uri uri<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> projection<span class="token punctuation">,</span>
                <span class="token annotation punctuation">@Nullable</span> Bundle queryArgs<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ICancellationSignal cancellationSignal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">validateIncomingUri</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
            uri <span class="token operator">=</span> <span class="token function">maybeGetUriWithoutUserId</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">enforceReadPermission</span><span class="token punctuation">(</span>callingPkg<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> null<span class="token punctuation">)</span> <span class="token operator">!=</span> AppOpsManager<span class="token punctuation">.</span>MODE_ALLOWED<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>projection <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MatrixCursor</span><span class="token punctuation">(</span>projection<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                Cursor cursor <span class="token operator">=</span> ContentProvider<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
                        uri<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> queryArgs<span class="token punctuation">,</span>
                        CancellationSignal<span class="token punctuation">.</span><span class="token function">fromTransport</span><span class="token punctuation">(</span>cancellationSignal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MatrixCursor</span><span class="token punctuation">(</span>cursor<span class="token punctuation">.</span><span class="token function">getColumnNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> String original <span class="token operator">=</span> <span class="token function">setCallingPackage</span><span class="token punctuation">(</span>callingPkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> ContentProvider<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
                        uri<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> queryArgs<span class="token punctuation">,</span>
                        CancellationSignal<span class="token punctuation">.</span><span class="token function">fromTransport</span><span class="token punctuation">(</span>cancellationSignal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token function">setCallingPackage</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在查询的时候会校验，当前CP是否设置了<code>android:readPermission</code>读取权限，如果设置了需要进行校验才能进行查询。同理增删改三个操作则是需要设置<code>android:writePermission</code>写入权限是否设置并允许。</p>
<p>如果此时不允许，且搜索的行列不为空，返回一个空数据的MatrixCursor。如果调用了query之后查询到的浮标是空则返回空。否则返回带了所有列名的空数据浮标</p>
<p>如果允许则调用ContentProvider的query方法，直接返回。在这里直接返回了Cursor 包含数据窗口的浮标。如果是SQLCursor的实现，那么就是来自sqlite数据库的数据。</p>
<p>当时进行SQLCursor查询的时候，会把索引填充好在整个CursorWindow中，等待浮标的移动进行查询。</p>
<h2 id="总结与思考"><a href="#总结与思考" class="headerlink" title="总结与思考"></a>总结与思考</h2><p>CP的启动可以分为如下三种情况：</p>
<h3 id="CP-异进程的启动与安装小结"><a href="#CP-异进程的启动与安装小结" class="headerlink" title="CP 异进程的启动与安装小结"></a>CP 异进程的启动与安装小结</h3><p>本应用的CP在本应用中是如何安装，这个很简单。就是在Application 绑定之后，调用installProvider实例化每一个来自本应用中所有在AndroidManifest的privder标签。如下图：<br><img src="/images/%E6%9C%AC%E5%BA%94%E7%94%A8%E7%9A%84ContentProvider%E5%9C%A8%E6%9C%AC%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8.png" alt="本应用的ContentProvider在本应用启动.png"></p>
<p>真正可能让人弄迷糊的问题就是，客户端应用需要访问一个不属于客户端应用的CP对象。</p>
<p>可以分为两个情况，一个是添加了<code>android:multiprocess="true"</code>的CP，一个是没有。</p>
<ul>
<li>对于没有打开多进程标签，也会生成一个ContentProviderHolder对象，保存到mLauncherProviders集合中，并阻塞获取ContentProviderHolder对象的流程。<ul>
<li>然后等到启动CP所属真正的进程，实例化好ContentProvider后。再实例化一个ContentProviderHolder对象，不过这个时候ContentProviderHolder就有了Transport 这个Binder对象。</li>
<li>通过AMS的publishContentProviders保存当前CP对应的CP名和ContentProviderHolder对象在ProviderMap中，让之后其他应用可以通过这个Binder通信到CP所属的进程进行数据上的交互。</li>
</ul>
</li>
</ul>
<p>如图：<br><img src="/images/%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8%E7%9A%84CP%E5%9C%A8%E4%B8%8D%E5%85%81%E8%AE%B8%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%BC%8F.png" alt="其他应用的CP在不允许多进程启动模式.png"></p>
<ul>
<li><p>对于打开了多进程标签，会返回一个ContentProviderHolder对象，而这个对象中IContentProvider Binder对象，也就是Transport对象。接下来则比较复杂：</p>
<ul>
<li><p>1.在installProvider方法中，先通过createPackageContext，创建出包名对应的Context上下文出来：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> Context <span class="token function">createPackageContextAsUser</span><span class="token punctuation">(</span>String packageName<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> NameNotFoundException <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">)</span> <span class="token operator">||</span> packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// The system resources are loaded in every application, so we can safely copy</span>
        <span class="token comment" spellcheck="true">// the context without reloading Resources.</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mMainThread<span class="token punctuation">,</span> mPackageInfo<span class="token punctuation">,</span> null<span class="token punctuation">,</span> mActivityToken<span class="token punctuation">,</span> user<span class="token punctuation">,</span>
                flags<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    LoadedApk pi <span class="token operator">=</span> mMainThread<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> mResources<span class="token punctuation">.</span><span class="token function">getCompatibilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            flags <span class="token operator">|</span> CONTEXT_REGISTER_PACKAGE<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pi <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ContextImpl c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mMainThread<span class="token punctuation">,</span> pi<span class="token punctuation">,</span> null<span class="token punctuation">,</span> mActivityToken<span class="token punctuation">,</span> user<span class="token punctuation">,</span>
                flags<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> displayId <span class="token operator">=</span> mDisplay <span class="token operator">!=</span> null
                <span class="token operator">?</span> mDisplay<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> Display<span class="token punctuation">.</span>DEFAULT_DISPLAY<span class="token punctuation">;</span>

        c<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span><span class="token function">createResources</span><span class="token punctuation">(</span>mActivityToken<span class="token punctuation">,</span> pi<span class="token punctuation">,</span> null<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                <span class="token function">getDisplayAdjustments</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCompatibilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>mResources <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> c<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageManager<span class="token punctuation">.</span>NameNotFoundException</span><span class="token punctuation">(</span>
            <span class="token string">"Application package "</span> <span class="token operator">+</span> packageName <span class="token operator">+</span> <span class="token string">" not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程很熟悉，就是通过getPackageInfo从PMS中获取包名对应的LoadedApk对象，这个对象就是apk在内存中的表示，接着装载资源到Context中，并返回Context。</p>
</li>
</ul>
</li>
</ul>
<p>如图：<br><img src="/images/%E9%9D%9E%E6%9C%AC%E5%BA%94%E7%94%A8%E7%9A%84CP%E6%89%93%E5%BC%80%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%BC%8F.png" alt="非本应用的CP打开多进程模式.png"></p>
<p>关于资源是如何加载的可以阅读我写的<a href="https://www.jianshu.com/p/817a787910f2" target="_blank" rel="noopener">资源管理系统系列</a>，关于Context和Application是如何绑定可以阅读我写的<a href="https://www.jianshu.com/p/2b1d43ffeba6" target="_blank" rel="noopener">ActivityThread的初始化</a>。</p>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>基于CP这种初始化的特殊性，开发者们也在此基础上做了各种奇思妙想。比如说，我不想过多的涉足应用的Application中，可以把初始化放到CP中进行，最经典就是<a href="https://github.com/JessYanCoding/AndroidAutoSize/blob/master/autosize/src/main/java/me/jessyan/autosize/InitProvider.java">AndroidAutoSize</a>的初始化。当然，我自己在编写自定义腾讯Matrix插件时候也用到这种思路。</p>
<p>RePlugin在管理每一个插件的Binder接口时候，也是包装成一个Cursor返回。</p>
<p>那么为什么Cursor没有实现Binder对象，也能进行数据共享呢？因为在客户端也提供了一个CP对象，把另一个进程的代码和ClassLoader也加载到本进程中。</p>
<p>为什么要这么做？因为CP本身经常和SQLite一起出现，由于Cursor中包含了数据库的浮标。每一次进行数据查询都会填充浮标中的浮标窗口，它的数据量很可能超过了Binder的传输限制，因此Google官方才会这么做。</p>
<p>其实这个CP加载把别的应用apk加载到另一个应用的过程，就是我们常说的插件化。插件化最初的灵感就是来源于此，关于插件化的具体原理，可以阅读<a href="https://www.jianshu.com/p/d824056f510b" target="_blank" rel="noopener">横向浅析Small,RePlugin两个插件化框架</a></p>
<h2 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h2><p>关于ContentProvider的启动就到这里了，但是我并没有深入聊CP中链接到数据库的原理，如何查询，数据如何填充CursorWindow的。关于这部分的知识等，后面有机会我们来解析Android的sqlite是如何实现的吧。</p>
<p>还有一句话，如果从重学系列一直跟着阅读到现在的朋友，现在应该可以把我两年前写的插件化原理绝大部分的内容都看懂了。接下来再让我写完最后一个PMS的模块，就可以把写了2年的Android重学系列给完结了。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/08/22/android-chong-xue-xi-lie-packagemanagerservice-de-qi-dong-yu-an-zhuang/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Android重学系列 PackageManagerService的启动与安装(上)">
                        
                        <span class="card-title">Android重学系列 PackageManagerService的启动与安装(上)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言PackageManagerService 是Android系统中对所有apk包的管理服务中心，之后我将成其为PMS。PMS除了管理所有已经安装好的apk包的数据，还包含了安装apk的服务，让我们一探究竟。
正文PMS的启动PMS的启动
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-08-22
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/PMS/" class="post-category">
                                    PMS
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/08/09/android-chong-xue-xi-lie-service-qi-dong-he-bang-ding-yuan-li/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="Android重学系列 Service 启动和绑定原理">
                        
                        <span class="card-title">Android重学系列 Service 启动和绑定原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言我们已经了解了BroadcastReceiver的原理，我们再来看看四大组件之一的Service是怎么启动的，以及怎么运行的原理。
正文启动Service的入口就是startService和bindService方法。我们先来看看sta
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-08-09
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-Framework/" class="post-category">
                                    Android Framework
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
