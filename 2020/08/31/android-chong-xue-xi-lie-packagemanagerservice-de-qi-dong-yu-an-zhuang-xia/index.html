<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android重学系列 PackageManagerService的启动与安装(下), Android | Linux | Flutter">
    <meta name="description" content="前言 之前和大家聊完了PMS的启动原理，本文继续介绍当进行安装的时候，PMS做了什么事情。
正文先来看看在Android 中如何吊起安装界面：
 public static void installApk(Context context, ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android重学系列 PackageManagerService的启动与安装(下) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android重学系列 PackageManagerService的启动与安装(下)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/PMS/" class="post-category">
                                PMS
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-08-31
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        14.3k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        71 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p> 之前和大家聊完了PMS的启动原理，本文继续介绍当进行安装的时候，PMS做了什么事情。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>先来看看在Android 中如何吊起安装界面：</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">installApk</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> String apkPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> null <span class="token operator">||</span> TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_VIEW<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//判读版本是否在7.0以上</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">>=</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"7.0以上，正在安装apk..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Uri apkUri <span class="token operator">=</span> FileProvider<span class="token punctuation">.</span><span class="token function">getUriForFile</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"com.yjy.fileprovider"</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

            intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_GRANT_READ_URI_PERMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">setDataAndType</span><span class="token punctuation">(</span>apkUri<span class="token punctuation">,</span> <span class="token string">"application/vnd.android.package-archive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"7.0以下，正在安装apk..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">setDataAndType</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"application/vnd.android.package-archive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        context<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到其实是启动了一个特殊的意图,设置了data和type:<code>application/vnd.android.package-archive</code>.</p>
<p>我们可以看看<code>AndroidManifest.xml</code><br>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/" target="_blank" rel="noopener">packages</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/" target="_blank" rel="noopener">apps</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/" target="_blank" rel="noopener">PackageInstaller</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/AndroidManifest.xml" target="_blank" rel="noopener">AndroidManifest.xml</a></p>
<pre class="line-numbers language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.InstallStart<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>excludeFromRecents</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span> <span class="token attr-name"><span class="token namespace">android:</span>priority</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.VIEW<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.INSTALL_PACKAGE<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.category.DEFAULT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>scheme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>scheme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>mimeType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>application/vnd.android.package-archive<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span> <span class="token attr-name"><span class="token namespace">android:</span>priority</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.INSTALL_PACKAGE<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.category.DEFAULT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>scheme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>scheme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>package<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>scheme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span> <span class="token attr-name"><span class="token namespace">android:</span>priority</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.content.pm.action.CONFIRM_PERMISSIONS<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.category.DEFAULT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实除了通过<code>application/vnd.android.package-archive</code>能打开之外，还能通过action为<code>android.intent.action.INSTALL_PACKAGE</code>以及<code>"android.content.pm.action.CONFIRM_PERMISSIONS</code>能打开安装的Activity对象<code>InstallStart</code>。</p>
<h3 id="InstallStart-获取需要安装的包"><a href="#InstallStart-获取需要安装的包" class="headerlink" title="InstallStart 获取需要安装的包"></a>InstallStart 获取需要安装的包</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mIPackageManager <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Intent intent <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String callingPackage <span class="token operator">=</span> <span class="token function">getCallingPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// If the activity was started via a PackageInstaller session, we retrieve the calling</span>
        <span class="token comment" spellcheck="true">// package from that session</span>
        <span class="token keyword">int</span> sessionId <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_SESSION_ID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callingPackage <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> sessionId <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageInstaller packageInstaller <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            PackageInstaller<span class="token punctuation">.</span>SessionInfo sessionInfo <span class="token operator">=</span> packageInstaller<span class="token punctuation">.</span><span class="token function">getSessionInfo</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            callingPackage <span class="token operator">=</span> <span class="token punctuation">(</span>sessionInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> sessionInfo<span class="token punctuation">.</span><span class="token function">getInstallerPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> ApplicationInfo sourceInfo <span class="token operator">=</span> <span class="token function">getSourceInfo</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> originatingUid <span class="token operator">=</span> <span class="token function">getOriginatingUid</span><span class="token punctuation">(</span>sourceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isTrustedSource <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceInfo <span class="token operator">!=</span> null
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sourceInfo<span class="token punctuation">.</span>privateFlags <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isTrustedSource <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getBooleanExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_NOT_UNKNOWN_SOURCE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isTrustedSource <span class="token operator">&amp;&amp;</span> originatingUid <span class="token operator">!=</span> PackageInstaller<span class="token punctuation">.</span>SessionParams<span class="token punctuation">.</span>UID_UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> targetSdkVersion <span class="token operator">=</span> <span class="token function">getMaxTargetSdkVersionForUid</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> originatingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>targetSdkVersion <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                mAbortInstall <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>targetSdkVersion <span class="token operator">>=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>O <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">declaresAppOpPermission</span><span class="token punctuation">(</span>
                    originatingUid<span class="token punctuation">,</span> Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>REQUEST_INSTALL_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                mAbortInstall <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAbortInstall<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setResult</span><span class="token punctuation">(</span>RESULT_CANCELED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Intent nextActivity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nextActivity<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_FORWARD_RESULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        nextActivity<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageInstallerActivity<span class="token punctuation">.</span>EXTRA_CALLING_PACKAGE<span class="token punctuation">,</span> callingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nextActivity<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageInstallerActivity<span class="token punctuation">.</span>EXTRA_ORIGINAL_SOURCE_INFO<span class="token punctuation">,</span> sourceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nextActivity<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_UID<span class="token punctuation">,</span> originatingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>ACTION_CONFIRM_PERMISSIONS<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nextActivity<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PackageInstallerActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            Uri packageUri <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>packageUri <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ContentResolver<span class="token punctuation">.</span>SCHEME_FILE<span class="token punctuation">)</span>
                    <span class="token operator">||</span> packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ContentResolver<span class="token punctuation">.</span>SCHEME_CONTENT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                nextActivity<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> InstallStaging<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packageUri <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                    PackageInstallerActivity<span class="token punctuation">.</span>SCHEME_PACKAGE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nextActivity<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PackageInstallerActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                Intent result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_INSTALL_RESULT<span class="token punctuation">,</span>
                        PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_URI<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setResult</span><span class="token punctuation">(</span>RESULT_FIRST_USER<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

                nextActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">startActivity</span><span class="token punctuation">(</span>nextActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，这个过程做了如下事情：</p>
<ul>
<li>1.判断当前的apk包是否是可信任来源，如果是不可信任来源，且没有申请不可信任来源包安装权限，则会强制结束当前的Activity。</li>
<li>2.此时就会从data从获取到我们传递进来的apk包的地址uri，并且设置下一个启动的Activity为InstallStaging</li>
<li>3.启动InstallStaging 这个Activity</li>
</ul>
<p>值得注意的是：</p>
<ul>
<li>1.如果我们使用另一种安装方式，设置的是Intent的action为<code>ACTION_CONFIRM_PERMISSIONS</code>(也就是<code>android.content.pm.action.CONFIRM_PERMISSIONS</code>)，则会直接启动PackageInstallerActivity</li>
<li>1.如果此时我们的uri不是<code>file</code>和<code>content</code>开头的协议，但是是<code>package</code>协议也是直接启动PackageInstallerActivity</li>
</ul>
<h3 id="InstallStaging-包安装确认界面"><a href="#InstallStaging-包安装确认界面" class="headerlink" title="InstallStaging 包安装确认界面"></a>InstallStaging 包安装确认界面</h3><p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/packages/" target="_blank" rel="noopener">packages</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/" target="_blank" rel="noopener">apps</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/" target="_blank" rel="noopener">PackageInstaller</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/src/" target="_blank" rel="noopener">src</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/src/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/src/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/src/com/android/packageinstaller/" target="_blank" rel="noopener">packageinstaller</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallStaging.java" target="_blank" rel="noopener">InstallStaging.java</a><br>这是一个带着旋转进度条和一个取消按钮的页面，核心方法在onResume</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStagingTask <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mStagedFile <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mStagedFile <span class="token operator">=</span> TemporaryFileManager<span class="token punctuation">.</span><span class="token function">getStagedFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">showError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            mStagingTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StagingAsyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mStagingTask<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里构建了一个临时文件：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> File <span class="token function">getStagedFile</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> File<span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">,</span> <span class="token string">".apk"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getNoBackupFilesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这个文件建立在当前应用私有目录下的no_backup文件夹上。也就是<code>/data/no_backup/packagexxx.apk</code> 这个临时文件。</p>
<p>并启动StagingAsyncTask这个AysncTask任务。这个AysncTask就没必要聊了，都是老生常谈的东西了，现在都是用LoaderManager了。如果实在好奇可以阅读我很早以前写过的<a href="https://www.jianshu.com/p/b6b98520ef00" target="_blank" rel="noopener">AsyncTask与LoaderManager</a>。</p>
<h4 id="StagingAsyncTask"><a href="#StagingAsyncTask" class="headerlink" title="StagingAsyncTask"></a>StagingAsyncTask</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">StagingAsyncTask</span> <span class="token keyword">extends</span> <span class="token class-name">AsyncTask</span><span class="token operator">&lt;</span>Uri<span class="token punctuation">,</span> Void<span class="token punctuation">,</span> Boolean<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> Boolean <span class="token function">doInBackground</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">==</span> null <span class="token operator">||</span> params<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Uri packageUri <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span>InputStream in <span class="token operator">=</span> <span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openInputStream</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">(</span>OutputStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>mStagedFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> bytesRead<span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytesRead <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> SecurityException <span class="token operator">|</span> IllegalStateException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPostExecute</span><span class="token punctuation">(</span>Boolean success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Intent installIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                installIntent<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span>InstallStaging<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> DeleteStagedFileOnResult<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                installIntent<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>mStagedFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>installIntent<span class="token punctuation">.</span><span class="token function">getBooleanExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_RETURN_RESULT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    installIntent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_FORWARD_RESULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                installIntent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NO_ANIMATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">startActivity</span><span class="token punctuation">(</span>installIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>

                InstallStaging<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">showError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.doInBackground 是指在异步线程池中处理的事务。doInBackground中实际上就是把uri中需要安装的apk拷贝到临时文件中。</p>
</li>
<li><p>2.onPostExecute 当拷贝任务处理完之后，就会把当前的临时文件作为Intent的参数，跳转到DeleteStagedFileOnResult中。</p>
</li>
</ul>
<h3 id="DeleteStagedFileOnResult"><a href="#DeleteStagedFileOnResult" class="headerlink" title="DeleteStagedFileOnResult"></a>DeleteStagedFileOnResult</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeleteStagedFileOnResult</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>savedInstanceState <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Intent installIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            installIntent<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PackageInstallerActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            installIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NO_ANIMATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">startActivityForResult</span><span class="token punctuation">(</span>installIntent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onActivityResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> Intent data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        File sourceFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sourceFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setResult</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程很简单就是启动到PackageInstallerActivity中。如果PackageInstallerActivity安装失败了，就会退出PackageInstallerActivity界面在DeleteStagedFileOnResult的onActivityResult中删除这个临时文件。</p>
<h3 id="PackageInstallerActivity-安装界面"><a href="#PackageInstallerActivity-安装界面" class="headerlink" title="PackageInstallerActivity 安装界面"></a>PackageInstallerActivity 安装界面</h3><p>先来看看onCreate</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle icicle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>icicle <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAllowUnknownSources <span class="token operator">=</span> icicle<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>ALLOW_UNKNOWN_SOURCES_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mPm <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mIpm <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mAppOpsManager <span class="token operator">=</span> <span class="token punctuation">(</span>AppOpsManager<span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>APP_OPS_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInstaller <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mUserManager <span class="token operator">=</span> <span class="token punctuation">(</span>UserManager<span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>USER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> Intent intent <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mCallingPackage <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span>EXTRA_CALLING_PACKAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSourceInfo <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>EXTRA_ORIGINAL_SOURCE_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mOriginatingUid <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_UID<span class="token punctuation">,</span>
                PackageInstaller<span class="token punctuation">.</span>SessionParams<span class="token punctuation">.</span>UID_UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mOriginatingPackage <span class="token operator">=</span> <span class="token punctuation">(</span>mOriginatingUid <span class="token operator">!=</span> PackageInstaller<span class="token punctuation">.</span>SessionParams<span class="token punctuation">.</span>UID_UNKNOWN<span class="token punctuation">)</span>
                <span class="token operator">?</span> <span class="token function">getPackageNameForUid</span><span class="token punctuation">(</span>mOriginatingUid<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>


        <span class="token keyword">final</span> Uri packageUri<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>ACTION_CONFIRM_PERMISSIONS<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> sessionId <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_SESSION_ID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> PackageInstaller<span class="token punctuation">.</span>SessionInfo info <span class="token operator">=</span> mInstaller<span class="token punctuation">.</span><span class="token function">getSessionInfo</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>info <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>info<span class="token punctuation">.</span>sealed <span class="token operator">||</span> info<span class="token punctuation">.</span>resolvedBaseCodePath <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mSessionId <span class="token operator">=</span> sessionId<span class="token punctuation">;</span>
            packageUri <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>resolvedBaseCodePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOriginatingURI <span class="token operator">=</span> null<span class="token punctuation">;</span>
            mReferrerURI <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mSessionId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            packageUri <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOriginatingURI <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_URI<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mReferrerURI <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REFERRER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">boolean</span> wasSetUp <span class="token operator">=</span> <span class="token function">processPackageUri</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasSetUp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">checkIfAllowedAndInitiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.能看到如果使用<code>application/vnd.android.package-archive</code>另外两种模式进行安装，那么就会获取保存在Intent中的ApplicationInfo对象，获取其中的resolvedBaseCodePath也就是代码文件路径</p>
</li>
<li><p>2.如果是使用<code>application/vnd.android.package-archive</code> 则通过Intent的getData获取到保存在其中的临时文件。</p>
</li>
<li><p>3.processPackageUri 扫描路径对应的包</p>
</li>
<li><p>4.checkIfAllowedAndInitiateInstall 启动安装</p>
</li>
</ul>
<h4 id="processPackageUri"><a href="#processPackageUri" class="headerlink" title="processPackageUri"></a>processPackageUri</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processPackageUri</span><span class="token punctuation">(</span><span class="token keyword">final</span> Uri packageUri<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPackageURI <span class="token operator">=</span> packageUri<span class="token punctuation">;</span>

        <span class="token keyword">final</span> String scheme <span class="token operator">=</span> packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>scheme<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> SCHEME_PACKAGE<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mPkgInfo <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            PackageManager<span class="token punctuation">.</span>GET_PERMISSIONS
                                    <span class="token operator">|</span> PackageManager<span class="token punctuation">.</span>MATCH_UNINSTALLED_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPkgInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_PACKAGE_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setPmResult</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_APK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mAppSnippet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageUtil<span class="token punctuation">.</span>AppSnippet</span><span class="token punctuation">(</span>mPm<span class="token punctuation">.</span><span class="token function">getApplicationLabel</span><span class="token punctuation">(</span>mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mPm<span class="token punctuation">.</span><span class="token function">getApplicationIcon</span><span class="token punctuation">(</span>mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> ContentResolver<span class="token punctuation">.</span>SCHEME_FILE<span class="token operator">:</span> <span class="token punctuation">{</span>
                File sourceFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                PackageParser<span class="token punctuation">.</span>Package parsed <span class="token operator">=</span> PackageUtil<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sourceFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_PACKAGE_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setPmResult</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_APK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mPkgInfo <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span><span class="token function">generatePackageInfo</span><span class="token punctuation">(</span>parsed<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                        PackageManager<span class="token punctuation">.</span>GET_PERMISSIONS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">PackageUserState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAppSnippet <span class="token operator">=</span> PackageUtil<span class="token punctuation">.</span><span class="token function">getAppSnippet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> sourceFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unexpected URI scheme "</span> <span class="token operator">+</span> packageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先把uri缓存到全局的mPackageURI<br>在这个过程中，会解析两种uri：</p>
<ul>
<li>1.<code>package</code>协议开头的uri：这种uri会通过PMS的getPackageInfo通过getSchemeSpecificPart获取对应apk文件对应的PackageInfo信息</li>
<li>2.<code>file</code>协议开头的uri，则使用PMS的generatePackageInfo方法获取apk文件中的package信息</li>
</ul>
<h5 id="PackageParser-generatePackageInfo"><a href="#PackageParser-generatePackageInfo" class="headerlink" title="PackageParser generatePackageInfo"></a>PackageParser generatePackageInfo</h5><p>PMS的generatePackageInfo，最终会调用PackageParser的generatePackageInfo</p>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">public</span> <span class="token keyword">static</span> PackageInfo <span class="token function">generatePackageInfo</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package p<span class="token punctuation">,</span>
            <span class="token keyword">int</span> gids<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">long</span> firstInstallTime<span class="token punctuation">,</span> <span class="token keyword">long</span> lastUpdateTime<span class="token punctuation">,</span>
            Set<span class="token operator">&lt;</span>String<span class="token operator">></span> grantedPermissions<span class="token punctuation">,</span> PackageUserState state<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkUseInstalledOrHidden</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> state<span class="token punctuation">,</span> p<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>p<span class="token punctuation">.</span><span class="token function">isMatch</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        PackageInfo pi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>packageName <span class="token operator">=</span> p<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>splitNames <span class="token operator">=</span> p<span class="token punctuation">.</span>splitNames<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>versionCode <span class="token operator">=</span> p<span class="token punctuation">.</span>mVersionCode<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>versionCodeMajor <span class="token operator">=</span> p<span class="token punctuation">.</span>mVersionCodeMajor<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>baseRevisionCode <span class="token operator">=</span> p<span class="token punctuation">.</span>baseRevisionCode<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>splitRevisionCodes <span class="token operator">=</span> p<span class="token punctuation">.</span>splitRevisionCodes<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>versionName <span class="token operator">=</span> p<span class="token punctuation">.</span>mVersionName<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>sharedUserId <span class="token operator">=</span> p<span class="token punctuation">.</span>mSharedUserId<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>sharedUserLabel <span class="token operator">=</span> p<span class="token punctuation">.</span>mSharedUserLabel<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>applicationInfo <span class="token operator">=</span> <span class="token function">generateApplicationInfo</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> state<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>installLocation <span class="token operator">=</span> p<span class="token punctuation">.</span>installLocation<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>isStub <span class="token operator">=</span> p<span class="token punctuation">.</span>isStub<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>coreApp <span class="token operator">=</span> p<span class="token punctuation">.</span>coreApp<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                <span class="token operator">||</span> <span class="token punctuation">(</span>pi<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_UPDATED_SYSTEM_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pi<span class="token punctuation">.</span>requiredForAllUsers <span class="token operator">=</span> p<span class="token punctuation">.</span>mRequiredForAllUsers<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pi<span class="token punctuation">.</span>restrictedAccountType <span class="token operator">=</span> p<span class="token punctuation">.</span>mRestrictedAccountType<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>requiredAccountType <span class="token operator">=</span> p<span class="token punctuation">.</span>mRequiredAccountType<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>overlayTarget <span class="token operator">=</span> p<span class="token punctuation">.</span>mOverlayTarget<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>overlayCategory <span class="token operator">=</span> p<span class="token punctuation">.</span>mOverlayCategory<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>overlayPriority <span class="token operator">=</span> p<span class="token punctuation">.</span>mOverlayPriority<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>mOverlayIsStatic <span class="token operator">=</span> p<span class="token punctuation">.</span>mOverlayIsStatic<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>compileSdkVersion <span class="token operator">=</span> p<span class="token punctuation">.</span>mCompileSdkVersion<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>compileSdkVersionCodename <span class="token operator">=</span> p<span class="token punctuation">.</span>mCompileSdkVersionCodename<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>firstInstallTime <span class="token operator">=</span> firstInstallTime<span class="token punctuation">;</span>
        pi<span class="token punctuation">.</span>lastUpdateTime <span class="token operator">=</span> lastUpdateTime<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>PackageManager<span class="token punctuation">.</span>GET_GIDS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pi<span class="token punctuation">.</span>gids <span class="token operator">=</span> gids<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>PackageManager<span class="token punctuation">.</span>GET_CONFIGURATIONS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> N <span class="token operator">=</span> p<span class="token punctuation">.</span>configPreferences <span class="token operator">!=</span> null <span class="token operator">?</span> p<span class="token punctuation">.</span>configPreferences<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pi<span class="token punctuation">.</span>configPreferences <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationInfo</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>configPreferences<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>configPreferences<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            N <span class="token operator">=</span> p<span class="token punctuation">.</span>reqFeatures <span class="token operator">!=</span> null <span class="token operator">?</span> p<span class="token punctuation">.</span>reqFeatures<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pi<span class="token punctuation">.</span>reqFeatures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FeatureInfo</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>reqFeatures<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>reqFeatures<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            N <span class="token operator">=</span> p<span class="token punctuation">.</span>featureGroups <span class="token operator">!=</span> null <span class="token operator">?</span> p<span class="token punctuation">.</span>featureGroups<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pi<span class="token punctuation">.</span>featureGroups <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FeatureGroupInfo</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>featureGroups<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>featureGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>GET_ACTIVITIES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> p<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> ActivityInfo<span class="token punctuation">[</span><span class="token punctuation">]</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> Activity a <span class="token operator">=</span> p<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">isMatch</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>info<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        res<span class="token punctuation">[</span>num<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">generateActivityInfo</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> state<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                pi<span class="token punctuation">.</span>activities <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">trimToSize</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>GET_RECEIVERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> p<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> ActivityInfo<span class="token punctuation">[</span><span class="token punctuation">]</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> Activity a <span class="token operator">=</span> p<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">isMatch</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>info<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        res<span class="token punctuation">[</span>num<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">generateActivityInfo</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> state<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                pi<span class="token punctuation">.</span>receivers <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">trimToSize</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>GET_SERVICES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> p<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> ServiceInfo<span class="token punctuation">[</span><span class="token punctuation">]</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceInfo</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> Service s <span class="token operator">=</span> p<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">isMatch</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>info<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        res<span class="token punctuation">[</span>num<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">generateServiceInfo</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> state<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                pi<span class="token punctuation">.</span>services <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">trimToSize</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>GET_PROVIDERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> p<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> ProviderInfo<span class="token punctuation">[</span><span class="token punctuation">]</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProviderInfo</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> Provider pr <span class="token operator">=</span> p<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">isMatch</span><span class="token punctuation">(</span>pr<span class="token punctuation">.</span>info<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        res<span class="token punctuation">[</span>num<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">generateProviderInfo</span><span class="token punctuation">(</span>pr<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> state<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                pi<span class="token punctuation">.</span>providers <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">trimToSize</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>PackageManager<span class="token punctuation">.</span>GET_INSTRUMENTATION<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> N <span class="token operator">=</span> p<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pi<span class="token punctuation">.</span>instrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstrumentationInfo</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    pi<span class="token punctuation">.</span>instrumentation<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">generateInstrumentationInfo</span><span class="token punctuation">(</span>
                            p<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>PackageManager<span class="token punctuation">.</span>GET_PERMISSIONS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> N <span class="token operator">=</span> p<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pi<span class="token punctuation">.</span>permissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionInfo</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    pi<span class="token punctuation">.</span>permissions<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">generatePermissionInfo</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            N <span class="token operator">=</span> p<span class="token punctuation">.</span>requestedPermissions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pi<span class="token punctuation">.</span>requestedPermissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
                pi<span class="token punctuation">.</span>requestedPermissionsFlags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> String perm <span class="token operator">=</span> p<span class="token punctuation">.</span>requestedPermissions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pi<span class="token punctuation">.</span>requestedPermissions<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> perm<span class="token punctuation">;</span>
                    pi<span class="token punctuation">.</span>requestedPermissionsFlags<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">|=</span> PackageInfo<span class="token punctuation">.</span>REQUESTED_PERMISSION_REQUIRED<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>grantedPermissions <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> grantedPermissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pi<span class="token punctuation">.</span>requestedPermissionsFlags<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">|=</span> PackageInfo<span class="token punctuation">.</span>REQUESTED_PERMISSION_GRANTED<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>PackageManager<span class="token punctuation">.</span>GET_SIGNATURES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span><span class="token function">hasPastSigningCertificates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                pi<span class="token punctuation">.</span>signatures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signature</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                pi<span class="token punctuation">.</span>signatures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span>pastSigningCertificates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span><span class="token function">hasSignatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> numberOfSigs <span class="token operator">=</span> p<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span>signatures<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                pi<span class="token punctuation">.</span>signatures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signature</span><span class="token punctuation">[</span>numberOfSigs<span class="token punctuation">]</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span>signatures<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pi<span class="token punctuation">.</span>signatures<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numberOfSigs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>GET_SIGNING_CERTIFICATES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>mSigningDetails <span class="token operator">!=</span> SigningDetails<span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                pi<span class="token punctuation">.</span>signingInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SigningInfo</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                pi<span class="token punctuation">.</span>signingInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pi<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到generatePackageInfo的方法实际上只解析了四大组件的内容以及权限相关的标签。还没有上一篇文章中扫描apk做的事情齐全。不过倒是拿到了apk包所有运行需要的基础信息。</p>
<h4 id="checkIfAllowedAndInitiateInstall"><a href="#checkIfAllowedAndInitiateInstall" class="headerlink" title="checkIfAllowedAndInitiateInstall"></a>checkIfAllowedAndInitiateInstall</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkIfAllowedAndInitiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAllowUnknownSources <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isInstallRequestFromUnknownSource</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">initiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是这样一行，允许安装未知来源的文件判断，initiateInstall</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String pkgName <span class="token operator">=</span> mPkgInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> oldName <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">canonicalToCurrentPackageNames</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> pkgName <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldName <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> oldName<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> oldName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pkgName <span class="token operator">=</span> oldName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            mPkgInfo<span class="token punctuation">.</span>packageName <span class="token operator">=</span> pkgName<span class="token punctuation">;</span>
            mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName <span class="token operator">=</span> pkgName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mAppInfo <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span>
                    PackageManager<span class="token punctuation">.</span>MATCH_UNINSTALLED_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mAppInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_INSTALLED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mAppInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAppInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">startInstallConfirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过PMS的getApplicationInfo方法，获取当前Android系统中是否已经安装了当前的app，如果能找到mAppInfo对象，说明是安装了，则调用startInstallConfirm刷新按钮的内容，是<code>安装</code>还是<code>更新</code>.</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startInstallConfirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We might need to show permissions, load layout with permissions</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">bindUi</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_confirm_perm_update<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">bindUi</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_confirm_perm<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="PackageInstallerActivity-点击安装按钮"><a href="#PackageInstallerActivity-点击安装按钮" class="headerlink" title="PackageInstallerActivity 点击安装按钮"></a>PackageInstallerActivity 点击安装按钮</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> mOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mOk<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mOkCanInstall <span class="token operator">||</span> mScrollView <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mSessionId <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mInstaller<span class="token punctuation">.</span><span class="token function">setPermissionsResult</span><span class="token punctuation">(</span>mSessionId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">startInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mScrollView<span class="token punctuation">.</span><span class="token function">pageScroll</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>FOCUS_DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> mCancel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setResult</span><span class="token punctuation">(</span>RESULT_CANCELED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSessionId <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mInstaller<span class="token punctuation">.</span><span class="token function">setPermissionsResult</span><span class="token punctuation">(</span>mSessionId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程就很简单了，如果点击了安装的按钮，则调用startInstall启动安装等待界面。</p>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Intent newIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageUtil<span class="token punctuation">.</span>INTENT_ATTR_APPLICATION_INFO<span class="token punctuation">,</span>
                mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        newIntent<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>mPackageURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        newIntent<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> InstallInstalling<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String installerPackageName <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span>
                Intent<span class="token punctuation">.</span>EXTRA_INSTALLER_PACKAGE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOriginatingURI <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_URI<span class="token punctuation">,</span> mOriginatingURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mReferrerURI <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REFERRER<span class="token punctuation">,</span> mReferrerURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOriginatingUid <span class="token operator">!=</span> PackageInstaller<span class="token punctuation">.</span>SessionParams<span class="token punctuation">.</span>UID_UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_UID<span class="token punctuation">,</span> mOriginatingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>installerPackageName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_INSTALLER_PACKAGE_NAME<span class="token punctuation">,</span>
                    installerPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBooleanExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_RETURN_RESULT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_RETURN_RESULT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        newIntent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_FORWARD_RESULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">startActivity</span><span class="token punctuation">(</span>newIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这一段代码，就能看到把mPackageURI放入Intent的Data中，并且启动了InstallInstalling 这个Activity。</p>
<h3 id="InstallInstalling-安装等待界面"><a href="#InstallInstalling-安装等待界面" class="headerlink" title="InstallInstalling 安装等待界面"></a>InstallInstalling 安装等待界面</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/packages/" target="_blank" rel="noopener">packages</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/" target="_blank" rel="noopener">apps</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/" target="_blank" rel="noopener">PackageInstaller</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/src/" target="_blank" rel="noopener">src</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/src/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/src/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/src/com/android/packageinstaller/" target="_blank" rel="noopener">packageinstaller</a>/<a href="http://androidxref.com/9.0.0_r3/xref/packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallInstalling.java" target="_blank" rel="noopener">InstallInstalling.java</a></p>
<p>先来看看InstallInstalling的onCreate方法</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_installing<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ApplicationInfo appInfo <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>PackageUtil<span class="token punctuation">.</span>INTENT_ATTR_APPLICATION_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPackageURI <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mPackageURI<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">installExistingPackage</span><span class="token punctuation">(</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">launchSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManager<span class="token punctuation">.</span>NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">launchFailure</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INTERNAL_ERROR<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> File sourceFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mPackageURI<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            PackageUtil<span class="token punctuation">.</span><span class="token function">initSnippetForNewApp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PackageUtil<span class="token punctuation">.</span><span class="token function">getAppSnippet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span>
                    sourceFile<span class="token punctuation">)</span><span class="token punctuation">,</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>app_snippet<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>savedInstanceState <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                PackageInstaller<span class="token punctuation">.</span>SessionParams params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInstaller<span class="token punctuation">.</span>SessionParams</span><span class="token punctuation">(</span>
                        PackageInstaller<span class="token punctuation">.</span>SessionParams<span class="token punctuation">.</span>MODE_FULL_INSTALL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                params<span class="token punctuation">.</span>installFlags <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_FULL_APP<span class="token punctuation">;</span>
                params<span class="token punctuation">.</span>referrerUri <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REFERRER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                params<span class="token punctuation">.</span>originatingUri <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_URI<span class="token punctuation">)</span><span class="token punctuation">;</span>
                params<span class="token punctuation">.</span>originatingUid <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_UID<span class="token punctuation">,</span>
                        UID_UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                params<span class="token punctuation">.</span>installerPackageName <span class="token operator">=</span>
                        <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_INSTALLER_PACKAGE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

                File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mPackageURI<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    PackageParser<span class="token punctuation">.</span>PackageLite pkg <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span><span class="token function">parsePackageLite</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    params<span class="token punctuation">.</span><span class="token function">setAppPackageName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    params<span class="token punctuation">.</span><span class="token function">setInstallLocation</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>installLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    params<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span>
                            PackageHelper<span class="token punctuation">.</span><span class="token function">calculateInstalledSize</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>abiOverride<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParser<span class="token punctuation">.</span>PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    params<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    params<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mInstallId <span class="token operator">=</span> InstallEventReceiver
                            <span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> EventResultPersister<span class="token punctuation">.</span>GENERATE_NEW_ID<span class="token punctuation">,</span>
                                    <span class="token keyword">this</span><span class="token operator">:</span><span class="token operator">:</span>launchFinishBasedOnResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EventResultPersister<span class="token punctuation">.</span>OutOfIdsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">launchFailure</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INTERNAL_ERROR<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mSessionId <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">launchFailure</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INTERNAL_ERROR<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mSessionCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstallSessionCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程分为两种：</p>
<ul>
<li><p>1.如果是<code>package</code>协议，则调用PMS的installExistingPackage方法，并且调用launchSuccess，告诉用户这个apk已经安装成功了</p>
</li>
<li><p>2.剩下只可能是<code>file</code>协议，则获取PackageUri对应的临时文件，先通过PackageParser.parsePackageLite 解析出Package包的中apk的AndroidManifest的versionCode，安装路径等包含一个apk包中基础数据的PackageLite。</p>
</li>
<li><p>3.注册InstallEventReceiver 一个安装完成的广播监听。</p>
</li>
<li><p>4.调用PMS的getPackageInstaller.createSession 创建一个Session，并获得对应的sessionID。</p>
</li>
</ul>
<p>核心的后面的2两点，我们依次看看都做了什么</p>
<h4 id="InstallEventReceiver-addObserver"><a href="#InstallEventReceiver-addObserver" class="headerlink" title="InstallEventReceiver.addObserver"></a>InstallEventReceiver.addObserver</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstallEventReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Object sLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> EventResultPersister sReceiver<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">private</span> <span class="token keyword">static</span> EventResultPersister <span class="token function">getReceiver</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sReceiver <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventResultPersister</span><span class="token punctuation">(</span>
                        TemporaryFileManager<span class="token punctuation">.</span><span class="token function">getInstallStateFile</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> sReceiver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getReceiver</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onEventReceived</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> EventResultPersister<span class="token punctuation">.</span>EventResultObserver observer<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> EventResultPersister<span class="token punctuation">.</span>OutOfIdsException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getReceiver</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个类很简答，实际上就是实例化一个静态EventResultPersister对象后，并且调用EventResultPersister的addObserver，把监听事件注册到里面。注意InstallEventReceiver接受的广播是<code>com.android.packageinstaller.ACTION_INSTALL_COMMIT</code></p>
<h5 id="EventResultPersister-实例化"><a href="#EventResultPersister-实例化" class="headerlink" title="EventResultPersister  实例化"></a>EventResultPersister  实例化</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token function">EventResultPersister</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> File resultFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mResultsFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicFile</span><span class="token punctuation">(</span>resultFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCounter <span class="token operator">=</span> GENERATE_NEW_ID <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">(</span>FileInputStream stream <span class="token operator">=</span> mResultsFile<span class="token punctuation">.</span><span class="token function">openRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            XmlPullParser parser <span class="token operator">=</span> Xml<span class="token punctuation">.</span><span class="token function">newPullParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parser<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">nextElement</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String tagName <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"results"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mCounter <span class="token operator">=</span> <span class="token function">readIntAttribute</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token string">"counter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token function">readIntAttribute</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token function">readIntAttribute</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> legacyStatus <span class="token operator">=</span> <span class="token function">readIntAttribute</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token string">"legacyStatus"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    String statusMessage <span class="token operator">=</span> <span class="token function">readStringAttribute</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token string">"statusMessage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    mResults<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EventResult</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> legacyStatus<span class="token punctuation">,</span> statusMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"unexpected tag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token function">nextElement</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mResults<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">writeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程也很简单，就是读取<code>no_backup</code>文件夹下的<code>install_results.xml</code>xml文件</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> File <span class="token function">getInstallStateFile</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getNoBackupFilesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"install_results.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>install_results.xml</code>实际上可以获取到Android每一次安装后记录，每新增一个apk的安装都会递增id。并且该id就对应上不同安装的结果，如<code>status</code>,<code>legacyStatus</code>,<code>statusMessage</code>都会记录在这个文件中。</p>
<p>当安装完后，分发的消息就会同步到这个文件中，这样就能保证需要分发的安装完成的事件可以保证分发出去。</p>
<h5 id="EventResultPersister-addObserver"><a href="#EventResultPersister-addObserver" class="headerlink" title="EventResultPersister addObserver"></a>EventResultPersister addObserver</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">int</span> <span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> EventResultObserver observer<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> OutOfIdsException <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> resultIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> GENERATE_NEW_ID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                id <span class="token operator">=</span> <span class="token function">getNewId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                resultIndex <span class="token operator">=</span> mResults<span class="token punctuation">.</span><span class="token function">indexOfKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Check if we can instantly call back</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resultIndex <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                EventResult result <span class="token operator">=</span> mResults<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>resultIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

                observer<span class="token punctuation">.</span><span class="token function">onResult</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>status<span class="token punctuation">,</span> result<span class="token punctuation">.</span>legacyStatus<span class="token punctuation">,</span> result<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mResults<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>resultIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">writeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mObservers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>此时的id是GENERATE_NEW_ID，因此会通过getNewId对应的id会从0依次递增，并且把EventResultObserver记录id和observer，等到后面安装完成后，在通过id获取observer回调到外面的Activity。</p>
</li>
<li><p>如果id不为GENERATE_NEW_ID，则尝试从mResults中获取，如果能找到，说明需要告诉监听者这个apk已经安装好了，则回调EventResultObserver的onResult方法。</p>
</li>
</ul>
<h4 id="ContextImpl-getPackageManager-获取ApplicationPackageManager"><a href="#ContextImpl-getPackageManager-获取ApplicationPackageManager" class="headerlink" title="ContextImpl getPackageManager 获取ApplicationPackageManager"></a>ContextImpl getPackageManager 获取ApplicationPackageManager</h4><p>在继续聊getPackageInstaller之前，先来看看getPackageManager在App进程端实际上访问的是哪个对象？</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> PackageManager <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageManager <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mPackageManager<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        IPackageManager pm <span class="token operator">=</span> ActivityThread<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>mPackageManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationPackageManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上App进程是不会直接访问PMS的，而是通过一层ApplicationPackageManager对PMS进行方法。</p>
<h4 id="ApplicationPackageManager-getPackageInstaller"><a href="#ApplicationPackageManager-getPackageInstaller" class="headerlink" title="ApplicationPackageManager getPackageInstaller"></a>ApplicationPackageManager getPackageInstaller</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> PackageInstaller <span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstaller <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mInstaller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInstaller</span><span class="token punctuation">(</span>mPM<span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            mContext<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mContext<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> mInstaller<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里实际上拿的是PMS的Binder方法，通过getPackageInstaller获取到PackageInstallerService后，再包装到PackageInstaller。App进程正是通过PackageInstaller进一步的访问SystemServer端的PackageInstallerService对象。</p>
<h4 id="PMS的getPackageInstaller-createSession"><a href="#PMS的getPackageInstaller-createSession" class="headerlink" title="PMS的getPackageInstaller.createSession"></a>PMS的getPackageInstaller.createSession</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/" target="_blank" rel="noopener">pm</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java" target="_blank" rel="noopener">PackageManagerService.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> IPackageInstaller <span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getInstantAppPackageName</span><span class="token punctuation">(</span>Binder<span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mInstallerService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上是获取了mInstallerService，而这个Service在上一篇文章和大家聊过了但是并没有重点聊，实际上就是PackageInstallerService对象。</p>
<h4 id="PackageInstallerService的初始化"><a href="#PackageInstallerService的初始化" class="headerlink" title="PackageInstallerService的初始化"></a>PackageInstallerService的初始化</h4><pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">public</span> <span class="token function">PackageInstallerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> PackageManagerService pm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
        mPm <span class="token operator">=</span> pm<span class="token punctuation">;</span>
        mPermissionManager <span class="token operator">=</span> LocalServices<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>PermissionManagerInternal<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mInstallThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HandlerThread</span><span class="token punctuation">(</span>TAG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInstallThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mInstallHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>mInstallThread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mCallbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Callbacks</span><span class="token punctuation">(</span>mInstallThread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mSessionsFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicFile</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getDataSystemDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"install_sessions.xml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"package-session"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSessionsDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getDataSystemDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"install_sessions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSessionsDir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mAppOps <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>AppOpsManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">readSessionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">reconcileStagesLocked</span><span class="token punctuation">(</span>StorageManager<span class="token punctuation">.</span>UUID_PRIVATE_INTERNAL<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*isInstant*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reconcileStagesLocked</span><span class="token punctuation">(</span>StorageManager<span class="token punctuation">.</span>UUID_PRIVATE_INTERNAL<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*isInstant*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> ArraySet<span class="token operator">&lt;</span>File<span class="token operator">></span> unclaimedIcons <span class="token operator">=</span> <span class="token function">newArraySet</span><span class="token punctuation">(</span>
                    mSessionsDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mSessions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> PackageInstallerSession session <span class="token operator">=</span> mSessions<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                unclaimedIcons<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token function">buildAppIconFile</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>File icon <span class="token operator">:</span> unclaimedIcons<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                icon<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.在构造函数中，先初始化了如下2个文件：</li>
<li><code>/data/system/install_sessions.xml</code></li>
<li><code>/data/system/install_sessions/</code> 目录</li>
</ul>
<p>其次就是PMS的systemReady会调用PackageInstallerService的systemReady。</p>
<ul>
<li><p>2.调用readSessionsLocked方法，读取缓存在xml中的数据，并且依据这些数据生成PackageInstallerSession对象</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readSessionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      mSessions<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      FileInputStream fis <span class="token operator">=</span> null<span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          fis <span class="token operator">=</span> mSessionsFile<span class="token punctuation">.</span><span class="token function">openRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">final</span> XmlPullParser in <span class="token operator">=</span> Xml<span class="token punctuation">.</span><span class="token function">newPullParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          in<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>fis<span class="token punctuation">,</span> StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">int</span> type<span class="token punctuation">;</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> END_DOCUMENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> START_TAG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">final</span> String tag <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageInstallerSession<span class="token punctuation">.</span>TAG_SESSION<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword">final</span> PackageInstallerSession session<span class="token punctuation">;</span>
                      <span class="token keyword">try</span> <span class="token punctuation">{</span>
                          session <span class="token operator">=</span> PackageInstallerSession<span class="token punctuation">.</span><span class="token function">readFromXml</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> mInternalCallback<span class="token punctuation">,</span>
                                  mContext<span class="token punctuation">,</span> mPm<span class="token punctuation">,</span> mInstallThread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mSessionsDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          <span class="token keyword">continue</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span>

                      <span class="token keyword">final</span> <span class="token keyword">long</span> age <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> session<span class="token punctuation">.</span>createdMillis<span class="token punctuation">;</span>

                      <span class="token keyword">final</span> <span class="token keyword">boolean</span> valid<span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>age <span class="token operator">>=</span> MAX_AGE_MILLIS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                          valid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span>

                      <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          mSessions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                          <span class="token function">addHistoricalSessionLocked</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span>
                      mAllocatedSessions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// Missing sessions are okay, probably first boot</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> XmlPullParserException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Slog<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed reading install sessions"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>fis<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程通过解析xml的数据后，就能通过这些数据生成一个个PackageInstallerSession对象，如果还有效则保存在mSessions。接着不管是否有效都会保存在mAllocatedSessions，告诉Android系统已经实例化了这么多的Seesion对象。</p>
</li>
<li><p>3.reconcileStagesLocked 清除安装阶段性的临时文件</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reconcileStagesLocked</span><span class="token punctuation">(</span>String volumeUuid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isEphemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> File stagingDir <span class="token operator">=</span> <span class="token function">buildStagingDir</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">,</span> isEphemeral<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> ArraySet<span class="token operator">&lt;</span>File<span class="token operator">></span> unclaimedStages <span class="token operator">=</span> <span class="token function">newArraySet</span><span class="token punctuation">(</span>
              stagingDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span>sStageFilter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mSessions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">final</span> PackageInstallerSession session <span class="token operator">=</span> mSessions<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          unclaimedStages<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>stageDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span>File stage <span class="token operator">:</span> unclaimedStages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPm<span class="token punctuation">.</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              mPm<span class="token punctuation">.</span><span class="token function">removeCodePathLI</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> FilenameFilter sStageFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilenameFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">accept</span><span class="token punctuation">(</span>File dir<span class="token punctuation">,</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">isStageName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isStageName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> <span class="token keyword">boolean</span> isFile <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"vmdl"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">boolean</span> isContainer <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"smdl"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">boolean</span> isLegacyContainer <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"smdl2tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> isFile <span class="token operator">||</span> isContainer <span class="token operator">||</span> isLegacyContainer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> File <span class="token function">buildStagingDir</span><span class="token punctuation">(</span>String volumeUuid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isEphemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Environment<span class="token punctuation">.</span><span class="token function">getDataAppDirectory</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>实际上在volumeUuid对应的参数就是<code>StorageManager.UUID_PRIVATE_INTERNAL</code>而他是一个为null的static final的成员变量。因此实际上就是构建了一个<code>/data/app</code>的目录。</p>
</li>
<li><p>拿到该目录下所有的数据临时数据，这些临时数据一般为(<code>vmdlxx.tmp</code>,<code>smdlxxx.tmp</code>,<code>smdl2tmpxxx</code>)，从这个集合中挑选出没有session对应的临时文件并删除。</p>
</li>
<li><p>遍历这些临时数据，调用PMS的removeCodePathLI，移除缓存在PMS这些临时文件对应的扫描结果</p>
</li>
<li><p>4.遍历<code>/data/system/install_sessions/</code>中所有的文件，并且从unclaimedIcons集合移除每一个Session对象的<code>app_icon.sessionId.png</code>也就是临时的安装应用图标，最后删除剩下哪些没有sessionId对应的临时应用图标文件。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> File <span class="token function">buildAppIconFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> sessionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSessionsDir<span class="token punctuation">,</span> <span class="token string">"app_icon."</span> <span class="token operator">+</span> sessionId <span class="token operator">+</span> <span class="token string">".png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h4 id="PackageInstaller-createSession"><a href="#PackageInstaller-createSession" class="headerlink" title="PackageInstaller createSession"></a>PackageInstaller createSession</h4><p>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/" target="_blank" rel="noopener">content</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/pm/" target="_blank" rel="noopener">pm</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/content/pm/PackageInstaller.java" target="_blank" rel="noopener">PackageInstaller.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">createSession</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> SessionParams params<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> String installerPackage<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>installerPackageName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                installerPackage <span class="token operator">=</span> mInstallerPackageName<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                installerPackage <span class="token operator">=</span> params<span class="token punctuation">.</span>installerPackageName<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> mInstaller<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> installerPackage<span class="token punctuation">,</span> mUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ExceptionUtils<span class="token punctuation">.</span><span class="token function">maybeUnwrapIOException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程很简单，就是调用了PackageInstallerService的createSession，而这个方法最终会调用到createSessionInternal中</p>
<h5 id="PackageInstallerService-createSessionInternal"><a href="#PackageInstallerService-createSessionInternal" class="headerlink" title="PackageInstallerService createSessionInternal"></a>PackageInstallerService createSessionInternal</h5><pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">createSessionInternal</span><span class="token punctuation">(</span>SessionParams params<span class="token punctuation">,</span> String installerPackageName<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>callingUid <span class="token operator">==</span> Process<span class="token punctuation">.</span>SHELL_UID<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>callingUid <span class="token operator">==</span> Process<span class="token punctuation">.</span>ROOT_UID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            params<span class="token punctuation">.</span>installFlags <span class="token operator">|=</span> PackageManager<span class="token punctuation">.</span>INSTALL_FROM_ADB<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">checkCallingOrSelfPermission</span><span class="token punctuation">(</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>INSTALL_PACKAGES<span class="token punctuation">)</span> <span class="token operator">!=</span>
                    PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mAppOps<span class="token punctuation">.</span><span class="token function">checkPackage</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            params<span class="token punctuation">.</span>installFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>PackageManager<span class="token punctuation">.</span>INSTALL_FROM_ADB<span class="token punctuation">;</span>
            params<span class="token punctuation">.</span>installFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>PackageManager<span class="token punctuation">.</span>INSTALL_ALL_USERS<span class="token punctuation">;</span>
            params<span class="token punctuation">.</span>installFlags <span class="token operator">|=</span> PackageManager<span class="token punctuation">.</span>INSTALL_REPLACE_EXISTING<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_VIRTUAL_PRELOAD<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mPm<span class="token punctuation">.</span><span class="token function">isCallerVerifier</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                params<span class="token punctuation">.</span>installFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>PackageManager<span class="token punctuation">.</span>INSTALL_VIRTUAL_PRELOAD<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">// Defensively resize giant app icons</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>appIcon <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ActivityManager am <span class="token operator">=</span> <span class="token punctuation">(</span>ActivityManager<span class="token punctuation">)</span> mContext<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>
                    Context<span class="token punctuation">.</span>ACTIVITY_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> iconSize <span class="token operator">=</span> am<span class="token punctuation">.</span><span class="token function">getLauncherLargeIconSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>appIcon<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> iconSize <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>appIcon<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> iconSize <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                params<span class="token punctuation">.</span>appIcon <span class="token operator">=</span> Bitmap<span class="token punctuation">.</span><span class="token function">createScaledBitmap</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>appIcon<span class="token punctuation">,</span> iconSize<span class="token punctuation">,</span> iconSize<span class="token punctuation">,</span>
                        <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_INTERNAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_EXTERNAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_FORCE_VOLUME_UUID<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            params<span class="token punctuation">.</span><span class="token function">setInstallFlagsInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">long</span> ident <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                params<span class="token punctuation">.</span>volumeUuid <span class="token operator">=</span> PackageHelper<span class="token punctuation">.</span><span class="token function">resolveInstallVolume</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> sessionId<span class="token punctuation">;</span>
        <span class="token keyword">final</span> PackageInstallerSession session<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> activeCount <span class="token operator">=</span> <span class="token function">getSessionCount</span><span class="token punctuation">(</span>mSessions<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> historicalCount <span class="token operator">=</span> mHistoricalSessionsByInstaller<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            sessionId <span class="token operator">=</span> <span class="token function">allocateSessionIdLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">long</span> createdMillis <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// We're staging to exactly one location</span>
        File stageDir <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String stageCid <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_INTERNAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> isInstant <span class="token operator">=</span>
                    <span class="token punctuation">(</span>params<span class="token punctuation">.</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            stageDir <span class="token operator">=</span> <span class="token function">buildStageDir</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>volumeUuid<span class="token punctuation">,</span> sessionId<span class="token punctuation">,</span> isInstant<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            stageCid <span class="token operator">=</span> <span class="token function">buildExternalStageCid</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        session <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInstallerSession</span><span class="token punctuation">(</span>mInternalCallback<span class="token punctuation">,</span> mContext<span class="token punctuation">,</span> mPm<span class="token punctuation">,</span>
                mInstallThread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sessionId<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                params<span class="token punctuation">,</span> createdMillis<span class="token punctuation">,</span> stageDir<span class="token punctuation">,</span> stageCid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSessions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mCallbacks<span class="token punctuation">.</span><span class="token function">notifySessionCreated</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> session<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">writeSessionsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sessionId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.从ActivityManager 获取全局配置下，当前配置下的dp数值以及图标大小，从而计算出应用图标对应的bitmap大小，并提前申请出内存出来.</p>
</li>
<li><p>2.PackageHelper.resolveInstallVolume 拿到磁盘中最合适安装的扇区的uuid，保存到SessionParams的volumeUuid中。setInstallFlagsInternal设置installFlags带上INSTALL_INTERNAL</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setInstallFlagsInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        installFlags <span class="token operator">|=</span> PackageManager<span class="token punctuation">.</span>INSTALL_INTERNAL<span class="token punctuation">;</span>
        installFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>PackageManager<span class="token punctuation">.</span>INSTALL_EXTERNAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>3.从Int的最大数值内挑选一个没有使用过的随机数，成为新的PackageInstallerSession的id。</p>
</li>
<li><p>4.如果PackageManager.INSTALL_INTERNAL不为空，则会通过buildStageDir方法生成一个特殊文件：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> File <span class="token function">buildStageDir</span><span class="token punctuation">(</span>String volumeUuid<span class="token punctuation">,</span> <span class="token keyword">int</span> sessionId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isEphemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> File stagingDir <span class="token operator">=</span> <span class="token function">buildStagingDir</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">,</span> isEphemeral<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>stagingDir<span class="token punctuation">,</span> <span class="token string">"vmdl"</span> <span class="token operator">+</span> sessionId <span class="token operator">+</span> <span class="token string">".tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> File <span class="token function">buildStagingDir</span><span class="token punctuation">(</span>String volumeUuid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isEphemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Environment<span class="token punctuation">.</span><span class="token function">getDataAppDirectory</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> File <span class="token function">getDataAppDirectory</span><span class="token punctuation">(</span>String volumeUuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token function">getDataDirectory</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> File <span class="token function">getDataDirectory</span><span class="token punctuation">(</span>String volumeUuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> DIR_ANDROID_DATA<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"/mnt/expand/"</span> <span class="token operator">+</span> volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当不传入需要安装的扇区uuid时候则为<code>/data/app/vmdlsessionId.tmp</code>文件，但是如果传入了，整个文件就变成了<code>/data/app/volumeUuid/vmdlsessionId.tmp</code></p>
</li>
</ul>
<p>注意此时如果能在私有磁盘(也就是内置存储器)内找到剩余空间进行安装<code>/data/app/vmdlsessionId.tmp</code>，如果找不到则安装到<code>/mnt/expand/volumeUuid/vmdlsessionId.tmp</code>(也就是类似U盘的外部存储器)</p>
<ul>
<li><p>5.否则则生成一个新的名字<code>smdlsessionid.tmp</code>名字保存到PackageInstallerSession中。</p>
</li>
<li><p>6.生成一个PackageInstallerSession对象，并保存到mSessions这个Map中，唤醒监听者notifySessionCreated的Session创建成功的监听</p>
</li>
<li><p>7.writeSessionsAsync 通过IO线程，调用PackageInstallerSession的write方法，把数据全部写入到PackageInstallerSession的</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeSessionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FileOutputStream fos <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        fos <span class="token operator">=</span> mSessionsFile<span class="token punctuation">.</span><span class="token function">startWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        XmlSerializer out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FastXmlSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">setOutput</span><span class="token punctuation">(</span>fos<span class="token punctuation">,</span> StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">startDocument</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">startTag</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> TAG_SESSIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> mSessions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PackageInstallerSession session <span class="token operator">=</span> mSessions<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> mSessionsDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        out<span class="token punctuation">.</span><span class="token function">endTag</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> TAG_SESSIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">endDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mSessionsFile<span class="token punctuation">.</span><span class="token function">finishWrite</span><span class="token punctuation">(</span>fos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fos <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSessionsFile<span class="token punctuation">.</span><span class="token function">failWrite</span><span class="token punctuation">(</span>fos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实这个过程就很简单了，就是往<code>/data/system/install_sessions.xml</code>中写入当前PackageInstallerSession的配置数据。</p>
</li>
</ul>
<h4 id="InstallInstalling-onResume"><a href="#InstallInstalling-onResume" class="headerlink" title="InstallInstalling onResume"></a>InstallInstalling onResume</h4><p>onCreate考察完了，我们来看看onResume.</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstallingTask <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageInstaller installer <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            PackageInstaller<span class="token punctuation">.</span>SessionInfo sessionInfo <span class="token operator">=</span> installer<span class="token punctuation">.</span><span class="token function">getSessionInfo</span><span class="token punctuation">(</span>mSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionInfo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sessionInfo<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mInstallingTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstallingAsyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mInstallingTask<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// we will receive a broadcast when the install is finished</span>
                mCancelButton<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setFinishOnTouchOutside</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在onCreate的过程通过PackageInstallerService的CreateSession方法获取到每一个Session对应的id，此时通过id反过来找到每一个SessionInfo，并开始执行这个InstallingAsyncTask这个AsyncTask。</p>
<h4 id="InstallingAsyncTask的异步执行"><a href="#InstallingAsyncTask的异步执行" class="headerlink" title="InstallingAsyncTask的异步执行"></a>InstallingAsyncTask的异步执行</h4><pre class="line-numbers language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> PackageInstaller<span class="token punctuation">.</span>Session <span class="token function">doInBackground</span><span class="token punctuation">(</span>Void<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageInstaller<span class="token punctuation">.</span>Session session<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                session <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span>mSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            session<span class="token punctuation">.</span><span class="token function">setStagingProgress</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mPackageURI<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">(</span>InputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> sizeBytes <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">(</span>OutputStream out <span class="token operator">=</span> session
                            <span class="token punctuation">.</span><span class="token function">openWrite</span><span class="token punctuation">(</span><span class="token string">"PackageInstaller"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sizeBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">int</span> numRead <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span>numRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                session<span class="token punctuation">.</span><span class="token function">fsync</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>sizeBytes <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">float</span> fraction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> numRead <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> sizeBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                session<span class="token punctuation">.</span><span class="token function">addProgress</span><span class="token punctuation">(</span>fraction<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> session<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> SecurityException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    isDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上，InstallingAsyncTask的异步线程的工作就是在通过PackageInstallerService.openSession方法打开一个session，并通过FileInputStream读取临时apk文件的数据流，并通过session.openWrite ，把临时apk数据往session的OutputSream中写入。</p>
<p>依次看看openSession和openWrite都做了什么？</p>
<h5 id="PackageInstaller-openSession"><a href="#PackageInstaller-openSession" class="headerlink" title="PackageInstaller openSession"></a>PackageInstaller openSession</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token annotation punctuation">@NonNull</span> Session <span class="token function">openSession</span><span class="token punctuation">(</span><span class="token keyword">int</span> sessionId<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Session</span><span class="token punctuation">(</span>mInstaller<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ExceptionUtils<span class="token punctuation">.</span><span class="token function">maybeUnwrapIOException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，调用了PackageInstallerService的openSession，获得IPackageInstallerSession这个Binder对象，并且包装成一个Session对象返回。</p>
<h5 id="PackageInstallerService-openSession"><a href="#PackageInstallerService-openSession" class="headerlink" title="PackageInstallerService openSession"></a>PackageInstallerService openSession</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> IPackageInstallerSession <span class="token function">openSessionInternal</span><span class="token punctuation">(</span><span class="token keyword">int</span> sessionId<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PackageInstallerSession session <span class="token operator">=</span> mSessions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            session<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> session<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心还是PacakgeInstallerSession的open方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mActiveCount<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCallback<span class="token punctuation">.</span><span class="token function">onSessionActiveChanged</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> wasPrepared<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            wasPrepared <span class="token operator">=</span> mPrepared<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPrepared<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stageDir <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">prepareStageDir</span><span class="token punctuation">(</span>stageDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"stageDir must be set"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                mPrepared <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasPrepared<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCallback<span class="token punctuation">.</span><span class="token function">onSessionPrepared</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepareStageDir</span><span class="token punctuation">(</span>File stageDir<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Os<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>stageDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Os<span class="token punctuation">.</span><span class="token function">chmod</span><span class="token punctuation">(</span>stageDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Failed to prepare session dir: "</span> <span class="token operator">+</span> stageDir<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SELinux<span class="token punctuation">.</span><span class="token function">restorecon</span><span class="token punctuation">(</span>stageDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Failed to restorecon session dir: "</span> <span class="token operator">+</span> stageDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里实际上就是给安装的目录做了准备的工作，把<code>/mnt/expand/volumeUuid/vmdlsessionId.tmp</code>这个文件设置权限为0755,也就是当前用户允许操作所有权限，同用户组或者其他用户的权限只能读执行。</p>
<h5 id="PackageInstaller-Session-openWrite"><a href="#PackageInstaller-Session-openWrite" class="headerlink" title="PackageInstaller.Session openWrite"></a>PackageInstaller.Session openWrite</h5><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token annotation punctuation">@NonNull</span> OutputStream <span class="token function">openWrite</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> String name<span class="token punctuation">,</span> <span class="token keyword">long</span> offsetBytes<span class="token punctuation">,</span>
                <span class="token keyword">long</span> lengthBytes<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ENABLE_REVOCABLE_FD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ParcelFileDescriptor<span class="token punctuation">.</span>AutoCloseOutputStream</span><span class="token punctuation">(</span>
                            mSession<span class="token punctuation">.</span><span class="token function">openWrite</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> offsetBytes<span class="token punctuation">,</span> lengthBytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> ParcelFileDescriptor clientSocket <span class="token operator">=</span> mSession<span class="token punctuation">.</span><span class="token function">openWrite</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>
                            offsetBytes<span class="token punctuation">,</span> lengthBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileBridge<span class="token punctuation">.</span>FileBridgeOutputStream</span><span class="token punctuation">(</span>clientSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ExceptionUtils<span class="token punctuation">.</span><span class="token function">maybeUnwrapIOException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心还是调用PackageInstallerSession的openWrite后，获取到ParcelFileDescriptor对象通过ParcelFileDescriptor.AutoCloseOutputStream或者FileBridge.FileBridgeOutputStream封装成OutputStream。</p>
<p>而PackageInstallerSession的openWrite核心会调用到doWriteInternal。这里我们先只关注ENABLE_REVOCABLE_FD为false的情况。</p>
<h5 id="PackageInstallerSession-doWriteInternal"><a href="#PackageInstallerSession-doWriteInternal" class="headerlink" title="PackageInstallerSession doWriteInternal"></a>PackageInstallerSession doWriteInternal</h5><pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">private</span> ParcelFileDescriptor <span class="token function">doWriteInternal</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">long</span> offsetBytes<span class="token punctuation">,</span> <span class="token keyword">long</span> lengthBytes<span class="token punctuation">,</span>
            ParcelFileDescriptor incomingFd<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>

        <span class="token keyword">final</span> RevocableFileDescriptor fd<span class="token punctuation">;</span>
        <span class="token keyword">final</span> FileBridge bridge<span class="token punctuation">;</span>
        <span class="token keyword">final</span> File stageDir<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertCallerIsOwnerOrRootLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertPreparedAndNotSealedLocked</span><span class="token punctuation">(</span><span class="token string">"openWrite"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>ENABLE_REVOCABLE_FD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RevocableFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                bridge <span class="token operator">=</span> null<span class="token punctuation">;</span>
                mFds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                fd <span class="token operator">=</span> null<span class="token punctuation">;</span>
                bridge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mBridges<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bridge<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            stageDir <span class="token operator">=</span> <span class="token function">resolveStageDirLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>FileUtils<span class="token punctuation">.</span><span class="token function">isValidExtFilename</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Invalid name: "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> File target<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> identity <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>stageDir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> FileDescriptor targetFd <span class="token operator">=</span> Os<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    O_CREAT <span class="token operator">|</span> O_WRONLY<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Os<span class="token punctuation">.</span><span class="token function">chmod</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>offsetBytes <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Os<span class="token punctuation">.</span><span class="token function">lseek</span><span class="token punctuation">(</span>targetFd<span class="token punctuation">,</span> offsetBytes<span class="token punctuation">,</span> OsConstants<span class="token punctuation">.</span>SEEK_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>incomingFd <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>ENABLE_REVOCABLE_FD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                bridge<span class="token punctuation">.</span><span class="token function">setTargetFile</span><span class="token punctuation">(</span>targetFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                bridge<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ParcelFileDescriptor</span><span class="token punctuation">(</span>bridge<span class="token punctuation">.</span><span class="token function">getClientSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowAsIOException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.就是根据stageDir目录下生成一个特殊的文件，其实就是<br><code>/data/app/vmdlsessionId.tmp/PackageInstaller</code>.并调用Os.open创建这个文件，这个文件的权限是0644，也就是本用户能读写，其他和同一个用户组只能读。</p>
</li>
<li><p>2.创建一个新的FileBridge对象，把需要写入的对象设置到FileBridge中，并调用start方法，最后获取FileBridge的getClientSocket，设置到ParcelFileDescriptor。</p>
</li>
</ul>
<h5 id="FileBridge-原理"><a href="#FileBridge-原理" class="headerlink" title="FileBridge 原理"></a>FileBridge 原理</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileBridge</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"FileBridge"</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// TODO: consider extending to support bidirectional IO</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MSG_LENGTH <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** CMD_WRITE [len] [data] */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CMD_WRITE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/** CMD_FSYNC */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CMD_FSYNC <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/** CMD_CLOSE */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CMD_CLOSE <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> FileDescriptor mTarget<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> FileDescriptor mServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> FileDescriptor mClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> mClosed<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">FileBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Os<span class="token punctuation">.</span><span class="token function">socketpair</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mServer<span class="token punctuation">,</span> mClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mClosed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">forceClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>mTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
        IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>mServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>mClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mClosed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTargetFile</span><span class="token punctuation">(</span>FileDescriptor target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mTarget <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> FileDescriptor <span class="token function">getClientSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>IoBridge<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>mServer<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MSG_LENGTH<span class="token punctuation">)</span> <span class="token operator">==</span> MSG_LENGTH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> cmd <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">peekInt</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ByteOrder<span class="token punctuation">.</span>BIG_ENDIAN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> CMD_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Shuttle data into local file</span>
                    <span class="token keyword">int</span> len <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">peekInt</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> ByteOrder<span class="token punctuation">.</span>BIG_ENDIAN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>len <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> n <span class="token operator">=</span> IoBridge<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>mServer<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>length<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        IoBridge<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>mTarget<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        len <span class="token operator">-=</span> n<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> CMD_FSYNC<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Os<span class="token punctuation">.</span><span class="token function">fsync</span><span class="token punctuation">(</span>mTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    IoBridge<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>mServer<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MSG_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> CMD_CLOSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Os<span class="token punctuation">.</span><span class="token function">fsync</span><span class="token punctuation">(</span>mTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Os<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>mTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mClosed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    IoBridge<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>mServer<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MSG_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> <span class="token operator">|</span> IOException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">forceClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>FileBridge在构造函数中，通过 Os.socketpair 生成一对socket。一旦启动了线程，FileBridge就会开始监听mServer 服务端的socket是否有数据到来，有数据到来，则开始分析当前的命令是什么并执行相应的操作，命令结构如下：<br>| socket数据 | 头8位高4位 | 头8位低4位 | 头8位的决定的长度内容 |<br>| ———- | ———- | ———- | ——————— |<br>| 意义       | 命令       | 长度       | 传递过来的数据内容    |</p>
<ul>
<li><p>先从mServer的服务端socket读取当前数据的命令和命令中对应数据的长度</p>
</li>
<li><p>CMD_WRITE 说明需要开始写入数据，从socket中读取长度对应的内容，并把当前的数据写入到设置到FileBridge中的mTarget中</p>
</li>
<li><p>CMD_FSYNC 则把mTarget对应缓存数据刷到mTarget这个文件中</p>
</li>
<li><p>CMD_CLOSE 则关闭服务端socket的监听和需要写入的文件fd。</p>
</li>
</ul>
<h5 id="FileBridgeOutputStream-写入原理"><a href="#FileBridgeOutputStream-写入原理" class="headerlink" title="FileBridgeOutputStream 写入原理"></a>FileBridgeOutputStream 写入原理</h5><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> byteOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> byteCount<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            Arrays<span class="token punctuation">.</span><span class="token function">checkOffsetAndCount</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>length<span class="token punctuation">,</span> byteOffset<span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Memory<span class="token punctuation">.</span><span class="token function">pokeInt</span><span class="token punctuation">(</span>mTemp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> CMD_WRITE<span class="token punctuation">,</span> ByteOrder<span class="token punctuation">.</span>BIG_ENDIAN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Memory<span class="token punctuation">.</span><span class="token function">pokeInt</span><span class="token punctuation">(</span>mTemp<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> byteCount<span class="token punctuation">,</span> ByteOrder<span class="token punctuation">.</span>BIG_ENDIAN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            IoBridge<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> mTemp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MSG_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
            IoBridge<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> byteOffset<span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>整个流程就是不断的往mClient 的socket端口写入数据，先写入命令CMD_WRITE，然后byteCount但是这个过程是以BIG_ENDIAN写入，因此两个顺序是颠倒的。最后是apk包数据内容。</p>
<p>当写完数据之后，就会调用FileBridgeOutputStream的fsync方法。</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token function">writeCommandAndBlock</span><span class="token punctuation">(</span>CMD_FSYNC<span class="token punctuation">,</span> <span class="token string">"fsync()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeCommandAndBlock</span><span class="token punctuation">(</span><span class="token keyword">int</span> cmd<span class="token punctuation">,</span> String cmdString<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            Memory<span class="token punctuation">.</span><span class="token function">pokeInt</span><span class="token punctuation">(</span>mTemp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> ByteOrder<span class="token punctuation">.</span>BIG_ENDIAN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            IoBridge<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> mTemp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MSG_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>IoBridge<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> mTemp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MSG_LENGTH<span class="token punctuation">)</span> <span class="token operator">==</span> MSG_LENGTH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Memory<span class="token punctuation">.</span><span class="token function">peekInt</span><span class="token punctuation">(</span>mTemp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ByteOrder<span class="token punctuation">.</span>BIG_ENDIAN<span class="token punctuation">)</span> <span class="token operator">==</span> cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Failed to execute "</span> <span class="token operator">+</span> cmdString <span class="token operator">+</span> <span class="token string">" across bridge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程很简单就是写入了一个CMD_FSYNC命令交给正在监听的FileBridge处理，调用Os.fsync从缓存刷入磁盘。</p>
<p>通过这种方式，就把临时文件<code>/data/no_backup/packagexxx.apk</code>拷贝到<code>/data/app/vmdlsessionId.tmp/PackageInstaller</code>中。</p>
<h4 id="InstallingAsyncTask-onPostExecute"><a href="#InstallingAsyncTask-onPostExecute" class="headerlink" title="InstallingAsyncTask onPostExecute"></a>InstallingAsyncTask onPostExecute</h4><p>当拷贝app的事件完成之后，就会回到主线程回调InstallingAsyncTask的onPostExecute。</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPostExecute</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>Session session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Intent broadcastIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>BROADCAST_ACTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
                broadcastIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_FOREGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
                broadcastIntent<span class="token punctuation">.</span><span class="token function">setPackage</span><span class="token punctuation">(</span>
                        <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPermissionControllerPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                broadcastIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>EventResultPersister<span class="token punctuation">.</span>EXTRA_ID<span class="token punctuation">,</span> mInstallId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                PendingIntent pendingIntent <span class="token operator">=</span> PendingIntent<span class="token punctuation">.</span><span class="token function">getBroadcast</span><span class="token punctuation">(</span>
                        InstallInstalling<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span>
                        mInstallId<span class="token punctuation">,</span>
                        broadcastIntent<span class="token punctuation">,</span>
                        PendingIntent<span class="token punctuation">.</span>FLAG_UPDATE_CURRENT<span class="token punctuation">)</span><span class="token punctuation">;</span>

                session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>pendingIntent<span class="token punctuation">.</span><span class="token function">getIntentSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mCancelButton<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setFinishOnTouchOutside</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>构造一个BROADCAST_ACTION(<code>com.android.packageinstaller.ACTION_INSTALL_COMMIT</code>)的PendingIntent广播，调用session的commit方法，进行发送。</p>
<h5 id="PackageInstaller-Session-commit"><a href="#PackageInstaller-Session-commit" class="headerlink" title="PackageInstaller.Session commit"></a>PackageInstaller.Session commit</h5><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> IntentSender statusReceiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mSession<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>statusReceiver<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就是调用了PackageInstallerSession的commit方法。</p>
<h5 id="PackageInstallerSession-commit"><a href="#PackageInstallerSession-commit" class="headerlink" title="PackageInstallerSession commit"></a>PackageInstallerSession commit</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> IntentSender statusReceiver<span class="token punctuation">,</span> <span class="token keyword">boolean</span> forTransfer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>statusReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> wasSealed<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertCallerIsOwnerOrRootLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertPreparedAndNotDestroyedLocked</span><span class="token punctuation">(</span><span class="token string">"commit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> PackageInstallObserverAdapter adapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInstallObserverAdapter</span><span class="token punctuation">(</span>
                    mContext<span class="token punctuation">,</span> statusReceiver<span class="token punctuation">,</span> sessionId<span class="token punctuation">,</span>
                    <span class="token function">isInstallerDeviceOwnerOrAffiliatedProfileOwnerLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mRemoteObserver <span class="token operator">=</span> adapter<span class="token punctuation">.</span><span class="token function">getBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            wasSealed <span class="token operator">=</span> mSealed<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSealed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">sealAndValidateLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            mClientProgress <span class="token operator">=</span> <span class="token number">1f</span><span class="token punctuation">;</span>
            <span class="token function">computeProgressLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mActiveCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mCommitted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>MSG_COMMIT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendToTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasSealed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCallback<span class="token punctuation">.</span><span class="token function">onSessionSealedBlocking</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.构建一个PackageInstallObserverAdapter对象，并获取其中的Binder对象也就是IPackageInstallObserver2.</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">final</span> IPackageInstallObserver2<span class="token punctuation">.</span>Stub mBinder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IPackageInstallObserver2<span class="token punctuation">.</span>Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onUserActionRequired</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          PackageInstallObserver<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onUserActionRequired</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPackageInstalled</span><span class="token punctuation">(</span>String basePackageName<span class="token punctuation">,</span> <span class="token keyword">int</span> returnCode<span class="token punctuation">,</span>
              String msg<span class="token punctuation">,</span> Bundle extras<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          PackageInstallObserver<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onPackageInstalled</span><span class="token punctuation">(</span>basePackageName<span class="token punctuation">,</span> returnCode<span class="token punctuation">,</span> msg<span class="token punctuation">,</span>
                  extras<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个Binder将会监听从远程端发送过来onPackageInstalled安装完毕的消息。</p>
</li>
<li><p>2.sealAndValidateLocked 把当前拷贝过来的文件进行一次重命名，并且清除该文件夹下可能安装过的临时文件</p>
</li>
<li><p>3.computeProgressLocked 计算进度并且回调</p>
</li>
<li><p>4.发送MSG_COMMIT 的Handler消息</p>
</li>
</ul>
<p>核心是来看看后面2点。</p>
<h5 id="sealAndValidateLocked"><a href="#sealAndValidateLocked" class="headerlink" title="sealAndValidateLocked"></a>sealAndValidateLocked</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sealAndValidateLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
        <span class="token function">assertNoWriteFileTransfersOpenLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertPreparedAndNotDestroyedLocked</span><span class="token punctuation">(</span><span class="token string">"sealing of session"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> PackageInfo pkgInfo <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span>
                params<span class="token punctuation">.</span>appPackageName<span class="token punctuation">,</span> PackageManager<span class="token punctuation">.</span>GET_SIGNATURES
                        <span class="token operator">|</span> PackageManager<span class="token punctuation">.</span>MATCH_STATIC_SHARED_LIBRARIES <span class="token comment" spellcheck="true">/*flags*/</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">resolveStageDirLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mSealed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">validateInstallLocked</span><span class="token punctuation">(</span>pkgInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageManagerException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程先通过PMS的getPackageInfo获取包内容，接着调用validateInstallLocked根据包内容进一步的处理事务。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> File <span class="token function">resolveStageDirLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mResolvedStageDir <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stageDir <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mResolvedStageDir <span class="token operator">=</span> stageDir<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Missing stageDir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mResolvedStageDir<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>设置了mResolvedStageDir为stageDir，也就是<code>/data/app/vmdlsessionId.tmp/</code></p>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">validateInstallLocked</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> PackageInfo pkgInfo<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>
        mPackageName <span class="token operator">=</span> null<span class="token punctuation">;</span>
        mVersionCode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        mSigningDetails <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span>SigningDetails<span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">;</span>

        mResolvedBaseFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
        mResolvedStagedFiles<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mResolvedInheritedFiles<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">resolveStageDirLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> File<span class="token punctuation">[</span><span class="token punctuation">]</span> removedFiles <span class="token operator">=</span> mResolvedStageDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span>sRemovedFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> removeSplitList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>removedFiles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File removedFile <span class="token operator">:</span> removedFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> String fileName <span class="token operator">=</span> removedFile<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> String splitName <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>
                        <span class="token number">0</span><span class="token punctuation">,</span> fileName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> REMOVE_SPLIT_MARKER_EXTENSION<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                removeSplitList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>splitName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> File<span class="token punctuation">[</span><span class="token punctuation">]</span> addedFiles <span class="token operator">=</span> mResolvedStageDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span>sAddedFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> ArraySet<span class="token operator">&lt;</span>String<span class="token operator">></span> stagedSplits <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArraySet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>File addedFile <span class="token operator">:</span> addedFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ApkLite apk<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                apk <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span><span class="token function">parseApkLite</span><span class="token punctuation">(</span>
                        addedFile<span class="token punctuation">,</span> PackageParser<span class="token punctuation">.</span>PARSE_COLLECT_CERTIFICATES<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> PackageManagerException<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mPackageName <span class="token operator">=</span> apk<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
                mVersionCode <span class="token operator">=</span> apk<span class="token punctuation">.</span><span class="token function">getLongVersionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSigningDetails <span class="token operator">==</span> PackageParser<span class="token punctuation">.</span>SigningDetails<span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSigningDetails <span class="token operator">=</span> apk<span class="token punctuation">.</span>signingDetails<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">final</span> String targetName<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>apk<span class="token punctuation">.</span>splitName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                targetName <span class="token operator">=</span> <span class="token string">"base"</span> <span class="token operator">+</span> APK_FILE_EXTENSION<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                targetName <span class="token operator">=</span> <span class="token string">"split_"</span> <span class="token operator">+</span> apk<span class="token punctuation">.</span>splitName <span class="token operator">+</span> APK_FILE_EXTENSION<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">final</span> File targetFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mResolvedStageDir<span class="token punctuation">,</span> targetName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">maybeRenameFile</span><span class="token punctuation">(</span>addedFile<span class="token punctuation">,</span> targetFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Base is coming from session</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>apk<span class="token punctuation">.</span>splitName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mResolvedBaseFile <span class="token operator">=</span> targetFile<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mResolvedStagedFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>targetFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> File dexMetadataFile <span class="token operator">=</span> DexMetadataHelper<span class="token punctuation">.</span><span class="token function">findDexMetadataForFile</span><span class="token punctuation">(</span>addedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dexMetadataFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">final</span> File targetDexMetadataFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mResolvedStageDir<span class="token punctuation">,</span>
                        DexMetadataHelper<span class="token punctuation">.</span><span class="token function">buildDexMetadataPathForApk</span><span class="token punctuation">(</span>targetName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mResolvedStagedFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>targetDexMetadataFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">maybeRenameFile</span><span class="token punctuation">(</span>dexMetadataFile<span class="token punctuation">,</span> targetDexMetadataFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>mode <span class="token operator">==</span> SessionParams<span class="token punctuation">.</span>MODE_FULL_INSTALL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.resolveStageDirLocked 做的事情其实就是把stageDir赋值给mResolvedStageDir中，也就是<code>/data/app/vmdlsessionId.tmp/</code></p>
</li>
<li><p>2.遍历mResolvedStageDir文件夹中<code>/data/app/vmdlsessionId.tmp/</code>所有的文件，能通过sRemovedFilter和sAddedFilter识别出哪些文件需要删除，哪些文件是本次需要添加到安装流程中。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> FileFilter sAddedFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">accept</span><span class="token punctuation">(</span>File file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>REMOVE_SPLIT_MARKER_EXTENSION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>DexMetadataHelper<span class="token punctuation">.</span><span class="token function">isDexMetadataFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String REMOVE_SPLIT_MARKER_EXTENSION <span class="token operator">=</span> <span class="token string">".removed"</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> FileFilter sRemovedFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">accept</span><span class="token punctuation">(</span>File file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>REMOVE_SPLIT_MARKER_EXTENSION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于需要删除的都是带了<code>.remove</code>后缀的文件，需要添加到安装的除了目录文件，<code>.dm</code>，<code>.remove</code>的文件。</p>
</li>
<li><p>3.拿到这些需要添加到安装的流程的文件后，则对每一个apk包通过PackageParser.parseApkLite解析出AndroidManifest最顶层的xml内容出来。获得其版本号，包名，签名等数据，并以包名为基础转化为两种形式的名字：</p>
<ul>
<li>1.如果apk没有进行分割,则名字为<code>base.apk</code></li>
<li>2.如果分割，则为 <code>split_splitname.apk</code><br>并在<code>/data/app/vmdlsessionId.tmp/</code>中生成一个该文件名的实例File(也就是<code>/data/app/vmdlsessionId.tmp/base.apk</code>)，最后添加到mResolvedStagedFiles集合中。接着校验这个apk文件在有没有对应的<code>包名.dm</code>文件，存在则生成一个<code>/data/app/vmdlsessionId.tmp/base.dm</code>文件.</li>
</ul>
</li>
</ul>
<h4 id="PackageInstallSession计算安装进度原理"><a href="#PackageInstallSession计算安装进度原理" class="headerlink" title="PackageInstallSession计算安装进度原理"></a>PackageInstallSession计算安装进度原理</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">computeProgressLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forcePublish<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mProgress <span class="token operator">=</span> MathUtils<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span>mClientProgress <span class="token operator">*</span> <span class="token number">0.8f</span><span class="token punctuation">,</span> <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token number">0.8f</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> MathUtils<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span>mInternalProgress <span class="token operator">*</span> <span class="token number">0.2f</span><span class="token punctuation">,</span> <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token number">0.2f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>forcePublish <span class="token operator">||</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>mProgress <span class="token operator">-</span> mReportedProgress<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0.01</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mReportedProgress <span class="token operator">=</span> mProgress<span class="token punctuation">;</span>
            mCallback<span class="token punctuation">.</span><span class="token function">onSessionProgressChanged</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>决定当前安装进度的有两个，是mClientProgress和mInternalProgress。mClientProgress是指来自PackageInstallerSession之外的PMS的安装进度，另一方面就是mInternalProgress也就是PackageInstallSession本身的进度.</p>
<blockquote>
<p>mClientProgress的进度要乘以0.8,并且把这个结果约束到0～0.8之间。<br>mInternalProgress的进度需要乘以0.5,并且把结果约束到0～0.2之间</p>
</blockquote>
<h4 id="PackageInstallSession-发送MSG-COMMIT-的Handler消息"><a href="#PackageInstallSession-发送MSG-COMMIT-的Handler消息" class="headerlink" title="PackageInstallSession 发送MSG_COMMIT 的Handler消息"></a>PackageInstallSession 发送MSG_COMMIT 的Handler消息</h4><p>在PackageInstallerService的mInstallThread中接收到MSG_COMMIT，就会执行commitLocked方法：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commitLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>mode <span class="token operator">==</span> SessionParams<span class="token punctuation">.</span>MODE_INHERIT_EXISTING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> List<span class="token operator">&lt;</span>File<span class="token operator">></span> fromFiles <span class="token operator">=</span> mResolvedInheritedFiles<span class="token punctuation">;</span>
                <span class="token keyword">final</span> File toDir <span class="token operator">=</span> <span class="token function">resolveStageDirLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLinkPossible</span><span class="token punctuation">(</span>fromFiles<span class="token punctuation">,</span> toDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mResolvedInstructionSets<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> File oatDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>toDir<span class="token punctuation">,</span> <span class="token string">"oat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">createOatDirs</span><span class="token punctuation">(</span>mResolvedInstructionSets<span class="token punctuation">,</span> oatDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mResolvedNativeLibPaths<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>String libPath <span class="token operator">:</span> mResolvedNativeLibPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">final</span> <span class="token keyword">int</span> splitIndex <span class="token operator">=</span> libPath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>splitIndex <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> splitIndex <span class="token operator">>=</span> libPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">final</span> String libDirPath <span class="token operator">=</span> libPath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> splitIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">final</span> File libDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>toDir<span class="token punctuation">,</span> libDirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>libDir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                NativeLibraryHelper<span class="token punctuation">.</span><span class="token function">createNativeLibrarySubdir</span><span class="token punctuation">(</span>libDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">final</span> String archDirPath <span class="token operator">=</span> libPath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>splitIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            NativeLibraryHelper<span class="token punctuation">.</span><span class="token function">createNativeLibrarySubdir</span><span class="token punctuation">(</span>
                                    <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>libDir<span class="token punctuation">,</span> archDirPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">linkFiles</span><span class="token punctuation">(</span>fromFiles<span class="token punctuation">,</span> toDir<span class="token punctuation">,</span> mInheritedFilesBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">copyFiles</span><span class="token punctuation">(</span>fromFiles<span class="token punctuation">,</span> toDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mInternalProgress <span class="token operator">=</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
        <span class="token function">computeProgressLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">extractNativeLibraries</span><span class="token punctuation">(</span>mResolvedStageDir<span class="token punctuation">,</span> params<span class="token punctuation">.</span>abiOverride<span class="token punctuation">,</span> <span class="token function">mayInheritNativeLibs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> IPackageInstallObserver2 localObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IPackageInstallObserver2<span class="token punctuation">.</span>Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onUserActionRequired</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPackageInstalled</span><span class="token punctuation">(</span>String basePackageName<span class="token punctuation">,</span> <span class="token keyword">int</span> returnCode<span class="token punctuation">,</span> String msg<span class="token punctuation">,</span>
                    Bundle extras<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">destroyInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">dispatchSessionFinished</span><span class="token punctuation">(</span>returnCode<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> extras<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> UserHandle user<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_ALL_USERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            user <span class="token operator">=</span> UserHandle<span class="token punctuation">.</span>ALL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserHandle</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mRelinquished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        mPm<span class="token punctuation">.</span><span class="token function">installStage</span><span class="token punctuation">(</span>mPackageName<span class="token punctuation">,</span> stageDir<span class="token punctuation">,</span> localObserver<span class="token punctuation">,</span> params<span class="token punctuation">,</span>
                mInstallerPackageName<span class="token punctuation">,</span> mInstallerUid<span class="token punctuation">,</span> user<span class="token punctuation">,</span> mSigningDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果是SessionParams.MODE_INHERIT_EXISTING安装模式，那么说明是进行安装覆盖，则会遍历该目录下所有的文件。通过isLinkPossible来检查安装原有的文件和当前的原有的文件，mResolvedInheritedFiles中的文件是否可以进行覆盖，如果文件信息一致说明可以覆盖，不能则直接拷贝到<code>/data/app/vmdlsessionId.tmp/</code>目录下。</p>
</li>
<li><p>2.mInternalProgress 设置为0.5，并且更新进度条回调给正在监听的Activity</p>
</li>
<li><p>3.extractNativeLibraries </p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">extractNativeLibraries</span><span class="token punctuation">(</span>File packageDir<span class="token punctuation">,</span> String abiOverride<span class="token punctuation">,</span> <span class="token keyword">boolean</span> inherit<span class="token punctuation">)</span>
          <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>
      <span class="token keyword">final</span> File libDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>packageDir<span class="token punctuation">,</span> NativeLibraryHelper<span class="token punctuation">.</span>LIB_DIR_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inherit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          NativeLibraryHelper<span class="token punctuation">.</span><span class="token function">removeNativeBinariesFromDirLI</span><span class="token punctuation">(</span>libDir<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      NativeLibraryHelper<span class="token punctuation">.</span>Handle handle <span class="token operator">=</span> null<span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          handle <span class="token operator">=</span> NativeLibraryHelper<span class="token punctuation">.</span>Handle<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>packageDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">final</span> <span class="token keyword">int</span> res <span class="token operator">=</span> NativeLibraryHelper<span class="token punctuation">.</span><span class="token function">copyNativeBinariesWithOverride</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> libDir<span class="token punctuation">,</span>
                  abiOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建<code>/data/app/vmdlsessionId.tmp/lib</code>，copyNativeBinariesWithOverride并在这个文件下创建该系统支持的一系列的如64位，32位的arm-v7的so库保存目录</p>
</li>
<li><p>4.把localObserver这个本地Binder作为参数调用PMS的installStage方法，此时安装步骤将会转移到PMS中。之后等到PMS到达了某个阶段就会回调到onPackageInstalled，从而得知PMS那边安装完成了。</p>
</li>
</ul>
<h4 id="PMS-installStage-PMS中的安装步骤"><a href="#PMS-installStage-PMS中的安装步骤" class="headerlink" title="PMS installStage PMS中的安装步骤"></a>PMS installStage PMS中的安装步骤</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">installStage</span><span class="token punctuation">(</span>String packageName<span class="token punctuation">,</span> File stagedDir<span class="token punctuation">,</span>
            IPackageInstallObserver2 observer<span class="token punctuation">,</span> PackageInstaller<span class="token punctuation">.</span>SessionParams sessionParams<span class="token punctuation">,</span>
            String installerPackageName<span class="token punctuation">,</span> <span class="token keyword">int</span> installerUid<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">,</span>
            PackageParser<span class="token punctuation">.</span>SigningDetails signingDetails<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">final</span> VerificationInfo verificationInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VerificationInfo</span><span class="token punctuation">(</span>
                sessionParams<span class="token punctuation">.</span>originatingUri<span class="token punctuation">,</span> sessionParams<span class="token punctuation">.</span>referrerUri<span class="token punctuation">,</span>
                sessionParams<span class="token punctuation">.</span>originatingUid<span class="token punctuation">,</span> installerUid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> OriginInfo origin <span class="token operator">=</span> OriginInfo<span class="token punctuation">.</span><span class="token function">fromStagedFile</span><span class="token punctuation">(</span>stagedDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>INIT_COPY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> installReason <span class="token operator">=</span> <span class="token function">fixUpInstallReason</span><span class="token punctuation">(</span>installerPackageName<span class="token punctuation">,</span> installerUid<span class="token punctuation">,</span>
                sessionParams<span class="token punctuation">.</span>installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> InstallParams params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstallParams</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> null<span class="token punctuation">,</span> observer<span class="token punctuation">,</span>
                sessionParams<span class="token punctuation">.</span>installFlags<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">,</span> sessionParams<span class="token punctuation">.</span>volumeUuid<span class="token punctuation">,</span>
                verificationInfo<span class="token punctuation">,</span> user<span class="token punctuation">,</span> sessionParams<span class="token punctuation">.</span>abiOverride<span class="token punctuation">,</span>
                sessionParams<span class="token punctuation">.</span>grantedRuntimePermissions<span class="token punctuation">,</span> signingDetails<span class="token punctuation">,</span> installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>

        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> params<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">
        <span class="token keyword">static</span> OriginInfo <span class="token function">fromStagedFile</span><span class="token punctuation">(</span>File file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OriginInfo</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token function">OriginInfo</span><span class="token punctuation">(</span>File file<span class="token punctuation">,</span> <span class="token keyword">boolean</span> staged<span class="token punctuation">,</span> <span class="token keyword">boolean</span> existing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>staged <span class="token operator">=</span> staged<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>existing <span class="token operator">=</span> existing<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resolvedPath <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                resolvedFile <span class="token operator">=</span> file<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                resolvedPath <span class="token operator">=</span> null<span class="token punctuation">;</span>
                resolvedFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很见到就是发送了一个INIT_COPY的handler消息，并且把stagedDir信息存储到OriginInfo中。OriginInfo记录了stageDir的路径也就是<code>/data/app/vmdlsessionId.tmp</code></p>
<h5 id="PackageHandler-处理INIT-COPY消息"><a href="#PackageHandler-处理INIT-COPY消息" class="headerlink" title="PackageHandler 处理INIT_COPY消息"></a>PackageHandler 处理INIT_COPY消息</h5><pre class="line-numbers language-java"><code class="language-java">                <span class="token keyword">case</span> INIT_COPY<span class="token operator">:</span> <span class="token punctuation">{</span>
                    HandlerParams params <span class="token operator">=</span> <span class="token punctuation">(</span>HandlerParams<span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                    <span class="token keyword">int</span> idx <span class="token operator">=</span> mPendingInstalls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mBound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">connectToService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            params<span class="token punctuation">.</span><span class="token function">serviceError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            mPendingInstalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        mPendingInstalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>MCS_BOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先第一次安装的时候mBound必定是false，就会调用connectToService尝试的绑定一个Service，如果绑定成功则把此时的安装参数HandlerParams保存到mPendingInstalls。</p>
<h5 id="PackageHandler-connectToService"><a href="#PackageHandler-connectToService" class="headerlink" title="PackageHandler connectToService"></a>PackageHandler connectToService</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> ComponentName DEFAULT_CONTAINER_COMPONENT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
            DEFAULT_CONTAINER_PACKAGE<span class="token punctuation">,</span>
            <span class="token string">"com.android.defcontainer.DefaultContainerService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">connectToService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Intent service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>DEFAULT_CONTAINER_COMPONENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Process<span class="token punctuation">.</span><span class="token function">setThreadPriority</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span>THREAD_PRIORITY_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">bindServiceAsUser</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> mDefContainerConn<span class="token punctuation">,</span>
                    Context<span class="token punctuation">.</span>BIND_AUTO_CREATE<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>SYSTEM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Process<span class="token punctuation">.</span><span class="token function">setThreadPriority</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span>THREAD_PRIORITY_BACKGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mBound <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Process<span class="token punctuation">.</span><span class="token function">setThreadPriority</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span>THREAD_PRIORITY_BACKGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时先提高进程优先级到THREAD_PRIORITY_DEFAULT；并启动了一个DefaultContainerService服务，同时绑定了mDefContainerConn。成功后把进程设置回THREAD_PRIORITY_BACKGROUND。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">class</span> <span class="token class-name">DefaultContainerConnection</span> <span class="token keyword">implements</span> <span class="token class-name">ServiceConnection</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> IMediaContainerService imcs <span class="token operator">=</span> IMediaContainerService<span class="token punctuation">.</span>Stub
                    <span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>Binder<span class="token punctuation">.</span><span class="token function">allowBlocking</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>MCS_BOUND<span class="token punctuation">,</span> imcs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>值得注意的是，DefaultContainerConnection会监听Service启动后返回的Binder并且发送一个MCS_BOUND消息。</p>
<h5 id="DefaultContainerService的Binder对象"><a href="#DefaultContainerService的Binder对象" class="headerlink" title="DefaultContainerService的Binder对象"></a>DefaultContainerService的Binder对象</h5><p>实际上我们不需要关系这哥Service是启动都做了什么，我们关心的是返回的Binder是什么，具体的实现先不看，直接看看它的aidl接口</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">IMediaContainerService</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token function">copyPackage</span><span class="token punctuation">(</span>String packagePath<span class="token punctuation">,</span> in IParcelFileDescriptorFactory target<span class="token punctuation">)</span><span class="token punctuation">;</span>

    PackageInfoLite <span class="token function">getMinimalPackageInfo</span><span class="token punctuation">(</span>String packagePath<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String abiOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ObbInfo <span class="token function">getObbInfo</span><span class="token punctuation">(</span>String filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">clearDirectory</span><span class="token punctuation">(</span>String directory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token function">calculateInstalledSize</span><span class="token punctuation">(</span>String packagePath<span class="token punctuation">,</span> String abiOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，就是关于PMS中进行apk包相关的操作。</p>
<h4 id="PackageHandler-处理MCS-BOUND消息"><a href="#PackageHandler-处理MCS-BOUND消息" class="headerlink" title="PackageHandler 处理MCS_BOUND消息"></a>PackageHandler 处理MCS_BOUND消息</h4><pre class="line-numbers language-java"><code class="language-java">                <span class="token keyword">case</span> MCS_BOUND<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>obj <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mContainerService <span class="token operator">=</span> <span class="token punctuation">(</span>IMediaContainerService<span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mContainerService <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingInstalls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        HandlerParams params <span class="token operator">=</span> mPendingInstalls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">startCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingInstalls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    mPendingInstalls<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingInstalls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mBound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        <span class="token function">removeMessages</span><span class="token punctuation">(</span>MCS_UNBIND<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        Message ubmsg <span class="token operator">=</span> <span class="token function">obtainMessage</span><span class="token punctuation">(</span>MCS_UNBIND<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>ubmsg<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>MCS_BOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在PMS的ServiceThread handleThread线程中会检查mPendingInstalls是否有需要安装的对象，有则从mPendingInstalls的头部获取HandlerParams，调用HandlerParams.startCopy方法进行拷贝，知道消费完mPendingInstalls中所有的任务则进行解绑。</p>
<h5 id="PMS-HandlerParams-startCopy"><a href="#PMS-HandlerParams-startCopy" class="headerlink" title="PMS.HandlerParams startCopy"></a>PMS.HandlerParams startCopy</h5><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_RETRIES <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">startCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> res<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>mRetries <span class="token operator">></span> MAX_RETRIES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>MCS_GIVE_UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">handleServiceError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">handleStartCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    res <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>MCS_RECONNECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                res <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">handleReturnCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个拷贝的步骤会重新的尝试4次，但是正常步骤则是调用handleStartCopy开始拷贝安装后，再调用handleReturnCode返回状态码</p>
<h6 id="PMS-HandlerParams-handleStartCopy"><a href="#PMS-HandlerParams-handleStartCopy" class="headerlink" title="PMS.HandlerParams handleStartCopy"></a>PMS.HandlerParams handleStartCopy</h6><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleStartCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>origin<span class="token punctuation">.</span>staged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>origin<span class="token punctuation">.</span>file <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    installFlags <span class="token operator">|=</span> PackageManager<span class="token punctuation">.</span>INSTALL_INTERNAL<span class="token punctuation">;</span>
                    installFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>PackageManager<span class="token punctuation">.</span>INSTALL_EXTERNAL<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> <span class="token keyword">boolean</span> onSd <span class="token operator">=</span> <span class="token punctuation">(</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_EXTERNAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> onInt <span class="token operator">=</span> <span class="token punctuation">(</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_INTERNAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> ephemeral <span class="token operator">=</span> <span class="token punctuation">(</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            PackageInfoLite pkgLite <span class="token operator">=</span> null<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>onInt <span class="token operator">&amp;&amp;</span> onSd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>onSd <span class="token operator">&amp;&amp;</span> ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                pkgLite <span class="token operator">=</span> mContainerService<span class="token punctuation">.</span><span class="token function">getMinimalPackageInfo</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>resolvedPath<span class="token punctuation">,</span> installFlags<span class="token punctuation">,</span>
                        packageAbiOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">final</span> InstallArgs args <span class="token operator">=</span> <span class="token function">createInstallArgs</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mArgs <span class="token operator">=</span> args<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                UserHandle verifierUser <span class="token operator">=</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>verifierUser <span class="token operator">==</span> UserHandle<span class="token punctuation">.</span>ALL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    verifierUser <span class="token operator">=</span> UserHandle<span class="token punctuation">.</span>SYSTEM<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> requiredUid <span class="token operator">=</span> mRequiredVerifierPackage <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span>
                        <span class="token operator">:</span> <span class="token function">getPackageUid</span><span class="token punctuation">(</span>mRequiredVerifierPackage<span class="token punctuation">,</span> MATCH_DEBUG_TRIAGED_MISSING<span class="token punctuation">,</span>
                                verifierUser<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> installerUid <span class="token operator">=</span>
                        verificationInfo <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> verificationInfo<span class="token punctuation">.</span>installerUid<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>origin<span class="token punctuation">.</span>existing <span class="token operator">&amp;&amp;</span> requiredUid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token function">isVerificationEnabled</span><span class="token punctuation">(</span>
                                verifierUser<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> installFlags<span class="token punctuation">,</span> installerUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> Intent verification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>
                            Intent<span class="token punctuation">.</span>ACTION_PACKAGE_NEEDS_VERIFICATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    verification<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_FOREGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    verification<span class="token punctuation">.</span><span class="token function">setDataAndType</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>resolvedPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            PACKAGE_MIME_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    verification<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_GRANT_READ_URI_PERMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">final</span> List<span class="token operator">&lt;</span>ResolveInfo<span class="token operator">></span> receivers <span class="token operator">=</span> <span class="token function">queryIntentReceiversInternal</span><span class="token punctuation">(</span>verification<span class="token punctuation">,</span>
                            PACKAGE_MIME_TYPE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> verifierUser<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*allowDynamicSplits*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


                    <span class="token keyword">final</span> <span class="token keyword">int</span> verificationId <span class="token operator">=</span> mPendingVerificationToken<span class="token operator">++</span><span class="token punctuation">;</span>

                    verification<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>EXTRA_VERIFICATION_ID<span class="token punctuation">,</span> verificationId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    verification<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>EXTRA_VERIFICATION_INSTALLER_PACKAGE<span class="token punctuation">,</span>
                            installerPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    verification<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>EXTRA_VERIFICATION_INSTALL_FLAGS<span class="token punctuation">,</span>
                            installFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    verification<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>EXTRA_VERIFICATION_PACKAGE_NAME<span class="token punctuation">,</span>
                            pkgLite<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    verification<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>EXTRA_VERIFICATION_VERSION_CODE<span class="token punctuation">,</span>
                            pkgLite<span class="token punctuation">.</span>versionCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    verification<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>EXTRA_VERIFICATION_LONG_VERSION_CODE<span class="token punctuation">,</span>
                            pkgLite<span class="token punctuation">.</span><span class="token function">getLongVersionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>verificationInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>verificationInfo<span class="token punctuation">.</span>originatingUri <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            verification<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_URI<span class="token punctuation">,</span>
                                    verificationInfo<span class="token punctuation">.</span>originatingUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>verificationInfo<span class="token punctuation">.</span>referrer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            verification<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REFERRER<span class="token punctuation">,</span>
                                    verificationInfo<span class="token punctuation">.</span>referrer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>verificationInfo<span class="token punctuation">.</span>originatingUid <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            verification<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_UID<span class="token punctuation">,</span>
                                    verificationInfo<span class="token punctuation">.</span>originatingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>verificationInfo<span class="token punctuation">.</span>installerUid <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            verification<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>EXTRA_VERIFICATION_INSTALLER_UID<span class="token punctuation">,</span>
                                    verificationInfo<span class="token punctuation">.</span>installerUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">final</span> PackageVerificationState verificationState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageVerificationState</span><span class="token punctuation">(</span>
                            requiredUid<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    mPendingVerification<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>verificationId<span class="token punctuation">,</span> verificationState<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">final</span> List<span class="token operator">&lt;</span>ComponentName<span class="token operator">></span> sufficientVerifiers <span class="token operator">=</span> <span class="token function">matchVerifiers</span><span class="token punctuation">(</span>pkgLite<span class="token punctuation">,</span>
                            receivers<span class="token punctuation">,</span> verificationState<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    DeviceIdleController<span class="token punctuation">.</span>LocalService idleController <span class="token operator">=</span> <span class="token function">getDeviceIdleController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> idleDuration <span class="token operator">=</span> <span class="token function">getVerificationTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>sufficientVerifiers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> sufficientVerifiers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ret <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_VERIFICATION_FAILURE<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">final</span> ComponentName verifierComponent <span class="token operator">=</span> sufficientVerifiers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                idleController<span class="token punctuation">.</span><span class="token function">addPowerSaveTempWhitelistApp</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span><span class="token function">myUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        verifierComponent<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> idleDuration<span class="token punctuation">,</span>
                                        verifierUser<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"package verifier"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                                <span class="token keyword">final</span> Intent sufficientIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>verification<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                sufficientIntent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>verifierComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                mContext<span class="token punctuation">.</span><span class="token function">sendBroadcastAsUser</span><span class="token punctuation">(</span>sufficientIntent<span class="token punctuation">,</span> verifierUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">final</span> ComponentName requiredVerifierComponent <span class="token operator">=</span> <span class="token function">matchComponentForVerifier</span><span class="token punctuation">(</span>
                            mRequiredVerifierPackage<span class="token punctuation">,</span> receivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED
                            <span class="token operator">&amp;&amp;</span> mRequiredVerifierPackage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        verification<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>requiredVerifierComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        idleController<span class="token punctuation">.</span><span class="token function">addPowerSaveTempWhitelistApp</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span><span class="token function">myUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                mRequiredVerifierPackage<span class="token punctuation">,</span> idleDuration<span class="token punctuation">,</span>
                                verifierUser<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"package verifier"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mContext<span class="token punctuation">.</span><span class="token function">sendOrderedBroadcastAsUser</span><span class="token punctuation">(</span>verification<span class="token punctuation">,</span> verifierUser<span class="token punctuation">,</span>
                                android<span class="token punctuation">.</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>PACKAGE_VERIFICATION_AGENT<span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">BroadcastReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token annotation punctuation">@Override</span>
                                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        <span class="token keyword">final</span> Message msg <span class="token operator">=</span> mHandler
                                                <span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>CHECK_PENDING_VERIFICATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> verificationId<span class="token punctuation">;</span>
                                        mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token function">getVerificationTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        mArgs <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                    ret <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">copyApk</span><span class="token punctuation">(</span>mContainerService<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            mRet <span class="token operator">=</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.调用IMediaContainerService的getMinimalPackageInfo方法，扫描安装apk到Android系统中。</p>
</li>
<li><p>2.通过createInstallArgs构建InstallArgs对象，如果getMinimalPackageInfo的安装成功了，则会进行判断该包是否已经安装过且isVerificationEnabled是否允许进行包校验器进行校验。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> InstallArgs <span class="token function">createInstallArgs</span><span class="token punctuation">(</span>InstallParams params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>move <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MoveInstallArgs</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileInstallArgs</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意我们此时是FileInstallArgs，我们只考虑第一次安装apk包的情况</p>
</li>
<li><p>3.如果可以进行包校验,则通过data为<code>"application/vnd.android.package-archive"</code>调用queryIntentReceiversInternal方法查找有没有注册在Android系统中的包校验广播接受者；通过matchVerifiers筛选出当前合适的包校验器，最后依次发送广播，让包校验接受者根据包名，versionCode，packageName，安装来源等信息进行校验</p>
</li>
</ul>
<ul>
<li>4.不如出现不满足进行校验的条件，则调用InstallArgs.copyApk进行进一步的拷贝操作。</li>
</ul>
<p>关于包校验器这里就不多聊了，核心是第1点和第4点，让我们依次看看IMediaContainerService.getMinimalPackageInfo以及InstallArgs.copyApk</p>
<h5 id="DefaultContainerService-getMinimalPackageInfo"><a href="#DefaultContainerService-getMinimalPackageInfo" class="headerlink" title="DefaultContainerService getMinimalPackageInfo"></a>DefaultContainerService getMinimalPackageInfo</h5><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> PackageInfoLite <span class="token function">getMinimalPackageInfo</span><span class="token punctuation">(</span>String packagePath<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
                String abiOverride<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> Context context <span class="token operator">=</span> DefaultContainerService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">;</span>

            PackageInfoLite ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInfoLite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> File packageFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>packagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>PackageLite pkg<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> sizeBytes<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                pkg <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span><span class="token function">parsePackageLite</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sizeBytes <span class="token operator">=</span> PackageHelper<span class="token punctuation">.</span><span class="token function">calculateInstalledSize</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> abiOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> <span class="token operator">|</span> IOException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> <span class="token keyword">int</span> recommendedInstallLocation<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> token <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                recommendedInstallLocation <span class="token operator">=</span> PackageHelper<span class="token punctuation">.</span><span class="token function">resolveInstallLocation</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>
                        pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> pkg<span class="token punctuation">.</span>installLocation<span class="token punctuation">,</span> sizeBytes<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            ret<span class="token punctuation">.</span>packageName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
            ret<span class="token punctuation">.</span>splitNames <span class="token operator">=</span> pkg<span class="token punctuation">.</span>splitNames<span class="token punctuation">;</span>
            ret<span class="token punctuation">.</span>versionCode <span class="token operator">=</span> pkg<span class="token punctuation">.</span>versionCode<span class="token punctuation">;</span>
            ret<span class="token punctuation">.</span>versionCodeMajor <span class="token operator">=</span> pkg<span class="token punctuation">.</span>versionCodeMajor<span class="token punctuation">;</span>
            ret<span class="token punctuation">.</span>baseRevisionCode <span class="token operator">=</span> pkg<span class="token punctuation">.</span>baseRevisionCode<span class="token punctuation">;</span>
            ret<span class="token punctuation">.</span>splitRevisionCodes <span class="token operator">=</span> pkg<span class="token punctuation">.</span>splitRevisionCodes<span class="token punctuation">;</span>
            ret<span class="token punctuation">.</span>installLocation <span class="token operator">=</span> pkg<span class="token punctuation">.</span>installLocation<span class="token punctuation">;</span>
            ret<span class="token punctuation">.</span>verifiers <span class="token operator">=</span> pkg<span class="token punctuation">.</span>verifiers<span class="token punctuation">;</span>
            ret<span class="token punctuation">.</span>recommendedInstallLocation <span class="token operator">=</span> recommendedInstallLocation<span class="token punctuation">;</span>
            ret<span class="token punctuation">.</span>multiArch <span class="token operator">=</span> pkg<span class="token punctuation">.</span>multiArch<span class="token punctuation">;</span>

            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.PackageParser.parsePackageLite 对apk包进行解析</li>
<li>2.PackageHelper.calculateInstalledSize 对安装后的包进行大小统计</li>
<li>3.PackageHelper.resolveInstallLocation 计算出返回的结果</li>
</ul>
<h6 id="PackageParser-parsePackageLite"><a href="#PackageParser-parsePackageLite" class="headerlink" title="PackageParser.parsePackageLite"></a>PackageParser.parsePackageLite</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> PackageLite <span class="token function">parsePackageLite</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageFile<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">parseClusterPackageLite</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">parseMonolithicPackageLite</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>到这个方法就是解析包中的AndroidManifest最外层的数据.拿到版本号，包名，包的路径等等不包含四大组件的基础信息。注意这里将会走目录的分支，parseClusterPackageLite。这个方法其实和parseMonolithicPackageLite作用十分相似，核心还是遍历这个目录里面所有的apk文件，以splitName为key，ApkLite为value保存起来，并且找出null为key对应的baseApk的value，从而确认这个apk安装包的基础包是什么。</p>
<h6 id="PackageHelper-calculateInstalledSize"><a href="#PackageHelper-calculateInstalledSize" class="headerlink" title="PackageHelper.calculateInstalledSize"></a>PackageHelper.calculateInstalledSize</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">calculateInstalledSize</span><span class="token punctuation">(</span>PackageLite pkg<span class="token punctuation">,</span> NativeLibraryHelper<span class="token punctuation">.</span>Handle handle<span class="token punctuation">,</span>
            String abiOverride<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">long</span> sizeBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>


        <span class="token keyword">for</span> <span class="token punctuation">(</span>String codePath <span class="token operator">:</span> pkg<span class="token punctuation">.</span><span class="token function">getAllCodePaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> File codeFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sizeBytes <span class="token operator">+=</span> codeFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        sizeBytes <span class="token operator">+=</span> DexMetadataHelper<span class="token punctuation">.</span><span class="token function">getPackageDexMetadataSize</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        sizeBytes <span class="token operator">+=</span> NativeLibraryHelper<span class="token punctuation">.</span><span class="token function">sumNativeBinariesWithOverride</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> abiOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> sizeBytes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>计算结果是：</p>
<blockquote>
<p>安装后大小 = 每一个包安装路径下文件的大小(<code>/data/app/vmdlsessionId.tmp/base.apk</code>)+ <code>.dm</code>后缀的文件大小 + <code>so</code>库大小</p>
</blockquote>
<h5 id="FileInstallArgs-copyApk"><a href="#FileInstallArgs-copyApk" class="headerlink" title="FileInstallArgs.copyApk"></a>FileInstallArgs.copyApk</h5><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">int</span> <span class="token function">copyApk</span><span class="token punctuation">(</span>IMediaContainerService imcs<span class="token punctuation">,</span> <span class="token keyword">boolean</span> temp<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
            Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"copyApk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">doCopyApk</span><span class="token punctuation">(</span>imcs<span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">doCopyApk</span><span class="token punctuation">(</span>IMediaContainerService imcs<span class="token punctuation">,</span> <span class="token keyword">boolean</span> temp<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>origin<span class="token punctuation">.</span>staged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                codeFile <span class="token operator">=</span> origin<span class="token punctuation">.</span>file<span class="token punctuation">;</span>
                resourceFile <span class="token operator">=</span> origin<span class="token punctuation">.</span>file<span class="token punctuation">;</span>
                <span class="token keyword">return</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isEphemeral <span class="token operator">=</span> <span class="token punctuation">(</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> File tempDir <span class="token operator">=</span>
                        mInstallerService<span class="token punctuation">.</span><span class="token function">allocateStageDirLegacy</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">,</span> isEphemeral<span class="token punctuation">)</span><span class="token punctuation">;</span>
                codeFile <span class="token operator">=</span> tempDir<span class="token punctuation">;</span>
                resourceFile <span class="token operator">=</span> tempDir<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> IParcelFileDescriptorFactory target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IParcelFileDescriptorFactory<span class="token punctuation">.</span>Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> ParcelFileDescriptor <span class="token function">open</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>

                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>codeFile<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> FileDescriptor fd <span class="token operator">=</span> Os<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        Os<span class="token punctuation">.</span><span class="token function">chmod</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ParcelFileDescriptor</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> ret <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>
            ret <span class="token operator">=</span> imcs<span class="token punctuation">.</span><span class="token function">copyPackage</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> File libraryRoot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>codeFile<span class="token punctuation">,</span> LIB_DIR_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            NativeLibraryHelper<span class="token punctuation">.</span>Handle handle <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                handle <span class="token operator">=</span> NativeLibraryHelper<span class="token punctuation">.</span>Handle<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>codeFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> NativeLibraryHelper<span class="token punctuation">.</span><span class="token function">copyNativeBinariesWithOverride</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> libraryRoot<span class="token punctuation">,</span>
                        abiOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.PackageInstallerService.allocateStageDirLegacy 获取一个全新的sessionId对应目录：<code>/data/app/vmdlsessionId.tmp/</code>目录，把code和资源的路径都设置到同一处。</p>
</li>
<li><p>2.实例化一个IParcelFileDescriptorFactory接口，用于设置每一个创建文件时候确定权限为0644。</p>
</li>
<li><p>3.IMediaContainerService.copyPackage 把保存在OriginInfo的File(<code>/data/app/vmdlsessionId.tmp/</code>)拷贝到IParcelFileDescriptorFactory的路径中。</p>
</li>
<li><p>3.codeFile 下设置一个lib文件夹，里面包含了不同平台的so库。</p>
</li>
</ul>
<h6 id="IMediaContainerService-copyPackage"><a href="#IMediaContainerService-copyPackage" class="headerlink" title="IMediaContainerService.copyPackage"></a>IMediaContainerService.copyPackage</h6><p>核心方法如下：</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">copyPackage</span><span class="token punctuation">(</span>String packagePath<span class="token punctuation">,</span> IParcelFileDescriptorFactory target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>packagePath <span class="token operator">==</span> null <span class="token operator">||</span> target <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_URI<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            PackageLite pkg <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> File packageFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>packagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pkg <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span><span class="token function">parsePackageLite</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">copyPackageInner</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> <span class="token operator">|</span> IOException <span class="token operator">|</span> RemoteException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">copyPackageInner</span><span class="token punctuation">(</span>PackageLite pkg<span class="token punctuation">,</span> IParcelFileDescriptorFactory target<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> RemoteException <span class="token punctuation">{</span>
        <span class="token function">copyFile</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>baseCodePath<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token string">"base.apk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>splitNames<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pkg<span class="token punctuation">.</span>splitNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">copyFile</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>splitCodePaths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token string">"split_"</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>splitNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".apk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>把<code>/data/app/vmdlsessionId.tmp/</code>下的文件apk资源往另一个sessionId对应的<code>/data/app/vmdlsessionId.tmp/base.apk</code>复制拷贝。</p>
<h6 id="PMS-HandlerParams-handleReturnCode"><a href="#PMS-HandlerParams-handleReturnCode" class="headerlink" title="PMS.HandlerParams handleReturnCode"></a>PMS.HandlerParams handleReturnCode</h6><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">void</span> <span class="token function">handleReturnCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mArgs <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">processPendingInstall</span><span class="token punctuation">(</span>mArgs<span class="token punctuation">,</span> mRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processPendingInstall</span><span class="token punctuation">(</span><span class="token keyword">final</span> InstallArgs args<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> currentStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mHandler<span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                PackageInstalledInfo res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInstalledInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                res<span class="token punctuation">.</span><span class="token function">setReturnCode</span><span class="token punctuation">(</span>currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
                res<span class="token punctuation">.</span>uid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                res<span class="token punctuation">.</span>pkg <span class="token operator">=</span> null<span class="token punctuation">;</span>
                res<span class="token punctuation">.</span>removedInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    args<span class="token punctuation">.</span><span class="token function">doPreInstall</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">installPackageTracedLI</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    args<span class="token punctuation">.</span><span class="token function">doPostInstall</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode<span class="token punctuation">,</span> res<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>doRestore<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>POST_INSTALL<span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.InstallArgs.doPreInstall 安装失败则清除安装过程中的临时文件</li>
<li>2.installPackageTracedLI 安装扫描apk包</li>
<li>3.InstallArgs.doPostInstall 清除缓存在Installd的缓存</li>
<li>4.发送POST_INSTALL Handler消息到ServiceThread中处理</li>
</ul>
<h5 id="PMS-installPackageTracedLI"><a href="#PMS-installPackageTracedLI" class="headerlink" title="PMS installPackageTracedLI"></a>PMS installPackageTracedLI</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installPackageLI</span><span class="token punctuation">(</span>InstallArgs args<span class="token punctuation">,</span> PackageInstalledInfo res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pp<span class="token punctuation">.</span><span class="token function">setSeparateProcesses</span><span class="token punctuation">(</span>mSeparateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pp<span class="token punctuation">.</span><span class="token function">setDisplayMetrics</span><span class="token punctuation">(</span>mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pp<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>mPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            pkg <span class="token operator">=</span> pp<span class="token punctuation">.</span><span class="token function">parsePackage</span><span class="token punctuation">(</span>tmpPackageFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            DexMetadataHelper<span class="token punctuation">.</span><span class="token function">validatePackageDexMetadata</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>cpuAbiOverride<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pkg<span class="token punctuation">.</span>cpuAbiOverride <span class="token operator">=</span> args<span class="token punctuation">.</span>abiOverride<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        String pkgName <span class="token operator">=</span> res<span class="token punctuation">.</span>name <span class="token operator">=</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>signingDetails <span class="token operator">!=</span> PackageParser<span class="token punctuation">.</span>SigningDetails<span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pkg<span class="token punctuation">.</span><span class="token function">setSigningDetails</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>signingDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                PackageParser<span class="token punctuation">.</span><span class="token function">collectCertificates</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* skipVerify */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token string">"Failed collect during installPackageLI"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        pp <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String oldCodePath <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> systemApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span> N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Permission perm <span class="token operator">=</span> pkg<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> BasePermission bp <span class="token operator">=</span>
                        <span class="token punctuation">(</span>BasePermission<span class="token punctuation">)</span> mPermissionManager<span class="token punctuation">.</span><span class="token function">getPermissionTEMP</span><span class="token punctuation">(</span>perm<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>perm<span class="token punctuation">.</span>info<span class="token punctuation">.</span>protectionLevel <span class="token operator">&amp;</span> PermissionInfo<span class="token punctuation">.</span>PROTECTION_FLAG_INSTANT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>systemApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    perm<span class="token punctuation">.</span>info<span class="token punctuation">.</span>protectionLevel <span class="token operator">&amp;=</span> <span class="token operator">~</span>PermissionInfo<span class="token punctuation">.</span>PROTECTION_FLAG_INSTANT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">final</span> <span class="token keyword">boolean</span> sigsOk<span class="token punctuation">;</span>
                    <span class="token keyword">final</span> String sourcePackageName <span class="token operator">=</span> bp<span class="token punctuation">.</span><span class="token function">getSourcePackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> PackageSettingBase sourcePackageSetting <span class="token operator">=</span> bp<span class="token punctuation">.</span><span class="token function">getSourcePackageSetting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> KeySetManagerService ksms <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mKeySetManagerService<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>sourcePackageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ksms<span class="token punctuation">.</span><span class="token function">shouldCheckUpgradeKeySetLocked</span><span class="token punctuation">(</span>
                                    sourcePackageSetting<span class="token punctuation">,</span> scanFlags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        sigsOk <span class="token operator">=</span> ksms<span class="token punctuation">.</span><span class="token function">checkUpgradeKeySetLocked</span><span class="token punctuation">(</span>sourcePackageSetting<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>sourcePackageSetting<span class="token punctuation">.</span>signatures<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span><span class="token function">checkCapability</span><span class="token punctuation">(</span>
                                        pkg<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">,</span>
                                        PackageParser<span class="token punctuation">.</span>SigningDetails<span class="token punctuation">.</span>CertCapabilities<span class="token punctuation">.</span>PERMISSION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            sigsOk <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span><span class="token function">checkCapability</span><span class="token punctuation">(</span>
                                        sourcePackageSetting<span class="token punctuation">.</span>signatures<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">,</span>
                                        PackageParser<span class="token punctuation">.</span>SigningDetails<span class="token punctuation">.</span>CertCapabilities<span class="token punctuation">.</span>PERMISSION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            sourcePackageSetting<span class="token punctuation">.</span>signatures<span class="token punctuation">.</span>mSigningDetails <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">;</span>
                            sigsOk <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            sigsOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sigsOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PLATFORM_PACKAGE_NAME<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>perm<span class="token punctuation">.</span>info<span class="token punctuation">.</span>protectionLevel <span class="token operator">&amp;</span> PermissionInfo<span class="token punctuation">.</span>PROTECTION_MASK_BASE<span class="token punctuation">)</span>
                                <span class="token operator">==</span> PermissionInfo<span class="token punctuation">.</span>PROTECTION_DANGEROUS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bp<span class="token punctuation">.</span><span class="token function">isRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                                perm<span class="token punctuation">.</span>info<span class="token punctuation">.</span>protectionLevel <span class="token operator">=</span> bp<span class="token punctuation">.</span><span class="token function">getProtectionLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>move <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forwardLocked <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isExternalAsec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>args<span class="token punctuation">.</span><span class="token function">doRename</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span> oldCodePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageManagerServiceUtils<span class="token punctuation">.</span><span class="token function">isApkVerityEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String apkPath <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">final</span> PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> ps<span class="token punctuation">.</span><span class="token function">isPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    apkPath <span class="token operator">=</span> pkg<span class="token punctuation">.</span>baseCodePath<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>apkPath <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> VerityUtils<span class="token punctuation">.</span>SetupResult result <span class="token operator">=</span>
                        VerityUtils<span class="token punctuation">.</span><span class="token function">generateApkVeritySetupData</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    FileDescriptor fd <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getUnownedFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> signedRootHash <span class="token operator">=</span> VerityUtils<span class="token punctuation">.</span><span class="token function">generateFsverityRootHash</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mInstaller<span class="token punctuation">.</span><span class="token function">installApkVerity</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getContentSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mInstaller<span class="token punctuation">.</span><span class="token function">assertFsverityRootHashMatches</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">,</span> signedRootHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstallerException</span> <span class="token operator">|</span> IOException <span class="token operator">|</span> DigestException <span class="token operator">|</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">try</span> <span class="token punctuation">(</span>PackageFreezer freezer <span class="token operator">=</span> <span class="token function">freezePackageForInstall</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span> installFlags<span class="token punctuation">,</span>
                <span class="token string">"installPackageLI"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">installNewPackageLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags <span class="token operator">|</span> SCAN_DELETE_DATA_ON_FAILURES<span class="token punctuation">,</span>
                        args<span class="token punctuation">.</span>user<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">,</span> volumeUuid<span class="token punctuation">,</span> res<span class="token punctuation">,</span> args<span class="token punctuation">.</span>installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mArtManagerService<span class="token punctuation">.</span><span class="token function">prepareAppProfiles</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> <span class="token function">resolveUserIds</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">final</span> <span class="token keyword">boolean</span> performDexopt <span class="token operator">=</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>forwardLocked
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isExternalAsec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>instantApp <span class="token operator">||</span> Global<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Global<span class="token punctuation">.</span>INSTANT_APP_DEXOPT_ENABLED<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_DEBUGGABLE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>performDexopt<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            DexoptOptions dexoptOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexoptOptions</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                    REASON_INSTALL<span class="token punctuation">,</span>
                    DexoptOptions<span class="token punctuation">.</span>DEXOPT_BOOT_COMPLETE <span class="token operator">|</span>
                    DexoptOptions<span class="token punctuation">.</span>DEXOPT_INSTALL_WITH_DEX_METADATA_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPackageDexOptimizer<span class="token punctuation">.</span><span class="token function">performDexOpt</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> pkg<span class="token punctuation">.</span>usesLibraryFiles<span class="token punctuation">,</span>
                    null <span class="token comment" spellcheck="true">/* instructionSets */</span><span class="token punctuation">,</span>
                    <span class="token function">getOrCreateCompilerPackageStats</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mDexManager<span class="token punctuation">.</span><span class="token function">getPackageUseInfoOrDefault</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dexoptOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>


        BackgroundDexOptService<span class="token punctuation">.</span><span class="token function">notifyPackageChanged</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span>newUsers <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">queryInstalledUsers</span><span class="token punctuation">(</span>sUserManager<span class="token punctuation">.</span><span class="token function">getUserIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ps<span class="token punctuation">.</span><span class="token function">setUpdateAvailable</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*updateAvailable*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分为如下几步：</p>
<ul>
<li><p>1.PackageParser.parsePackage 扫描apk包中完整的<code>AndroidManifest.xml</code>内容，并把解析的package结果缓存到磁盘和内存中</p>
</li>
<li><p>2.往Package对象中设置好签名信息</p>
</li>
<li><p>3.从Settings中获取是否有当前包名对应的PackageSetting 包配置信息，此时还没有则跳开这里的if。获取PermissionManagerService查询权限信息。如果还是能查到，说明是包的升级，此时会进行包权限的校验。判断前后两次是不是内部包含的包权限内容都是一致，而只是顺序变了。当然如果之前没有安装，或者内容不一致，都会触发KeySetManagerService的checkUpgradeKeySetLocked进行更新</p>
</li>
<li><p>4.调用InstallArgs.doRename 把当前的包的名字给更新了</p>
</li>
<li><p>5.判断当前是否允许对包进行校验，如果允许则调用VerityUtils.generateApkVeritySetupData 对包的签名进行校验,校验通过根路径则调用Installd服务进一步调用installApkVerity进行校验。详细就不说了</p>
</li>
<li><p>6.installNewPackageLIF </p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installNewPackageLIF</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span>
          <span class="token keyword">final</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">,</span> String installerPackageName<span class="token punctuation">,</span>
          String volumeUuid<span class="token punctuation">,</span> PackageInstalledInfo res<span class="token punctuation">,</span> <span class="token keyword">int</span> installReason<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      String pkgName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>

      <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">final</span> String renamedPackage <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getRenamedPackageLPr</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>renamedPackage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

              <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          PackageParser<span class="token punctuation">.</span>Package newPackage <span class="token operator">=</span> <span class="token function">scanPackageTracedLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                  System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token function">updateSettingsLI</span><span class="token punctuation">(</span>newPackage<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">,</span> null<span class="token punctuation">,</span> res<span class="token punctuation">,</span> user<span class="token punctuation">,</span> installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">prepareAppDataAfterInstallLIF</span><span class="token punctuation">(</span>newPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token punctuation">}</span>

  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.调用scanPackageTracedLI 扫描包内容，此时其实已经解析过一次包内容，在这里能直接获得缓存。</p>
</li>
<li><p>2.updateSettingsLI 更新Settings中的包配置对象也就是PackageSettings对象以及往Settings的<code>package.list</code>和<code>package.xml</code>写入配置内容。关于这两个文件可以阅读<a href="https://www.jianshu.com/p/2afddb959b67" target="_blank" rel="noopener">PackageManagerService的启动与安装(上)</a>。</p>
</li>
<li><p>3.prepareAppDataAfterInstallLIF核心还是调用了prepareAppDataLeafLIF方法，关于这个方法还是可以阅读<a href="https://www.jianshu.com/p/2afddb959b67" target="_blank" rel="noopener">PackageManagerService的启动与安装(上)</a>。实际上就是给下面编译优化的结果文件，创建对应的目录在每一个包下面创建<code>cache</code>或者<code>code_cache</code>文件夹，并且生成加速dex2oat编译的<code>.prof</code>文件.</p>
</li>
</ul>
</li>
</ul>
<ul>
<li>7.prepareAppProfiles 调用<code>/system/bin/profman</code>生成加速dex2oat编译的<code>.prof</code>文件</li>
</ul>
<ul>
<li>8.PackageDexOptimizer.performDexOpt 进行dexopt 对dex文件进行优化</li>
</ul>
<p>我们再来看看其中核心的scanPackageTracedLI 以及InstallArgs.doRename</p>
<h5 id="PMS-scanPackageTracedLI"><a href="#PMS-scanPackageTracedLI" class="headerlink" title="PMS scanPackageTracedLI"></a>PMS scanPackageTracedLI</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageLI</span><span class="token punctuation">(</span>File scanFile<span class="token punctuation">,</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span>
            <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>
        PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pp<span class="token punctuation">.</span><span class="token function">setSeparateProcesses</span><span class="token punctuation">(</span>mSeparateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pp<span class="token punctuation">.</span><span class="token function">setOnlyCoreApps</span><span class="token punctuation">(</span>mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pp<span class="token punctuation">.</span><span class="token function">setDisplayMetrics</span><span class="token punctuation">(</span>mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pp<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>mPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            pkg <span class="token operator">=</span> pp<span class="token punctuation">.</span><span class="token function">parsePackage</span><span class="token punctuation">(</span>scanFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isStaticSharedLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">renameStaticSharedLibraryPackage</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面的很简单又一次的调用了parsePackage，这一次是直接从缓存中读取出了完成的package信息，接着调用scanPackageChildLI。</p>
<h6 id="scanPackageChildLI"><a href="#scanPackageChildLI" class="headerlink" title="scanPackageChildLI"></a>scanPackageChildLI</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span>
                    <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>childPackages <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                scanFlags <span class="token operator">|=</span> SCAN_CHECK_ONLY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            scanFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>SCAN_CHECK_ONLY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Scan the parent</span>
        PackageParser<span class="token punctuation">.</span>Package scannedPkg <span class="token operator">=</span> <span class="token function">addForInitLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span>
                scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> childCount <span class="token operator">=</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>childPackages <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageParser<span class="token punctuation">.</span>Package childPackage <span class="token operator">=</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addForInitLI</span><span class="token punctuation">(</span>childPackage<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                    currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> scannedPkg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里面会不断的递归整个目录结构中所有的可能的子包。我们不需要理解也ok，关键是addForInitLI 对每一个安装包的package会进行一次初始化。这个方法对于新包来说核心的逻辑在于其中的<code>scanPackageNewLI</code></p>
<h6 id="scanPackageNewLI"><a href="#scanPackageNewLI" class="headerlink" title="scanPackageNewLI"></a>scanPackageNewLI</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageNewLI</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        scanFlags <span class="token operator">=</span> <span class="token function">adjustScanFlags</span><span class="token punctuation">(</span>scanFlags<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span> disabledPkgSetting<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">boolean</span> scanSucceeded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ScanRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanRequest</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> sharedUserSetting<span class="token punctuation">,</span>
                        pkgSetting <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> pkgSetting<span class="token punctuation">.</span>pkg<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span> disabledPkgSetting<span class="token punctuation">,</span>
                        originalPkgSetting<span class="token punctuation">,</span> realPkgName<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span>pkg <span class="token operator">==</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> ScanResult result <span class="token operator">=</span> <span class="token function">scanPackageOnlyLI</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mFactoryTest<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">commitScanResultsLocked</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                scanSucceeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心是调用了commitScanResultsLocked，这个方法对把扫描后的内容同步到PackageSettings，等待后续的写入到缓存文件中。对于全新的包则会做如下处理:</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newPkgSettingCreated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>originalPkgSetting <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSettings<span class="token punctuation">.</span><span class="token function">addRenamedPackageLPw</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> originalPkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mSettings<span class="token punctuation">.</span><span class="token function">addUserToSettingLPw</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>originalPkgSetting <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mTransferedPackages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>originalPkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是Settings的addUserToSettingLPw 为新的包分配全新的userId。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">addUserToSettingLPw</span><span class="token punctuation">(</span>PackageSetting p<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>appId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            p<span class="token punctuation">.</span>appId <span class="token operator">=</span> <span class="token function">newUserIdLPw</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">addUserIdLPw</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>appId<span class="token punctuation">,</span> p<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>appId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在ApplicationInfo 没有记录appid也就是没有分配过userId的情况下，会调用newUserIdLPw进行分配</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> FIRST_APPLICATION_UID <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> LAST_APPLICATION_UID <span class="token operator">=</span> <span class="token number">19999</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">newUserIdLPw</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> mUserIds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mFirstAvailableUid<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mUserIds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mUserIds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Process<span class="token punctuation">.</span>FIRST_APPLICATION_UID <span class="token operator">+</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">></span> <span class="token punctuation">(</span>Process<span class="token punctuation">.</span>LAST_APPLICATION_UID<span class="token operator">-</span>Process<span class="token punctuation">.</span>FIRST_APPLICATION_UID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mUserIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Process<span class="token punctuation">.</span>FIRST_APPLICATION_UID <span class="token operator">+</span> N<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就查找当前的mUserIds中有多少空闲的uid，找到则拿到对应的index,设置UserId为：</p>
<blockquote>
<p>uid = 10000 + index</p>
</blockquote>
<h5 id="InstallArgs-doRename"><a href="#InstallArgs-doRename" class="headerlink" title="InstallArgs.doRename"></a>InstallArgs.doRename</h5><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">boolean</span> <span class="token function">doRename</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">,</span> PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span> String oldCodePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">final</span> File targetDir <span class="token operator">=</span> codeFile<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> File beforeCodeFile <span class="token operator">=</span> codeFile<span class="token punctuation">;</span>
            <span class="token keyword">final</span> File afterCodeFile <span class="token operator">=</span> <span class="token function">getNextCodePath</span><span class="token punctuation">(</span>targetDir<span class="token punctuation">,</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                Os<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>beforeCodeFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> afterCodeFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SELinux<span class="token punctuation">.</span><span class="token function">restoreconRecursive</span><span class="token punctuation">(</span>afterCodeFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            codeFile <span class="token operator">=</span> afterCodeFile<span class="token punctuation">;</span>
            resourceFile <span class="token operator">=</span> afterCodeFile<span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                pkg<span class="token punctuation">.</span><span class="token function">setCodePath</span><span class="token punctuation">(</span>afterCodeFile<span class="token punctuation">.</span><span class="token function">getCanonicalPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pkg<span class="token punctuation">.</span><span class="token function">setBaseCodePath</span><span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">rewriteAfterRename</span><span class="token punctuation">(</span>beforeCodeFile<span class="token punctuation">,</span>
                    afterCodeFile<span class="token punctuation">,</span> pkg<span class="token punctuation">.</span>baseCodePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setSplitCodePaths</span><span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">rewriteAfterRename</span><span class="token punctuation">(</span>beforeCodeFile<span class="token punctuation">,</span>
                    afterCodeFile<span class="token punctuation">,</span> pkg<span class="token punctuation">.</span>splitCodePaths<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Reflect the rename in app info</span>
            pkg<span class="token punctuation">.</span><span class="token function">setApplicationVolumeUuid</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setApplicationInfoCodePath</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setApplicationInfoBaseCodePath</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>baseCodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setApplicationInfoSplitCodePaths</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>splitCodePaths<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setApplicationInfoResourcePath</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setApplicationInfoBaseResourcePath</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>baseCodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setApplicationInfoSplitResourcePaths</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>splitCodePaths<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里存在两种路径，一种是变化前的路径，名字为<code>/data/app/vmdlsessionId/base.apk</code>,另一种是安装后的路径，通过如下getNextCodePath方法获得：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> File <span class="token function">getNextCodePath</span><span class="token punctuation">(</span>File targetDir<span class="token punctuation">,</span> String packageName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        File result<span class="token punctuation">;</span>
        SecureRandom random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            random<span class="token punctuation">.</span><span class="token function">nextBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String suffix <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> Base64<span class="token punctuation">.</span>URL_SAFE <span class="token operator">|</span> Base64<span class="token punctuation">.</span>NO_WRAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>targetDir<span class="token punctuation">,</span> packageName <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>targetDir是指<code>/data/app/vmdlsessionId.tmp/</code>的父目录<code>/data/app/</code> 那么此时就是设置为<code>/data/app/包名-随机数</code></p>
<h5 id="发送POST-INSTALL-Handler消息到PackageHandler中处理"><a href="#发送POST-INSTALL-Handler消息到PackageHandler中处理" class="headerlink" title="发送POST_INSTALL Handler消息到PackageHandler中处理"></a>发送POST_INSTALL Handler消息到PackageHandler中处理</h5><p>当安装完成后就会发送POST_INSTALL 处理安装完的内容</p>
<pre class="line-numbers language-java"><code class="language-java">                <span class="token keyword">case</span> POST_INSTALL<span class="token operator">:</span> <span class="token punctuation">{</span>
                    PostInstallData data <span class="token operator">=</span> mRunningInstalls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token keyword">boolean</span> didRestore <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>arg2 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mRunningInstalls<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        InstallArgs args <span class="token operator">=</span> data<span class="token punctuation">.</span>args<span class="token punctuation">;</span>
                        PackageInstalledInfo parentRes <span class="token operator">=</span> data<span class="token punctuation">.</span>res<span class="token punctuation">;</span>

                        <span class="token keyword">final</span> <span class="token keyword">boolean</span> grantPermissions <span class="token operator">=</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>installFlags
                                <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_GRANT_RUNTIME_PERMISSIONS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> <span class="token keyword">boolean</span> killApp <span class="token operator">=</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>installFlags
                                <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_DONT_KILL_APP<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> <span class="token keyword">boolean</span> virtualPreload <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>installFlags
                                <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_VIRTUAL_PRELOAD<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> grantedPermissions <span class="token operator">=</span> args<span class="token punctuation">.</span>installGrantPermissions<span class="token punctuation">;</span>

                        <span class="token function">handlePackagePostInstall</span><span class="token punctuation">(</span>parentRes<span class="token punctuation">,</span> grantPermissions<span class="token punctuation">,</span> killApp<span class="token punctuation">,</span>
                                virtualPreload<span class="token punctuation">,</span> grantedPermissions<span class="token punctuation">,</span> didRestore<span class="token punctuation">,</span>
                                args<span class="token punctuation">.</span>installerPackageName<span class="token punctuation">,</span> args<span class="token punctuation">.</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">final</span> <span class="token keyword">int</span> childCount <span class="token operator">=</span> <span class="token punctuation">(</span>parentRes<span class="token punctuation">.</span>addedChildPackages <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                                <span class="token operator">?</span> parentRes<span class="token punctuation">.</span>addedChildPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            PackageInstalledInfo childRes <span class="token operator">=</span> parentRes<span class="token punctuation">.</span>addedChildPackages<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">handlePackagePostInstall</span><span class="token punctuation">(</span>childRes<span class="token punctuation">,</span> grantPermissions<span class="token punctuation">,</span> killApp<span class="token punctuation">,</span>
                                    virtualPreload<span class="token punctuation">,</span> grantedPermissions<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*didRestore*/</span><span class="token punctuation">,</span>
                                    args<span class="token punctuation">.</span>installerPackageName<span class="token punctuation">,</span> args<span class="token punctuation">.</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>


                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心方法是handlePackagePostInstall，这个方法发送了如下几种广播：</p>
<ul>
<li>1.Intent.ACTION_PACKAGE_ADDED 包添加广播</li>
<li>2.Intent.ACTION_PACKAGE_REPLACED 包替换广播<br>最后还会获取到保存在InstallArgs的IPackageInstallObserver2 ，回调onPackageInstalled。也就是在PackageInstallSession的commit流程中生成的对象，而这个方法又会调用dispatchSessionFinished</li>
</ul>
<h4 id="PackageInstallSession-dispatchSessionFinished"><a href="#PackageInstallSession-dispatchSessionFinished" class="headerlink" title="PackageInstallSession dispatchSessionFinished"></a>PackageInstallSession dispatchSessionFinished</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dispatchSessionFinished</span><span class="token punctuation">(</span><span class="token keyword">int</span> returnCode<span class="token punctuation">,</span> String msg<span class="token punctuation">,</span> Bundle extras<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> IPackageInstallObserver2 observer<span class="token punctuation">;</span>
        <span class="token keyword">final</span> String packageName<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mFinalStatus <span class="token operator">=</span> returnCode<span class="token punctuation">;</span>
            mFinalMessage <span class="token operator">=</span> msg<span class="token punctuation">;</span>

            observer <span class="token operator">=</span> mRemoteObserver<span class="token punctuation">;</span>
            packageName <span class="token operator">=</span> mPackageName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> SomeArgs args <span class="token operator">=</span> SomeArgs<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            args<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> packageName<span class="token punctuation">;</span>
            args<span class="token punctuation">.</span>arg2 <span class="token operator">=</span> msg<span class="token punctuation">;</span>
            args<span class="token punctuation">.</span>arg3 <span class="token operator">=</span> extras<span class="token punctuation">;</span>
            args<span class="token punctuation">.</span>arg4 <span class="token operator">=</span> observer<span class="token punctuation">;</span>
            args<span class="token punctuation">.</span>argi1 <span class="token operator">=</span> returnCode<span class="token punctuation">;</span>

            mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>MSG_ON_PACKAGE_INSTALLED<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendToTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token punctuation">(</span>returnCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isNewInstall <span class="token operator">=</span> extras <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>extras<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REPLACING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>success <span class="token operator">&amp;&amp;</span> isNewInstall<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPm<span class="token punctuation">.</span><span class="token function">sendSessionCommitBroadcast</span><span class="token punctuation">(</span><span class="token function">generateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mCallback<span class="token punctuation">.</span><span class="token function">onSessionFinished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>做了三件事情：</p>
<ul>
<li>1.发送Handler消息MSG_ON_PACKAGE_INSTALLED</li>
<li>2.发送了一个ACTION_SESSION_COMMITTED广播 发送到InstallEventReceiver</li>
<li>3.回调了onSessionFinished</li>
</ul>
<p>其中第一点的MSG_ON_PACKAGE_INSTALLED的消息处理中又调用了Binder对象mRemoteObserver的onPackageInstalled。此时就会调用PackageInstallObserver也就是PackageInstallerService. PackageInstallObserverAdapter的onPackageInstalled。</p>
<h5 id="PackageInstallObserverAdapter的onPackageInstalled"><a href="#PackageInstallObserverAdapter的onPackageInstalled" class="headerlink" title="PackageInstallObserverAdapter的onPackageInstalled"></a>PackageInstallObserverAdapter的onPackageInstalled</h5><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPackageInstalled</span><span class="token punctuation">(</span>String basePackageName<span class="token punctuation">,</span> <span class="token keyword">int</span> returnCode<span class="token punctuation">,</span> String msg<span class="token punctuation">,</span>
                Bundle extras<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED <span class="token operator">==</span> returnCode <span class="token operator">&amp;&amp;</span> mShowNotification<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> update <span class="token operator">=</span> <span class="token punctuation">(</span>extras <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> extras<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REPLACING<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Notification notification <span class="token operator">=</span> <span class="token function">buildSuccessNotification</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span>
                        mContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>update <span class="token operator">?</span> R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>package_updated_device_owner <span class="token operator">:</span>
                                        R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>package_installed_device_owner<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        basePackageName<span class="token punctuation">,</span>
                        mUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>notification <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    NotificationManager notificationManager <span class="token operator">=</span> <span class="token punctuation">(</span>NotificationManager<span class="token punctuation">)</span>
                            mContext<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>NOTIFICATION_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    notificationManager<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>basePackageName<span class="token punctuation">,</span>
                            SystemMessage<span class="token punctuation">.</span>NOTE_PACKAGE_STATE<span class="token punctuation">,</span>
                            notification<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> Intent fillIn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fillIn<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_PACKAGE_NAME<span class="token punctuation">,</span> basePackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fillIn<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_SESSION_ID<span class="token punctuation">,</span> mSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fillIn<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_STATUS<span class="token punctuation">,</span>
                    PackageManager<span class="token punctuation">.</span><span class="token function">installStatusToPublicStatus</span><span class="token punctuation">(</span>returnCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fillIn<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_STATUS_MESSAGE<span class="token punctuation">,</span>
                    PackageManager<span class="token punctuation">.</span><span class="token function">installStatusToString</span><span class="token punctuation">(</span>returnCode<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fillIn<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_LEGACY_STATUS<span class="token punctuation">,</span> returnCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>extras <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> String existing <span class="token operator">=</span> extras<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>
                        PackageManager<span class="token punctuation">.</span>EXTRA_FAILURE_EXISTING_PACKAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>existing<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    fillIn<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_OTHER_PACKAGE_NAME<span class="token punctuation">,</span> existing<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mTarget<span class="token punctuation">.</span><span class="token function">sendIntent</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fillIn<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SendIntentException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时就会调用NotificationManager 出现一个通知栏告诉用户已经安装好了apk了。</p>
<h5 id="InstallEventReceiver-接受到广播后的处理"><a href="#InstallEventReceiver-接受到广播后的处理" class="headerlink" title="InstallEventReceiver 接受到广播后的处理"></a>InstallEventReceiver 接受到广播后的处理</h5><p>当这个对象接受到广播后，就会调用EventResultPersister的onEventReceived</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">onEventReceived</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> status <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_STATUS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> PackageInstaller<span class="token punctuation">.</span>STATUS_PENDING_USER_ACTION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_INTENT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> id <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>EXTRA_ID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String statusMessage <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_STATUS_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> legacyStatus <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_LEGACY_STATUS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        EventResultObserver observerToCall <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> numObservers <span class="token operator">=</span> mObservers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numObservers<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mObservers<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    observerToCall <span class="token operator">=</span> mObservers<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mObservers<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>observerToCall <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                observerToCall<span class="token punctuation">.</span><span class="token function">onResult</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> legacyStatus<span class="token punctuation">,</span> statusMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mResults<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EventResult</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> legacyStatus<span class="token punctuation">,</span> statusMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">writeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里很简单从EXTRA_ID 中获取当前EventResultObserver对应的id，并且回调onResult。此时就会回调到InstallInstalling的launchFinishBasedOnResult方法中。</p>
<h5 id="InstallInstalling-launchFinishBasedOnResult"><a href="#InstallInstalling-launchFinishBasedOnResult" class="headerlink" title="InstallInstalling launchFinishBasedOnResult"></a>InstallInstalling launchFinishBasedOnResult</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">launchFinishBasedOnResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> statusCode<span class="token punctuation">,</span> <span class="token keyword">int</span> legacyStatus<span class="token punctuation">,</span> String statusMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode <span class="token operator">==</span> PackageInstaller<span class="token punctuation">.</span>STATUS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">launchSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">launchFailure</span><span class="token punctuation">(</span>legacyStatus<span class="token punctuation">,</span> statusMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单就是显示成功或者失败的页面。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到这里PMS的安装全流程就解析完了，虽然有不少的地方说不详细，但是总体架构在这里了，需要探索哪一点可以继续根据这个框架去阅读源码即可。老规矩，先上一个时序图，流程很长，注意这里我没有把所有的AysncTask中的流程显示出来，能意会就好：<br><img src="/images/PMS%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B.jpg" alt="PMS安装流程.jpg"></p>
<p>在PMS的安装过程，总结来说就是两个步骤：</p>
<ul>
<li>1.拷贝apk</li>
<li>2.解析apk，把解析的内容缓存到Andoid系统，把包内容保存在配置中。</li>
</ul>
<p>apk的拷贝过程，经过了如下几次变化，我们以此为线索梳理其流程：</p>
<ul>
<li><p>1.<code>来源apk uri</code> -&gt; <code>/data/no_backup/packagexxx.apk</code> .</p>
</li>
<li><p>2.<code>/data/no_backup/packagexxx.apk</code><br>-&gt; <code>/data/app/vmdlsessionId.tmp/PackageInstaller</code> 这个过程中还记录了PackageInstallerSession的记录，保存在<code>/data/system/install_sessions.xml</code> 中。这个过程是通过PackageInstallerService创建一个Session对象时候进行记录，这样就能得知Android系统中曾经出现过多少次安装记录，可能出现多少残余的数据需要清除。 </p>
</li>
<li><p>3.<code>/data/app/vmdlsessionId.tmp/PackageInstaller</code> -&gt; 会变化为另外一个sessionId对应的<code>/data/app/vmdlsessionId.tmp/base.apk</code> 这个过程因为可能会复用sessionId，因此需要先删除一些之前可能遗留下来的残留文件，接着就会创建一个临时的<code>/data/app/vmdlsessionId.tmp/lib</code>保存so库 </p>
</li>
</ul>
<ul>
<li><p>4.<code>/data/app/vmdlsessionId2.tmp/base.apk</code> 重命名为 <code>/data/app/包名-随机数</code><br>在这个过程最为核心，就是整个PMS的安装核心如下：</p>
<ul>
<li><p>4.1.PackageParser.parsePackage 解析包AndroidManifest所有内容，缓存到<code>data/system/package_cache/包名_0</code>中</p>
</li>
<li><p>4.2.scanPackageTracedLI 虽然这个方法也有扫描包内容的能力，但是这里更加重要的是为每一个apk包设置好PackageSettings对象，准备写入到Settings中<code>packages.xml</code>中，并为每一个新安装的apk设置好自己的userid(10000 + index).</p>
</li>
<li><p>4.3. updateSettingsLI  把包配置设置到<code>packages.xml</code></p>
</li>
<li><p>4.4. prepareAppDataAfterInstallLIF, prepareAppProfiles,PackageDexOptimizer.performDexOpt都是对dex文件的优化提供环境:</p>
<ul>
<li>4.4.1prepareAppDataAfterInstallLIF提供目录结构<code>/data/user/用户ID/包名/cache</code> 或<code>/data/user/用户ID/包名/code_cache</code></li>
<li>4.4.2.调用了Installd的fixupAppData方法,创建一个/data/user/用户id和/data/data目录，也就是我们常见的/data/user/0./data/user/用户id是/data/data的软链接</li>
<li>4.4.2.prepareAppProfiles 提供加速编译的文件</li>
<li>4.4.3.performDexOpt 执行dexopt</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>4.5. doRename 重命名</p>
</li>
<li><p>5.最后发送POST_INSTALL消息，通过IPackageInstallObserver2回调，通知此时又调用DefaultContainerService记录好的Binder的onPackageInstalled 展示一个通知栏通知，告诉用户已经安装完毕</p>
</li>
<li><p>6.IPackageInstallObserver2回调 回调中也会发送一个广播消息，告诉正在等待安装结果的InstallInstalling 页面展示安装成功提示。</p>
</li>
</ul>
<h2 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h2><p>到这里PMS的全流程就结束了，能看到有一个很核心的内容，performDexOpt是是如何优化dex还没有聊到。这是一个比较重要的内容，但是学习的门槛有点高，需要熟悉ART 虚拟机。</p>
<p>不过没关系，我对ART虚拟机源码也来回看了几遍，之后我会开启新的篇章，名为JVM基础系列，让我们恶补一下关于Java的“基础”吧，看看网上哪些优化的言论，看看网上哪些常用的说法是否正确。要达到这个能力还需要自己亲自去底层看看ART是怎么设计的。通过对JVM的理解，可以加深对Java编程的理解。</p>
<p>在这之前，我们还只是在单机世界中兜兜转转，下一个篇章应该是来总结网络相关的知识，就以解析OkHttp开始，看看socket的底层设计吧。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/09/06/android-chong-xue-xi-lie-binder-de-zong-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Android 重学系列 Binder的总结">
                        
                        <span class="card-title">Android 重学系列 Binder的总结</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言本文实际上是Android 重学系列 Binder驱动相关知识的总结。关于Binder驱动的源码分析我划分出了6部分：

1.Binder驱动的初始化 syscall原理
2.Binder驱动的初始化 mmap映射原理
3.Binder
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-09-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Binder/" class="post-category">
                                    Binder
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                    <a href="/tags/Linux-kernel/">
                        <span class="chip bg-color">Linux kernel</span>
                    </a>
                    
                    <a href="/tags/Binder/">
                        <span class="chip bg-color">Binder</span>
                    </a>
                    
                    <a href="/tags/系统调用/">
                        <span class="chip bg-color">系统调用</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/08/22/android-chong-xue-xi-lie-packagemanagerservice-de-qi-dong-yu-an-zhuang/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Android重学系列 PackageManagerService的启动与安装(上)">
                        
                        <span class="card-title">Android重学系列 PackageManagerService的启动与安装(上)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言PackageManagerService 是Android系统中对所有apk包的管理服务中心，之后我将成其为PMS。PMS除了管理所有已经安装好的apk包的数据，还包含了安装apk的服务，让我们一探究竟。
正文PMS的启动PMS的启动
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-08-22
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/PMS/" class="post-category">
                                    PMS
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
