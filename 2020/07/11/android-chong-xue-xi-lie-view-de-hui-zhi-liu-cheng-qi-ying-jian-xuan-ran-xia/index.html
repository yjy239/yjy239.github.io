<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 View的绘制流程(七) 硬件渲染(下), Android | Linux | Flutter">
    <meta name="description" content="前言上一篇文章，我们一直聊到了ThreadedRenderer的setFrameCallback方法，就停止下来了。本文继续沿着setFrameCallback的逻辑来看看ThreadedRenderer中做了什么。
我们继续考察下面这个代">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 View的绘制流程(七) 硬件渲染(下) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 View的绘制流程(七) 硬件渲染(下)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/View的绘制流程/" class="post-category">
                                View的绘制流程
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-07-11
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        14.3k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        63 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇文章，我们一直聊到了ThreadedRenderer的setFrameCallback方法，就停止下来了。本文继续沿着setFrameCallback的逻辑来看看ThreadedRenderer中做了什么。</p>
<p>我们继续考察下面这个代码段的逻辑：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">draw</span><span class="token punctuation">(</span>View view<span class="token punctuation">,</span> AttachInfo attachInfo<span class="token punctuation">,</span> DrawCallbacks callbacks<span class="token punctuation">,</span>
            FrameDrawingCallback frameDrawingCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        attachInfo<span class="token punctuation">.</span>mIgnoreDirtyState <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> Choreographer choreographer <span class="token operator">=</span> attachInfo<span class="token punctuation">.</span>mViewRootImpl<span class="token punctuation">.</span>mChoreographer<span class="token punctuation">;</span>
        choreographer<span class="token punctuation">.</span>mFrameInfo<span class="token punctuation">.</span><span class="token function">markDrawStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">updateRootDisplayList</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>

        attachInfo<span class="token punctuation">.</span>mIgnoreDirtyState <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>attachInfo<span class="token punctuation">.</span>mPendingAnimatingRenderNodes <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> count <span class="token operator">=</span> attachInfo<span class="token punctuation">.</span>mPendingAnimatingRenderNodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">registerAnimatingRenderNode</span><span class="token punctuation">(</span>
                        attachInfo<span class="token punctuation">.</span>mPendingAnimatingRenderNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            attachInfo<span class="token punctuation">.</span>mPendingAnimatingRenderNodes<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachInfo<span class="token punctuation">.</span>mPendingAnimatingRenderNodes <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> frameInfo <span class="token operator">=</span> choreographer<span class="token punctuation">.</span>mFrameInfo<span class="token punctuation">.</span>mFrameInfo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frameDrawingCallback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">nSetFrameCallback</span><span class="token punctuation">(</span>mNativeProxy<span class="token punctuation">,</span> frameDrawingCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> syncResult <span class="token operator">=</span> <span class="token function">nSyncAndDrawFrame</span><span class="token punctuation">(</span>mNativeProxy<span class="token punctuation">,</span> frameInfo<span class="token punctuation">,</span> frameInfo<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>syncResult <span class="token operator">&amp;</span> SYNC_LOST_SURFACE_REWARD_IF_FOUND<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachInfo<span class="token punctuation">.</span>mViewRootImpl<span class="token punctuation">.</span>mSurface<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachInfo<span class="token punctuation">.</span>mViewRootImpl<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>syncResult <span class="token operator">&amp;</span> SYNC_INVALIDATE_REQUIRED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            attachInfo<span class="token punctuation">.</span>mViewRootImpl<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上一篇文章，我们聊到了nSetFrameCallback就戛然而止，本文将继续讨论下面的方法。</p>
<p>如果遇到疑问欢迎来到<a href="https://www.jianshu.com/p/4854d9fcc55e" target="_blank" rel="noopener">https://www.jianshu.com/p/4854d9fcc55e</a>下讨论。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="ThreadedRenderer-nSetFrameCallback"><a href="#ThreadedRenderer-nSetFrameCallback" class="headerlink" title="ThreadedRenderer nSetFrameCallback"></a>ThreadedRenderer nSetFrameCallback</h2><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_view_ThreadedRenderer.cpp" target="_blank" rel="noopener">android_view_ThreadedRenderer.cpp</a></p>
<p>接着在ThreadedRenderer的draw方法遍历完整个View树后会设置一个回调FrameCallback在底层。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_view_ThreadedRenderer_setFrameCallback</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
        jobject clazz<span class="token punctuation">,</span> jlong proxyPtr<span class="token punctuation">,</span> jobject frameCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RenderProxy<span class="token operator">*</span> proxy <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RenderProxy<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>proxyPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frameCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        JavaVM<span class="token operator">*</span> vm <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> globalCallbackRef <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>JGlobalRefHolder<span class="token operator">></span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>
                env<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewGlobalRef</span><span class="token punctuation">(</span>frameCallback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        proxy<span class="token operator">-</span><span class="token operator">></span><span class="token function">setFrameCallback</span><span class="token punctuation">(</span><span class="token punctuation">[</span>globalCallbackRef<span class="token punctuation">]</span><span class="token punctuation">(</span>int64_t frameNr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            JNIEnv<span class="token operator">*</span> env <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span>globalCallbackRef<span class="token operator">-</span><span class="token operator">></span><span class="token function">vm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>globalCallbackRef<span class="token operator">-</span><span class="token operator">></span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gFrameDrawingCallback<span class="token punctuation">.</span>onFrameDraw<span class="token punctuation">,</span>
                    <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>jlong<span class="token operator">></span><span class="token punctuation">(</span>frameNr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="RenderProxy-setFrameCallback"><a href="#RenderProxy-setFrameCallback" class="headerlink" title="RenderProxy setFrameCallback"></a>RenderProxy setFrameCallback</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/" target="_blank" rel="noopener">renderthread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/RenderProxy.cpp" target="_blank" rel="noopener">RenderProxy.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderProxy<span class="token operator">::</span><span class="token function">setFrameCallback</span><span class="token punctuation">(</span>std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>int64_t<span class="token punctuation">)</span><span class="token operator">></span><span class="token operator">&amp;&amp;</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mDrawFrameTask<span class="token punctuation">.</span><span class="token function">setFrameCallback</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>很简单实际上就是把这个方法设置给DrawFrameTask的mFrameCallback方法指针中。</p>
<h2 id="ThreadedRenderer-nSyncAndDrawFrame"><a href="#ThreadedRenderer-nSyncAndDrawFrame" class="headerlink" title="ThreadedRenderer nSyncAndDrawFrame"></a>ThreadedRenderer nSyncAndDrawFrame</h2><p>前面的步骤都只是对绘制的准备，而在这个步骤开始才是真正开始绘制图层。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">android_view_ThreadedRenderer_syncAndDrawFrame</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span>
        jlong proxyPtr<span class="token punctuation">,</span> jlongArray frameInfo<span class="token punctuation">,</span> jint frameInfoSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RenderProxy<span class="token operator">*</span> proxy <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RenderProxy<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>proxyPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetLongArrayRegion</span><span class="token punctuation">(</span>frameInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> frameInfoSize<span class="token punctuation">,</span> proxy<span class="token operator">-</span><span class="token operator">></span><span class="token function">frameInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> proxy<span class="token operator">-</span><span class="token operator">></span><span class="token function">syncAndDrawFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上还是调用了RenderProxy的syncAndDrawFrame方法。实际上很简单，就是调用了mDrawFrameTask的drawFrame方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> RenderProxy<span class="token operator">::</span><span class="token function">syncAndDrawFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mDrawFrameTask<span class="token punctuation">.</span><span class="token function">drawFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="DrawFrameTask-drawFrame"><a href="#DrawFrameTask-drawFrame" class="headerlink" title="DrawFrameTask drawFrame"></a>DrawFrameTask drawFrame</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> DrawFrameTask<span class="token operator">::</span><span class="token function">drawFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mSyncResult <span class="token operator">=</span> SyncResult<span class="token operator">::</span>OK<span class="token punctuation">;</span>
    mSyncQueued <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span>CLOCK_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">postAndWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> mSyncResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> DrawFrameTask<span class="token operator">::</span><span class="token function">postAndWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    AutoMutex <span class="token function">_lock</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mRenderThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSignal<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中能看到实际上把一个run方法丢到mRenderThread的任务队列中进行排队处理，同时通过mSignal阻塞当前线程。什么时候释放该线程呢？</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> DrawFrameTask<span class="token operator">::</span><span class="token function">unblockUiThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    AutoMutex <span class="token function">_lock</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSignal<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>当处理完一次绘制操作后，就会调用unblockUiThread释放当前线程的阻塞。核心方法如下：</p>
<h4 id="DrawFrameTask-run"><a href="#DrawFrameTask-run" class="headerlink" title="DrawFrameTask run"></a>DrawFrameTask run</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> DrawFrameTask<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">bool</span> canUnblockUiThread<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> canDrawThisFrame<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        TreeInfo <span class="token function">info</span><span class="token punctuation">(</span>TreeInfo<span class="token operator">::</span>MODE_FULL<span class="token punctuation">,</span> <span class="token operator">*</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        canUnblockUiThread <span class="token operator">=</span> <span class="token function">syncFrameState</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        canDrawThisFrame <span class="token operator">=</span> info<span class="token punctuation">.</span>out<span class="token punctuation">.</span>canDrawThisFrame<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mFrameCompleteCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mContext<span class="token operator">-</span><span class="token operator">></span><span class="token function">addFrameCompleteListener</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>mFrameCompleteCallback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mFrameCompleteCallback <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    CanvasContext<span class="token operator">*</span> context <span class="token operator">=</span> mContext<span class="token punctuation">;</span>
    std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>int64_t<span class="token punctuation">)</span><span class="token operator">></span> callback <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>mFrameCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mFrameCallback <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>canUnblockUiThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">unblockUiThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token operator">-</span><span class="token operator">></span><span class="token function">enqueueFrameWork</span><span class="token punctuation">(</span><span class="token punctuation">[</span>callback<span class="token punctuation">,</span> frameNr <span class="token operator">=</span> context<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFrameNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>frameNr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_LIKELY</span><span class="token punctuation">(</span>canDrawThisFrame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token operator">-</span><span class="token operator">></span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        context<span class="token operator">-</span><span class="token operator">></span><span class="token function">waitOnFences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>canUnblockUiThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">unblockUiThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里面可以分为几个步骤：</p>
<ul>
<li>1.为CanvasContext通过addFrameCompleteListener添加一个绘制完毕的回调</li>
<li>2.调用syncFrameState进行Layer的处理，判断是否需要阻塞ui线程。</li>
<li>2.如果不需要阻塞线程，则在绘制之前调用unblockUiThread，把ui线程的阻塞先关闭。</li>
<li>3.通过enqueueFrameWork回调，回调Java层添加的mFrameCallback监听。</li>
<li>4.如果可以绘制当前这一帧，则调用CanvasContext的draw绘制，否则说明硬件的绘制栏栅没有释放，需要对fence进行等待。</li>
<li>5.如果需要阻塞线程，说明之前没有释放过阻塞，此时需要进行释放一次。</li>
</ul>
<p>可以看到核心方法有两个：</p>
<ul>
<li>1.syncFrameState 准备渲染树</li>
<li>2.CanvasContext 的draw方法。</li>
</ul>
<p>这两个方法才是真正的执行绘制的行为，只要弄懂了这两个行为就可以明白整个硬件渲染的流程了。</p>
<h3 id="DrawFrameTask-syncFrameState"><a href="#DrawFrameTask-syncFrameState" class="headerlink" title="DrawFrameTask syncFrameState"></a>DrawFrameTask syncFrameState</h3><p>syncFrameState方法其实已经和大家聊过不少。</p>
<p>不过在这里面，如果没有TextureView这种自己先进行绘制图层的情况，更多是进行准备工作。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> DrawFrameTask<span class="token operator">::</span><span class="token function">syncFrameState</span><span class="token punctuation">(</span>TreeInfo<span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    int64_t vsync <span class="token operator">=</span> mFrameInfo<span class="token punctuation">[</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>FrameInfoIndex<span class="token operator">::</span>Vsync<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    mRenderThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">timeLord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">vsyncReceived</span><span class="token punctuation">(</span>vsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> canDraw <span class="token operator">=</span> mContext<span class="token operator">-</span><span class="token operator">></span><span class="token function">makeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mContext<span class="token operator">-</span><span class="token operator">></span><span class="token function">unpinImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mLayers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mLayers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mLayers<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mContext<span class="token operator">-</span><span class="token operator">></span><span class="token function">setContentDrawBounds</span><span class="token punctuation">(</span>mContentDrawBounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mContext<span class="token operator">-</span><span class="token operator">></span><span class="token function">prepareTree</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> mFrameInfo<span class="token punctuation">,</span> mSyncQueued<span class="token punctuation">,</span> mTargetNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> info<span class="token punctuation">.</span>prepareTextures<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>大致上可以分为3步骤：</p>
<ul>
<li><p>1.CanvasContext调用makeCurrent，为OpenGL创建运行上下文。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> CanvasContext<span class="token operator">::</span><span class="token function">makeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mStopped<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> result <span class="token operator">=</span> mRenderPipeline<span class="token operator">-</span><span class="token operator">></span><span class="token function">makeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单实际上就是调用了渲染管道的makeCurrent，此时是指OpenGLPipeline的makeCurrent。而OpenGLPipeline的makeCurrent实际上还是调用EglManager的makeCurrent。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> EglManager<span class="token operator">::</span><span class="token function">makeCurrent</span><span class="token punctuation">(</span>EGLSurface surface<span class="token punctuation">,</span> EGLint<span class="token operator">*</span> errOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrent</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>surface <span class="token operator">==</span> EGL_NO_SURFACE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Ensure we always have a valid surface &amp; context</span>
      surface <span class="token operator">=</span> mPBufferSurface<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">eglMakeCurrent</span><span class="token punctuation">(</span>mEglDisplay<span class="token punctuation">,</span> surface<span class="token punctuation">,</span> surface<span class="token punctuation">,</span> mEglContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
  mCurrentSurface <span class="token operator">=</span> surface<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Properties<span class="token operator">::</span>disableVsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">eglSwapInterval</span><span class="token punctuation">(</span>mEglDisplay<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单就是调用了OpenGL的eglMakeCurrent方法。</p>
</li>
<li><p>2.CanvasContext调用unpinImages。而这个方法实际上调用的是渲染管道OpenGLPipeLine的unpinImages方法。而unpinImages方法是获取之前所有的纹理缓存并且重置。</p>
</li>
<li><p>3.处理保存在mDisplayList的Layer逻辑。在TextureView一文中，打开了Skia标志位，并且由于TextureView本身的特殊性，需要自己在App端进行OpenGL的渲染加工，因此需要压入DeferredLayerUpdater延迟刷新Layer对象对图像进行刷新。详细的内容可以阅读我写的<a href="https://www.jianshu.com/p/1dce98846dc7" target="_blank" rel="noopener">SurfaceView和TextureView 源码浅析(下)</a></p>
</li>
<li><p>4.CanvasContext prepareTree 在绘制之前做最后的准备。而这个方法最后决定了是否要阻塞ui线程。</p>
</li>
</ul>
<h4 id="CanvasContext-prepareTree"><a href="#CanvasContext-prepareTree" class="headerlink" title="CanvasContext prepareTree"></a>CanvasContext prepareTree</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CanvasContext<span class="token operator">::</span><span class="token function">prepareTree</span><span class="token punctuation">(</span>TreeInfo<span class="token operator">&amp;</span> info<span class="token punctuation">,</span> int64_t<span class="token operator">*</span> uiFrameInfo<span class="token punctuation">,</span> int64_t syncQueued<span class="token punctuation">,</span>
                                RenderNode<span class="token operator">*</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mRenderThread<span class="token punctuation">.</span><span class="token function">removeFrameCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mCurrentFrameInfo<span class="token operator">-</span><span class="token operator">></span><span class="token function">importUiThreadInfo</span><span class="token punctuation">(</span>uiFrameInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mCurrentFrameInfo<span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span>FrameInfoIndex<span class="token operator">::</span>SyncQueued<span class="token punctuation">)</span> <span class="token operator">=</span> syncQueued<span class="token punctuation">;</span>
    mCurrentFrameInfo<span class="token operator">-</span><span class="token operator">></span><span class="token function">markSyncStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    info<span class="token punctuation">.</span>damageAccumulator <span class="token operator">=</span> <span class="token operator">&amp;</span>mDamageAccumulator<span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>layerUpdateQueue <span class="token operator">=</span> <span class="token operator">&amp;</span>mLayerUpdateQueue<span class="token punctuation">;</span>

    mAnimationContext<span class="token operator">-</span><span class="token operator">></span><span class="token function">startFrame</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mRenderPipeline<span class="token operator">-</span><span class="token operator">></span><span class="token function">onPrepareTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>RenderNode<span class="token operator">></span><span class="token operator">&amp;</span> node <span class="token operator">:</span> mRenderNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        info<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> target <span class="token operator">?</span> TreeInfo<span class="token operator">::</span>MODE_FULL <span class="token operator">:</span> TreeInfo<span class="token operator">::</span>MODE_RT_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-</span><span class="token operator">></span><span class="token function">prepareTree</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mAnimationContext<span class="token operator">-</span><span class="token operator">></span><span class="token function">runRemainingAnimations</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">freePrefetchedLayers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mIsDirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.mRenderPipeline的onPrepareTree回调</li>
<li>2.mAnimationContext 调用startFrame</li>
<li>3.调用保存在mRenderNodes集合中的RenderNode的prepareTree方法。</li>
<li>4.mAnimationContext runRemainingAnimations</li>
</ul>
<p>关于动画这里的逻辑，我们先不管，先看看第三点。还记得在上文中和大家聊过的在CanvasContext的构造函数中，会先把根部的RenderNode保存到mrenderNodes中。</p>
<p>换句话说，此时是从RootRenderNode的prepareTree开始执行所有的RenderNode。</p>
<h4 id="RootRenderNode-prepareTree"><a href="#RootRenderNode-prepareTree" class="headerlink" title="RootRenderNode prepareTree"></a>RootRenderNode prepareTree</h4><pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">prepareTree</span><span class="token punctuation">(</span>TreeInfo<span class="token operator">&amp;</span> info<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        info<span class="token punctuation">.</span>errorHandler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> anim <span class="token operator">:</span> mRunningVDAnimators<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            anim<span class="token operator">-</span><span class="token operator">></span><span class="token function">getVectorDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">markDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>mode <span class="token operator">==</span> TreeInfo<span class="token operator">::</span>MODE_FULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>anim <span class="token operator">:</span> mPausedVDAnimators<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                anim<span class="token operator">-</span><span class="token operator">></span><span class="token function">getVectorDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setPropertyChangeWillBeConsumed</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                anim<span class="token operator">-</span><span class="token operator">></span><span class="token function">getVectorDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">markDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        info<span class="token punctuation">.</span>updateWindowPositions <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        RenderNode<span class="token operator">::</span><span class="token function">prepareTree</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token punctuation">.</span>updateWindowPositions <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        info<span class="token punctuation">.</span>errorHandler <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.首先处理添加到RootRenderNode的mRunningVDAnimators集合，这个集合实际上是在ViewRootImpl通过registerAnimatingRenderNode的添加向量动画。此时把这些集合设置为脏区，告诉之后需要渲染。这里不多进行讨论了。</li>
<li>2.调用父类RenderNode的prepareTree方法。</li>
</ul>
<p>在prepareTree方法中，就会遍历View树中所有内容，转化为一帧帧的内容。</p>
<h5 id="RenderNode-prepareTree"><a href="#RenderNode-prepareTree" class="headerlink" title="RenderNode prepareTree"></a>RenderNode prepareTree</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/RenderNode.cpp" target="_blank" rel="noopener">RenderNode.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderNode<span class="token operator">::</span><span class="token function">prepareTree</span><span class="token punctuation">(</span>TreeInfo<span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MarkAndSweepRemoved <span class="token function">observer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> functorsNeedLayer <span class="token operator">=</span> Properties<span class="token operator">::</span>debugOverdraw <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Properties<span class="token operator">::</span><span class="token function">isSkiaEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prepareTreeImpl</span><span class="token punctuation">(</span>observer<span class="token punctuation">,</span> info<span class="token punctuation">,</span> functorsNeedLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心调用了prepareTreeImpl。</p>
<h5 id="RenderNode-prepareTreeImpl"><a href="#RenderNode-prepareTreeImpl" class="headerlink" title="RenderNode prepareTreeImpl"></a>RenderNode prepareTreeImpl</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderNode<span class="token operator">::</span><span class="token function">prepareTreeImpl</span><span class="token punctuation">(</span>TreeObserver<span class="token operator">&amp;</span> observer<span class="token punctuation">,</span> TreeInfo<span class="token operator">&amp;</span> info<span class="token punctuation">,</span> <span class="token keyword">bool</span> functorsNeedLayer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">.</span>damageAccumulator<span class="token operator">-</span><span class="token operator">></span><span class="token function">pushTransform</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>mode <span class="token operator">==</span> TreeInfo<span class="token operator">::</span>MODE_FULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pushStagingPropertiesChanges</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    uint32_t animatorDirtyMask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">bool</span> willHaveFunctor <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>mode <span class="token operator">==</span> TreeInfo<span class="token operator">::</span>MODE_FULL <span class="token operator">&amp;&amp;</span> mStagingDisplayList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        willHaveFunctor <span class="token operator">=</span> mStagingDisplayList<span class="token operator">-</span><span class="token operator">></span><span class="token function">hasFunctor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mDisplayList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span>mPositionListener<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPositionListener<span class="token operator">-</span><span class="token operator">></span><span class="token function">onPositionUpdated</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">prepareLayer</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> animatorDirtyMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>mode <span class="token operator">==</span> TreeInfo<span class="token operator">::</span>MODE_FULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pushStagingDisplayListChanges</span><span class="token punctuation">(</span>observer<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDisplayList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        info<span class="token punctuation">.</span>out<span class="token punctuation">.</span>hasFunctors <span class="token operator">|</span><span class="token operator">=</span> mDisplayList<span class="token operator">-</span><span class="token operator">></span><span class="token function">hasFunctor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> isDirty <span class="token operator">=</span> mDisplayList<span class="token operator">-</span><span class="token operator">></span><span class="token function">prepareListAndChildren</span><span class="token punctuation">(</span>
                observer<span class="token punctuation">,</span> info<span class="token punctuation">,</span> childFunctorsNeedLayer<span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>RenderNode<span class="token operator">*</span> child<span class="token punctuation">,</span> TreeObserver<span class="token operator">&amp;</span> observer<span class="token punctuation">,</span> TreeInfo<span class="token operator">&amp;</span> info<span class="token punctuation">,</span>
                   <span class="token keyword">bool</span> functorsNeedLayer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    child<span class="token operator">-</span><span class="token operator">></span><span class="token function">prepareTreeImpl</span><span class="token punctuation">(</span>observer<span class="token punctuation">,</span> info<span class="token punctuation">,</span> functorsNeedLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isDirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">damageSelf</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">pushLayerUpdate</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

    info<span class="token punctuation">.</span>damageAccumulator<span class="token operator">-</span><span class="token operator">></span><span class="token function">popTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>记住此时的TreeInfo的mode是TreeInfo::MODE_FULL。</p>
<ul>
<li><p>1.首先在TreeInfo的通过pushTransform把当前的renderNode对象保存在一个脏栈(DirtyStack)中</p>
</li>
<li><p>2.判断DisplayList中的hasFunctor是否为true，也就是DisplayList的functors集合是否为空。而functors实际上是通过Java层的DisplayListCanvas的下面方法添加的：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">drawGLFunctor2</span><span class="token punctuation">(</span><span class="token keyword">long</span> drawGLFunctor<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Runnable releasedCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">nCallDrawGLFunction</span><span class="token punctuation">(</span>mNativeCanvasWrapper<span class="token punctuation">,</span> drawGLFunctor<span class="token punctuation">,</span> releasedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>3.回调位置监听mPositionListener的onPositionUpdated</p>
</li>
<li><p>4.调用pushStagingDisplayListChanges方法，而这个方法就是DisplayList的functors的方法指针执行时机。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderNode<span class="token operator">::</span><span class="token function">damageSelf</span><span class="token punctuation">(</span>TreeInfo<span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRenderable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClipDamageToBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          info<span class="token punctuation">.</span>damageAccumulator<span class="token operator">-</span><span class="token operator">></span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          info<span class="token punctuation">.</span>damageAccumulator<span class="token operator">-</span><span class="token operator">></span><span class="token function">dirty</span><span class="token punctuation">(</span>DIRTY_MIN<span class="token punctuation">,</span> DIRTY_MIN<span class="token punctuation">,</span> DIRTY_MAX<span class="token punctuation">,</span> DIRTY_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> RenderNode<span class="token operator">::</span><span class="token function">pushStagingDisplayListChanges</span><span class="token punctuation">(</span>TreeObserver<span class="token operator">&amp;</span> observer<span class="token punctuation">,</span> TreeInfo<span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mNeedsDisplayListSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mNeedsDisplayListSync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token function">damageSelf</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">syncDisplayList</span><span class="token punctuation">(</span>observer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">damageSelf</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用damageSelf方法，对info进行更新脏区。每一次更新都会获取RenderNode的properties对象中保存RenderNode的宽高作为脏区，更新TreeInfo中记录脏区的数据。</p>
</li>
<li><p>5.执行mDisplayList的prepareListAndChildren方法，最后在回调中调用所有保存在DisplayList中的子RenderNode的prepareTreeImpl。</p>
</li>
</ul>
<h4 id="RenderNode-syncDisplayList"><a href="#RenderNode-syncDisplayList" class="headerlink" title="RenderNode syncDisplayList"></a>RenderNode syncDisplayList</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderNode<span class="token operator">::</span><span class="token function">syncDisplayList</span><span class="token punctuation">(</span>TreeObserver<span class="token operator">&amp;</span> observer<span class="token punctuation">,</span> TreeInfo<span class="token operator">*</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mStagingDisplayList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mStagingDisplayList<span class="token operator">-</span><span class="token operator">></span><span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>RenderNode<span class="token operator">*</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span> child<span class="token operator">-</span><span class="token operator">></span><span class="token function">incParentRefCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">deleteDisplayList</span><span class="token punctuation">(</span>observer<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mDisplayList <span class="token operator">=</span> mStagingDisplayList<span class="token punctuation">;</span>
    mStagingDisplayList <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDisplayList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mDisplayList<span class="token operator">-</span><span class="token operator">></span><span class="token function">syncContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.mStagingDisplayList的updateChildren，增加每一个孩子的引用计数</li>
<li>2.mStagingDisplayList赋值给mDisplayList，调用mDisplayList的syncContents。</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> DisplayList<span class="token operator">::</span><span class="token function">syncContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> iter <span class="token operator">:</span> functors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>iter<span class="token punctuation">.</span>functor<span class="token punctuation">)</span><span class="token punctuation">(</span>DrawGlInfo<span class="token operator">::</span>kModeSync<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> vectorDrawable <span class="token operator">:</span> vectorDrawables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vectorDrawable<span class="token operator">-</span><span class="token operator">></span><span class="token function">syncProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行每一个从Java层传递下来的GL方法指针，其次是处理每一个向量Drawable。</p>
<h4 id="DisplayList-prepareListAndChildren"><a href="#DisplayList-prepareListAndChildren" class="headerlink" title="DisplayList prepareListAndChildren"></a>DisplayList prepareListAndChildren</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> DisplayList<span class="token operator">::</span><span class="token function">prepareListAndChildren</span><span class="token punctuation">(</span>
        TreeObserver<span class="token operator">&amp;</span> observer<span class="token punctuation">,</span> TreeInfo<span class="token operator">&amp;</span> info<span class="token punctuation">,</span> <span class="token keyword">bool</span> functorsNeedLayer<span class="token punctuation">,</span>
        std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>RenderNode<span class="token operator">*</span><span class="token punctuation">,</span> TreeObserver<span class="token operator">&amp;</span><span class="token punctuation">,</span> TreeInfo<span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">)</span><span class="token operator">></span> childFn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">.</span>prepareTextures <span class="token operator">=</span> info<span class="token punctuation">.</span>canvasContext<span class="token punctuation">.</span><span class="token function">pinImages</span><span class="token punctuation">(</span>bitmapResources<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> op <span class="token operator">:</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RenderNode<span class="token operator">*</span> childNode <span class="token operator">=</span> op<span class="token operator">-</span><span class="token operator">></span>renderNode<span class="token punctuation">;</span>
        info<span class="token punctuation">.</span>damageAccumulator<span class="token operator">-</span><span class="token operator">></span><span class="token function">pushTransform</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>op<span class="token operator">-</span><span class="token operator">></span>localMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> childFunctorsNeedLayer <span class="token operator">=</span>
                functorsNeedLayer<span class="token punctuation">;</span>  
        <span class="token function">childFn</span><span class="token punctuation">(</span>childNode<span class="token punctuation">,</span> observer<span class="token punctuation">,</span> info<span class="token punctuation">,</span> childFunctorsNeedLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token punctuation">.</span>damageAccumulator<span class="token operator">-</span><span class="token operator">></span><span class="token function">popTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> isDirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> vectorDrawable <span class="token operator">:</span> vectorDrawables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vectorDrawable<span class="token operator">-</span><span class="token operator">></span><span class="token function">isDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isDirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        vectorDrawable<span class="token operator">-</span><span class="token operator">></span><span class="token function">setPropertyChangeWillBeConsumed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> isDirty<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以的出，实际上是取出了所有的子RenderNode，先通过pushTransform把当前的RenderNode加入到脏栈，接着调用每一个子View的prepareTreeImpl方法，最后再调用damageAccumulator的popTransform推出当前的RenderNode，因为已经把当前的子RenderNode以及其后代RenderNode的总脏区已经计算完毕了。</p>
<p>最后可以注意到 info.prepareTextures这个bool是决定于CanvasContext的pinImages方法的结果。而info.prepareTextures的结果决定了ThreadedRender在绘制时候ui线程是否需要阻塞。</p>
<h5 id="OpenGLPipeline-pinImages"><a href="#OpenGLPipeline-pinImages" class="headerlink" title="OpenGLPipeline::pinImages"></a>OpenGLPipeline::pinImages</h5><p>其核心实际上是调用了OpenGLPipeline::pinImages</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> OpenGLPipeline<span class="token operator">::</span><span class="token function">pinImages</span><span class="token punctuation">(</span>LsaVector<span class="token operator">&lt;</span>sk_sp<span class="token operator">&lt;</span>Bitmap<span class="token operator">>></span><span class="token operator">&amp;</span> images<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TextureCache<span class="token operator">&amp;</span> cache <span class="token operator">=</span> Caches<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textureCache<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> prefetchSucceeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> bitmapResource <span class="token operator">:</span> images<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prefetchSucceeded <span class="token operator">&amp;</span><span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">prefetchAndMarkInUse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> bitmapResource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> prefetchSucceeded<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而在native中会通过TextureCache保存所有之前使用过的Bitmap资源中的纹理id。除非缓存的Bitmap本身的纹理被移除了，或者申请纹理失败了(如申请的图片纹理实在太大)，才会出现prefetchSucceeded为false的情况。</p>
<p>总结来说是否可以进行同步操作，需要判断硬件渲染的Bitmap缓存是否还生效，如果缓存生效则说明可以不阻塞ui线程。如果原来的缓存失败了，为了绘制避免出现割裂感，必须保证ui线程和硬件渲染执行的统一性。</p>
<h5 id="TreeInfo-中DamageAccumulator的职责"><a href="#TreeInfo-中DamageAccumulator的职责" class="headerlink" title="TreeInfo 中DamageAccumulator的职责"></a>TreeInfo 中DamageAccumulator的职责</h5><pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> op <span class="token operator">:</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RenderNode<span class="token operator">*</span> childNode <span class="token operator">=</span> op<span class="token operator">-</span><span class="token operator">></span>renderNode<span class="token punctuation">;</span>
        info<span class="token punctuation">.</span>damageAccumulator<span class="token operator">-</span><span class="token operator">></span><span class="token function">pushTransform</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>op<span class="token operator">-</span><span class="token operator">></span>localMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> childFunctorsNeedLayer <span class="token operator">=</span>
                functorsNeedLayer<span class="token punctuation">;</span>  
        <span class="token function">childFn</span><span class="token punctuation">(</span>childNode<span class="token punctuation">,</span> observer<span class="token punctuation">,</span> info<span class="token punctuation">,</span> childFunctorsNeedLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token punctuation">.</span>damageAccumulator<span class="token operator">-</span><span class="token operator">></span><span class="token function">popTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在TreeInfo中大致可以分为如下3个步骤：</p>
<ul>
<li>1.DamageAccumulator.pushTransform压入RenderNodeop的localMatrix变化矩阵。</li>
<li>2.childFn的方法指针实际上是指子RenderNode的prepareTree方法：<pre class="line-numbers language-cpp"><code class="language-cpp">child<span class="token operator">-</span><span class="token operator">></span><span class="token function">prepareTreeImpl</span><span class="token punctuation">(</span>observer<span class="token punctuation">,</span> info<span class="token punctuation">,</span> functorsNeedLayer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>3.DamageAccumulator.popTransform.</li>
</ul>
<p>这三个步骤DamageAccumulator做了什么呢？</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> DamageAccumulator<span class="token operator">::</span><span class="token function">pushTransform</span><span class="token punctuation">(</span><span class="token keyword">const</span> RenderNode<span class="token operator">*</span> transform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pushCommon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mHead<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">=</span> TransformRenderNode<span class="token punctuation">;</span>
    mHead<span class="token operator">-</span><span class="token operator">></span>renderNode <span class="token operator">=</span> transform<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> DamageAccumulator<span class="token operator">::</span><span class="token function">pushCommon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHead<span class="token operator">-</span><span class="token operator">></span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        DirtyStack<span class="token operator">*</span> nextFrame <span class="token operator">=</span> mAllocator<span class="token punctuation">.</span>create_trivial<span class="token operator">&lt;</span>DirtyStack<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nextFrame<span class="token operator">-</span><span class="token operator">></span>next <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        nextFrame<span class="token operator">-</span><span class="token operator">></span>prev <span class="token operator">=</span> mHead<span class="token punctuation">;</span>
        mHead<span class="token operator">-</span><span class="token operator">></span>next <span class="token operator">=</span> nextFrame<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mHead <span class="token operator">=</span> mHead<span class="token operator">-</span><span class="token operator">></span>next<span class="token punctuation">;</span>
    mHead<span class="token operator">-</span><span class="token operator">></span>pendingDirty<span class="token punctuation">.</span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> DamageAccumulator<span class="token operator">::</span><span class="token function">popTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>mHead<span class="token operator">-</span><span class="token operator">></span>prev <span class="token operator">==</span> mHead<span class="token punctuation">,</span> <span class="token string">"Cannot pop the root frame!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    DirtyStack<span class="token operator">*</span> dirtyFrame <span class="token operator">=</span> mHead<span class="token punctuation">;</span>
    mHead <span class="token operator">=</span> mHead<span class="token operator">-</span><span class="token operator">></span>prev<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>dirtyFrame<span class="token operator">-</span><span class="token operator">></span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> TransformRenderNode<span class="token operator">:</span>
            <span class="token function">applyRenderNodeTransform</span><span class="token punctuation">(</span>dirtyFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> TransformMatrix4<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> TransformNone<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">"Tried to pop an invalid type: %d"</span><span class="token punctuation">,</span> dirtyFrame<span class="token operator">-</span><span class="token operator">></span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>push的过程实际上是申请一个全新的DirtyStack，放在DirtyStack的链表的末尾，这个链表是一个双向指针。把mHead更新为尾部。并设置type为TransformRenderNode，transform为RenderNode。</p>
<p>每当pop操作调用一次就会通过mHead指向的前驱指针找到上一个DirtyStack，并且执行的applyRenderNodeTransform方法以当前RenderNode作为参数。</p>
<h6 id="applyRenderNodeTransform"><a href="#applyRenderNodeTransform" class="headerlink" title="applyRenderNodeTransform"></a>applyRenderNodeTransform</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">mapRect</span><span class="token punctuation">(</span><span class="token keyword">const</span> Matrix4<span class="token operator">*</span> matrix<span class="token punctuation">,</span> <span class="token keyword">const</span> SkRect<span class="token operator">&amp;</span> in<span class="token punctuation">,</span> SkRect<span class="token operator">*</span> out<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    Rect <span class="token function">temp</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_LIKELY</span><span class="token punctuation">(</span><span class="token operator">!</span>matrix<span class="token operator">-</span><span class="token operator">></span><span class="token function">isPerspective</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        matrix<span class="token operator">-</span><span class="token operator">></span><span class="token function">mapRect</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        temp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>DIRTY_MIN<span class="token punctuation">,</span> DIRTY_MIN<span class="token punctuation">,</span> DIRTY_MAX<span class="token punctuation">,</span> DIRTY_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    out<span class="token operator">-</span><span class="token operator">></span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">RECT_ARGS</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> DamageAccumulator<span class="token operator">::</span><span class="token function">applyRenderNodeTransform</span><span class="token punctuation">(</span>DirtyStack<span class="token operator">*</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-</span><span class="token operator">></span>pendingDirty<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> RenderProperties<span class="token operator">&amp;</span> props <span class="token operator">=</span> frame<span class="token operator">-</span><span class="token operator">></span>renderNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getAlpha</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getClipDamageToBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>frame<span class="token operator">-</span><span class="token operator">></span>pendingDirty<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame<span class="token operator">-</span><span class="token operator">></span>pendingDirty<span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            frame<span class="token operator">-</span><span class="token operator">></span>pendingDirty<span class="token punctuation">.</span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">mapRect</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> frame<span class="token operator">-</span><span class="token operator">></span>pendingDirty<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mHead<span class="token operator">-</span><span class="token operator">></span>pendingDirty<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getProjectBackwards</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>frame<span class="token operator">-</span><span class="token operator">></span>pendingDirty<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>记住此时到applyRenderNodeTransform方法的时候，mHead已经指向前驱的DirtyStack，而参数是当前RenderNode对象的DirtyStack。那么做法实际上就很简单了：</p>
<ul>
<li>1.首先获取当前RenderNode的属性，通过交集计算裁剪出当前的脏区。</li>
<li>2.通过mapRect方法把当前的RenderNode的DirtyStack中的pendingDirty（脏区）设置到前驱节点的pendingDirty中。</li>
</ul>
<p>就通过这种递归方式不断用下层的RenderNode和上层的renderNode进行交集计算最终找到需要绘制的区域。</p>
<h3 id="RenderNode-pushLayerUpdate"><a href="#RenderNode-pushLayerUpdate" class="headerlink" title="RenderNode pushLayerUpdate"></a>RenderNode pushLayerUpdate</h3><p>我们回到RenderNode的prepareTreeImpl方法中，当通过RenderNode的prepareTree步骤遍历完所有的View显示层级，就会调用pushLayerUpdate方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderNode<span class="token operator">::</span><span class="token function">pushLayerUpdate</span><span class="token punctuation">(</span>TreeInfo<span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    LayerType layerType <span class="token operator">=</span> <span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">effectiveLayerType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_LIKELY</span><span class="token punctuation">(</span>layerType <span class="token operator">!=</span> LayerType<span class="token operator">::</span>RenderLayer<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRenderable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span><span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span><span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fitsOnLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span><span class="token function">hasLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            renderthread<span class="token operator">::</span>CanvasContext<span class="token operator">::</span><span class="token function">destroyLayer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>canvasContext<span class="token punctuation">.</span><span class="token function">createOrUpdateLayer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">*</span>info<span class="token punctuation">.</span>damageAccumulator<span class="token punctuation">,</span> info<span class="token punctuation">.</span>errorHandler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">damageSelf</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    SkRect dirty<span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>damageAccumulator<span class="token operator">-</span><span class="token operator">></span><span class="token function">peekAtDirty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dirty<span class="token punctuation">)</span><span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>layerUpdateQueue<span class="token operator">-</span><span class="token operator">></span><span class="token function">enqueueLayerWithDamage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> dirty<span class="token punctuation">)</span><span class="token punctuation">;</span>

    info<span class="token punctuation">.</span>canvasContext<span class="token punctuation">.</span><span class="token function">markLayerInUse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程TreeInfo已经通过prepareTree的方法计算完需要刷新的脏区。</p>
<ul>
<li>1.CanvasContext的createOrUpdateLayer方法创建每一个RenderNode的绘制Layer。</li>
<li>2.首先获取通过peekAtDirty获取damageAccumulator中mHead的脏区，这个脏区就是之前通过prepareTree计算出来的顶层脏区，接着通过enqueueLayerWithDamage计算·当前的Layer需要刷新的区域大小以及需要刷新的RenderNode。</li>
</ul>
<p>注意如果判断到RenderNode不是RenderLayer类型则直接返回。实际上RenderNode有在native层三种类型：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">LayerType</span> <span class="token punctuation">{</span>
    None <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    Software <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    RenderLayer <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>只有RenderLayer才是代表硬件渲染，只有打开了RenderLayer的LayerType才会开始构建一个离屏渲染内存。</p>
<p>当然这三个也对应上Java层的三个标志位,在之前的文章已经出现了不少次：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@ViewDebug</span><span class="token punctuation">.</span><span class="token function">ExportedProperty</span><span class="token punctuation">(</span>category <span class="token operator">=</span> <span class="token string">"drawing"</span><span class="token punctuation">,</span> mapping <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@ViewDebug</span><span class="token punctuation">.</span><span class="token function">IntToString</span><span class="token punctuation">(</span>from <span class="token operator">=</span> LAYER_TYPE_NONE<span class="token punctuation">,</span> to <span class="token operator">=</span> <span class="token string">"NONE"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ViewDebug</span><span class="token punctuation">.</span><span class="token function">IntToString</span><span class="token punctuation">(</span>from <span class="token operator">=</span> LAYER_TYPE_SOFTWARE<span class="token punctuation">,</span> to <span class="token operator">=</span> <span class="token string">"SOFTWARE"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ViewDebug</span><span class="token punctuation">.</span><span class="token function">IntToString</span><span class="token punctuation">(</span>from <span class="token operator">=</span> LAYER_TYPE_HARDWARE<span class="token punctuation">,</span> to <span class="token operator">=</span> <span class="token string">"HARDWARE"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> mLayerType <span class="token operator">=</span> LAYER_TYPE_NONE<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认是LAYER_TYPE_NONE。</p>
<h4 id="LayerUpdateQueue-enqueueLayerWithDamage"><a href="#LayerUpdateQueue-enqueueLayerWithDamage" class="headerlink" title="LayerUpdateQueue enqueueLayerWithDamage"></a>LayerUpdateQueue enqueueLayerWithDamage</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> LayerUpdateQueue<span class="token operator">::</span><span class="token function">enqueueLayerWithDamage</span><span class="token punctuation">(</span>RenderNode<span class="token operator">*</span> renderNode<span class="token punctuation">,</span> Rect damage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    damage<span class="token punctuation">.</span><span class="token function">roundOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    damage<span class="token punctuation">.</span><span class="token function">doIntersect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> renderNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> renderNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>damage<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Entry<span class="token operator">&amp;</span> entry <span class="token operator">:</span> mEntries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>renderNode <span class="token operator">==</span> renderNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                entry<span class="token punctuation">.</span>damage<span class="token punctuation">.</span><span class="token function">unionWith</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mEntries<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>renderNode<span class="token punctuation">,</span> damage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先计算当前的脏区和当前RenderNode区域之前的交集。如果计算出来的结果脏区不为空，并且在LayerUpdateQueue的Entry中记录的底层RenderNode和当前的一致则把刷新区域的大小增加并且返回。</p>
<p>如果是新的RenderNode则记录到mEntries中，作为一个全新需要刷新的RenderNode记录。</p>
<h3 id="CanvasContext中离屏渲染相关对象"><a href="#CanvasContext中离屏渲染相关对象" class="headerlink" title="CanvasContext中离屏渲染相关对象"></a>CanvasContext中离屏渲染相关对象</h3><p>再聊这个话题之前，我们先来看看下面几个重要的对象：</p>
<ul>
<li>1.RenderState 渲染器的状态</li>
<li>2.OffscreenBufferPool 离屏渲染内存申请池</li>
<li>3.OffscreenBuffer 离屏渲染内存</li>
</ul>
<h4 id="RenderState"><a href="#RenderState" class="headerlink" title="RenderState"></a>RenderState</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">RenderState</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">private</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    renderthread<span class="token operator">::</span>RenderThread<span class="token operator">&amp;</span> mRenderThread<span class="token punctuation">;</span>
    Caches<span class="token operator">*</span> mCaches <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    Blend<span class="token operator">*</span> mBlend <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    MeshState<span class="token operator">*</span> mMeshState <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    Scissor<span class="token operator">*</span> mScissor <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    Stencil<span class="token operator">*</span> mStencil <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    OffscreenBufferPool<span class="token operator">*</span> mLayerPool <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    std<span class="token operator">::</span>set<span class="token operator">&lt;</span>Layer<span class="token operator">*</span><span class="token operator">></span> mActiveLayers<span class="token punctuation">;</span>
    std<span class="token operator">::</span>set<span class="token operator">&lt;</span>DeferredLayerUpdater<span class="token operator">*</span><span class="token operator">></span> mActiveLayerUpdaters<span class="token punctuation">;</span>
    std<span class="token operator">::</span>set<span class="token operator">&lt;</span>renderthread<span class="token operator">::</span>CanvasContext<span class="token operator">*</span><span class="token operator">></span> mRegisteredContexts<span class="token punctuation">;</span>

    GLsizei mViewportWidth<span class="token punctuation">;</span>
    GLsizei mViewportHeight<span class="token punctuation">;</span>
    GLuint mFramebuffer<span class="token punctuation">;</span>

    pthread_t mThreadId<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在RenderState，存在几个核心对象。</p>
<ul>
<li>1.Caches 关于OpenGL相关的缓存</li>
<li>2.OffscreenBufferPool 离屏渲染缓存池子</li>
<li>3.Layer集合 是绘制像素内存的承载体Layer</li>
<li>4.DeferredLayerUpdater 延时绘制集合，一般是指TextureView中TextureLayer的集合</li>
<li>5.mViewportWidth和mViewportHeight 整个视窗的大小</li>
<li>6.mFramebuffer OpenGL中离屏渲染缓存的id</li>
</ul>
<h4 id="OffscreenBufferPool"><a href="#OffscreenBufferPool" class="headerlink" title="OffscreenBufferPool"></a>OffscreenBufferPool</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">OffscreenBufferPool</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">struct</span> Entry <span class="token punctuation">{</span>
        <span class="token function">Entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token function">Entry</span><span class="token punctuation">(</span><span class="token keyword">const</span> uint32_t layerWidth<span class="token punctuation">,</span> <span class="token keyword">const</span> uint32_t layerHeight<span class="token punctuation">,</span> <span class="token keyword">bool</span> wideColorGamut<span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token function">width</span><span class="token punctuation">(</span>OffscreenBuffer<span class="token operator">::</span><span class="token function">computeIdealDimension</span><span class="token punctuation">(</span>layerWidth<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> <span class="token function">height</span><span class="token punctuation">(</span>OffscreenBuffer<span class="token operator">::</span><span class="token function">computeIdealDimension</span><span class="token punctuation">(</span>layerHeight<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> <span class="token function">wideColorGamut</span><span class="token punctuation">(</span>wideColorGamut<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token keyword">explicit</span> <span class="token function">Entry</span><span class="token punctuation">(</span>OffscreenBuffer<span class="token operator">*</span> layer<span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token function">layer</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span>
                <span class="token punctuation">,</span> <span class="token function">width</span><span class="token punctuation">(</span>layer<span class="token operator">-</span><span class="token operator">></span>texture<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> <span class="token function">height</span><span class="token punctuation">(</span>layer<span class="token operator">-</span><span class="token operator">></span>texture<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> <span class="token function">wideColorGamut</span><span class="token punctuation">(</span>layer<span class="token operator">-</span><span class="token operator">></span>wideColorGamut<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        OffscreenBuffer<span class="token operator">*</span> layer <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        uint32_t width <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        uint32_t height <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> wideColorGamut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// struct Entry</span>

    std<span class="token operator">::</span>multiset<span class="token operator">&lt;</span>Entry<span class="token operator">></span> mPool<span class="token punctuation">;</span>

    uint32_t mSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    uint32_t mMaxSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在OffscreenBufferPool中存在一个multiset(在c++中保证有序且重复的set集合)的Entry集合。这个Entry对象中保存了一个个OffscreenBuffer对象，让被调用者从mPool中申请出来。</p>
<p>每当我们需要获取一个全新的OffscreenBuffer对象的时候会调用如下方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">OffscreenBuffer<span class="token operator">*</span> OffscreenBufferPool<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span>RenderState<span class="token operator">&amp;</span> renderState<span class="token punctuation">,</span> <span class="token keyword">const</span> uint32_t width<span class="token punctuation">,</span>
                                          <span class="token keyword">const</span> uint32_t height<span class="token punctuation">,</span> <span class="token keyword">bool</span> wideColorGamut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    OffscreenBuffer<span class="token operator">*</span> layer <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    Entry <span class="token function">entry</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> wideColorGamut<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> iter <span class="token operator">=</span> mPool<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>iter <span class="token operator">!=</span> mPool<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        entry <span class="token operator">=</span> <span class="token operator">*</span>iter<span class="token punctuation">;</span>
        mPool<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span>

        layer <span class="token operator">=</span> entry<span class="token punctuation">.</span>layer<span class="token punctuation">;</span>
        layer<span class="token operator">-</span><span class="token operator">></span>viewportWidth <span class="token operator">=</span> width<span class="token punctuation">;</span>
        layer<span class="token operator">-</span><span class="token operator">></span>viewportHeight <span class="token operator">=</span> height<span class="token punctuation">;</span>
        mSize <span class="token operator">-</span><span class="token operator">=</span> layer<span class="token operator">-</span><span class="token operator">></span><span class="token function">getSizeInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        layer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">OffscreenBuffer</span><span class="token punctuation">(</span>renderState<span class="token punctuation">,</span> Caches<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span>
                                    wideColorGamut<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> layer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先通过宽高和色彩模式为entry，通过entry尝试查找mPool中是否存在缓存，存在则从mPool总移除，并且把对应的OffscreenBuffer返回，不存在就直接new一个OffscreenBuffer对象返回给请求者。</p>
<p>每当使用完毕OffscreenBuffer,会调用如下方法对OffscreenBuffer进行回收：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> OffscreenBufferPool<span class="token operator">::</span><span class="token function">putOrDelete</span><span class="token punctuation">(</span>OffscreenBuffer<span class="token operator">*</span> layer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> uint32_t size <span class="token operator">=</span> layer<span class="token operator">-</span><span class="token operator">></span><span class="token function">getSizeInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> mMaxSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// TODO: Use an LRU</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>mSize <span class="token operator">+</span> size <span class="token operator">></span> mMaxSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            OffscreenBuffer<span class="token operator">*</span> victim <span class="token operator">=</span> mPool<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>layer<span class="token punctuation">;</span>
            mSize <span class="token operator">-</span><span class="token operator">=</span> victim<span class="token operator">-</span><span class="token operator">></span><span class="token function">getSizeInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">delete</span> victim<span class="token punctuation">;</span>
            mPool<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>mPool<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// clear region, since it's no longer valid</span>
        layer<span class="token operator">-</span><span class="token operator">></span>region<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Entry <span class="token function">entry</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mPool<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSize <span class="token operator">+</span><span class="token operator">=</span> size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> layer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就是把OffscreenBuffer添加回mPool中，同时检查大小是否需要缩小整个mPool池中大小。</p>
<p>实际上这是一个十分经典的享元设计设计模式，我们开发中也经常使用到。这么做的好处可以对内存进行循环应用。</p>
<h5 id="OffscreenBuffer"><a href="#OffscreenBuffer" class="headerlink" title="OffscreenBuffer"></a>OffscreenBuffer</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">OffscreenBuffer</span> <span class="token operator">:</span> GpuMemoryTracker <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">OffscreenBuffer</span><span class="token punctuation">(</span>RenderState<span class="token operator">&amp;</span> renderState<span class="token punctuation">,</span> Caches<span class="token operator">&amp;</span> caches<span class="token punctuation">,</span> uint32_t viewportWidth<span class="token punctuation">,</span>
                    uint32_t viewportHeight<span class="token punctuation">,</span> <span class="token keyword">bool</span> wideColorGamut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    RenderState<span class="token operator">&amp;</span> renderState<span class="token punctuation">;</span>

    uint32_t viewportWidth<span class="token punctuation">;</span>
    uint32_t viewportHeight<span class="token punctuation">;</span>
    Texture texture<span class="token punctuation">;</span>

    <span class="token keyword">bool</span> wideColorGamut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    Region region<span class="token punctuation">;</span>

    Matrix4 inverseTransformInWindow<span class="token punctuation">;</span>

    GLsizei elementCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    GLuint vbo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> hasRenderedSinceRepaint<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个OffscreenBuffer对象实际上保存如下几个核心对象：</p>
<ul>
<li>1.viewportWidth和viewportHeight 当前离屏缓存对象的大小</li>
<li>2.Texture 纹理对象，实际上就是指OpenGL的纹理对象</li>
<li>3.inverseTransformInWindow 一个转化的纹理矩阵</li>
<li>4.vbo 顶点缓存对象</li>
</ul>
<p>关于顶点缓存对象以及纹理对象可以阅读我写过的<a href="https://www.jianshu.com/p/4710b707e3ae" target="_blank" rel="noopener">绘制一个三角形</a>以及<a href="https://www.jianshu.com/p/9c58cd895fa5" target="_blank" rel="noopener">纹理基础与索引</a></p>
<h4 id="Layer"><a href="#Layer" class="headerlink" title="Layer"></a>Layer</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Layer</span> <span class="token operator">:</span> <span class="token keyword">public</span> VirtualLightRefBase<span class="token punctuation">,</span> GpuMemoryTracker <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">Api</span> <span class="token punctuation">{</span>
        OpenGL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        Vulkan <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    Api <span class="token function">getApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mApi<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


<span class="token keyword">protected</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">buildColorSpaceWithFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Api mApi<span class="token punctuation">;</span>

    sk_sp<span class="token operator">&lt;</span>SkColorFilter<span class="token operator">></span> mColorFilter<span class="token punctuation">;</span>

    android_dataspace mCurrentDataspace <span class="token operator">=</span> HAL_DATASPACE_UNKNOWN<span class="token punctuation">;</span>

    sk_sp<span class="token operator">&lt;</span>SkColorFilter<span class="token operator">></span> mColorSpaceWithFilter<span class="token punctuation">;</span>

    <span class="token keyword">bool</span> forceFilter <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> alpha<span class="token punctuation">;</span>

    SkBlendMode mode<span class="token punctuation">;</span>


    mat4 texTransform<span class="token punctuation">;</span>

    mat4 transform<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// struct Layer</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到Layer实际上这是一个简单的对象，Layer本质上只存在了透明度，是否打开混合模式，颜色过滤器，转化矩阵等等。<br>而实际上，我们一般是不会直接使用Layer这个结构体，而是会使用如GlLayer更加具体意义的Layer对象。</p>
<h4 id="CanvasContext-createOrUpdateLayer"><a href="#CanvasContext-createOrUpdateLayer" class="headerlink" title="CanvasContext createOrUpdateLayer"></a>CanvasContext createOrUpdateLayer</h4><p>而这个方法时机上调用的就是渲染管道的createOrUpdateLayer方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> OpenGLPipeline<span class="token operator">::</span><span class="token function">createOrUpdateLayer</span><span class="token punctuation">(</span>RenderNode<span class="token operator">*</span> node<span class="token punctuation">,</span>
                                         <span class="token keyword">const</span> DamageAccumulator<span class="token operator">&amp;</span> damageAccumulator<span class="token punctuation">,</span>
                                         <span class="token keyword">bool</span> wideColorGamut<span class="token punctuation">,</span>
                                         ErrorHandler<span class="token operator">*</span> errorHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RenderState<span class="token operator">&amp;</span> renderState <span class="token operator">=</span> mRenderThread<span class="token punctuation">.</span><span class="token function">renderState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OffscreenBufferPool<span class="token operator">&amp;</span> layerPool <span class="token operator">=</span> renderState<span class="token punctuation">.</span><span class="token function">layerPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> transformUpdateNeeded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-</span><span class="token operator">></span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token operator">-</span><span class="token operator">></span><span class="token function">setLayer</span><span class="token punctuation">(</span>
                layerPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>renderState<span class="token punctuation">,</span> node<span class="token operator">-</span><span class="token operator">></span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token operator">-</span><span class="token operator">></span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wideColorGamut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transformUpdateNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">layerMatchesWH</span><span class="token punctuation">(</span>node<span class="token operator">-</span><span class="token operator">></span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token operator">-</span><span class="token operator">></span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token operator">-</span><span class="token operator">></span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-</span><span class="token operator">></span><span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fitsOnLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token operator">-</span><span class="token operator">></span><span class="token function">setLayer</span><span class="token punctuation">(</span>layerPool<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>node<span class="token operator">-</span><span class="token operator">></span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token operator">-</span><span class="token operator">></span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token operator">-</span><span class="token operator">></span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">destroyLayer</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        transformUpdateNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>transformUpdateNeeded <span class="token operator">&amp;&amp;</span> node<span class="token operator">-</span><span class="token operator">></span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        Matrix4 windowTransform<span class="token punctuation">;</span>
        damageAccumulator<span class="token punctuation">.</span><span class="token function">computeCurrentTransform</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>windowTransform<span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-</span><span class="token operator">></span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setWindowTransform</span><span class="token punctuation">(</span>windowTransform<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token operator">-</span><span class="token operator">></span><span class="token function">hasLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> transformUpdateNeeded<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>了解上面几个核心对象后，就能知道实际上这个步骤就是给每一个RenderNode设置一个OffscreenBuffer离屏渲染内存，这里主要起作用的是纹理对象。经过这个步骤之后RenderNode才能拥有绘制出图像的能力。</p>
<p>当这里就分析完了关于CanvasContext的syncFrameState方法了。</p>
<h3 id="CanvasContext-draw"><a href="#CanvasContext-draw" class="headerlink" title="CanvasContext draw"></a>CanvasContext draw</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CanvasContext<span class="token operator">::</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SkRect dirty<span class="token punctuation">;</span>
    mDamageAccumulator<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dirty<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    Frame frame <span class="token operator">=</span> mRenderPipeline<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    SkRect windowDirty <span class="token operator">=</span> <span class="token function">computeDirtyRect</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dirty<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> drew <span class="token operator">=</span> mRenderPipeline<span class="token operator">-</span><span class="token operator">></span><span class="token function">draw</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> windowDirty<span class="token punctuation">,</span> dirty<span class="token punctuation">,</span> mLightGeometry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mLayerUpdateQueue<span class="token punctuation">,</span>
                                      mContentDrawBounds<span class="token punctuation">,</span> mOpaque<span class="token punctuation">,</span> mWideColorGamut<span class="token punctuation">,</span> mLightInfo<span class="token punctuation">,</span>
                                      mRenderNodes<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token function">profiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    int64_t frameCompleteNr <span class="token operator">=</span> mFrameCompleteCallbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">getFrameNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">waitOnFences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> requireSwap <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> didSwap <span class="token operator">=</span>
            mRenderPipeline<span class="token operator">-</span><span class="token operator">></span><span class="token function">swapBuffers</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> drew<span class="token punctuation">,</span> windowDirty<span class="token punctuation">,</span> mCurrentFrameInfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>requireSwap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mIsDirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>requireSwap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSwap<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">setSurface</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>didSwap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> func <span class="token operator">:</span> mFrameCompleteCallbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            std<span class="token operator">::</span><span class="token function">invoke</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> frameCompleteNr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mFrameCompleteCallbacks<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上CanvasContext的draw可以分为如下几个步骤：</p>
<ul>
<li>1.DamageAccumulator.finish 获取需要渲染的脏区</li>
<li>2.通过getFrame获取到包含Surface的Frame对象，并通过computeDirtyRect把DamageAccumulator计算出来的脏区赋值到frame中。</li>
<li>3.渲染管道调用draw方法开始执行渲染</li>
<li>4.waitOnFences 等待OpenGL渲染的绘制栏栅fence解放</li>
<li>5.调用渲染管道的swapBuffers，把Surface中的GrapBuffer发送到SF进行开始渲染</li>
<li>6.如果发现渲染失败，则设置CanvasContext的Surface为null</li>
<li>7.回调之前设置渲染完成监听。</li>
</ul>
<h4 id="DamageAccumulator-finish"><a href="#DamageAccumulator-finish" class="headerlink" title="DamageAccumulator::finish"></a>DamageAccumulator::finish</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> DamageAccumulator<span class="token operator">::</span><span class="token function">finish</span><span class="token punctuation">(</span>SkRect<span class="token operator">*</span> totalDirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>totalDirty <span class="token operator">=</span> mHead<span class="token operator">-</span><span class="token operator">></span>pendingDirty<span class="token punctuation">;</span>
    totalDirty<span class="token operator">-</span><span class="token operator">></span><span class="token function">roundOut</span><span class="token punctuation">(</span>totalDirty<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mHead<span class="token operator">-</span><span class="token operator">></span>pendingDirty<span class="token punctuation">.</span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单就是把mHead中的脏区的大小赋值给SkRect。</p>
<h4 id="CanvasContext获取本次需要渲染区域"><a href="#CanvasContext获取本次需要渲染区域" class="headerlink" title="CanvasContext获取本次需要渲染区域"></a>CanvasContext获取本次需要渲染区域</h4><p>首先来看看一个比较关键的对象Frame的头文件：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Frame</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">Frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">EglManager</span><span class="token punctuation">;</span>

    int32_t mWidth<span class="token punctuation">;</span>
    int32_t mHeight<span class="token punctuation">;</span>
    int32_t mBufferAge<span class="token punctuation">;</span>

    EGLSurface mSurface<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上很简单，存在当前EGLSurface对应的宽高参数以及EGLSurface对象。</p>
<h5 id="getFrame获取Frame对象"><a href="#getFrame获取Frame对象" class="headerlink" title="getFrame获取Frame对象"></a>getFrame获取Frame对象</h5><pre class="line-numbers language-cpp"><code class="language-cpp">Frame OpenGLPipeline<span class="token operator">::</span><span class="token function">getFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mEglManager<span class="token punctuation">.</span><span class="token function">beginFrame</span><span class="token punctuation">(</span>mEglSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">Frame EglManager<span class="token operator">::</span><span class="token function">beginFrame</span><span class="token punctuation">(</span>EGLSurface surface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">makeCurrent</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Frame frame<span class="token punctuation">;</span>
    frame<span class="token punctuation">.</span>mSurface <span class="token operator">=</span> surface<span class="token punctuation">;</span>
    <span class="token function">eglQuerySurface</span><span class="token punctuation">(</span>mEglDisplay<span class="token punctuation">,</span> surface<span class="token punctuation">,</span> EGL_WIDTH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">.</span>mWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eglQuerySurface</span><span class="token punctuation">(</span>mEglDisplay<span class="token punctuation">,</span> surface<span class="token punctuation">,</span> EGL_HEIGHT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">.</span>mHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    frame<span class="token punctuation">.</span>mBufferAge <span class="token operator">=</span> <span class="token function">queryBufferAge</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eglBeginFrame</span><span class="token punctuation">(</span>mEglDisplay<span class="token punctuation">,</span> surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> frame<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到很简单，首先makeCurrent 设置当前EGLSurface为渲染的上下为主体环境。把frame中的mSurface赋值为保存在mEglManager的EGLSurface，以及通过eglQuerySurface查询mEglDisplay(渲染屏幕对象)的宽高并且返回。</p>
<h5 id="computeDirtyRect计算Frame的脏区"><a href="#computeDirtyRect计算Frame的脏区" class="headerlink" title="computeDirtyRect计算Frame的脏区"></a>computeDirtyRect计算Frame的脏区</h5><pre class="line-numbers language-cpp"><code class="language-cpp">SkRect CanvasContext<span class="token operator">::</span><span class="token function">computeDirtyRect</span><span class="token punctuation">(</span><span class="token keyword">const</span> Frame<span class="token operator">&amp;</span> frame<span class="token punctuation">,</span> SkRect<span class="token operator">*</span> dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> mLastFrameWidth <span class="token operator">||</span> frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> mLastFrameHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dirty<span class="token operator">-</span><span class="token operator">></span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLastFrameWidth <span class="token operator">=</span> frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLastFrameHeight <span class="token operator">=</span> frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mHaveNewSurface <span class="token operator">||</span> frame<span class="token punctuation">.</span><span class="token function">bufferAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dirty<span class="token operator">-</span><span class="token operator">></span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirty<span class="token operator">-</span><span class="token operator">></span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dirty<span class="token operator">-</span><span class="token operator">></span><span class="token function">intersect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dirty<span class="token operator">-</span><span class="token operator">></span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">profiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unionDirty</span><span class="token punctuation">(</span>dirty<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token operator">-</span><span class="token operator">></span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dirty<span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    SkRect <span class="token function">windowDirty</span><span class="token punctuation">(</span><span class="token operator">*</span>dirty<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">bufferAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">bufferAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>mSwapHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dirty<span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mSwapHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                 i <span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>mSwapHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> frame<span class="token punctuation">.</span><span class="token function">bufferAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dirty<span class="token operator">-</span><span class="token operator">></span><span class="token function">join</span><span class="token punctuation">(</span>mSwapHistory<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>damage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> windowDirty<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程实际上很简单，如果发现从EGLSurface中获取到的宽高和上一次的不同则更新mLastFrameWidth和mLastFrameHeight。如果Frame的是第一次创建则脏区设置为null。</p>
<p>如果脏区为空，就需要把frame的宽高设置到脏区中进行全局刷新。</p>
<p>如果bufferAge大于1，则判断当前的bufferAge是否大于mSwapHistory。mSwapHistory这个对象实际上记录了当前已经交换成功的历史。如果bufferAge大于mSwapHistory说明是权限的刷新区域，则把脏区设置为全局，否则则查找对应的mSwapHistory子元素比较和当前的脏区获取交集。</p>
<p>最后返回脏区的区域。</p>
<h4 id="渲染管道的draw方法"><a href="#渲染管道的draw方法" class="headerlink" title="渲染管道的draw方法"></a>渲染管道的draw方法</h4><p>在聊具体的逻辑之前，我们还需要弄清楚几个关键的对象。</p>
<h5 id="FrameBuilder-帧构造者"><a href="#FrameBuilder-帧构造者" class="headerlink" title="FrameBuilder 帧构造者"></a>FrameBuilder 帧构造者</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">FrameBuilder</span> <span class="token operator">:</span> <span class="token keyword">public</span> CanvasStateClient <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">struct</span> LightGeometry <span class="token punctuation">{</span>
        Vector3 center<span class="token punctuation">;</span>
        <span class="token keyword">float</span> radius<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    LinearAllocator mAllocator<span class="token punctuation">;</span>
    LinearStdAllocator<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span> mStdAllocator<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// List of every deferred layer's render state. Replayed in reverse order to render a frame.</span>
    LsaVector<span class="token operator">&lt;</span>LayerBuilder<span class="token operator">*</span><span class="token operator">></span> mLayerBuilders<span class="token punctuation">;</span>

    LsaVector<span class="token operator">&lt;</span>size_t<span class="token operator">></span> mLayerStack<span class="token punctuation">;</span>

    CanvasState mCanvasState<span class="token punctuation">;</span>

    Caches<span class="token operator">&amp;</span> mCaches<span class="token punctuation">;</span>

    <span class="token keyword">float</span> mLightRadius<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">bool</span> mDrawFbo0<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里我们只关注它的属性即可。<br>能看到FrameBuilder帧构造者中包含了如下几个核心对象：</p>
<ul>
<li>1.LinearAllocator和LinearStdAllocator 这两个线性内存管理器在上一篇文章已经和大家聊过了</li>
<li>2.mLayerBuilders 是一个LayerBuilder Layer构造器的集合</li>
<li>3.mLayerStack 是指Layer的栈</li>
<li>4.mCaches 是指OpenGL的缓存</li>
</ul>
<p>而这里面又存在另一个核心的对象LayerBuilder Layer构造器</p>
<h5 id="LayerBuilder-Layer构造器"><a href="#LayerBuilder-Layer构造器" class="headerlink" title="LayerBuilder Layer构造器"></a>LayerBuilder Layer构造器</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">LayerBuilder</span> <span class="token punctuation">{</span>viewportClip
    <span class="token function">PREVENT_COPY_AND_ASSIGN</span><span class="token punctuation">(</span>LayerBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">LayerBuilder</span><span class="token punctuation">(</span>uint32_t width<span class="token punctuation">,</span> uint32_t height<span class="token punctuation">,</span> <span class="token keyword">const</span> Rect<span class="token operator">&amp;</span> repaintRect<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">LayerBuilder</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> repaintRect<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">LayerBuilder</span><span class="token punctuation">(</span>uint32_t width<span class="token punctuation">,</span> uint32_t height<span class="token punctuation">,</span> <span class="token keyword">const</span> Rect<span class="token operator">&amp;</span> repaintRect<span class="token punctuation">,</span>
                 <span class="token keyword">const</span> BeginLayerOp<span class="token operator">*</span> beginLayerOp<span class="token punctuation">,</span> RenderNode<span class="token operator">*</span> renderNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">const</span> uint32_t width<span class="token punctuation">;</span>
    <span class="token keyword">const</span> uint32_t height<span class="token punctuation">;</span>
    <span class="token keyword">const</span> Rect repaintRect<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ClipRect repaintClip<span class="token punctuation">;</span>
    OffscreenBuffer<span class="token operator">*</span> offscreenBuffer<span class="token punctuation">;</span>
    <span class="token keyword">const</span> BeginLayerOp<span class="token operator">*</span> beginLayerOp<span class="token punctuation">;</span>
    <span class="token keyword">const</span> RenderNode<span class="token operator">*</span> renderNode<span class="token punctuation">;</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>BakedOpState<span class="token operator">*</span><span class="token operator">></span> activeUnclippedSaveLayers<span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>BatchBase<span class="token operator">*</span><span class="token operator">></span> mBatches<span class="token punctuation">;</span>

    std<span class="token operator">::</span>unordered_map<span class="token operator">&lt;</span>mergeid_t<span class="token punctuation">,</span> MergingOpBatch<span class="token operator">*</span><span class="token operator">></span> mMergingBatchLookup<span class="token punctuation">[</span>OpBatchType<span class="token operator">::</span>Count<span class="token punctuation">]</span><span class="token punctuation">;</span>

    OpBatch<span class="token operator">*</span> mBatchLookup<span class="token punctuation">[</span>OpBatchType<span class="token operator">::</span>Count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Rect<span class="token operator">></span> mClearRects<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>LayerBuilder中保存了对应宽高，renderNode，以及OffscreenBuffer几个核心的属性。</p>
<p>在这里出现几个比较重要的新对象，我称为绘制操作批次：</p>
<ul>
<li>1.BatchBase</li>
<li>2.MergingOpBatch</li>
<li>3.mBatchLookup</li>
</ul>
<p>实际上这些对象是都是通过RecordOp转化过来的全新的操作对象。但是他们并非直接操作RecordOp，而是操作一个名为BakedOpState的对象。</p>
<h6 id="BakedOpState"><a href="#BakedOpState" class="headerlink" title="BakedOpState"></a>BakedOpState</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">BakedOpState</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">static</span> BakedOpState<span class="token operator">*</span> <span class="token function">tryConstruct</span><span class="token punctuation">(</span>LinearAllocator<span class="token operator">&amp;</span> allocator<span class="token punctuation">,</span> Snapshot<span class="token operator">&amp;</span> snapshot<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> RecordedOp<span class="token operator">&amp;</span> recordedOp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> BakedOpState<span class="token operator">*</span> <span class="token function">tryConstructUnbounded</span><span class="token punctuation">(</span>LinearAllocator<span class="token operator">&amp;</span> allocator<span class="token punctuation">,</span> Snapshot<span class="token operator">&amp;</span> snapshot<span class="token punctuation">,</span>
                                               <span class="token keyword">const</span> RecordedOp<span class="token operator">&amp;</span> recordedOp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">StrokeBehavior</span> <span class="token punctuation">{</span>
        StyleDefined<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> BakedOpState<span class="token operator">*</span> <span class="token function">tryStrokeableOpConstruct</span><span class="token punctuation">(</span>LinearAllocator<span class="token operator">&amp;</span> allocator<span class="token punctuation">,</span> Snapshot<span class="token operator">&amp;</span> snapshot<span class="token punctuation">,</span>
                                                  <span class="token keyword">const</span> RecordedOp<span class="token operator">&amp;</span> recordedOp<span class="token punctuation">,</span>
                                                  StrokeBehavior strokeBehavior<span class="token punctuation">,</span>
                                                  <span class="token keyword">bool</span> expandForPathTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> BakedOpState<span class="token operator">*</span> <span class="token function">tryShadowOpConstruct</span><span class="token punctuation">(</span>LinearAllocator<span class="token operator">&amp;</span> allocator<span class="token punctuation">,</span> Snapshot<span class="token operator">&amp;</span> snapshot<span class="token punctuation">,</span>
                                              <span class="token keyword">const</span> ShadowOp<span class="token operator">*</span> shadowOpPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> BakedOpState<span class="token operator">*</span> <span class="token function">directConstruct</span><span class="token punctuation">(</span>LinearAllocator<span class="token operator">&amp;</span> allocator<span class="token punctuation">,</span> <span class="token keyword">const</span> ClipRect<span class="token operator">*</span> clip<span class="token punctuation">,</span>
                                         <span class="token keyword">const</span> Rect<span class="token operator">&amp;</span> dstRect<span class="token punctuation">,</span> <span class="token keyword">const</span> RecordedOp<span class="token operator">&amp;</span> recordedOp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">const</span> <span class="token keyword">float</span> alpha<span class="token punctuation">;</span>
    <span class="token keyword">const</span> RoundRectClipState<span class="token operator">*</span> roundRectClipState<span class="token punctuation">;</span>
    <span class="token keyword">const</span> RecordedOp<span class="token operator">*</span> op<span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">LinearAllocator</span><span class="token punctuation">;</span>

    <span class="token function">BakedOpState</span><span class="token punctuation">(</span>LinearAllocator<span class="token operator">&amp;</span> allocator<span class="token punctuation">,</span> Snapshot<span class="token operator">&amp;</span> snapshot<span class="token punctuation">,</span> <span class="token keyword">const</span> RecordedOp<span class="token operator">&amp;</span> recordedOp<span class="token punctuation">,</span>
                 <span class="token keyword">bool</span> expandForStroke<span class="token punctuation">,</span> <span class="token keyword">bool</span> expandForPathTexture<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">computedState</span><span class="token punctuation">(</span>allocator<span class="token punctuation">,</span> snapshot<span class="token punctuation">,</span> recordedOp<span class="token punctuation">,</span> expandForStroke<span class="token punctuation">,</span> expandForPathTexture<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">alpha</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span>alpha<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">roundRectClipState</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span>roundRectClipState<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">op</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>recordedOp<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token function">BakedOpState</span><span class="token punctuation">(</span>LinearAllocator<span class="token operator">&amp;</span> allocator<span class="token punctuation">,</span> Snapshot<span class="token operator">&amp;</span> snapshot<span class="token punctuation">,</span> <span class="token keyword">const</span> RecordedOp<span class="token operator">&amp;</span> recordedOp<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">computedState</span><span class="token punctuation">(</span>allocator<span class="token punctuation">,</span> snapshot<span class="token punctuation">,</span> recordedOp<span class="token punctuation">.</span>localMatrix<span class="token punctuation">,</span> recordedOp<span class="token punctuation">.</span>localClip<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">alpha</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span>alpha<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">roundRectClipState</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span>roundRectClipState<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">op</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>recordedOp<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token function">BakedOpState</span><span class="token punctuation">(</span>LinearAllocator<span class="token operator">&amp;</span> allocator<span class="token punctuation">,</span> Snapshot<span class="token operator">&amp;</span> snapshot<span class="token punctuation">,</span> <span class="token keyword">const</span> ShadowOp<span class="token operator">*</span> shadowOpPtr<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">computedState</span><span class="token punctuation">(</span>allocator<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">alpha</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span>alpha<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">roundRectClipState</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span>roundRectClipState<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">op</span><span class="token punctuation">(</span>shadowOpPtr<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token function">BakedOpState</span><span class="token punctuation">(</span><span class="token keyword">const</span> ClipRect<span class="token operator">*</span> clipRect<span class="token punctuation">,</span> <span class="token keyword">const</span> Rect<span class="token operator">&amp;</span> dstRect<span class="token punctuation">,</span> <span class="token keyword">const</span> RecordedOp<span class="token operator">&amp;</span> recordedOp<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">computedState</span><span class="token punctuation">(</span>clipRect<span class="token punctuation">,</span> dstRect<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">alpha</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">roundRectClipState</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">op</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>recordedOp<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从头文件可以看出，实际上BackStateOp是包含了RecordedOp，也就是我们在每一个View调用Canvas的操作方法生成的RecordedOp对象。同时包含透明度以及裁剪范围。</p>
<p>那么BackStateOp和RecordedOp有什么区别呢？实际上从名字就能明白，就是对RecordedOp进行一次拷贝存储后，同时保存裁剪区域，目标绘制区域以及透明度。</p>
<h6 id="BatchBase"><a href="#BatchBase" class="headerlink" title="BatchBase"></a>BatchBase</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">BatchBase</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">BatchBase</span><span class="token punctuation">(</span>batchid_t batchId<span class="token punctuation">,</span> BakedOpState<span class="token operator">*</span> op<span class="token punctuation">,</span> <span class="token keyword">bool</span> merging<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">mBatchId</span><span class="token punctuation">(</span>batchId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mMerging</span><span class="token punctuation">(</span>merging<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mBounds <span class="token operator">=</span> op<span class="token operator">-</span><span class="token operator">></span>computedState<span class="token punctuation">.</span>clippedBounds<span class="token punctuation">;</span>
        mOps<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> <span class="token function">intersects</span><span class="token punctuation">(</span><span class="token keyword">const</span> Rect<span class="token operator">&amp;</span> rect<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rect<span class="token punctuation">.</span><span class="token function">intersects</span><span class="token punctuation">(</span>mBounds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> BakedOpState<span class="token operator">*</span> op <span class="token operator">:</span> mOps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rect<span class="token punctuation">.</span><span class="token function">intersects</span><span class="token punctuation">(</span>op<span class="token operator">-</span><span class="token operator">></span>computedState<span class="token punctuation">.</span>clippedBounds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    batchid_t <span class="token function">getBatchId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mBatchId<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">isMerging</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mMerging<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>BakedOpState<span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">getOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mOps<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
    batchid_t mBatchId<span class="token punctuation">;</span>
    Rect mBounds<span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>BakedOpState<span class="token operator">*</span><span class="token operator">></span> mOps<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> mMerging<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上BatchBase 包含的了一个BakedOpState集合，以及渲染的区域。但是一般来说很少直接使用BatchBase而是使用它的派生类OpBatch以及MergingOpBatch。</p>
<h6 id="OpBatch"><a href="#OpBatch" class="headerlink" title="OpBatch"></a>OpBatch</h6><pre class="line-numbers language-h"><code class="language-h">class OpBatch : public BatchBase {
public:
    OpBatch(batchid_t batchId, BakedOpState* op) : BatchBase(batchId, op, false) {}

    void batchOp(BakedOpState* op) {
        mBounds.unionWith(op->computedState.clippedBounds);
        mOps.push_back(op);
    }
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，OpBatch相比BatchBase来说，会并上所有添加到mOps集合中每一个绘制操作符的区域，以及保存每一个绘制操作BakedOpState。</p>
<h6 id="MergingOpBatch"><a href="#MergingOpBatch" class="headerlink" title="MergingOpBatch"></a>MergingOpBatch</h6><pre class="line-numbers language-h"><code class="language-h">class MergingOpBatch : public BatchBase {
public:
    MergingOpBatch(batchid_t batchId, BakedOpState* op)
            : BatchBase(batchId, op, true), mClipSideFlags(op->computedState.clipSideFlags) {}

    static inline bool checkSide(const int currentFlags, const int newFlags, const int side,
                                 float boundsDelta) {
        bool currentClipExists = currentFlags & side;
        bool newClipExists = newFlags & side;

        if (boundsDelta > 0 && currentClipExists) return false;

        if (boundsDelta < 0 && newClipExists) return false;

        return true;
    }

    static bool paintIsDefault(const SkPaint& paint) {
        return paint.getAlpha() == 255 && paint.getColorFilter() == nullptr &&
               paint.getShader() == nullptr;
    }

    static bool paintsAreEquivalent(const SkPaint& a, const SkPaint& b) {
        return a.getAlpha() == b.getAlpha() && a.getColorFilter() == b.getColorFilter() &&
               a.getShader() == b.getShader();
    }

    bool canMergeWith(BakedOpState* op) const {
        bool isTextBatch =
                getBatchId() == OpBatchType::Text || getBatchId() == OpBatchType::ColorText;

        if (!isTextBatch || PaintUtils::hasTextShadow(op->op->paint)) {
            if (intersects(op->computedState.clippedBounds)) return false;
        }

        const BakedOpState* lhs = op;
        const BakedOpState* rhs = mOps[0];

        if (!MathUtils::areEqual(lhs->alpha, rhs->alpha)) return false;

        if (lhs->roundRectClipState != rhs->roundRectClipState) return false;

        if (lhs->computedState.localProjectionPathMask ||
            rhs->computedState.localProjectionPathMask)
            return false;

        const int currentFlags = mClipSideFlags;
        const int newFlags = op->computedState.clipSideFlags;
        if (currentFlags != OpClipSideFlags::None || newFlags != OpClipSideFlags::None) {
            const Rect& opBounds = op->computedState.clippedBounds;
            float boundsDelta = mBounds.left - opBounds.left;
            if (!checkSide(currentFlags, newFlags, OpClipSideFlags::Left, boundsDelta))
                return false;
            boundsDelta = mBounds.top - opBounds.top;
            if (!checkSide(currentFlags, newFlags, OpClipSideFlags::Top, boundsDelta)) return false;

            boundsDelta = opBounds.right - mBounds.right;
            if (!checkSide(currentFlags, newFlags, OpClipSideFlags::Right, boundsDelta))
                return false;
            boundsDelta = opBounds.bottom - mBounds.bottom;
            if (!checkSide(currentFlags, newFlags, OpClipSideFlags::Bottom, boundsDelta))
                return false;
        }

        const SkPaint* newPaint = op->op->paint;
        const SkPaint* oldPaint = mOps[0]->op->paint;

        if (newPaint == oldPaint) {
            return true;
        } else if (newPaint && !oldPaint) {
            return paintIsDefault(*newPaint);
        } else if (!newPaint && oldPaint) {
            return paintIsDefault(*oldPaint);
        }
        return paintsAreEquivalent(*newPaint, *oldPaint);
    }

    void mergeOp(BakedOpState* op) {
        mBounds.unionWith(op->computedState.clippedBounds);
        mOps.push_back(op);
        mClipSideFlags |= op->computedState.clipSideFlags;
    }

    int getClipSideFlags() const { return mClipSideFlags; }
    const Rect& getClipRect() const { return mBounds; }

private:
    int mClipSideFlags;
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上MergingOpBatch就如同名字一样，尝试着把多个BakedOpState合并成一个操作批次。如果可以合并到一个操作，就能对这些操作同步进行。</p>
<p>判断能够进行合并需要考量如下几点：</p>
<ul>
<li>1.如果不是绘制文字，或者是绘制文字但是存在阴影。则需要判断是否存在交集，存在则返回false。</li>
<li>2.透明度不一致，返回false</li>
<li>3.裁剪区域不一致返回false</li>
<li>4.OpClipSideFlags 标志位不为空，则判断对应方向（top,left,right,bottom）的边缘是否是在当前MergingOpBatch的裁剪范围内，不在则返回false</li>
<li>5.判断绘制的画笔SKPaint是否是相同透明度，相同色值的，不是则返回false。</li>
</ul>
<p>有了这些基础后，我们在回过头来看看OpenGLPipeline中的draw方法。</p>
<h3 id="OpenGLPipeline-draw"><a href="#OpenGLPipeline-draw" class="headerlink" title="OpenGLPipeline draw"></a>OpenGLPipeline draw</h3><p>在这里渲染管道是指OpenGL的渲染管道。因此我们考察一下OpenGLPipeline的draw方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> OpenGLPipeline<span class="token operator">::</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token keyword">const</span> Frame<span class="token operator">&amp;</span> frame<span class="token punctuation">,</span> <span class="token keyword">const</span> SkRect<span class="token operator">&amp;</span> screenDirty<span class="token punctuation">,</span> <span class="token keyword">const</span> SkRect<span class="token operator">&amp;</span> dirty<span class="token punctuation">,</span>
                          <span class="token keyword">const</span> FrameBuilder<span class="token operator">::</span>LightGeometry<span class="token operator">&amp;</span> lightGeometry<span class="token punctuation">,</span>
                          LayerUpdateQueue<span class="token operator">*</span> layerUpdateQueue<span class="token punctuation">,</span> <span class="token keyword">const</span> Rect<span class="token operator">&amp;</span> contentDrawBounds<span class="token punctuation">,</span>
                          <span class="token keyword">bool</span> opaque<span class="token punctuation">,</span> <span class="token keyword">bool</span> wideColorGamut<span class="token punctuation">,</span>
                          <span class="token keyword">const</span> BakedOpRenderer<span class="token operator">::</span>LightInfo<span class="token operator">&amp;</span> lightInfo<span class="token punctuation">,</span>
                          <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>sp<span class="token operator">&lt;</span>RenderNode<span class="token operator">>></span><span class="token operator">&amp;</span> renderNodes<span class="token punctuation">,</span>
                          FrameInfoVisualizer<span class="token operator">*</span> profiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mEglManager<span class="token punctuation">.</span><span class="token function">damageFrame</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> dirty<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> drew <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span><span class="token operator">&amp;</span> caches <span class="token operator">=</span> Caches<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FrameBuilder <span class="token function">frameBuilder</span><span class="token punctuation">(</span>dirty<span class="token punctuation">,</span> frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lightGeometry<span class="token punctuation">,</span> caches<span class="token punctuation">)</span><span class="token punctuation">;</span>

    frameBuilder<span class="token punctuation">.</span><span class="token function">deferLayers</span><span class="token punctuation">(</span><span class="token operator">*</span>layerUpdateQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    layerUpdateQueue<span class="token operator">-</span><span class="token operator">></span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    frameBuilder<span class="token punctuation">.</span><span class="token function">deferRenderNodeScene</span><span class="token punctuation">(</span>renderNodes<span class="token punctuation">,</span> contentDrawBounds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    BakedOpRenderer <span class="token function">renderer</span><span class="token punctuation">(</span>caches<span class="token punctuation">,</span> mRenderThread<span class="token punctuation">.</span><span class="token function">renderState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> opaque<span class="token punctuation">,</span> wideColorGamut<span class="token punctuation">,</span>
                             lightInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    frameBuilder<span class="token punctuation">.</span>replayBakedOps<span class="token operator">&lt;</span>BakedOpDispatcher<span class="token operator">></span><span class="token punctuation">(</span>renderer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ProfileRenderer <span class="token function">profileRenderer</span><span class="token punctuation">(</span>renderer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    profiler<span class="token operator">-</span><span class="token operator">></span><span class="token function">draw</span><span class="token punctuation">(</span>profileRenderer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    drew <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">didDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// post frame cleanup</span>
    caches<span class="token punctuation">.</span><span class="token function">clearGarbage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    caches<span class="token punctuation">.</span>pathCache<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    caches<span class="token punctuation">.</span>tessellationCache<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> drew<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.构建FrameBuilder对象后调用deferLayers方法</li>
<li>2.构建BakedOpRenderer对象，调用FrameBuilder的replayBakedOps，通过BakedOpDispatcher分发具体操作</li>
<li>3.调用ProfileRenderer的draw方法</li>
</ul>
<p>大致上就是这三步。</p>
<h4 id="FrameBuilder-deferLayers"><a href="#FrameBuilder-deferLayers" class="headerlink" title="FrameBuilder deferLayers"></a>FrameBuilder deferLayers</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/FrameBuilder.cpp" target="_blank" rel="noopener">FrameBuilder.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> FrameBuilder<span class="token operator">::</span><span class="token function">deferLayers</span><span class="token punctuation">(</span><span class="token keyword">const</span> LayerUpdateQueue<span class="token operator">&amp;</span> layers<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> layers<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RenderNode<span class="token operator">*</span> layerNode <span class="token operator">=</span> layers<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>renderNode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        OffscreenBuffer<span class="token operator">*</span> layer <span class="token operator">=</span> layerNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_LIKELY</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            Rect layerDamage <span class="token operator">=</span> layers<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>damage<span class="token punctuation">;</span>
            layerDamage<span class="token punctuation">.</span><span class="token function">doIntersect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> layer<span class="token operator">-</span><span class="token operator">></span>viewportWidth<span class="token punctuation">,</span> layer<span class="token operator">-</span><span class="token operator">></span>viewportHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            layerNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">computeOrdering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token function">saveForLayer</span><span class="token punctuation">(</span>layerNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> layerNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> layerDamage<span class="token punctuation">,</span>
                         lightCenter<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> layerNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>layerNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">getDisplayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">deferNodeOps</span><span class="token punctuation">(</span><span class="token operator">*</span>layerNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">restoreForLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意这里的LayerUpdateQueue记录了需要更新的RenderNode，在prepareTree步骤中已经完成了对所有RenderNode的刷新范围以及个数进行记录。而LayerUpdateQueue的entries方法就是获取mEntries对象。</p>
<ul>
<li>1.遍历每一个mEntries记录的RenderNode，首先把整个视窗大小和RenderNode的脏区去交集，避免RenderNode绘制在屏幕之外。</li>
<li>2.通过computeOrdering计算renderNode的投影顺序。</li>
<li>3.saveForLayer 通过RenderNode和BeginLayerOp生成LayerBuilder，记录在FrameBuilder的mLayerBuilders集合中。同时通过mLayerStack记录当前的绘制的个数。</li>
<li>4.判断RenderNode是否存在DisplayList，从上一篇文章知道DisplayList这个对象时机上控制了当前的RenderNode的所有子renderNode，因此如果存在DisplayList说明RenderNode还有子元素，调用deferNodeOps处理子renderNode。</li>
<li>5.restoreForLayer 把mLayerStack的绘制个数弹出。</li>
</ul>
<h4 id="FrameBuilder-saveForLayer"><a href="#FrameBuilder-saveForLayer" class="headerlink" title="FrameBuilder saveForLayer"></a>FrameBuilder saveForLayer</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> FrameBuilder<span class="token operator">::</span><span class="token function">saveForLayer</span><span class="token punctuation">(</span>uint32_t layerWidth<span class="token punctuation">,</span> uint32_t layerHeight<span class="token punctuation">,</span> <span class="token keyword">float</span> contentTranslateX<span class="token punctuation">,</span>
                                <span class="token keyword">float</span> contentTranslateY<span class="token punctuation">,</span> <span class="token keyword">const</span> Rect<span class="token operator">&amp;</span> repaintRect<span class="token punctuation">,</span>
                                <span class="token keyword">const</span> Vector3<span class="token operator">&amp;</span> lightCenter<span class="token punctuation">,</span> <span class="token keyword">const</span> BeginLayerOp<span class="token operator">*</span> beginLayerOp<span class="token punctuation">,</span>
                                RenderNode<span class="token operator">*</span> renderNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mCanvasState<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>SaveFlags<span class="token operator">::</span>MatrixClip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mCanvasState<span class="token punctuation">.</span><span class="token function">writableSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">initializeViewport</span><span class="token punctuation">(</span>layerWidth<span class="token punctuation">,</span> layerHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mCanvasState<span class="token punctuation">.</span><span class="token function">writableSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>roundRectClipState <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    mCanvasState<span class="token punctuation">.</span><span class="token function">writableSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setRelativeLightCenter</span><span class="token punctuation">(</span>lightCenter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mCanvasState<span class="token punctuation">.</span><span class="token function">writableSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>transform<span class="token operator">-</span><span class="token operator">></span><span class="token function">loadTranslate</span><span class="token punctuation">(</span>contentTranslateX<span class="token punctuation">,</span> contentTranslateY<span class="token punctuation">,</span>
                                                              <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mCanvasState<span class="token punctuation">.</span><span class="token function">writableSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setClip</span><span class="token punctuation">(</span>repaintRect<span class="token punctuation">.</span>left<span class="token punctuation">,</span> repaintRect<span class="token punctuation">.</span>top<span class="token punctuation">,</span> repaintRect<span class="token punctuation">.</span>right<span class="token punctuation">,</span>
                                             repaintRect<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mLayerStack<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>mLayerBuilders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> newFbo <span class="token operator">=</span> mAllocator<span class="token punctuation">.</span>create<span class="token operator">&lt;</span>LayerBuilder<span class="token operator">></span><span class="token punctuation">(</span>layerWidth<span class="token punctuation">,</span> layerHeight<span class="token punctuation">,</span> repaintRect<span class="token punctuation">,</span>
                                                  beginLayerOp<span class="token punctuation">,</span> renderNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mLayerBuilders<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>newFbo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到每一个RenderNode都会生成一个LayerBuilder对象，并且保存到mLayerBuilders中。同时通过mCanvasState记录当前的绘制属性状态。mLayerStack还会记录当前mLayerBuilders中的大小。这样就能通过栈知道每一层的View显示层次有多少个子View。</p>
<h5 id="FrameBuilder-deferNodeOps"><a href="#FrameBuilder-deferNodeOps" class="headerlink" title="FrameBuilder deferNodeOps"></a>FrameBuilder deferNodeOps</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> OP_RECEIVER(Type)                                       \
    [](FrameBuilder&amp; frameBuilder, const RecordedOp&amp; op) {      \
        frameBuilder.defer##Type(static_cast&lt;const Type&amp;>(op)); \
    },</span>
<span class="token keyword">void</span> FrameBuilder<span class="token operator">::</span><span class="token function">deferNodeOps</span><span class="token punctuation">(</span><span class="token keyword">const</span> RenderNode<span class="token operator">&amp;</span> renderNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>OpDispatcher<span class="token punctuation">)</span><span class="token punctuation">(</span>FrameBuilder <span class="token operator">&amp;</span> frameBuilder<span class="token punctuation">,</span> <span class="token keyword">const</span> RecordedOp<span class="token operator">&amp;</span> op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> OpDispatcher receivers<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BUILD_DEFERRABLE_OP_LUT</span><span class="token punctuation">(</span>OP_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">const</span> DisplayList<span class="token operator">&amp;</span> displayList <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>renderNode<span class="token punctuation">.</span><span class="token function">getDisplayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> chunk <span class="token operator">:</span> displayList<span class="token punctuation">.</span><span class="token function">getChunks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        FatVector<span class="token operator">&lt;</span>ZRenderNodeOpPair<span class="token punctuation">,</span> <span class="token number">16</span><span class="token operator">></span> zTranslatedNodes<span class="token punctuation">;</span>
        <span class="token function">buildZSortedChildList</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zTranslatedNodes<span class="token punctuation">,</span> displayList<span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">defer3dChildren</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>reorderClip<span class="token punctuation">,</span> ChildrenSelectMode<span class="token operator">::</span>Negative<span class="token punctuation">,</span> zTranslatedNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t opIndex <span class="token operator">=</span> chunk<span class="token punctuation">.</span>beginOpIndex<span class="token punctuation">;</span> opIndex <span class="token operator">&lt;</span> chunk<span class="token punctuation">.</span>endOpIndex<span class="token punctuation">;</span> opIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> RecordedOp<span class="token operator">*</span> op <span class="token operator">=</span> displayList<span class="token punctuation">.</span><span class="token function">getOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>opIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
            receivers<span class="token punctuation">[</span>op<span class="token operator">-</span><span class="token operator">></span>opId<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">*</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span><span class="token operator">!</span>renderNode<span class="token punctuation">.</span>mProjectedNodes<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                            displayList<span class="token punctuation">.</span>projectionReceiveIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                            <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>opIndex<span class="token punctuation">)</span> <span class="token operator">==</span> displayList<span class="token punctuation">.</span>projectionReceiveIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">deferProjectedChildren</span><span class="token punctuation">(</span>renderNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">defer3dChildren</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>reorderClip<span class="token punctuation">,</span> ChildrenSelectMode<span class="token operator">::</span>Positive<span class="token punctuation">,</span> zTranslatedNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个方法中，遍历了DisplayList的chunk，这个对象实际上就是记录当前RenderNode的op操作层级从哪里还是到哪里结束 。在这里面还是分为三步骤：</p>
<ul>
<li><p>1.buildZSortedChildList 根据chunk来重新对子RenderNode在Z轴上的排序，接着调用defer3dChildren(mode 为ChildrenSelectMode::Negative)处理已经拍好z轴顺序的zTranslatedNodes列表.</p>
</li>
<li><p>2.获取chunk记录当前op的起始位置和结束位置。以此为index获取当前DisplayList中记录的RecordedOp集合的位置。并且调用receivers这个OpDispatcher数组对应位置的方法指针执行对应RecordedOp操作。这个过程实际上是把RecordedOp转化为BakedOpState保存起来。</p>
</li>
<li><p>3.最后再调用defer3dChildren，mode为ChildrenSelectMode::Positive</p>
</li>
</ul>
<p>我们依次看看buildZSortedChildList，defer3dChildren以及receivers数组转化RecordedOp为BakeOpState的过程。</p>
<h6 id="FrameBuilder-buildZSortedChildList"><a href="#FrameBuilder-buildZSortedChildList" class="headerlink" title="FrameBuilder buildZSortedChildList"></a>FrameBuilder buildZSortedChildList</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> V<span class="token operator">></span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">buildZSortedChildList</span><span class="token punctuation">(</span>V<span class="token operator">*</span> zTranslatedNodes<span class="token punctuation">,</span> <span class="token keyword">const</span> DisplayList<span class="token operator">&amp;</span> displayList<span class="token punctuation">,</span>
                                  <span class="token keyword">const</span> DisplayList<span class="token operator">::</span>Chunk<span class="token operator">&amp;</span> chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>beginChildIndex <span class="token operator">==</span> chunk<span class="token punctuation">.</span>endChildIndex<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> chunk<span class="token punctuation">.</span>beginChildIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunk<span class="token punctuation">.</span>endChildIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RenderNodeOp<span class="token operator">*</span> childOp <span class="token operator">=</span> displayList<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        RenderNode<span class="token operator">*</span> child <span class="token operator">=</span> childOp<span class="token operator">-</span><span class="token operator">></span>renderNode<span class="token punctuation">;</span>
        <span class="token keyword">float</span> childZ <span class="token operator">=</span> child<span class="token operator">-</span><span class="token operator">></span><span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>MathUtils<span class="token operator">::</span><span class="token function">isZero</span><span class="token punctuation">(</span>childZ<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> chunk<span class="token punctuation">.</span>reorderChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            zTranslatedNodes<span class="token operator">-</span><span class="token operator">></span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">ZRenderNodeOpPair</span><span class="token punctuation">(</span>childZ<span class="token punctuation">,</span> childOp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            childOp<span class="token operator">-</span><span class="token operator">></span>skipInOrderDraw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token operator">-</span><span class="token operator">></span><span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProjectBackwards</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            childOp<span class="token operator">-</span><span class="token operator">></span>skipInOrderDraw <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    std<span class="token operator">::</span><span class="token function">stable_sort</span><span class="token punctuation">(</span>zTranslatedNodes<span class="token operator">-</span><span class="token operator">></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> zTranslatedNodes<span class="token operator">-</span><span class="token operator">></span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到是机上很简单，就是获取RenderNode每一个子RenderNode的Z轴的坐标，接着使用稳定排序，重排保存在zTranslatedNodes的所有的子RenderNode。</p>
<h6 id="FrameBuilder-defer3dChildren"><a href="#FrameBuilder-defer3dChildren" class="headerlink" title="FrameBuilder::defer3dChildren"></a>FrameBuilder::defer3dChildren</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> V<span class="token operator">></span>
<span class="token keyword">static</span> size_t <span class="token function">findNonNegativeIndex</span><span class="token punctuation">(</span><span class="token keyword">const</span> V<span class="token operator">&amp;</span> zTranslatedNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> zTranslatedNodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>zTranslatedNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">>=</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> zTranslatedNodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> V<span class="token operator">></span>
<span class="token keyword">void</span> FrameBuilder<span class="token operator">::</span><span class="token function">defer3dChildren</span><span class="token punctuation">(</span><span class="token keyword">const</span> ClipBase<span class="token operator">*</span> reorderClip<span class="token punctuation">,</span> ChildrenSelectMode mode<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> V<span class="token operator">&amp;</span> zTranslatedNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> size <span class="token operator">=</span> zTranslatedNodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> ChildrenSelectMode<span class="token operator">::</span>Negative <span class="token operator">&amp;&amp;</span> zTranslatedNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">></span> <span class="token number">0.0f</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>mode <span class="token operator">==</span> ChildrenSelectMode<span class="token operator">::</span>Positive <span class="token operator">&amp;&amp;</span> zTranslatedNodes<span class="token punctuation">[</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">&lt;</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> size_t nonNegativeIndex <span class="token operator">=</span> <span class="token function">findNonNegativeIndex</span><span class="token punctuation">(</span>zTranslatedNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t drawIndex<span class="token punctuation">,</span> shadowIndex<span class="token punctuation">,</span> endIndex<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> ChildrenSelectMode<span class="token operator">::</span>Negative<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        drawIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        endIndex <span class="token operator">=</span> nonNegativeIndex<span class="token punctuation">;</span>
        shadowIndex <span class="token operator">=</span> endIndex<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// draw no shadows</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        drawIndex <span class="token operator">=</span> nonNegativeIndex<span class="token punctuation">;</span>
        endIndex <span class="token operator">=</span> size<span class="token punctuation">;</span>
        shadowIndex <span class="token operator">=</span> drawIndex<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// potentially draw shadow for each pos Z child</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">float</span> lastCasterZ <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>shadowIndex <span class="token operator">&lt;</span> endIndex <span class="token operator">||</span> drawIndex <span class="token operator">&lt;</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shadowIndex <span class="token operator">&lt;</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> RenderNodeOp<span class="token operator">*</span> casterNodeOp <span class="token operator">=</span> zTranslatedNodes<span class="token punctuation">[</span>shadowIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">float</span> casterZ <span class="token operator">=</span> zTranslatedNodes<span class="token punctuation">[</span>shadowIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>shadowIndex <span class="token operator">==</span> drawIndex <span class="token operator">||</span> casterZ <span class="token operator">-</span> lastCasterZ <span class="token operator">&lt;</span> <span class="token number">0.1f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">deferShadow</span><span class="token punctuation">(</span>reorderClip<span class="token punctuation">,</span> <span class="token operator">*</span>casterNodeOp<span class="token punctuation">)</span><span class="token punctuation">;</span>

                lastCasterZ <span class="token operator">=</span> casterZ<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// must do this even if current caster not casting a shadow</span>
                shadowIndex<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> RenderNodeOp<span class="token operator">*</span> childOp <span class="token operator">=</span> zTranslatedNodes<span class="token punctuation">[</span>drawIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token function">deferRenderNodeOpImpl</span><span class="token punctuation">(</span><span class="token operator">*</span>childOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        drawIndex<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过findNonNegativeIndex找到第一个带有z轴的子RenderNode，否则是子RenderNode的总数大小，也就是统一z轴层次。<br>在这个方法根据ChildrenSelectMode两个流程：</p>
<ul>
<li><p>1.为ChildrenSelectMode::Negative时候，drawIndex为0，endIndex为第一个z轴子RenderNode，shadowIndex为endIndex。因此在下面那个循环，就不会走到deferShadow进行阴影的绘制。</p>
</li>
<li><p>2.为ChildrenSelectMode::Positive时候，则是相反。尽可能的绘制z轴上每一个层级上的阴影。</p>
</li>
</ul>
<p>最后调用deferRenderNodeOpImpl处理子renderNode。注意ChildrenSelectMode::Negative是获取第0个子RenderNode，而ChildrenSelectMode::Positive，则获取第一个带有z轴序列的renderNode。</p>
<h6 id="deferRenderNodeOpImpl"><a href="#deferRenderNodeOpImpl" class="headerlink" title="deferRenderNodeOpImpl"></a>deferRenderNodeOpImpl</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> FrameBuilder<span class="token operator">::</span><span class="token function">deferRenderNodeOpImpl</span><span class="token punctuation">(</span><span class="token keyword">const</span> RenderNodeOp<span class="token operator">&amp;</span> op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>op<span class="token punctuation">.</span>renderNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">nothingToDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> mCanvasState<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>SaveFlags<span class="token operator">::</span>MatrixClip<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mCanvasState<span class="token punctuation">.</span><span class="token function">writableSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">applyClip</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>localClip<span class="token punctuation">,</span>
                                               <span class="token operator">*</span>mCanvasState<span class="token punctuation">.</span><span class="token function">currentSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>transform<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mCanvasState<span class="token punctuation">.</span><span class="token function">concatMatrix</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>localMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">deferNodePropsAndOps</span><span class="token punctuation">(</span><span class="token operator">*</span>op<span class="token punctuation">.</span>renderNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mCanvasState<span class="token punctuation">.</span><span class="token function">restoreToCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> FrameBuilder<span class="token operator">::</span><span class="token function">deferNodePropsAndOps</span><span class="token punctuation">(</span>RenderNode<span class="token operator">&amp;</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">bool</span> quickRejected <span class="token operator">=</span> mCanvasState<span class="token punctuation">.</span><span class="token function">currentSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getRenderTargetClip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                         <span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getClipToBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                          mCanvasState<span class="token punctuation">.</span><span class="token function">quickRejectConservative</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>quickRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// HW layer</span>
            LayerOp<span class="token operator">*</span> drawLayerOp <span class="token operator">=</span> mAllocator<span class="token punctuation">.</span>create_trivial<span class="token operator">&lt;</span>LayerOp<span class="token operator">></span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            BakedOpState<span class="token operator">*</span> bakedOpState <span class="token operator">=</span> <span class="token function">tryBakeOpState</span><span class="token punctuation">(</span><span class="token operator">*</span>drawLayerOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bakedOpState<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token function">currentLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deferUnmergeableOp</span><span class="token punctuation">(</span>mAllocator<span class="token punctuation">,</span> bakedOpState<span class="token punctuation">,</span> OpBatchType<span class="token operator">::</span>Bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span><span class="token operator">!</span>saveLayerBounds<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SkPaint saveLayerPaint<span class="token punctuation">;</span>
            saveLayerPaint<span class="token punctuation">.</span><span class="token function">setAlpha</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getAlpha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">deferBeginLayerOp</span><span class="token punctuation">(</span><span class="token operator">*</span>mAllocator<span class="token punctuation">.</span>create_trivial<span class="token operator">&lt;</span>BeginLayerOp<span class="token operator">></span><span class="token punctuation">(</span>
                    saveLayerBounds<span class="token punctuation">,</span> Matrix4<span class="token operator">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">nullptr</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// no record-time clip - need only respect defer-time one</span>
                    <span class="token operator">&amp;</span>saveLayerPaint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">deferNodeOps</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">deferEndLayerOp</span><span class="token punctuation">(</span><span class="token operator">*</span>mAllocator<span class="token punctuation">.</span>create_trivial<span class="token operator">&lt;</span>EndLayerOp<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">deferNodeOps</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上这里可以分为2种子renderNode的情况：</p>
<ul>
<li><p>1.RenderNode 是一个重写onDraw的有内容的View(如ImageView，textView)。此时getLayer获得的OffscreenBuffer离屏渲染内存就不为空，也就是设置了RenderLayer的LayerType。那么说明原来RenderNode就有内容，保存在BakeOpState中。</p>
</li>
<li><p>2.如果是ViewGroup对应的RenderNode，必定不存在OffscreenBuffer。则会走两个流程。如果之前ViewGroup对应的RenderNode，也就是当前RenderNode的父renderNode已经把范围记录在saveLayerBounds，先通过deferBeginLayerOp压入一个BeginLayerOp确定范围保存当前状态，再调用deferNodeOps继续遍历孙子RenderNode，最后通过deferEndLayerOp 返回之前保存的状态生成一个全新的LayerOp保存到BakedOpState。</p>
</li>
</ul>
<h6 id="OpDispatcher-receivers执行RecordedOp的原理"><a href="#OpDispatcher-receivers执行RecordedOp的原理" class="headerlink" title="OpDispatcher receivers执行RecordedOp的原理"></a>OpDispatcher receivers执行RecordedOp的原理</h6><p>可能有点糊涂，这里分析一下可以看到receivers数组是这么定义：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">static</span> OpDispatcher receivers<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BUILD_DEFERRABLE_OP_LUT</span><span class="token punctuation">(</span>OP_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>而OP_RECEIVER又是这么定义的：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> OP_RECEIVER(Type)                                       \
    [](FrameBuilder&amp; frameBuilder, const RecordedOp&amp; op) {      \
        frameBuilder.defer##Type(static_cast&lt;const Type&amp;>(op)); \
    },</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到这里是根据传进来的RecordedOp如XXX类型，找到对应的frameBuilder.deferXXX方法。比如说，此时我们使用的是ColorOp，颜色操作。那么这个数组对应的位置执行的是frameBuilder.deferColorOp。遍历chunk中记录的对应index的RecordedOp，就是执行如下方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> FrameBuilder<span class="token operator">::</span><span class="token function">deferColorOp</span><span class="token punctuation">(</span><span class="token keyword">const</span> ColorOp<span class="token operator">&amp;</span> op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    BakedOpState<span class="token operator">*</span> bakedState <span class="token operator">=</span> <span class="token function">tryBakeUnboundedOpState</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bakedState<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// quick rejected</span>
    <span class="token function">currentLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deferUnmergeableOp</span><span class="token punctuation">(</span>mAllocator<span class="token punctuation">,</span> bakedState<span class="token punctuation">,</span> OpBatchType<span class="token operator">::</span>Vertices<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"> LayerBuilder<span class="token operator">&amp;</span> <span class="token function">currentLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>mLayerBuilders<span class="token punctuation">[</span>mLayerStack<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    BakedOpState<span class="token operator">*</span> <span class="token function">tryBakeUnboundedOpState</span><span class="token punctuation">(</span><span class="token keyword">const</span> RecordedOp<span class="token operator">&amp;</span> recordedOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> BakedOpState<span class="token operator">::</span><span class="token function">tryConstructUnbounded</span><span class="token punctuation">(</span>mAllocator<span class="token punctuation">,</span> <span class="token operator">*</span>mCanvasState<span class="token punctuation">.</span><span class="token function">writableSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                   recordedOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先把通过LinearAllocation生成一个BakedOpState对象，它持有了当前对应的绘制操作RecordedOp以及快照区域。</p>
<p>接着调用刚刚设置到mLayerBuilders的LayerBuilder的deferUnmergeableOp方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> LayerBuilder<span class="token operator">::</span><span class="token function">deferUnmergeableOp</span><span class="token punctuation">(</span>LinearAllocator<span class="token operator">&amp;</span> allocator<span class="token punctuation">,</span> BakedOpState<span class="token operator">*</span> op<span class="token punctuation">,</span>
                                      batchid_t batchId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onDeferOp</span><span class="token punctuation">(</span>allocator<span class="token punctuation">,</span> op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    OpBatch<span class="token operator">*</span> targetBatch <span class="token operator">=</span> mBatchLookup<span class="token punctuation">[</span>batchId<span class="token punctuation">]</span><span class="token punctuation">;</span>

    size_t insertBatchIndex <span class="token operator">=</span> mBatches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">locateInsertIndex</span><span class="token punctuation">(</span>batchId<span class="token punctuation">,</span> op<span class="token operator">-</span><span class="token operator">></span>computedState<span class="token punctuation">.</span>clippedBounds<span class="token punctuation">,</span> <span class="token punctuation">(</span>BatchBase<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>targetBatch<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token operator">&amp;</span>insertBatchIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        targetBatch<span class="token operator">-</span><span class="token operator">></span><span class="token function">batchOp</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        targetBatch <span class="token operator">=</span> allocator<span class="token punctuation">.</span>create<span class="token operator">&lt;</span>OpBatch<span class="token operator">></span><span class="token punctuation">(</span>batchId<span class="token punctuation">,</span> op<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBatchLookup<span class="token punctuation">[</span>batchId<span class="token punctuation">]</span> <span class="token operator">=</span> targetBatch<span class="token punctuation">;</span>
        mBatches<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mBatches<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> insertBatchIndex<span class="token punctuation">,</span> targetBatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一开始的mBatchLookup对应index的OpBatch都是null指针。因此会走到下面的targetBatch分支，创建一个OpBatch对象，插入对应类型id到mBatches中。如果能找到mBatches对应类型id，就调用batchOp方法保存新的BakedOpState到OpBatch。</p>
<p>当然让我们看看一共有多少种OpBatch的类型：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> OpBatchType <span class="token punctuation">{</span>
<span class="token keyword">enum</span> <span class="token punctuation">{</span>
    Bitmap<span class="token punctuation">,</span>
    MergedPatch<span class="token punctuation">,</span>
    AlphaVertices<span class="token punctuation">,</span>
    Vertices<span class="token punctuation">,</span>
    AlphaMaskTexture<span class="token punctuation">,</span>
    Text<span class="token punctuation">,</span>
    ColorText<span class="token punctuation">,</span>
    Shadow<span class="token punctuation">,</span>
    TextureLayer<span class="token punctuation">,</span>
    Functor<span class="token punctuation">,</span>
    CopyToLayer<span class="token punctuation">,</span>
    CopyFromLayer<span class="token punctuation">,</span>

    Count  <span class="token comment" spellcheck="true">// must be last</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="FrameBuilder的replayBakedOps"><a href="#FrameBuilder的replayBakedOps" class="headerlink" title="FrameBuilder的replayBakedOps"></a>FrameBuilder的replayBakedOps</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/FrameBuilder.h" target="_blank" rel="noopener">FrameBuilder.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> StaticDispatcher<span class="token punctuation">,</span> <span class="token keyword">typename</span> Renderer<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">replayBakedOps</span><span class="token punctuation">(</span>Renderer<span class="token operator">&amp;</span> renderer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>OffscreenBuffer<span class="token operator">*</span><span class="token operator">></span> temporaryLayers<span class="token punctuation">;</span>
        <span class="token function">finishDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> X(Type)                                                                   \
    [](void* renderer, const BakedOpState&amp; state) {                               \
        StaticDispatcher::on##Type(*(static_cast&lt;Renderer*>(renderer)),           \
                                   static_cast&lt;const Type&amp;>(*(state.op)), state); \
    },</span>
        <span class="token keyword">static</span> BakedOpReceiver unmergedReceivers<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BUILD_RENDERABLE_OP_LUT</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> X</span>


<span class="token macro property">#<span class="token directive keyword">define</span> X(Type)                                                                           \
    [](void* renderer, const MergedBakedOpList&amp; opList) {                                 \
        StaticDispatcher::onMerged##Type##s(*(static_cast&lt;Renderer*>(renderer)), opList); \
    },</span>
        <span class="token keyword">static</span> MergedOpReceiver mergedReceivers<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BUILD_MERGEABLE_OP_LUT</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> X</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mLayerBuilders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">GL_CHECKPOINT</span><span class="token punctuation">(</span>MODERATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            LayerBuilder<span class="token operator">&amp;</span> layer <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>mLayerBuilders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>renderNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                renderer<span class="token punctuation">.</span><span class="token function">startRepaintLayer</span><span class="token punctuation">(</span>layer<span class="token punctuation">.</span>offscreenBuffer<span class="token punctuation">,</span> layer<span class="token punctuation">.</span>repaintRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
                layer<span class="token punctuation">.</span><span class="token function">replayBakedOpsImpl</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>renderer<span class="token punctuation">,</span> unmergedReceivers<span class="token punctuation">,</span> mergedReceivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                renderer<span class="token punctuation">.</span><span class="token function">endLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_LIKELY</span><span class="token punctuation">(</span>mDrawFbo0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> LayerBuilder<span class="token operator">&amp;</span> fbo0 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>mLayerBuilders<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            renderer<span class="token punctuation">.</span><span class="token function">startFrame</span><span class="token punctuation">(</span>fbo0<span class="token punctuation">.</span>width<span class="token punctuation">,</span> fbo0<span class="token punctuation">.</span>height<span class="token punctuation">,</span> fbo0<span class="token punctuation">.</span>repaintRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fbo0<span class="token punctuation">.</span><span class="token function">replayBakedOpsImpl</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>renderer<span class="token punctuation">,</span> unmergedReceivers<span class="token punctuation">,</span> mergedReceivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            renderer<span class="token punctuation">.</span><span class="token function">endFrame</span><span class="token punctuation">(</span>fbo0<span class="token punctuation">.</span>repaintRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> temporaryLayer <span class="token operator">:</span> temporaryLayers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            renderer<span class="token punctuation">.</span><span class="token function">recycleTemporaryLayer</span><span class="token punctuation">(</span>temporaryLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先遍历mLayerBuilders中所有保存的LayerBuilder依次执行如下几个方法：</p>
<ul>
<li>1.Renderer的startFrame方法</li>
<li>2.LayerBuilder的replayBakedOpsImpl</li>
<li>3.Renderer的endFrame方法</li>
</ul>
<p>如果判断mDrawFbo0为true，再一次执行LayerBuilder第0个位置的LayerBuilder上面三个步骤。这个Render就是BakedOpRenderer。</p>
<p>注意replayBakedOpsImpl方法设置两个特殊的对象：</p>
<ul>
<li>1.BakedOpReceiver</li>
<li>2.MergedOpReceiver</li>
</ul>
<p>这两个参数作为方法指针传入到replayBakedOpsImpl中。这两个方法实际上分别对应2个宏。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> X(Type)                                                                   \
    [](void* renderer, const BakedOpState&amp; state) {                               \
        StaticDispatcher::on##Type(*(static_cast&lt;Renderer*>(renderer)),           \
                                   static_cast&lt;const Type&amp;>(*(state.op)), state); \
    },</span>
        <span class="token keyword">static</span> BakedOpReceiver unmergedReceivers<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BUILD_RENDERABLE_OP_LUT</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> X</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意StaticDispatcher这个实际上是一个范性对象，它实际上是指</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">frameBuilder<span class="token punctuation">.</span>replayBakedOps<span class="token operator">&lt;</span>BakedOpDispatcher<span class="token operator">></span><span class="token punctuation">(</span>renderer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>BakedOpDispatcher。</p>
<p>如果当前X传递进来的类型是BitmapOp，那么实际上保存的是：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">BakedOpDispatcher<span class="token operator">::</span>onBitmapOp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个方法。</p>
<p>同理，对于mergedReceivers，如果是BitmapOp则是：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">BakedOpDispatcher<span class="token operator">::</span>onMergedBitmapOps<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样就能对应每一个Type，执行一种操作。而对应合并操作，必须是同一种绘制操作，同一个透明度才能完成合并。</p>
<p>让我们依次看看这三个方法都做了什么吧。</p>
<h5 id="BakedOpRenderer-startFrame"><a href="#BakedOpRenderer-startFrame" class="headerlink" title="BakedOpRenderer startFrame"></a>BakedOpRenderer startFrame</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> BakedOpRenderer<span class="token operator">::</span><span class="token function">startFrame</span><span class="token punctuation">(</span>uint32_t width<span class="token punctuation">,</span> uint32_t height<span class="token punctuation">,</span> <span class="token keyword">const</span> Rect<span class="token operator">&amp;</span> repaintRect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mRenderState<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setViewport</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOpaque<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearColorBuffer</span><span class="token punctuation">(</span>repaintRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderState<span class="token operator">::</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>GLuint fbo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFramebuffer <span class="token operator">!=</span> fbo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mFramebuffer <span class="token operator">=</span> fbo<span class="token punctuation">;</span>
        <span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> mFramebuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单实际上就是绑定index为0的Framebuffer。0号帧缓冲就是默认的屏幕帧缓冲区。接着设置试图宽高，如果不是透明的则清空当前绘制区域的色值。</p>
<h5 id="LayerBuilder-replayBakedOpsImpl"><a href="#LayerBuilder-replayBakedOpsImpl" class="headerlink" title="LayerBuilder replayBakedOpsImpl"></a>LayerBuilder replayBakedOpsImpl</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> LayerBuilder<span class="token operator">::</span><span class="token function">replayBakedOpsImpl</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span> BakedOpReceiver<span class="token operator">*</span> unmergedReceivers<span class="token punctuation">,</span>
                                      MergedOpReceiver<span class="token operator">*</span> mergedReceivers<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> BatchBase<span class="token operator">*</span> batch <span class="token operator">:</span> mBatches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        size_t size <span class="token operator">=</span> batch<span class="token operator">-</span><span class="token operator">></span><span class="token function">getOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> batch<span class="token operator">-</span><span class="token operator">></span><span class="token function">isMerging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> opId <span class="token operator">=</span> batch<span class="token operator">-</span><span class="token operator">></span><span class="token function">getOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span>op<span class="token operator">-</span><span class="token operator">></span>opId<span class="token punctuation">;</span>
            <span class="token keyword">const</span> MergingOpBatch<span class="token operator">*</span> mergingBatch <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> MergingOpBatch<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            MergedBakedOpList data <span class="token operator">=</span> <span class="token punctuation">{</span>batch<span class="token operator">-</span><span class="token operator">></span><span class="token function">getOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span>
                                      mergingBatch<span class="token operator">-</span><span class="token operator">></span><span class="token function">getClipSideFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      mergingBatch<span class="token operator">-</span><span class="token operator">></span><span class="token function">getClipRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            mergedReceivers<span class="token punctuation">[</span>opId<span class="token punctuation">]</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> BakedOpState<span class="token operator">*</span> op <span class="token operator">:</span> batch<span class="token operator">-</span><span class="token operator">></span><span class="token function">getOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                unmergedReceivers<span class="token punctuation">[</span>op<span class="token operator">-</span><span class="token operator">></span>op<span class="token operator">-</span><span class="token operator">></span>opId<span class="token punctuation">]</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token operator">*</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之前通过deferUnmergeableOp的操作把所有的OpBatch保存到mBatches。此时在replayBakedOpsImpl开始遍历所有的OpBatch。</p>
<ul>
<li><p>1.如果OpBatch中保存的BakeOpState列表大小大于1，且允许合并。说明这是一个MergingOpBatch对象。先生成MergedBakedOpList对象后，在调用mergedReceivers对应index的BakedOpDispatcher::onMerged##Type##s的方法。</p>
</li>
<li><p>2.如果无法合并，只能遍历OpBatch中每一个BakedOpState进行一一绘制，此时调用的方法是mergedReceivers对应index的BakedOpDispatcher::on##Type。</p>
</li>
</ul>
<p>我们举个例子Bitmap的操作。</p>
<h5 id="关于Bitmap的操作"><a href="#关于Bitmap的操作" class="headerlink" title="关于Bitmap的操作"></a>关于Bitmap的操作</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> BakedOpDispatcher<span class="token operator">::</span><span class="token function">onBitmapOp</span><span class="token punctuation">(</span>BakedOpRenderer<span class="token operator">&amp;</span> renderer<span class="token punctuation">,</span> <span class="token keyword">const</span> BitmapOp<span class="token operator">&amp;</span> op<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> BakedOpState<span class="token operator">&amp;</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Texture<span class="token operator">*</span> texture <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">getTexture</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>texture<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> AutoTexture <span class="token function">autoCleanup</span><span class="token punctuation">(</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> textureFillFlags <span class="token operator">=</span> <span class="token punctuation">(</span>op<span class="token punctuation">.</span>bitmap<span class="token operator">-</span><span class="token operator">></span><span class="token function">colorType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kAlpha_8_SkColorType<span class="token punctuation">)</span>
                                         <span class="token operator">?</span> TextureFillFlags<span class="token operator">::</span>IsAlphaMaskTexture
                                         <span class="token operator">:</span> TextureFillFlags<span class="token operator">::</span>None<span class="token punctuation">;</span>
    Glop glop<span class="token punctuation">;</span>
    <span class="token function">GlopBuilder</span><span class="token punctuation">(</span>renderer<span class="token punctuation">.</span><span class="token function">renderState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> renderer<span class="token punctuation">.</span><span class="token function">caches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>glop<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setRoundRectClipState</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>roundRectClipState<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setMeshTexturedUnitQuad</span><span class="token punctuation">(</span>texture<span class="token operator">-</span><span class="token operator">></span>uvMapper<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setFillTexturePaint</span><span class="token punctuation">(</span><span class="token operator">*</span>texture<span class="token punctuation">,</span> textureFillFlags<span class="token punctuation">,</span> op<span class="token punctuation">.</span>paint<span class="token punctuation">,</span> state<span class="token punctuation">.</span>alpha<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>computedState<span class="token punctuation">.</span>transform<span class="token punctuation">,</span> TransformFlags<span class="token operator">::</span>None<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setModelViewMapUnitToRectSnap</span><span class="token punctuation">(</span><span class="token function">Rect</span><span class="token punctuation">(</span>texture<span class="token operator">-</span><span class="token operator">></span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> texture<span class="token operator">-</span><span class="token operator">></span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    renderer<span class="token punctuation">.</span><span class="token function">renderGlop</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> glop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程实际上就是获取Bitmap中的纹理为基础，以及其他的参数构成一个GlopBuilder生成glop对象。</p>
<p>最后调用renderer的renderGlop进行渲染</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> BakedOpDispatcher<span class="token operator">::</span><span class="token function">onMergedBitmapOps</span><span class="token punctuation">(</span>BakedOpRenderer<span class="token operator">&amp;</span> renderer<span class="token punctuation">,</span>
                                          <span class="token keyword">const</span> MergedBakedOpList<span class="token operator">&amp;</span> opList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> BakedOpState<span class="token operator">&amp;</span> firstState <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>opList<span class="token punctuation">.</span>states<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Bitmap<span class="token operator">*</span> bitmap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> BitmapOp<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>opList<span class="token punctuation">.</span>states<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span>op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>bitmap<span class="token punctuation">;</span>

    Texture<span class="token operator">*</span> texture <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">caches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textureCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>texture<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> AutoTexture <span class="token function">autoCleanup</span><span class="token punctuation">(</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>

    TextureVertex vertices<span class="token punctuation">[</span>opList<span class="token punctuation">.</span>count <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opList<span class="token punctuation">.</span>count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> BakedOpState<span class="token operator">&amp;</span> state <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>opList<span class="token punctuation">.</span>states<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TextureVertex<span class="token operator">*</span> rectVerts <span class="token operator">=</span> <span class="token operator">&amp;</span>vertices<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        Rect opBounds <span class="token operator">=</span> state<span class="token punctuation">.</span>op<span class="token operator">-</span><span class="token operator">></span>unmappedBounds<span class="token punctuation">;</span>
        state<span class="token punctuation">.</span>computedState<span class="token punctuation">.</span>transform<span class="token punctuation">.</span><span class="token function">mapRect</span><span class="token punctuation">(</span>opBounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_LIKELY</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>computedState<span class="token punctuation">.</span>transform<span class="token punctuation">.</span><span class="token function">isPureTranslate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opBounds<span class="token punctuation">.</span><span class="token function">snapToPixelBoundaries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">storeTexturedRect</span><span class="token punctuation">(</span>rectVerts<span class="token punctuation">,</span> opBounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        renderer<span class="token punctuation">.</span><span class="token function">dirtyRenderTarget</span><span class="token punctuation">(</span>opBounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> textureFillFlags <span class="token operator">=</span> <span class="token punctuation">(</span>bitmap<span class="token operator">-</span><span class="token operator">></span><span class="token function">colorType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kAlpha_8_SkColorType<span class="token punctuation">)</span>
                                         <span class="token operator">?</span> TextureFillFlags<span class="token operator">::</span>IsAlphaMaskTexture
                                         <span class="token operator">:</span> TextureFillFlags<span class="token operator">::</span>None<span class="token punctuation">;</span>
    Glop glop<span class="token punctuation">;</span>
    <span class="token function">GlopBuilder</span><span class="token punctuation">(</span>renderer<span class="token punctuation">.</span><span class="token function">renderState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> renderer<span class="token punctuation">.</span><span class="token function">caches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>glop<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setRoundRectClipState</span><span class="token punctuation">(</span>firstState<span class="token punctuation">.</span>roundRectClipState<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setMeshTexturedIndexedQuads</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> opList<span class="token punctuation">.</span>count <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setFillTexturePaint</span><span class="token punctuation">(</span><span class="token operator">*</span>texture<span class="token punctuation">,</span> textureFillFlags<span class="token punctuation">,</span> firstState<span class="token punctuation">.</span>op<span class="token operator">-</span><span class="token operator">></span>paint<span class="token punctuation">,</span> firstState<span class="token punctuation">.</span>alpha<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span>Matrix4<span class="token operator">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TransformFlags<span class="token operator">::</span>None<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setModelViewIdentityEmptyBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ClipRect <span class="token function">renderTargetClip</span><span class="token punctuation">(</span>opList<span class="token punctuation">.</span>clip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ClipBase<span class="token operator">*</span> clip <span class="token operator">=</span> opList<span class="token punctuation">.</span>clipSideFlags <span class="token operator">?</span> <span class="token operator">&amp;</span>renderTargetClip <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    renderer<span class="token punctuation">.</span><span class="token function">renderGlop</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> clip<span class="token punctuation">,</span> glop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于merge来说，由于是希望把多个操作合并到一起，因此每一个绘制操作的区域可能不哦不同，因此需要计算最大的操作区域，以及不断的记录每一个操作对应脏区到mRenderTarget结构体中。</p>
<p>最后还是调用renderGlop进行渲染。不同的是，此时还传了裁剪区域ClipRect到BakedOpRenderer中。</p>
<h5 id="BakedOpRenderer-renderGlop"><a href="#BakedOpRenderer-renderGlop" class="headerlink" title="BakedOpRenderer renderGlop"></a>BakedOpRenderer renderGlop</h5><pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">void</span> <span class="token function">renderGlop</span><span class="token punctuation">(</span><span class="token keyword">const</span> BakedOpState<span class="token operator">&amp;</span> state<span class="token punctuation">,</span> <span class="token keyword">const</span> Glop<span class="token operator">&amp;</span> glop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">renderGlop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">.</span>computedState<span class="token punctuation">.</span>clippedBounds<span class="token punctuation">,</span> state<span class="token punctuation">.</span>computedState<span class="token punctuation">.</span><span class="token function">getClipIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> glop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">renderGlop</span><span class="token punctuation">(</span><span class="token keyword">const</span> Rect<span class="token operator">*</span> dirtyBounds<span class="token punctuation">,</span> <span class="token keyword">const</span> ClipBase<span class="token operator">*</span> clip<span class="token punctuation">,</span> <span class="token keyword">const</span> Glop<span class="token operator">&amp;</span> glop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mGlopReceiver</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> dirtyBounds<span class="token punctuation">,</span> clip<span class="token punctuation">,</span> glop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到最后是调用了mGlopReceiver这个函数 指针。这个mGlopReceiver实际上是什么呢？我们来看看BakedOpRenderer的构造函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token function">BakedOpRenderer</span><span class="token punctuation">(</span>Caches<span class="token operator">&amp;</span> caches<span class="token punctuation">,</span> RenderState<span class="token operator">&amp;</span> renderState<span class="token punctuation">,</span> <span class="token keyword">bool</span> opaque<span class="token punctuation">,</span> <span class="token keyword">bool</span> wideColorGamut<span class="token punctuation">,</span>
                    <span class="token keyword">const</span> LightInfo<span class="token operator">&amp;</span> lightInfo<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">mGlopReceiver</span><span class="token punctuation">(</span>DefaultGlopReceiver<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">mRenderState</span><span class="token punctuation">(</span>renderState<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">mCaches</span><span class="token punctuation">(</span>caches<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">mOpaque</span><span class="token punctuation">(</span>opaque<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">mWideColorGamut</span><span class="token punctuation">(</span>wideColorGamut<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">mLightInfo</span><span class="token punctuation">(</span>lightInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DefaultGlopReceiver</span><span class="token punctuation">(</span>BakedOpRenderer<span class="token operator">&amp;</span> renderer<span class="token punctuation">,</span> <span class="token keyword">const</span> Rect<span class="token operator">*</span> dirtyBounds<span class="token punctuation">,</span>
                                    <span class="token keyword">const</span> ClipBase<span class="token operator">*</span> clip<span class="token punctuation">,</span> <span class="token keyword">const</span> Glop<span class="token operator">&amp;</span> glop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        renderer<span class="token punctuation">.</span><span class="token function">renderGlopImpl</span><span class="token punctuation">(</span>dirtyBounds<span class="token punctuation">,</span> clip<span class="token punctuation">,</span> glop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上它调用就是BakedOpRenderer的renderGlopImpl方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> BakedOpRenderer<span class="token operator">::</span><span class="token function">renderGlopImpl</span><span class="token punctuation">(</span><span class="token keyword">const</span> Rect<span class="token operator">*</span> dirtyBounds<span class="token punctuation">,</span> <span class="token keyword">const</span> ClipBase<span class="token operator">*</span> clip<span class="token punctuation">,</span>
                                     <span class="token keyword">const</span> Glop<span class="token operator">&amp;</span> glop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">prepareRender</span><span class="token punctuation">(</span>dirtyBounds<span class="token punctuation">,</span> clip<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> overrideDisableBlending <span class="token operator">=</span> <span class="token operator">!</span>mHasDrawn <span class="token operator">&amp;&amp;</span> mOpaque <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mRenderTarget<span class="token punctuation">.</span>frameBufferId <span class="token operator">&amp;&amp;</span>
                                   glop<span class="token punctuation">.</span>blend<span class="token punctuation">.</span>src <span class="token operator">==</span> GL_ONE <span class="token operator">&amp;&amp;</span>
                                   glop<span class="token punctuation">.</span>blend<span class="token punctuation">.</span>dst <span class="token operator">==</span> GL_ONE_MINUS_SRC_ALPHA<span class="token punctuation">;</span>
    mRenderState<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>glop<span class="token punctuation">,</span> mRenderTarget<span class="token punctuation">.</span>orthoMatrix<span class="token punctuation">,</span> overrideDisableBlending<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mRenderTarget<span class="token punctuation">.</span>frameBufferId<span class="token punctuation">)</span> mHasDrawn <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>做了两件是将：</p>
<ul>
<li>1.prepareRender 打开裁剪区域，模版测试，为帧缓冲区绑定颜色附件</li>
<li>2.调用了RenderState的render方法。</li>
</ul>
<h6 id="prepareRender"><a href="#prepareRender" class="headerlink" title="prepareRender"></a>prepareRender</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> BakedOpRenderer<span class="token operator">::</span><span class="token function">prepareRender</span><span class="token punctuation">(</span><span class="token keyword">const</span> Rect<span class="token operator">*</span> dirtyBounds<span class="token punctuation">,</span> <span class="token keyword">const</span> ClipBase<span class="token operator">*</span> clip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mRenderState<span class="token punctuation">.</span><span class="token function">scissor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span>clip <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mRenderState<span class="token punctuation">.</span><span class="token function">scissor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mRenderTarget<span class="token punctuation">.</span>viewportHeight<span class="token punctuation">,</span> clip<span class="token operator">-</span><span class="token operator">></span>rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_LIKELY</span><span class="token punctuation">(</span><span class="token operator">!</span>Properties<span class="token operator">::</span>debugOverdraw<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span>clip <span class="token operator">&amp;&amp;</span> clip<span class="token operator">-</span><span class="token operator">></span>mode <span class="token operator">!=</span> ClipMode<span class="token operator">::</span>Rectangle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mRenderTarget<span class="token punctuation">.</span>lastStencilClip <span class="token operator">!=</span> clip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mRenderTarget<span class="token punctuation">.</span>lastStencilClip <span class="token operator">=</span> clip<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mRenderTarget<span class="token punctuation">.</span>frameBufferId <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mRenderTarget<span class="token punctuation">.</span>stencil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    OffscreenBuffer<span class="token operator">*</span> layer <span class="token operator">=</span> mRenderTarget<span class="token punctuation">.</span>offscreenBuffer<span class="token punctuation">;</span>
                    mRenderTarget<span class="token punctuation">.</span>stencil <span class="token operator">=</span> mCaches<span class="token punctuation">.</span>renderBufferCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                            Stencil<span class="token operator">::</span><span class="token function">getLayerStencilFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> layer<span class="token operator">-</span><span class="token operator">></span>texture<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            layer<span class="token operator">-</span><span class="token operator">></span>texture<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">glFramebufferRenderbuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_STENCIL_ATTACHMENT<span class="token punctuation">,</span>
                                              GL_RENDERBUFFER<span class="token punctuation">,</span> mRenderTarget<span class="token punctuation">.</span>stencil<span class="token operator">-</span><span class="token operator">></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>clip<span class="token operator">-</span><span class="token operator">></span>mode <span class="token operator">==</span> ClipMode<span class="token operator">::</span>RectangleList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">setupStencilRectList</span><span class="token punctuation">(</span>clip<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">setupStencilRegion</span><span class="token punctuation">(</span>clip<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> incrementThreshold <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_LIKELY</span><span class="token punctuation">(</span>clip<span class="token operator">-</span><span class="token operator">></span>mode <span class="token operator">==</span> ClipMode<span class="token operator">::</span>RectangleList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> rectList <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> ClipRectList<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>clip<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>rectList<span class="token punctuation">;</span>
                    incrementThreshold <span class="token operator">=</span> rectList<span class="token punctuation">.</span><span class="token function">getTransformedRectanglesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mRenderState<span class="token punctuation">.</span><span class="token function">stencil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enableTest</span><span class="token punctuation">(</span>incrementThreshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mRenderState<span class="token punctuation">.</span><span class="token function">stencil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirtyBounds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dirtyRenderTarget</span><span class="token punctuation">(</span><span class="token operator">*</span>dirtyBounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上这里面的逻辑都是关于OpenGL 模版测试是否打开，如果有裁剪区域则打开裁剪功能。其中最重要的一点就是从Caches中获取一个宽高一致的渲染缓冲对象，通过glFramebufferRenderbuffer绑定到帧缓冲区。</p>
<h6 id="RenderState的render方法"><a href="#RenderState的render方法" class="headerlink" title="RenderState的render方法"></a>RenderState的render方法</h6><p>下面这段代码十分冗长，我只节选比较核心的，其实都是我之前和大家聊过的OpenGL es的套路操作</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderState<span class="token operator">::</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">const</span> Glop<span class="token operator">&amp;</span> glop<span class="token punctuation">,</span> <span class="token keyword">const</span> Matrix4<span class="token operator">&amp;</span> orthoMatrix<span class="token punctuation">,</span>
                         <span class="token keyword">bool</span> overrideDisableBlending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> Glop<span class="token operator">::</span>Mesh<span class="token operator">&amp;</span> mesh <span class="token operator">=</span> glop<span class="token punctuation">.</span>mesh<span class="token punctuation">;</span>
    <span class="token keyword">const</span> Glop<span class="token operator">::</span>Mesh<span class="token operator">::</span>Vertices<span class="token operator">&amp;</span> vertices <span class="token operator">=</span> mesh<span class="token punctuation">.</span>vertices<span class="token punctuation">;</span>
    <span class="token keyword">const</span> Glop<span class="token operator">::</span>Mesh<span class="token operator">::</span>Indices<span class="token operator">&amp;</span> indices <span class="token operator">=</span> mesh<span class="token punctuation">.</span>indices<span class="token punctuation">;</span>
    <span class="token keyword">const</span> Glop<span class="token operator">::</span>Fill<span class="token operator">&amp;</span> fill <span class="token operator">=</span> glop<span class="token punctuation">.</span>fill<span class="token punctuation">;</span>

    <span class="token function">GL_CHECKPOINT</span><span class="token punctuation">(</span>MODERATE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ---------------------------------------------</span>
    <span class="token comment" spellcheck="true">// ---------- Program + uniform setup ----------</span>
    <span class="token comment" spellcheck="true">// ---------------------------------------------</span>
    mCaches<span class="token operator">-</span><span class="token operator">></span><span class="token function">setProgram</span><span class="token punctuation">(</span>fill<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fill<span class="token punctuation">.</span>colorEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fill<span class="token punctuation">.</span>program<span class="token operator">-</span><span class="token operator">></span><span class="token function">setColor</span><span class="token punctuation">(</span>fill<span class="token punctuation">.</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fill<span class="token punctuation">.</span>program<span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span>orthoMatrix<span class="token punctuation">,</span> glop<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>modelView<span class="token punctuation">,</span> glop<span class="token punctuation">.</span>transform<span class="token punctuation">.</span><span class="token function">meshTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      glop<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>transformFlags <span class="token operator">&amp;</span> TransformFlags<span class="token operator">::</span>OffsetByFudgeFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// --------------------------------</span>
    <span class="token comment" spellcheck="true">// ---------- Mesh setup ----------</span>
    <span class="token comment" spellcheck="true">// --------------------------------</span>
    <span class="token comment" spellcheck="true">// vertices</span>
    <span class="token function">meshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindMeshBuffer</span><span class="token punctuation">(</span>vertices<span class="token punctuation">.</span>bufferObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">meshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindPositionVertexPointer</span><span class="token punctuation">(</span>vertices<span class="token punctuation">.</span>position<span class="token punctuation">,</span> vertices<span class="token punctuation">.</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// indices</span>
    <span class="token function">meshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindIndicesBuffer</span><span class="token punctuation">(</span>indices<span class="token punctuation">.</span>bufferObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// ------------------------------------</span>
    <span class="token comment" spellcheck="true">// ---------- GL state setup ----------</span>
    <span class="token comment" spellcheck="true">// ------------------------------------</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


    <span class="token comment" spellcheck="true">// ------------------------------------</span>
    <span class="token comment" spellcheck="true">// ---------- Actual drawing ----------</span>
    <span class="token comment" spellcheck="true">// ------------------------------------</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>indices<span class="token punctuation">.</span>bufferObject <span class="token operator">==</span> <span class="token function">meshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQuadListIBO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        GLsizei elementsCount <span class="token operator">=</span> mesh<span class="token punctuation">.</span>elementCount<span class="token punctuation">;</span>
        <span class="token keyword">const</span> GLbyte<span class="token operator">*</span> vertexData <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> GLbyte<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>vertices<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>elementsCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            GLsizei drawCount <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>elementsCount<span class="token punctuation">,</span> <span class="token punctuation">(</span>GLsizei<span class="token punctuation">)</span>kMaxNumberOfQuads <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            GLsizei vertexCount <span class="token operator">=</span> <span class="token punctuation">(</span>drawCount <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token function">meshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindPositionVertexPointer</span><span class="token punctuation">(</span>vertexData<span class="token punctuation">,</span> vertices<span class="token punctuation">.</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>vertices<span class="token punctuation">.</span>attribFlags <span class="token operator">&amp;</span> VertexAttribFlags<span class="token operator">::</span>TextureCoord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">meshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTexCoordsVertexPointer</span><span class="token punctuation">(</span>vertexData <span class="token operator">+</span> kMeshTextureOffset<span class="token punctuation">,</span>
                                                       vertices<span class="token punctuation">.</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCaches<span class="token operator">-</span><span class="token operator">></span><span class="token function">extensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMajorGlVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">glDrawRangeElements</span><span class="token punctuation">(</span>mesh<span class="token punctuation">.</span>primitiveMode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> vertexCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> drawCount<span class="token punctuation">,</span>
                                    GL_UNSIGNED_SHORT<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">glDrawElements</span><span class="token punctuation">(</span>mesh<span class="token punctuation">.</span>primitiveMode<span class="token punctuation">,</span> drawCount<span class="token punctuation">,</span> GL_UNSIGNED_SHORT<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            elementsCount <span class="token operator">-</span><span class="token operator">=</span> drawCount<span class="token punctuation">;</span>
            vertexData <span class="token operator">+</span><span class="token operator">=</span> vertexCount <span class="token operator">*</span> vertices<span class="token punctuation">.</span>stride<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>indices<span class="token punctuation">.</span>bufferObject <span class="token operator">||</span> indices<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCaches<span class="token operator">-</span><span class="token operator">></span><span class="token function">extensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMajorGlVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">glDrawRangeElements</span><span class="token punctuation">(</span>mesh<span class="token punctuation">.</span>primitiveMode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mesh<span class="token punctuation">.</span>vertexCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> mesh<span class="token punctuation">.</span>elementCount<span class="token punctuation">,</span>
                                GL_UNSIGNED_SHORT<span class="token punctuation">,</span> indices<span class="token punctuation">.</span>indices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">glDrawElements</span><span class="token punctuation">(</span>mesh<span class="token punctuation">.</span>primitiveMode<span class="token punctuation">,</span> mesh<span class="token punctuation">.</span>elementCount<span class="token punctuation">,</span> GL_UNSIGNED_SHORT<span class="token punctuation">,</span>
                           indices<span class="token punctuation">.</span>indices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">glDrawArrays</span><span class="token punctuation">(</span>mesh<span class="token punctuation">.</span>primitiveMode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mesh<span class="token punctuation">.</span>elementCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// -----------------------------------</span>
    <span class="token comment" spellcheck="true">// ---------- Mesh teardown ----------</span>
    <span class="token comment" spellcheck="true">// -----------------------------------</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vertices<span class="token punctuation">.</span>attribFlags <span class="token operator">&amp;</span> VertexAttribFlags<span class="token operator">::</span>Alpha<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">glDisableVertexAttribArray</span><span class="token punctuation">(</span>alphaLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vertices<span class="token punctuation">.</span>attribFlags <span class="token operator">&amp;</span> VertexAttribFlags<span class="token operator">::</span>Color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">glDisableVertexAttribArray</span><span class="token punctuation">(</span>colorLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">GL_CHECKPOINT</span><span class="token punctuation">(</span>MODERATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>都是套路操作，首先执行在Glop中初始化好的GLProgram对象，接着处理vbo和vao对象，并且bindPositionVertexPointer告诉OpenGL es应该如何进行操作解析vbo和vao。最后根据条件执行glElementDraw还是glDrawArrays方法，根据索引绘制还是默认的进行glDrawArrays绘制。</p>
<p>最后通过渲染管道的swapBuffers，把Surface中的内存发送到SF进程中处理。最后回调在ViewRootImpl设置的FrameCompleteCallback，也就是pendingDrawFinished方法。</p>
<h3 id="ViewRootImpl-pendingDrawFinished"><a href="#ViewRootImpl-pendingDrawFinished" class="headerlink" title="ViewRootImpl pendingDrawFinished"></a>ViewRootImpl pendingDrawFinished</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">pendingDrawFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDrawsNeededToReport <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Unbalanced drawPending/pendingDrawFinished calls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mDrawsNeededToReport<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDrawsNeededToReport <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reportDrawFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后和之前<a href="https://www.jianshu.com/p/a4fb6a02ad53" target="_blank" rel="noopener">onDraw</a>总结一文一样，通知WMS已经执行完了draw流程，允许下一次performTraversals可以进行relayoutWindow对窗体进行测量。</p>
<p>到这里硬件渲染一次渲染就结束了。</p>
<h3 id="Vsync信号-的硬件刷新原理"><a href="#Vsync信号-的硬件刷新原理" class="headerlink" title="Vsync信号 的硬件刷新原理"></a>Vsync信号 的硬件刷新原理</h3><p>硬件渲染但是还没有结束，硬件渲染的RenderThread还监听了Vsync信号。实际上为了更加快捷的进行渲染，RenderThread会自己在native进行监听，并且执行类似ViewRootImpl的循环流程。</p>
<p>我们来看看上一篇文章和大家聊过的，当Vsync信号到来最终会执行如下方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderThread<span class="token operator">::</span><span class="token function">dispatchFrameCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mFrameCallbackTaskPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    std<span class="token operator">::</span>set<span class="token operator">&lt;</span>IFrameCallback<span class="token operator">*</span><span class="token operator">></span> callbacks<span class="token punctuation">;</span>
    mFrameCallbacks<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">requestVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token operator">::</span>set<span class="token operator">&lt;</span>IFrameCallback<span class="token operator">*</span><span class="token operator">></span><span class="token operator">::</span>iterator it <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> callbacks<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">doFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么这个IFrameCallback对象是何时注册进来的呢？我之前在聊ViewRootImpl的时候有一个方法我忽略了。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">scheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTraversalScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTraversalScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mTraversalBarrier <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postSyncBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mChoreographer<span class="token punctuation">.</span><span class="token function">postCallback</span><span class="token punctuation">(</span>
                    Choreographer<span class="token punctuation">.</span>CALLBACK_TRAVERSAL<span class="token punctuation">,</span> mTraversalRunnable<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">notifyRendererOfFramePending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pokeDrawLockIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>每当mChoreographer发送一个CALLBACK_TRAVERSAL到Handler的Loop中进行下一轮的View绘制流程处理后，会执行notifyRendererOfFramePending方法：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">notifyRendererOfFramePending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">notifyFramePending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而这个方法实际上就是ThreadedRenderer通过RenderProxy，调用了CanvasContext的pushBackFrameCallback：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CanvasContext<span class="token operator">::</span><span class="token function">notifyFramePending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mRenderThread<span class="token punctuation">.</span><span class="token function">pushBackFrameCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>到这里，才真正的注册了CanvasContext的回调。换句话说，每当RenderThread接收到了VSync信号就会走到CanvasContext的doFrame回调中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CanvasContext<span class="token operator">::</span><span class="token function">doFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mRenderPipeline<span class="token operator">-</span><span class="token operator">></span><span class="token function">isSurfaceReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token function">prepareAndDraw</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CanvasContext<span class="token operator">::</span><span class="token function">prepareAndDraw</span><span class="token punctuation">(</span>RenderNode<span class="token operator">*</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    nsecs_t vsync <span class="token operator">=</span> mRenderThread<span class="token punctuation">.</span><span class="token function">timeLord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">computeFrameTimeNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    int64_t frameInfo<span class="token punctuation">[</span>UI_THREAD_FRAME_INFO_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">UiFrameInfoBuilder</span><span class="token punctuation">(</span>frameInfo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFlag</span><span class="token punctuation">(</span>FrameInfoFlags<span class="token operator">::</span>RTAnimation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setVsync</span><span class="token punctuation">(</span>vsync<span class="token punctuation">,</span> vsync<span class="token punctuation">)</span><span class="token punctuation">;</span>

    TreeInfo <span class="token function">info</span><span class="token punctuation">(</span>TreeInfo<span class="token operator">::</span>MODE_RT_ONLY<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prepareTree</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> frameInfo<span class="token punctuation">,</span> <span class="token function">systemTime</span><span class="token punctuation">(</span>CLOCK_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>out<span class="token punctuation">.</span>canDrawThisFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">waitOnFences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程和之前的几乎一致：</p>
<ul>
<li>1.prepareTree 处理整个View的显示层级,构建绘制操作recordedOp以及生成OffscreenBuffer</li>
<li>2.draw 进行渲染</li>
</ul>
<p>如果此时已经在绘制了，canDrawThisFrame为false，则对fence进行等待。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到这里硬件渲染的主要流程和原理和大家已经解析，关于Skia的渲染管道以及Vulkan相关渲染管道相关的操作，在这里就不多赘述了。不过关于Skia相关的专题会等到IMS，PMS，另外三个组建和大家聊完了，我们再回头看看。</p>
<p>老规矩，先让我们上时序图：<br><img src="/images/%E7%A1%AC%E4%BB%B6%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B.jpg" alt="硬件渲染流程.jpg"></p>
<p>关于总体流程的总结可以阅读我写的上一篇文章：<a href="https://www.jianshu.com/p/c84bfa909810" target="_blank" rel="noopener">Android 重学系列 View的绘制流程(六) 硬件渲染(上)</a>。</p>
<p>我们只需要关注ThreadedRenderer绘制流程的中做了什么？当ThreadedRenderer准备开始绘制，则会通知RenderProxy，把绘制事件压入RenderThread进行排队执行后，从DrawFrameTask的run方法开始绘制。</p>
<p>在DrawFrameTask中主要执行了两个步骤：</p>
<ul>
<li><p>1.syncFrameState 从名字就能知道是同步每一帧的状态，而这个方法的核心就是调用prepareTree从RootRenderNode开始遍历整个View显示层级。</p>
<ul>
<li>第一步执行了drawGLFunctor2注入的OpenGL的回调方法；</li>
<li>第二步尝试着读取当前RenderNode对应的纹理缓存，如果缓存生效可以不阻塞ui线程；</li>
<li>第三步根据层级的脏区计算出整个视图的总脏区；</li>
<li>第四步把需要刷新的RenderNode记录到LayerUpdateQueue中</li>
<li>第五步为每一个需要绘制View的RenderNode，创建一个离屏渲染缓存</li>
</ul>
</li>
<li><p>2.CanvasContext的draw方法，执行如下几个步骤：</p>
<ul>
<li>第一步通过computeDirtyRect把计算好的脏区拷贝到包含OpenGL es的EGLSurface对象Frame中</li>
<li>第二步 构建FrameBuilder对象，并且调用deferLayers方法。在deferLayer方法中，先通过saveForLayer保存每一个LayerBuilder在FrameBuilder的LayerBuilders集合中；接着调用deferNodeOps，调用buildZSortedChildList处理每一个子RenderNode的z轴上的顺序，defer3dChildren处理每一个子RenderNode上是否需要对阴影进行处理。遍历保存在DisplayList对象中的chunk集合对象，以chunk记录的索引获取当前的RecordedOp绘制操作，并且调用每一个操作的defer(类型)Op,把RecordedOp转化为BakeStateOp对象</li>
</ul>
</li>
<li><p>第三步 调用FrameBuilder的replayBakedOps方法，这个方法会通过一个BakedOpDispatcher对象为对应的绘制类型，找到对应on(类型)Op方法 构建一个Glop对象传递到BakedOpRenderer 中开始渲染。如果遇到绘制类型，画笔，透明度一致则变成找到onMerged(类型)Ops，合并绘制操作之后，最后才构成Glop对象传递到BakedOpRenderer 中开始渲染。</p>
</li>
<li><p>第四步 BakedOpRenderer最后会通过RenderState真正的开始渲染。同时会解开通过建造者模式构造的Glop对象内容，开始OpenGL es的绘制。</p>
</li>
</ul>
<p>经历了2大步骤，9个小步骤才在RenderThread中完成了渲染的行为。</p>
<p>当然，在其中绘制操作对象RecordedOp经历了几个比较重大的转变。<br><img src="/images/RecordedOp%E8%BD%AC%E5%8C%96.png" alt="RecordedOp转化.png"></p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>我们来比较一下硬件渲染系列文章以及<a href="https://www.jianshu.com/p/a4fb6a02ad53" target="_blank" rel="noopener">软件渲染</a>文章，可以发现两者最大的不同。软件渲染所有的工作都在ui主线程中的Looper排队处理渲染事件；</p>
<p>而硬件渲染不同的地方就是一旦到达了performDraw开始绘制的步骤，所有的流程就会切换到渲染线程RenderThread的Looper中排队渲染。</p>
<p>下面是一个示意图：<br><img src="/images/%E8%BD%AF%E7%A1%AC%E4%BB%B6%E6%B8%B2%E6%9F%93%E9%80%BB%E8%BE%91%E6%AF%94%E5%AF%B9.jpg" alt="软硬件渲染逻辑比对.jpg"></p>
<p>所以很多说ui渲染优化说打开硬件渲染进行优化，这是正确的。这是因为在这些流程中最消耗事件就是绘制。如果我们把绘制的步骤放在另外一个RenderThread线程中的Looper执行，就能降低ui线程的压力。</p>
<p>那么我们能不能再大胆一点，把performMeasure和performLayout，也就是测量和排版统统移动到另外一个测量线程中完成测量。让我们的主线程完全脱离ui线程的逻辑，成为名副其实的业务线程。</p>
<h3 id="关于ui渲染优化和Litho的介绍"><a href="#关于ui渲染优化和Litho的介绍" class="headerlink" title="关于ui渲染优化和Litho的介绍"></a>关于ui渲染优化和Litho的介绍</h3><p>实际上确实有人这么做了，facebook开源了一个<a href="https://github.com/facebook/litho">Litho</a>的异步测量的绘制库。Litho这个库最大的问题就是抛弃了Android原来流水线式开发，需要接受一种新的理念，更加接近React的理念，万物皆组件(Component)。在这一点的设计思路上flutter倒是学习了不少。litho和Android的布局比起来更为的简单。它只有一种布局那就是flexbox布局，由于在代码中编写，所以目前为止还没办法在AS中直观看到编写结果。<br><img src="/images/litho%E7%BA%BF%E7%A8%8B%E8%AE%BE%E8%AE%A1.png" alt="litho线程设计.png"></p>
<p>它又是怎么工作的呢？这里不会有太多介绍，下面是一个示意图：<br><img src="/images/litho%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png" alt="litho工作原理.png"></p>
<p>为了能够在多线程中正常进行控件的测量，Litho为每一个控件添加几个状态：</p>
<ul>
<li>@OnPrepare，准备阶段，进行一些初始化操作。</li>
<li>@OnMeasure，负责布局的计算。</li>
<li>@OnBoundsDefined，在布局计算完成后挂载视图前做一些操作。</li>
<li>@OnCreateMountContent，创建需要挂载的视图。</li>
<li>@OnMount，挂载视图，完成布局相关的设置。</li>
<li>@OnBind，绑定视图，完成数据和视图的绑定。</li>
<li>@OnUnBind，解绑视图，主要用于重置视图的数据相关的属性，防止出现复用问题。</li>
<li>@OnUnmount，卸载视图，主要用于重置视图的布局相关的属性，防止出现复用问题。</li>
</ul>
<p>其原理是怎么样子的呢？Litho的源码也不难，有空和大家聊聊。他的设计和flutter有同工异曲之妙。Flutter实际上是在Activity中有且只有一个FlutterNativeView，之后所有的绘制操作都在这个View上通过Skia进行。而LItho也是一样，全局只有一个LithoView，所有的绘制都是从LithoView开始，在LithoView中通过yoga库不断的给LithoView添加绘制节点(YogaNode)。</p>
<p>那么对于Android系统来说，onMeasure和onLayout以及onDraw只会有一个层级那就是LithoView。<br><img src="/images/Litho.jpg" alt="Litho.jpg"><br>能看到在Litho中已经把performMeasure，performLayout，performDraw接管过来了。</p>
<p>整个流程中，只要LithoView需要开始绘制了从onMeasure开始进行布局就会完全把遍历组件树的逻辑接管过来，执行上面几个注解对应的步骤。当执行完布局的测量和摆放后，就会执行Yoga节点的绘制。当然LithoView默认是同步布局测量，只有在RecyclerView类似的列表组件中，才会进行异步布局。当然它也如下核心方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setRootAndSizeSpecInternal</span><span class="token punctuation">(</span>
      Component root<span class="token punctuation">,</span>
      <span class="token keyword">int</span> widthSpec<span class="token punctuation">,</span>
      <span class="token keyword">int</span> heightSpec<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isAsync<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> Size output<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@CalculateLayoutSource</span> <span class="token keyword">int</span> source<span class="token punctuation">,</span>
      <span class="token keyword">int</span> externalRootVersion<span class="token punctuation">,</span>
      String extraAttribution<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> TreeProps treeProps<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当需要更新的时候，也有对应的Async方法。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">updateStateInternal</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isAsync<span class="token punctuation">,</span> String attribution<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isCreateLayoutInProgress<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Android原生为什么不支持异步布局？虽然网上说的原因有二：</p>
<ul>
<li>1.View的属性是可变的，只要属性发生变化就可能导致布局变化，因此需要重新计算布局，那么提前计算布局的意义就不大了。Litho的属性唯一，因此有了提前计算布局的可能。</li>
<li>2.提前异步布局就意味着要提前创建好接下来要用到的一个或者多个条目的视图，而Android原生的View作为视图单元，不仅包含一个视图的所有属性，而且还负责视图的绘制工作。如果要在绘制前提前去计算布局，就需要预先去持有大量未展示的View实例，大大增加内存占用。而Litho在底层有一个DefaultMountContentPool 挂载池子对组件对象进行循环利用，只有经过挂载之后的View才会显示到屏幕上。</li>
</ul>
<p>第二点我是赞同的，但是第一点我对这个说法抱有意见。我们的确不能忽视异步线程预先测量变化程度大View中的所做无意义的工作。</p>
<p>但是别忘了在整个ui线程中我们不仅仅只有View的绘制工作。更多的还有我们的业务代码，往往一开始小小需求到没什么太大的问题。但是一旦到达了一定的量级对于16ms一帧数的会造成不少负担(理想情况下允许掉帧1-3帧)。一般我们开发为了处理这种情况会从一个线程池中生成一个线程处理繁重的业务，比如io操作。不过有的时候，不一定是io操作也会造成方法耗时超出理想阈值，可能是一片片碎小的业务代码组合造成(因此我们需要对方法插桩监控)。</p>
<p>因此，在线程上下文切换代价不大的情况下，为了尽可能降低绘制的压力，我们完全可以对performMeasure和performLayout进行异步处理。</p>
<p>当然除了有这种优化手段，当然可以从Litho中得到一些灵感，如提前构造View对象等。使用X2C手段从xml转化为code，减少view对象实例化时间;复杂的像素操作可以你用RenderScript进行GPU的优化操作;可以使用View.animate生成ViewPropertyAnimator的硬件渲染动画。</p>
<h3 id="横向比较浏览器的渲染流程后思考"><a href="#横向比较浏览器的渲染流程后思考" class="headerlink" title="横向比较浏览器的渲染流程后思考"></a>横向比较浏览器的渲染流程后思考</h3><p>实际上在我看来RenderThread的硬件渲染绘制流程和浏览器的绘制流程设计十分相似。<br>虽然，我没有专门的阅读过webview的内核代码，但是一些基础原理还是明白的。这里我们简单来比较一下，这里就以Chrome浏览器原理为例子。<br><img src="/images/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png" alt="浏览器工作原理.png"></p>
<p>能看到Android系统如果打开了硬件渲染后，其实整个流程就和浏览器的渲染流程十分接近了。</p>
<p>在浏览器中，网络请求后，获取到的DOM树后，进行style的计算，进行Layout排版生成对应的树。实际上和Android的performMeasure和performLayout两个流程做的事情几乎是一致的，都是对布局的大小和位置进行了测定。</p>
<p>当浏览器根据LayoutTree生成了LayerTree，跨越到合成线程分成更小的图块，再到栅格线程每个图层进行栅格化后，传递回合成线程生成每一帧。</p>
<p>这个步骤实际上和硬件渲染有点相似。但是硬件渲染做的更多。在RenderThread线程中对所有的绘制节点RenderNode(对应上DOM树中的节点)会分配离屏渲染内存生成一个个LayerBuilder保存到FrameBuilder中。也就相当于浏览器中的Layer Tree步骤。</p>
<p>对于硬件渲染来说最小单位的图块就是RenderNode，每一个RenderNode都有自己的缓存。也可以对应上tiles图块的步骤。但是后面的步骤就不相同了。</p>
<p>在ThreadedRenderer的遍历View 树的时候，虽然如ImageView会调用Drawable的绘制方法绘制到DisplayListCanvas中，由于DisplayListCanvas本质上是一个RecordedCanvas，不会立即绘制而是把所有的绘制操作保存起来，等到后续同一合成绘制。这么做就极大的优化了整个硬件渲染的流程，不需要时刻操作OpenGL es和GPU进行交互，通过合成绘制操作，延后统一执行减少GPU的计算次数，就能大大增加了整个系统的绘制性能。</p>
<p>最后，Android系统通过GPU栅格化，合成每一帧EGLSurface直接发送到SF进程中进一步处理。</p>
<p>还有一点启示，那就是为什么无论软硬件，每一个View或者RenderNode都需要自己的缓存呢？从chrome得到的启发是tiles的图块划分是在一个名为合成线程中完成的。</p>
<p>对比上Android系统，实际上也有合成的概念。每一个renderNode有自己的缓存纹理，每一个View有自己的缓存Bitmap。那么就有如下的设计图：</p>
<p><img src="/images/View%E7%9A%84%E5%90%88%E6%88%90%E6%80%9D%E6%83%B3.png" alt="View的合成思想.png"></p>
<p>由于所有的绘制操作都有延后性，只保存了绘制操作对象，因此每一个纹理或者View如果有自己的缓存，可以统一在LayerBuilder中进行合成，最终通过OpenGL es进行栅格化，传送到SF进程。通过这种方式把View/RenderNode一块块组合起来就能快速的组成一个全新的一帧。我称这种行为为横向帧合成。</p>
<p>当然，为什么推荐硬件渲染，另一个原因是它能申请更大的纹理缓存。而不是软件渲染中只有 480 * 800 * 4这么大。</p>
<p>当然也有纵向帧合成，这个就是SF的HWC，HardwareComposer的作用，一个个Client对应的Layer对象进行纵向(z轴)合成。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>写硬件渲染这两篇文章倒是重新写了一遍，发现对象有点多，需要重新理清思路，所以才这么久写完。</p>
<p>到这里View的渲染主要逻辑已经和大家理清楚了，暂时可以收尾了。下一次你再见到我写绘制流程，估计就是关于Skia源码解析了。但是别太得意这仅仅只是熟悉的程度，其实里面还有不少东西可以探究的，比如说动画等。</p>
<p>接下来我们来探索IMS与点击事件的传递原理。</p>
<p>最后关于Litho更多的基础知识可以阅读：<a href="https://tech.meituan.com/2019/03/14/litho-use-and-principle-analysis.html" target="_blank" rel="noopener">https://tech.meituan.com/2019/03/14/litho-use-and-principle-analysis.html</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/07/22/android-chong-xue-xi-lie-ims-yu-shi-jian-fen-fa-shang/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="Android重学系列 IMS与事件分发(上)">
                        
                        <span class="card-title">Android重学系列 IMS与事件分发(上)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言当了解的View是如何渲染之后，我们再聊聊点击事件是如何分发。所有的点击事件实际上都是来源于SystemServer进程中的InputManagerService(之后我将简称为IMS)。
就让我们来看看IMS的初始化。
正文IMS的初
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-07-22
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/IMS/" class="post-category">
                                    IMS
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/06/30/android-chong-xue-xi-lie-view-de-hui-zhi-liu-cheng-liu-ying-jian-xuan-ran-shang/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="Android 重学系列 View的绘制流程(六) 硬件渲染(上)">
                        
                        <span class="card-title">Android 重学系列 View的绘制流程(六) 硬件渲染(上)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言本文开始聊聊Android中的硬件渲染。如果跟着我的文章顺序，从SF进程到App进程的绘制流程一直阅读，我们到这里已经有了一定的基础，可以试着进行横向比对如Chrome浏览器渲染流程，看看软件渲染，硬件渲染，SF合成都做了什么程度的优化
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-06-30
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/View的绘制流程/" class="post-category">
                                    View的绘制流程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
