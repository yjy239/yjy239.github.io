<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android重学系列 OkHttp源码解析(三), Android | Linux | Flutter">
    <meta name="description" content="前言上一篇文章和大家聊了聊Okhttp前三个拦截器，本文来聊聊ConnectInterceptor 链接拦截器都负责什么职责。
本文将不会了聊自定义的网络拦截器以及自定义的用户拦截器。
阅读本文之前，最好对SSL/TLS有一定的了解,具体的">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android重学系列 OkHttp源码解析(三) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/22.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android重学系列 OkHttp源码解析(三)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/网络编程/">
                                <span class="chip bg-color">网络编程</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/网络编程/" class="post-category">
                                网络编程
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-10-24
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        9.2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        43 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇文章和大家聊了聊Okhttp前三个拦截器，本文来聊聊ConnectInterceptor 链接拦截器都负责什么职责。</p>
<p>本文将不会了聊自定义的网络拦截器以及自定义的用户拦截器。</p>
<p>阅读本文之前，最好对SSL/TLS有一定的了解,具体的协议细节可看<a href="https://tools.ietf.org/html/rfc7540" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc7540</a>，快速入门可看<a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html" target="_blank" rel="noopener">阮一峰的SSL/TLS介绍</a>。不过不懂没关系，阅读完okhttp如何处理SSL/TLS的，就能明白整个流程是如何运作的了。</p>
<p>总的一句话就是，SSL/TLS 就是我们常说的Https的加密手段。SSL是专门指代安全套字节(SSL Socket),而后SSL的基础上发展出了TLS。</p>
<blockquote>
<p>TLS 1.0通常被标示为SSL 3.1，TLS 1.1为SSL 3.2，TLS 1.2为SSL 3.3</p>
</blockquote>
<p>可以说是一个东西。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="ConnectInterceptor-链接拦截器-查找可靠链接"><a href="#ConnectInterceptor-链接拦截器-查找可靠链接" class="headerlink" title="ConnectInterceptor 链接拦截器 查找可靠链接"></a>ConnectInterceptor 链接拦截器 查找可靠链接</h2><pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">object</span> ConnectInterceptor <span class="token operator">:</span> Interceptor <span class="token punctuation">{</span>
  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
    <span class="token keyword">val</span> realChain <span class="token operator">=</span> chain <span class="token keyword">as</span> RealInterceptorChain
    <span class="token keyword">val</span> exchange <span class="token operator">=</span> realChain<span class="token punctuation">.</span>call<span class="token punctuation">.</span><span class="token function">initExchange</span><span class="token punctuation">(</span>chain<span class="token punctuation">)</span>
    <span class="token keyword">val</span> connectedChain <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>exchange <span class="token operator">=</span> exchange<span class="token punctuation">)</span>
    <span class="token keyword">return</span> connectedChain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>realChain<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.RealCall.initExchange 初始化可交换链接对象</li>
<li>2.copy拷贝一个全新的RealInterceptorChain对象，并调用这个对象的proceed方法。</li>
</ul>
<p>核心还是RealCall.initExchange</p>
<h3 id="RealCall-initExchange"><a href="#RealCall-initExchange" class="headerlink" title="RealCall.initExchange"></a>RealCall.initExchange</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">initExchange</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> RealInterceptorChain<span class="token punctuation">)</span><span class="token operator">:</span> Exchange <span class="token punctuation">{</span>
    <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">check</span><span class="token punctuation">(</span>expectMoreExchanges<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">"released"</span> <span class="token punctuation">}</span>
      <span class="token function">check</span><span class="token punctuation">(</span><span class="token operator">!</span>responseBodyOpen<span class="token punctuation">)</span>
      <span class="token function">check</span><span class="token punctuation">(</span><span class="token operator">!</span>requestBodyOpen<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">val</span> exchangeFinder <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exchangeFinder<span class="token operator">!!</span>
    <span class="token keyword">val</span> codec <span class="token operator">=</span> exchangeFinder<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>
    <span class="token keyword">val</span> result <span class="token operator">=</span> <span class="token function">Exchange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> eventListener<span class="token punctuation">,</span> exchangeFinder<span class="token punctuation">,</span> codec<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorScopedExchange <span class="token operator">=</span> result
    <span class="token keyword">this</span><span class="token punctuation">.</span>exchange <span class="token operator">=</span> result
    <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>requestBodyOpen <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>responseBodyOpen <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>canceled<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>整个核心是使用exchangeFinder.find 找到ExchangeCodec后生成Exchange对象，并返回该对象。</p>
<h4 id="ExchangeFinder-find"><a href="#ExchangeFinder-find" class="headerlink" title="ExchangeFinder find"></a>ExchangeFinder find</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">find</span><span class="token punctuation">(</span>
    client<span class="token operator">:</span> OkHttpClient<span class="token punctuation">,</span>
    chain<span class="token operator">:</span> RealInterceptorChain
  <span class="token punctuation">)</span><span class="token operator">:</span> ExchangeCodec <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> resultConnection <span class="token operator">=</span> <span class="token function">findHealthyConnection</span><span class="token punctuation">(</span>
          connectTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span>connectTimeoutMillis<span class="token punctuation">,</span>
          readTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span>readTimeoutMillis<span class="token punctuation">,</span>
          writeTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span>writeTimeoutMillis<span class="token punctuation">,</span>
          pingIntervalMillis <span class="token operator">=</span> client<span class="token punctuation">.</span>pingIntervalMillis<span class="token punctuation">,</span>
          connectionRetryEnabled <span class="token operator">=</span> client<span class="token punctuation">.</span>retryOnConnectionFailure<span class="token punctuation">,</span>
          doExtensiveHealthChecks <span class="token operator">=</span> chain<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">!=</span> <span class="token string">"GET"</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">return</span> resultConnection<span class="token punctuation">.</span><span class="token function">newCodec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> RouteException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">trackFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>lastConnectException<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> e
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">trackFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token function">RouteException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.通过findHealthyConnection，获取一个“健康”的链接，也就是保持存活的链接。</p>
</li>
<li><p>2.调用RealConnection 的 newCodec并返回。</p>
</li>
</ul>
<h4 id="findHealthyConnection-查找活跃的链接"><a href="#findHealthyConnection-查找活跃的链接" class="headerlink" title="findHealthyConnection  查找活跃的链接"></a>findHealthyConnection  查找活跃的链接</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">findHealthyConnection</span><span class="token punctuation">(</span>
    connectTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    readTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    writeTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    pingIntervalMillis<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    connectionRetryEnabled<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    doExtensiveHealthChecks<span class="token operator">:</span> Boolean
  <span class="token punctuation">)</span><span class="token operator">:</span> RealConnection <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> candidate <span class="token operator">=</span> <span class="token function">findConnection</span><span class="token punctuation">(</span>
          connectTimeout <span class="token operator">=</span> connectTimeout<span class="token punctuation">,</span>
          readTimeout <span class="token operator">=</span> readTimeout<span class="token punctuation">,</span>
          writeTimeout <span class="token operator">=</span> writeTimeout<span class="token punctuation">,</span>
          pingIntervalMillis <span class="token operator">=</span> pingIntervalMillis<span class="token punctuation">,</span>
          connectionRetryEnabled <span class="token operator">=</span> connectionRetryEnabled
      <span class="token punctuation">)</span>


      <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span>doExtensiveHealthChecks<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> candidate
      <span class="token punctuation">}</span>

      candidate<span class="token punctuation">.</span><span class="token function">noNewExchanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextRouteToTry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>

      <span class="token keyword">val</span> routesLeft <span class="token operator">=</span> routeSelection<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token boolean">true</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>routesLeft<span class="token punctuation">)</span> <span class="token keyword">continue</span>

      <span class="token keyword">val</span> routesSelectionLeft <span class="token operator">=</span> routeSelector<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token boolean">true</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>routesSelectionLeft<span class="token punctuation">)</span> <span class="token keyword">continue</span>

      <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"exhausted all routes"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.findConnection 从Okhttp的链接池中查找对应的RealConnection</li>
<li>2.isHealthy 校验筛选出链接是否活跃</li>
<li>3.如果判断到当前的链接是不活跃的，且可以匹配当前新的请求路径的，那么就通过noNewExchanges方法设置RealConnection的noNewExchanges为true，表示当前的链接可能有问题，被阻止进一步链接了。</li>
<li>4.此时虽然找到了链接，但是是不健康的，那么从RouteSelector 找到新的routesLeft，如果存在可以匹配多个route的情况则进入下一个轮回。</li>
</ul>
<p>其实这些标志位最终都会作用到findConnection 方法中.</p>
<h4 id="findConnection-查找匹配当前资源路径的链接"><a href="#findConnection-查找匹配当前资源路径的链接" class="headerlink" title="findConnection 查找匹配当前资源路径的链接"></a>findConnection 查找匹配当前资源路径的链接</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">findConnection</span><span class="token punctuation">(</span>
    connectTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    readTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    writeTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    pingIntervalMillis<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    connectionRetryEnabled<span class="token operator">:</span> Boolean
  <span class="token punctuation">)</span><span class="token operator">:</span> RealConnection <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>call<span class="token punctuation">.</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> callConnection <span class="token operator">=</span> call<span class="token punctuation">.</span>connection <span class="token comment" spellcheck="true">// This may be mutated by releaseConnectionNoEvents()!</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callConnection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> toClose<span class="token operator">:</span> Socket<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token function">synchronized</span><span class="token punctuation">(</span>callConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callConnection<span class="token punctuation">.</span>noNewExchanges <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">sameHostAndPort</span><span class="token punctuation">(</span>callConnection<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          toClose <span class="token operator">=</span> call<span class="token punctuation">.</span><span class="token function">releaseConnectionNoEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>call<span class="token punctuation">.</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">check</span><span class="token punctuation">(</span>toClose <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> callConnection
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// The call's connection was released.</span>
      toClose<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionReleased</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> callConnection<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// We need a new connection. Give it fresh stats.</span>
    refusedStreamCount <span class="token operator">=</span> <span class="token number">0</span>
    connectionShutdownCount <span class="token operator">=</span> <span class="token number">0</span>
    otherFailureCount <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token comment" spellcheck="true">// Attempt to get a connection from the pool.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">.</span><span class="token function">callAcquirePooledConnection</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> call<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> result <span class="token operator">=</span> call<span class="token punctuation">.</span>connection<span class="token operator">!!</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
      <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Nothing in the pool. Figure out what route we'll try next.</span>
    <span class="token keyword">val</span> routes<span class="token operator">:</span> List<span class="token operator">&lt;</span>Route<span class="token operator">></span><span class="token operator">?</span>
    <span class="token keyword">val</span> route<span class="token operator">:</span> Route
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextRouteToTry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Use a route from a preceding coalesced connection.</span>
      routes <span class="token operator">=</span> <span class="token keyword">null</span>
      route <span class="token operator">=</span> nextRouteToTry<span class="token operator">!!</span>
      nextRouteToTry <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>routeSelection <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> routeSelection<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Use a route from an existing route selection.</span>
      routes <span class="token operator">=</span> <span class="token keyword">null</span>
      route <span class="token operator">=</span> routeSelection<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Compute a new route selection. This is a blocking operation!</span>
      <span class="token keyword">var</span> localRouteSelector <span class="token operator">=</span> routeSelector
      <span class="token keyword">if</span> <span class="token punctuation">(</span>localRouteSelector <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        localRouteSelector <span class="token operator">=</span> <span class="token function">RouteSelector</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> call<span class="token punctuation">.</span>client<span class="token punctuation">.</span>routeDatabase<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>routeSelector <span class="token operator">=</span> localRouteSelector
      <span class="token punctuation">}</span>
      <span class="token keyword">val</span> localRouteSelection <span class="token operator">=</span> localRouteSelector<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      routeSelection <span class="token operator">=</span> localRouteSelection
      routes <span class="token operator">=</span> localRouteSelection<span class="token punctuation">.</span>routes

      <span class="token keyword">if</span> <span class="token punctuation">(</span>call<span class="token punctuation">.</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">.</span><span class="token function">callAcquirePooledConnection</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> call<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> result <span class="token operator">=</span> call<span class="token punctuation">.</span>connection<span class="token operator">!!</span>
        eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
      <span class="token punctuation">}</span>

      route <span class="token operator">=</span> localRouteSelection<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Connect. Tell the call about the connecting call so async cancels work.</span>
    <span class="token keyword">val</span> newConnection <span class="token operator">=</span> <span class="token function">RealConnection</span><span class="token punctuation">(</span>connectionPool<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
    call<span class="token punctuation">.</span>connectionToCancel <span class="token operator">=</span> newConnection
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      newConnection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>
          connectTimeout<span class="token punctuation">,</span>
          readTimeout<span class="token punctuation">,</span>
          writeTimeout<span class="token punctuation">,</span>
          pingIntervalMillis<span class="token punctuation">,</span>
          connectionRetryEnabled<span class="token punctuation">,</span>
          call<span class="token punctuation">,</span>
          eventListener
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      call<span class="token punctuation">.</span>connectionToCancel <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    call<span class="token punctuation">.</span>client<span class="token punctuation">.</span>routeDatabase<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span>newConnection<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">.</span><span class="token function">callAcquirePooledConnection</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> call<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> result <span class="token operator">=</span> call<span class="token punctuation">.</span>connection<span class="token operator">!!</span>
      nextRouteToTry <span class="token operator">=</span> route
      newConnection<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
      <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>

    <span class="token function">synchronized</span><span class="token punctuation">(</span>newConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      connectionPool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newConnection<span class="token punctuation">)</span>
      call<span class="token punctuation">.</span><span class="token function">acquireConnectionNoEvents</span><span class="token punctuation">(</span>newConnection<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> newConnection<span class="token punctuation">)</span>
    <span class="token keyword">return</span> newConnection
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为RealCall可以从之前的缓存队列获取，因此里面可能RealCall本身就存在RealConnection。</p>
<p>因此可以分为3种情况：</p>
<ul>
<li><p>1.RealCall缓存了RealConnection 但是不匹配的情况</p>
</li>
<li><p>2.RealCall缓存了RealConnection 匹配的情况</p>
</li>
<li><p>3.RealCall没有缓存RealConnection</p>
</li>
<li><p>1.此时会校验如果发现RealCall中存在缓存的RealConnection，那么就校验noNewExchanges为true 或者校验 到url中的host和port不一致，则调用releaseConnectionNoEvents 方法，把RealConnection绑定的RealCall队列中对应的RealCall移除，并从ConnectionPool中移除该RealConnection，当前RealCall中绑定的RealConnection设置为空</p>
</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">sameHostAndPort</span><span class="token punctuation">(</span>url<span class="token operator">:</span> HttpUrl<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
    <span class="token keyword">val</span> routeUrl <span class="token operator">=</span> address<span class="token punctuation">.</span>url
    <span class="token keyword">return</span> url<span class="token punctuation">.</span>port <span class="token operator">==</span> routeUrl<span class="token punctuation">.</span>port <span class="token operator">&amp;&amp;</span> url<span class="token punctuation">.</span>host <span class="token operator">==</span> routeUrl<span class="token punctuation">.</span>host
  <span class="token punctuation">}</span>

  <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">releaseConnectionNoEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Socket<span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> connection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token operator">!!</span>
    connection<span class="token punctuation">.</span><span class="token function">assertThreadHoldsLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> calls <span class="token operator">=</span> connection<span class="token punctuation">.</span>calls
    <span class="token keyword">val</span> index <span class="token operator">=</span> calls<span class="token punctuation">.</span><span class="token function">indexOfFirst</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token label symbol">@RealCall</span> <span class="token punctuation">}</span>
    <span class="token function">check</span><span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    calls<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connection <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>calls<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      connection<span class="token punctuation">.</span>idleAtNs <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">.</span><span class="token function">connectionBecameIdle</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>；<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并获取当前缓存RealConnection的socket对象，并关闭该socket。</p>
<p>当然，如果出现了noNewExchanges 为false 且 host和port都匹配则返回，不会关闭RealConnection的socket。</p>
<ul>
<li><p>2.处理RealCall没有缓存RealConnection 或者 RealConnection不匹配情况下，清除缓存重新申请RealCall。</p>
<ul>
<li>2.1. 首先从ConnectionPool的callAcquirePooledConnection方法中获取一个可用的RealConnection，找到匹配且可用的链接则直接返回。</li>
<li>2.2. 如果ConnectionPool找不到匹配的RealConnection ，生成或者获取RouteSelector，从中获取routes对象并callAcquirePooledConnection 试着从路由中获取可复用的RealConnection</li>
</ul>
</li>
<li><p>2.3. 什么都找不到，则会通过RealConnectionPool 生成RealConnection。 </p>
<ul>
<li>2.3.1 调用RealConnection.connect 进行链接RouteDatabase.connected 从失败的路由缓存中移除</li>
<li>2.3.2 生成一个新的RealConnection后，继续从RealConnectionPool查找是否可以和另一个链接合并起来(http 2.0),可以则复用之前的RealConnection</li>
<li>2.3.3 如果不能复用，则吧当前的RealConnection 添加到RealConnectionPool 中，并返回</li>
</ul>
</li>
</ul>
<p>在这个过程中有几个比较核心的方法：</p>
<ul>
<li>1.connectionPool.callAcquirePooledConnection </li>
<li><ol start="2">
<li>RouteSelector 生成</li>
</ol>
</li>
<li><ol start="3">
<li>RealConnection.connect</li>
</ol>
</li>
</ul>
<h5 id="connectionPool-callAcquirePooledConnection"><a href="#connectionPool-callAcquirePooledConnection" class="headerlink" title="connectionPool.callAcquirePooledConnection"></a>connectionPool.callAcquirePooledConnection</h5><p>使用这个方法的时候分为3种情况：</p>
<ul>
<li>1.直接从connectionPool 中查找RealConnection 传入的routes为null和 requireMultiplexed 为false</li>
<li>2.传入的routes为 Route集合和 requireMultiplexed 为false</li>
<li>3.传入的routes为 Route集合和 requireMultiplexed 为true</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">callAcquirePooledConnection</span><span class="token punctuation">(</span>
    address<span class="token operator">:</span> Address<span class="token punctuation">,</span>
    call<span class="token operator">:</span> RealCall<span class="token punctuation">,</span>
    routes<span class="token operator">:</span> List<span class="token operator">&lt;</span>Route<span class="token operator">></span><span class="token operator">?</span><span class="token punctuation">,</span>
    requireMultiplexed<span class="token operator">:</span> Boolean
  <span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>connection <span class="token keyword">in</span> connections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">synchronized</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requireMultiplexed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>connection<span class="token punctuation">.</span>isMultiplexed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token label symbol">@synchronized</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isEligible</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> routes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token label symbol">@synchronized</span>
        call<span class="token punctuation">.</span><span class="token function">acquireConnectionNoEvents</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>如果requireMultiplexed为true且RealConnection的isMultiplexed（可复用，只有在http 2.0协议中，才会打开这个协议）表为false 则进入下一个connections index的循环</li>
</ol>
</li>
<li><ol start="2">
<li>判断到connection的isEligible 校验到当前的RealConnection不合格则进入下一个循环</li>
</ol>
</li>
<li><ol start="3">
<li>通过上述两个判断火都通过就返回true，否则就是false。</li>
</ol>
</li>
</ul>
<h6 id="RealConnection-isEligible-判断是否复用合法"><a href="#RealConnection-isEligible-判断是否复用合法" class="headerlink" title="RealConnection isEligible 判断是否复用合法"></a>RealConnection isEligible 判断是否复用合法</h6><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">private</span> <span class="token keyword">var</span> allocationLimit <span class="token operator">=</span> <span class="token number">1</span>

  <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">isEligible</span><span class="token punctuation">(</span>address<span class="token operator">:</span> Address<span class="token punctuation">,</span> routes<span class="token operator">:</span> List<span class="token operator">&lt;</span>Route<span class="token operator">></span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
    <span class="token function">assertThreadHoldsLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>calls<span class="token punctuation">.</span>size <span class="token operator">>=</span> allocationLimit <span class="token operator">||</span> noNewExchanges<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>route<span class="token punctuation">.</span>address<span class="token punctuation">.</span><span class="token function">equalsNonHost</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>host <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>host<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">// This connection is a perfect match.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>http2Connection <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

    <span class="token comment" spellcheck="true">// 2. The routes must share an IP address.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>routes <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">routeMatchesAny</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

    <span class="token comment" spellcheck="true">// 3. This connection's server certificate's must cover the new host.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>address<span class="token punctuation">.</span>hostnameVerifier <span class="token operator">!==</span> OkHostnameVerifier<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">supportsUrl</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

    <span class="token comment" spellcheck="true">// 4. Certificate pinning must match the host.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      address<span class="token punctuation">.</span>certificatePinner<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>host<span class="token punctuation">,</span> <span class="token function">handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!!</span><span class="token punctuation">.</span>peerCertificates<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>_<span class="token operator">:</span> SSLPeerUnverifiedException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">// The caller's address can be carried by this connection.</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果当前RealConnection复用的RealCall队列的大小大于allocationLimit 限制大小，或者noNewExchanges 为true ；则返回false。allocationLimit 代表了Okhttp在http 2.0协议中允许一个最大能够复用的链接，超出则说明不能继续复用了。noNewExchanges 链接链接后发现是不活跃的。</p>
</li>
<li><p>2.如果RealConnection 中的route和当前传递进来的地址的address不一致，直接返回false即可</p>
</li>
<li><p>3.如果RealConnection 中的route 和传递进来的host一致了，那么说明address和host都一致就是一个资源路径可以返回true。</p>
</li>
<li><ol start="4">
<li>如果host 不一致，且http2Connection 为空，也就不是http 2.0协议，那么就不可能做到不同的资源路径进行复用的情况直接返回</li>
</ol>
</li>
<li><p>5.此时就是必须要符合http 2.0的协议才能进行链接的复用，也就是路由可以共享。如果传进来的routes是空 或者通过routeMatchesAny 查找只要出现socket的地址一致且是直接链接的地址，则返回true，返回false一半就是代理的服务。此时就会直接返回。</p>
</li>
<li><p>6.想要进一步匹配，那么整个网络请求的HostnameVerifier 校验服务器主机名的必须为OkHostnameVerifier</p>
</li>
<li><p>7.其次匹配HttpUrl和RealConnection的route 能否匹配。如果port 端口不匹配则直接返回false，如果host 匹配则直接返回true。否则就必须要保证<code>noCoalescedConnections</code> 为true （<code>noCoalescedConnections</code> 这个标志位为true，则说明该链接可以共享链接，但是不共享主机.），handshake不为空（说明已经经过了三次握手），且本次校验可以通过主机服务器名的校验。</p>
</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">supportsUrl</span><span class="token punctuation">(</span>url<span class="token operator">:</span> HttpUrl<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
    <span class="token function">assertThreadHoldsLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> routeUrl <span class="token operator">=</span> route<span class="token punctuation">.</span>address<span class="token punctuation">.</span>url

    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>port <span class="token operator">!=</span> routeUrl<span class="token punctuation">.</span>port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">// Port mismatch.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>host <span class="token operator">==</span> routeUrl<span class="token punctuation">.</span>host<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">// Host match. The URL is supported.</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// We have a host mismatch. But if the certificate matches, we're still good.</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>noCoalescedConnections <span class="token operator">&amp;&amp;</span> handshake <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">certificateSupportHost</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> handshake<span class="token operator">!!</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">certificateSupportHost</span><span class="token punctuation">(</span>url<span class="token operator">:</span> HttpUrl<span class="token punctuation">,</span> handshake<span class="token operator">:</span> Handshake<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
    <span class="token keyword">val</span> peerCertificates <span class="token operator">=</span> handshake<span class="token punctuation">.</span>peerCertificates

    <span class="token keyword">return</span> peerCertificates<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> OkHostnameVerifier<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>host<span class="token punctuation">,</span>
        peerCertificates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> X509Certificate<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol start="8">
<li>address.certificatePinner!!.check 则是校验每一个Certificate 是否都是X509Certificate类型,且加密的方式是否是<code>sha256</code> 或者 <code>sha1</code><pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">check</span><span class="token punctuation">(</span>hostname<span class="token operator">:</span> String<span class="token punctuation">,</span> peerCertificates<span class="token operator">:</span> List<span class="token operator">&lt;</span>Certificate<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token function">check</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">(</span>certificateChainCleaner<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span>peerCertificates<span class="token punctuation">,</span> hostname<span class="token punctuation">)</span> <span class="token operator">?:</span> peerCertificates<span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> it <span class="token keyword">as</span> X509Certificate <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
</li>
</ul>
<h5 id="RouteSelector-生成"><a href="#RouteSelector-生成" class="headerlink" title="RouteSelector 生成"></a>RouteSelector 生成</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">      <span class="token keyword">var</span> localRouteSelector <span class="token operator">=</span> routeSelector
      <span class="token keyword">if</span> <span class="token punctuation">(</span>localRouteSelector <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        localRouteSelector <span class="token operator">=</span> <span class="token function">RouteSelector</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> call<span class="token punctuation">.</span>client<span class="token punctuation">.</span>routeDatabase<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>routeSelector <span class="token operator">=</span> localRouteSelector
      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还记得routeDatabase 是用于记录黑名单的路由。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">on
<span class="token keyword">class</span> <span class="token function">RouteSelector</span><span class="token punctuation">(</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> address<span class="token operator">:</span> Address<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> routeDatabase<span class="token operator">:</span> RouteDatabase<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> call<span class="token operator">:</span> Call<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> eventListener<span class="token operator">:</span> EventListener
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">init</span> <span class="token punctuation">{</span>
    <span class="token function">resetNextProxy</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span>url<span class="token punctuation">,</span> address<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="resetNextProxy-初始化代理代理队列"><a href="#resetNextProxy-初始化代理代理队列" class="headerlink" title="resetNextProxy 初始化代理代理队列"></a>resetNextProxy 初始化代理代理队列</h6><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">resetNextProxy</span><span class="token punctuation">(</span>url<span class="token operator">:</span> HttpUrl<span class="token punctuation">,</span> proxy<span class="token operator">:</span> Proxy<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">selectProxies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>Proxy<span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>proxy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">listOf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>

      <span class="token keyword">val</span> uri <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">toUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>uri<span class="token punctuation">.</span>host <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">immutableListOf</span><span class="token punctuation">(</span>Proxy<span class="token punctuation">.</span>NO_PROXY<span class="token punctuation">)</span>

      <span class="token keyword">val</span> proxiesOrNull <span class="token operator">=</span> address<span class="token punctuation">.</span>proxySelector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>proxiesOrNull<span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">immutableListOf</span><span class="token punctuation">(</span>Proxy<span class="token punctuation">.</span>NO_PROXY<span class="token punctuation">)</span>

      <span class="token keyword">return</span> proxiesOrNull<span class="token punctuation">.</span><span class="token function">toImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    eventListener<span class="token punctuation">.</span><span class="token function">proxySelectStart</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    proxies <span class="token operator">=</span> <span class="token function">selectProxies</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    nextProxyIndex <span class="token operator">=</span> <span class="token number">0</span>
    eventListener<span class="token punctuation">.</span><span class="token function">proxySelectEnd</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> url<span class="token punctuation">,</span> proxies<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果Address的Proxy不为空，则缓存到队列返回</p>
</li>
<li><p>2.如果host为为空，则直接返回一个<code>Proxy.NO_PROXY</code>无代理到缓存队列中</p>
</li>
<li><p>3.调用Address的ProxySelector的select获取代理队列。<br>一个例子,下面是默认的ProxySelector：</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">object</span> NullProxySelector <span class="token operator">:</span> <span class="token function">ProxySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">select</span><span class="token punctuation">(</span>uri<span class="token operator">:</span> URI<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>Proxy<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token function">requireNotNull</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">"uri must not be null"</span> <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">listOf</span><span class="token punctuation">(</span>Proxy<span class="token punctuation">.</span>NO_PROXY<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">connectFailed</span><span class="token punctuation">(</span>uri<span class="token operator">:</span> URI<span class="token operator">?</span><span class="token punctuation">,</span> sa<span class="token operator">:</span> SocketAddress<span class="token operator">?</span><span class="token punctuation">,</span> ioe<span class="token operator">:</span> IOException<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>能看到实际上如果没有设定，ProxySelector默认就是Proxy.NO_PROXY（无代理状态）。而如果有需要进行代理可以在OkhttpClientBuilder的addProxy中为不同的uri设置自己的代理规则。</p>
<p>直接来看看这个对象的next 迭代方法是什么：</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin"> <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  operator <span class="token keyword">fun</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Selection <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// Compute the next set of routes to attempt.</span>
    <span class="token keyword">val</span> routes <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>Route<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">hasNextProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token keyword">val</span> proxy <span class="token operator">=</span> <span class="token function">nextProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>inetSocketAddress <span class="token keyword">in</span> inetSocketAddresses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> route <span class="token operator">=</span> <span class="token function">Route</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> proxy<span class="token punctuation">,</span> inetSocketAddress<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>routeDatabase<span class="token punctuation">.</span><span class="token function">shouldPostpone</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          postponedRoutes <span class="token operator">+=</span> route
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          routes <span class="token operator">+=</span> route
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>routes<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>routes<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      routes <span class="token operator">+=</span> postponedRoutes
      postponedRoutes<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">Selection</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">nextProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Proxy <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasNextProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">SocketException</span><span class="token punctuation">(</span>
          <span class="token string">"No route to <span class="token interpolation"><span class="token delimiter variable">${</span>address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>host<span class="token delimiter variable">}</span></span>; exhausted proxy configurations: <span class="token interpolation variable">$proxies</span>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">val</span> result <span class="token operator">=</span> proxies<span class="token punctuation">[</span>nextProxyIndex<span class="token operator">++</span><span class="token punctuation">]</span>
    <span class="token function">resetNextInetSocketAddress</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>nextProxy 不断的迭代遍历初始化时候获取的所有的proxies 代理对象(从Address的ProxySelector)调用resetNextInetSocketAddress</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">
  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">resetNextInetSocketAddress</span><span class="token punctuation">(</span>proxy<span class="token operator">:</span> Proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Clear the addresses. Necessary if getAllByName() below throws!</span>
    <span class="token keyword">val</span> mutableInetSocketAddresses <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>InetSocketAddress<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    inetSocketAddresses <span class="token operator">=</span> mutableInetSocketAddresses

    <span class="token keyword">val</span> socketHost<span class="token operator">:</span> String
    <span class="token keyword">val</span> socketPort<span class="token operator">:</span> Int
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>DIRECT <span class="token operator">||</span> proxy<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>SOCKS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      socketHost <span class="token operator">=</span> address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>host
      socketPort <span class="token operator">=</span> address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>port
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> proxyAddress <span class="token operator">=</span> proxy<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">require</span><span class="token punctuation">(</span>proxyAddress <span class="token keyword">is</span> InetSocketAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string">"Proxy.address() is not an InetSocketAddress: <span class="token interpolation"><span class="token delimiter variable">${</span>proxyAddress<span class="token punctuation">.</span>javaClass<span class="token delimiter variable">}</span></span>"</span>
      <span class="token punctuation">}</span>
      socketHost <span class="token operator">=</span> proxyAddress<span class="token punctuation">.</span>socketHost
      socketPort <span class="token operator">=</span> proxyAddress<span class="token punctuation">.</span>port
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>socketPort <span class="token operator">!</span><span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">65535</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">SocketException</span><span class="token punctuation">(</span><span class="token string">"No route to <span class="token interpolation variable">$socketHost</span>:<span class="token interpolation variable">$socketPort</span>; port is out of range"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>SOCKS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mutableInetSocketAddresses <span class="token operator">+=</span> InetSocketAddress<span class="token punctuation">.</span><span class="token function">createUnresolved</span><span class="token punctuation">(</span>socketHost<span class="token punctuation">,</span> socketPort<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">dnsStart</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> socketHost<span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">// Try each address for best behavior in mixed IPv4/IPv6 environments.</span>
      <span class="token keyword">val</span> addresses <span class="token operator">=</span> address<span class="token punctuation">.</span>dns<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>socketHost<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>addresses<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">UnknownHostException</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation"><span class="token delimiter variable">${</span>address<span class="token punctuation">.</span>dns<span class="token delimiter variable">}</span></span> returned no addresses for <span class="token interpolation variable">$socketHost</span>"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      eventListener<span class="token punctuation">.</span><span class="token function">dnsEnd</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> socketHost<span class="token punctuation">,</span> addresses<span class="token punctuation">)</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span>inetAddress <span class="token keyword">in</span> addresses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mutableInetSocketAddresses <span class="token operator">+=</span> <span class="token function">InetSocketAddress</span><span class="token punctuation">(</span>inetAddress<span class="token punctuation">,</span> socketPort<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.1.如果代理类型是 <code>Proxy.Type.SOCKS</code> socket代理，那么先获得Address的host以及port，并调用<code>InetSocketAddress.createUnresolved</code> 解析套字节地址并保存到mutableInetSocketAddresses集合中</p>
</li>
<li><p>1.2.如果代理类型是<code>Proxy.Type.DIRECT</code> 则先获取Address的host和port，并调用Address的DNS方法调用lookup 查询 host，并生成InetSocketAddress保存到mutableInetSocketAddresses集合中。</p>
</li>
<li><p>1.3. 如果代理类型是其他，如<code>Proxy.Type.HTTP</code>，则获取传递进来的Proxy中的host和port，在DNS的lookup 查询转化的地址，并生成一个InetSocketAddress保存到mutableInetSocketAddresses。</p>
</li>
</ul>
<p>注意默认的DNS是DnsSystem对象</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token annotation builtin">@JvmField</span>
    <span class="token keyword">val</span> SYSTEM<span class="token operator">:</span> Dns <span class="token operator">=</span> <span class="token function">DnsSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> DnsSystem <span class="token operator">:</span> Dns <span class="token punctuation">{</span>
      <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">lookup</span><span class="token punctuation">(</span>hostname<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>InetAddress<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> InetAddress<span class="token punctuation">.</span><span class="token function">getAllByName</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> NullPointerException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token function">UnknownHostException</span><span class="token punctuation">(</span><span class="token string">"Broken system behaviour for dns lookup of <span class="token interpolation variable">$hostname</span>"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span>
            <span class="token function">initCause</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程实际上是InetAddress.getAllByName 会查询DNS服务器解析主机地址返回InetAddress。InetAddress实际上就是在java中代表IP地址的对象。</p>
<p>这样就能拿到该地址对应所有的服务器主机的ip地址。</p>
<ul>
<li><ol start="2">
<li>当所有的代理和非代理，解析出来的主机ip都保存到inetSocketAddresses集合后，就会遍历这个集合生成一个个对应的Route对象，这个对象会缓存ip地址对象以及代理对象，并保存到Selection的routes中，返回。</li>
</ol>
</li>
</ul>
<h4 id="RealConnection-connect"><a href="#RealConnection-connect" class="headerlink" title="RealConnection.connect"></a>RealConnection.connect</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">connect</span><span class="token punctuation">(</span>
    connectTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    readTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    writeTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    pingIntervalMillis<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    connectionRetryEnabled<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    call<span class="token operator">:</span> Call<span class="token punctuation">,</span>
    eventListener<span class="token operator">:</span> EventListener
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">check</span><span class="token punctuation">(</span>protocol <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">"already connected"</span> <span class="token punctuation">}</span>

    <span class="token keyword">var</span> routeException<span class="token operator">:</span> RouteException<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">val</span> connectionSpecs <span class="token operator">=</span> route<span class="token punctuation">.</span>address<span class="token punctuation">.</span>connectionSpecs
    <span class="token keyword">val</span> connectionSpecSelector <span class="token operator">=</span> <span class="token function">ConnectionSpecSelector</span><span class="token punctuation">(</span>connectionSpecs<span class="token punctuation">)</span>

<span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">requiresTunnel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">connectTunnel</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span> writeTimeout<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>rawSocket <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">connectSocket</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">establishProtocol</span><span class="token punctuation">(</span>connectionSpecSelector<span class="token punctuation">,</span> pingIntervalMillis<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span>
        eventListener<span class="token punctuation">.</span><span class="token function">connectEnd</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> route<span class="token punctuation">.</span>socketAddress<span class="token punctuation">,</span> route<span class="token punctuation">.</span>proxy<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        socket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        rawSocket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        socket <span class="token operator">=</span> <span class="token keyword">null</span>
        rawSocket <span class="token operator">=</span> <span class="token keyword">null</span>
        source <span class="token operator">=</span> <span class="token keyword">null</span>
        sink <span class="token operator">=</span> <span class="token keyword">null</span>
        handshake <span class="token operator">=</span> <span class="token keyword">null</span>
        protocol <span class="token operator">=</span> <span class="token keyword">null</span>
        http2Connection <span class="token operator">=</span> <span class="token keyword">null</span>
        allocationLimit <span class="token operator">=</span> <span class="token number">1</span>

        eventListener<span class="token punctuation">.</span><span class="token function">connectFailed</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> route<span class="token punctuation">.</span>socketAddress<span class="token punctuation">,</span> route<span class="token punctuation">.</span>proxy<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>routeException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          routeException <span class="token operator">=</span> <span class="token function">RouteException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          routeException<span class="token punctuation">.</span><span class="token function">addConnectException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connectionRetryEnabled <span class="token operator">||</span> <span class="token operator">!</span>connectionSpecSelector<span class="token punctuation">.</span><span class="token function">connectionFailed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> routeException
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">requiresTunnel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rawSocket <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">RouteException</span><span class="token punctuation">(</span><span class="token function">ProtocolException</span><span class="token punctuation">(</span>
          <span class="token string">"Too many tunnel connections attempted: <span class="token interpolation variable">$MAX_TUNNEL_ATTEMPTS</span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    idleAtNs <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里可以分为2种情况：</p>
<ul>
<li>1.requiresTunnel 判断当前的代理是http代理，那么就会调用<code>connectTunnel</code>方法链接socket</li>
<li><ol start="2">
<li>如果是其他代理方式，那么就是调用connectSocket 方式链接socket</li>
</ol>
</li>
</ul>
<p>当上面2个步骤都完成之后，就会统一调用establishProtocol 进行协议的处理。</p>
<p>先来看看connectSocket 都做了什么。</p>
<h5 id="connectSocket"><a href="#connectSocket" class="headerlink" title="connectSocket"></a>connectSocket</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">connectSocket</span><span class="token punctuation">(</span>
    connectTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    readTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    call<span class="token operator">:</span> Call<span class="token punctuation">,</span>
    eventListener<span class="token operator">:</span> EventListener
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> proxy <span class="token operator">=</span> route<span class="token punctuation">.</span>proxy
    <span class="token keyword">val</span> address <span class="token operator">=</span> route<span class="token punctuation">.</span>address

    <span class="token keyword">val</span> rawSocket <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>DIRECT<span class="token punctuation">,</span> Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>HTTP <span class="token operator">-></span> address<span class="token punctuation">.</span>socketFactory<span class="token punctuation">.</span><span class="token function">createSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!!</span>
      <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token function">Socket</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rawSocket <span class="token operator">=</span> rawSocket

    eventListener<span class="token punctuation">.</span><span class="token function">connectStart</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> route<span class="token punctuation">.</span>socketAddress<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span>
    rawSocket<span class="token punctuation">.</span>soTimeout <span class="token operator">=</span> readTimeout
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connectSocket</span><span class="token punctuation">(</span>rawSocket<span class="token punctuation">,</span> route<span class="token punctuation">.</span>socketAddress<span class="token punctuation">,</span> connectTimeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> ConnectException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">ConnectException</span><span class="token punctuation">(</span><span class="token string">"Failed to connect to <span class="token interpolation"><span class="token delimiter variable">${</span>route<span class="token punctuation">.</span>socketAddress<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span>
        <span class="token function">initCause</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// The following try/catch block is a pseudo hacky way to get around a crash on Android 7.0</span>
    <span class="token comment" spellcheck="true">// More details:</span>
    <span class="token comment" spellcheck="true">// https://github.com/square/okhttp/issues/3245</span>
    <span class="token comment" spellcheck="true">// https://android-review.googlesource.com/#/c/271775/</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      source <span class="token operator">=</span> rawSocket<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      sink <span class="token operator">=</span> rawSocket<span class="token punctuation">.</span><span class="token function">sink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>npe<span class="token operator">:</span> NullPointerException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>npe<span class="token punctuation">.</span>message <span class="token operator">==</span> NPE_THROW_WITH_NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span>npe<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.如果是直连或者是Http代理，则通过默认的SocketFactory创建socket对象。默认是DefaultSocketFactory 对象，但是通过SocketFactory 就进行了结偶，允许我们自己定义Socket<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> Socket <span class="token function">createSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>2.如果是Socket代理，直接生成一个Socket对象</li>
<li>3.回调connectStart 监听</li>
<li>4.调用Socket的connect 链接上InetSocketAddress 对应的ip地址<pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">connectSocket</span><span class="token punctuation">(</span>socket<span class="token operator">:</span> Socket<span class="token punctuation">,</span> address<span class="token operator">:</span> InetSocketAddress<span class="token punctuation">,</span> connectTimeout<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> connectTimeout<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>5.通过Okio分别获取source  写入流和sink 输出流缓存在RealConnection中。</li>
</ul>
<h5 id="connectTunnel"><a href="#connectTunnel" class="headerlink" title="connectTunnel"></a>connectTunnel</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> MAX_TUNNEL_ATTEMPTS <span class="token operator">=</span> <span class="token number">21</span>

  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">connectTunnel</span><span class="token punctuation">(</span>
    connectTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    readTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    writeTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    call<span class="token operator">:</span> Call<span class="token punctuation">,</span>
    eventListener<span class="token operator">:</span> EventListener
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> tunnelRequest<span class="token operator">:</span> Request <span class="token operator">=</span> <span class="token function">createTunnelRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> url <span class="token operator">=</span> tunnelRequest<span class="token punctuation">.</span>url
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until MAX_TUNNEL_ATTEMPTS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">connectSocket</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span>
      tunnelRequest <span class="token operator">=</span> <span class="token function">createTunnel</span><span class="token punctuation">(</span>readTimeout<span class="token punctuation">,</span> writeTimeout<span class="token punctuation">,</span> tunnelRequest<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
          <span class="token operator">?:</span> <span class="token keyword">break</span> <span class="token comment" spellcheck="true">// Tunnel successfully created.</span>

      rawSocket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      rawSocket <span class="token operator">=</span> <span class="token keyword">null</span>
      sink <span class="token operator">=</span> <span class="token keyword">null</span>
      source <span class="token operator">=</span> <span class="token keyword">null</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectEnd</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> route<span class="token punctuation">.</span>socketAddress<span class="token punctuation">,</span> route<span class="token punctuation">.</span>proxy<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.createTunnelRequest 创建一个通道确认的请求</li>
<li>2.首先调用connectSocket 尝试着链接服务器地址</li>
<li>3.createTunnel 回去http协议下的返回的结果数据生成新的Request。如果返回Request 不是空空则重新尝试，直到21次为止。</li>
</ul>
<h5 id="createTunnelRequest-创建一个通道确认的请求"><a href="#createTunnelRequest-创建一个通道确认的请求" class="headerlink" title="createTunnelRequest 创建一个通道确认的请求"></a>createTunnelRequest 创建一个通道确认的请求</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">createTunnelRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Request <span class="token punctuation">{</span>
    <span class="token keyword">val</span> proxyConnectRequest <span class="token operator">=</span> Request<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>address<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token string">"CONNECT"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Host"</span><span class="token punctuation">,</span> route<span class="token punctuation">.</span>address<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">toHostHeader</span><span class="token punctuation">(</span>includeDefaultPort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Proxy-Connection"</span><span class="token punctuation">,</span> <span class="token string">"Keep-Alive"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// For HTTP/1.0 proxies like Squid.</span>
        <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"User-Agent"</span><span class="token punctuation">,</span> userAgent<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> fakeAuthChallengeResponse <span class="token operator">=</span> Response<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>proxyConnectRequest<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span>Protocol<span class="token punctuation">.</span>HTTP_1_1<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span>HTTP_PROXY_AUTH<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">"Preemptive Authenticate"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>EMPTY_RESPONSE<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Proxy-Authenticate"</span><span class="token punctuation">,</span> <span class="token string">"OkHttp-Preemptive"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> authenticatedRequest <span class="token operator">=</span> route<span class="token punctuation">.</span>address<span class="token punctuation">.</span>proxyAuthenticator
        <span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> fakeAuthChallengeResponse<span class="token punctuation">)</span>

    <span class="token keyword">return</span> authenticatedRequest <span class="token operator">?:</span> proxyConnectRequest
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程构建了构建了一个代理用的proxyConnectRequest 链接请求对象，以及一个虚假的响应，这个响应会包含proxyConnectRequest。然后通过设置的proxyAuthenticator 进行权限校验。</p>
<p>可以阅读源码JavaNetAuthenticator 中的实现：</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>route<span class="token operator">:</span> Route<span class="token operator">?</span><span class="token punctuation">,</span> response<span class="token operator">:</span> Response<span class="token punctuation">)</span><span class="token operator">:</span> Request<span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> challenges <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">challenges</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> request <span class="token operator">=</span> response<span class="token punctuation">.</span>request
    <span class="token keyword">val</span> url <span class="token operator">=</span> request<span class="token punctuation">.</span>url
    <span class="token keyword">val</span> proxyAuthorization <span class="token operator">=</span> response<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">407</span>
    <span class="token keyword">val</span> proxy <span class="token operator">=</span> route<span class="token operator">?</span><span class="token punctuation">.</span>proxy <span class="token operator">?:</span> Proxy<span class="token punctuation">.</span>NO_PROXY

    <span class="token keyword">for</span> <span class="token punctuation">(</span>challenge <span class="token keyword">in</span> challenges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"Basic"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>scheme<span class="token punctuation">,</span> ignoreCase <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">val</span> dns <span class="token operator">=</span> route<span class="token operator">?</span><span class="token punctuation">.</span>address<span class="token operator">?</span><span class="token punctuation">.</span>dns <span class="token operator">?:</span> defaultDns
      <span class="token keyword">val</span> auth <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyAuthorization<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> proxyAddress <span class="token operator">=</span> proxy<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> InetSocketAddress
        Authenticator<span class="token punctuation">.</span><span class="token function">requestPasswordAuthentication</span><span class="token punctuation">(</span>
            proxyAddress<span class="token punctuation">.</span>hostName<span class="token punctuation">,</span>
            proxy<span class="token punctuation">.</span><span class="token function">connectToInetAddress</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> dns<span class="token punctuation">)</span><span class="token punctuation">,</span>
            proxyAddress<span class="token punctuation">.</span>port<span class="token punctuation">,</span>
            url<span class="token punctuation">.</span>scheme<span class="token punctuation">,</span>
            challenge<span class="token punctuation">.</span>realm<span class="token punctuation">,</span>
            challenge<span class="token punctuation">.</span>scheme<span class="token punctuation">,</span>
            url<span class="token punctuation">.</span><span class="token function">toUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Authenticator<span class="token punctuation">.</span>RequestorType<span class="token punctuation">.</span>PROXY
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        Authenticator<span class="token punctuation">.</span><span class="token function">requestPasswordAuthentication</span><span class="token punctuation">(</span>
            url<span class="token punctuation">.</span>host<span class="token punctuation">,</span>
            proxy<span class="token punctuation">.</span><span class="token function">connectToInetAddress</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> dns<span class="token punctuation">)</span><span class="token punctuation">,</span>
            url<span class="token punctuation">.</span>port<span class="token punctuation">,</span>
            url<span class="token punctuation">.</span>scheme<span class="token punctuation">,</span>
            challenge<span class="token punctuation">.</span>realm<span class="token punctuation">,</span>
            challenge<span class="token punctuation">.</span>scheme<span class="token punctuation">,</span>
            url<span class="token punctuation">.</span><span class="token function">toUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Authenticator<span class="token punctuation">.</span>RequestorType<span class="token punctuation">.</span>SERVER
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>auth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> credentialHeader <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyAuthorization<span class="token punctuation">)</span> <span class="token string">"Proxy-Authorization"</span> <span class="token keyword">else</span> <span class="token string">"Authorization"</span>
        <span class="token keyword">val</span> credential <span class="token operator">=</span> Credentials<span class="token punctuation">.</span><span class="token function">basic</span><span class="token punctuation">(</span>
            auth<span class="token punctuation">.</span>userName<span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>auth<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span> challenge<span class="token punctuation">.</span>charset<span class="token punctuation">)</span>
        <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span>credentialHeader<span class="token punctuation">,</span> credential<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span> <span class="token comment" spellcheck="true">// No challenges were satisfied!</span>
  <span class="token punctuation">}</span>

  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> Proxy<span class="token punctuation">.</span><span class="token function">connectToInetAddress</span><span class="token punctuation">(</span>url<span class="token operator">:</span> HttpUrl<span class="token punctuation">,</span> dns<span class="token operator">:</span> Dns<span class="token punctuation">)</span><span class="token operator">:</span> InetAddress <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>DIRECT <span class="token operator">-></span> dns<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>host<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> InetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">.</span>address
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>校验方式实际上就是获取Response中的Header的challenges</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">challenges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>Challenge<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> headers<span class="token punctuation">.</span><span class="token function">parseChallenges</span><span class="token punctuation">(</span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          HTTP_UNAUTHORIZED <span class="token operator">-></span> <span class="token string">"WWW-Authenticate"</span>
          HTTP_PROXY_AUTH <span class="token operator">-></span> <span class="token string">"Proxy-Authenticate"</span>
          <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token keyword">return</span> <span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也就是拿到当前的状态码:</p>
<ul>
<li>1.如果是401 则设置为<code>WWW-Authenticate</code></li>
<li>2.如果是407 ，则设置<code>Proxy-Authenticate</code></li>
</ul>
<p>然后以这两个字符串为key 寻找设置Header的数值到Challenge对象中。</p>
<p>在这个过程构建了一个虚假的应答，答应的状态码为407.所以会生成一个对应的Challenge对象。然而此时在头部中设置了<code>OkHttp-Preemptive</code> 对应的value，那么在调用<code>Authenticator.requestPasswordAuthentication</code>方法就会把如<code>WWW-Authenticate: Basic realm="请求域"</code> 取出<code>realm</code>中的请求域，提交给Authenticator(通过<code>Authenticator.setDefault</code> 在本地设置的)认证。</p>
<p>注意在这个过程中还是会调用一次DNS的lookup方法，把url解析成对应主机的ip地址。</p>
<p>并返回校验权限的authenticatedRequest Request请求对象，注意观察这个对象，如果在本地的验证器认证通过后，会在新的请求头部中设置好<code>Basic:账号:密码</code>。</p>
<h5 id="createTunnel-根据socket链接返回的结构构建新的Request"><a href="#createTunnel-根据socket链接返回的结构构建新的Request" class="headerlink" title="createTunnel 根据socket链接返回的结构构建新的Request"></a>createTunnel 根据socket链接返回的结构构建新的Request</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">createTunnel</span><span class="token punctuation">(</span>
    readTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    writeTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    tunnelRequest<span class="token operator">:</span> Request<span class="token punctuation">,</span>
    url<span class="token operator">:</span> HttpUrl
  <span class="token punctuation">)</span><span class="token operator">:</span> Request<span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> nextRequest <span class="token operator">=</span> tunnelRequest
    <span class="token comment" spellcheck="true">// Make an SSL Tunnel on the first message pair of each SSL + proxy connection.</span>
    <span class="token keyword">val</span> requestLine <span class="token operator">=</span> <span class="token string">"CONNECT <span class="token interpolation"><span class="token delimiter variable">${</span>url<span class="token punctuation">.</span><span class="token function">toHostHeader</span><span class="token punctuation">(</span>includeDefaultPort <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span> HTTP/1.1"</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token operator">!!</span>
      <span class="token keyword">val</span> sink <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sink<span class="token operator">!!</span>
      <span class="token keyword">val</span> tunnelCodec <span class="token operator">=</span> <span class="token function">Http1ExchangeCodec</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>
      source<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>readTimeout<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">)</span>
      sink<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>writeTimeout<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">)</span>
      tunnelCodec<span class="token punctuation">.</span><span class="token function">writeRequest</span><span class="token punctuation">(</span>nextRequest<span class="token punctuation">.</span>headers<span class="token punctuation">,</span> requestLine<span class="token punctuation">)</span>
      tunnelCodec<span class="token punctuation">.</span><span class="token function">finishRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> response <span class="token operator">=</span> tunnelCodec<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">!!</span>
          <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>nextRequest<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      tunnelCodec<span class="token punctuation">.</span><span class="token function">skipConnectBody</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>

      <span class="token keyword">when</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        HTTP_OK <span class="token operator">-></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>source<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">exhausted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>sink<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">exhausted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"TLS tunnel buffered too many bytes!"</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>

        HTTP_PROXY_AUTH <span class="token operator">-></span> <span class="token punctuation">{</span>
          nextRequest <span class="token operator">=</span> route<span class="token punctuation">.</span>address<span class="token punctuation">.</span>proxyAuthenticator<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
              <span class="token operator">?:</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"Failed to authenticate with proxy"</span><span class="token punctuation">)</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Connection"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ignoreCase <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> nextRequest
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"Unexpected response code for CONNECT: <span class="token interpolation"><span class="token delimiter variable">${</span>response<span class="token punctuation">.</span>code<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心是构建了一个Http1ExchangeCodec对象，把之前通过Socket.connect获取到的输入输出流保存在其中，接着依次执行如下步骤：</p>
<ul>
<li>1.设置输入输出流的超时时间</li>
<li>2.往Http1ExchangeCodec 中先往socket写入缓冲区写入 <code>"CONNECT ${host:port} HTTP/1.1"</code> (也就是把host和port写入到头部),接着往socket 的写入缓冲区写入 之前带上 校验的账号密码的头部。</li>
<li>3.调用Http1ExchangeCodec的finishRequest，把缓冲区的数据推到socket链接的服务器。</li>
<li>4.Http1ExchangeCodec 将会读取socket返回的头部信息以及响应状态码，如果为<code>200</code>则说明且有数据，则返回空。如果为<code>407</code> 则为权限校验出问题了，这一次再通过服务器那边返回的响应体，在本地中获取账号密码后再重新请求依次，直到<code>200</code>成功为止。</li>
</ul>
<h5 id="establishProtocol-处理协议链接"><a href="#establishProtocol-处理协议链接" class="headerlink" title="establishProtocol 处理协议链接"></a>establishProtocol 处理协议链接</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">establishProtocol</span><span class="token punctuation">(</span>
    connectionSpecSelector<span class="token operator">:</span> ConnectionSpecSelector<span class="token punctuation">,</span>
    pingIntervalMillis<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    call<span class="token operator">:</span> Call<span class="token punctuation">,</span>
    eventListener<span class="token operator">:</span> EventListener
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>address<span class="token punctuation">.</span>sslSocketFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Protocol<span class="token punctuation">.</span>H2_PRIOR_KNOWLEDGE <span class="token keyword">in</span> route<span class="token punctuation">.</span>address<span class="token punctuation">.</span>protocols<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        socket <span class="token operator">=</span> rawSocket
        protocol <span class="token operator">=</span> Protocol<span class="token punctuation">.</span>H2_PRIOR_KNOWLEDGE
        <span class="token function">startHttp2</span><span class="token punctuation">(</span>pingIntervalMillis<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>

      socket <span class="token operator">=</span> rawSocket
      protocol <span class="token operator">=</span> Protocol<span class="token punctuation">.</span>HTTP_1_1
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    eventListener<span class="token punctuation">.</span><span class="token function">secureConnectStart</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span>
    <span class="token function">connectTls</span><span class="token punctuation">(</span>connectionSpecSelector<span class="token punctuation">)</span>
    eventListener<span class="token punctuation">.</span><span class="token function">secureConnectEnd</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> handshake<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol <span class="token operator">===</span> Protocol<span class="token punctuation">.</span>HTTP_2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">startHttp2</span><span class="token punctuation">(</span>pingIntervalMillis<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>整个过程分为3个情况：</p>
<ul>
<li><p>1.如果没有设置sslSocketFactory (也就是安全套接字协议层的socket生成池)为空，说明可以进行明文传输。</p>
<ul>
<li><p>1.1.如果在Route.Address中的协议包含了<code>H2_PRIOR_KNOWLEDGE</code>也就是<code>h2_prior_knowledge</code> 调用startHttp2 启动Http 2.0协议</p>
</li>
<li><p>1.2.如果不包含<code>H2_PRIOR_KNOWLEDGE</code> 又不存在sslSocketFactory。那么协议就会退化到http 1.1中</p>
</li>
</ul>
</li>
<li><p>2.如果sslSocketFactory 存在，那么就会调用connectTls 进行链接，如果发现是http2.0协议，就调用startHttp2。</p>
</li>
</ul>
<p><code>h2_prior_knowledge</code> 这个协议，在RFC 第 3.4节中有介绍，实际上就是指可以对服务器发送一个序言(preface)，用于识别当前服务器是否支持http2.0的协议。如果支持可以直接进行发送数据帧，当然这个协议只建立在http2.0明文传输中。如果服务端实现的是TLS的Http 2.0，必须使用TLS方式进行传输。</p>
<p>整个核心有两个，都是关于Http 2.0的：</p>
<ul>
<li>startHttp2</li>
<li>connectTls</li>
</ul>
<p>我们从假设此时sslSocketFactory 存在，先调用connectTls 方法处理TLS协议</p>
<h6 id="connectTls"><a href="#connectTls" class="headerlink" title="connectTls"></a>connectTls</h6><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">connectTls</span><span class="token punctuation">(</span>connectionSpecSelector<span class="token operator">:</span> ConnectionSpecSelector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> address <span class="token operator">=</span> route<span class="token punctuation">.</span>address
    <span class="token keyword">val</span> sslSocketFactory <span class="token operator">=</span> address<span class="token punctuation">.</span>sslSocketFactory
    <span class="token keyword">var</span> success <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">var</span> sslSocket<span class="token operator">:</span> SSLSocket<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Create the wrapper over the connected socket.</span>
      sslSocket <span class="token operator">=</span> sslSocketFactory<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">createSocket</span><span class="token punctuation">(</span>
          rawSocket<span class="token punctuation">,</span> address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>host<span class="token punctuation">,</span> address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* autoClose */</span><span class="token punctuation">)</span> <span class="token keyword">as</span> SSLSocket

      <span class="token comment" spellcheck="true">// Configure the socket's ciphers, TLS versions, and extensions.</span>
      <span class="token keyword">val</span> connectionSpec <span class="token operator">=</span> connectionSpecSelector<span class="token punctuation">.</span><span class="token function">configureSecureSocket</span><span class="token punctuation">(</span>sslSocket<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionSpec<span class="token punctuation">.</span>supportsTlsExtensions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configureTlsExtensions</span><span class="token punctuation">(</span>sslSocket<span class="token punctuation">,</span> address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>host<span class="token punctuation">,</span> address<span class="token punctuation">.</span>protocols<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// Force handshake. This can throw!</span>
      sslSocket<span class="token punctuation">.</span><span class="token function">startHandshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment" spellcheck="true">// block for session establishment</span>
      <span class="token keyword">val</span> sslSocketSession <span class="token operator">=</span> sslSocket<span class="token punctuation">.</span>session
      <span class="token keyword">val</span> unverifiedHandshake <span class="token operator">=</span> sslSocketSession<span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">// Verify that the socket's certificates are acceptable for the target host.</span>
<span class="token operator">..</span><span class="token punctuation">.</span>

      <span class="token keyword">val</span> certificatePinner <span class="token operator">=</span> address<span class="token punctuation">.</span>certificatePinner<span class="token operator">!!</span>

      handshake <span class="token operator">=</span> <span class="token function">Handshake</span><span class="token punctuation">(</span>unverifiedHandshake<span class="token punctuation">.</span>tlsVersion<span class="token punctuation">,</span> unverifiedHandshake<span class="token punctuation">.</span>cipherSuite<span class="token punctuation">,</span>
          unverifiedHandshake<span class="token punctuation">.</span>localCertificates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        certificatePinner<span class="token punctuation">.</span>certificateChainCleaner<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span>unverifiedHandshake<span class="token punctuation">.</span>peerCertificates<span class="token punctuation">,</span>
            address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>host<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// Check that the certificate pinner is satisfied by the certificates presented.</span>
      certificatePinner<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>host<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handshake<span class="token operator">!!</span><span class="token punctuation">.</span>peerCertificates<span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> it <span class="token keyword">as</span> X509Certificate <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// Success! Save the handshake and the ALPN protocol.</span>
      <span class="token keyword">val</span> maybeProtocol <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionSpec<span class="token punctuation">.</span>supportsTlsExtensions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSelectedProtocol</span><span class="token punctuation">(</span>sslSocket<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">null</span>
      <span class="token punctuation">}</span>
      socket <span class="token operator">=</span> sslSocket
      source <span class="token operator">=</span> sslSocket<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      sink <span class="token operator">=</span> sslSocket<span class="token punctuation">.</span><span class="token function">sink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      protocol <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>maybeProtocol <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> Protocol<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>maybeProtocol<span class="token punctuation">)</span> <span class="token keyword">else</span> Protocol<span class="token punctuation">.</span>HTTP_1_1
      success <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sslSocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">afterHandshake</span><span class="token punctuation">(</span>sslSocket<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sslSocket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.sslSocketFactory!!.createSocket 通过工厂创建一个SSL 的socket</li>
<li><ol start="2">
<li>获取Okhttp的Platform，调用configureTlsExtensions 配置SSLSocket</li>
</ol>
</li>
<li><ol start="3">
<li>sslSocket. startHandshake 开始进行握手</li>
</ol>
</li>
<li><ol start="4">
<li>获取sslSocket的session，调用session的handshake方法</li>
</ol>
</li>
<li>5.构建一个HandShake对象，CertificatePinner 对 Session的Certificate集合通过X509TrustManagerExtensions 校验，从这些证书集合中晒选出信任的证书。</li>
<li>6.从这些Certificate集合中，进一步的筛选出类型为X509Certificate的证书。</li>
<li>7.如果当前的请求支持tls的扩展，那么就从Platform中获取当前匹配的协议，进行协议切换。</li>
<li>8.最后，获取sslSocket的写入写出流缓存到RealConnection中。</li>
</ul>
<p><img src="/images/OkhttpPlatform.png" alt="OkhttpPlatform.png"></p>
<p>在Okhttp中内部设置如上几中platform，当然我们Android开发只需要关注AndroidPlatform以及Android10Platform。其实就是一个适配器模式。至于如何检测出Android还是Java其实很简单：</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">val</span> isAndroid<span class="token operator">:</span> Boolean
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"Dalvik"</span> <span class="token operator">==</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.vm.name"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>通过获取java的虚拟机名字，如果是<code>Dalvik</code>则是Android环境。说明不管是ART虚拟机还是Dalvik虚拟机，一般情况下，虚拟机名字都是Dalvik。</p>
<h6 id="startHttp2"><a href="#startHttp2" class="headerlink" title="startHttp2"></a>startHttp2</h6><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">startHttp2</span><span class="token punctuation">(</span>pingIntervalMillis<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> socket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token operator">!!</span>
    <span class="token keyword">val</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token operator">!!</span>
    <span class="token keyword">val</span> sink <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sink<span class="token operator">!!</span>
    socket<span class="token punctuation">.</span>soTimeout <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">// HTTP/2 connection timeouts are set per-stream.</span>
    <span class="token keyword">val</span> http2Connection <span class="token operator">=</span> Http2Connection<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>client <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> taskRunner <span class="token operator">=</span> TaskRunner<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> route<span class="token punctuation">.</span>address<span class="token punctuation">.</span>url<span class="token punctuation">.</span>host<span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pingIntervalMillis</span><span class="token punctuation">(</span>pingIntervalMillis<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>http2Connection <span class="token operator">=</span> http2Connection
    <span class="token keyword">this</span><span class="token punctuation">.</span>allocationLimit <span class="token operator">=</span> Http2Connection<span class="token punctuation">.</span>DEFAULT_SETTINGS<span class="token punctuation">.</span><span class="token function">getMaxConcurrentStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    http2Connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先构建了一个Http2Connection对象，并把任务调度工具TaskRunner 和socket设置在其中，最后调用http2Connection的start方法。</p>
<p>注意如果是经过了TLS/SSL 此时的socket 是在connecttls中设置的SSL Socket。否则就是在establishProtocol 中设置的普通socket。</p>
<h5 id="Http2Connection-的初始化"><a href="#Http2Connection-的初始化" class="headerlink" title="Http2Connection 的初始化"></a>Http2Connection 的初始化</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">init</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>builder<span class="token punctuation">.</span>pingIntervalMillis <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> pingIntervalNanos <span class="token operator">=</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>pingIntervalMillis<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      writerQueue<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation variable">$connectionName</span> ping"</span><span class="token punctuation">,</span> pingIntervalNanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> failDueToMissingPong <span class="token operator">=</span> <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@Http2Connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>intervalPongsReceived <span class="token operator">&lt;</span> intervalPingsSent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token label symbol">@synchronized</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            intervalPingsSent<span class="token operator">++</span>
            <span class="token keyword">return</span><span class="token label symbol">@synchronized</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failDueToMissingPong<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">failConnection</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span><span class="token label symbol">@schedule</span> <span class="token operator">-</span><span class="token number">1L</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">writePing</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> INTERVAL_PING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span><span class="token label symbol">@schedule</span> pingIntervalNanos
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于TaskRunner的实现这里不多说，writerQueue实际上通过TaskRunner生成一个<code>TaskQueue</code>对象。TaskRunner内置了Backend对象，他里面就是一个线程池，阻塞队列为一对一的<code>SynchronousQueue</code>.</p>
<p>每当进行调度发送到任务处理，就会把这个Runnable封装成Task对象，添加到<code>TaskQueue</code>的<code>futureTasks</code>队列末尾，然后调用TaskRunner的Backend对象，在线程池中执行Task。当然如果正在工作了，调用Backend的执行而是把<code>TaskQueue</code>添加到<code>TaskRunner</code>的<code>readyQueues</code>中. 在Backend的线程池子中有一个写好的Runnable，消费这些队列：</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">private</span> <span class="token keyword">val</span> runnable<span class="token operator">:</span> Runnable <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> Runnable <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> task <span class="token operator">=</span> <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@TaskRunner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">awaitTaskToRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token operator">?:</span> <span class="token keyword">return</span>

        <span class="token function">logElapsed</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> task<span class="token punctuation">.</span>queue<span class="token operator">!!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> completedNormally <span class="token operator">=</span> <span class="token boolean">false</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">runTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>
            completedNormally <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// If the task is crashing start another thread to service the queues.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>completedNormally<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              backend<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到实际上线程执行的是一个looper，循环处理,核心是awaitTaskToRun 下面一段</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">      <span class="token label symbol">eachQueue@</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>queue <span class="token keyword">in</span> readyQueues<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> candidate <span class="token operator">=</span> queue<span class="token punctuation">.</span>futureTasks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">val</span> candidateDelay <span class="token operator">=</span> <span class="token function">maxOf</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> candidate<span class="token punctuation">.</span>nextExecuteNanoTime <span class="token operator">-</span> now<span class="token punctuation">)</span>

        <span class="token keyword">when</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// Compute the delay of the soonest-executable task.</span>
          candidateDelay <span class="token operator">></span> <span class="token number">0L</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            minDelayNanos <span class="token operator">=</span> <span class="token function">minOf</span><span class="token punctuation">(</span>candidateDelay<span class="token punctuation">,</span> minDelayNanos<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token label symbol">@eachQueue</span>
          <span class="token punctuation">}</span>

          <span class="token comment" spellcheck="true">// If we already have more than one task, that's enough work for now. Stop searching.</span>
          readyTask <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            multipleReadyTasks <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token keyword">break</span><span class="token label symbol">@eachQueue</span>
          <span class="token punctuation">}</span>

          <span class="token comment" spellcheck="true">// We have a task to execute when we complete the loop.</span>
          <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            readyTask <span class="token operator">=</span> candidate
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程实际上是不断的消费距离当前时间最近的Task。</p>
<p>这个Task实际上做的事情就是一个执行writePing 发送心跳包给服务器。</p>
<h6 id="writePing"><a href="#writePing" class="headerlink" title="writePing"></a>writePing</h6><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">val</span> writer <span class="token operator">=</span> <span class="token function">Http2Writer</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>sink<span class="token punctuation">,</span> client<span class="token punctuation">)</span>

  <span class="token keyword">fun</span> <span class="token function">writePing</span><span class="token punctuation">(</span>
    reply<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    payload1<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    payload2<span class="token operator">:</span> Int
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      writer<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> payload1<span class="token punctuation">,</span> payload2<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">failConnection</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程实际上就是通过Http2Writer 往服务器写数据帧数。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">fun</span> <span class="token function">ping</span><span class="token punctuation">(</span>ack<span class="token operator">:</span> Boolean<span class="token punctuation">,</span> payload1<span class="token operator">:</span> Int<span class="token punctuation">,</span> payload2<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"closed"</span><span class="token punctuation">)</span>
    <span class="token function">frameHeader</span><span class="token punctuation">(</span>
        streamId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        length <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
        type <span class="token operator">=</span> TYPE_PING<span class="token punctuation">,</span>
        flags <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> FLAG_ACK <span class="token keyword">else</span> FLAG_NONE
    <span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意几个参数：</p>
<ul>
<li>ack 为false</li>
<li>payload1是指<pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">const</span> <span class="token keyword">val</span> INTERVAL_PING <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>payload2是指0</li>
</ul>
<p>先通过frameHeader 生成一个数据帧，然后依次写入1和0</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">const</span> <span class="token keyword">val</span> FLAG_NONE <span class="token operator">=</span> <span class="token number">0x0</span>
  <span class="token keyword">const</span> <span class="token keyword">val</span> FLAG_ACK <span class="token operator">=</span> <span class="token number">0x1</span> <span class="token comment" spellcheck="true">// Used for settings and ping.</span>
  <span class="token keyword">const</span> <span class="token keyword">val</span> TYPE_PING <span class="token operator">=</span> <span class="token number">0x6</span>

  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">frameHeader</span><span class="token punctuation">(</span>streamId<span class="token operator">:</span> Int<span class="token punctuation">,</span> length<span class="token operator">:</span> Int<span class="token punctuation">,</span> type<span class="token operator">:</span> Int<span class="token punctuation">,</span> flags<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
    sink<span class="token punctuation">.</span><span class="token function">writeMedium</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// </span>
    sink<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>type <span class="token operator">and</span> <span class="token number">0xff</span><span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>flags <span class="token operator">and</span> <span class="token number">0xff</span><span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>streamId <span class="token operator">and</span> <span class="token number">0x7fffffff</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token keyword">fun</span> BufferedSink<span class="token punctuation">.</span><span class="token function">writeMedium</span><span class="token punctuation">(</span>medium<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">writeByte</span><span class="token punctuation">(</span>medium<span class="token punctuation">.</span><span class="token function">ushr</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//向右移动高16位，获取低16位，也就是拿到最高的16位(31~16)</span>
  <span class="token function">writeByte</span><span class="token punctuation">(</span>medium<span class="token punctuation">.</span><span class="token function">ushr</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//向右移动8位，也就是(24~8)</span>
  <span class="token function">writeByte</span><span class="token punctuation">(</span>medium <span class="token operator">and</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 直接获取低16位</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这里，我们可以得到如下的数据结构<br><img src="/images/http2ping%E7%AC%AC%E4%B8%80%E5%B8%A7.png" alt="http2ping第一帧.png"></p>
<h5 id="http2Connection-start"><a href="#http2Connection-start" class="headerlink" title="http2Connection.start"></a>http2Connection.start</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token annotation builtin">@JvmOverloads</span>
  <span class="token keyword">fun</span> <span class="token function">start</span><span class="token punctuation">(</span>sendConnectionPreface<span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> taskRunner<span class="token operator">:</span> TaskRunner <span class="token operator">=</span> TaskRunner<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sendConnectionPreface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      writer<span class="token punctuation">.</span><span class="token function">connectionPreface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      writer<span class="token punctuation">.</span><span class="token function">settings</span><span class="token punctuation">(</span>okHttpSettings<span class="token punctuation">)</span>
      <span class="token keyword">val</span> windowSize <span class="token operator">=</span> okHttpSettings<span class="token punctuation">.</span>initialWindowSize
      <span class="token keyword">if</span> <span class="token punctuation">(</span>windowSize <span class="token operator">!=</span> DEFAULT_INITIAL_WINDOW_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writer<span class="token punctuation">.</span><span class="token function">windowUpdate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>windowSize <span class="token operator">-</span> DEFAULT_INITIAL_WINDOW_SIZE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    taskRunner<span class="token punctuation">.</span><span class="token function">newQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>name <span class="token operator">=</span> connectionName<span class="token punctuation">,</span> block <span class="token operator">=</span> readerRunnable<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.首先调用connectionPreface 往socket里写入序言，说明客户端要开始发送数据了。</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@JvmField</span>
  <span class="token keyword">val</span> CONNECTION_PREFACE <span class="token operator">=</span> <span class="token string">"PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n"</span><span class="token punctuation">.</span><span class="token function">encodeUtf8</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token annotation builtin">@Synchronized</span> <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">connectionPreface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"closed"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment" spellcheck="true">// Nothing to write; servers don't send connection headers!</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>FINE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">fine</span><span class="token punctuation">(</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">">> CONNECTION <span class="token interpolation"><span class="token delimiter variable">${</span>CONNECTION_PREFACE<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sink<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>CONNECTION_PREFACE<span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程往socket中写入字符串<code>PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n</code></p>
<ul>
<li>2.Http2Writer.settings 往socket中写入的配置</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">
  <span class="token comment" spellcheck="true">/** Settings we communicate to the peer. */</span>
  <span class="token keyword">val</span> okHttpSettings <span class="token operator">=</span> <span class="token function">Settings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>builder<span class="token punctuation">.</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">set</span><span class="token punctuation">(</span>Settings<span class="token punctuation">.</span>INITIAL_WINDOW_SIZE<span class="token punctuation">,</span> OKHTTP_CLIENT_WINDOW_SIZE<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上在Settings中持有一个数组，数组每一位代表一种设置。设置这个初始数据输出窗口大小为16M。这个窗口和tcp的滑动窗口需要区分开。这个是为了避免出现Http2.0上传太多数据流而做的限制。</p>
<p>下面是配置http2.0的列表</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/**
     * From the HTTP/2 specs, the default initial window size for all streams is 64 KiB. (Chrome 25
     * uses 10 MiB).
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> DEFAULT_INITIAL_WINDOW_SIZE <span class="token operator">=</span> <span class="token number">65535</span>

    <span class="token comment" spellcheck="true">/** HTTP/2: Size in bytes of the table used to decode the sender's header blocks. */</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> HEADER_TABLE_SIZE <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token comment" spellcheck="true">/** HTTP/2: The peer must not send a PUSH_PROMISE frame when this is 0. */</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> ENABLE_PUSH <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token comment" spellcheck="true">/** Sender's maximum number of concurrent streams. */</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> MAX_CONCURRENT_STREAMS <span class="token operator">=</span> <span class="token number">4</span>
    <span class="token comment" spellcheck="true">/** HTTP/2: Size in bytes of the largest frame payload the sender will accept. */</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> MAX_FRAME_SIZE <span class="token operator">=</span> <span class="token number">5</span>
    <span class="token comment" spellcheck="true">/** HTTP/2: Advisory only. Size in bytes of the largest header list the sender will accept. */</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> MAX_HEADER_LIST_SIZE <span class="token operator">=</span> <span class="token number">6</span>
    <span class="token comment" spellcheck="true">/** Window size in bytes. */</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> INITIAL_WINDOW_SIZE <span class="token operator">=</span> <span class="token number">7</span>

    <span class="token comment" spellcheck="true">/** Total number of settings. */</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> COUNT <span class="token operator">=</span> <span class="token number">10</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.HEADER_TABLE_SIZE 用于解码发送方头部的字节大小，这个大小由服务器发送回来的应答进行调整</li>
<li>2.ENABLE_PUSH 对端是否可以进行数据传输。默认是允许的。</li>
<li>3.MAX_CONCURRENT_STREAMS 发送端最大的并发流数目 </li>
<li>4.MAX_FRAME_SIZE 发送端一帧数据最大能接受多大，初始大小为16384(16kb).</li>
<li>5.MAX_HEADER_LIST_SIZE 发送端最大能接受的一帧数据</li>
<li>6.INITIAL_WINDOW_SIZE 所有并发流控制窗口初始大小，初始大小为65535.但是当时调用http2Connection的时候，就修改为16M。</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">
  <span class="token annotation builtin">@Synchronized</span> <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">settings</span><span class="token punctuation">(</span>settings<span class="token operator">:</span> Settings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"closed"</span><span class="token punctuation">)</span>
    <span class="token function">frameHeader</span><span class="token punctuation">(</span>
        streamId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        length <span class="token operator">=</span> settings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">,</span>
        type <span class="token operator">=</span> TYPE_SETTINGS<span class="token punctuation">,</span>
        flags <span class="token operator">=</span> FLAG_NONE
    <span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until Settings<span class="token punctuation">.</span>COUNT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>settings<span class="token punctuation">.</span><span class="token function">isSet</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>
      <span class="token keyword">val</span> id <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token number">4</span> <span class="token operator">-></span> <span class="token number">3</span> <span class="token comment" spellcheck="true">// SETTINGS_MAX_CONCURRENT_STREAMS renumbered.</span>
        <span class="token number">7</span> <span class="token operator">-></span> <span class="token number">4</span> <span class="token comment" spellcheck="true">// SETTINGS_INITIAL_WINDOW_SIZE renumbered.</span>
        <span class="token keyword">else</span> <span class="token operator">-></span> i
      <span class="token punctuation">}</span>
      sink<span class="token punctuation">.</span><span class="token function">writeShort</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
      sink<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>settings<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sink<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/%E4%BC%A0%E9%80%81settings.png" alt="传送settings.png"></p>
<ul>
<li>3.调用windowUpdate 往socket里面写入并发流控制窗体变化情况。</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Synchronized</span> <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">windowUpdate</span><span class="token punctuation">(</span>streamId<span class="token operator">:</span> Int<span class="token punctuation">,</span> windowSizeIncrement<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"closed"</span><span class="token punctuation">)</span>
    <span class="token function">require</span><span class="token punctuation">(</span>windowSizeIncrement <span class="token operator">!=</span> <span class="token number">0L</span> <span class="token operator">&amp;&amp;</span> windowSizeIncrement <span class="token operator">&lt;=</span> 0x7fffffffL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">"windowSizeIncrement == 0 || windowSizeIncrement > 0x7fffffffL: <span class="token interpolation variable">$windowSizeIncrement</span>"</span>
    <span class="token punctuation">}</span>
    <span class="token function">frameHeader</span><span class="token punctuation">(</span>
        streamId <span class="token operator">=</span> streamId<span class="token punctuation">,</span>
        length <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
        type <span class="token operator">=</span> TYPE_WINDOW_UPDATE<span class="token punctuation">,</span>
        flags <span class="token operator">=</span> FLAG_NONE
    <span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>windowSizeIncrement<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sink<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/%E7%AA%97%E4%BD%93%E5%8F%98%E5%8C%96%E6%95%B0%E6%8D%AE.png" alt="窗体变化数据.png"></p>
<ul>
<li>4.异步线程执行readerRunnable ，发送完配置数据后等待服务器的响应数据<pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> readerRunnable <span class="token operator">=</span> <span class="token function">ReaderRunnable</span><span class="token punctuation">(</span><span class="token function">Http2Reader</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>source<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h4 id="ReaderRunnable与Http2Reader-读取服务端发送的数据"><a href="#ReaderRunnable与Http2Reader-读取服务端发送的数据" class="headerlink" title="ReaderRunnable与Http2Reader 读取服务端发送的数据"></a>ReaderRunnable与Http2Reader 读取服务端发送的数据</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">inner</span> <span class="token keyword">class</span> ReaderRunnable <span class="token keyword">internal</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">internal</span> <span class="token keyword">val</span> reader<span class="token operator">:</span> Http2Reader
  <span class="token punctuation">)</span> <span class="token operator">:</span> Http2Reader<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> connectionErrorCode <span class="token operator">=</span> ErrorCode<span class="token punctuation">.</span>INTERNAL_ERROR
      <span class="token keyword">var</span> streamErrorCode <span class="token operator">=</span> ErrorCode<span class="token punctuation">.</span>INTERNAL_ERROR
      <span class="token keyword">var</span> errorException<span class="token operator">:</span> IOException<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        reader<span class="token punctuation">.</span><span class="token function">readConnectionPreface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">nextFrame</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        connectionErrorCode <span class="token operator">=</span> ErrorCode<span class="token punctuation">.</span>NO_ERROR
        streamErrorCode <span class="token operator">=</span> ErrorCode<span class="token punctuation">.</span>CANCEL
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errorException <span class="token operator">=</span> e
        connectionErrorCode <span class="token operator">=</span> ErrorCode<span class="token punctuation">.</span>PROTOCOL_ERROR
        streamErrorCode <span class="token operator">=</span> ErrorCode<span class="token punctuation">.</span>PROTOCOL_ERROR
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">close</span><span class="token punctuation">(</span>connectionErrorCode<span class="token punctuation">,</span> streamErrorCode<span class="token punctuation">,</span> errorException<span class="token punctuation">)</span>
        reader<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上做了如下的事情：</p>
<ul>
<li>1.从Http2Reader的readConnectionPreface 读取标示头</li>
<li>2.调用reader.nextFrame 不断的读取下一帧的响应数据，直到结束为止。</li>
</ul>
<h5 id="Http2Reader-readConnectionPreface"><a href="#Http2Reader-readConnectionPreface" class="headerlink" title="Http2Reader readConnectionPreface"></a>Http2Reader readConnectionPreface</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">readConnectionPreface</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> Handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">nextFrame</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"Required SETTINGS preface not received"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到readConnectionPreface 方法核心也是nextFrame的方法。</p>
<h5 id="Http2Reader-nextFrame"><a href="#Http2Reader-nextFrame" class="headerlink" title="Http2Reader nextFrame"></a>Http2Reader nextFrame</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">fun</span> <span class="token function">nextFrame</span><span class="token punctuation">(</span>requireSettings<span class="token operator">:</span> Boolean<span class="token punctuation">,</span> handler<span class="token operator">:</span> Handler<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      source<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Frame header size.</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> EOFException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">// This might be a normal socket close.</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//  0                   1                   2                   3</span>
    <span class="token comment" spellcheck="true">//  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
    <span class="token comment" spellcheck="true">// +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
    <span class="token comment" spellcheck="true">// |                 Length (24)                   |</span>
    <span class="token comment" spellcheck="true">// +---------------+---------------+---------------+</span>
    <span class="token comment" spellcheck="true">// |   Type (8)    |   Flags (8)   |</span>
    <span class="token comment" spellcheck="true">// +-+-+-----------+---------------+-------------------------------+</span>
    <span class="token comment" spellcheck="true">// |R|                 Stream Identifier (31)                      |</span>
    <span class="token comment" spellcheck="true">// +=+=============================================================+</span>
    <span class="token comment" spellcheck="true">// |                   Frame Payload (0...)                      ...</span>
    <span class="token comment" spellcheck="true">// +---------------------------------------------------------------+</span>
    <span class="token keyword">val</span> length <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">readMedium</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">></span> INITIAL_MAX_FRAME_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"FRAME_SIZE_ERROR: <span class="token interpolation variable">$length</span>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">val</span> type <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token number">0xff</span>
    <span class="token keyword">val</span> flags <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token number">0xff</span>
    <span class="token keyword">val</span> streamId <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token number">0x7fffffff</span> <span class="token comment" spellcheck="true">// Ignore reserved bit.</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">when</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      TYPE_DATA <span class="token operator">-></span> <span class="token function">readData</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_HEADERS <span class="token operator">-></span> <span class="token function">readHeaders</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_PRIORITY <span class="token operator">-></span> <span class="token function">readPriority</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_RST_STREAM <span class="token operator">-></span> <span class="token function">readRstStream</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_SETTINGS <span class="token operator">-></span> <span class="token function">readSettings</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_PUSH_PROMISE <span class="token operator">-></span> <span class="token function">readPushPromise</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_PING <span class="token operator">-></span> <span class="token function">readPing</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_GOAWAY <span class="token operator">-></span> <span class="token function">readGoAway</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      TYPE_WINDOW_UPDATE <span class="token operator">-></span> <span class="token function">readWindowUpdate</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> length<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> streamId<span class="token punctuation">)</span>
      <span class="token keyword">else</span> <span class="token operator">-></span> source<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>length<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Implementations MUST discard frames of unknown types.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>服务端传递过来的结构和客户端传递过去的一致：</p>
<ul>
<li>1.首先解析当前数据帧有多长</li>
<li>2.然后获取当前数据帧的类型type</li>
<li>3.接着获取数据帧的flag</li>
<li>4.获取当前数据帧所属的数据流id</li>
<li>5.根据类型从而解析不同的数据。</li>
</ul>
<p><img src="/images/Http2%E6%95%B0%E6%8D%AE%E5%B8%A7.png" alt="Http2 数据帧.png"></p>
<p>上面我们依次发送了如下的类型的数据：</p>
<ul>
<li>1.TYPE_PING</li>
<li>2.TYPE_SETTINGS</li>
<li>3.TYPE_WINDOW_UPDATE</li>
</ul>
<h4 id="处理TYPE-PING"><a href="#处理TYPE-PING" class="headerlink" title="处理TYPE_PING"></a>处理TYPE_PING</h4><p>TYPE_PING 在RFC协议中，用于确定双方的链接是否还有效。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">readPing</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> Handler<span class="token punctuation">,</span> length<span class="token operator">:</span> Int<span class="token punctuation">,</span> flags<span class="token operator">:</span> Int<span class="token punctuation">,</span> streamId<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"TYPE_PING length != 8: <span class="token interpolation variable">$length</span>"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>streamId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"TYPE_PING streamId != 0"</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> payload1 <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> payload2 <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> ack <span class="token operator">=</span> flags <span class="token operator">and</span> FLAG_ACK <span class="token operator">!=</span> <span class="token number">0</span>
    handler<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span>ack<span class="token punctuation">,</span> payload1<span class="token punctuation">,</span> payload2<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么就会拿到flag，如果是FLAG_ACK 不为0，说明此时是从服务器那边的应答。并取出payload1和payload2，传递到Handler中处理。此时的Handler是指ReaderRunnable。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">ping</span><span class="token punctuation">(</span>
      ack<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
      payload1<span class="token operator">:</span> Int<span class="token punctuation">,</span>
      payload2<span class="token operator">:</span> Int
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@Http2Connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">when</span> <span class="token punctuation">(</span>payload1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            INTERVAL_PING <span class="token operator">-></span> <span class="token punctuation">{</span>
              intervalPongsReceived<span class="token operator">++</span>
            <span class="token punctuation">}</span>
            DEGRADED_PING <span class="token operator">-></span> <span class="token punctuation">{</span>
              degradedPongsReceived<span class="token operator">++</span>
            <span class="token punctuation">}</span>
            AWAIT_PING <span class="token operator">-></span> <span class="token punctuation">{</span>
              awaitPongsReceived<span class="token operator">++</span>
              <span class="token keyword">this</span><span class="token label symbol">@Http2Connection</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">// Ignore an unexpected pong.</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程中，就是不断的进行ping的计数。</p>
<h5 id="TYPE-SETTINGS"><a href="#TYPE-SETTINGS" class="headerlink" title="TYPE_SETTINGS"></a>TYPE_SETTINGS</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">readSettings</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> Handler<span class="token punctuation">,</span> length<span class="token operator">:</span> Int<span class="token punctuation">,</span> flags<span class="token operator">:</span> Int<span class="token punctuation">,</span> streamId<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>streamId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"TYPE_SETTINGS streamId != 0"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">and</span> FLAG_ACK <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"FRAME_SIZE_ERROR ack frame should be empty!"</span><span class="token punctuation">)</span>
      handler<span class="token punctuation">.</span><span class="token function">ackSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">%</span> <span class="token number">6</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"TYPE_SETTINGS length % 6 != 0: <span class="token interpolation variable">$length</span>"</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> settings <span class="token operator">=</span> <span class="token function">Settings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until length step <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> id <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">readShort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token number">0xffff</span>
      <span class="token keyword">val</span> value <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">when</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// SETTINGS_HEADER_TABLE_SIZE</span>
        <span class="token number">1</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// SETTINGS_ENABLE_PUSH</span>
        <span class="token number">2</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"PROTOCOL_ERROR SETTINGS_ENABLE_PUSH != 0 or 1"</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// SETTINGS_MAX_CONCURRENT_STREAMS</span>
        <span class="token number">3</span> <span class="token operator">-></span> id <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment" spellcheck="true">// Renumbered in draft 10.</span>

        <span class="token comment" spellcheck="true">// SETTINGS_INITIAL_WINDOW_SIZE</span>
        <span class="token number">4</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
          id <span class="token operator">=</span> <span class="token number">7</span> <span class="token comment" spellcheck="true">// Renumbered in draft 10.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"PROTOCOL_ERROR SETTINGS_INITIAL_WINDOW_SIZE > 2^31 - 1"</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// SETTINGS_MAX_FRAME_SIZE</span>
        <span class="token number">5</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> INITIAL_MAX_FRAME_SIZE <span class="token operator">||</span> value <span class="token operator">></span> <span class="token number">16777215</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string">"PROTOCOL_ERROR SETTINGS_MAX_FRAME_SIZE: <span class="token interpolation variable">$value</span>"</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// SETTINGS_MAX_HEADER_LIST_SIZE</span>
        <span class="token number">6</span> <span class="token operator">-></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Advisory only, so ignored.</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Must ignore setting with unknown id.</span>
        <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      settings<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> value
    <span class="token punctuation">}</span>
    handler<span class="token punctuation">.</span><span class="token function">settings</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> settings<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果不是打开了FLAG_ACK，那么说明是从客户端发送到服务器的数据，此时会调用ackSettings。</p>
</li>
<li><p>2.如果打开了FLAG_ACK，说明是客户端发送到服务端的应答数据，这个过程就是读取从客户端传递过来的数据帧，读取其中每一项配置合并当前服务器每一个配置。能看到实际上客户端此时只能影响服务端除了限制并发流窗口大小之外所有的配置。</p>
</li>
</ul>
<p>Handler中的ackSettings，其实什么实现都没有。</p>
<h5 id="处理TYPE-WINDOW-UPDATE"><a href="#处理TYPE-WINDOW-UPDATE" class="headerlink" title="处理TYPE_WINDOW_UPDATE"></a>处理TYPE_WINDOW_UPDATE</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">readWindowUpdate</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> Handler<span class="token punctuation">,</span> length<span class="token operator">:</span> Int<span class="token punctuation">,</span> flags<span class="token operator">:</span> Int<span class="token punctuation">,</span> streamId<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">val</span> increment <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> 0x7fffffffL
<span class="token operator">..</span><span class="token punctuation">.</span>
    handler<span class="token punctuation">.</span><span class="token function">windowUpdate</span><span class="token punctuation">(</span>streamId<span class="token punctuation">,</span> increment<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心只有一行windowUpdate：</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">windowUpdate</span><span class="token punctuation">(</span>streamId<span class="token operator">:</span> Int<span class="token punctuation">,</span> windowSizeIncrement<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>streamId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@Http2Connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          writeBytesMaximum <span class="token operator">+=</span> windowSizeIncrement
          <span class="token keyword">this</span><span class="token label symbol">@Http2Connection</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> stream <span class="token operator">=</span> <span class="token function">getStream</span><span class="token punctuation">(</span>streamId<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">synchronized</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stream<span class="token punctuation">.</span><span class="token function">addBytesToWriteWindow</span><span class="token punctuation">(</span>windowSizeIncrement<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果streamId 为0，那么就更改writeBytesMaximum 中的大小，从而动态的修改okhttp 中对所有并发流的窗口控制。</p>
<h3 id="RealConnection-newCodec"><a href="#RealConnection-newCodec" class="headerlink" title="RealConnection newCodec"></a>RealConnection newCodec</h3><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>SocketException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">newCodec</span><span class="token punctuation">(</span>client<span class="token operator">:</span> OkHttpClient<span class="token punctuation">,</span> chain<span class="token operator">:</span> RealInterceptorChain<span class="token punctuation">)</span><span class="token operator">:</span> ExchangeCodec <span class="token punctuation">{</span>
    <span class="token keyword">val</span> socket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token operator">!!</span>
    <span class="token keyword">val</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token operator">!!</span>
    <span class="token keyword">val</span> sink <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sink<span class="token operator">!!</span>
    <span class="token keyword">val</span> http2Connection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http2Connection

    <span class="token keyword">return</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>http2Connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">Http2ExchangeCodec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> chain<span class="token punctuation">,</span> http2Connection<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      socket<span class="token punctuation">.</span>soTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      source<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span>readTimeoutMillis<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">)</span>
      sink<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span>writeTimeoutMillis<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">)</span>
      <span class="token function">Http1ExchangeCodec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果执行了startHttp2 那么此时的http2Connection 就不为空，并且为Http2Connection对象，就返回Http2ExchangeCodec对象。</p>
<p>除此之外都是Http 1.1或者是Http1.0 那么就返回Http1ExchangeCodec。</p>
<p>这两个对象最后都会保存在ExChange对象中并赋值给RealChainInterceptor中，执行到下一个拦截器中。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ConnectInterceptor 链接拦截器在okhttp中做了如下几件事情：</p>
<ul>
<li><p>1.尝试从ConnectionPool 中获取可以进行多路复用的socket链接(当然需要http 2.0协议的请求)</p>
</li>
<li><p>2.从ProxySelector 中获取直连或者代理的资源路径，在这个过程中，会处理三种情况：</p>
<ul>
<li>2.1 如果是<code>Proxy.Type.SOCKET</code> 则通过<code>InetSocketAddress.createUnresolved</code>解析获取到<code>InetSocketAddress</code>对象</li>
<li>2.2 如果是<code>Proxy.Type.DIRECT</code>或者<code>Proxy.Type.HTTP</code> 则通过Address的DNS方法调用lookup 查询 host对应对应的ip地址，生成<code>InetSocketAddress</code>对象</li>
</ul>
</li>
<li><p>3.当拿到了该资源路径对应所有的ip地址，(不是一对一，是因为可能是408等情况存在了负载均衡实际关联不同的服务器)，并开始尝试链接。</p>
<ul>
<li>3.1 如果是简单的知道了当前的代理模式是非Http代理模式，那么就会直接调用socket.connect 进行链接</li>
<li>3.2. 如果当前的代理模式是Http代理模式，那么会先先构造一个虚假的请求和应答，交给本地的proxyAuthenticator 尝试获取该代理服务器的需要的账号和密码，这样就不会出现407/408等权限异常再重新进行一次请求。当获取好后就添加到头部，并且调用socket.connect. </li>
<li>3.3 获取socket的输入输出流，保存在全局。</li>
</ul>
</li>
<li><ol start="4">
<li>establishProtocol 尝试这处理具体的协议，这个方法主要处理了Http 1.0和Http 2.0。</li>
</ol>
<ul>
<li><p>4.1. Http 1.0 存入了SSLSocketFactory对象，说明允许进行TLS/SSL 的加密传输（一般都存在一个默认的对象）。就会依次执行握手过程，依次为：</p>
<ul>
<li>4.1.1. 根据原来的socket对象，通过SSLSocketFactory 包裹生成一个新的sslSocket对象</li>
<li>4.1.2. sslSocket.startHandshake sslsocket对象开始进行握手</li>
<li>4.1.3. 获取sslSocket.session 对象，调用他的handshake方法，开始握手</li>
<li>4.1.4. 从Address的certificatePinner 中检索握手成功的证书，保证合法信任并且是X509Certificate</li>
</ul>
</li>
<li><p>4.2. 如果是Http 2.0 除了进行connectTls的操作之外，还会开始依次传输如下三种类型的http 数据帧：</p>
<ul>
<li>4.2.1. TYPE_PING 代表当前链接还活跃着，在RFC说明协议中，说明这个协议优先级是最高，必须先发送。</li>
<li>4.2.2 往服务端发送序言，说明客户端的流开始传递的了，会发送如下的数据：<code>PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n</code></li>
<li>4.2.3. TYPE_SETTINGS 把当前的okhttp设置的客户端的设置，如一个数据帧最大的负载容量是多少（默认为16kb），当前的允许控制的最大(默认是Int的最大值相当于不限制)交给服务器，服务器会把客户端的配置合并起来，进行对客户端的适配</li>
<li>4.2.4  TYPE_WINDOW_UPDATE  严格来说这个也是保存在settings中的，然而服务器只会读取前6个数组，刚好就没有读取这个所有复用并发流窗口大小。而是专门通过TYPE_WINDOW_UPDATE 和初始的65535大小的并发流窗口大小进行调节</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>到这里就完成了整个ConnectInterceptor 的工作。比起http 2.0的协议初始化，我们更需要关注的是，这个过程中由如下两个核心的方法：</p>
<ul>
<li>dns lookup 把资源地址转化为ip地址</li>
<li>socket.connect 通过socket把客户端和服务端联系起来</li>
<li>socket.starthandshake</li>
<li>socket.handshake</li>
</ul>
<p>这四个方法才是整个网络请求最为核心的四步骤。这里我们先把okhttp弄懂了整个流程，我们之后再回头看看这几个步骤，在底层中都做了什么？</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/11/03/android-chong-xue-xi-lie-okhttp-yuan-ma-jie-xi-si/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="Android重学系列 OkHttp源码解析(四)">
                        
                        <span class="card-title">Android重学系列 OkHttp源码解析(四)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章和大家探讨了，Okhttp的ConnectInterceptor 拦截器。接下来，我们就来聊聊Okhttp最后一个拦截器，CallServerInterceptor拦截器都做了什么？
正文  @Throws(IOExcepti
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-11-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/网络编程/" class="post-category">
                                    网络编程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/网络编程/">
                        <span class="chip bg-color">网络编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/10/16/android-chong-xue-xi-lie-okhttp-yuan-ma-jie-xi-er/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="Android重学系列 OkHttp源码解析(二)">
                        
                        <span class="card-title">Android重学系列 OkHttp源码解析(二)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言阅读过上一篇对网络编程的概述一文后，应该对网络编程有一个大体的概念了。从本文开始，将会开始对OkHttp的源码开始进行解析。
OkHttp是由square开发的网络请求哭，它是当前Android开发中使用率高达近100%的网络请求库。而
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-10-16
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/网络编程/" class="post-category">
                                    网络编程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/网络编程/">
                        <span class="chip bg-color">网络编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
