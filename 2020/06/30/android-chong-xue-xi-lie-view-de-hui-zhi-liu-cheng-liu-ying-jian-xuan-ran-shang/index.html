<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 View的绘制流程(六) 硬件渲染(上), Android | Linux | Flutter">
    <meta name="description" content="前言本文开始聊聊Android中的硬件渲染。如果跟着我的文章顺序，从SF进程到App进程的绘制流程一直阅读，我们到这里已经有了一定的基础，可以试着进行横向比对如Chrome浏览器渲染流程，看看软件渲染，硬件渲染，SF合成都做了什么程度的优化">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 View的绘制流程(六) 硬件渲染(上) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/13.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 View的绘制流程(六) 硬件渲染(上)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/View的绘制流程/" class="post-category">
                                View的绘制流程
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-06-30
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        12.1k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        53 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文开始聊聊Android中的硬件渲染。如果跟着我的文章顺序，从SF进程到App进程的绘制流程一直阅读，我们到这里已经有了一定的基础，可以试着进行横向比对如Chrome浏览器渲染流程，看看软件渲染，硬件渲染，SF合成都做了什么程度的优化。</p>
<p>先让我们回顾一下负责硬件渲染的主体对象ThreadedRenderer在整个绘制流程中做了哪几个步骤。</p>
<ul>
<li>1.enableHardwareAcceleration 实例化ThreadedRenderer</li>
<li>2.initialize 初始化</li>
<li>3.updateSurface 更新Surface</li>
<li>4.setup 启动ThreadedRenderer设置阴影等参数</li>
<li>5.如果需要 执行invalidateRoot 判断是否需要从根部开始遍历查找无效的元素</li>
<li>6.draw 开始硬件渲染进行View层级绘制</li>
<li>7.updateDisplayListIfDirty 更新硬件渲染中的脏区</li>
<li>8.destroy 销毁硬件渲染对象</li>
</ul>
<p>在硬件渲染的过程中，有一个很核心的对象RenderNode，作为每一个View绘制的节点对象。</p>
<p>当每一次进行准备进行绘制的时候，都会雷打不动执行如下三个步骤：</p>
<ul>
<li>1.RenderNode.start 生成一个新的DisplayListCanvas</li>
<li>2.DisplayListCanvas 上进行绘制 如调用Drawable的draw方法，把DisplayListCanvas作为参数</li>
<li>3.RenderNode.end 完成RenderNode的操作</li>
</ul>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>实际上整个硬件渲染的设计还是比较庞大。因此本文先聊聊ThreadedRender整个体系中主要对象的构造以及相关的原理。</p>
<p>首先来认识下面几个重要的对象有一个大体的印象。</p>
<ul>
<li>1.ThreadedRenderer 管理所有的硬件渲染对象，也是ViewRootImpl进行硬件渲染的入口对象。</li>
<li>2.RenderNode 每一个View都会携带的对象，当打开了硬件渲染的时候，将会根据判断，把相关的渲染逻辑移动到RenderNode中。</li>
<li>3.DisplayListCanvas 每一个RenderNode真正开始绘制自己的内容之前，需要通过RenderNode生成一个DisplayListCanvas，所有的绘制的行为都会在DisplayListCanvas中绘制，最后DisplayListCanvas会保存会RenderNode中。</li>
</ul>
<p>在Java层中面向Framework中，只有这么多，下面是一一映射的简图。<br><img src="/images/TextureView%E7%A1%AC%E4%BB%B6%E6%B8%B2%E6%9F%93.jpg" alt="硬件渲染.jpg"></p>
<p>能看到实际上RenderNode也会跟着View 树的构建同时一起构建整个显示层级。也是因此ThreadedRender也能以RenderNode为线索构建出一套和软件渲染一样的渲染流程。</p>
<p>仅仅这样？如果只是这么简单，知道我习惯的都知道，我喜欢把相关总结写在最后。如果把总揽写在正文开头是因为设计比较繁多。因为我们如果以流水线的形式进行剖析容易造成迷失细节的困境。</p>
<p>让我继续介绍一下，在硬件渲染中native层的核心对象。</p>
<ul>
<li><p>1.RootRenderNode 所有RenderNode的根部RenderNode，一切的View层级结构遍历都从这个RenderNode开始。类似View中DecorView的职责。但是DecorView并非和RootRenderNode对应，而是拥有自己的RenderNode。</p>
</li>
<li><p>2.RenderNode 对应于Java层的native对象</p>
</li>
<li><p>3.RenderThread 硬件渲染线程，所有的渲染任务都会在该线程中使用硬件渲染线程的Looper进行。</p>
</li>
<li><p>4.CanvasContext 是所有的渲染的上下文，它将持用PipeLine渲染管道</p>
</li>
<li><p>5.PipeLine 如OpenGLPipeLine，SkiaOpenGLPipeLine，VulkanPipeLine渲染管道。而这个渲染管道将会根据Android系统的配置，执行真正的渲染行为</p>
</li>
<li><p>6.DrawFrameTask 是整个ThreadedRender中真正开始执行渲染的对象</p>
</li>
<li><p>7.RenderNodeProxy  ThreadedRender的对应native层的入口。它将全局的作为RootRenderNode，CanvasContext，以及RenderThread门面（门面设计模式）。</p>
</li>
</ul>
<p>如下是一个思维导图：<br><img src="/images/ThreadedRender%E5%AF%B9%E8%B1%A1.png" alt="ThreadedRender对象.png"></p>
<p>有这么一个大体印象后，就不容易迷失在源码中。我们先来把这些对象的实例化以及上面列举的ThreadedRenderer在ViewRootImpl中执行行为的顺序和大家来聊聊其原理，先来看看ThreadedRenderer的实例化。</p>
<h2 id="ThreadedRenderer-实例化"><a href="#ThreadedRenderer-实例化" class="headerlink" title="ThreadedRenderer 实例化"></a>ThreadedRenderer 实例化</h2><p>当发现mSurfaceHolder为空的时候会调用如下函数：</p>
<pre class="line-numbers language-java"><code class="language-java">                <span class="token keyword">if</span> <span class="token punctuation">(</span>mSurfaceHolder <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">enableHardwareAcceleration</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>而这个方法则调用如下的方法对ThreadedRenderer进行创建：</p>
<pre class="line-numbers language-java"><code class="language-java"> mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer <span class="token operator">=</span> ThreadedRenderer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> translucent<span class="token punctuation">,</span>
                        attrs<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/ThreadedRenderer.java" target="_blank" rel="noopener">ThreadedRenderer.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sSupportsOpenGL <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> sSupportsOpenGL<span class="token punctuation">.</span><span class="token function">booleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>SystemProperties<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"ro.kernel.qemu"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sSupportsOpenGL <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> qemu_gles <span class="token operator">=</span> SystemProperties<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"qemu.gles"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>qemu_gles <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sSupportsOpenGL <span class="token operator">=</span> qemu_gles <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sSupportsOpenGL<span class="token punctuation">.</span><span class="token function">booleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> ThreadedRenderer <span class="token function">create</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> <span class="token keyword">boolean</span> translucent<span class="token punctuation">,</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ThreadedRenderer renderer <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadedRenderer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> translucent<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> renderer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能不能创建的了ThreadedRenderer则决定于全局配置。如果ro.kernel.qemu的配置为0，说明支持OpenGL 则可以直接返回true。如果qemu.gles为-1说明不支持OpenGL es返回false，只能使用软件渲染。如果设置了qemu.gles并大于0，才能打开硬件渲染。</p>
<h3 id="ThreadedRenderer构造函数"><a href="#ThreadedRenderer构造函数" class="headerlink" title="ThreadedRenderer构造函数"></a>ThreadedRenderer构造函数</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token function">ThreadedRenderer</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> <span class="token keyword">boolean</span> translucent<span class="token punctuation">,</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">long</span> rootNodePtr <span class="token operator">=</span> <span class="token function">nCreateRootRenderNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mRootNode <span class="token operator">=</span> RenderNode<span class="token punctuation">.</span><span class="token function">adopt</span><span class="token punctuation">(</span>rootNodePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mRootNode<span class="token punctuation">.</span><span class="token function">setClipToBounds</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mIsOpaque <span class="token operator">=</span> <span class="token operator">!</span>translucent<span class="token punctuation">;</span>
        mNativeProxy <span class="token operator">=</span> <span class="token function">nCreateProxy</span><span class="token punctuation">(</span>translucent<span class="token punctuation">,</span> rootNodePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">nSetName</span><span class="token punctuation">(</span>mNativeProxy<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ProcessInitializer<span class="token punctuation">.</span>sInstance<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mNativeProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">loadSystemProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们能看到ThreadedRenderer在初始化，做了三件事情：</p>
<ul>
<li>1.nCreateRootRenderNode 创建native层的RootRenderNode，也就是所有RenderNode的根。类似DecorView的角色，是所有View的父布局，我们把整个View层次看成一个树，那么这里是根节点。</li>
<li>2.RenderNode.adopt  根据native的 RootRenderNode创建Java层的根部RenderNode。</li>
<li>3.nCreateProxy 创建RenderNode的代理者，nSetName给该代理者赋予名字。</li>
<li>4.ProcessInitializer的初始化graphicsstats服务</li>
<li>5.loadSystemProperties 读取系统给硬件渲染器设置的属性。</li>
</ul>
<p>关键是看1-3点中ThreadRenderer都做了什么。</p>
<h4 id="nCreateRootRenderNode"><a href="#nCreateRootRenderNode" class="headerlink" title="nCreateRootRenderNode"></a>nCreateRootRenderNode</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_view_ThreadedRenderer.cpp" target="_blank" rel="noopener">android_view_ThreadedRenderer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jlong <span class="token function">android_view_ThreadedRenderer_createRootRenderNode</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RootRenderNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">RootRenderNode</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    node<span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    node<span class="token operator">-</span><span class="token operator">></span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"RootRenderNode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>jlong<span class="token operator">></span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里是直接实例化一个RootRenderNode对象，并把指针的地址直接返回。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">RootRenderNode</span> <span class="token operator">:</span> <span class="token keyword">public</span> RenderNode<span class="token punctuation">,</span> ErrorHandler <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">explicit</span> <span class="token function">RootRenderNode</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">RenderNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mLooper <span class="token operator">=</span> Looper<span class="token operator">::</span><span class="token function">getForThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetJavaVM</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mVm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到RootRenderNode继承了RenderNode对象，并且保存一个JavaVM也就是我们所说的Java虚拟机对象，一个java进程全局只有一个。同时通过getForThread方法，获取ThreadLocal中的Looper对象。这里实际上拿的就是UI线程的Looper。</p>
<h5 id="native层RenderNode-的实例化"><a href="#native层RenderNode-的实例化" class="headerlink" title="native层RenderNode 的实例化"></a>native层RenderNode 的实例化</h5><pre class="line-numbers language-cpp"><code class="language-cpp">RenderNode<span class="token operator">::</span><span class="token function">RenderNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">mDirtyPropertyFields</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mNeedsDisplayListSync</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mDisplayList</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mStagingDisplayList</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mAnimatorManager</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mParentCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个构造函数有一个mDisplayList十分重要，记住之后会频繁出现。接着来看看RenderNode的头文件：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/RenderNode.h" target="_blank" rel="noopener">RenderNode.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">RenderNode</span> <span class="token operator">:</span> <span class="token keyword">public</span> VirtualLightRefBase <span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">TestUtils</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// allow TestUtils to access syncDisplayList / syncProperties</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">FrameBuilder</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    ANDROID_API <span class="token keyword">void</span> <span class="token function">setStagingDisplayList</span><span class="token punctuation">(</span>DisplayList<span class="token operator">*</span> newData<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">bool</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mValid<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    AnimatorManager<span class="token operator">&amp;</span> <span class="token function">animators</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mAnimatorManager<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">const</span> DisplayList<span class="token operator">*</span> <span class="token function">getDisplayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mDisplayList<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    OffscreenBuffer<span class="token operator">*</span> <span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mLayer<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    OffscreenBuffer<span class="token operator">*</span><span class="token operator">*</span> <span class="token function">getLayerHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>mLayer<span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ugh...</span>
    <span class="token keyword">void</span> <span class="token function">setLayer</span><span class="token punctuation">(</span>OffscreenBuffer<span class="token operator">*</span> layer<span class="token punctuation">)</span> <span class="token punctuation">{</span> mLayer <span class="token operator">=</span> layer<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">private</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    String8 mName<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    uint32_t mDirtyPropertyFields<span class="token punctuation">;</span>
    RenderProperties mProperties<span class="token punctuation">;</span>
    RenderProperties mStagingProperties<span class="token punctuation">;</span>

    <span class="token keyword">bool</span> mValid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    DisplayList<span class="token operator">*</span> mDisplayList<span class="token punctuation">;</span>
    DisplayList<span class="token operator">*</span> mStagingDisplayList<span class="token punctuation">;</span>

    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">AnimatorManager</span><span class="token punctuation">;</span>
    AnimatorManager mAnimatorManager<span class="token punctuation">;</span>

    OffscreenBuffer<span class="token operator">*</span> mLayer <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>RenderNodeOp<span class="token operator">*</span><span class="token operator">></span> mProjectedNodes<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">private</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> <span class="token comment" spellcheck="true">/* namespace uirenderer */</span>
<span class="token punctuation">}</span> <span class="token comment" spellcheck="true">/* namespace android */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上我把几个重要的对象留下来：</p>
<ul>
<li>1.mDisplayList 实际上就是RenderNode中持有的所有的子RenderNode对象</li>
<li>2.mStagingDisplayList 这个一般是一个View遍历完后保存下来的DisplayList，之后会在绘制行为之前转化为mDisplayList</li>
<li>3.RenderProperties mProperties 是指RenderNode的宽高等信息的存储对象</li>
<li>4.OffscreenBuffer mProperties RenderNode真正的渲染内存对象。</li>
</ul>
<h4 id="RenderNode-adopt"><a href="#RenderNode-adopt" class="headerlink" title="RenderNode.adopt"></a>RenderNode.adopt</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/RenderNode.java" target="_blank" rel="noopener">RenderNode.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> RenderNode <span class="token function">adopt</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativePtr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RenderNode</span><span class="token punctuation">(</span>nativePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>能看到很简单，就是包裹一个native层的RenderNode返回一个Java层对应的对象开放Java层的操作API。</p>
<h4 id="nCreateProxy"><a href="#nCreateProxy" class="headerlink" title="nCreateProxy"></a>nCreateProxy</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jlong <span class="token function">android_view_ThreadedRenderer_createProxy</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span>
        jboolean translucent<span class="token punctuation">,</span> jlong rootRenderNodePtr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RootRenderNode<span class="token operator">*</span> rootRenderNode <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RootRenderNode<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>rootRenderNodePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ContextFactoryImpl <span class="token function">factory</span><span class="token punctuation">(</span>rootRenderNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>jlong<span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token function">RenderProxy</span><span class="token punctuation">(</span>translucent<span class="token punctuation">,</span> rootRenderNode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程生成了两个对象：</p>
<ul>
<li>1.ContextFactoryImpl 动画上下文工厂</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">ContextFactoryImpl</span> <span class="token operator">:</span> <span class="token keyword">public</span> IContextFactory <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">explicit</span> <span class="token function">ContextFactoryImpl</span><span class="token punctuation">(</span>RootRenderNode<span class="token operator">*</span> rootNode<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">mRootNode</span><span class="token punctuation">(</span>rootNode<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">virtual</span> AnimationContext<span class="token operator">*</span> <span class="token function">createAnimationContext</span><span class="token punctuation">(</span>renderthread<span class="token operator">::</span>TimeLord<span class="token operator">&amp;</span> clock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">AnimationContextBridge</span><span class="token punctuation">(</span>clock<span class="token punctuation">,</span> mRootNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    RootRenderNode<span class="token operator">*</span> mRootNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个对象实际上让RenderProxy持有一个创建动画上下文的工厂。RenderProxy可以通过ContextFactoryImpl为每一个RenderNode创建一个动画执行对象的上下文AnimationContextBridge。</p>
<ul>
<li>2.RenderProxy 一个 根RenderNode的代理对象。这个代理对象将作为所有绘制开始遍历入口。</li>
</ul>
<h4 id="RenderProxy-根RenderNode的代理对象的创建"><a href="#RenderProxy-根RenderNode的代理对象的创建" class="headerlink" title="RenderProxy 根RenderNode的代理对象的创建"></a>RenderProxy 根RenderNode的代理对象的创建</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/" target="_blank" rel="noopener">renderthread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/RenderProxy.cpp" target="_blank" rel="noopener">RenderProxy.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">RenderProxy<span class="token operator">::</span><span class="token function">RenderProxy</span><span class="token punctuation">(</span><span class="token keyword">bool</span> translucent<span class="token punctuation">,</span> RenderNode<span class="token operator">*</span> rootRenderNode<span class="token punctuation">,</span>
                         IContextFactory<span class="token operator">*</span> contextFactory<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">mRenderThread</span><span class="token punctuation">(</span>RenderThread<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mContext</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mContext <span class="token operator">=</span> mRenderThread<span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runSync</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> CanvasContext<span class="token operator">*</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> CanvasContext<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>mRenderThread<span class="token punctuation">,</span> translucent<span class="token punctuation">,</span> rootRenderNode<span class="token punctuation">,</span> contextFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mDrawFrameTask<span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mRenderThread<span class="token punctuation">,</span> mContext<span class="token punctuation">,</span> rootRenderNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里有几个十分重要的对象被实例化，当然这几个对象在聊TextureView有聊过(<a href="https://www.jianshu.com/p/1dce98846dc7" target="_blank" rel="noopener">SurfaceView和TextureView 源码浅析</a>)：</p>
<ul>
<li>1.RenderThread 硬件渲染线程，所有的硬件渲染命令都需要经过这个线程排队执行。初始化方法如下：<pre class="line-numbers language-cpp"><code class="language-cpp">RenderThread<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>2.CanvasContext 一个硬件Canvas的上下文，一般来说就在这个上下文决定了使用OpenGL es还是其他的渲染管道。初始化方法如下：<pre class="line-numbers language-cpp"><code class="language-cpp">CanvasContext<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>mRenderThread<span class="token punctuation">,</span> translucent<span class="token punctuation">,</span> rootRenderNode<span class="token punctuation">,</span> contextFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>2.DrawFrameTask 每一帧绘制的任务对象。</li>
</ul>
<p>我们依次看看他们初始化都做了什么。</p>
<h3 id="RenderThread的初始化和运行机制"><a href="#RenderThread的初始化和运行机制" class="headerlink" title="RenderThread的初始化和运行机制"></a>RenderThread的初始化和运行机制</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/" target="_blank" rel="noopener">renderthread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/RenderThread.cpp" target="_blank" rel="noopener">RenderThread.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">RenderThread<span class="token operator">&amp;</span> RenderThread<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> RenderThread<span class="token operator">*</span> sInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">RenderThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gHasRenderThreadInstance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span>sInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到其实就是简单的调用RenderThread的构造函数进行实例化，并且返回对象的指针。</p>
<p>RenderThread是一个线程对象。先来看看其头文件继承的对象：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/" target="_blank" rel="noopener">renderthread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/RenderThread.h" target="_blank" rel="noopener">RenderThread.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">RenderThread</span> <span class="token operator">:</span> <span class="token keyword">private</span> ThreadBase <span class="token punctuation">{</span>
    <span class="token function">PREVENT_COPY_AND_ASSIGN</span><span class="token punctuation">(</span>RenderThread<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment" spellcheck="true">// Sets a callback that fires before any RenderThread setup has occured.</span>
    ANDROID_API <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setOnStartHook</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>onStartHook<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    WorkQueue<span class="token operator">&amp;</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> ThreadBase<span class="token operator">::</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中RenderThread的中进行排队处理的任务队列实际上是来自ThreadBase的WorkQueue对象。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/thread/" target="_blank" rel="noopener">thread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/thread/ThreadBase.h" target="_blank" rel="noopener">ThreadBase.h</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ThreadBase</span> <span class="token operator">:</span> <span class="token keyword">protected</span> Thread <span class="token punctuation">{</span>
    <span class="token function">PREVENT_COPY_AND_ASSIGN</span><span class="token punctuation">(</span>ThreadBase<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">ThreadBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">mLooper</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">mQueue</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    WorkQueue<span class="token operator">&amp;</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mQueue<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">requestExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Thread<span class="token operator">:</span><span class="token operator">:</span><span class="token function">requestExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> <span class="token string">"ThreadBase"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Thread<span class="token operator">:</span><span class="token operator">:</span><span class="token function">run</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ThreadBase则是继承于Thread对象。当调用start方法时候其实就是调用Thread的run方法启动线程。</p>
<p>另一个更加关键的对象，就是实例化一个Looper对象到WorkQueue中。而直接实例化Looper实际上就是新建一个Looper。但是这个Looper并没有获取当先线程的Looper，这个Looper做什么的呢？下文就会揭晓。</p>
<p>WorkQueue把一个Looper的方法指针设置到其中，其作用可能是完成了某一件任务后唤醒Looper继续工作。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">RenderThread<span class="token operator">::</span><span class="token function">RenderThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">ThreadBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mVsyncSource</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mVsyncRequested</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mFrameCallbackTaskPending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mRenderState</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mEglManager</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mVkManager</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Properties<span class="token operator">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"RenderThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.先从Properties读取一些全局配置，进行一些如debug的配置。</li>
<li>2.start启动当前的线程</li>
</ul>
<p>而start方法会启动Thread的run方法。而run方法最终会走到threadLoop方法中，至于是怎么走进来的，之后有机会会解剖虚拟机的源码线程篇章进行讲解。</p>
<h4 id="RenderThread-threadLoop"><a href="#RenderThread-threadLoop" class="headerlink" title="RenderThread::threadLoop"></a>RenderThread::threadLoop</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> RenderThread<span class="token operator">::</span><span class="token function">threadLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setpriority</span><span class="token punctuation">(</span>PRIO_PROCESS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PRIORITY_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gOnStartHook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">gOnStartHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">initThreadLocals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">waitForWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">processQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingRegistrationFrameCallbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mFrameCallbackTaskPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">drainDisplayEventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mFrameCallbacks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mPendingRegistrationFrameCallbacks<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                   mPendingRegistrationFrameCallbacks<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPendingRegistrationFrameCallbacks<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">requestVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mFrameCallbackTaskPending <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mVsyncRequested <span class="token operator">&amp;&amp;</span> mFrameCallbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">requestVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在threadloop中关键的步骤有如下四个：</p>
<ul>
<li>1.initThreadLocals 初始化线程本地变量</li>
<li>2.waitForWork 等待RenderThread的渲染工作</li>
<li>3.processQueue 执行保存在WorkQueue的渲染工作</li>
<li>4.mPendingRegistrationFrameCallbacks大于0或者mFrameCallbacks大于0；并且mFrameCallbackTaskPending为false，则会调用requestVsync，打开SF进程的EventThread的阻塞让监听返回。mFrameCallbackTaskPending这个方法代表Vsync信号来了并且执行则mFrameCallbackTaskPending为true。</li>
</ul>
<h5 id="initThreadLocals"><a href="#initThreadLocals" class="headerlink" title="initThreadLocals"></a>initThreadLocals</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderThread<span class="token operator">::</span><span class="token function">initThreadLocals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mDisplayInfo <span class="token operator">=</span> DeviceInfo<span class="token operator">::</span><span class="token function">queryDisplayInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nsecs_t frameIntervalNanos <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>nsecs_t<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1000000000</span> <span class="token operator">/</span> mDisplayInfo<span class="token punctuation">.</span>fps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mTimeLord<span class="token punctuation">.</span><span class="token function">setFrameInterval</span><span class="token punctuation">(</span>frameIntervalNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initializeDisplayEventReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mEglManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">EglManager</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mRenderState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">RenderState</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mVkManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">VulkanManager</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mCacheManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CacheManager</span><span class="token punctuation">(</span>mDisplayInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中创建了几个核心对象：</p>
<ul>
<li>1.EglManager 当使用OpenGL 相关的管道的时候，将会通过EglManager对OpenGL进行上下文等操作。</li>
<li>2.VulkanManager 当使用Vulkan 的渲染管道，将会使用VulkanManager进行操作(Vulkan 是新一代的3d硬件显卡渲染api，比起OpenGL更加轻量化，性能更佳)</li>
<li>3.RenderState 渲染状态，内有OpenGL和Vulkan的管道，需要渲染的Layer等。</li>
</ul>
<p>另一个核心的方法就是initializeDisplayEventReceiver，这个方法为WorkQueue的Looper注册了监听：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderThread<span class="token operator">::</span><span class="token function">initializeDisplayEventReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>mVsyncSource<span class="token punctuation">,</span> <span class="token string">"Initializing a second DisplayEventReceiver?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Properties<span class="token operator">::</span>isolatedProcess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> receiver <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>DisplayEventReceiver<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        status_t status <span class="token operator">=</span> receiver<span class="token operator">-</span><span class="token operator">></span><span class="token function">initCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">addFd</span><span class="token punctuation">(</span>receiver<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Looper<span class="token operator">::</span>EVENT_INPUT<span class="token punctuation">,</span>
                RenderThread<span class="token operator">::</span>displayEventReceiverCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mVsyncSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">DisplayEventReceiverWrapper</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mVsyncSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">DummyVsyncSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个Looper中注册了对DisplayEventReceiver的监听，也就是Vsync信号的监听，回调方法为displayEventReceiverCallback。</p>
<p>我们暂时先对RenderThread的initializeDisplayEventReceiver方法探索到这里，我们稍后继续看看回调后的逻辑。</p>
<h5 id="waitForWork-对Looper监听的对象进行阻塞等待"><a href="#waitForWork-对Looper监听的对象进行阻塞等待" class="headerlink" title="waitForWork 对Looper监听的对象进行阻塞等待"></a>waitForWork 对Looper监听的对象进行阻塞等待</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/thread/" target="_blank" rel="noopener">thread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/thread/ThreadBase.h" target="_blank" rel="noopener">ThreadBase.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">void</span> <span class="token function">waitForWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nsecs_t nextWakeup<span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>unique_lock lock<span class="token punctuation">{</span>mLock<span class="token punctuation">}</span><span class="token punctuation">;</span>
            nextWakeup <span class="token operator">=</span> mQueue<span class="token punctuation">.</span><span class="token function">nextWakeup</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextWakeup <span class="token operator">&lt;</span> std<span class="token operator">::</span>numeric_limits<span class="token operator">&lt;</span>nsecs_t<span class="token operator">></span><span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timeout <span class="token operator">=</span> <span class="token function">ns2ms</span><span class="token punctuation">(</span>nextWakeup <span class="token operator">-</span> WorkQueue<span class="token operator">::</span>clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">pollOnce</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里的逻辑很简单实际上就是调用Looper的pollOnce方法，阻塞Looper中的循环，直到Vsync的信号到来才会继续往下执行。详细的可以阅读我写的<a href="https://www.jianshu.com/p/416de2a3a1d6" target="_blank" rel="noopener">Handler与相关系统调用的剖析</a>系列文章。</p>
<h5 id="processQueue"><a href="#processQueue" class="headerlink" title="processQueue"></a>processQueue</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/thread/" target="_blank" rel="noopener">thread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/thread/ThreadBase.h" target="_blank" rel="noopener">ThreadBase.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">processQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> mQueue<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>实际上调用的是WorkQueue的process方法。</p>
<h6 id="WorkQueue的process"><a href="#WorkQueue的process" class="headerlink" title="WorkQueue的process"></a>WorkQueue的process</h6><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/thread/" target="_blank" rel="noopener">thread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/thread/WorkQueue.h" target="_blank" rel="noopener">WorkQueue.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> now <span class="token operator">=</span> clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>WorkItem<span class="token operator">></span> toProcess<span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>unique_lock _lock<span class="token punctuation">{</span>mLock<span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mWorkQueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            toProcess <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>mWorkQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> moveBack <span class="token operator">=</span> <span class="token function">find_if</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">begin</span><span class="token punctuation">(</span>toProcess<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">end</span><span class="token punctuation">(</span>toProcess<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token punctuation">[</span><span class="token operator">&amp;</span>now<span class="token punctuation">]</span><span class="token punctuation">(</span>WorkItem<span class="token operator">&amp;</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> item<span class="token punctuation">.</span>runAt <span class="token operator">></span> now<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>moveBack <span class="token operator">!=</span> std<span class="token operator">::</span><span class="token function">end</span><span class="token punctuation">(</span>toProcess<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mWorkQueue<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">distance</span><span class="token punctuation">(</span>moveBack<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">end</span><span class="token punctuation">(</span>toProcess<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>moveBack<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">end</span><span class="token punctuation">(</span>toProcess<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">back_inserter</span><span class="token punctuation">(</span>mWorkQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                toProcess<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>moveBack<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">end</span><span class="token punctuation">(</span>toProcess<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> item <span class="token operator">:</span> toProcess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span><span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程中很简单，几乎和Message的loop的逻辑一致。如果Looper的阻塞打开了，则首先找到预计执行时间比当前时刻都大的WorkItem。并且从mWorkQueue移除，最后添加到toProcess中，并且执行每一个WorkItem的work方法。而每一个WorkItem其实就是通过从某一个压入方法添加到mWorkQueue中。</p>
<p>到这里，我们就明白了RenderThread中是如何消费渲染任务的。那么这些渲染任务又是哪里诞生呢？</p>
<h4 id="RenderThread-相应Vsync信号的回调"><a href="#RenderThread-相应Vsync信号的回调" class="headerlink" title="RenderThread 相应Vsync信号的回调"></a>RenderThread 相应Vsync信号的回调</h4><p>上文聊到了在RenderThread中的Looper会监听Vsync信号，当信号回调后将会执行下面的回调。</p>
<h4 id="displayEventReceiverCallback"><a href="#displayEventReceiverCallback" class="headerlink" title="displayEventReceiverCallback"></a>displayEventReceiverCallback</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> RenderThread<span class="token operator">::</span><span class="token function">displayEventReceiverCallback</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>events <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Looper<span class="token operator">::</span>EVENT_ERROR <span class="token operator">|</span> Looper<span class="token operator">::</span>EVENT_HANGUP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// remove the callback</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>events <span class="token operator">&amp;</span> Looper<span class="token operator">::</span>EVENT_INPUT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// keep the callback</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RenderThread<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">drainDisplayEventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// keep the callback</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个方法的核心实际上就是调用drainDisplayEventQueue方法，对ui渲染任务队列进行处理。</p>
<h6 id="RenderThread-drainDisplayEventQueue"><a href="#RenderThread-drainDisplayEventQueue" class="headerlink" title="RenderThread::drainDisplayEventQueue"></a>RenderThread::drainDisplayEventQueue</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderThread<span class="token operator">::</span><span class="token function">drainDisplayEventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nsecs_t vsyncEvent <span class="token operator">=</span> mVsyncSource<span class="token operator">-</span><span class="token operator">></span><span class="token function">latestVsyncEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vsyncEvent <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mVsyncRequested <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTimeLord<span class="token punctuation">.</span><span class="token function">vsyncReceived</span><span class="token punctuation">(</span>vsyncEvent<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mFrameCallbackTaskPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mFrameCallbackTaskPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            nsecs_t runAt <span class="token operator">=</span> <span class="token punctuation">(</span>vsyncEvent <span class="token operator">+</span> DISPATCH_FRAME_CALLBACKS_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postAt</span><span class="token punctuation">(</span>runAt<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">dispatchFrameCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能到在这里mVsyncRequested设置为false，且mFrameCallbackTaskPending将会设置为true，并且调用queue的postAt的方法执行ui渲染方法。</p>
<p>还记得queue实际是是指WorkQueue，而WorkQueue的postAt方法实际实现如下：<br>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/thread/" target="_blank" rel="noopener">thread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/thread/WorkQueue.h" target="_blank" rel="noopener">WorkQueue.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">F</span><span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">postAt</span><span class="token punctuation">(</span>nsecs_t time<span class="token punctuation">,</span> F<span class="token operator">&amp;&amp;</span> func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enqueue</span><span class="token punctuation">(</span>WorkItem<span class="token punctuation">{</span>time<span class="token punctuation">,</span> std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span>std<span class="token operator">::</span>forward<span class="token operator">&lt;</span>F<span class="token operator">></span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>WorkItem<span class="token operator">&amp;&amp;</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">bool</span> needsWakeup<span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>unique_lock _lock<span class="token punctuation">{</span>mLock<span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> insertAt <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">find_if</span><span class="token punctuation">(</span>
                    std<span class="token operator">::</span><span class="token function">begin</span><span class="token punctuation">(</span>mWorkQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">end</span><span class="token punctuation">(</span>mWorkQueue<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span>time <span class="token operator">=</span> item<span class="token punctuation">.</span>runAt<span class="token punctuation">]</span><span class="token punctuation">(</span>WorkItem <span class="token operator">&amp;</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> item<span class="token punctuation">.</span>runAt <span class="token operator">></span> time<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            needsWakeup <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">begin</span><span class="token punctuation">(</span>mWorkQueue<span class="token punctuation">)</span> <span class="token operator">==</span> insertAt<span class="token punctuation">;</span>
            mWorkQueue<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>insertAt<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>needsWakeup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">mWakeFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>情景带入，当一个Vsync信号达到Looper的监听者，此时就会通过WorkQueue的drainDisplayEventQueue 压入一个任务到队列中。</p>
<p>每一个默认的任务都是执行dispatchFrameCallback方法。这里的判断mWorkQueue中是否存在比当前时间更迟的时刻，并返回这个WorkItem。如果这个对象在头部needsWakeup为true，说明可以进行唤醒了。而mWakeFunc这个方法指针就是上面传下来：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>把阻塞的Looper唤醒。当唤醒后就继续执行WorkQueue的process方法。也就是执行dispatchFrameCallbacks方法。</p>
<h5 id="RenderThread-dispatchFrameCallbacks"><a href="#RenderThread-dispatchFrameCallbacks" class="headerlink" title="RenderThread dispatchFrameCallbacks"></a>RenderThread dispatchFrameCallbacks</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderThread<span class="token operator">::</span><span class="token function">dispatchFrameCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mFrameCallbackTaskPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    std<span class="token operator">::</span>set<span class="token operator">&lt;</span>IFrameCallback<span class="token operator">*</span><span class="token operator">></span> callbacks<span class="token punctuation">;</span>
    mFrameCallbacks<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">requestVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token operator">::</span>set<span class="token operator">&lt;</span>IFrameCallback<span class="token operator">*</span><span class="token operator">></span><span class="token operator">::</span>iterator it <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> callbacks<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">doFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里执行了两个事情：</p>
<ul>
<li>1.requestVsync 打开EventThread的监听阻塞。</li>
<li>2.处理IFrameCallback的doFrame方法。而每一个IFrameCallback是通过如下方式添加进来的：<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderThread<span class="token operator">::</span><span class="token function">pushBackFrameCallback</span><span class="token punctuation">(</span>IFrameCallback<span class="token operator">*</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mFrameCallbacks<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mPendingRegistrationFrameCallbacks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
先添加到mPendingRegistrationFrameCallbacks集合中，在上面提到过的threadLoop中，会执行如下逻辑：<pre class="line-numbers language-cpp"><code class="language-cpp">      <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingRegistrationFrameCallbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mFrameCallbackTaskPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">drainDisplayEventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          mFrameCallbacks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mPendingRegistrationFrameCallbacks<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 mPendingRegistrationFrameCallbacks<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          mPendingRegistrationFrameCallbacks<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">requestVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
如果mPendingRegistrationFrameCallbacks大小不为0，则的把mPendingRegistrationFrameCallbacks中的IFrameCallback全部迁移到mFrameCallbacks中。</li>
</ul>
<p>而这个方法什么时候调用呢？稍后就会介绍。其实这部分的逻辑在TextureView的解析中提到过。</p>
<h4 id="CanvasContext的初始化"><a href="#CanvasContext的初始化" class="headerlink" title="CanvasContext的初始化"></a>CanvasContext的初始化</h4><p>接下来将会初始化一个重要对象：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">CanvasContext<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>mRenderThread<span class="token punctuation">,</span> translucent<span class="token punctuation">,</span> rootRenderNode<span class="token punctuation">,</span> contextFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个对象名字叫做画布的上下文，具体是什么上下文呢？我们现在就来看看其实例化方法。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/" target="_blank" rel="noopener">renderthread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/CanvasContext.cpp" target="_blank" rel="noopener">CanvasContext.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">CanvasContext<span class="token operator">*</span> CanvasContext<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>RenderThread<span class="token operator">&amp;</span> thread<span class="token punctuation">,</span> <span class="token keyword">bool</span> translucent<span class="token punctuation">,</span>
                                     RenderNode<span class="token operator">*</span> rootRenderNode<span class="token punctuation">,</span> IContextFactory<span class="token operator">*</span> contextFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> renderType <span class="token operator">=</span> Properties<span class="token operator">::</span><span class="token function">getRenderPipelineType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>renderType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> RenderPipelineType<span class="token operator">::</span>OpenGL<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">CanvasContext</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> translucent<span class="token punctuation">,</span> rootRenderNode<span class="token punctuation">,</span> contextFactory<span class="token punctuation">,</span>
                                     std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>OpenGLPipeline<span class="token operator">></span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> RenderPipelineType<span class="token operator">::</span>SkiaGL<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">CanvasContext</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> translucent<span class="token punctuation">,</span> rootRenderNode<span class="token punctuation">,</span> contextFactory<span class="token punctuation">,</span>
                                     std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>skiapipeline<span class="token operator">::</span>SkiaOpenGLPipeline<span class="token operator">></span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> RenderPipelineType<span class="token operator">::</span>SkiaVulkan<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">CanvasContext</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> translucent<span class="token punctuation">,</span> rootRenderNode<span class="token punctuation">,</span> contextFactory<span class="token punctuation">,</span>
                                     std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>skiapipeline<span class="token operator">::</span>SkiaVulkanPipeline<span class="token operator">></span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/device/" target="_blank" rel="noopener">device</a>/<a href="http://androidxref.com/9.0.0_r3/xref/device/generic/" target="_blank" rel="noopener">generic</a>/<a href="http://androidxref.com/9.0.0_r3/xref/device/generic/goldfish/" target="_blank" rel="noopener">goldfish</a>/<a href="http://androidxref.com/9.0.0_r3/xref/device/generic/goldfish/init.ranchu.rc" target="_blank" rel="noopener">init.ranchu.rc</a></p>
<pre><code>on boot
    setprop debug.hwui.renderer opengl</code></pre><p>在init.rc中默认是opengl，那么我们就来看看下面的逻辑：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">        <span class="token keyword">case</span> RenderPipelineType<span class="token operator">::</span>OpenGL<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">CanvasContext</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> translucent<span class="token punctuation">,</span> rootRenderNode<span class="token punctuation">,</span> contextFactory<span class="token punctuation">,</span>
                                     std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>OpenGLPipeline<span class="token operator">></span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>首先实例化一个OpenGLPipeline管道，接着OpenGLPipeline作为参数实例化CanvasContext。</p>
<h4 id="OpenGLPipeline实例化"><a href="#OpenGLPipeline实例化" class="headerlink" title="OpenGLPipeline实例化"></a>OpenGLPipeline实例化</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/" target="_blank" rel="noopener">renderthread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/OpenGLPipeline.cpp" target="_blank" rel="noopener">OpenGLPipeline.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">OpenGLPipeline<span class="token operator">::</span><span class="token function">OpenGLPipeline</span><span class="token punctuation">(</span>RenderThread<span class="token operator">&amp;</span> thread<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">mEglManager</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">eglManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mRenderThread</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>能看到在OpenGLPipeline中，实际上就是存储了RenderThread对象，以及RenderThread中的mEglManager。透过OpenGLPipeline来控制mEglManager进而进一步操作OpenGL。</p>
<h4 id="CanvasContext实例化"><a href="#CanvasContext实例化" class="headerlink" title="CanvasContext实例化"></a>CanvasContext实例化</h4><pre><code>CanvasContext::CanvasContext(RenderThread&amp; thread, bool translucent, RenderNode* rootRenderNode,
                             IContextFactory* contextFactory,
                             std::unique_ptr&lt;IRenderPipeline&gt; renderPipeline)
        : mRenderThread(thread)
        , mGenerationID(0)
        , mOpaque(!translucent)
        , mAnimationContext(contextFactory-&gt;createAnimationContext(mRenderThread.timeLord()))
        , mJankTracker(&amp;thread.globalProfileData(), thread.mainDisplayInfo())
        , mProfiler(mJankTracker.frames())
        , mContentDrawBounds(0, 0, 0, 0)
        , mRenderPipeline(std::move(renderPipeline)) {
    rootRenderNode-&gt;makeRoot();
    mRenderNodes.emplace_back(rootRenderNode);
    mRenderThread.renderState().registerCanvasContext(this);
    mProfiler.setDensity(mRenderThread.mainDisplayInfo().density);
}</code></pre><p>做了如下操作：</p>
<ul>
<li><p>1.RenderNode的makeRoot方法，添加RenderNode的引用计数</p>
</li>
<li><p>2.mRenderNodes的集合收集rootRenderNode对象，注意在这里带了一个很核心的逻辑，把rootRenderNode根RenderNode添加到mRenderNodes集合中，之后就可以从mRenderNodes找到根部的RenderNode。</p>
</li>
<li><p>3.获取RenderThread的renderState对象调用registerCanvasContext方法保存CanvasContext到mRegisteredContexts中。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderstate/" target="_blank" rel="noopener">renderstate</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderstate/RenderState.cpp" target="_blank" rel="noopener">RenderState.cpp</a></p>
</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">void</span> <span class="token function">registerCanvasContext</span><span class="token punctuation">(</span>renderthread<span class="token operator">::</span>CanvasContext<span class="token operator">*</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mRegisteredContexts<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="mDrawFrameTask-初始化"><a href="#mDrawFrameTask-初始化" class="headerlink" title="mDrawFrameTask 初始化"></a>mDrawFrameTask 初始化</h4><pre class="line-numbers language-cpp"><code class="language-cpp"> mDrawFrameTask<span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mRenderThread<span class="token punctuation">,</span> mContext<span class="token punctuation">,</span> rootRenderNode<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/" target="_blank" rel="noopener">renderthread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/DrawFrameTask.cpp" target="_blank" rel="noopener">DrawFrameTask.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> DrawFrameTask<span class="token operator">::</span><span class="token function">setContext</span><span class="token punctuation">(</span>RenderThread<span class="token operator">*</span> thread<span class="token punctuation">,</span> CanvasContext<span class="token operator">*</span> context<span class="token punctuation">,</span>
                               RenderNode<span class="token operator">*</span> targetNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mRenderThread <span class="token operator">=</span> thread<span class="token punctuation">;</span>
    mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
    mTargetNode <span class="token operator">=</span> targetNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就是保存这三对象RenderThread；CanvasContext；RenderNode。</p>
<h3 id="ThreadedRenderer-nSetName"><a href="#ThreadedRenderer-nSetName" class="headerlink" title="ThreadedRenderer nSetName"></a>ThreadedRenderer nSetName</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_view_ThreadedRenderer.cpp" target="_blank" rel="noopener">android_view_ThreadedRenderer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_view_ThreadedRenderer_setName</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span>
        jlong proxyPtr<span class="token punctuation">,</span> jstring jname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RenderProxy<span class="token operator">*</span> proxy <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RenderProxy<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>proxyPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>jname<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxy<span class="token operator">-</span><span class="token operator">></span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token operator">-</span><span class="token operator">></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>jname<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上就是调用RenderProxy的setName方法给当前硬件渲染对象设置名字。</p>
<p> 文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/" target="_blank" rel="noopener">renderthread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/RenderProxy.cpp" target="_blank" rel="noopener">RenderProxy.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderProxy<span class="token operator">::</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mRenderThread<span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runSync</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> mContext<span class="token operator">-</span><span class="token operator">></span><span class="token function">setName</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>能看到在setName方法中，实际上就是调用RenderThread的WorkQueue，把一个任务队列设置进去，并且调用runSync执行。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">F</span><span class="token operator">></span>
    <span class="token keyword">auto</span> <span class="token function">runSync</span><span class="token punctuation">(</span>F<span class="token operator">&amp;&amp;</span> func<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token operator">::</span>packaged_task<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> task<span class="token punctuation">{</span>std<span class="token operator">::</span>forward<span class="token operator">&lt;</span>F<span class="token operator">></span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>task<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token operator">::</span><span class="token function">invoke</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> task<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个方法实际上也是调用post执行排队执行任务，不同的是，这里使用了线程的Future方式，阻塞了执行，等待CanvasContext的setName工作完毕。</p>
<h2 id="ThreadedRenderer-初始化"><a href="#ThreadedRenderer-初始化" class="headerlink" title="ThreadedRenderer 初始化"></a>ThreadedRenderer 初始化</h2><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">initialize</span><span class="token punctuation">(</span>Surface surface<span class="token punctuation">)</span> <span class="token keyword">throws</span> OutOfResourcesException <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> status <span class="token operator">=</span> <span class="token operator">!</span>mInitialized<span class="token punctuation">;</span>
        mInitialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">updateEnabledState</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">nInitialize</span><span class="token punctuation">(</span>mNativeProxy<span class="token punctuation">,</span> surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心是调用nInitialize的方法，把Surface方法传递到threadedRenderer中。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_view_ThreadedRenderer.cpp" target="_blank" rel="noopener">android_view_ThreadedRenderer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_view_ThreadedRenderer_initialize</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span>
        jlong proxyPtr<span class="token punctuation">,</span> jobject jsurface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RenderProxy<span class="token operator">*</span> proxy <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RenderProxy<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>proxyPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>Surface<span class="token operator">></span> surface <span class="token operator">=</span> <span class="token function">android_view_Surface_getSurface</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jsurface<span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxy<span class="token operator">-</span><span class="token operator">></span><span class="token function">initialize</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里里面的核心也很简单，拿到RenderProxy对象，把native层的Surface对象作为参数调用initialize方法。关于Surface对象详解可以阅读。<a href="https://www.jianshu.com/p/3bfc0053d254" target="_blank" rel="noopener">GraphicBuffer的诞生</a>。</p>
<h3 id="RenderProxy-initialize"><a href="#RenderProxy-initialize" class="headerlink" title="RenderProxy initialize"></a>RenderProxy initialize</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderProxy<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Surface<span class="token operator">></span><span class="token operator">&amp;</span> surface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mRenderThread<span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span> <span class="token keyword">this</span><span class="token punctuation">,</span> surf <span class="token operator">=</span> surface <span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">mutable</span> <span class="token punctuation">{</span> mContext<span class="token operator">-</span><span class="token operator">></span><span class="token function">setSurface</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>surf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="CanvasContext-setSurface"><a href="#CanvasContext-setSurface" class="headerlink" title="CanvasContext setSurface"></a>CanvasContext setSurface</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CanvasContext<span class="token operator">::</span><span class="token function">setSurface</span><span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>Surface<span class="token operator">></span><span class="token operator">&amp;&amp;</span> surface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mNativeSurface <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ColorMode colorMode <span class="token operator">=</span> mWideColorGamut <span class="token operator">?</span> ColorMode<span class="token operator">::</span>WideColorGamut <span class="token operator">:</span> ColorMode<span class="token operator">::</span>Srgb<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> hasSurface <span class="token operator">=</span> mRenderPipeline<span class="token operator">-</span><span class="token operator">></span><span class="token function">setSurface</span><span class="token punctuation">(</span>mNativeSurface<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mSwapBehavior<span class="token punctuation">,</span> colorMode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mFrameNumber <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasSurface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mHaveNewSurface <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        mSwapHistory<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mRenderThread<span class="token punctuation">.</span><span class="token function">removeFrameCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mGenerationID<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上这里的逻辑很简单，就是给渲染管道(当前OpenGLPipeline)方法调用setSurface。如果设置成功mSwapHistory则清空。如果失败说明mNativeSurface为空或者无效，则调用removeFrameCallback移除会调用，也就是上面说过的IFrameCallback。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/" target="_blank" rel="noopener">renderthread</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/renderthread/OpenGLPipeline.cpp" target="_blank" rel="noopener">OpenGLPipeline.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> OpenGLPipeline<span class="token operator">::</span><span class="token function">setSurface</span><span class="token punctuation">(</span>Surface<span class="token operator">*</span> surface<span class="token punctuation">,</span> SwapBehavior swapBehavior<span class="token punctuation">,</span> ColorMode colorMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mEglSurface <span class="token operator">!=</span> EGL_NO_SURFACE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mEglManager<span class="token punctuation">.</span><span class="token function">destroySurface</span><span class="token punctuation">(</span>mEglSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mEglSurface <span class="token operator">=</span> EGL_NO_SURFACE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>surface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">bool</span> wideColorGamut <span class="token operator">=</span> colorMode <span class="token operator">==</span> ColorMode<span class="token operator">::</span>WideColorGamut<span class="token punctuation">;</span>
        mEglSurface <span class="token operator">=</span> mEglManager<span class="token punctuation">.</span><span class="token function">createSurface</span><span class="token punctuation">(</span>surface<span class="token punctuation">,</span> wideColorGamut<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mEglSurface <span class="token operator">!=</span> EGL_NO_SURFACE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">bool</span> preserveBuffer <span class="token operator">=</span> <span class="token punctuation">(</span>swapBehavior <span class="token operator">!=</span> SwapBehavior<span class="token operator">::</span>kSwap_discardBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBufferPreserved <span class="token operator">=</span> mEglManager<span class="token punctuation">.</span><span class="token function">setPreserveBuffer</span><span class="token punctuation">(</span>mEglSurface<span class="token punctuation">,</span> preserveBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面的逻辑很简单，走的就是OpenGL的初始化的流程，如果surface不为空，则调用mEglManager为Surface， 从Surface中创建一个opengl es的surface。详情可以阅读我写的<a href="https://www.jianshu.com/p/03c40afab7a5" target="_blank" rel="noopener">渲染图层-OpenGL es上的封装(上)</a>。</p>
<h4 id="ThreadedRenderer-updateSurface-更新Surface"><a href="#ThreadedRenderer-updateSurface-更新Surface" class="headerlink" title="ThreadedRenderer updateSurface  更新Surface"></a>ThreadedRenderer updateSurface  更新Surface</h4><p>当Surface在Java层发生了变化，则需要进行updateSurface方法，告诉硬件渲染线程更新Surface方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">updateSurface</span><span class="token punctuation">(</span>Surface surface<span class="token punctuation">)</span> <span class="token keyword">throws</span> OutOfResourcesException <span class="token punctuation">{</span>
        <span class="token function">updateEnabledState</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">nUpdateSurface</span><span class="token punctuation">(</span>mNativeProxy<span class="token punctuation">,</span> surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上还是调用RenderProxy的updateSurface方法。而这个方法还是调用CanvasContext的setSurface方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderProxy<span class="token operator">::</span><span class="token function">updateSurface</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Surface<span class="token operator">></span><span class="token operator">&amp;</span> surface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mRenderThread<span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span> <span class="token keyword">this</span><span class="token punctuation">,</span> surf <span class="token operator">=</span> surface <span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">mutable</span> <span class="token punctuation">{</span> mContext<span class="token operator">-</span><span class="token operator">></span><span class="token function">setSurface</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>surf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ThreadedRenderer-setup启动硬件渲染，初始化参数"><a href="#ThreadedRenderer-setup启动硬件渲染，初始化参数" class="headerlink" title="ThreadedRenderer setup启动硬件渲染，初始化参数"></a>ThreadedRenderer setup启动硬件渲染，初始化参数</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> AttachInfo attachInfo<span class="token punctuation">,</span> Rect surfaceInsets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mWidth <span class="token operator">=</span> width<span class="token punctuation">;</span>
        mHeight <span class="token operator">=</span> height<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>surfaceInsets <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>surfaceInsets<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> surfaceInsets<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token number">0</span>
                <span class="token operator">||</span> surfaceInsets<span class="token punctuation">.</span>top <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> surfaceInsets<span class="token punctuation">.</span>bottom <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mHasInsets <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mInsetLeft <span class="token operator">=</span> surfaceInsets<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
            mInsetTop <span class="token operator">=</span> surfaceInsets<span class="token punctuation">.</span>top<span class="token punctuation">;</span>
            mSurfaceWidth <span class="token operator">=</span> width <span class="token operator">+</span> mInsetLeft <span class="token operator">+</span> surfaceInsets<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
            mSurfaceHeight <span class="token operator">=</span> height <span class="token operator">+</span> mInsetTop <span class="token operator">+</span> surfaceInsets<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
            <span class="token function">setOpaque</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mHasInsets <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mInsetLeft <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            mInsetTop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            mSurfaceWidth <span class="token operator">=</span> width<span class="token punctuation">;</span>
            mSurfaceHeight <span class="token operator">=</span> height<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mRootNode<span class="token punctuation">.</span><span class="token function">setLeftTopRightBottom</span><span class="token punctuation">(</span><span class="token operator">-</span>mInsetLeft<span class="token punctuation">,</span> <span class="token operator">-</span>mInsetTop<span class="token punctuation">,</span> mSurfaceWidth<span class="token punctuation">,</span> mSurfaceHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">nSetup</span><span class="token punctuation">(</span>mNativeProxy<span class="token punctuation">,</span> mLightRadius<span class="token punctuation">,</span>
                mAmbientShadowAlpha<span class="token punctuation">,</span> mSpotShadowAlpha<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setLightCenter</span><span class="token punctuation">(</span>attachInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.调用RootNode的setLeftTopRightBottom更新根部节点的上下左右的参数。</li>
<li>2.nSetup 进行ThreadedRenderer进行装载。</li>
</ul>
<h4 id="RootNode-setLeftTopRightBottom"><a href="#RootNode-setLeftTopRightBottom" class="headerlink" title="RootNode setLeftTopRightBottom"></a>RootNode setLeftTopRightBottom</h4><p>RootNode.setLeftTopRightBottom方法实际上调用的是如下方法：<br>文件：<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_view_RenderNode.cpp" target="_blank" rel="noopener">android_view_RenderNode.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jboolean <span class="token function">android_view_RenderNode_setLeftTopRightBottom</span><span class="token punctuation">(</span>jlong renderNodePtr<span class="token punctuation">,</span>
        <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RenderNode<span class="token operator">*</span> renderNode <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RenderNode<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>renderNodePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">mutateStagingProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLeftTopRightBottom</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        renderNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">setPropertyFieldsDirty</span><span class="token punctuation">(</span>RenderNode<span class="token operator">::</span>X <span class="token operator">|</span> RenderNode<span class="token operator">::</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.setLeftTopRightBottom 是RenderNode的RenderNode参数对象RenderProperties设置上下左右的方法。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/RenderProperties.cpp" target="_blank" rel="noopener">RenderProperties.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">  <span class="token keyword">bool</span> <span class="token function">setLeftTopRightBottom</span><span class="token punctuation">(</span><span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">!=</span> mPrimitiveFields<span class="token punctuation">.</span>mLeft <span class="token operator">||</span> top <span class="token operator">!=</span> mPrimitiveFields<span class="token punctuation">.</span>mTop <span class="token operator">||</span>
          right <span class="token operator">!=</span> mPrimitiveFields<span class="token punctuation">.</span>mRight <span class="token operator">||</span> bottom <span class="token operator">!=</span> mPrimitiveFields<span class="token punctuation">.</span>mBottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          mPrimitiveFields<span class="token punctuation">.</span>mLeft <span class="token operator">=</span> left<span class="token punctuation">;</span>
          mPrimitiveFields<span class="token punctuation">.</span>mTop <span class="token operator">=</span> top<span class="token punctuation">;</span>
          mPrimitiveFields<span class="token punctuation">.</span>mRight <span class="token operator">=</span> right<span class="token punctuation">;</span>
          mPrimitiveFields<span class="token punctuation">.</span>mBottom <span class="token operator">=</span> bottom<span class="token punctuation">;</span>
          mPrimitiveFields<span class="token punctuation">.</span>mWidth <span class="token operator">=</span> mPrimitiveFields<span class="token punctuation">.</span>mRight <span class="token operator">-</span> mPrimitiveFields<span class="token punctuation">.</span>mLeft<span class="token punctuation">;</span>
          mPrimitiveFields<span class="token punctuation">.</span>mHeight <span class="token operator">=</span> mPrimitiveFields<span class="token punctuation">.</span>mBottom <span class="token operator">-</span> mPrimitiveFields<span class="token punctuation">.</span>mTop<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPrimitiveFields<span class="token punctuation">.</span>mPivotExplicitlySet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              mPrimitiveFields<span class="token punctuation">.</span>mMatrixOrPivotDirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上就是给mPrimitiveFields中的参数给设置上。</p>
</li>
<li><p>2.setPropertyFieldsDirty 告诉当前的RenderNode已经改变了。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">setPropertyFieldsDirty</span><span class="token punctuation">(</span>uint32_t fields<span class="token punctuation">)</span> <span class="token punctuation">{</span> mDirtyPropertyFields <span class="token operator">|</span><span class="token operator">=</span> fields<span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h4 id="native中ThreadedRenderer-setup"><a href="#native中ThreadedRenderer-setup" class="headerlink" title="native中ThreadedRenderer setup"></a>native中ThreadedRenderer setup</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_view_ThreadedRenderer_setup</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span> jlong proxyPtr<span class="token punctuation">,</span>
        jfloat lightRadius<span class="token punctuation">,</span> jint ambientShadowAlpha<span class="token punctuation">,</span> jint spotShadowAlpha<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RenderProxy<span class="token operator">*</span> proxy <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RenderProxy<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>proxyPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxy<span class="token operator">-</span><span class="token operator">></span><span class="token function">setup</span><span class="token punctuation">(</span>lightRadius<span class="token punctuation">,</span> ambientShadowAlpha<span class="token punctuation">,</span> spotShadowAlpha<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>本质上还是调用RenderProxy的setup方法。</p>
<h5 id="RenderProxy-setup"><a href="#RenderProxy-setup" class="headerlink" title="RenderProxy setup"></a>RenderProxy setup</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderProxy<span class="token operator">::</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">float</span> lightRadius<span class="token punctuation">,</span> uint8_t ambientShadowAlpha<span class="token punctuation">,</span> uint8_t spotShadowAlpha<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mRenderThread<span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> mContext<span class="token operator">-</span><span class="token operator">></span><span class="token function">setup</span><span class="token punctuation">(</span>lightRadius<span class="token punctuation">,</span> ambientShadowAlpha<span class="token punctuation">,</span> spotShadowAlpha<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上调用CanvasContext的setup。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CanvasContext<span class="token operator">::</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">float</span> lightRadius<span class="token punctuation">,</span> uint8_t ambientShadowAlpha<span class="token punctuation">,</span> uint8_t spotShadowAlpha<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mLightGeometry<span class="token punctuation">.</span>radius <span class="token operator">=</span> lightRadius<span class="token punctuation">;</span>
    mLightInfo<span class="token punctuation">.</span>ambientShadowAlpha <span class="token operator">=</span> ambientShadowAlpha<span class="token punctuation">;</span>
    mLightInfo<span class="token punctuation">.</span>spotShadowAlpha <span class="token operator">=</span> spotShadowAlpha<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程中就是设置好一些亮度，阴影的参数。</p>
<h3 id="ThreadedRenderer-invalidateRoot打开标志位"><a href="#ThreadedRenderer-invalidateRoot打开标志位" class="headerlink" title="ThreadedRenderer invalidateRoot打开标志位"></a>ThreadedRenderer invalidateRoot打开标志位</h3><p>首先ViewRootImpl的draw方法时候，会判断invalidateRoot是否需要调用：</p>
<pre class="line-numbers language-java"><code class="language-java">                <span class="token keyword">if</span> <span class="token punctuation">(</span>invalidateRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">invalidateRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">invalidateRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mRootNodeNeedsUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上就是很简单的，mRootNodeNeedsUpdate标志位设置为true。而invalidateRoot判断的标准是整个View tree位移是否发生了变化。整个是指整个View树的整体位移。<br>每一个View的onMeasure，onLayout，onDraw三个流程中，判断是否是软件渲染还是硬件渲染，进而判断是否调用RenderNode中的操作，还是调用Skia中的Canvas操作。</p>
<h2 id="ThreadedRenderer-draw-开始硬件渲染绘制"><a href="#ThreadedRenderer-draw-开始硬件渲染绘制" class="headerlink" title="ThreadedRenderer draw 开始硬件渲染绘制"></a>ThreadedRenderer draw 开始硬件渲染绘制</h2><p>调用时机在ViewRootImpl的draw方法：</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">final</span> FrameDrawingCallback callback <span class="token operator">=</span> mNextRtFrameCallback<span class="token punctuation">;</span>
                mNextRtFrameCallback <span class="token operator">=</span> null<span class="token punctuation">;</span>
                mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>mView<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>详细的解析可以阅读我写的<a href="https://www.jianshu.com/p/a4fb6a02ad53" target="_blank" rel="noopener">View的绘制流程(三) onDraw</a>。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">draw</span><span class="token punctuation">(</span>View view<span class="token punctuation">,</span> AttachInfo attachInfo<span class="token punctuation">,</span> DrawCallbacks callbacks<span class="token punctuation">,</span>
            FrameDrawingCallback frameDrawingCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        attachInfo<span class="token punctuation">.</span>mIgnoreDirtyState <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> Choreographer choreographer <span class="token operator">=</span> attachInfo<span class="token punctuation">.</span>mViewRootImpl<span class="token punctuation">.</span>mChoreographer<span class="token punctuation">;</span>
        choreographer<span class="token punctuation">.</span>mFrameInfo<span class="token punctuation">.</span><span class="token function">markDrawStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">updateRootDisplayList</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>

        attachInfo<span class="token punctuation">.</span>mIgnoreDirtyState <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>attachInfo<span class="token punctuation">.</span>mPendingAnimatingRenderNodes <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> count <span class="token operator">=</span> attachInfo<span class="token punctuation">.</span>mPendingAnimatingRenderNodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">registerAnimatingRenderNode</span><span class="token punctuation">(</span>
                        attachInfo<span class="token punctuation">.</span>mPendingAnimatingRenderNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            attachInfo<span class="token punctuation">.</span>mPendingAnimatingRenderNodes<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachInfo<span class="token punctuation">.</span>mPendingAnimatingRenderNodes <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> frameInfo <span class="token operator">=</span> choreographer<span class="token punctuation">.</span>mFrameInfo<span class="token punctuation">.</span>mFrameInfo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frameDrawingCallback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">nSetFrameCallback</span><span class="token punctuation">(</span>mNativeProxy<span class="token punctuation">,</span> frameDrawingCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> syncResult <span class="token operator">=</span> <span class="token function">nSyncAndDrawFrame</span><span class="token punctuation">(</span>mNativeProxy<span class="token punctuation">,</span> frameInfo<span class="token punctuation">,</span> frameInfo<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>syncResult <span class="token operator">&amp;</span> SYNC_LOST_SURFACE_REWARD_IF_FOUND<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachInfo<span class="token punctuation">.</span>mViewRootImpl<span class="token punctuation">.</span>mSurface<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachInfo<span class="token punctuation">.</span>mViewRootImpl<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>syncResult <span class="token operator">&amp;</span> SYNC_INVALIDATE_REQUIRED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            attachInfo<span class="token punctuation">.</span>mViewRootImpl<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.updateRootDisplayList 从根部开始遍历整个View tree。</li>
<li>2.registerAnimatingRenderNode 注册每一个需要执行动画的RenderNode</li>
<li>3.nSetFrameCallback 把FrameDrawingCallback注册到native层</li>
<li>4.nSyncAndDrawFrame 调用native的同步绘制</li>
<li>5.如果绘制结果返回SYNC_LOST_SURFACE_REWARD_IF_FOUND标志位，说明可能Surface无效或者出错，则关闭硬件渲染，释放VRI的mSurface等对象。如果SYNC_INVALIDATE_REQUIRED返回了，说明还需要下一轮的Loop通过performTravel进行局部刷新。</li>
</ul>
<p>可以看到整个核心在updateRootDisplayList和nSyncAndDrawFrame两个方法。只要弄懂这两个核心流程就能明白整套硬件渲染的流程。</p>
<h3 id="ThreadedRenderer-updateRootDisplayList-从根部更新绘制树"><a href="#ThreadedRenderer-updateRootDisplayList-从根部更新绘制树" class="headerlink" title="ThreadedRenderer updateRootDisplayList 从根部更新绘制树"></a>ThreadedRenderer updateRootDisplayList 从根部更新绘制树</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateRootDisplayList</span><span class="token punctuation">(</span>View view<span class="token punctuation">,</span> DrawCallbacks callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateViewTreeDisplayList</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRootNodeNeedsUpdate <span class="token operator">||</span> <span class="token operator">!</span>mRootNode<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            DisplayListCanvas canvas <span class="token operator">=</span> mRootNode<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>mSurfaceWidth<span class="token punctuation">,</span> mSurfaceHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> saveCount <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>mInsetLeft<span class="token punctuation">,</span> mInsetTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
                callbacks<span class="token punctuation">.</span><span class="token function">onPreDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>

                canvas<span class="token punctuation">.</span><span class="token function">insertReorderBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                canvas<span class="token punctuation">.</span><span class="token function">drawRenderNode</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">updateDisplayListIfDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                canvas<span class="token punctuation">.</span><span class="token function">insertInorderBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                callbacks<span class="token punctuation">.</span><span class="token function">onPostDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
                canvas<span class="token punctuation">.</span><span class="token function">restoreToCount</span><span class="token punctuation">(</span>saveCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mRootNodeNeedsUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                mRootNode<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_VIEW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行了如下几个事情：</p>
<ul>
<li>1.updateViewTreeDisplayList 更新整个View tree</li>
<li>2.调用根绘制节点mRootNode的start方法，生成一个根DisplayListCanvas对象</li>
<li>3.调用ViewRootImpl的onPreDraw回调。</li>
<li>4.DisplayListCanvas insertReorderBarrier</li>
<li>5.DisplayListCanvas drawRenderNode绘制节点，并开始遍历子节点</li>
<li>6.DisplayListCanvas insertInorderBarrier</li>
<li>7.调用ViewRootImpl的onPostDraw</li>
<li>8.mRootNode的end方法，保存DisplayListCanvas到根节点中。</li>
</ul>
<p>我们一个个进行解析。</p>
<h4 id="updateViewTreeDisplayList"><a href="#updateViewTreeDisplayList" class="headerlink" title="updateViewTreeDisplayList"></a>updateViewTreeDisplayList</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateViewTreeDisplayList</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        view<span class="token punctuation">.</span>mPrivateFlags <span class="token operator">|=</span> View<span class="token punctuation">.</span>PFLAG_DRAWN<span class="token punctuation">;</span>
        view<span class="token punctuation">.</span>mRecreateDisplayList <span class="token operator">=</span> <span class="token punctuation">(</span>view<span class="token punctuation">.</span>mPrivateFlags <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>PFLAG_INVALIDATED<span class="token punctuation">)</span>
                <span class="token operator">==</span> View<span class="token punctuation">.</span>PFLAG_INVALIDATED<span class="token punctuation">;</span>
        view<span class="token punctuation">.</span>mPrivateFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>View<span class="token punctuation">.</span>PFLAG_INVALIDATED<span class="token punctuation">;</span>
        view<span class="token punctuation">.</span><span class="token function">updateDisplayListIfDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        view<span class="token punctuation">.</span>mRecreateDisplayList <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意此时的View是指DecorView，在这里面给DecorView设置了PFLAG_DRAWN标志位。</p>
<p>如果DecorView的PFLAG_INVALIDATED标志位打开了，说明整个View都被设置无效，需要重新构建整个硬件渲染的View树。接着关闭PFLAG_INVALIDATED标志位，调用updateDisplayListIfDirty进行子View的RenderNode遍历。</p>
<p>而关于updateDisplayListIfDirty的详细原理可以阅读<a href="https://www.jianshu.com/p/a4fb6a02ad53" target="_blank" rel="noopener">View的绘制流程(三) onDraw</a>中updateDisplayListIfDirty小结。这里我们只关注核心的部分：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> RenderNode <span class="token function">updateDisplayListIfDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> RenderNode renderNode <span class="token operator">=</span> mRenderNode<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canHaveDisplayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> renderNode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mRecreateDisplayList <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> width <span class="token operator">=</span> mRight <span class="token operator">-</span> mLeft<span class="token punctuation">;</span>
            <span class="token keyword">int</span> height <span class="token operator">=</span> mBottom <span class="token operator">-</span> mTop<span class="token punctuation">;</span>
            <span class="token keyword">int</span> layerType <span class="token operator">=</span> <span class="token function">getLayerType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> DisplayListCanvas canvas <span class="token operator">=</span> renderNode<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>layerType <span class="token operator">==</span> LAYER_TYPE_SOFTWARE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token operator">-</span>mScrollX<span class="token punctuation">,</span> <span class="token operator">-</span>mScrollY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mPrivateFlags <span class="token operator">|=</span> PFLAG_DRAWN <span class="token operator">|</span> PFLAG_DRAWING_CACHE_VALID<span class="token punctuation">;</span>
                    mPrivateFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>PFLAG_DIRTY_MASK<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> PFLAG_SKIP_DRAW<span class="token punctuation">)</span> <span class="token operator">==</span> PFLAG_SKIP_DRAW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">dispatchDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">drawAutofilledHighlight</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOverlay <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mOverlay<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mOverlay<span class="token punctuation">.</span><span class="token function">getOverlayView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">draw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                renderNode<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setDisplayListProperties</span><span class="token punctuation">(</span>renderNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> renderNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>假如此时是DecorView，则会调用DecorView中的RenderNode对象执行如下：</p>
<ul>
<li>1.RenderNode.start 给DecorView生成一个对应的DisplayListCanvas对象。</li>
<li>2.调用draw方法，开始对DisplayListCanvas进行绘制。在这个过程中，还会调用drawRenderNode方法。</li>
<li>3.RenderNode.end 保存了DisplayListCanvas对象。</li>
</ul>
<p>能看到实际上来来去去都是调用每一个View层级中RenderNode的三个方法，</p>
<ul>
<li>1.start生成View自己的RenderNode</li>
<li>2.当调用完DisplayListCanvas的绘制结果后，drawRenderNode DisplayListCanvas绘制RenderNode</li>
<li>3.end 保存DisplayListCanvas</li>
</ul>
<p>关于这三个方法，我们接下来来看看DisplayListCanvas几个方法。</p>
<h2 id="DisplayListCanvas-原理"><a href="#DisplayListCanvas-原理" class="headerlink" title="DisplayListCanvas 原理"></a>DisplayListCanvas 原理</h2><p>在聊DisplayListCanvas之前，我们需要了解它的在Java层中的继承关系。如下图：<br><img src="/images/DisplayListCanvas%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.jpg" alt="DisplayListCanvas继承关系.jpg"></p>
<p>实际上在native层也是十分相似的结构。</p>
<h3 id="RenderNode-DisplayListCanvas的生成"><a href="#RenderNode-DisplayListCanvas的生成" class="headerlink" title="RenderNode DisplayListCanvas的生成"></a>RenderNode DisplayListCanvas的生成</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> DisplayListCanvas <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> DisplayListCanvas<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/DisplayListCanvas.java" target="_blank" rel="noopener">DisplayListCanvas.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> POOL_LIMIT <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> SynchronizedPool<span class="token operator">&lt;</span>DisplayListCanvas<span class="token operator">></span> sPool <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">SynchronizedPool</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>POOL_LIMIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> DisplayListCanvas <span class="token function">obtain</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> RenderNode node<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"node cannot be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DisplayListCanvas canvas <span class="token operator">=</span> sPool<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>canvas <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayListCanvas</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">nResetDisplayListCanvas</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>mNativeCanvasWrapper<span class="token punctuation">,</span> node<span class="token punctuation">.</span>mNativeRenderNode<span class="token punctuation">,</span>
                    width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        canvas<span class="token punctuation">.</span>mNode <span class="token operator">=</span> node<span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span>mWidth <span class="token operator">=</span> width<span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span>mHeight <span class="token operator">=</span> height<span class="token punctuation">;</span>
        <span class="token keyword">return</span> canvas<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程中，所有的DisplayListCanvas都是从一个sPool中获取。其实这就是一个享元设计模式，sPool里面最大25个DisplayListCanvas，如果获取不到则直接new一个，否则则调用nResetDisplayListCanvas重置DisplayListCanvas中的内容。</p>
<p>我们再来看看DisplayListCanvas的构造函数。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token function">DisplayListCanvas</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> RenderNode node<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token function">nCreateDisplayListCanvas</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>mNativeRenderNode<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDensity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@CriticalNative</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">long</span> <span class="token function">nCreateDisplayListCanvas</span><span class="token punctuation">(</span><span class="token keyword">long</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先调用了native方法nCreateDisplayListCanvas生成一个native对象继续调用父类的构造函数。</p>
<p>这里有两个比较有意思的注解，是从Android 8.0开始支持的，@CriticalNative与@FastNative。</p>
<p>这两个注解是注解在native方法上，可以加速native的查找。</p>
<p>@FastNative：注解支持非静态方法(当然也支持静态方法)。如果某种方法将 jobject 作为参数或返回值进行访问，请使用此注解。其速度是普通的3倍。</p>
<p>@CriticalNative 比起普通的速度有5倍差距，但是使用场景有限制：</p>
<ul>
<li>1.方法必须是静态的 - 没有参数、返回值或隐式 this 的对象</li>
<li>2.仅将基元类型传递给原生方法</li>
<li>3.native方法在其函数定义中不使用 JNIEnv 和 jclass 参数</li>
<li>4.该方法必须是使用 RegisterNatives 注册的，而不是依靠动态 JNI 链接</li>
</ul>
<h4 id="nCreateDisplayListCanvas"><a href="#nCreateDisplayListCanvas" class="headerlink" title="nCreateDisplayListCanvas"></a>nCreateDisplayListCanvas</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_view_DisplayListCanvas.cpp" target="_blank" rel="noopener">android_view_DisplayListCanvas.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jlong <span class="token function">android_view_DisplayListCanvas_createDisplayListCanvas</span><span class="token punctuation">(</span>jlong renderNodePtr<span class="token punctuation">,</span>
        jint width<span class="token punctuation">,</span> jint height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RenderNode<span class="token operator">*</span> renderNode <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RenderNode<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>renderNodePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>jlong<span class="token operator">></span><span class="token punctuation">(</span>Canvas<span class="token operator">::</span><span class="token function">create_recording_canvas</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> renderNode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上调用了静态方法create_recording_canvas创建了一个对象。<br>文件：<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/hwui/Canvas.cpp" target="_blank" rel="noopener">Canvas.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Canvas<span class="token operator">*</span> Canvas<span class="token operator">::</span><span class="token function">create_recording_canvas</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> uirenderer<span class="token operator">::</span>RenderNode<span class="token operator">*</span> renderNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uirenderer<span class="token operator">::</span>Properties<span class="token operator">::</span><span class="token function">isSkiaEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> uirenderer<span class="token operator">::</span>skiapipeline<span class="token operator">::</span><span class="token function">SkiaRecordingCanvas</span><span class="token punctuation">(</span>renderNode<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> uirenderer<span class="token operator">::</span><span class="token function">RecordingCanvas</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中会进行判断，如果打开了Skia开关，也就是SKiaGL或者SkiaVulan两者其一的类型则会创建一个SkiaRecordingCanvas对象，否则会创建RecordingCanvas对象。</p>
<p>SkiaRecordingCanvas这个对象，我在TextureView一文和大家已经聊过一部分内容，我们现在来聊聊skia默认关闭的情景。</p>
<h4 id="RecordingCanvas的创建"><a href="#RecordingCanvas的创建" class="headerlink" title="RecordingCanvas的创建"></a>RecordingCanvas的创建</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/RecordingCanvas.cpp" target="_blank" rel="noopener">RecordingCanvas.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">RecordingCanvas<span class="token operator">::</span><span class="token function">RecordingCanvas</span><span class="token punctuation">(</span>size_t width<span class="token punctuation">,</span> size_t height<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">mState</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mResourceCache</span><span class="token punctuation">(</span>ResourceCache<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resetRecording</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> RecordingCanvas<span class="token operator">::</span><span class="token function">resetRecording</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> RenderNode<span class="token operator">*</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mDisplayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">DisplayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mState<span class="token punctuation">.</span><span class="token function">initializeRecordingSaveStack</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mDeferredBarrierType <span class="token operator">=</span> DeferredBarrierType<span class="token operator">::</span>InOrder<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>RecordingCanvas顾名思义，就是记录了什么东西的Canvas。</p>
<ul>
<li>1.首先构建一个记录绘制集合DisplayList对象。</li>
<li>2.调用当前对象的initializeRecordingSaveStack方法。也就是调用CanvasState的initializeRecordingSaveStack。<br>文件： /<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/CanvasState.cpp" target="_blank" rel="noopener">CanvasState.cpp</a></li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CanvasState<span class="token operator">::</span><span class="token function">initializeRecordingSaveStack</span><span class="token punctuation">(</span><span class="token keyword">int</span> viewportWidth<span class="token punctuation">,</span> <span class="token keyword">int</span> viewportHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mWidth <span class="token operator">!=</span> viewportWidth <span class="token operator">||</span> mHeight <span class="token operator">!=</span> viewportHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mWidth <span class="token operator">=</span> viewportWidth<span class="token punctuation">;</span>
        mHeight <span class="token operator">=</span> viewportHeight<span class="token punctuation">;</span>
        mFirstSnapshot<span class="token punctuation">.</span><span class="token function">initializeViewport</span><span class="token punctuation">(</span>viewportWidth<span class="token punctuation">,</span> viewportHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCanvas<span class="token punctuation">.</span><span class="token function">onViewportInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeAllSnapshots</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSnapshot <span class="token operator">=</span> <span class="token function">allocSnapshot</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mFirstSnapshot<span class="token punctuation">,</span> SaveFlags<span class="token operator">::</span>MatrixClip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSnapshot<span class="token operator">-</span><span class="token operator">></span><span class="token function">setRelativeLightCenter</span><span class="token punctuation">(</span><span class="token function">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSaveCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果宽高和当前实例化的换高不一致，初始化mFirstSnapshot快照对象，以及回调RecordCanvas的onViewportInitialized的回调。</p>
<p>释放之前除了第一张之外所有的快照，并且重新申请一个新的快照对象。</p>
<h4 id="DisplayList-实例化"><a href="#DisplayList-实例化" class="headerlink" title="DisplayList 实例化"></a>DisplayList 实例化</h4><p>能看到在RecordingCanvas中，有一个核心对象DisplayList。从名字可以看出是承载一个个显示图层的集合。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/DisplayList.h" target="_blank" rel="noopener">DisplayList.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">DisplayList</span> <span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">RecordingCanvas</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token comment" spellcheck="true">// allocator into which all ops and LsaVector arrays allocated</span>
    LinearAllocator allocator<span class="token punctuation">;</span>
    LinearStdAllocator<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span> stdAllocator<span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    LsaVector<span class="token operator">&lt;</span>Chunk<span class="token operator">></span> chunks<span class="token punctuation">;</span>
    LsaVector<span class="token operator">&lt;</span>BaseOpType<span class="token operator">*</span><span class="token operator">></span> ops<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// list of Ops referring to RenderNode children for quick, non-drawing traversal</span>
    LsaVector<span class="token operator">&lt;</span>NodeOpType<span class="token operator">*</span><span class="token operator">></span> children<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Resources - Skia objects + 9 patches referred to by this DisplayList</span>
    LsaVector<span class="token operator">&lt;</span>sk_sp<span class="token operator">&lt;</span>Bitmap<span class="token operator">>></span> bitmapResources<span class="token punctuation">;</span>
    LsaVector<span class="token operator">&lt;</span><span class="token keyword">const</span> SkPath<span class="token operator">*</span><span class="token operator">></span> pathResources<span class="token punctuation">;</span>
    LsaVector<span class="token operator">&lt;</span><span class="token keyword">const</span> Res_png_9patch<span class="token operator">*</span><span class="token operator">></span> patchResources<span class="token punctuation">;</span>
    LsaVector<span class="token operator">&lt;</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> SkPaint<span class="token operator">>></span> paints<span class="token punctuation">;</span>
    LsaVector<span class="token operator">&lt;</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> SkRegion<span class="token operator">>></span> regions<span class="token punctuation">;</span>
    LsaVector<span class="token operator">&lt;</span>sp<span class="token operator">&lt;</span>VirtualLightRefBase<span class="token operator">>></span> referenceHolders<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// List of functors</span>
    LsaVector<span class="token operator">&lt;</span>FunctorContainer<span class="token operator">></span> functors<span class="token punctuation">;</span>

    LsaVector<span class="token operator">&lt;</span>VectorDrawableRoot<span class="token operator">*</span><span class="token operator">></span> vectorDrawables<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">cleanupResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到DisplayList类中，有那么几个核心对象：</p>
<ul>
<li>1.LinearAllocator与LinearStdAllocator，这两个对象是硬件渲染中用于控制申请管理操作对象BaseOpType内存的内存管理器。</li>
<li>2.BaseOpType集合  BaseOpType是RecordedOp 类的别名，RecordedOp类是指绘制操作。</li>
<li>3.NodeOpType集合 NodeOpType 是RenderNodeOp别名，一般是作为DisplayList用于保存子RenderNode的内容</li>
<li>4.剩下的如bitmap资源，.9图片资源，画笔字眼，区域，vector向量图资源。</li>
</ul>
<p>能看到DisplayList中，有两个对象作为整个类的主导地位：</p>
<ul>
<li>1.BaseOpType 绘制操作对象</li>
<li>2.LinearAllocator BaseOpType的内存管理器</li>
</ul>
<p>让我们来看看这两者的核心原理。</p>
<h4 id="LinearAllocator-线性内存管理器"><a href="#LinearAllocator-线性内存管理器" class="headerlink" title="LinearAllocator 线性内存管理器"></a>LinearAllocator 线性内存管理器</h4><p>先来看看头文件：<br>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/utils/LinearAllocator.h" target="_blank" rel="noopener">LinearAllocator.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">LinearAllocator</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">alloc</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">allocImpl</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Params<span class="token operator">></span>
    T<span class="token operator">*</span> <span class="token function">create</span><span class="token punctuation">(</span>Params<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        T<span class="token operator">*</span> ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token function">allocImpl</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">T</span><span class="token punctuation">(</span>std<span class="token operator">::</span>forward<span class="token operator">&lt;</span>Params<span class="token operator">></span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>std<span class="token operator">::</span>is_trivially_destructible<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> dtor <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ret<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>T<span class="token operator">*</span><span class="token punctuation">)</span>ret<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token operator">~</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token function">addToDestructionList</span><span class="token punctuation">(</span>dtor<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Params<span class="token operator">></span>
    T<span class="token operator">*</span> <span class="token function">create_trivial</span><span class="token punctuation">(</span>Params<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">static_assert</span><span class="token punctuation">(</span>std<span class="token operator">::</span>is_trivially_destructible<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span>value<span class="token punctuation">,</span>
                      <span class="token string">"Error, called create_trivial on a non-trivial type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token function">allocImpl</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">T</span><span class="token punctuation">(</span>std<span class="token operator">::</span>forward<span class="token operator">&lt;</span>Params<span class="token operator">></span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
    T<span class="token operator">*</span> <span class="token function">create_trivial_array</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">static_assert</span><span class="token punctuation">(</span>std<span class="token operator">::</span>is_trivially_destructible<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span>value<span class="token punctuation">,</span>
                      <span class="token string">"Error, called create_trivial_array on a non-trivial type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token function">allocImpl</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">*</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">LinearAllocator</span><span class="token punctuation">(</span><span class="token keyword">const</span> LinearAllocator<span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">Page</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">allocImpl</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    size_t mPageSize<span class="token punctuation">;</span>
    size_t mMaxAllocSize<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> mNext<span class="token punctuation">;</span>
    Page<span class="token operator">*</span> mCurrentPage<span class="token punctuation">;</span>
    Page<span class="token operator">*</span> mPages<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    size_t mTotalAllocated<span class="token punctuation">;</span>
    size_t mWastedSpace<span class="token punctuation">;</span>
    size_t mPageCount<span class="token punctuation">;</span>
    size_t mDedicatedPageCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个内存管理器中实际上是把每一个申请出去的内存以page(页为单位)管理</p>
<ul>
<li>1.同时会不断的通过mTotalAllocated记录总共申请了多少</li>
<li>2.mWastedSpace记录有多少内存没有被使用</li>
<li>3.mPages指针实际上是一个page链表，当前LinearAllocator所有已经申请的内存页。</li>
<li>4.mCurrentPage 当前申请指向的页对象。</li>
</ul>
<p>一般的当Android进行申请内存，将会调用如下顺序：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">create_trivial<span class="token operator">&lt;</span>TextureLayerOp<span class="token operator">></span><span class="token punctuation">(</span>
            <span class="token function">Rect</span><span class="token punctuation">(</span>layerHandle<span class="token operator">-</span><span class="token operator">></span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> layerHandle<span class="token operator">-</span><span class="token operator">></span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">*</span><span class="token punctuation">(</span>mState<span class="token punctuation">.</span><span class="token function">currentSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>transform<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getRecordedClip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> layerHandle<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>实际上调用create_trivial方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Params<span class="token operator">></span>
    T<span class="token operator">*</span> <span class="token function">create_trivial</span><span class="token punctuation">(</span>Params<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token function">allocImpl</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">T</span><span class="token punctuation">(</span>std<span class="token operator">::</span>forward<span class="token operator">&lt;</span>Params<span class="token operator">></span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上是根据范性T的大小调用allocImpl申请内存大小为T。</p>
<h5 id="LinearAllocator的内存单元Page"><a href="#LinearAllocator的内存单元Page" class="headerlink" title="LinearAllocator的内存单元Page"></a>LinearAllocator的内存单元Page</h5><p>其中还有一个核心的对象Page：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">LinearAllocator</span><span class="token operator">::</span>Page <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    Page<span class="token operator">*</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mNextPage<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">setNext</span><span class="token punctuation">(</span>Page<span class="token operator">*</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span> mNextPage <span class="token operator">=</span> next<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">mNextPage</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token keyword">operator</span> <span class="token keyword">new</span><span class="token punctuation">(</span>size_t <span class="token comment" spellcheck="true">/*size*/</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> buf<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">Page</span><span class="token punctuation">(</span><span class="token keyword">const</span> Page<span class="token operator">&amp;</span> <span class="token comment" spellcheck="true">/*other*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    Page<span class="token operator">*</span> mNextPage<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 能看到实际上Page类实际上是一个链表中的一项，记录下一个Page的指针。page中有2个基本操作，用于计算Page的所申请的内存起点和末尾。</p>
<ul>
<li>start 是指Page内存单元的起点:<blockquote>
<p>计算方式为 Page地址起点+page类的大小</p>
</blockquote>
</li>
<li>end 是指Page内存单元的终点:<blockquote>
<p>计算方式为 Page地址起点+page类的大小+申请的内存大小PageSize</p>
</blockquote>
</li>
</ul>
<p>了解两个基本操作后，我们来看看LinearAllocator的内存操作create_trivial。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/utils/LinearAllocator.cpp" target="_blank" rel="noopener">LinearAllocator.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> INITIAL_PAGE_SIZE ((size_t)512)  </span><span class="token comment" spellcheck="true">// 512b</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_PAGE_SIZE ((size_t)131072)   </span><span class="token comment" spellcheck="true">// 128kb</span>

<span class="token macro property">#<span class="token directive keyword">if</span> ALIGN_DOUBLE</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ALIGN_SZ (sizeof(double))</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> ALIGN_SZ (sizeof(int))</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> ALIGN(x) (((x) + ALIGN_SZ - 1) &amp; ~(ALIGN_SZ - 1))</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ALIGN_PTR(p) ((void*)(ALIGN((size_t)(p))))</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_WASTE_RATIO (0.5f)</span>


LinearAllocator<span class="token operator">::</span><span class="token function">LinearAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">mPageSize</span><span class="token punctuation">(</span>INITIAL_PAGE_SIZE<span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mMaxAllocSize</span><span class="token punctuation">(</span>INITIAL_PAGE_SIZE <span class="token operator">*</span> MAX_WASTE_RATIO<span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mNext</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mCurrentPage</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mPages</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mTotalAllocated</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mWastedSpace</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mPageCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mDedicatedPageCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">bool</span> LinearAllocator<span class="token operator">::</span><span class="token function">fitsInCurrentPage</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mNext <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>mNext <span class="token operator">+</span> size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token function">end</span><span class="token punctuation">(</span>mCurrentPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span><span class="token operator">*</span> LinearAllocator<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span>Page<span class="token operator">*</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">ALIGN_PTR</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>p <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span><span class="token operator">*</span> LinearAllocator<span class="token operator">::</span><span class="token function">end</span><span class="token punctuation">(</span>Page<span class="token operator">*</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">)</span> <span class="token operator">+</span> mPageSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

LinearAllocator<span class="token operator">::</span>Page<span class="token operator">*</span> LinearAllocator<span class="token operator">::</span><span class="token function">newPage</span><span class="token punctuation">(</span>size_t pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pageSize <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>pageSize <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>LinearAllocator<span class="token operator">::</span>Page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mTotalAllocated <span class="token operator">+</span><span class="token operator">=</span> pageSize<span class="token punctuation">;</span>
    mPageCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> buf <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先来看看两个重要的属性：</p>
<ul>
<li>1.mPageSize 在初始化的时候定义好当前拥有页的大小，为INITIAL_PAGE_SIZE也就是宏512b。</li>
<li>2.mMaxAllocSize 也就是512* 0.5，也就是256.也是指最大能够申请的大小，超过这个大小就需要扩容了。</li>
<li>3.mNext 记录LinearAllocator本次申请后的终点。</li>
</ul>
<p>我们先来看看几个重要查找内存位置方法：</p>
<ul>
<li><p>1.start 方法实际上就是当前page的指针向后偏移Page的大小，并且ALIGN_PTR进行指针地址对齐。ALIGN_PTR的操作就是先把当前的指针地址先加3，接着与上3的非，这样能保证增加后的两位都为0，这样就能保证是4的倍数。</p>
</li>
<li><p>2.end 计算当前内存的末尾，指针大小+申请的页数大小</p>
</li>
<li><p>3.fitsInCurrentPage 判断当前的需要申请的大小是否能够被满足，计算方式最后一次申请的起点+即将申请的大小&lt; 当前已经申请大小的末尾</p>
</li>
<li><p>4.newPage 当超过mMaxAllocSize的阈值的时候，将会调用newPage申请新的内存。能看到每一次申请对应对象的大小，将会在mTotalAllocated累计起来，mPageCount进行累加申请了多少页。<br>而申请的大小通过malloc方式申请：</p>
<blockquote>
<p>新申请的大小 = 对齐内存（即将申请对象的大小 + Page大小）</p>
</blockquote>
</li>
</ul>
<h5 id="allocImpl-申请实现"><a href="#allocImpl-申请实现" class="headerlink" title="allocImpl 申请实现"></a>allocImpl 申请实现</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span><span class="token operator">*</span> LinearAllocator<span class="token operator">::</span><span class="token function">allocImpl</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    size <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">></span> mMaxAllocSize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">fitsInCurrentPage</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Page<span class="token operator">*</span> page <span class="token operator">=</span> <span class="token function">newPage</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDedicatedPageCount<span class="token operator">++</span><span class="token punctuation">;</span>
        page<span class="token operator">-</span><span class="token operator">></span><span class="token function">setNext</span><span class="token punctuation">(</span>mPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPages <span class="token operator">=</span> page<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mCurrentPage<span class="token punctuation">)</span> mCurrentPage <span class="token operator">=</span> mPages<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">start</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ensureNext</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> ptr <span class="token operator">=</span> mNext<span class="token punctuation">;</span>
    mNext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>mNext<span class="token punctuation">)</span> <span class="token operator">+</span> size<span class="token punctuation">;</span>
    mWastedSpace <span class="token operator">-</span><span class="token operator">=</span> size<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.首先对需要申请的大小进行ALIGN 字节对齐处理</li>
<li>2.判断需要申请的大小是否大于mMaxAllocSize且当前的页所支持有的大小不能满足当前需要申请的大小，则先通过newPage申请一个size内存大小page对象，把page的mNextPage对象设置为mPage对象，并且更新mPage的指针为最新对象，最后调用start方法，找到page申请出来大小的指针，并且返回起始地址。</li>
<li>3.如果满足剩余的Page当前需要申请的大小且小于mMaxAllocSize大小，则通过ensureNext查找合适的大小，并以mNext指针为起始地址返回，同时记录新的mNext地址作为申请的末尾，等待下次申请，并且把mWastedSpace的大小缩减。</li>
</ul>
<h6 id="ensureNext"><a href="#ensureNext" class="headerlink" title="ensureNext"></a>ensureNext</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> LinearAllocator<span class="token operator">::</span><span class="token function">ensureNext</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fitsInCurrentPage</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentPage <span class="token operator">&amp;&amp;</span> mPageSize <span class="token operator">&lt;</span> MAX_PAGE_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPageSize <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>MAX_PAGE_SIZE<span class="token punctuation">,</span> mPageSize <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mMaxAllocSize <span class="token operator">=</span> mPageSize <span class="token operator">*</span> MAX_WASTE_RATIO<span class="token punctuation">;</span>
        mPageSize <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>mPageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mWastedSpace <span class="token operator">+</span><span class="token operator">=</span> mPageSize<span class="token punctuation">;</span>
    Page<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">newPage</span><span class="token punctuation">(</span>mPageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mCurrentPage<span class="token operator">-</span><span class="token operator">></span><span class="token function">setNext</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mCurrentPage <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPages <span class="token operator">=</span> mCurrentPage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mNext <span class="token operator">=</span> <span class="token function">start</span><span class="token punctuation">(</span>mCurrentPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.如果fitsInCurrentPage判断到大小已经合适当前需要申请的大小，则直接返回，把当前的mNext申请到Page的地址起点返回。</li>
<li>2.如果mCurrentPage存在，且mPageSize(已经申请的Page的大小)小于MAX_PAGE_SIZE，说明此时原来已有的空余Page已经无法满足需要申请的大小，需要进行一次扩容。</li>
</ul>
<blockquote>
<p>扩容的上限数值为：MAX_PAGE_SIZE为128kb</p>
</blockquote>
<p>在128kb的限制夏，每一次对在上一次的PageSize的大小2倍基础上进行扩容。同时对mMaxAllocSize 最大可以申请到的阈值更新为新的PageSize的一半。</p>
<p>mPageSize最后需要进行一次，字节对齐。</p>
<ul>
<li>3.mWastedSpace 新增一个mPageSize大小，同时根据需要扩容的mPageSize进行newPage的申请。mCurrentPage如果存在，则mCurrentPage的mNext设置为新申请的page对象。mPages为空，说明是第一次申请，则把mPages设置为mCurrentPage。mNext设置为当前当前新申请的Page的起点。</li>
</ul>
<p>可能到这里，有的读者还是有点模糊，我这里再上几幅图就能明白LinearAllocator的内存管理思想。</p>
<p>每一个内存单元管理如下：<br><img src="/images/LinearAlloc.jpg" alt="LinearAlloc.jpg"></p>
<p>有了这个内存管理支持后，当需要销毁的时候，会调用LinearAllocator的析构函数。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">LinearAllocator<span class="token operator">::</span><span class="token operator">~</span><span class="token function">LinearAllocator</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>mDtorList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> node <span class="token operator">=</span> mDtorList<span class="token punctuation">;</span>
        mDtorList <span class="token operator">=</span> node<span class="token operator">-</span><span class="token operator">></span>next<span class="token punctuation">;</span>
        node<span class="token operator">-</span><span class="token operator">></span><span class="token function">dtor</span><span class="token punctuation">(</span>node<span class="token operator">-</span><span class="token operator">></span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Page<span class="token operator">*</span> p <span class="token operator">=</span> mPages<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Page<span class="token operator">*</span> next <span class="token operator">=</span> p<span class="token operator">-</span><span class="token operator">></span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token operator">-</span><span class="token operator">></span><span class="token operator">~</span><span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">RM_ALLOCATION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        p <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="RecordedOp-绘制操作基础对象"><a href="#RecordedOp-绘制操作基础对象" class="headerlink" title="RecordedOp 绘制操作基础对象"></a>RecordedOp 绘制操作基础对象</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/RecordedOp.h" target="_blank" rel="noopener">RecordedOp.h</a><br>来看看它的声明：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> RecordedOp <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* ID from RecordedOpId - generally used for jumping into function tables */</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> opId<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* bounds in *local* space, without accounting for DisplayList transformation, or stroke */</span>
    <span class="token keyword">const</span> Rect unmappedBounds<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* transform in recording space (vs DisplayList origin) */</span>
    <span class="token keyword">const</span> Matrix4 localMatrix<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* clip in recording space - nullptr if not clipped */</span>
    <span class="token keyword">const</span> ClipBase<span class="token operator">*</span> localClip<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* optional paint, stored in base object to simplify merging logic */</span>
    <span class="token keyword">const</span> SkPaint<span class="token operator">*</span> paint<span class="token punctuation">;</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token function">RecordedOp</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> opId<span class="token punctuation">,</span> BASE_PARAMS<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">opId</span><span class="token punctuation">(</span>opId<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">unmappedBounds</span><span class="token punctuation">(</span>unmappedBounds<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">localMatrix</span><span class="token punctuation">(</span>localMatrix<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">localClip</span><span class="token punctuation">(</span>localClip<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">paint</span><span class="token punctuation">(</span>paint<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.opId RecordedOp 绘制操作的类型id</li>
<li>2.unmappedBounds RecordedOp 绘制操作的区域(不考虑画笔宽度以及变换)</li>
<li>3.localMatrix 坐标的转化矩阵</li>
<li>4.localClip 裁剪区域</li>
<li>5.paint 画笔</li>
</ul>
<p>我们可以看看几个经典的继承例子：<br>代表绘制线的操作对象LinesOp：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> LinesOp <span class="token operator">:</span> RecordedOp <span class="token punctuation">{</span>
    <span class="token function">LinesOp</span><span class="token punctuation">(</span>BASE_PARAMS<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> points<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> floatCount<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">SUPER</span><span class="token punctuation">(</span>LinesOp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">points</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">floatCount</span><span class="token punctuation">(</span>floatCount<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> points<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> floatCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>线所有点集合points。</p>
<p>代表颜色操作的RecordedOp</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> ColorOp <span class="token operator">:</span> RecordedOp <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Note: unbounded op that will fillclip, so no bounds/matrix needed</span>
    <span class="token function">ColorOp</span><span class="token punctuation">(</span><span class="token keyword">const</span> ClipBase<span class="token operator">*</span> localClip<span class="token punctuation">,</span> <span class="token keyword">int</span> color<span class="token punctuation">,</span> SkBlendMode mode<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">RecordedOp</span><span class="token punctuation">(</span>RecordedOpId<span class="token operator">::</span>ColorOp<span class="token punctuation">,</span> <span class="token function">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Matrix4<span class="token operator">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> localClip<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">color</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">mode</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> color<span class="token punctuation">;</span>
    <span class="token keyword">const</span> SkBlendMode mode<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代表色值的color。</p>
<p>还有TextureView接触的对象TextureLayerOp：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> TextureLayerOp <span class="token operator">:</span> RecordedOp <span class="token punctuation">{</span>
    <span class="token function">TextureLayerOp</span><span class="token punctuation">(</span>BASE_PARAMS_PAINTLESS<span class="token punctuation">,</span> DeferredLayerUpdater<span class="token operator">*</span> layer<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">SUPER_PAINTLESS</span><span class="token punctuation">(</span>TextureLayerOp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">layerHandle</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Copy an existing TextureLayerOp, replacing the underlying matrix</span>
    <span class="token function">TextureLayerOp</span><span class="token punctuation">(</span><span class="token keyword">const</span> TextureLayerOp<span class="token operator">&amp;</span> op<span class="token punctuation">,</span> <span class="token keyword">const</span> Matrix4<span class="token operator">&amp;</span> replacementMatrix<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">RecordedOp</span><span class="token punctuation">(</span>RecordedOpId<span class="token operator">::</span>TextureLayerOp<span class="token punctuation">,</span> op<span class="token punctuation">.</span>unmappedBounds<span class="token punctuation">,</span> replacementMatrix<span class="token punctuation">,</span>
                         op<span class="token punctuation">.</span>localClip<span class="token punctuation">,</span> op<span class="token punctuation">.</span>paint<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">layerHandle</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>layerHandle<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    DeferredLayerUpdater<span class="token operator">*</span> layerHandle<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>内部包含了一个DeferredLayerUpdater，由于更新一块图层区域DeferredLayerUpdater对象。关于DeferredLayerUpdater的原理详细的可以阅读我写的<a href="https://www.jianshu.com/p/1dce98846dc7" target="_blank" rel="noopener"> SurfaceView和TextureView 源码浅析(下)</a>一文，注意TextView一文中实际上就是打开了Skia开关后的逻辑。</p>
<h5 id="RenderNodeOp"><a href="#RenderNodeOp" class="headerlink" title="RenderNodeOp"></a>RenderNodeOp</h5><p>除此之外，还有另一个比较重要的对象RenderNodeOp：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> RenderNodeOp <span class="token operator">:</span> RecordedOp <span class="token punctuation">{</span>
    <span class="token function">RenderNodeOp</span><span class="token punctuation">(</span>BASE_PARAMS_PAINTLESS<span class="token punctuation">,</span> RenderNode<span class="token operator">*</span> renderNode<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">SUPER_PAINTLESS</span><span class="token punctuation">(</span>RenderNodeOp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">renderNode</span><span class="token punctuation">(</span>renderNode<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    RenderNode<span class="token operator">*</span> renderNode<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// not const, since drawing modifies it</span>
    Matrix4 transformFromCompositingAncestor<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> skipInOrderDraw <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到RenderNodeOp这个操作实际上是包含了一个RenderNode对象。实际上mDisplayList对象将会通过RenderNodeOp控制所有的子renderNode。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/DisplayList.cpp" target="_blank" rel="noopener">DisplayList.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">size_t DisplayList<span class="token operator">::</span><span class="token function">addChild</span><span class="token punctuation">(</span>NodeOpType<span class="token operator">*</span> op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    referenceHolders<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>op<span class="token operator">-</span><span class="token operator">></span>renderNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t index <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    children<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> index<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还记得这个children实际上就是NodeOpType的集合吗？那么就可以看到，实际上父容器的RenderNode是通过其生成的DisplayListCanvas中的DisplayList的NodeOpType集合控制所有的子RenderNode。</p>
<p>从而在硬件渲染线程中构造出和软件渲染一样的View树。</p>
<h4 id="Canvas的构造函数"><a href="#Canvas的构造函数" class="headerlink" title="Canvas的构造函数"></a>Canvas的构造函数</h4><p>RecordingCanvas的构造函数还是直接调用基类的构造函数，我们来直接看看Canvas的对象：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">Canvas</span><span class="token punctuation">(</span><span class="token keyword">long</span> nativeCanvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeCanvas <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mNativeCanvasWrapper <span class="token operator">=</span> nativeCanvas<span class="token punctuation">;</span>
        mFinalizer <span class="token operator">=</span> NoImagePreloadHolder<span class="token punctuation">.</span>sRegistry<span class="token punctuation">.</span><span class="token function">registerNativeAllocation</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span> mNativeCanvasWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDensity <span class="token operator">=</span> Bitmap<span class="token punctuation">.</span><span class="token function">getDefaultDensity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到很简单实际上就是监听了mNativeCanvasWrapper的回收方法。</p>
<h4 id="DisplayListCanvas-nResetDisplayListCanvas-重置整个DisplayListCanvas对象"><a href="#DisplayListCanvas-nResetDisplayListCanvas-重置整个DisplayListCanvas对象" class="headerlink" title="DisplayListCanvas nResetDisplayListCanvas  重置整个DisplayListCanvas对象"></a>DisplayListCanvas nResetDisplayListCanvas  重置整个DisplayListCanvas对象</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_view_DisplayListCanvas.cpp" target="_blank" rel="noopener">android_view_DisplayListCanvas.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_view_DisplayListCanvas_resetDisplayListCanvas</span><span class="token punctuation">(</span>jlong canvasPtr<span class="token punctuation">,</span>
        jlong renderNodePtr<span class="token punctuation">,</span> jint width<span class="token punctuation">,</span> jint height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Canvas<span class="token operator">*</span> canvas <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Canvas<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>canvasPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    RenderNode<span class="token operator">*</span> renderNode <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RenderNode<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>renderNodePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token operator">-</span><span class="token operator">></span><span class="token function">resetRecording</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> renderNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上还是调用了RecordingCanvas的resetRecording，一个新的DisplayList以及重置快照。</p>
<h4 id="DisplayListCanvas-drawRenderNode"><a href="#DisplayListCanvas-drawRenderNode" class="headerlink" title="DisplayListCanvas drawRenderNode"></a>DisplayListCanvas drawRenderNode</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/DisplayListCanvas.java" target="_blank" rel="noopener">DisplayListCanvas.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">drawRenderNode</span><span class="token punctuation">(</span>RenderNode renderNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">nDrawRenderNode</span><span class="token punctuation">(</span>mNativeCanvasWrapper<span class="token punctuation">,</span> renderNode<span class="token punctuation">.</span><span class="token function">getNativeDisplayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>文件：<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_view_DisplayListCanvas.cpp" target="_blank" rel="noopener">android_view_DisplayListCanvas.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_view_DisplayListCanvas_drawRenderNode</span><span class="token punctuation">(</span>jlong canvasPtr<span class="token punctuation">,</span> jlong renderNodePtr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Canvas<span class="token operator">*</span> canvas <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Canvas<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>canvasPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    RenderNode<span class="token operator">*</span> renderNode <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RenderNode<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>renderNodePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token operator">-</span><span class="token operator">></span><span class="token function">drawRenderNode</span><span class="token punctuation">(</span>renderNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上很简单，就是调用了RecordingCanvas的drawRenderNode方法。</p>
<h5 id="RecordingCanvas-drawRenderNode"><a href="#RecordingCanvas-drawRenderNode" class="headerlink" title="RecordingCanvas drawRenderNode"></a>RecordingCanvas drawRenderNode</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/" target="_blank" rel="noopener">hwui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/libs/hwui/RecordingCanvas.cpp" target="_blank" rel="noopener">RecordingCanvas.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RecordingCanvas<span class="token operator">::</span><span class="token function">drawRenderNode</span><span class="token punctuation">(</span>RenderNode<span class="token operator">*</span> renderNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> stagingProps <span class="token operator">=</span> renderNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">stagingProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RenderNodeOp<span class="token operator">*</span> op <span class="token operator">=</span> <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>create_trivial<span class="token operator">&lt;</span>RenderNodeOp<span class="token operator">></span><span class="token punctuation">(</span>
            <span class="token function">Rect</span><span class="token punctuation">(</span>stagingProps<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stagingProps<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">*</span><span class="token punctuation">(</span>mState<span class="token punctuation">.</span><span class="token function">currentSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>transform<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getRecordedClip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> renderNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> opIndex <span class="token operator">=</span> <span class="token function">addOp</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_LIKELY</span><span class="token punctuation">(</span>opIndex <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> childIndex <span class="token operator">=</span> mDisplayList<span class="token operator">-</span><span class="token operator">></span><span class="token function">addChild</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// update the chunk's child indices</span>
        DisplayList<span class="token operator">::</span>Chunk<span class="token operator">&amp;</span> chunk <span class="token operator">=</span> mDisplayList<span class="token operator">-</span><span class="token operator">></span>chunks<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chunk<span class="token punctuation">.</span>endChildIndex <span class="token operator">=</span> childIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>renderNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">stagingProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isProjectionReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// use staging property, since recording on UI thread</span>
            mDisplayList<span class="token operator">-</span><span class="token operator">></span>projectionReceiveIndex <span class="token operator">=</span> opIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>drawRenderNode方法首先先通过addOp，把RenderNodeOp操作添加到ops操作集合中，同时通过addChild把子的RenderNode交给当前的DisplayList进行管理。</p>
<h5 id="RecordingCanvas-addOp"><a href="#RecordingCanvas-addOp" class="headerlink" title="RecordingCanvas addOp"></a>RecordingCanvas addOp</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> RecordingCanvas<span class="token operator">::</span><span class="token function">addOp</span><span class="token punctuation">(</span>RecordedOp<span class="token operator">*</span> op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// skip op with empty clip</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>op<span class="token operator">-</span><span class="token operator">></span>localClip <span class="token operator">&amp;&amp;</span> op<span class="token operator">-</span><span class="token operator">></span>localClip<span class="token operator">-</span><span class="token operator">></span>rect<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> insertIndex <span class="token operator">=</span> mDisplayList<span class="token operator">-</span><span class="token operator">></span>ops<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mDisplayList<span class="token operator">-</span><span class="token operator">></span>ops<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDeferredBarrierType <span class="token operator">!=</span> DeferredBarrierType<span class="token operator">::</span>None<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// op is first in new chunk</span>
        mDisplayList<span class="token operator">-</span><span class="token operator">></span>chunks<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DisplayList<span class="token operator">::</span>Chunk<span class="token operator">&amp;</span> newChunk <span class="token operator">=</span> mDisplayList<span class="token operator">-</span><span class="token operator">></span>chunks<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newChunk<span class="token punctuation">.</span>beginOpIndex <span class="token operator">=</span> insertIndex<span class="token punctuation">;</span>
        newChunk<span class="token punctuation">.</span>endOpIndex <span class="token operator">=</span> insertIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        newChunk<span class="token punctuation">.</span>reorderChildren <span class="token operator">=</span> <span class="token punctuation">(</span>mDeferredBarrierType <span class="token operator">==</span> DeferredBarrierType<span class="token operator">::</span>OutOfOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        newChunk<span class="token punctuation">.</span>reorderClip <span class="token operator">=</span> mDeferredBarrierClip<span class="token punctuation">;</span>

        <span class="token keyword">int</span> nextChildIndex <span class="token operator">=</span> mDisplayList<span class="token operator">-</span><span class="token operator">></span>children<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newChunk<span class="token punctuation">.</span>beginChildIndex <span class="token operator">=</span> newChunk<span class="token punctuation">.</span>endChildIndex <span class="token operator">=</span> nextChildIndex<span class="token punctuation">;</span>
        mDeferredBarrierType <span class="token operator">=</span> DeferredBarrierType<span class="token operator">::</span>None<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// standard case - append to existing chunk</span>
        mDisplayList<span class="token operator">-</span><span class="token operator">></span>chunks<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>endOpIndex <span class="token operator">=</span> insertIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> insertIndex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上这里的操作有2个：</p>
<ul>
<li>1.mDisplayList的ops保存当前的操作。</li>
<li>2.mDeferredBarrierType不为None，则获取末尾位置的chunk数据块对象，保存相关的参数。</li>
</ul>
<h3 id="DisplayListCanvas-end"><a href="#DisplayListCanvas-end" class="headerlink" title="DisplayListCanvas end"></a>DisplayListCanvas end</h3><p>当start和drawRenderNode后，RenderNode就会调用end方法收尾：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">end</span><span class="token punctuation">(</span>DisplayListCanvas canvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> displayList <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">finishRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">nSetDisplayList</span><span class="token punctuation">(</span>mNativeRenderNode<span class="token punctuation">,</span> displayList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.finishRecord 方法结束Canvas对绘制的记录。调用的方法如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">DisplayList<span class="token operator">*</span> RecordingCanvas<span class="token operator">::</span><span class="token function">finishRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">restoreToCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mPaintMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mRegionMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mPathMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  DisplayList<span class="token operator">*</span> displayList <span class="token operator">=</span> mDisplayList<span class="token punctuation">;</span>
  mDisplayList <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  mSkiaCanvasProxy<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> displayList<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上就是把RecordingCanvas中的DisplayList直接返回给上层对象。</p>
</li>
<li><p>2.nSetDisplayList RenderNode记录DisplayList。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_view_RenderNode_setDisplayList</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
      jobject clazz<span class="token punctuation">,</span> jlong renderNodePtr<span class="token punctuation">,</span> jlong displayListPtr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  RenderNode<span class="token operator">*</span> renderNode <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>RenderNode<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>renderNodePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  DisplayList<span class="token operator">*</span> newData <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>DisplayList<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>displayListPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  renderNode<span class="token operator">-</span><span class="token operator">></span><span class="token function">setStagingDisplayList</span><span class="token punctuation">(</span>newData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RenderNode<span class="token operator">::</span><span class="token function">setStagingDisplayList</span><span class="token punctuation">(</span>DisplayList<span class="token operator">*</span> displayList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mValid <span class="token operator">=</span> <span class="token punctuation">(</span>displayList <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mNeedsDisplayListSync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> mStagingDisplayList<span class="token punctuation">;</span>
  mStagingDisplayList <span class="token operator">=</span> displayList<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上RenderNode的native对象，会先销毁上一次DisplayList对象，并把新的DisplayList保存到mStagingDisplayList中。</p>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文先到这里，到这里我们就知道了整个ThreadRenderer在执行硬件渲染之前都做了什么准备。后续就会开始解析整个硬件渲染的原理。先做做总结。</p>
<p>现在再来看看之前的思维导图：<br><img src="/images/ThreadedRender%E5%AF%B9%E8%B1%A1.png" alt="ThreadedRender对象.png"></p>
<p>我们先从RenderNode开始总结</p>
<h3 id="RenderNode的总结"><a href="#RenderNode的总结" class="headerlink" title="RenderNode的总结"></a>RenderNode的总结</h3><p>RenderNode可以分为两种：</p>
<ul>
<li><p>1.一种是保存在ThreadedRenderer中的RootRenderNode，是一个根部RenderNode，在初始化的时候，会添加到CanvasContext中，等待后续的绘制时候从RootRenderNode开始遍历。</p>
</li>
<li><p>2.另一种是跟在所有View的RenderNode的对象，这是所有View中都会只有的对象，当打开了硬件渲染，就会走到RenderNode的分支中，把绘制行为都放到RenderNode中。</p>
</li>
</ul>
<p>对于所有的RenderNode都有如下图的职责：<br><img src="/images/RenderNode.png" alt="RenderNode.png"></p>
<h3 id="DisplayListCanvas与DisplayList的总结"><a href="#DisplayListCanvas与DisplayList的总结" class="headerlink" title="DisplayListCanvas与DisplayList的总结"></a>DisplayListCanvas与DisplayList的总结</h3><p>所有的DisplayListCanvas都是通过RenderNode的start方法生成的，DisplayListCanvas对应native对象就是RecordingCanvas，下面是一个更加全面的UML图：<br><img src="/images/DisplayListCanvas.jpg" alt="DisplayListCanvas.jpg"><br>从图中可以看到如下关系：</p>
<ul>
<li><p>1.DisplayListCanvas在底层和RecordingCanvas/SkiaRecordingCanvas 一一对应。所有在硬件渲染画布上的内容实际上保存在RecordingCanvas。</p>
</li>
<li><p>2.RecordingCanvas 之所以名字为Recording 记录，原因很简单，因为通过draw，onDraw，drawdispatch三个流程时候，并不会立即绘制到内存中，而是把绘制操作变成一个个BaseOpType保存在DisplayList中。当一次绘制结束后就会通过RenderNode.end把DisplayList保存到RenderNode中。</p>
</li>
<li><p>3.在RecordingCanvas中有一个十分关键的类DisplayList。DisplayList中有两个比较核心的集合，这两个集合贯通了硬件渲染的全局，一个是ops，一个是children。</p>
</li>
</ul>
<p>ops是BaseOpType的集合，实际上是一个个RecordedOp集合。这个集合一般不记录RecordedOp基础结构体，而是收集那些通过继承扩展成Text，Color等有实际操作的意义的操作。</p>
<p>children是RenderNodeOp。虽然也是继承RecordedOp，但是RenderNodeOp中包含了子RenderNode，因此硬件渲染执行的时候，并不会把RenderNodeOp保存到ops集合中，而是在draw方法的时候收集到children集合中。</p>
<h3 id="RenderThread的总结"><a href="#RenderThread的总结" class="headerlink" title="RenderThread的总结"></a>RenderThread的总结</h3><p>RenderThread本质上是活跃在背后的硬件渲染线程：</p>
<pre class="line-numbers language-java"><code class="language-java">
                <span class="token keyword">final</span> FrameDrawingCallback callback <span class="token operator">=</span> mNextRtFrameCallback<span class="token punctuation">;</span>
                mNextRtFrameCallback <span class="token operator">=</span> null<span class="token punctuation">;</span>
                mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>mView<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在ViewRootImpl的draw方法中会调用判断到mThreadedRenderer可用，则会通过mThreadedRenderer.draw通过RenderProxy进入到RenderThread中。注意RenderThread是一个单例的渲染线程，其中包含着一个Looper和一个WorkQueue。其核心原理几乎和MessageQueue和Looper一致。</p>
<p>所有的任务都是通过RenderThread进入到WorkQueue中，Looper会通过epoll唤醒获取WorkQueue中保存好的WorkItem进行执行。而这些WorkItem包含我们需要执行的渲染的方法指针。</p>
<p>RenderThread的Looper除了执行WorkQueue中保存的渲染方法之外，还做了另一件事情，那就是监听Vsync信号的到来。当每一次Vsync信号到了，将会调用dispatchFrameCallbacks方法开始回调到CanvasContext中执行渲染动作，关于这部分内容，我将放到下一篇文章和大家聊聊。</p>
<h3 id="CanvasContext与PipeLine的总结"><a href="#CanvasContext与PipeLine的总结" class="headerlink" title="CanvasContext与PipeLine的总结"></a>CanvasContext与PipeLine的总结</h3><p>CanvasContext是指绘制上下文，CanvasContext持有一个很关键的对象PipeLine。PipeLine会根据当前配置，选择OpenGL，Skia适配的OpenGL，Skia适配的vulkan进行硬件渲染</p>
<p>总结来说，所有的绘制行为都会集中到CanvasContext中，最后由CanvasContext决定使用哪一个管道进行渲染行为。</p>
<p>每当RenderThread监听到一个Vsync信号到来之后，将会回调到DrawFrameTask中执行真正的像素合成。</p>
<h3 id="ThreadedRenderer-在ViewRootImpl中扮演的角色与执行时机"><a href="#ThreadedRenderer-在ViewRootImpl中扮演的角色与执行时机" class="headerlink" title="ThreadedRenderer 在ViewRootImpl中扮演的角色与执行时机"></a>ThreadedRenderer 在ViewRootImpl中扮演的角色与执行时机</h3><p>总结2个在核心类后，我们全局观看一下ThreadedRenderer在ViewRootImpl中三大绘制流程所扮演的角色。实际上在前面几篇文章中，我有意无意的跳过了硬件渲染的流程。</p>
<p>不熟悉的，可以阅读我之前写的5篇文章：</p>
<ul>
<li>1.<a href="https://www.jianshu.com/p/003dc36af9db" target="_blank" rel="noopener">Android 重学系列 View的绘制流程 (一)View的初始化</a></li>
<li>2.<a href="https://www.jianshu.com/p/2f4e7e9e5cc0" target="_blank" rel="noopener">Android 重学系列 View的绘制流程(二) 绘制的准备</a></li>
<li>3.<a href="https://www.jianshu.com/p/4f8b5c559311" target="_blank" rel="noopener">Android 重学系列 View的绘制流程(三) onMeasure</a></li>
<li>4.<a href="https://www.jianshu.com/p/577afa53ce97" target="_blank" rel="noopener">Android 重学系列 View的绘制流程(四) onLayout</a></li>
<li>5.<a href="https://www.jianshu.com/p/a4fb6a02ad53" target="_blank" rel="noopener">Android 重学系列 View的绘制流程(五) onDraw</a></li>
</ul>
<p>实际上真正参与工作是从步骤2 绘制的准备开始的。<br>在ViewRootImpl的performTraversals方法中执行如下步骤：</p>
<ul>
<li><p>1.enableHardwareAcceleration 实例化ThreadedRenderer，同时构建RootRenderNode，RenderProxy，CanvasContext，DrawFrameTask等。并通过Looper开始监听Vsync信号.</p>
</li>
<li><p>2.initialize 在调用onMeasure遍历全局的View树之前，处理WindowInset之后。让渲染管道PipeLine能够持有Surface对象，从而可以通过Surface通信到SF进程中.</p>
</li>
<li><p>3.updateSurface 在调用onMeasure遍历全局的View树之前，处理WindowInset之后发现Surface参数发生了变化，更新硬件渲染PipeLine中的Surface。</p>
</li>
<li><p>4.setup 当初始化好PipeLine中的Surface，后启动ThreadedRenderer设置阴影等参数，处理RootRenderNode的左和上偏移量，也就是整个View树的左和上的偏移量。</p>
</li>
</ul>
<p>下面几个步骤是调用draw方法的时候，会判断是否能进行硬件渲染：</p>
<ul>
<li><p>5.如果需要 执行invalidateRoot 判断是否需要从根部开始遍历查找无效的元素，而判断的依据是整体硬件渲染树是否发生偏移</p>
</li>
<li><p>6.draw 开始硬件渲染进行View层级绘制，它包含如下几个步骤：-         </p>
<ul>
<li>1.updateRootDisplayList 从根部开始遍历整个View树</li>
<li>2.registerAnimatingRenderNode 注册每一个需要执行动画的RenderNode</li>
<li>3.nSetFrameCallback 把FrameDrawingCallback注册到native层</li>
<li>4.nSyncAndDrawFrame 调用native的开始把绘制操作进行合成像素存档到内存。</li>
<li>5.如果绘制结果返回SYNC_LOST_SURFACE_REWARD_IF_FOUND标志位，说明可能Surface无效或者出错，则关闭硬件渲染，释放VRI的mSurface等对象。如果SYNC_INVALIDATE_REQUIRED返回了，说明还需要下一轮的Loop通过performTravel进行局部刷新。</li>
</ul>
</li>
</ul>
<ul>
<li><p>7.updateDisplayListIfDirty 在updateRootDisplayList从根部开始遍历View树的过程中，每一个View都会调用该方法更新硬件渲染中的脏区。当PFLAG_DRAWING_CACHE_VALID 绘制缓存过期标志位关闭说明没有过期，则不需要通过执行一次draw，onDraw，dispatchDraw的流程，把绘制操作保存到RenderNode的DisplayList中等待合成。</p>
</li>
<li><p>8.destroy 销毁硬件渲染对象</p>
</li>
</ul>
<p>分析到了nSyncAndDrawFrame就暂时停止，下一篇文章将会接着本文继续聊聊硬件渲染是怎么合成这个操作，从Layer转化为Frame的。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/07/11/android-chong-xue-xi-lie-view-de-hui-zhi-liu-cheng-qi-ying-jian-xuan-ran-xia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="Android 重学系列 View的绘制流程(七) 硬件渲染(下)">
                        
                        <span class="card-title">Android 重学系列 View的绘制流程(七) 硬件渲染(下)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章，我们一直聊到了ThreadedRenderer的setFrameCallback方法，就停止下来了。本文继续沿着setFrameCallback的逻辑来看看ThreadedRenderer中做了什么。
我们继续考察下面这个代
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-07-11
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/View的绘制流程/" class="post-category">
                                    View的绘制流程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/06/14/android-chong-xue-xi-lie-view-de-hui-zhi-liu-cheng-san-ondraw/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Android 重学系列 View的绘制流程(三) onDraw">
                        
                        <span class="card-title">Android 重学系列 View的绘制流程(三) onDraw</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言之前已经和大家聊了onLayout的流程，本文将会继续聊一聊onDraw中做了什么？本文将集中关注软件渲染，关于Canvas的api源码解析暂时不会在本文聊，会专门开一个Skia源码解析进行分析。
正文performTravel的方法走
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-06-14
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/View的绘制流程/" class="post-category">
                                    View的绘制流程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
