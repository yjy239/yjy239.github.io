<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="存储性能优化 MMKV源码解析, Android | Linux | Flutter">
    <meta name="description" content="前言好久没有更新常用的第三方库了。让我们来聊聊MMKV这个常用的第三方库。MMKV这个库是做什么的呢？他本质上的定位和sp有点相似，经常用于持久化小数据的键值对。其速度可以说是当前所有同类型中速度最快，性能最优的库。
它的最早的诞生，主要是">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>存储性能优化 MMKV源码解析 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/21.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        存储性能优化 MMKV源码解析
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                            <a href="/tags/性能优化/">
                                <span class="chip bg-color">性能优化</span>
                            </a>
                        
                            <a href="/tags/Android-常用第三方库/">
                                <span class="chip bg-color">Android 常用第三方库</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/性能优化/" class="post-category">
                                性能优化
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-04-29
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        14k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        61 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>好久没有更新常用的第三方库了。让我们来聊聊MMKV这个常用的第三方库。MMKV这个库是做什么的呢？他本质上的定位和sp有点相似，经常用于持久化小数据的键值对。其速度可以说是当前所有同类型中速度最快，性能最优的库。</p>
<p>它的最早的诞生，主要是因为在微信iOS端有一个重大的bug，一个特殊的文本可以导致微信的iOS端闪退，而且还出现了不止一次。为了统计这种闪退的字符出现频率以及过滤，但是由于出现的次数，发现原来的键值对存储组件NSUserDefaults根本达不到要求，会导致cell的滑动卡顿。</p>
<p>因此iOS端就开始创造一个高新性能的键值对存储组件。于此同时，Android端SharedPreferences也有如下几个缺点：</p>
<ul>
<li><p>1.跨进程不安全 就算使用了MODE_MULTI_PROCESS，频繁的写入还是会会造成数据丢失。</p>
</li>
<li><p>2.加载缓慢 SharedPreferences使用异步加载，由于线程没有设置优先级，按照默认的线程优先级会造成时间片抢占机会小导致主线程长时间的等待。</p>
</li>
<li><p>3.全量写入 无论是调用 commit() 还是 apply()，即使我们只改动其中的一个条目，都会把整个内容全部写到文件</p>
</li>
<li><p>4.卡顿 由于提供了异步落盘的 apply 机制，在崩溃或者其他一些异常情况可能会导致数据丢失。所以当应用收到系统广播，或者被调用 onPause 等一些时机，系统会强制把所有的 SharedPreferences 对象数据落地到磁盘。如果没有落地完成，这时候主线程会被一直阻塞。这样非常容易造成卡顿，甚至是 ANR，从线上数据来看 SP 卡顿占比一般会超过 5%</p>
</li>
</ul>
<p>因此Android也开始复用iOS的MMKV，而后Android有了多进程的写入数据的需求，Android组又在这个基础上进行改进。</p>
<p>这里是官方的性能的比较图：</p>
<h3 id="Android端-1000次的读写性能比较："><a href="#Android端-1000次的读写性能比较：" class="headerlink" title="Android端 1000次的读写性能比较："></a>Android端 1000次的读写性能比较：</h3><p><img src="/images/mmkv_android%E6%AF%94%E8%BE%83.png" alt="mmkv_android比较.png"></p>
<h3 id="iOS-10000次的性能比较："><a href="#iOS-10000次的性能比较：" class="headerlink" title="iOS 10000次的性能比较："></a>iOS 10000次的性能比较：</h3><p><img src="/images/mmkv_iOS%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83.png" alt="mmkv_iOS性能比较.png"></p>
<p>能看到mmkv比起我们开发常用的组件要快上数百倍。</p>
<p>那么本文将会从源码角度围绕MMKV的性能为什么会如此高，以及SharePrefences为什么可能出现ANR的原因。</p>
<p>请注意下文是以MMKV 1.1.1版本源码为例子分析。如果遇到什么问题欢迎来到本文<a href="https://www.jianshu.com/p/c12290a9a3f7" target="_blank" rel="noopener">https://www.jianshu.com/p/c12290a9a3f7</a>互相讨论。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>老规矩，先来看看MMKV怎么使用。mmkv其实和SharePrefences一样，有增删查改四种操作。</p>
<h2 id="MMKV-前置知识"><a href="#MMKV-前置知识" class="headerlink" title="MMKV 前置知识"></a>MMKV 前置知识</h2><p>MMKV作为一个键值对存储组件，也对了存储对象的序列化方式进行了优化。常用的方式比如有json，Twitter的Serial。而MMKV使用的是Google开源的序列化方案:Protocol Buffers。</p>
<p>Protocol Buffers这个方案比起json来说就高级不少：</p>
<ul>
<li>1.从体积上，使用了二进制的压缩。比起json小上不少。</li>
<li>2.兼容性上，Protocol Buffers有自己的语法，可以跨语言跨平台。</li>
<li>3.使用成本上，比起json就要高上不少。需要定义.proto 文件，并用工具生成对应的辅助类。辅助类特有一些序列化的辅助方法，所有要序列化的对象，都需要先转化为辅助类的对象，这让序列化代码跟业务代码大量耦合，是侵入性较强的一种方式。</li>
</ul>
<p>使用方式可以阅读下面这篇文章：<a href="https://www.jianshu.com/p/e8712962f0e9" target="_blank" rel="noopener">https://www.jianshu.com/p/e8712962f0e9</a></p>
<p>下面进行比较几个对象序列化之间的要素比较<br>要素|Serial|JSON|Protocol Buffers<br>-|-|-|-<br>正确性|优|优|优<br>时间开销|良(Json&gt;性能&gt;Serializable)|良(性能&lt;Protocol Buffers)|优|<br>空间开销|良(对象序列化，空间较大)|良 (数据序列化,保留可读性牺牲空间)|优(二进制压缩)|<br>开发成本|良(比起Serializable麻烦需要额外接入)|良(对引用,继承支持有限)|差(不支持对象之间引用和继承)|<br>兼容性|良(和平台相关)|优(跨平台跨语言支持)|优(跨平台跨语言支持)|</p>
<p>而MMKV就是看重了Protocol Buffers的时间开销小，选择Protocol Buffers进行对象缓存的核心。</p>
<h2 id="MMKV的使用"><a href="#MMKV的使用" class="headerlink" title="MMKV的使用"></a>MMKV的使用</h2><p>使用前请初始化：</p>
<pre><code>MMKV.initialize(this)</code></pre><h4 id="mmkv写入键值对"><a href="#mmkv写入键值对" class="headerlink" title="mmkv写入键值对"></a>mmkv写入键值对</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">var</span> mmkv <span class="token operator">=</span> MMKV<span class="token punctuation">.</span><span class="token function">defaultMMKV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mmkv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"bool"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
mmkv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"int"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
mmkv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"String"</span><span class="token punctuation">,</span><span class="token string">"test"</span><span class="token punctuation">)</span>
mmkv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"float"</span><span class="token punctuation">,</span><span class="token number">1.0f</span><span class="token punctuation">)</span>
mmkv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"double"</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当然mmkv除了能够写入这些基本类型，只要SharePrefences支持的，它也一定能够支持。</p>
<h4 id="mmkv读取键值对"><a href="#mmkv读取键值对" class="headerlink" title="mmkv读取键值对"></a>mmkv读取键值对</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">var</span> mmkv <span class="token operator">=</span> MMKV<span class="token punctuation">.</span><span class="token function">defaultMMKV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> bo <span class="token operator">=</span> mmkv<span class="token punctuation">.</span><span class="token function">decodeBool</span><span class="token punctuation">(</span><span class="token string">"bool"</span><span class="token punctuation">)</span>
Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"bool:<span class="token interpolation"><span class="token delimiter variable">${</span>bo<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> i <span class="token operator">=</span> mmkv<span class="token punctuation">.</span><span class="token function">decodeInt</span><span class="token punctuation">(</span><span class="token string">"int"</span><span class="token punctuation">)</span>
Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"int:<span class="token interpolation"><span class="token delimiter variable">${</span>i<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> s <span class="token operator">=</span> mmkv<span class="token punctuation">.</span><span class="token function">decodeString</span><span class="token punctuation">(</span><span class="token string">"String"</span><span class="token punctuation">)</span>
Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"String:<span class="token interpolation"><span class="token delimiter variable">${</span>s<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> f <span class="token operator">=</span> mmkv<span class="token punctuation">.</span><span class="token function">decodeFloat</span><span class="token punctuation">(</span><span class="token string">"float"</span><span class="token punctuation">)</span>
Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"float:<span class="token interpolation"><span class="token delimiter variable">${</span>f<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> d <span class="token operator">=</span> mmkv<span class="token punctuation">.</span><span class="token function">decodeDouble</span><span class="token punctuation">(</span><span class="token string">"double"</span><span class="token punctuation">)</span>
Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"double:<span class="token interpolation"><span class="token delimiter variable">${</span>d<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同上，每一个key读取的数据类型就是decodexxx对应的类型名字。使用起来十分简单。</p>
<h4 id="mmkv-删除键值对和查键值对"><a href="#mmkv-删除键值对和查键值对" class="headerlink" title="mmkv 删除键值对和查键值对"></a>mmkv 删除键值对和查键值对</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">var</span> mmkv <span class="token operator">=</span> MMKV<span class="token punctuation">.</span><span class="token function">defaultMMKV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mmkv<span class="token punctuation">.</span><span class="token function">removeValueForKey</span><span class="token punctuation">(</span><span class="token string">"String"</span><span class="token punctuation">)</span>
mmkv<span class="token punctuation">.</span><span class="token function">removeValuesForKeys</span><span class="token punctuation">(</span><span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">"int"</span><span class="token punctuation">,</span><span class="token string">"bool"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
mmkv<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"String"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>能够删除单个key对应的value，也能删除多个key分别对应的value。containsKey判断mmkv的磁盘缓存中是否存在对应的key。</p>
<h4 id="mmkv的其他用法"><a href="#mmkv的其他用法" class="headerlink" title="mmkv的其他用法"></a>mmkv的其他用法</h4><p>mmkv和SharePrefences一样，还能根据模块和业务划分对应的缓存文件：</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">var</span> mmkv <span class="token operator">=</span> MMKV<span class="token punctuation">.</span><span class="token function">mmkvWithID</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>
mmkv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"String"</span><span class="token punctuation">,</span><span class="token string">"test111"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这里创建了一个id为a的实例在磁盘中，进行数据的缓存。</p>
<p>当需要多进程缓存的时候：</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">var</span> mmkv <span class="token operator">=</span> MMKV<span class="token punctuation">.</span><span class="token function">mmkvWithID</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span>MMKV<span class="token punctuation">.</span>MULTI_PROCESS_MODE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="MMKV使用Ashmem匿名内存"><a href="#MMKV使用Ashmem匿名内存" class="headerlink" title="MMKV使用Ashmem匿名内存"></a>MMKV使用Ashmem匿名内存</h5><p>MMKV可以使用Ashmem的匿名内存进行更加快速的大对象传输：<br>进程1：</p>
<pre class="line-numbers language-java"><code class="language-java">m_ashmemMMKV <span class="token operator">=</span> MMKV<span class="token punctuation">.</span><span class="token function">mmkvWithAshmemID</span><span class="token punctuation">(</span>BenchMarkBaseService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> AshmemMMKV_Size<span class="token punctuation">,</span>
                                                 MMKV<span class="token punctuation">.</span>MULTI_PROCESS_MODE<span class="token punctuation">,</span> CryptKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            m_ashmemMMKV<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"bool"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="MMKV迁移到SharePrefences"><a href="#MMKV迁移到SharePrefences" class="headerlink" title="MMKV迁移到SharePrefences"></a>MMKV迁移到SharePrefences</h5><p>最重要的一点，mmkv把SharePrefences的缓存迁移到mmkv中，之后的使用就和SharePrefences一致。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">var</span> preferences <span class="token operator">=</span> MMKV<span class="token punctuation">.</span><span class="token function">mmkvWithID</span><span class="token punctuation">(</span><span class="token string">"myData"</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> originPrefences <span class="token operator">=</span> <span class="token function">getSharedPreferences</span><span class="token punctuation">(</span><span class="token string">"myData"</span><span class="token punctuation">,</span> Context<span class="token punctuation">.</span>MODE_PRIVATE<span class="token punctuation">)</span>
        preferences<span class="token punctuation">.</span><span class="token function">importFromSharedPreferences</span><span class="token punctuation">(</span>originPrefences<span class="token punctuation">)</span>
        originPrefences<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里就是把SharedPreferences的myData数据迁移到mmkv中。当然如果我们需要保持SharePreferences的用法不变需要自己进行自定义一个SharePreferences。</p>
<p>mmkv的用法极其简单，接下来我们关注他的原理。</p>
<h2 id="MMKV-源码解析"><a href="#MMKV-源码解析" class="headerlink" title="MMKV 源码解析"></a>MMKV 源码解析</h2><p>首先来看看MMKV的初始化。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">initialize</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String root <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getFilesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/mmkv"</span><span class="token punctuation">;</span>
        MMKVLogLevel logLevel <span class="token operator">=</span> MMKVLogLevel<span class="token punctuation">.</span>LevelInfo<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">initialize</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token punctuation">(</span>MMKV<span class="token punctuation">.</span>LibLoader<span class="token punctuation">)</span>null<span class="token punctuation">,</span> logLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">initialize</span><span class="token punctuation">(</span>String rootDir<span class="token punctuation">,</span> LibLoader loader<span class="token punctuation">,</span> MMKVLogLevel logLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>BuildConfig<span class="token punctuation">.</span>FLAVOR<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"SharedCpp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                loader<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"c++_shared"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            loader<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"mmkv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>BuildConfig<span class="token punctuation">.</span>FLAVOR<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"SharedCpp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"c++_shared"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"mmkv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        MMKV<span class="token punctuation">.</span>rootDir <span class="token operator">=</span> rootDir<span class="token punctuation">;</span>
        <span class="token function">jniInitialize</span><span class="token punctuation">(</span>MMKV<span class="token punctuation">.</span>rootDir<span class="token punctuation">,</span> <span class="token function">logLevel2Int</span><span class="token punctuation">(</span>logLevel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rootDir<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上initialize分为如下几个步骤：</p>
<ul>
<li><p>1.创建一个app内的/data/data/包名/files/mmkv的目录。所有的文件都保存在里面。</p>
</li>
<li><p>2.加载两个so库，c++_shared以及mmkv。这里有点迷惑，c++_shared是什么条件加载的：</p>
<pre class="line-numbers language-gradle"><code class="language-gradle">defaultPublishConfig "StaticCppRelease"
flavorDimensions "stl_mode"
  productFlavors {
      StaticCpp {
          dimension "stl_mode"
          ext.artifactIdSuffix = 'static'
          externalNativeBuild {
              cmake {
                  arguments = ["-DANDROID_STL=c++_static"]
              }
          }
      }
      SharedCpp {
          dimension "stl_mode"
          ext.artifactIdSuffix = ''
          externalNativeBuild {
              cmake {
                  arguments = ["-DANDROID_STL=c++_shared"]
              }
          }
      }
  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到其实就是做这个判断。由于此时设置的是libc++的打包方式。此时BuildConfig.FLAVOR就是StaticCpp，就不会加载c++_shared。当然，如果我们已经使用了c++_shared库，则没有必要打包进去，使用defaultPublishConfig “SharedCppRelease”会尝试的查找动态链接库_shared。这样就能少2M的大小。</p>
</li>
<li><ol start="3">
<li>jniInitialize 初始化jni层,以及打印模块。</li>
</ol>
</li>
</ul>
<h3 id="MMKV-native层的初始化"><a href="#MMKV-native层的初始化" class="headerlink" title="MMKV native层的初始化"></a>MMKV native层的初始化</h3><p>请注意一个前提的知识，jni的初始化，在调用了  System.loadLibrary之后，会通过dlopen把so加载到内存后，调用dlsym，调用jni中的JNI_OnLoad方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span> JNIEXPORT JNICALL jint <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    g_currentJVM <span class="token operator">=</span> vm<span class="token punctuation">;</span>
    JNIEnv <span class="token operator">*</span>env<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> JNI_VERSION_1_6<span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>g_cls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteGlobalRef</span><span class="token punctuation">(</span>g_cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>clsName <span class="token operator">=</span> <span class="token string">"com/tencent/mmkv/MMKV"</span><span class="token punctuation">;</span>
    jclass <span class="token class-name">instance</span> <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span>clsName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to locate class: %s"</span><span class="token punctuation">,</span> clsName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    g_cls <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>jclass<span class="token operator">></span><span class="token punctuation">(</span>env<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewGlobalRef</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_cls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to create global reference for %s"</span><span class="token punctuation">,</span> clsName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">registerNativeMethods</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> g_cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to register native methods for class %s, ret = %d"</span><span class="token punctuation">,</span> clsName<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    g_fileID <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFieldID</span><span class="token punctuation">(</span>g_cls<span class="token punctuation">,</span> <span class="token string">"nativeHandle"</span><span class="token punctuation">,</span> <span class="token string">"J"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_fileID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to locate fileID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    g_callbackOnCRCFailID <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>g_cls<span class="token punctuation">,</span> <span class="token string">"onMMKVCRCCheckFail"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;)I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_callbackOnCRCFailID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to get method id for onMMKVCRCCheckFail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    g_callbackOnFileLengthErrorID <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>g_cls<span class="token punctuation">,</span> <span class="token string">"onMMKVFileLengthError"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;)I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_callbackOnFileLengthErrorID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to get method id for onMMKVFileLengthError"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    g_mmkvLogID <span class="token operator">=</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>g_cls<span class="token punctuation">,</span> <span class="token string">"mmkvLogImp"</span><span class="token punctuation">,</span> <span class="token string">"(ILjava/lang/String;ILjava/lang/String;Ljava/lang/String;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_mmkvLogID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to get method id for mmkvLogImp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    g_callbackOnContentChange <span class="token operator">=</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>g_cls<span class="token punctuation">,</span> <span class="token string">"onContentChangedByOuterProcess"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_callbackOnContentChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to get method id for onContentChangedByOuterProcess()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// get current API level by accessing android.os.Build.VERSION.SDK_INT</span>
    jclass <span class="token class-name">versionClass</span> <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"android/os/Build$VERSION"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>versionClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jfieldID sdkIntFieldID <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStaticFieldID</span><span class="token punctuation">(</span>versionClass<span class="token punctuation">,</span> <span class="token string">"SDK_INT"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sdkIntFieldID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            g_android_api <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStaticIntField</span><span class="token punctuation">(</span>versionClass<span class="token punctuation">,</span> sdkIntFieldID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">MMKVInfo</span><span class="token punctuation">(</span><span class="token string">"current API level = %d"</span><span class="token punctuation">,</span> g_android_api<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to get field id android.os.Build.VERSION.SDK_INT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to get class android.os.Build.VERSION"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// get CPU status of ARMv8 extensions (CRC32, AES)</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> __aarch64__</span>
    <span class="token keyword">auto</span> hwcaps <span class="token operator">=</span> <span class="token function">getauxval</span><span class="token punctuation">(</span>AT_HWCAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hwcaps <span class="token operator">&amp;</span> HWCAP_AES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        AES_set_encrypt_key <span class="token operator">=</span> openssl_aes_armv8_set_encrypt_key<span class="token punctuation">;</span>
        AES_encrypt <span class="token operator">=</span> openssl_aes_armv8_encrypt<span class="token punctuation">;</span>
        <span class="token function">MMKVInfo</span><span class="token punctuation">(</span><span class="token string">"armv8 AES instructions is supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hwcaps <span class="token operator">&amp;</span> HWCAP_CRC32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CRC32 <span class="token operator">=</span> mmkv<span class="token operator">::</span>armv8_crc32<span class="token punctuation">;</span>
        <span class="token function">MMKVInfo</span><span class="token punctuation">(</span><span class="token string">"armv8 CRC32 instructions is supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token keyword">return</span> JNI_VERSION_1_6<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上这里面做的事情十分简单：</p>
<ul>
<li>1.注册MMKV类在jni的反射对象，以及MMKV的java层对应的native方法：<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> JNINativeMethod g_methods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">{</span><span class="token string">"onExit"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>onExit<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"cryptKey"</span><span class="token punctuation">,</span> <span class="token string">"()Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>cryptKey<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"reKey"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>reKey<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"checkReSetCryptKey"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>checkReSetCryptKey<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"pageSize"</span><span class="token punctuation">,</span> <span class="token string">"()I"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>pageSize<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"mmapID"</span><span class="token punctuation">,</span> <span class="token string">"()Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>mmapID<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>lock<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"unlock"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>unlock<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"tryLock"</span><span class="token punctuation">,</span> <span class="token string">"()Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>tryLock<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"allKeys"</span><span class="token punctuation">,</span> <span class="token string">"()[Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>allKeys<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"removeValuesForKeys"</span><span class="token punctuation">,</span> <span class="token string">"([Ljava/lang/String;)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>removeValuesForKeys<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"clearAll"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>clearAll<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"trim"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>trim<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"close"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>close<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"clearMemoryCache"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>clearMemoryCache<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"sync"</span><span class="token punctuation">,</span> <span class="token string">"(Z)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>sync<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"isFileValid"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>isFileValid<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"ashmemFD"</span><span class="token punctuation">,</span> <span class="token string">"()I"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>ashmemFD<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"ashmemMetaFD"</span><span class="token punctuation">,</span> <span class="token string">"()I"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>ashmemMetaFD<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"jniInitialize"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;I)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>jniInitialize<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"getMMKVWithID"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;ILjava/lang/String;Ljava/lang/String;)J"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>getMMKVWithID<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"getMMKVWithIDAndSize"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;IILjava/lang/String;)J"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>getMMKVWithIDAndSize<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"getDefaultMMKV"</span><span class="token punctuation">,</span> <span class="token string">"(ILjava/lang/String;)J"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>getDefaultMMKV<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"getMMKVWithAshmemFD"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;IILjava/lang/String;)J"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>getMMKVWithAshmemFD<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"encodeBool"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;Z)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>encodeBool<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"decodeBool"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;Z)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>decodeBool<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"encodeInt"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;I)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>encodeInt<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"decodeInt"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;I)I"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>decodeInt<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"encodeLong"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;J)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>encodeLong<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"decodeLong"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;J)J"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>decodeLong<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"encodeFloat"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;F)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>encodeFloat<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"decodeFloat"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;F)F"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>decodeFloat<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"encodeDouble"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;D)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>encodeDouble<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"decodeDouble"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;D)D"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>decodeDouble<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"encodeString"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;Ljava/lang/String;)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>encodeString<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"decodeString"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;Ljava/lang/String;)Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>decodeString<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"encodeSet"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;[Ljava/lang/String;)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>encodeSet<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"decodeStringSet"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;)[Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>decodeStringSet<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"encodeBytes"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;[B)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>encodeBytes<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"decodeBytes"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;)[B"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>decodeBytes<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"containsKey"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>containsKey<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token string">"(J)J"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>count<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"totalSize"</span><span class="token punctuation">,</span> <span class="token string">"(J)J"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>totalSize<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"removeValueForKey"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>removeValueForKey<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"valueSize"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;Z)I"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>valueSize<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"setLogLevel"</span><span class="token punctuation">,</span> <span class="token string">"(I)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>setLogLevel<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"setCallbackHandler"</span><span class="token punctuation">,</span> <span class="token string">"(ZZ)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>setCallbackHandler<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"createNB"</span><span class="token punctuation">,</span> <span class="token string">"(I)J"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>createNB<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"destroyNB"</span><span class="token punctuation">,</span> <span class="token string">"(JI)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>destroyNB<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"writeValueToNB"</span><span class="token punctuation">,</span> <span class="token string">"(JLjava/lang/String;JI)I"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>writeValueToNB<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"setWantsContentChangeNotify"</span><span class="token punctuation">,</span> <span class="token string">"(Z)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>setWantsContentChangeNotify<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">"checkContentChangedByOuterProcess"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> mmkv<span class="token operator">::</span>checkContentChanged<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>static int registerNativeMethods(JNIEnv *env, jclass cls) {<br>    return env-&gt;RegisterNatives(cls, g_methods, sizeof(g_methods) / sizeof(g_methods[0]));<br>}</p>
<pre><code>能从这些native方法中看到了所有MMKV的存储方法，设置支持共享内存ashemem的存储，支持直接获取native malloc申请的内存

- 3.获取当前编译的版本号并且记录下来。

### MMKV jniInitialize
接下来就是MMKV正式的初始化方法了。
```cpp
MMKV_JNI void jniInitialize(JNIEnv *env, jobject obj, jstring rootDir, jint logLevel) {
    if (!rootDir) {
        return;
    }
    const char *kstr = env-&gt;GetStringUTFChars(rootDir, nullptr);
    if (kstr) {
        MMKV::initializeMMKV(kstr, (MMKVLogLevel) logLevel);
        env-&gt;ReleaseStringUTFChars(rootDir, kstr);
    }
}

void initialize() {
    g_instanceDic = new unordered_map&lt;string, MMKV *&gt;;
    g_instanceLock = new ThreadLock();
    g_instanceLock-&gt;initialize();

    mmkv::DEFAULT_MMAP_SIZE = mmkv::getPageSize();
    MMKVInfo("page size:%d", DEFAULT_MMAP_SIZE);
}

ThreadOnceToken_t once_control = ThreadOnceUninitialized;

void MMKV::initializeMMKV(const MMKVPath_t &amp;rootDir, MMKVLogLevel logLevel) {
    g_currentLogLevel = logLevel;

    ThreadLock::ThreadOnce(&amp;once_control, initialize);

    g_rootDir = rootDir;
    mkPath(g_rootDir);

    MMKVInfo("root dir: " MMKV_PATH_FORMAT, g_rootDir.c_str());
}</code></pre><ul>
<li>1.获取rootDir的url char指针数组字符串，调用MMKV::initializeMMKV进一步初始化。</li>
<li>2.调用ThreadLock::ThreadOnce调用方法指针initialize进行初始化。在方法指针initialize中，则是初始化了一个全局的线程锁ThreadLock。以及一个全局的散列表g_instanceDic。在MMKV中，设置好每一页(page)的大小，一般来说我们在32位的机子中一页都是4kb大小。设置一个全局的打印对象g_currentLogLevel。</li>
</ul>
<p>这个方法实际上调用的是pthread_once方法。它一般是在多线程环境中，根据内核的调度策略，选择一个线程初始化一次的方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">ThreadLock<span class="token operator">::</span><span class="token function">ThreadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pthread_mutexattr_t attr<span class="token punctuation">;</span>
    <span class="token function">pthread_mutexattr_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutexattr_settype</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> PTHREAD_MUTEX_RECURSIVE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_lock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_mutexattr_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>3.mkPath根据路径创建文件夹</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">extern</span> <span class="token keyword">bool</span> <span class="token function">mkPath</span><span class="token punctuation">(</span><span class="token keyword">const</span> MMKVPath_t <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>path <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">struct</span> stat sb <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>slash <span class="token operator">=</span> path<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      slash <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>slash<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      slash <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strcspn</span><span class="token punctuation">(</span>slash<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      done <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>slash <span class="token operator">==</span> <span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sb<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> ENOENT <span class="token operator">||</span> <span class="token function">mkdir</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">MMKVWarning</span><span class="token punctuation">(</span><span class="token string">"%s : %s"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">free</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">MMKVWarning</span><span class="token punctuation">(</span><span class="token string">"%s: %s"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ENOTDIR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">free</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">free</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实这里面的算法很简单：</p>
</li>
<li><p>1.strdup拷贝一份字符串到path中。</p>
</li>
<li><p>2.strspn 是一直找到匹配字符串，直到出现第一个不是”/“</p>
</li>
<li><p>3.strcspn 则是一直找不匹配的字符串，直到出现第一个“/”<br>经过这样拆解，就能把路径一个个分割开。通过这中方式就能直到什么时候遍历完整个路径。</p>
</li>
<li><p>4.stat获取path每一个文件夹的权限状态，必须保证每一级别的文件都是0777，也就是读写执行全部权限打开。</p>
</li>
</ul>
<h3 id="MMKV-的实例化-defaultMMKV与mmkvWithID"><a href="#MMKV-的实例化-defaultMMKV与mmkvWithID" class="headerlink" title="MMKV 的实例化 defaultMMKV与mmkvWithID"></a>MMKV 的实例化 defaultMMKV与mmkvWithID</h3><h4 id="MMKV-java层的实例化"><a href="#MMKV-java层的实例化" class="headerlink" title="MMKV java层的实例化"></a>MMKV java层的实例化</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> MMKV <span class="token function">defaultMMKV</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rootDir <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"You should Call MMKV.initialize() first."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">long</span> handle <span class="token operator">=</span> <span class="token function">getDefaultMMKV</span><span class="token punctuation">(</span>SINGLE_PROCESS_MODE<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MMKV</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>defaultMMKV此时调用的是getDefaultMMKV这个native方法，默认是单进程模式。从这里的设计都能猜到getDefaultMMKV会从native层实例化一个MMKV对象，并且让实例化好的Java层MMKV对象持有。之后Java层的方法和native层的方法一一映射就能实现一个直接操作native对象的Java对象。</p>
<p>我们再来看看MMKV的mmkvWithID。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> MMKV <span class="token function">mmkvWithID</span><span class="token punctuation">(</span>String mmapID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rootDir <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"You should Call MMKV.initialize() first."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">long</span> handle <span class="token operator">=</span> <span class="token function">getMMKVWithID</span><span class="token punctuation">(</span>mmapID<span class="token punctuation">,</span> SINGLE_PROCESS_MODE<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MMKV</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>感觉上和defaultMMKV有点相似，也是调用native层方法进行初始化，并且让java层MMKV对象持有native层。那么我们可否认为这两个实例化本质上在底层调用同一个方法，只是多了一个id设置呢？</p>
<h4 id="MMKV-native层实例化"><a href="#MMKV-native层实例化" class="headerlink" title="MMKV native层实例化"></a>MMKV native层实例化</h4><pre class="line-numbers language-cpp"><code class="language-cpp">MMKV_JNI jlong <span class="token function">getDefaultMMKV</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">,</span> jint mode<span class="token punctuation">,</span> jstring cryptKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MMKV <span class="token operator">*</span>kv <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cryptKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        string crypt <span class="token operator">=</span> <span class="token function">jstring2string</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cryptKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>crypt<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            kv <span class="token operator">=</span> MMKV<span class="token operator">::</span><span class="token function">defaultMMKV</span><span class="token punctuation">(</span><span class="token punctuation">(</span>MMKVMode<span class="token punctuation">)</span> mode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>crypt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kv <span class="token operator">=</span> MMKV<span class="token operator">::</span><span class="token function">defaultMMKV</span><span class="token punctuation">(</span><span class="token punctuation">(</span>MMKVMode<span class="token punctuation">)</span> mode<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>jlong<span class="token punctuation">)</span> kv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">define</span> DEFAULT_MMAP_ID "mmkv.default"</span>

MMKV <span class="token operator">*</span>MMKV<span class="token operator">::</span><span class="token function">defaultMMKV</span><span class="token punctuation">(</span>MMKVMode mode<span class="token punctuation">,</span> string <span class="token operator">*</span>cryptKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> MMKV_ANDROID</span>
    <span class="token keyword">return</span> <span class="token function">mmkvWithID</span><span class="token punctuation">(</span>DEFAULT_MMAP_ID<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> cryptKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
    <span class="token keyword">return</span> <span class="token function">mmkvWithID</span><span class="token punctuation">(</span>DEFAULT_MMAP_ID<span class="token punctuation">,</span> DEFAULT_MMAP_SIZE<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> cryptKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看看MMKV.h文件：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">static</span> MMKV <span class="token operator">*</span><span class="token function">mmkvWithID</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string <span class="token operator">&amp;</span>mmapID<span class="token punctuation">,</span>
                            <span class="token keyword">int</span> size <span class="token operator">=</span> mmkv<span class="token operator">::</span>DEFAULT_MMAP_SIZE<span class="token punctuation">,</span>
                            MMKVMode mode <span class="token operator">=</span> MMKV_SINGLE_PROCESS<span class="token punctuation">,</span>
                            std<span class="token operator">::</span>string <span class="token operator">*</span>cryptKey <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span>
                            MMKVPath_t <span class="token operator">*</span>relativePath <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里就能看到上面的推测是正确的，只要是实例化，最后都是调用mmkvWithID进行实例化。默认的mmkv的id就是mmkv.default。Android端则会设置一个默认的page大小,假设4kb为例子。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#    <span class="token directive keyword">define</span> string2MMKVPath_t(str) (str)</span>

string <span class="token function">mmapedKVKey</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>mmapID<span class="token punctuation">,</span> MMKVPath_t <span class="token operator">*</span>relativePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>relativePath <span class="token operator">&amp;&amp;</span> g_rootDir <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token operator">*</span>relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token operator">*</span>relativePath <span class="token operator">+</span> MMKV_PATH_SLASH <span class="token operator">+</span> <span class="token function">string2MMKVPath_t</span><span class="token punctuation">(</span>mmapID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mmapID<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


MMKV <span class="token operator">*</span>MMKV<span class="token operator">::</span><span class="token function">mmkvWithID</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>mmapID<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> MMKVMode mode<span class="token punctuation">,</span> string <span class="token operator">*</span>cryptKey<span class="token punctuation">,</span> string <span class="token operator">*</span>relativePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mmapID<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>g_instanceLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> mmapKey <span class="token operator">=</span> <span class="token function">mmapedKVKey</span><span class="token punctuation">(</span>mmapID<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> itr <span class="token operator">=</span> g_instanceDic<span class="token operator">-</span><span class="token operator">></span><span class="token function">find</span><span class="token punctuation">(</span>mmapKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>itr <span class="token operator">!=</span> g_instanceDic<span class="token operator">-</span><span class="token operator">></span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MMKV <span class="token operator">*</span>kv <span class="token operator">=</span> itr<span class="token operator">-</span><span class="token operator">></span>second<span class="token punctuation">;</span>
        <span class="token keyword">return</span> kv<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFileExist</span><span class="token punctuation">(</span><span class="token operator">*</span>relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mkPath</span><span class="token punctuation">(</span><span class="token operator">*</span>relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">MMKVInfo</span><span class="token punctuation">(</span><span class="token string">"prepare to load %s (id %s) from relativePath %s"</span><span class="token punctuation">,</span> mmapID<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mmapKey<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 relativePath<span class="token operator">-</span><span class="token operator">></span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">auto</span> kv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MMKV</span><span class="token punctuation">(</span>mmapID<span class="token punctuation">,</span> size<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> cryptKey<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>g_instanceDic<span class="token punctuation">)</span><span class="token punctuation">[</span>mmapKey<span class="token punctuation">]</span> <span class="token operator">=</span> kv<span class="token punctuation">;</span>
    <span class="token keyword">return</span> kv<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所有的mmkvID以及对应的MMKV实例都会保存在之前实例化的g_instanceDic散列表中。其中mmkv每一个id对应一个文件的路径，其中路径是这么处理的：</p>
<blockquote>
<p>相对路径(android中是 data/data/包名/files/mmkv) + / + mmkvID</p>
</blockquote>
<p>如果发现对应路径下的mmkv在散列表中已经缓存了，则直接返回。否则就会把相对路径保存下来，传递给MMKV进行实例化，并保存在g_instanceDic散列表中。</p>
<h3 id="MMKV-的构造函数"><a href="#MMKV-的构造函数" class="headerlink" title="MMKV 的构造函数"></a>MMKV 的构造函数</h3><pre class="line-numbers language-cpp"><code class="language-cpp">MMKV<span class="token operator">::</span><span class="token function">MMKV</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>mmapID<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> MMKVMode mode<span class="token punctuation">,</span> string <span class="token operator">*</span>cryptKey<span class="token punctuation">,</span> string <span class="token operator">*</span>relativePath<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">m_mmapID</span><span class="token punctuation">(</span><span class="token function">mmapedKVKey</span><span class="token punctuation">(</span>mmapID<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// historically Android mistakenly use mmapKey as mmapID</span>
    <span class="token punctuation">,</span> <span class="token function">m_path</span><span class="token punctuation">(</span><span class="token function">mappedKVPathWithID</span><span class="token punctuation">(</span>m_mmapID<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">m_crcPath</span><span class="token punctuation">(</span><span class="token function">crcPathWithID</span><span class="token punctuation">(</span>m_mmapID<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">m_file</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">MemoryFile</span><span class="token punctuation">(</span>m_path<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> MMKV_ASHMEM<span class="token punctuation">)</span> <span class="token operator">?</span> MMFILE_TYPE_ASHMEM <span class="token operator">:</span> MMFILE_TYPE_FILE<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">m_metaFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">MemoryFile</span><span class="token punctuation">(</span>m_crcPath<span class="token punctuation">,</span> DEFAULT_MMAP_SIZE<span class="token punctuation">,</span> m_file<span class="token operator">-</span><span class="token operator">></span>m_fileType<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">m_metaInfo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">MMKVMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">m_crypter</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">m_lock</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ThreadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">m_fileLock</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">FileLock</span><span class="token punctuation">(</span>m_metaFile<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> MMKV_ASHMEM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">m_sharedProcessLock</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">InterProcessLock</span><span class="token punctuation">(</span>m_fileLock<span class="token punctuation">,</span> SharedLockType<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">m_exclusiveProcessLock</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">InterProcessLock</span><span class="token punctuation">(</span>m_fileLock<span class="token punctuation">,</span> ExclusiveLockType<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">m_isInterProcess</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> MMKV_MULTI_PROCESS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> CONTEXT_MODE_MULTI_PROCESS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m_actualSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    m_output <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cryptKey <span class="token operator">&amp;&amp;</span> cryptKey<span class="token operator">-</span><span class="token operator">></span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_crypter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">AESCrypt</span><span class="token punctuation">(</span>cryptKey<span class="token operator">-</span><span class="token operator">></span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cryptKey<span class="token operator">-</span><span class="token operator">></span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    m_needLoadFromFile <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    m_hasFullWriteback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    m_crcDigest <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    m_sharedProcessLock<span class="token operator">-</span><span class="token operator">></span>m_enable <span class="token operator">=</span> m_isInterProcess<span class="token punctuation">;</span>
    m_exclusiveProcessLock<span class="token operator">-</span><span class="token operator">></span>m_enable <span class="token operator">=</span> m_isInterProcess<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// sensitive zone</span>
    <span class="token punctuation">{</span>
        <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_sharedProcessLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">loadFromFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们来看看MMKV构造函数中几个关键的字段是怎么初始化。</p>
<ul>
<li><p>1.m_mmapID MMKV的ID通过mmapedKVKey创建：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">string <span class="token function">mmapedKVKey</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>mmapID<span class="token punctuation">,</span> MMKVPath_t <span class="token operator">*</span>relativePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>relativePath <span class="token operator">&amp;&amp;</span> g_rootDir <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token operator">*</span>relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token operator">*</span>relativePath <span class="token operator">+</span> MMKV_PATH_SLASH <span class="token operator">+</span> <span class="token function">string2MMKVPath_t</span><span class="token punctuation">(</span>mmapID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> mmapID<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>mmkvID就是经过md5后对应缓存文件对应的路径。</p>
</li>
<li><p>2.m_path mmkv 缓存的路径通过mappedKVPathWithID生成</p>
</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp">MMKVPath_t <span class="token function">mappedKVPathWithID</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>mmapID<span class="token punctuation">,</span> MMKVMode mode<span class="token punctuation">,</span> MMKVPath_t <span class="token operator">*</span>relativePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> MMKV_ANDROID</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> MMKV_ASHMEM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">ashmemMMKVPathWithID</span><span class="token punctuation">(</span><span class="token function">encodeFilePath</span><span class="token punctuation">(</span>mmapID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">return</span> <span class="token operator">*</span>relativePath <span class="token operator">+</span> MMKV_PATH_SLASH <span class="token operator">+</span> <span class="token function">encodeFilePath</span><span class="token punctuation">(</span>mmapID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> g_rootDir <span class="token operator">+</span> MMKV_PATH_SLASH <span class="token operator">+</span> <span class="token function">encodeFilePath</span><span class="token punctuation">(</span>mmapID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里是根据当前的mode初始化id，如果不是ashmem匿名共享内存模式进行创建，则会和上面的处理类似。id就是经过md5后对应缓存文件对应的路径。</p>
<p>注意这里mode设置的是MMKV_ASHMEM，也就是ashmem匿名共享内存模式则是如下创建方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">constexpr</span> <span class="token keyword">char</span> ASHMEM_NAME_DEF<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/dev/ashmem"</span><span class="token punctuation">;</span>

MMKVPath_t <span class="token function">ashmemMMKVPathWithID</span><span class="token punctuation">(</span><span class="token keyword">const</span> MMKVPath_t <span class="token operator">&amp;</span>mmapID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">MMKVPath_t</span><span class="token punctuation">(</span>ASHMEM_NAME_DEF<span class="token punctuation">)</span> <span class="token operator">+</span> MMKV_PATH_SLASH <span class="token operator">+</span> mmapID<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就是在驱动目录下的一个内存文件地址。</p>
<ul>
<li>3.m_crcPath 一个.crc文件的路径。这个crc文件实际上用于保存crc数据校验key，避免出现传输异常的数据进行保存了。</li>
<li>4.m_file 一个依据m_path构建的内存文件MemoryFile对象。</li>
<li>5.m_metaFile 一个依据m_crcPath构建的内存文件MemoryFile对象。</li>
<li>6.m_metaInfo 一个MMKVMetaInfo结构体，这个结构体一般是读写的时候，带上的MMKV的版本信息，映射的内存大小，加密crc的key等。</li>
<li>7.m_crypter 默认是一个AESCrypt 对称加密器</li>
<li>8.m_lock ThreadLock线程锁</li>
<li>9.m_fileLock 一个以m_metaFile的fd 文件锁</li>
<li>10.m_sharedProcessLock 类型是InterProcessLock，这是一种文件共享锁</li>
<li>11.m_exclusiveProcessLock 类型是InterProcessLock，这是一种排他锁</li>
<li>12.m_isInterProcess 判断是否打开了多进程模式的标志位，一旦关闭了，所有进程锁都会失效。</li>
</ul>
<p>接下来，在构造函数中使用了共享的文件锁进行保护后，调用loadFromFile进一步的初始化MMKV内部的数据。</p>
<p>我们大致的了解MMKV中每一个字段的负责的职责，但是具体如何进行工作下文都会解析。</p>
<p>在这里面我们遇到了看起来十分核心的类MemoryFile，它的名字有点像<a href="https://www.jianshu.com/p/6a8513fdb792" target="_blank" rel="noopener">Ashmem匿名共享内存</a>一文中描述过Java层的映射的匿名内存文件。</p>
<p>我们先来看看MemoryFile的初始化。</p>
<h3 id="MemoryFile的初始化"><a href="#MemoryFile的初始化" class="headerlink" title="MemoryFile的初始化"></a>MemoryFile的初始化</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">constexpr</span> <span class="token keyword">char</span> ASHMEM_NAME_DEF<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/dev/ashmem"</span><span class="token punctuation">;</span>

MemoryFile<span class="token operator">::</span><span class="token function">MemoryFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>path<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> FileType fileType<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">m_name</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_fd</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_ptr</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_fileType</span><span class="token punctuation">(</span>fileType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_fileType <span class="token operator">==</span> MMFILE_TYPE_FILE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reloadFromFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// round up to (n * pagesize)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> DEFAULT_MMAP_SIZE <span class="token operator">||</span> <span class="token punctuation">(</span>size <span class="token operator">%</span> DEFAULT_MMAP_SIZE <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">/</span> DEFAULT_MMAP_SIZE<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> DEFAULT_MMAP_SIZE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">auto</span> filename <span class="token operator">=</span> m_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> ptr <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> ASHMEM_NAME_DEF<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">&amp;&amp;</span> ptr<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ASHMEM_NAME_DEF<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            filename <span class="token operator">=</span> ptr <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ASHMEM_NAME_DEF<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        m_fd <span class="token operator">=</span> <span class="token function">ASharedMemory_create</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_fd <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m_size <span class="token operator">=</span> size<span class="token punctuation">;</span>
            <span class="token keyword">auto</span> ret <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">doCleanMemoryCache</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>MemeoryFile分为两个模式进行初始化：</p>
<h5 id="1-按照普通的内存文件进行映射到内存"><a href="#1-按照普通的内存文件进行映射到内存" class="headerlink" title="1.按照普通的内存文件进行映射到内存"></a>1.按照普通的内存文件进行映射到内存</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MemoryFile<span class="token operator">::</span><span class="token function">reloadFromFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    m_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>m_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">,</span> S_IRWXU<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to open:%s, %s"</span><span class="token punctuation">,</span> m_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        FileLock <span class="token function">fileLock</span><span class="token punctuation">(</span>m_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        InterProcessLock <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fileLock<span class="token punctuation">,</span> ExclusiveLockType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mmkv<span class="token operator">::</span><span class="token function">getFileSize</span><span class="token punctuation">(</span>m_fd<span class="token punctuation">,</span> m_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// round up to (n * pagesize)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_size <span class="token operator">&lt;</span> DEFAULT_MMAP_SIZE <span class="token operator">||</span> <span class="token punctuation">(</span>m_size <span class="token operator">%</span> DEFAULT_MMAP_SIZE <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size_t roundSize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_size <span class="token operator">/</span> DEFAULT_MMAP_SIZE<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> DEFAULT_MMAP_SIZE<span class="token punctuation">;</span>
            <span class="token function">truncate</span><span class="token punctuation">(</span>roundSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> ret <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">doCleanMemoryCache</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的处理很简单：</p>
<ul>
<li><p>1.首先尝试的打开该路径下file文件,如果fd小于0，说明file没有真正的创建过，则会调用mmap方法在内存中进行映射对应大小的内存。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> MemoryFile<span class="token operator">::</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  m_ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">::</span><span class="token function">mmap</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">,</span> m_size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> m_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to mmap [%s], %s"</span><span class="token punctuation">,</span> m_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      m_ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时将会调用mmap系统调用，通过设置标志位可读写，MAP_SHARED的模式进行打开。这样就file就在在内核中映射了一段4kb内存，以后访问文件可以不经过内核，直接访问file映射的这一段内存。</p>
</li>
</ul>
<p>关于mmap系统调用的源码解析可以看这一篇<a href="https://www.jianshu.com/p/4399aedb4d42" target="_blank" rel="noopener">Binder驱动的初始化 映射原理</a>。</p>
<ul>
<li><p>2.如果此时对应的内存文件已经映射过了，将会检测其大小是否是为0，或者是不是刚好是4kb的倍数。如果不是，则找到当前大小最近的4kb倍数同感ftruncate系统调用进行扩容。这样就能保证mmap映射的数据是整齐的页的倍数。这么做就能有效的减少内存碎片。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> MemoryFile<span class="token operator">::</span><span class="token function">truncate</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">auto</span> oldSize <span class="token operator">=</span> m_size<span class="token punctuation">;</span>
  m_size <span class="token operator">=</span> size<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// round up to (n * pagesize)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_size <span class="token operator">&lt;</span> DEFAULT_MMAP_SIZE <span class="token operator">||</span> <span class="token punctuation">(</span>m_size <span class="token operator">%</span> DEFAULT_MMAP_SIZE <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      m_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_size <span class="token operator">/</span> DEFAULT_MMAP_SIZE<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> DEFAULT_MMAP_SIZE<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">::</span><span class="token function">ftruncate</span><span class="token punctuation">(</span>m_fd<span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>off_t<span class="token operator">></span><span class="token punctuation">(</span>m_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to truncate [%s] to size %zu, %s"</span><span class="token punctuation">,</span> m_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_size<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      m_size <span class="token operator">=</span> oldSize<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_size <span class="token operator">></span> oldSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">zeroFillFile</span><span class="token punctuation">(</span>m_fd<span class="token punctuation">,</span> oldSize<span class="token punctuation">,</span> m_size <span class="token operator">-</span> oldSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to zeroFile [%s] to size %zu, %s"</span><span class="token punctuation">,</span> m_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_size<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          m_size <span class="token operator">=</span> oldSize<span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">munmap</span><span class="token punctuation">(</span>m_ptr<span class="token punctuation">,</span> oldSize<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to munmap [%s], %s"</span><span class="token punctuation">,</span> m_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">auto</span> ret <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">doCleanMemoryCache</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个过程中实际上还是通过ftruncate进行扩容，接着调用zeroFillFile，先通过lseek把指针移动当前容量的最后，并把剩余的部分都填充空数据’\0’。最后映射指向的地址是有效的，会先解开后重新进行映射。</p>
</li>
</ul>
<p>为什么要做最后这个步骤呢？如果阅读过我解析的mmap的源码一文，实际上就能明白，file使用MAP_SHARED的模式本质上是给file结构体绑定一段vma映射好的内存。ftruncate只是给file结构体进行了扩容，但是还没有对对应绑定虚拟内存进行扩容，因此需要解开一次映射后，重新mmap一次。</p>
<h5 id="2-通过Ashmem驱动映射一段共享匿名内存"><a href="#2-通过Ashmem驱动映射一段共享匿名内存" class="headerlink" title="2.通过Ashmem驱动映射一段共享匿名内存"></a>2.通过Ashmem驱动映射一段共享匿名内存</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">ASharedMemory_create</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>g_android_api <span class="token operator">>=</span> __ANDROID_API_O__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">auto</span> handle <span class="token operator">=</span> <span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> AShmem_create_t funcPtr <span class="token operator">=</span>
            <span class="token punctuation">(</span>handle <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>AShmem_create_t<span class="token operator">></span><span class="token punctuation">(</span><span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"ASharedMemory_create"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>funcPtr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fd <span class="token operator">=</span> <span class="token function">funcPtr</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to ASharedMemory_create %s with size %zu, errno:%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">MMKVWarning</span><span class="token punctuation">(</span><span class="token string">"fail to locate ASharedMemory_create() from loading libandroid.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>ASHMEM_NAME_DEF<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to open ashmem:%s, %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_SET_NAME<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to set ashmem name:%s, %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_SET_SIZE<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"fail to set ashmem:%s, size %zu, %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>MMKV在如果使用Ashmem模式打开：</p>
<ul>
<li><p>1.如果大于Android O就会从libandroid.so中查找ASharedMemory_create 描述符也就是方法地址，直接通过这个方法通过ashmem创建一个映射在ashmem驱动的内存。Ashmem驱动的核心原理请看<a href="https://www.jianshu.com/p/6a8513fdb792" target="_blank" rel="noopener">Ashmem匿名共享内存</a>。</p>
</li>
<li><p>2.否则则使用我在Ashmem的文章所说，按照三个步骤进行Ashmem驱动的映射，首先open打开在Ashmem中的映射，接着使用ASHMEM_SET_NAME给匿名内存命名，最后调用ASHMEM_SET_SIZE设置需要在Ashmem中映射的内存大小。</p>
</li>
</ul>
<p>接下来loadFromFile 这个方法可以说是MMKV的核心方法，所有的读写，还是扩容都需要这个方法，从映射的文件内存，缓存到MMKV的内存中。</p>
<h4 id="MMKV的初始化-loadFromFile"><a href="#MMKV的初始化-loadFromFile" class="headerlink" title="MMKV的初始化 loadFromFile"></a>MMKV的初始化 loadFromFile</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MMKV<span class="token operator">::</span><span class="token function">loadFromFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_metaFile<span class="token operator">-</span><span class="token operator">></span><span class="token function">isFileValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_metaInfo<span class="token operator">-</span><span class="token operator">></span><span class="token function">read</span><span class="token punctuation">(</span>m_metaFile<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_crypter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_version <span class="token operator">>=</span> MMKVVersionRandomIV<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m_crypter<span class="token operator">-</span><span class="token operator">></span><span class="token function">resetIV</span><span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_vector<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_vector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">isFileValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">reloadFromFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">isFileValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"file [%s] not valid"</span><span class="token punctuation">,</span> m_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// error checking</span>
        <span class="token keyword">bool</span> loadFromFile <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> needFullWriteback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">checkDataValid</span><span class="token punctuation">(</span>loadFromFile<span class="token punctuation">,</span> needFullWriteback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">auto</span> ptr <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// loading</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadFromFile <span class="token operator">&amp;&amp;</span> m_actualSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            MMBuffer <span class="token function">inputBuffer</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> Fixed32Size<span class="token punctuation">,</span> m_actualSize<span class="token punctuation">,</span> MMBufferNoCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_crypter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">decryptBuffer</span><span class="token punctuation">(</span><span class="token operator">*</span>m_crypter<span class="token punctuation">,</span> inputBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">clearDictionary</span><span class="token punctuation">(</span>m_dic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>needFullWriteback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                MiniPBCoder<span class="token operator">::</span><span class="token function">greedyDecodeMap</span><span class="token punctuation">(</span>m_dic<span class="token punctuation">,</span> inputBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                MiniPBCoder<span class="token operator">::</span><span class="token function">decodeMap</span><span class="token punctuation">(</span>m_dic<span class="token punctuation">,</span> inputBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            m_output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CodedOutputData</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> Fixed32Size<span class="token punctuation">,</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> Fixed32Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            m_output<span class="token operator">-</span><span class="token operator">></span><span class="token function">seek</span><span class="token punctuation">(</span>m_actualSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>needFullWriteback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fullWriteback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// file not valid or empty, discard everything</span>
            <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_exclusiveProcessLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

            m_output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CodedOutputData</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> Fixed32Size<span class="token punctuation">,</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> Fixed32Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_actualSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">writeActualSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> IncreaseSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">sync</span><span class="token punctuation">(</span>MMKV_SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">writeActualSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> KeepSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    m_needLoadFromFile <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>进入到这个方法后进行如下的处理：</p>
<ul>
<li><p>1.从m_metaFile内存文件中获取当前MMKV实例的配置保存到m_metaInfo 这个MMKVMetaInfo结构体中。由于是第一次实例化这个时候，内容全是空。稍微看看这个结构体的内容：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> MMKVMetaInfo <span class="token punctuation">{</span>
  uint32_t m_crcDigest <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//crc校验的数据</span>
  uint32_t m_version <span class="token operator">=</span> MMKVVersionSequence<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//MMKV的状态MMKVVersionSequence = 1,</span>
  uint32_t m_sequence <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// full write-back count</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> m_vector<span class="token punctuation">[</span>AES_KEY_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//aes的加密key</span>
  uint32_t m_actualSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//真实的大小</span>

  <span class="token comment" spellcheck="true">// confirmed info: it's been synced to file</span>
  <span class="token keyword">struct</span> <span class="token punctuation">{</span>
      uint32_t lastActualSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      uint32_t lastCRCDigest <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      uint32_t __reserved__<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> m_lastConfirmedMetaInfo<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//已经同步到文件的数据</span>

  <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">MMKV_ASSERT</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>MMKVMetaInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">writeCRCAndActualSizeOnly</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">MMKV_ASSERT</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">auto</span> other <span class="token operator">=</span> <span class="token punctuation">(</span>MMKVMetaInfo <span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
      other<span class="token operator">-</span><span class="token operator">></span>m_crcDigest <span class="token operator">=</span> m_crcDigest<span class="token punctuation">;</span>
      other<span class="token operator">-</span><span class="token operator">></span>m_actualSize <span class="token operator">=</span> m_actualSize<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">MMKV_ASSERT</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>MMKVMetaInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>在这里，遇到了一个比较有歧义的字段m_version ，从名字看起来有点像MMKV的版本号。其实它指代的是MMKV当前的状态，由一个枚举对象代表：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">enum</span> MMKVVersion <span class="token operator">:</span> uint32_t <span class="token punctuation">{</span>
    MMKVVersionDefault <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 记录当前MMKV的完整写回次数</span>
    MMKVVersionSequence <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 对随机数据进行加密存储</span>
    MMKVVersionRandomIV <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 保存了crc校验和存储存储大小，避免文件损坏</span>
    MMKVVersionActualSize <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>2.m_crypter不为空，则判断m_metaInfo中的m_version号是否大于等于2(MMKVVersionRandomIV)，是则调用resetIV方法进行aes加密的初始化。<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">constexpr</span> size_t AES_KEY_LEN <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> AESCrypt<span class="token operator">::</span><span class="token function">resetIV</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>iv<span class="token punctuation">,</span> size_t ivLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  m_number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iv <span class="token operator">&amp;&amp;</span> ivLength <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>m_vector<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> <span class="token punctuation">(</span>ivLength <span class="token operator">></span> AES_KEY_LEN<span class="token punctuation">)</span> <span class="token operator">?</span> AES_KEY_LEN <span class="token operator">:</span> ivLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>m_vector<span class="token punctuation">,</span> m_key<span class="token punctuation">,</span> AES_KEY_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
注意m_vector是一个长度16的char数组。其实很简单，就是把文件保存的m_vector获取16位拷贝到m_metaInfo的m_vector中。因为aes的加密必须以16的倍数才能正常运作。</li>
</ul>
<ul>
<li><p>3.m_file 真正工作的内存文件发现fd申请的有问题，就重新读取文件映射。</p>
</li>
<li><p>4.调用checkDataValid进行MMKV的初始化数据的检测。同时获取到两个标志位loadFromFile 代表是否从能从m_file中正常读取；needFullWriteback是否需要一口气完全写回到内存。</p>
</li>
<li><p>5.如果成功读取MemoryFile中的数据，且缓存的数据大小大于0.接下来将会获取内存文件中的数据保存到MMBuffer类中。并且调用AESCrypt的decryptBuffer解密MMBuffer中的内容。清空MMKV中存储键值对的m_dic散列表，并且从本地文件读取。</p>
</li>
<li><p>6.如果发现读取MemoryFile中的数据是空的，说明是第一次创建这个缓存文件，我们需要往m_metaFile写入当前MMKV的相关的信息。</p>
</li>
</ul>
<p>初始化分为这6点，我们从最后三点开始聊聊MMKV的初始化的核心逻辑。我们还需要开始关注MMKV中内存存储的结构。</p>
<h4 id="checkDataValid-校验MMKV数据有效性机制"><a href="#checkDataValid-校验MMKV数据有效性机制" class="headerlink" title="checkDataValid 校验MMKV数据有效性机制"></a>checkDataValid 校验MMKV数据有效性机制</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MMKV<span class="token operator">::</span><span class="token function">checkDataValid</span><span class="token punctuation">(</span><span class="token keyword">bool</span> <span class="token operator">&amp;</span>loadFromFile<span class="token punctuation">,</span> <span class="token keyword">bool</span> <span class="token operator">&amp;</span>needFullWriteback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// try auto recover from last confirmed location</span>
    <span class="token keyword">auto</span> fileSize <span class="token operator">=</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> checkLastConfirmedInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_version <span class="token operator">>=</span> MMKVVersionActualSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// downgrade &amp; upgrade support</span>
            uint32_t oldStyleActualSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oldStyleActualSize<span class="token punctuation">,</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Fixed32Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStyleActualSize <span class="token operator">!=</span> m_actualSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStyleActualSize <span class="token operator">&lt;</span> fileSize <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>oldStyleActualSize <span class="token operator">+</span> Fixed32Size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> fileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkFileCRCValid</span><span class="token punctuation">(</span>oldStyleActualSize<span class="token punctuation">,</span> m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_crcDigest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">auto</span> lastActualSize <span class="token operator">=</span> m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_lastConfirmedMetaInfo<span class="token punctuation">.</span>lastActualSize<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastActualSize <span class="token operator">&lt;</span> fileSize <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>lastActualSize <span class="token operator">+</span> Fixed32Size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> fileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">auto</span> lastCRCDigest <span class="token operator">=</span> m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_lastConfirmedMetaInfo<span class="token punctuation">.</span>lastCRCDigest<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkFileCRCValid</span><span class="token punctuation">(</span>lastActualSize<span class="token punctuation">,</span> lastCRCDigest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    loadFromFile <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token function">writeActualSize</span><span class="token punctuation">(</span>lastActualSize<span class="token punctuation">,</span> lastCRCDigest<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> KeepSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    m_actualSize <span class="token operator">=</span> <span class="token function">readActualSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_actualSize <span class="token operator">&lt;</span> fileSize <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m_actualSize <span class="token operator">+</span> Fixed32Size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> fileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkFileCRCValid</span><span class="token punctuation">(</span>m_actualSize<span class="token punctuation">,</span> m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_crcDigest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            loadFromFile <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">checkLastConfirmedInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loadFromFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">auto</span> strategic <span class="token operator">=</span> <span class="token function">onMMKVCRCCheckFail</span><span class="token punctuation">(</span>m_mmapID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>strategic <span class="token operator">==</span> OnErrorRecover<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    loadFromFile <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    needFullWriteback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">checkLastConfirmedInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loadFromFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> strategic <span class="token operator">=</span> <span class="token function">onMMKVFileLengthError</span><span class="token punctuation">(</span>m_mmapID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>strategic <span class="token operator">==</span> OnErrorRecover<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// make sure we don't over read the file</span>
                m_actualSize <span class="token operator">=</span> fileSize <span class="token operator">-</span> Fixed32Size<span class="token punctuation">;</span>
                loadFromFile <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                needFullWriteback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.首先调用readActualSize尝试读取m_file中记录已经存储的数据长度。<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">constexpr</span> uint32_t LittleEdian32Size <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>constexpr uint32_t pbFixed32Size() {<br>    return LittleEdian32Size;<br>}</p>
<p>constexpr uint32_t Fixed32Size = pbFixed32Size();</p>
<pre><code>```cpp
size_t MMKV::readActualSize() {
    MMKV_ASSERT(m_file-&gt;getMemory());
    MMKV_ASSERT(m_metaFile-&gt;isFileValid());

    uint32_t actualSize = 0;
    memcpy(&amp;actualSize, m_file-&gt;getMemory(), Fixed32Size);

    if (m_metaInfo-&gt;m_version &gt;= MMKVVersionActualSize) {
        if (m_metaInfo-&gt;m_actualSize != actualSize) {
...
        }
        return m_metaInfo-&gt;m_actualSize;
    } else {
        return actualSize;
    }
}</code></pre><p>能看到首先从m_file获取映射的指针地址，往后读取4位数据。这4位数据就是actualSize 真实数据。但是如果是m_metaInfo的m_version 大于等于3，则获取m_metaInfo中保存的actualSize。</p>
<ul>
<li><p>2.如果读取的到已经存储的数据小于映射内存的大小，或者读取已经读取的数据+4小于等于映射的内存大小，说明可以继续往里面存储不需要扩容。需要进一步的通过checkFileCRCValid校验里面的数据数据是否异常。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> MMKV<span class="token operator">::</span><span class="token function">checkFileCRCValid</span><span class="token punctuation">(</span>size_t actualSize<span class="token punctuation">,</span> uint32_t crcDigest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> ptr <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      m_crcDigest <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> <span class="token function">CRC32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> uint8_t <span class="token operator">*</span><span class="token punctuation">)</span> ptr <span class="token operator">+</span> Fixed32Size<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> actualSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>m_crcDigest <span class="token operator">==</span> crcDigest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"check crc [%s] fail, crc32:%u, m_crcDigest:%u"</span><span class="token punctuation">,</span> m_mmapID<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> crcDigest<span class="token punctuation">,</span> m_crcDigest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其校验的手段，是通过比较m_metaInfo保存的crcDigest和从m_file中读取的crcDigest进行比较，如果一致说明数据无误，则返回true，设置loadFromFile为true。</p>
</li>
</ul>
<ul>
<li><p>2.如果crc校验失败则会调用进行如下代码段进行处理。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">auto</span> checkLastConfirmedInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_version <span class="token operator">>=</span> MMKVVersionActualSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// downgrade &amp; upgrade support</span>
          uint32_t oldStyleActualSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oldStyleActualSize<span class="token punctuation">,</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Fixed32Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStyleActualSize <span class="token operator">!=</span> m_actualSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStyleActualSize <span class="token operator">&lt;</span> fileSize <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>oldStyleActualSize <span class="token operator">+</span> Fixed32Size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> fileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkFileCRCValid</span><span class="token punctuation">(</span>oldStyleActualSize<span class="token punctuation">,</span> m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_crcDigest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                      <span class="token keyword">return</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">auto</span> lastActualSize <span class="token operator">=</span> m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_lastConfirmedMetaInfo<span class="token punctuation">.</span>lastActualSize<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>lastActualSize <span class="token operator">&lt;</span> fileSize <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>lastActualSize <span class="token operator">+</span> Fixed32Size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> fileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">auto</span> lastCRCDigest <span class="token operator">=</span> m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_lastConfirmedMetaInfo<span class="token punctuation">.</span>lastCRCDigest<span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkFileCRCValid</span><span class="token punctuation">(</span>lastActualSize<span class="token punctuation">,</span> lastCRCDigest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  loadFromFile <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                  <span class="token function">writeActualSize</span><span class="token punctuation">(</span>lastActualSize<span class="token punctuation">,</span> lastCRCDigest<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> KeepSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实这里面只处理m_metaInfo的m_version的状态大于等于3的状态。我们回忆一下，在readActualSize方法中，把读取当前存储的数据长度，分为两个逻辑进行读取。如果大于等于3，则从m_metaInfo中获取。</p>
</li>
</ul>
<p>crc校验失败，说明我们写入的时候发生异常。需要强制进行recover恢复数据。<br>首先要清除crc校验校验了什么东西：</p>
<blockquote>
<p>1.可以检测出所有奇数位的错。<br>2.可以检测出双比特的错<br>3.可以检测出小于等于检测校验长度的突发错</p>
</blockquote>
<p>MMKV做了如下处理，只处理状态等级在MMKVVersionActualSize情况。这个情况，在m_metaInfo记录上一次MMKV中的信息。因此可以通过m_metaInfo进行校验已经存储的数据长度，进而更新真实的已经记录数据的长度。</p>
<p>最后读取上一次MMKV还没有更新的备份数据长度和crc校验字段，通过writeActualSize记录在映射的内存中。</p>
<p>如果最后弥补的校验还是crc校验错误，最后会回调onMMKVCRCCheckFail这个方法。这个方法会反射Java层实现的异常处理策略</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loadFromFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">auto</span> strategic <span class="token operator">=</span> <span class="token function">onMMKVCRCCheckFail</span><span class="token punctuation">(</span>m_mmapID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>strategic <span class="token operator">==</span> OnErrorRecover<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    loadFromFile <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    needFullWriteback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">MMKVInfo</span><span class="token punctuation">(</span><span class="token string">"recover strategic for [%s] is %d"</span><span class="token punctuation">,</span> m_mmapID<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strategic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果是OnErrorRecover，则设置loadFromFile和needFullWriteback都为true，尽可能的恢复数据。当然如果OnErrorDiscard，则会丢弃掉所有的数据。</p>
<ul>
<li>3.判断此时MMKV中预设的缓存已经满了，避免出现中间出现了上述的异常，也调用了一次checkLastConfirmedInfo进行状态的校验。发现loadFromFile确实为false，说明需要进行可能需要扩容：<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loadFromFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">auto</span> strategic <span class="token operator">=</span> <span class="token function">onMMKVFileLengthError</span><span class="token punctuation">(</span>m_mmapID<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>strategic <span class="token operator">==</span> OnErrorRecover<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              m_actualSize <span class="token operator">=</span> fileSize <span class="token operator">-</span> Fixed32Size<span class="token punctuation">;</span>
              loadFromFile <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              needFullWriteback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
如果发现MMKV在外部进行初始化，异常处理策略是OnErrorRecover,尝试着扩容数据。则给loadFromFile和needFullWriteback都设置为true。m_actualSize为了避免覆盖掉了前面的长度记录，<blockquote>
<p>设置真实记录长度 = 文件长度- 4</p>
</blockquote>
</li>
</ul>
<p>之后就以这个大小为基准进行扩容，在reloadFromFile方法中进行扩容。</p>
<h3 id="MMKV第一次初始化或者读取文件失败"><a href="#MMKV第一次初始化或者读取文件失败" class="headerlink" title="MMKV第一次初始化或者读取文件失败"></a>MMKV第一次初始化或者读取文件失败</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">enum</span> <span class="token operator">:</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
    KeepSequence <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    IncreaseSequence <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">
            <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_exclusiveProcessLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

            m_output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CodedOutputData</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> Fixed32Size<span class="token punctuation">,</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> Fixed32Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_actualSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">writeActualSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> IncreaseSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">sync</span><span class="token punctuation">(</span>MMKV_SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">writeActualSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> KeepSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>走到这个分支有两个条件，第一个是读取文件发现大小为0。第二个是读取文件出现了问题。第一个情况将会调用writeActualSize设置KeepSequence，第二个情况则设置IncreaseSequence。</p>
<p>其实writeActualSize这个方法就是往m_metaInfo记录相关于MMKV的信息。</p>
<h5 id="writeActualSize"><a href="#writeActualSize" class="headerlink" title="writeActualSize"></a>writeActualSize</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">ifndef</span> MMKV_WIN32</span>
<span class="token macro property">#    <span class="token directive keyword">ifndef</span> likely</span>
<span class="token macro property">#        <span class="token directive keyword">define</span> unlikely(x) (__builtin_expect(bool(x), 0))</span>
<span class="token macro property">#        <span class="token directive keyword">define</span> likely(x) (__builtin_expect(bool(x), 1))</span>
<span class="token macro property">#    <span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">else</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意if(unlikely(value))和if(likely(value))  都等价于if(value)。唯一不同的是对编译器指令的优化。比如说这里的unlikely的意思是，判断到为假的可能性更大；相对的likely的意思是指，判断到真的可能性更大。</p>
<p>这样的话，编译器就能按照这个思路进行预先优化，将可能性更大的代码段接在判断的后面，减少跳转等指令的调用。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> MMKV<span class="token operator">::</span><span class="token function">writeActualSize</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">,</span> uint32_t crcDigest<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>iv<span class="token punctuation">,</span> <span class="token keyword">bool</span> increaseSequence<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// backward compatibility</span>
    <span class="token function">oldStyleWriteActualSize</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_metaFile<span class="token operator">-</span><span class="token operator">></span><span class="token function">isFileValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> needsFullWrite <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    m_actualSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
    m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_actualSize <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_crcDigest <span class="token operator">=</span> crcDigest<span class="token punctuation">;</span>
    m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_crcDigest <span class="token operator">=</span> crcDigest<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_version <span class="token operator">&lt;</span> MMKVVersionSequence<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_version <span class="token operator">=</span> MMKVVersionSequence<span class="token punctuation">;</span>
        needsFullWrite <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_vector<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_vector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_version <span class="token operator">&lt;</span> MMKVVersionRandomIV<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_version <span class="token operator">=</span> MMKVVersionRandomIV<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        needsFullWrite <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>increaseSequence<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_sequence<span class="token operator">++</span><span class="token punctuation">;</span>
        m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_lastConfirmedMetaInfo<span class="token punctuation">.</span>lastActualSize <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_lastConfirmedMetaInfo<span class="token punctuation">.</span>lastCRCDigest <span class="token operator">=</span> crcDigest<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_version <span class="token operator">&lt;</span> MMKVVersionActualSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_version <span class="token operator">=</span> MMKVVersionActualSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        needsFullWrite <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> MMKV_IOS</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>needsFullWrite<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_metaInfo<span class="token operator">-</span><span class="token operator">></span><span class="token function">write</span><span class="token punctuation">(</span>m_metaFile<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        m_metaInfo<span class="token operator">-</span><span class="token operator">></span><span class="token function">writeCRCAndActualSizeOnly</span><span class="token punctuation">(</span>m_metaFile<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上文提到过的结构体MMKVMetaInfo其实就是在这里进行赋值。记录了m_actualSize以及crc校验的m_crcDigest。</p>
<p>如果是存储没有数据的话，m_actualSize为0，此时increaseSequence为false；存储过数据m_actualSize则大于0，increaseSequence为true。</p>
<ul>
<li><p>1.m_version默认是MMKVVersionSequence且iv为null。那么m_version将会设置为MMKVVersionRandomIV。一般来说这个iv的变化说明crc校验码发生了变化。</p>
</li>
<li><p>2.如果此时是IncreaseSequence为true，将会把当前的size和crc校验记录到m_lastConfirmedMetaInfo中，并且m_version升级成MMKVVersionActualSize。needsFullWrite都设置为true,m_sequence写回计数+1.</p>
</li>
</ul>
<p>-3.如果是第一次初始化，文件为空或者数据丢失，此时increaseSequence是KeepSequence为false，则不会记录相关写回的数据。</p>
<ul>
<li>3.needsFullWrite为true,所以会走到writeCRCAndActualSizeOnly中。<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">writeCRCAndActualSizeOnly</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">MMKV_ASSERT</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">auto</span> other <span class="token operator">=</span> <span class="token punctuation">(</span>MMKVMetaInfo <span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
      other<span class="token operator">-</span><span class="token operator">></span>m_crcDigest <span class="token operator">=</span> m_crcDigest<span class="token punctuation">;</span>
      other<span class="token operator">-</span><span class="token operator">></span>m_actualSize <span class="token operator">=</span> m_actualSize<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
能看到实际上就是把m_crcDigest和m_actualSize拷贝到m_metaFile内存文件映射的文件中。</li>
</ul>
<h3 id="MMKV已经初始化过了，第二次打开与异常处理机制"><a href="#MMKV已经初始化过了，第二次打开与异常处理机制" class="headerlink" title="MMKV已经初始化过了，第二次打开与异常处理机制"></a>MMKV已经初始化过了，第二次打开与异常处理机制</h3><pre class="line-numbers language-cpp"><code class="language-cpp">        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadFromFile <span class="token operator">&amp;&amp;</span> m_actualSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            MMBuffer <span class="token function">inputBuffer</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> Fixed32Size<span class="token punctuation">,</span> m_actualSize<span class="token punctuation">,</span> MMBufferNoCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_crypter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">decryptBuffer</span><span class="token punctuation">(</span><span class="token operator">*</span>m_crypter<span class="token punctuation">,</span> inputBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">clearDictionary</span><span class="token punctuation">(</span>m_dic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>needFullWriteback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                MiniPBCoder<span class="token operator">::</span><span class="token function">greedyDecodeMap</span><span class="token punctuation">(</span>m_dic<span class="token punctuation">,</span> inputBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                MiniPBCoder<span class="token operator">::</span><span class="token function">decodeMap</span><span class="token punctuation">(</span>m_dic<span class="token punctuation">,</span> inputBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            m_output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CodedOutputData</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> Fixed32Size<span class="token punctuation">,</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> Fixed32Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            m_output<span class="token operator">-</span><span class="token operator">></span><span class="token function">seek</span><span class="token punctuation">(</span>m_actualSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>needFullWriteback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fullWriteback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里需要注意一个类MMBuffer，这个类是MMKV的内存单元，里面保存了对应映射的指针，当然在iOS中就是一个NSData指针。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">MMBuffer</span> <span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    size_t size<span class="token punctuation">;</span>
    MMBufferCopyFlag isNoCopy<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> MMKV_APPLE</span>
    NSData <span class="token operator">*</span>m_data <span class="token operator">=</span> nil<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">explicit</span> <span class="token function">MMBuffer</span><span class="token punctuation">(</span>size_t length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MMBuffer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>source<span class="token punctuation">,</span> size_t length<span class="token punctuation">,</span> MMBufferCopyFlag flag <span class="token operator">=</span> MMBufferCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> MMKV_APPLE</span>
    <span class="token keyword">explicit</span> <span class="token function">MMBuffer</span><span class="token punctuation">(</span>NSData <span class="token operator">*</span>data<span class="token punctuation">,</span> MMBufferCopyFlag flag <span class="token operator">=</span> MMBufferCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token function">MMBuffer</span><span class="token punctuation">(</span>MMBuffer <span class="token operator">&amp;&amp;</span>other<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>
    MMBuffer <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>MMBuffer <span class="token operator">&amp;&amp;</span>other<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>

    <span class="token operator">~</span><span class="token function">MMBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> ptr<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    size_t <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> size<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// those are expensive, just forbid it for possibly misuse</span>
    <span class="token keyword">explicit</span> <span class="token function">MMBuffer</span><span class="token punctuation">(</span><span class="token keyword">const</span> MMBuffer <span class="token operator">&amp;</span>other<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
    MMBuffer <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> MMBuffer <span class="token operator">&amp;</span>other<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>另一个是MiniPBCoder类，这个类实际上是用于解析Protocol Buffers的对象。这个对象是什么呢？其实可以和json进行类比。和json一样是一种对象序列化的手段。</p>
<h4 id="1-decryptBuffer解析inputBuffer中被AESCrypt加密的数据。"><a href="#1-decryptBuffer解析inputBuffer中被AESCrypt加密的数据。" class="headerlink" title="1.decryptBuffer解析inputBuffer中被AESCrypt加密的数据。"></a>1.decryptBuffer解析inputBuffer中被AESCrypt加密的数据。</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">decryptBuffer</span><span class="token punctuation">(</span>AESCrypt <span class="token operator">&amp;</span>crypter<span class="token punctuation">,</span> MMBuffer <span class="token operator">&amp;</span>inputBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    size_t length <span class="token operator">=</span> inputBuffer<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MMBuffer <span class="token function">tmp</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> input <span class="token operator">=</span> inputBuffer<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> output <span class="token operator">=</span> tmp<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    crypter<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> output<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    inputBuffer <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> AESCrypt<span class="token operator">::</span><span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>input<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>output<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>input <span class="token operator">||</span> <span class="token operator">!</span>output <span class="token operator">||</span> length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">AES_cfb128_decrypt</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> input<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> output<span class="token punctuation">,</span> length<span class="token punctuation">,</span> m_aesKey<span class="token punctuation">,</span> m_vector<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里面使用了OpenSSL 的AES CFB模式进行解析。解析后的数据指针将会指向inputBuffer。</p>
<h4 id="2-needFullWriteback-不管是否为true都会把inputBuffer中的数据加载到全局散列表的m-dic中。"><a href="#2-needFullWriteback-不管是否为true都会把inputBuffer中的数据加载到全局散列表的m-dic中。" class="headerlink" title="2.needFullWriteback 不管是否为true都会把inputBuffer中的数据加载到全局散列表的m_dic中。"></a>2.needFullWriteback 不管是否为true都会把inputBuffer中的数据加载到全局散列表的m_dic中。</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MiniPBCoder<span class="token operator">::</span><span class="token function">decodeMap</span><span class="token punctuation">(</span>MMKVMap <span class="token operator">&amp;</span>dic<span class="token punctuation">,</span> <span class="token keyword">const</span> MMBuffer <span class="token operator">&amp;</span>oData<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MiniPBCoder <span class="token function">oCoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    oCoder<span class="token punctuation">.</span><span class="token function">decodeOneMap</span><span class="token punctuation">(</span>dic<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MiniPBCoder<span class="token operator">::</span><span class="token function">greedyDecodeMap</span><span class="token punctuation">(</span>MMKVMap <span class="token operator">&amp;</span>dic<span class="token punctuation">,</span> <span class="token keyword">const</span> MMBuffer <span class="token operator">&amp;</span>oData<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MiniPBCoder <span class="token function">oCoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    oCoder<span class="token punctuation">.</span><span class="token function">decodeOneMap</span><span class="token punctuation">(</span>dic<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能发现其实所有的工作都会通过MiniPBCoder进行解析。在这里我就不对protbuf进行过多的解析，直接看MMKV的核心流程：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MiniPBCoder<span class="token operator">::</span><span class="token function">decodeOneMap</span><span class="token punctuation">(</span>MMKVMap <span class="token operator">&amp;</span>dic<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> <span class="token keyword">bool</span> greedy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> block <span class="token operator">=</span> <span class="token punctuation">[</span>size<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>MMKVMap <span class="token operator">&amp;</span>dictionary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">[</span><span class="token punctuation">[</span>maybe_unused<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">auto</span> length <span class="token operator">=</span> m_inputData<span class="token operator">-</span><span class="token operator">></span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_inputData<span class="token operator">-</span><span class="token operator">></span><span class="token function">isAtEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token keyword">auto</span> <span class="token operator">&amp;</span>key <span class="token operator">=</span> m_inputData<span class="token operator">-</span><span class="token operator">></span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">auto</span> value <span class="token operator">=</span> m_inputData<span class="token operator">-</span><span class="token operator">></span><span class="token function">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dictionary<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">move</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    dictionary<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>greedy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">block</span><span class="token punctuation">(</span>dic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>std<span class="token operator">::</span>exception <span class="token operator">&amp;</span>exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> exception<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            MMKVMap tmpDic<span class="token punctuation">;</span>
            <span class="token function">block</span><span class="token punctuation">(</span>tmpDic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dic<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>tmpDic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>std<span class="token operator">::</span>exception <span class="token operator">&amp;</span>exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> exception<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上decodeOneMap的工作就是把保存在MiniPBCoder中的m_inputData进行解析，在这里就是指MMBuffer。把这些数据解析成一对对的键值对保存在MMKVMap这个m_dic散列表中。</p>
<h5 id="初始化的异常处理机制"><a href="#初始化的异常处理机制" class="headerlink" title="初始化的异常处理机制"></a>初始化的异常处理机制</h5><p>而greedy的区别就是指是否直接把数据拷贝到m_dic中，不是则通过一个临时MMKVMap作为中转。我们稍微回忆一下。当MMKV尝试从MMKV缓存数据的文件进行加载时候失败或者内容已经满了，才会设置needFullWriteback为true。换句话说，设置异常处理OnErrorRecover这个标志位只有长度异常和crc校验不通过，且异常处理机制为尽可能的恢复。</p>
<p>那么解析这个地方就很简单了。<br>如果说此时needFullWriteback为false:如果MMKV在初始化数据是正常的，通过tmp进行swap中转的时候就会正常的设置到m_dic中。但是如果出现了错误，dic还没有从tmp交换容器内容就被异常抛出，m_dic将无法读取出数据。</p>
<p>如果说此时needFullWriteback为true：如果MMKV初始化异常，则因为没有swap直接通过block获取数据，就会尽可能的把缓存在磁盘的数据读取到内存中。</p>
<h4 id="3-通过m-file的映射的内存生成CodedOutputData对象，并且调用seek方法跳到已经记录的数据末尾。"><a href="#3-通过m-file的映射的内存生成CodedOutputData对象，并且调用seek方法跳到已经记录的数据末尾。" class="headerlink" title="3.通过m_file的映射的内存生成CodedOutputData对象，并且调用seek方法跳到已经记录的数据末尾。"></a>3.通过m_file的映射的内存生成CodedOutputData对象，并且调用seek方法跳到已经记录的数据末尾。</h4><p>CodedOutputData的实例化可以看到此时是通过m_file往后移动4位之后开始拷贝到CodedOutputData中，其长度fileSize - 4位信息。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">CodedOutputData</span> <span class="token punctuation">{</span>
    uint8_t <span class="token operator">*</span><span class="token keyword">const</span> m_ptr<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//内存指针</span>
    size_t m_size<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//内存区域大小</span>
    size_t m_position<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//读取到哪个位置</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CodedOutputData<span class="token operator">::</span><span class="token function">seek</span><span class="token punctuation">(</span>size_t addedSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m_position <span class="token operator">+</span><span class="token operator">=</span> addedSize<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_position <span class="token operator">></span> m_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">out_of_range</span><span class="token punctuation">(</span><span class="token string">"OutOfSpace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4-needFullWriteback如果为true则调用fullWriteback方法。说明此时出现了crc校验或者文件长度异常，同时异常处理机制为OnErrorRecover。"><a href="#4-needFullWriteback如果为true则调用fullWriteback方法。说明此时出现了crc校验或者文件长度异常，同时异常处理机制为OnErrorRecover。" class="headerlink" title="4.needFullWriteback如果为true则调用fullWriteback方法。说明此时出现了crc校验或者文件长度异常，同时异常处理机制为OnErrorRecover。"></a>4.needFullWriteback如果为true则调用fullWriteback方法。说明此时出现了crc校验或者文件长度异常，同时异常处理机制为OnErrorRecover。</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> MMKV<span class="token operator">::</span><span class="token function">fullWriteback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_dic<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> allData <span class="token operator">=</span> MiniPBCoder<span class="token operator">::</span><span class="token function">encodeDataWithObject</span><span class="token punctuation">(</span>m_dic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_exclusiveProcessLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>allData<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> fileSize <span class="token operator">=</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>allData<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> Fixed32Size <span class="token operator">&lt;=</span> fileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">doFullWriteBack</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>allData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> <span class="token function">ensureMemorySize</span><span class="token punctuation">(</span>allData<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> Fixed32Size <span class="token operator">-</span> fileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里可以分为如下几个步骤：</p>
<ul>
<li><p>1.如果发现m_dic从磁盘缓存中读取PB数据是空的，则调用clearAll进行处理。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MMKV<span class="token operator">::</span><span class="token function">clearAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">MMKVInfo</span><span class="token punctuation">(</span><span class="token string">"cleaning all key-values from [%s]"</span><span class="token punctuation">,</span> m_mmapID<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_exclusiveProcessLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_needLoadFromFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">reloadFromFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">truncate</span><span class="token punctuation">(</span>DEFAULT_MMAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> ptr <span class="token operator">=</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">memset</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">msync</span><span class="token punctuation">(</span>MMKV_SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> newIV<span class="token punctuation">[</span>AES_KEY_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
  AESCrypt<span class="token operator">::</span><span class="token function">fillRandomIV</span><span class="token punctuation">(</span>newIV<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_crypter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      m_crypter<span class="token operator">-</span><span class="token operator">></span><span class="token function">resetIV</span><span class="token punctuation">(</span>newIV<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>newIV<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">writeActualSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> newIV<span class="token punctuation">,</span> IncreaseSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_metaFile<span class="token operator">-</span><span class="token operator">></span><span class="token function">msync</span><span class="token punctuation">(</span>MMKV_SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">clearMemoryCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">loadFromFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>会发生这种情况说明我们就算想要强制恢复数据，发现从磁盘中读取PB数据根本没办法解析任何东西，可以认为这个文件已经完全损坏了，这个文件存在也没有意义，进行如下步骤的处理：</p>
</li>
<li><p>调整m_file映射的大小。就会把file中映射的内存全部设置为0初始化，调用msync进行同步处理。</p>
</li>
<li><p>重新设置一个新的AESCrypt的key，设置到AESCrypt中，把这些数据通过writeActualSize写到meta_file中进行缓存。清空m_file映射数据后，重新通过loadFromFile初始化m_dic等数据。</p>
</li>
<li><p>2.如果发现m_dic调用encodeDataWithObject方法进行PB压缩加密为MMBuffer之后，发现MMBuffer比原来的文件内容要小，则调用doFullWriteBack把完好的数据通过doFullWriteBack写回到错误的文件中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> MMKV<span class="token operator">::</span><span class="token function">doFullWriteBack</span><span class="token punctuation">(</span>MMBuffer <span class="token operator">&amp;&amp;</span>allData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> newIV<span class="token punctuation">[</span>AES_KEY_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_crypter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      AESCrypt<span class="token operator">::</span><span class="token function">fillRandomIV</span><span class="token punctuation">(</span>newIV<span class="token punctuation">)</span><span class="token punctuation">;</span>
      m_crypter<span class="token operator">-</span><span class="token operator">></span><span class="token function">resetIV</span><span class="token punctuation">(</span>newIV<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>newIV<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">auto</span> ptr <span class="token operator">=</span> allData<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      m_crypter<span class="token operator">-</span><span class="token operator">></span><span class="token function">encrypt</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> allData<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">auto</span> ptr <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> m_output<span class="token punctuation">;</span>
  m_output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CodedOutputData</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> Fixed32Size<span class="token punctuation">,</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> Fixed32Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_output<span class="token operator">-</span><span class="token operator">></span><span class="token function">writeRawData</span><span class="token punctuation">(</span>allData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// note: don't write size of data</span>

  m_actualSize <span class="token operator">=</span> allData<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_crypter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">recaculateCRCDigestWithIV</span><span class="token punctuation">(</span>newIV<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">recaculateCRCDigestWithIV</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  m_hasFullWriteback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// make sure lastConfirmedMetaInfo is saved</span>
  <span class="token function">sync</span><span class="token punctuation">(</span>MMKV_SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的逻辑很简单，也是做了类似的处理。先经过AES加密后，把MMBuffer的数据通过CodedOutputData写入到m_file中，并更新crc的校验码。</p>
</li>
<li><p>3.如果发现encodeDataWithObject压缩后的大小比文件内容大，则会调用ensureMemorySize进行扩容，尝试着扩容成</p>
<blockquote>
<p>尝试扩容的大小 = 压缩后数据总大小 - 当前文件大小 - 4位长度标志位</p>
</blockquote>
</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> MMKV<span class="token operator">::</span><span class="token function">ensureMemorySize</span><span class="token punctuation">(</span>size_t newSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// make some room for placeholder</span>
    <span class="token keyword">constexpr</span> size_t ItemSizeHolderSize <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_dic<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newSize <span class="token operator">+</span><span class="token operator">=</span> ItemSizeHolderSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newSize <span class="token operator">>=</span> m_output<span class="token operator">-</span><span class="token operator">></span><span class="token function">spaceLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> m_dic<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// try a full rewrite to make space</span>
        <span class="token keyword">auto</span> fileSize <span class="token operator">=</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MMBuffer data <span class="token operator">=</span> MiniPBCoder<span class="token operator">::</span><span class="token function">encodeDataWithObject</span><span class="token punctuation">(</span>m_dic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size_t lenNeeded <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> Fixed32Size <span class="token operator">+</span> newSize<span class="token punctuation">;</span>
        size_t avgItemSize <span class="token operator">=</span> lenNeeded <span class="token operator">/</span> std<span class="token operator">::</span>max<span class="token operator">&lt;</span>size_t<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> m_dic<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        size_t futureUsage <span class="token operator">=</span> avgItemSize <span class="token operator">*</span> std<span class="token operator">::</span>max<span class="token operator">&lt;</span>size_t<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>m_dic<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 1. no space for a full rewrite, double it</span>
        <span class="token comment" spellcheck="true">// 2. or space is not large enough for future usage, double it to avoid frequently full rewrite</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lenNeeded <span class="token operator">>=</span> fileSize <span class="token operator">||</span> <span class="token punctuation">(</span>lenNeeded <span class="token operator">+</span> futureUsage<span class="token punctuation">)</span> <span class="token operator">>=</span> fileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size_t oldSize <span class="token operator">=</span> fileSize<span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                fileSize <span class="token operator">*</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>lenNeeded <span class="token operator">+</span> futureUsage <span class="token operator">>=</span> fileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">truncate</span><span class="token punctuation">(</span>fileSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// check if we fail to make more space</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFileValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">doFullWriteBack</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的算法也很简单：</p>
<ul>
<li><p>1.首先算出此时总共需要多少内存：</p>
<blockquote>
<p>总数据长度 = 原数据长度+标志位+需要扩充大小</p>
</blockquote>
</li>
<li><p>2.计算平均m_dic中每一项平均占用大小：</p>
<blockquote>
<p>每一项内存平均大小 = 总数据长度 / max(1,m_dic 的项数)</p>
</blockquote>
</li>
<li><p>3.futureUsage 扩充的额外容量，减少map的hash散列冲突，相当于扩充了1.5倍</p>
<blockquote>
<p>扩充的额外容量 =  每一项内存平均大小 * max(8 , (m_dic的项数+1)/2)</p>
</blockquote>
</li>
<li><p>4.不断的把原来的file大小扩容2倍，直到比扩充的额外容量的大小要大为止，最后通过truncate，把大小变成4kb的倍数。</p>
</li>
<li><p>5.doFullWriteBack 写回m_file中记录数据。</p>
</li>
</ul>
<p>到这里MMKV的初始化和错误校验和恢复流程的处理就结束了，我们来看看MMKV是如何读写的。</p>
<h3 id="MMKV-encode-写入数据"><a href="#MMKV-encode-写入数据" class="headerlink" title="MMKV encode 写入数据"></a>MMKV encode 写入数据</h3><p>这里以常见的encodeString为例子。<br>根据上面注册的native 方法，我们可以知道对应如下的方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> string <span class="token function">jstring2string</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jstring str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>kstr <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kstr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            string <span class="token function">result</span><span class="token punctuation">(</span>kstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> kstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

MMKV_JNI jboolean <span class="token function">encodeString</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jlong handle<span class="token punctuation">,</span> jstring oKey<span class="token punctuation">,</span> jstring oValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MMKV <span class="token operator">*</span>kv <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>MMKV <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kv <span class="token operator">&amp;&amp;</span> oKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        string key <span class="token operator">=</span> <span class="token function">jstring2string</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> oKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            string value <span class="token operator">=</span> <span class="token function">jstring2string</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> oValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>jboolean<span class="token punctuation">)</span> kv<span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            kv<span class="token operator">-</span><span class="token operator">></span><span class="token function">removeValueForKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>jboolean<span class="token punctuation">)</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>jboolean<span class="token punctuation">)</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这里面本质上就是调用了MMKV的set方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> MMKV<span class="token operator">::</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> MMKVKey_t key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isKeyEmpty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">auto</span> data <span class="token operator">=</span> MiniPBCoder<span class="token operator">::</span><span class="token function">encodeDataWithObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">setDataForKey</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里做了两件事情：</p>
<ul>
<li>1.encodeDataWithObject 编码压缩内容</li>
<li>2.setDataForKey 保存数据</li>
</ul>
<h4 id="encodeDataWithObject-编码压缩内容"><a href="#encodeDataWithObject-编码压缩内容" class="headerlink" title="encodeDataWithObject 编码压缩内容"></a>encodeDataWithObject 编码压缩内容</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> MMBuffer <span class="token function">encodeDataWithObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> T <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            MiniPBCoder pbcoder<span class="token punctuation">;</span>
            <span class="token keyword">return</span> pbcoder<span class="token punctuation">.</span><span class="token function">getEncodeData</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>exception <span class="token operator">&amp;</span>exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> exception<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">MMBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">MMBuffer MiniPBCoder<span class="token operator">::</span><span class="token function">getEncodeData</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m_encodeItems <span class="token operator">=</span> <span class="token keyword">new</span> vector<span class="token operator">&lt;</span>PBEncodeItem<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t index <span class="token operator">=</span> <span class="token function">prepareObjectForEncode</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PBEncodeItem <span class="token operator">*</span>oItem <span class="token operator">=</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> m_encodeItems<span class="token operator">-</span><span class="token operator">></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>m_encodeItems<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oItem <span class="token operator">&amp;&amp;</span> oItem<span class="token operator">-</span><span class="token operator">></span>compiledSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_outputBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MMBuffer</span><span class="token punctuation">(</span>oItem<span class="token operator">-</span><span class="token operator">></span>compiledSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_outputData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CodedOutputData</span><span class="token punctuation">(</span>m_outputBuffer<span class="token operator">-</span><span class="token operator">></span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_outputBuffer<span class="token operator">-</span><span class="token operator">></span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">writeRootObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">*</span>m_outputBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.prepareObjectForEncode 这个方法会解析当前的数据，设置相关的编码准备数据。</li>
<li>2.根据prepareObjectForEncode的index获取对应的PBEncodeItem对象，通过writeRootObject把数据保存到MMBuffer 临时开辟的缓存中。</li>
</ul>
<h4 id="prepareObjectForEncode"><a href="#prepareObjectForEncode" class="headerlink" title="prepareObjectForEncode"></a>prepareObjectForEncode</h4><pre class="line-numbers language-cpp"><code class="language-cpp">size_t MiniPBCoder<span class="token operator">::</span><span class="token function">prepareObjectForEncode</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m_encodeItems<span class="token operator">-</span><span class="token operator">></span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">PBEncodeItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    PBEncodeItem <span class="token operator">*</span>encodeItem <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>m_encodeItems<span class="token operator">-</span><span class="token operator">></span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t index <span class="token operator">=</span> m_encodeItems<span class="token operator">-</span><span class="token operator">></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        encodeItem<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">=</span> PBEncodeItemType_String<span class="token punctuation">;</span>
        encodeItem<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">.</span>strValue <span class="token operator">=</span> <span class="token operator">&amp;</span>str<span class="token punctuation">;</span>
        encodeItem<span class="token operator">-</span><span class="token operator">></span>valueSize <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>int32_t<span class="token operator">></span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    encodeItem<span class="token operator">-</span><span class="token operator">></span>compiledSize <span class="token operator">=</span> <span class="token function">pbRawVarint32Size</span><span class="token punctuation">(</span>encodeItem<span class="token operator">-</span><span class="token operator">></span>valueSize<span class="token punctuation">)</span> <span class="token operator">+</span> encodeItem<span class="token operator">-</span><span class="token operator">></span>valueSize<span class="token punctuation">;</span>

    <span class="token keyword">return</span> index<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个过程中会把PBEncodeItem缓存到m_encodeItems这个vector集合中。并且设置encodeItem的类型为String，保存string内容，以及字符串大小。最后设置compiledSize记录编码后的大小，这个大小包含了标志位的大小，因此会比原来的大。</p>
<h4 id="writeRootObject"><a href="#writeRootObject" class="headerlink" title="writeRootObject"></a>writeRootObject</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MiniPBCoder<span class="token operator">::</span><span class="token function">writeRootObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> total <span class="token operator">=</span> m_encodeItems<span class="token operator">-</span><span class="token operator">></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> total<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PBEncodeItem <span class="token operator">*</span>encodeItem <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>m_encodeItems<span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>encodeItem<span class="token operator">-</span><span class="token operator">></span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> PBEncodeItemType_Data<span class="token operator">:</span> <span class="token punctuation">{</span>
                m_outputData<span class="token operator">-</span><span class="token operator">></span><span class="token function">writeData</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>encodeItem<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">.</span>bufferValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> PBEncodeItemType_Container<span class="token operator">:</span> <span class="token punctuation">{</span>
                m_outputData<span class="token operator">-</span><span class="token operator">></span><span class="token function">writeUInt32</span><span class="token punctuation">(</span>encodeItem<span class="token operator">-</span><span class="token operator">></span>valueSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> PBEncodeItemType_String<span class="token operator">:</span> <span class="token punctuation">{</span>
                m_outputData<span class="token operator">-</span><span class="token operator">></span><span class="token function">writeString</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>encodeItem<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">.</span>strValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">case</span> PBEncodeItemType_None<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> encodeItem<span class="token operator">-</span><span class="token operator">></span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里实际上是调用了CodedOutputData的writeString把数据保存到映射的内存中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CodedOutputData<span class="token operator">::</span><span class="token function">writeString</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    size_t numberOfBytes <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">writeRawVarint32</span><span class="token punctuation">(</span><span class="token punctuation">(</span>int32_t<span class="token punctuation">)</span> numberOfBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_position <span class="token operator">+</span> numberOfBytes <span class="token operator">></span> m_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> msg <span class="token operator">=</span> <span class="token string">"m_position: "</span> <span class="token operator">+</span> <span class="token function">to_string</span><span class="token punctuation">(</span>m_position<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", numberOfBytes: "</span> <span class="token operator">+</span> <span class="token function">to_string</span><span class="token punctuation">(</span>numberOfBytes<span class="token punctuation">)</span> <span class="token operator">+</span>
                   <span class="token string">", m_size: "</span> <span class="token operator">+</span> <span class="token function">to_string</span><span class="token punctuation">(</span>m_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token function">out_of_range</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>m_ptr <span class="token operator">+</span> m_position<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span> value<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> numberOfBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_position <span class="token operator">+</span><span class="token operator">=</span> numberOfBytes<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上十分简单，就是把数据直接拷贝MMBuffer的临时缓冲区中。并且把存储的位置向后移动存储的长度。并通过m_position保存起来，下一次就从这里开始保存。</p>
<p>最后把这个临时缓冲区MMBuffer返回。</p>
<h3 id="setDataForKey-保存数据到映射的文件"><a href="#setDataForKey-保存数据到映射的文件" class="headerlink" title="setDataForKey 保存数据到映射的文件"></a>setDataForKey 保存数据到映射的文件</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> MMKV<span class="token operator">::</span><span class="token function">setDataForKey</span><span class="token punctuation">(</span>MMBuffer <span class="token operator">&amp;&amp;</span>data<span class="token punctuation">,</span> MMKVKey_t key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">isKeyEmpty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_exclusiveProcessLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkLoadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> ret <span class="token operator">=</span> <span class="token function">appendDataWithKey</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_dic<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_hasFullWriteback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为需要开始写入数据了，这里设置了互斥锁，和线程锁。整个步骤分为两步骤：</p>
<ul>
<li>1.checkLoadData 保存数据之前，校验已经存储的数据</li>
<li>2.appendDataWithKey 进行数据的保存</li>
</ul>
<h4 id="checkLoadData"><a href="#checkLoadData" class="headerlink" title="checkLoadData"></a>checkLoadData</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MMKV<span class="token operator">::</span><span class="token function">checkLoadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// TODO: atomic lock m_metaFile?</span>
    MMKVMetaInfo metaInfo<span class="token punctuation">;</span>
    metaInfo<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>m_metaFile<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_sequence <span class="token operator">!=</span> metaInfo<span class="token punctuation">.</span>m_sequence<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_sharedProcessLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">clearMemoryCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">loadFromFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">notifyContentChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m_metaInfo<span class="token operator">-</span><span class="token operator">></span>m_crcDigest <span class="token operator">!=</span> metaInfo<span class="token punctuation">.</span>m_crcDigest<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_sharedProcessLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        size_t fileSize <span class="token operator">=</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getActualFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> fileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">clearMemoryCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">loadFromFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">partialLoadFromFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">notifyContentChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果发现记录在m_metaFile中的m_sequence和缓存在内存中的m_sequence不一致。说明这个过程中发生过writeActualSize的调用。而这个方法的调用一般是文件读取发生了异常，要么是长度不足，要么是crc校验过不去。此时会进行一次初始化异常处理，因此重新读取一次m_file进行初始化。记住MMKV是支持多进程的，需要不断的校验内存文件是否被另一个进程给写坏了。</p>
</li>
<li><p>2.crc发现了变动，说明文件可能进行了扩容，扩容了可能会进行内存重排(重新绑定了mmap)，因此需要重新读取数据。</p>
</li>
</ul>
<p>如果相等说明文件没有扩容，但是因为内存触顶，重新设置MMKV的加密key，而触发了fullWriteback 完全写回，导致文件可能更新了crc校验码。这个过程将会调用partialLoadFromFile从内存文件中更新crc校验码，缓存的数据，数据写入位置到内存中。</p>
<h4 id="appendDataWithKey"><a href="#appendDataWithKey" class="headerlink" title="appendDataWithKey"></a>appendDataWithKey</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> MMKV<span class="token operator">::</span><span class="token function">appendDataWithKey</span><span class="token punctuation">(</span><span class="token keyword">const</span> MMBuffer <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> MMKVKey_t key<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    size_t keyLength <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// size needed to encode the key</span>
    size_t size <span class="token operator">=</span> keyLength <span class="token operator">+</span> <span class="token function">pbRawVarint32Size</span><span class="token punctuation">(</span><span class="token punctuation">(</span>int32_t<span class="token punctuation">)</span> keyLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// size needed to encode the value</span>
    size <span class="token operator">+</span><span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">pbRawVarint32Size</span><span class="token punctuation">(</span><span class="token punctuation">(</span>int32_t<span class="token punctuation">)</span> data<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_exclusiveProcessLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> hasEnoughSize <span class="token operator">=</span> <span class="token function">ensureMemorySize</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasEnoughSize <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isFileValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    m_output<span class="token operator">-</span><span class="token operator">></span><span class="token function">writeString</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    m_output<span class="token operator">-</span><span class="token operator">></span><span class="token function">writeData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// note: write size of data</span>

    <span class="token keyword">auto</span> ptr <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span> m_file<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> Fixed32Size <span class="token operator">+</span> m_actualSize<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_crypter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_crypter<span class="token operator">-</span><span class="token operator">></span><span class="token function">encrypt</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    m_actualSize <span class="token operator">+</span><span class="token operator">=</span> size<span class="token punctuation">;</span>
    <span class="token function">updateCRCDigest</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程就很简单了，判断是否有足够的空间，没有则调用ensureMemorySize进行扩容，实在无法从内存中映射出来，那说明系统没空间了就返回异常。</p>
<p>正常情况下，是往全局缓冲区CodedOutputData 先后在文件内存的末尾写入key和value的数据。并对这部分的数据进行一次加密，最后更新这个存储区域的crc校验码。</p>
<h3 id="decode-MMKV读取数据"><a href="#decode-MMKV读取数据" class="headerlink" title="decode MMKV读取数据"></a>decode MMKV读取数据</h3><p>接下来关注MMKV是如何读取数据的。还是以String为例子</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">MMKV_JNI jstring <span class="token function">decodeString</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">,</span> jlong handle<span class="token punctuation">,</span> jstring oKey<span class="token punctuation">,</span> jstring oDefaultValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MMKV <span class="token operator">*</span>kv <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>MMKV <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kv <span class="token operator">&amp;&amp;</span> oKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        string key <span class="token operator">=</span> <span class="token function">jstring2string</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> oKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        string value<span class="token punctuation">;</span>
        <span class="token keyword">bool</span> hasValue <span class="token operator">=</span> kv<span class="token operator">-</span><span class="token operator">></span><span class="token function">getString</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">string2jstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> oDefaultValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> MMKV<span class="token operator">::</span><span class="token function">getString</span><span class="token punctuation">(</span>MMKVKey_t key<span class="token punctuation">,</span> string <span class="token operator">&amp;</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isKeyEmpty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">SCOPED_LOCK</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> <span class="token operator">&amp;</span>data <span class="token operator">=</span> <span class="token function">getDataForKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> MiniPBCoder<span class="token operator">::</span><span class="token function">decodeString</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>std<span class="token operator">::</span>exception <span class="token operator">&amp;</span>exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">MMKVError</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> exception<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>大致可以分分为两步：</p>
<ul>
<li>1.getDataForKey 通过key找缓存的数据</li>
<li>2.decodeString 对获取到的数据进行解码</li>
</ul>
<h4 id="getDataForKey"><a href="#getDataForKey" class="headerlink" title="getDataForKey"></a>getDataForKey</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">const</span> MMBuffer <span class="token operator">&amp;</span>MMKV<span class="token operator">::</span><span class="token function">getDataForKey</span><span class="token punctuation">(</span>MMKVKey_t key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkLoadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> itr <span class="token operator">=</span> m_dic<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>itr <span class="token operator">!=</span> m_dic<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> itr<span class="token operator">-</span><span class="token operator">></span>second<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> MMBuffer nan<span class="token punctuation">;</span>
    <span class="token keyword">return</span> nan<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于是一个多进程的组件，因此每一次进行读写之前都需要进行一次checkLoadData的校验。而这个方法从上文可知，通过crc校验码，写回计数，文件长度来判断文件是否发生了变更，是否追加删除数据，从而是否需要重新充内存文件中获取数据缓存到m_dic。</p>
<p>也因此，在getDataForKey方法中，可以直接从m_dic中通过key找value。</p>
<h4 id="decodeString"><a href="#decodeString" class="headerlink" title="decodeString"></a>decodeString</h4><pre class="line-numbers language-cpp"><code class="language-cpp">string MiniPBCoder<span class="token operator">::</span><span class="token function">decodeString</span><span class="token punctuation">(</span><span class="token keyword">const</span> MMBuffer <span class="token operator">&amp;</span>oData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MiniPBCoder <span class="token function">oCoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> oCoder<span class="token punctuation">.</span><span class="token function">decodeOneString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">string MiniPBCoder<span class="token operator">::</span><span class="token function">decodeOneString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m_inputData<span class="token operator">-</span><span class="token operator">></span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">string CodedInputData<span class="token operator">::</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    int32_t size <span class="token operator">=</span> <span class="token function">readRawVarint32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">length_error</span><span class="token punctuation">(</span><span class="token string">"InvalidProtocolBuffer negativeSize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> s_size <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">></span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s_size <span class="token operator">&lt;=</span> m_size <span class="token operator">-</span> m_position<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        string <span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>m_ptr <span class="token operator">+</span> m_position<span class="token punctuation">)</span><span class="token punctuation">,</span> s_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_position <span class="token operator">+</span><span class="token operator">=</span> s_size<span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">out_of_range</span><span class="token punctuation">(</span><span class="token string">"InvalidProtocolBuffer truncatedMessage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上很简单就是从m_dic找到对应的MMBuffer数据，此时的可以通过CodedInputData对MMBuffer对应的内存块(已经知道内存起始地址，长度)进行解析数据。</p>
<h3 id="MMKV-初始化读写的小结"><a href="#MMKV-初始化读写的小结" class="headerlink" title="MMKV 初始化读写的小结"></a>MMKV 初始化读写的小结</h3><p>当然可能有人觉得奇怪，当时encode不是已经加密了一个键值对的数据块了吗？为什么在读取时候没有进行AES的解析呢？这里就要说一下AES加密解密都是以128位为一个单位进行加解密。当我们调用loadFromFile方法的时候，在更新m_dic方法就会对整个缓存文件数据进行解密。怎么保证整个文件大小是16位的倍数呢？调用encrypt 也就是AES_cfb128_encrypt的加密时候就会进行一次保险的数据填充。</p>
<p>同理crc校验码实际上并非是对整个内存文件的数据进行一次校对，而实际上是对上一次存储的内存进行一次crc校对。如果上一次存储的内容crc校验码正常，则说明整个MMKV的读写是正确的。</p>
<p>那么我们可以理解MMKVMetaInfo中的m_lastConfirmedMetaInfo结构体的意思了。因为保证了每一次读写的正确性，因此如果想要恢复，只需要通过m_lastConfirmedMetaInfo记录最近一次读写的状态，对meta_file进行恢复即可达到原来的MMKV应有的配置。</p>
<h3 id="MMKV-进程锁设计"><a href="#MMKV-进程锁设计" class="headerlink" title="MMKV 进程锁设计"></a>MMKV 进程锁设计</h3><p>MMKV作为一个多进程组件，其多进程如何进行同步也是值得我们学习的。重新回顾一下，进程的文件锁有几种操作方式：</p>
<blockquote>
<ol>
<li>LOCK_EX 排他锁 定义的代码范围中只允许一个进程操作</li>
<li>LOCK_SH 共享锁 定义的代码范围中允许多个进程操作</li>
<li>LOCK_UN 释放锁 释放锁定的区域</li>
</ol>
</blockquote>
<p>其实在早两年前，我写过一章关于线程的设计与思考。其中有聊到过读写锁。其实对于一个文件还是内存读写而言，最害怕的是读取出来的信息有误。有什么方法避免呢？其实就可以通过读写锁的设计进行避免。当写的时候只允许一个进程或者线程，这样就能保证文件或者内存中的内容不变。这样读取数据的时候也没有必要进行加锁处理。这种思路在进程锁也是同理。</p>
<p>所以在MMKV中用排他锁作为写锁，用共享锁作为读锁。</p>
<p>这是一个很简单且通用的思想。但是MMKV选择自己实现了一个文件锁？而不是直接使用Linux系统提供的api flock，这是为什么呢？这就是大神和普通程序员的区别了。</p>
<p>他们除了考虑了单一锁的情况，还考虑更加特殊常见的锁加完再加锁的递归锁问题以及锁的升降级。文件锁不支持锁的升降级。如果支持锁的升级，容易发生死锁。</p>
<blockquote>
<p>死锁发生的四个条件：<br>1.互斥条件： 一段时间内资源只允许一个任务持有<br>2.不可剥夺条件： 任务所获的的资源只能由自己释放<br>3.请求与保持条件：任务已经持有了一个资源，但是又提出了新的资源请求，而该资源被另一个任务持有，此时请求的行为被阻塞，不释放自己的资源<br>4.循环等待 若干任务形成首尾相接的循环等待资源</p>
</blockquote>
<p>死锁产生的两个原因:</p>
<blockquote>
<p>1.系统资源的竞争<br>2.任务运行的推进顺序顺序不当</p>
</blockquote>
<p>注:这里的任务特指进程或者线程</p>
<p>在这个过程中，如果2个进程中持有了读锁，都想升级为写锁，就可能被阻塞进入到死锁状态。其次文件锁也不支持锁的降级，一旦解开了就消失了。</p>
<p>可以在MMKV的构造函数中，知道有两种进程锁会存在其中。一个是排他锁，一个是共享锁。他们的类型都是InterProcessLock。InterProcessLock其中的核心就是FileLock文件锁。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">InterProcessLock</span> <span class="token punctuation">{</span>
    FileLock <span class="token operator">*</span>m_fileLock<span class="token punctuation">;</span>
    LockType m_lockType<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">InterProcessLock</span><span class="token punctuation">(</span>FileLock <span class="token operator">*</span>fileLock<span class="token punctuation">,</span> LockType lockType<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">m_fileLock</span><span class="token punctuation">(</span>fileLock<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_lockType</span><span class="token punctuation">(</span>lockType<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_enable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MMKV_ASSERT</span><span class="token punctuation">(</span>m_fileLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> m_enable<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m_fileLock<span class="token operator">-</span><span class="token operator">></span><span class="token function">lock</span><span class="token punctuation">(</span>m_lockType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> <span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> m_fileLock<span class="token operator">-</span><span class="token operator">></span><span class="token function">try_lock</span><span class="token punctuation">(</span>m_lockType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m_fileLock<span class="token operator">-</span><span class="token operator">></span><span class="token function">unlock</span><span class="token punctuation">(</span>m_lockType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面对应MMKV Java的native api有三个，lock，unlock，try_lock。分别是上锁，解锁，尝试上锁。我们先来看看上锁逻辑</p>
<h4 id="MMKV-文件锁上锁"><a href="#MMKV-文件锁上锁" class="headerlink" title="MMKV 文件锁上锁"></a>MMKV 文件锁上锁</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> FileLock<span class="token operator">::</span><span class="token function">lock</span><span class="token punctuation">(</span>LockType lockType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doLock</span><span class="token punctuation">(</span>lockType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> FileLock<span class="token operator">::</span><span class="token function">try_lock</span><span class="token punctuation">(</span>LockType lockType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doLock</span><span class="token punctuation">(</span>lockType<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到本质上就是一个都是调用doLock方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> FileLock<span class="token operator">::</span><span class="token function">doLock</span><span class="token punctuation">(</span>LockType lockType<span class="token punctuation">,</span> <span class="token keyword">bool</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFileLockValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> unLockFirstIfNeeded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>lockType <span class="token operator">==</span> SharedLockType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// don't want shared-lock to break any existing locks</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_sharedLockCount <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> m_exclusiveLockCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m_sharedLockCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// don't want exclusive-lock to break existing exclusive-locks</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_exclusiveLockCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m_exclusiveLockCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// prevent deadlock</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_sharedLockCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            unLockFirstIfNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> ret <span class="token operator">=</span> <span class="token function">platformLock</span><span class="token punctuation">(</span>lockType<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> unLockFirstIfNeeded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lockType <span class="token operator">==</span> SharedLockType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m_sharedLockCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            m_exclusiveLockCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.如果是共享锁想要加锁，判断到已经有共享锁或者排他锁已经在本进程已经添加了，此时共享锁直接返回true，不需要真的调用lock方法。</li>
<li>2.排斥锁类型想要加锁，如果发现已经加了排他锁(m_exclusiveLockCount 排他锁计数)，则直接返回。如果m_sharedLockCount 共享锁加锁计数大于0则设置unLockFirstIfNeeded为true(防止死锁)。</li>
</ul>
<p>换句话说，如果是共享锁想要加锁，只有m_sharedLockCount和m_exclusiveLockCount计数都为0，才会真的走到platformLock执行。</p>
<p>如果排他锁想要加锁，只有m_exclusiveLockCount 排他锁计数为0才会执行platformLock。</p>
<p>只有platformLock 执行成功了，才会给对应类型锁的对应计数+1.</p>
<h4 id="platformLock"><a href="#platformLock" class="headerlink" title="platformLock"></a>platformLock</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> int32_t <span class="token function">LockType2FlockType</span><span class="token punctuation">(</span>LockType lockType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>lockType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> SharedLockType<span class="token operator">:</span>
            <span class="token keyword">return</span> LOCK_SH<span class="token punctuation">;</span>
        <span class="token keyword">case</span> ExclusiveLockType<span class="token operator">:</span>
            <span class="token keyword">return</span> LOCK_EX<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> LOCK_EX<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> FileLock<span class="token operator">::</span><span class="token function">platformLock</span><span class="token punctuation">(</span>LockType lockType<span class="token punctuation">,</span> <span class="token keyword">bool</span> wait<span class="token punctuation">,</span> <span class="token keyword">bool</span> unLockFirstIfNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#    <span class="token directive keyword">ifdef</span> MMKV_ANDROID</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_isAshmem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">ashmemLock</span><span class="token punctuation">(</span>lockType<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> unLockFirstIfNeeded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#    <span class="token directive keyword">endif</span></span>
    <span class="token keyword">auto</span> realLockType <span class="token operator">=</span> <span class="token function">LockType2FlockType</span><span class="token punctuation">(</span>lockType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> cmd <span class="token operator">=</span> wait <span class="token operator">?</span> realLockType <span class="token operator">:</span> <span class="token punctuation">(</span>realLockType <span class="token operator">|</span> LOCK_NB<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unLockFirstIfNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// try lock</span>
        <span class="token keyword">auto</span> ret <span class="token operator">=</span> <span class="token function">flock</span><span class="token punctuation">(</span>m_fd<span class="token punctuation">,</span> realLockType <span class="token operator">|</span> LOCK_NB<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// let's be gentleman: unlock my shared-lock to prevent deadlock</span>
        ret <span class="token operator">=</span> <span class="token function">flock</span><span class="token punctuation">(</span>m_fd<span class="token punctuation">,</span> LOCK_UN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> ret <span class="token operator">=</span> <span class="token function">flock</span><span class="token punctuation">(</span>m_fd<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">// try recover my shared-lock</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>unLockFirstIfNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ret <span class="token operator">=</span> <span class="token function">flock</span><span class="token punctuation">(</span>m_fd<span class="token punctuation">,</span> <span class="token function">LockType2FlockType</span><span class="token punctuation">(</span>SharedLockType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// let's hope this never happen</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果发现锁是Ashmem匿名内存的锁，则调用ashmemLock处理</p>
</li>
<li><p>2.unLockFirstIfNeeded 这个标志位只有在排他锁(写锁)想要上锁的时候，发现有共享锁(读锁)已经上锁了才为true。则会尝试进行进行排他锁(写锁)的阻塞的上锁等待，一旦失败，则解开共享锁(读锁)，在加上排他锁(写锁)。这样能避免2个读锁同时存在，另一个进程也想升级成排他锁(写锁)。</p>
</li>
<li><p>3.其他情况则根据wait标志位来决定是否需要进行阻塞,这就是tryLock和lock的区别，tryLock不会阻塞。</p>
</li>
<li><p>4.最后如果此时已经有读锁，想上写锁的情况下，则会把写锁降级为读锁并返回false。</p>
</li>
</ul>
<p>到这里就完成了MMKV的进程锁的解析。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>限于篇幅问题，MMKV的源码解析到这里就结束了。不过MMKV比较核心的思想已经解析了，剩下的就是关于AES和CRC校验算法，以及Ashmem如何进行同步的问题。不过有了这些基础，继续研读MMKV代码就不会那么吃力了。</p>
<p>老规矩，先用一幅图来总结MMKV:<br><img src="/images/MMKV.jpg" alt="MMKV.jpg"></p>
<p>其实从<a href="https://www.jianshu.com/p/5061860545ef" target="_blank" rel="noopener">OKio</a>一文中我已经讨论过几种基于映射的共享内存读写和普通的io读写的区别。</p>
<p>由于MMKV读写是直接读写到mmap文件映射的内存上，绕开了普通读写io需要进入内核，写到磁盘的过程。光是这种级别优化，都可以拉开三个数量级的性能差距。但是也诞生了一个很大的问题，一个进程在32位的机子中有4g的虚拟内存限制，而我们把文件映射到虚拟内存中，如果文件过大虚拟内存就会出现大量的消耗最后出现异常，对于不熟悉Linux的朋友就无法理解这种现象。</p>
<p>当然这里不说OOM是因为Java虚拟机在初始化时候就提前预定好一段映射的内存，这里暂时不说了，之后会有虚拟机解析的专题，我们在详细聊聊。</p>
<p>阅读源码后，这里有几个关于MMKV使用的注意事项：</p>
<ul>
<li><p>1.保证每一个文件存储的数据都比较小，也就说需要把数据根据业务线存储分散。这要就不会把虚拟内存消耗过快。</p>
</li>
<li><p>2.还需要在适当的时候释放一部分内存数据，比如在App中监听onTrimMemory方法，在Java内存吃紧的情况下进行MMKV的trim操作(不准确，我们暂时以此为信号，最好自己监听进程中内存使用情况)。</p>
</li>
<li><p>2.在不需要使用的时候，最好把MMKV给close掉。甚至调用exit方法。</p>
</li>
</ul>
<p>SharedPreferences的源码解析放到下一篇，我们来快速看看为什么SharedPreferences会出现卡顿甚至ANR，我们该怎么自定义一个属于自己的SharedPreferences</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/05/04/android-chong-xue-xi-lie-sharedpreferences-yuan-ma-jie-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Android 重学系列 SharedPreferences源码解析">
                        
                        <span class="card-title">Android 重学系列 SharedPreferences源码解析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言分析了MMKV的源码解析后，我们来看看Android中常用的键值对组件SharedPreferences的实现。究竟源码中出现了什么问题，导致了SharedPreferences的卡顿和ANR呢？
正文关于SharedPreferenc
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-05-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-Framework/" class="post-category">
                                    Android Framework
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                    <a href="/tags/性能优化/">
                        <span class="chip bg-color">性能优化</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/04/19/android-chong-xue-xi-lie-surfaceview-he-textureview-yuan-ma-qian-xi-xia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="Android 重学系列 SurfaceView和TextureView 源码浅析(下)">
                        
                        <span class="card-title">Android 重学系列 SurfaceView和TextureView 源码浅析(下)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章和大家论述了SurfaceView的核心原理，本文和大家聊聊TextureView的核心原理。
如果发现什么地方写的有问题，欢迎来本文https://www.jianshu.com/p/1dce98846dc7指出。
正文Te
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-04-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-Framework/" class="post-category">
                                    Android Framework
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
