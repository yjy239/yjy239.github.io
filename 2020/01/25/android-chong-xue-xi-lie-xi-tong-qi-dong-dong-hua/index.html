<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 系统启动动画, Android | Linux | Flutter">
    <meta name="description" content="前言经过上一篇文章的探索和学习，相信大家对Hal 层的运作原理以及SF如何监听Hal层返回的回调有一定的了解。
原本应该是聊如何申请图元的，但是感觉和前文的逻辑割裂有点大，还是继续按照SF初始化，开机的逻辑顺序继续走下去。这一次就让我们聊聊">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 系统启动动画 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/14.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 系统启动动画
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                SurfaceFlinger
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-01-25
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        6.9k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        34 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>经过上一篇文章的探索和学习，相信大家对Hal 层的运作原理以及SF如何监听Hal层返回的回调有一定的了解。</p>
<p>原本应该是聊如何申请图元的，但是感觉和前文的逻辑割裂有点大，还是继续按照SF初始化，开机的逻辑顺序继续走下去。这一次就让我们聊聊系统启动动画吧。</p>
<p>带着这个疑问去阅读，开机的时候没有Activity为什么可以播放开机动画呢？注意Android系统中存在几个开机动画，这里不去聊Linux开机动画，我们只聊Android渲染系统中的开机动画，也就是我们打开手机时候的那个动画。</p>
<p>如果遇到问题，可以到本文来讨论<a href="https://www.jianshu.com/p/a79de4a6d83c" target="_blank" rel="noopener">https://www.jianshu.com/p/a79de4a6d83c</a></p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="解析init-rc-service的原理"><a href="#解析init-rc-service的原理" class="headerlink" title="解析init.rc service的原理"></a>解析init.rc service的原理</h2><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/cmds/" target="_blank" rel="noopener">cmds</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/cmds/bootanimation/" target="_blank" rel="noopener">bootanimation</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/cmds/bootanimation/bootanim.rc" target="_blank" rel="noopener">bootanim.rc</a></p>
<pre><code>service bootanim /system/bin/bootanimation
    class core animation
    user graphics
    group graphics audio
    disabled
    oneshot
    writepid /dev/stune/top-app/tasks</code></pre><p>开机就启动进程，那肯定就要从rc里面找。负责开机动画的进程是bootanimation。上面是他的rc文件。值得注意的是，设置了disable标志位。</p>
<p>我们翻翻看在init进程,是怎么解析service的。在Android9.0中实际上会把service，action，import等都会进行字符串解析额，最后分散在三个链表等待执行。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/init/" target="_blank" rel="noopener">init</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/init/service.cpp" target="_blank" rel="noopener">service.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">const</span> Service<span class="token operator">::</span>OptionParserMap<span class="token operator">::</span>Map<span class="token operator">&amp;</span> Service<span class="token operator">::</span>OptionParserMap<span class="token operator">::</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">constexpr</span> std<span class="token operator">::</span>size_t kMax <span class="token operator">=</span> std<span class="token operator">::</span>numeric_limits<span class="token operator">&lt;</span>std<span class="token operator">::</span>size_t<span class="token operator">></span><span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// clang-format off</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> Map option_parsers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span><span class="token string">"capabilities"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     kMax<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseCapabilities<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"class"</span><span class="token punctuation">,</span>       <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     kMax<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseClass<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"console"</span><span class="token punctuation">,</span>     <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseConsole<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"critical"</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseCritical<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"disabled"</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseDisabled<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"enter_namespace"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span>     <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseEnterNamespace<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"group"</span><span class="token punctuation">,</span>       <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     NR_SVC_SUPP_GIDS <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseGroup<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"interface"</span><span class="token punctuation">,</span>   <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span>     <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseInterface<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"ioprio"</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span>     <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseIoprio<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"priority"</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParsePriority<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"keycodes"</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     kMax<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseKeycodes<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"oneshot"</span><span class="token punctuation">,</span>     <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseOneshot<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"onrestart"</span><span class="token punctuation">,</span>   <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     kMax<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseOnrestart<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"override"</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseOverride<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"oom_score_adjust"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseOomScoreAdjust<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"memcg.swappiness"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseMemcgSwappiness<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"memcg.soft_limit_in_bytes"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseMemcgSoftLimitInBytes<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"memcg.limit_in_bytes"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseMemcgLimitInBytes<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"namespace"</span><span class="token punctuation">,</span>   <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseNamespace<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"rlimit"</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span>     <span class="token number">3</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseProcessRlimit<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"seclabel"</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseSeclabel<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"setenv"</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span>     <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseSetenv<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"shutdown"</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseShutdown<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"socket"</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span>     <span class="token number">6</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseSocket<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"file"</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span>     <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseFile<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"user"</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseUser<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"writepid"</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     kMax<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Service<span class="token operator">::</span>ParseWritepid<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// clang-format on</span>
    <span class="token keyword">return</span> option_parsers<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个map中写好了每一个命令对应的解析方法指针。我们直接看看disable做了什么：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Result<span class="token operator">&lt;</span>Success<span class="token operator">></span> Service<span class="token operator">::</span><span class="token function">ParseDisabled</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    flags_ <span class="token operator">|</span><span class="token operator">=</span> SVC_DISABLED<span class="token punctuation">;</span>
    flags_ <span class="token operator">|</span><span class="token operator">=</span> SVC_RC_DISABLED<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单就是设置了DISABLED的flag。</p>
<p>当解析完毕将会尝试着执行解析好的service的命令。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Result<span class="token operator">&lt;</span>Success<span class="token operator">></span> Service<span class="token operator">::</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">bool</span> disabled <span class="token operator">=</span> <span class="token punctuation">(</span>flags_ <span class="token operator">&amp;</span> <span class="token punctuation">(</span>SVC_DISABLED <span class="token operator">|</span> SVC_RESET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    flags_ <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token punctuation">(</span>SVC_DISABLED<span class="token operator">|</span>SVC_RESTARTING<span class="token operator">|</span>SVC_RESET<span class="token operator">|</span>SVC_RESTART<span class="token operator">|</span>SVC_DISABLED_START<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags_ <span class="token operator">&amp;</span> SVC_RUNNING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags_ <span class="token operator">&amp;</span> SVC_ONESHOT<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> disabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            flags_ <span class="token operator">|</span><span class="token operator">=</span> SVC_RESTART<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// It is not an error to try to start a service that is already running.</span>
        <span class="token keyword">return</span> <span class="token function">Success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> needs_console <span class="token operator">=</span> <span class="token punctuation">(</span>flags_ <span class="token operator">&amp;</span> SVC_CONSOLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>needs_console<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>console_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console_ <span class="token operator">=</span> default_console<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">int</span> console_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>console_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>console_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            flags_ <span class="token operator">|</span><span class="token operator">=</span> SVC_DISABLED<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">ErrnoError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Couldn't open console '"</span> <span class="token operator">&lt;&lt;</span> console_ <span class="token operator">&lt;&lt;</span> <span class="token string">"'"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">close</span><span class="token punctuation">(</span>console_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    pid_t pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>namespace_flags_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pid <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> namespace_flags_ <span class="token operator">|</span> SIGCHLD<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pid_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">ErrnoError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to fork"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token function">Success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到如果没有disable，reset这些标志位阻碍，将会通过fork系统生成一个新的进程。但是这里disable了，因此不会走下来，而是会把解析结果保存起来。保存在ServiceList对象中的services_  vector集合。</p>
<p>到这里似乎逻辑断开了，我们先把思路阻塞到这里。稍后就能看到。</p>
<h2 id="SF启动开机动画"><a href="#SF启动开机动画" class="headerlink" title="SF启动开机动画"></a>SF启动开机动画</h2><p>在SF的init方法中，我为了独立出一节出来，故意有一段没有解析。如下：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp" target="_blank" rel="noopener">SurfaceFlinger.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getHwComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasCapability</span><span class="token punctuation">(</span>
            HWC2<span class="token operator">::</span>Capability<span class="token operator">::</span>PresentFenceIsNotReliable<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mStartPropertySetThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">StartPropertySetThread</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mStartPropertySetThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">StartPropertySetThread</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartPropertySetThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Run StartPropertySetThread failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法是干什么的呢？我第一次看的时候差点看漏了，差点找不到哪里启动开机动画，其实是把事情交给了StartPropertySetThread完成。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/StartPropertySetThread.cpp" target="_blank" rel="noopener">StartPropertySetThread.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">StartPropertySetThread<span class="token operator">::</span><span class="token function">StartPropertySetThread</span><span class="token punctuation">(</span><span class="token keyword">bool</span> timestampPropertyValue<span class="token punctuation">)</span><span class="token operator">:</span>
        <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mTimestampPropertyValue</span><span class="token punctuation">(</span>timestampPropertyValue<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

status_t StartPropertySetThread<span class="token operator">::</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token string">"SurfaceFlinger::StartPropertySetThread"</span><span class="token punctuation">,</span> PRIORITY_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> StartPropertySetThread<span class="token operator">::</span><span class="token function">threadLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Set property service.sf.present_timestamp, consumer need check its readiness</span>
    <span class="token function">property_set</span><span class="token punctuation">(</span>kTimestampProperty<span class="token punctuation">,</span> mTimestampPropertyValue <span class="token operator">?</span> <span class="token string">"1"</span> <span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Clear BootAnimation exit flag</span>
    <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"service.bootanim.exit"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Start BootAnimation if not started</span>
    <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"ctl.start"</span><span class="token punctuation">,</span> <span class="token string">"bootanim"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Exit immediately</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这里设置了两个系统属性，一个是service.bootanim.exit设置为0，另一个则是开机的关键，设置了ctl.start中的参数为bootanim。这样就能启动开机动画的进程。</p>
<p>为什么如此呢？我们还是要回到init进程的main函数中。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/init/" target="_blank" rel="noopener">init</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/init/init.cpp" target="_blank" rel="noopener">init.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">start_property_service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">const</span> BuiltinFunctionMap function_map<span class="token punctuation">;</span>
    Action<span class="token operator">::</span><span class="token function">set_function_map</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>function_map<span class="token punctuation">)</span><span class="token punctuation">;</span>

    subcontexts <span class="token operator">=</span> <span class="token function">InitializeSubcontexts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ActionManager<span class="token operator">&amp;</span> am <span class="token operator">=</span> ActionManager<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ServiceList<span class="token operator">&amp;</span> sm <span class="token operator">=</span> ServiceList<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LoadBootScripts</span><span class="token punctuation">(</span>am<span class="token punctuation">,</span> sm<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Turning this on and letting the INFO logging be discarded adds 0.2s to</span>
    <span class="token comment" spellcheck="true">// Nexus 9 boot time, so it's disabled by default.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token function">DumpState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"early-init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>wait_for_coldboot_done_action<span class="token punctuation">,</span> <span class="token string">"wait_for_coldboot_done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ... so that we can start queuing up actions that require stuff from /dev.</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>MixHwrngIntoLinuxRngAction<span class="token punctuation">,</span> <span class="token string">"MixHwrngIntoLinuxRng"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>SetMmapRndBitsAction<span class="token punctuation">,</span> <span class="token string">"SetMmapRndBits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>SetKptrRestrictAction<span class="token punctuation">,</span> <span class="token string">"SetKptrRestrict"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>keychord_init_action<span class="token punctuation">,</span> <span class="token string">"keychord_init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>console_init_action<span class="token punctuation">,</span> <span class="token string">"console_init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Trigger all the boot actions to get us started.</span>
    am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span>
    <span class="token comment" spellcheck="true">// wasn't ready immediately after wait_for_coldboot_done</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>MixHwrngIntoLinuxRngAction<span class="token punctuation">,</span> <span class="token string">"MixHwrngIntoLinuxRng"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Don't mount filesystems or start core system services in charger mode.</span>
    std<span class="token operator">::</span>string bootmode <span class="token operator">=</span> <span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"ro.bootmode"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bootmode <span class="token operator">==</span> <span class="token string">"charger"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"charger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"late-init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Run all property triggers based on current state of the properties.</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>queue_property_triggers_action<span class="token punctuation">,</span> <span class="token string">"queue_property_triggers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们忽律掉最下面init.cpp监听epoll消息的逻辑，其实在这个过程中还通过start_property_service启动了一个检测Android全局配置属性变化服务。</p>
<p>文件：<a href="http://androidxref.com/9.0.0_r3/xref/system/core/init/property_service.cpp" target="_blank" rel="noopener">http://androidxref.com/9.0.0_r3/xref/system/core/init/property_service.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">start_property_service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    selinux_callback cb<span class="token punctuation">;</span>
    cb<span class="token punctuation">.</span>func_audit <span class="token operator">=</span> SelinuxAuditCallback<span class="token punctuation">;</span>
    <span class="token function">selinux_set_callback</span><span class="token punctuation">(</span>SELINUX_CB_AUDIT<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"ro.property_service.version"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    property_set_fd <span class="token operator">=</span> <span class="token function">CreateSocket</span><span class="token punctuation">(</span>PROP_SERVICE_NAME<span class="token punctuation">,</span> SOCK_STREAM <span class="token operator">|</span> SOCK_CLOEXEC <span class="token operator">|</span> SOCK_NONBLOCK<span class="token punctuation">,</span>
                                   <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>property_set_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token function">listen</span><span class="token punctuation">(</span>property_set_fd<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">register_epoll_handler</span><span class="token punctuation">(</span>property_set_fd<span class="token punctuation">,</span> handle_property_set_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个过程中，设置了版本号为2，启动了一个名字为property_service的socket服务。然后对这个服务进行监听，把property_set_fd注册到poll中，注册一个handle_property_set_fd回调事件。</p>
<p>我们先来看看property_set中做了什么事情：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/" target="_blank" rel="noopener">bionic</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/" target="_blank" rel="noopener">libc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/bionic/" target="_blank" rel="noopener">bionic</a>/<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/bionic/system_property_set.cpp" target="_blank" rel="noopener">system_property_set.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">__system_property_set</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> value <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>g_propservice_protocol_version <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">detect_protocol_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>g_propservice_protocol_version <span class="token operator">==</span> kProtocolVersion1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">>=</span> PROP_VALUE_MAX <span class="token operator">&amp;&amp;</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"ro."</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Use proper protocol</span>
    PropertyServiceConnection connection<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      errno <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    SocketWriter <span class="token function">writer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>writer<span class="token punctuation">.</span><span class="token function">WriteUint32</span><span class="token punctuation">(</span>PROP_MSG_SETPROP2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      errno <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">RecvInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      errno <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为版本号为2.其实它就会走下面的分之，此时能看到这不是简单的写入文件，而是写到了一个socket 中。</p>
<p>而这个socket是什么？</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> property_service_socket<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/dev/socket/"</span> PROP_SERVICE_NAME<span class="token punctuation">;</span>

<span class="token function">PropertyServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">last_error_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    socket_ <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">socket</span><span class="token punctuation">(</span>AF_LOCAL<span class="token punctuation">,</span> SOCK_STREAM <span class="token operator">|</span> SOCK_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>socket_ <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      last_error_ <span class="token operator">=</span> errno<span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> size_t namelen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>property_service_socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sockaddr_un addr<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strlcpy</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sun_path<span class="token punctuation">,</span> property_service_socket<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sun_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addr<span class="token punctuation">.</span>sun_family <span class="token operator">=</span> AF_LOCAL<span class="token punctuation">;</span>
    socklen_t alen <span class="token operator">=</span> namelen <span class="token operator">+</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>sockaddr_un<span class="token punctuation">,</span> sun_path<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>socket_<span class="token punctuation">,</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>sockaddr<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">,</span> alen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      last_error_ <span class="token operator">=</span> errno<span class="token punctuation">;</span>
      <span class="token function">close</span><span class="token punctuation">(</span>socket_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      socket_ <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们能看到他的地址其实是dev/socket下的property_service。也就是刚好是上面注册的socket。</p>
<p>关键来看这个方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handle_property_set_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">constexpr</span> uint32_t kDefaultSocketTimeout <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* ms */</span>

    <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">accept4</span><span class="token punctuation">(</span>property_set_fd<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> SOCK_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ucred cr<span class="token punctuation">;</span>
    socklen_t cr_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getsockopt</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_PEERCRED<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cr_size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    SocketConnection <span class="token function">socket</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint32_t timeout_ms <span class="token operator">=</span> kDefaultSocketTimeout<span class="token punctuation">;</span>

    uint32_t cmd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>socket<span class="token punctuation">.</span><span class="token function">RecvUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeout_ms<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        socket<span class="token punctuation">.</span><span class="token function">SendUint32</span><span class="token punctuation">(</span>PROP_ERROR_READ_CMD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> PROP_MSG_SETPROP<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">case</span> PROP_MSG_SETPROP2<span class="token operator">:</span> <span class="token punctuation">{</span>
        std<span class="token operator">::</span>string name<span class="token punctuation">;</span>
        std<span class="token operator">::</span>string value<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>socket<span class="token punctuation">.</span><span class="token function">RecvString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeout_ms<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token operator">!</span>socket<span class="token punctuation">.</span><span class="token function">RecvString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeout_ms<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

          socket<span class="token punctuation">.</span><span class="token function">SendUint32</span><span class="token punctuation">(</span>PROP_ERROR_READ_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> cr <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">cred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>string error<span class="token punctuation">;</span>
        uint32_t result <span class="token operator">=</span> <span class="token function">HandlePropertySet</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> socket<span class="token punctuation">.</span><span class="token function">source_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> PROP_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        socket<span class="token punctuation">.</span><span class="token function">SendUint32</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
        socket<span class="token punctuation">.</span><span class="token function">SendUint32</span><span class="token punctuation">(</span>PROP_ERROR_INVALID_CMD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面得知，首先会写入PROP_MSG_SETPROP2一个命令，此时就会走到下面这个分之，接着通过RecvString读取数据内容，执行HandlePropertySet。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">uint32_t <span class="token function">HandlePropertySet</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> value<span class="token punctuation">,</span>
                           <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> source_context<span class="token punctuation">,</span> <span class="token keyword">const</span> ucred<span class="token operator">&amp;</span> cr<span class="token punctuation">,</span> std<span class="token operator">::</span>string<span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">StartsWith</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"ctl."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CheckControlPropertyPerms</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> source_context<span class="token punctuation">,</span> cr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token function">StringPrintf</span><span class="token punctuation">(</span><span class="token string">"Invalid permissions to perform '%s' on '%s'"</span><span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span>
                                  value<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> PROP_ERROR_HANDLE_CONTROL_MESSAGE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">HandleControlMessage</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> cr<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> PROP_SUCCESS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> <span class="token function">PropertySet</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在SF中输送了两个属性过来，其中使用HandleControlMessage对ctl.进行了特殊处理。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/init/" target="_blank" rel="noopener">init</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/init/init.cpp" target="_blank" rel="noopener">init.cpp</a></p>
<pre><code>static const std::map&lt;std::string, ControlMessageFunction&gt;&amp; get_control_message_map() {
    // clang-format off
    static const std::map&lt;std::string, ControlMessageFunction&gt; control_message_functions = {
        {"start",             {ControlTarget::SERVICE,   DoControlStart}},
        {"stop",              {ControlTarget::SERVICE,   DoControlStop}},
        {"restart",           {ControlTarget::SERVICE,   DoControlRestart}},
        {"interface_start",   {ControlTarget::INTERFACE, DoControlStart}},
        {"interface_stop",    {ControlTarget::INTERFACE, DoControlStop}},
        {"interface_restart", {ControlTarget::INTERFACE, DoControlRestart}},
    };
    // clang-format on

    return control_message_functions;
}

static Result&lt;Success&gt; DoControlStart(Service* service) {
    return service-&gt;Start();
}


void HandleControlMessage(const std::string&amp; msg, const std::string&amp; name, pid_t pid) {
    const auto&amp; map = get_control_message_map();
    const auto it = map.find(msg);

    if (it == map.end()) {
    ...
        return;
    }

    std::string cmdline_path = StringPrintf("proc/%d/cmdline", pid);
    std::string process_cmdline;
    if (ReadFileToString(cmdline_path, &amp;process_cmdline)) {
        std::replace(process_cmdline.begin(), process_cmdline.end(), '\0', ' ');
        process_cmdline = Trim(process_cmdline);
    } else {
        process_cmdline = "unknown process";
    }

...
    const ControlMessageFunction&amp; function = it-&gt;second;

    if (function.target == ControlTarget::SERVICE) {
        Service* svc = ServiceList::GetInstance().FindService(name);
        if (svc == nullptr) {
...
            return;
        }
        if (auto result = function.action(svc); !result) {
...
        }

        return;
    }

....
}</code></pre><p>这里面的逻辑十分简单，本质上就是继续获取从property_set传递过来后续的字符串。也就是ctl.xxx点后面的命令对应的方法。并且先通过serviceList找到解析好的服务，调用缓存在map中命令start对应的方法指针，也就是service的start。就重新走到上面Service::Start fork出进程的逻辑中。</p>
<h2 id="BootAnimation进程启动"><a href="#BootAnimation进程启动" class="headerlink" title="BootAnimation进程启动"></a>BootAnimation进程启动</h2><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">setpriority</span><span class="token punctuation">(</span>PRIO_PROCESS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ANDROID_PRIORITY_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> noBootAnimation <span class="token operator">=</span> <span class="token function">bootAnimationDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ALOGI_IF</span><span class="token punctuation">(</span>noBootAnimation<span class="token punctuation">,</span>  <span class="token string">"boot animation disabled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>noBootAnimation<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        sp<span class="token operator">&lt;</span>ProcessState<span class="token operator">></span> <span class="token function">proc</span><span class="token punctuation">(</span>ProcessState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ProcessState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">waitForSurfaceFlinger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// create the boot animation object</span>
        sp<span class="token operator">&lt;</span>BootAnimation<span class="token operator">></span> boot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BootAnimation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">AudioAnimationCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"Boot animation set up. Joining pool."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        IPCThreadState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">joinThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"Boot animation exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先默认当前noBootAnimation是false。因此会初始化Binder的驱动，调用waitForSurfaceFlinger从serviceManager中查找SF进程，找到才生成一个BootAnimation对象准备执行开机动画，并设置了一个音轨的回调。</p>
<h3 id="BootAnimation-初始化"><a href="#BootAnimation-初始化" class="headerlink" title="BootAnimation 初始化"></a>BootAnimation 初始化</h3><p>接下来就会揭开本片文章的秘密，为什么没有Activity还是能够显示界面。其核心原理是什么。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/cmds/" target="_blank" rel="noopener">cmds</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/cmds/bootanimation/" target="_blank" rel="noopener">bootanimation</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/cmds/bootanimation/BootAnimation.cpp" target="_blank" rel="noopener">BootAnimation.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">BootAnimation<span class="token operator">::</span><span class="token function">BootAnimation</span><span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>Callbacks<span class="token operator">></span> callbacks<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mClockEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mTimeIsAccurate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mTimeFormat12Hour</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mTimeCheckThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mCallbacks</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">SurfaceComposerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个构造函数中，生成了一个十分重要的对象SurfaceComposerClient。因为SurfaceComposerClient是一个sp强智能指针，会继续走到onFirstRef中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceComposerClient<span class="token operator">::</span><span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>ISurfaceComposer<span class="token operator">></span> <span class="token function">sf</span><span class="token punctuation">(</span>ComposerService<span class="token operator">::</span><span class="token function">getComposerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sf <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mStatus <span class="token operator">==</span> NO_INIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> rootProducer <span class="token operator">=</span> mParent<span class="token punctuation">.</span><span class="token function">promote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sp<span class="token operator">&lt;</span>ISurfaceComposerClient<span class="token operator">></span> conn<span class="token punctuation">;</span>
        conn <span class="token operator">=</span> <span class="token punctuation">(</span>rootProducer <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">?</span> sf<span class="token operator">-</span><span class="token operator">></span><span class="token function">createScopedConnection</span><span class="token punctuation">(</span>rootProducer<span class="token punctuation">)</span> <span class="token operator">:</span>
                sf<span class="token operator">-</span><span class="token operator">></span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mClient <span class="token operator">=</span> conn<span class="token punctuation">;</span>
            mStatus <span class="token operator">=</span> NO_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先拿到一个单例的ComposerService 服务对象，接着通过ISurfaceComposer通过createScopedConnection通信创建一个ISurfaceComposerClient。</p>
<p>ISurfaceComposer指代的是什么，ISurfaceComposerClient又是指什么呢？</p>
<h4 id="ComposerService的初始化"><a href="#ComposerService的初始化" class="headerlink" title="ComposerService的初始化"></a>ComposerService的初始化</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/*static*/</span> sp<span class="token operator">&lt;</span>ISurfaceComposer<span class="token operator">></span> ComposerService<span class="token operator">::</span><span class="token function">getComposerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ComposerService<span class="token operator">&amp;</span> instance <span class="token operator">=</span> ComposerService<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>mComposerService <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ComposerService<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connectLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>mComposerService <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"ComposerService reconnected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">.</span>mComposerService<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到它实际上是一个单例设计,返回了ISurfaceComposer对象。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">ComposerService<span class="token operator">::</span><span class="token function">ComposerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">:</span> Singleton<span class="token operator">&lt;</span>ComposerService<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connectLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ComposerService<span class="token operator">::</span><span class="token function">connectLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> String16 <span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"SurfaceFlinger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">getService</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mComposerService<span class="token punctuation">)</span> <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">250000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>mComposerService <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Create the death listener.</span>
    <span class="token keyword">class</span> <span class="token class-name">DeathObserver</span> <span class="token operator">:</span> <span class="token keyword">public</span> IBinder<span class="token operator">::</span>DeathRecipient <span class="token punctuation">{</span>
        ComposerService<span class="token operator">&amp;</span> mComposerService<span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">binderDied</span><span class="token punctuation">(</span><span class="token keyword">const</span> wp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> who<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"ComposerService remote (surfaceflinger) died [%p]"</span><span class="token punctuation">,</span>
                  who<span class="token punctuation">.</span><span class="token function">unsafe_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mComposerService<span class="token punctuation">.</span><span class="token function">composerServiceDied</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">explicit</span> <span class="token function">DeathObserver</span><span class="token punctuation">(</span>ComposerService<span class="token operator">&amp;</span> mgr<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">mComposerService</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    mDeathObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">DeathObserver</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const_cast</span><span class="token operator">&lt;</span>ComposerService<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    IInterface<span class="token operator">::</span><span class="token function">asBinder</span><span class="token punctuation">(</span>mComposerService<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">linkToDeath</span><span class="token punctuation">(</span>mDeathObserver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个过程中，会从ServiceManager查找SF在Binder驱动中映射的服务。并且绑定上另一个死亡代理，用于销毁ComposerService中的资源。</p>
<p>到此时SF的binder接口已经对着BootAnimation暴露了。</p>
<p>了解ISurfaceComposer 本质上就是SF的远程端口，接下来再看看ISurfaceComposerClient是什么。</p>
<h4 id="ISurfaceComposer-createConnection"><a href="#ISurfaceComposer-createConnection" class="headerlink" title="ISurfaceComposer createConnection"></a>ISurfaceComposer createConnection</h4><p>实际调用的是SF的createConnection<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp" target="_blank" rel="noopener">SurfaceFlinger.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">sp<span class="token operator">&lt;</span>ISurfaceComposerClient<span class="token operator">></span> SurfaceFlinger<span class="token operator">::</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">initClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Client</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/Client.cpp" target="_blank" rel="noopener">Client.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token operator">:</span> <span class="token keyword">public</span> BnSurfaceComposerClient<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">Client<span class="token operator">::</span><span class="token function">Client</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>SurfaceFlinger<span class="token operator">></span><span class="token operator">&amp;</span> flinger<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">Client</span><span class="token punctuation">(</span>flinger<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>本质上就是一个实现了BnSurfaceComposerClient的Client对象。之后关于渲染的对象将会从中生成。</p>
<h3 id="BootAnimation-onFirstRef"><a href="#BootAnimation-onFirstRef" class="headerlink" title="BootAnimation onFirstRef"></a>BootAnimation onFirstRef</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> BootAnimation<span class="token operator">::</span><span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    status_t err <span class="token operator">=</span> mSession<span class="token operator">-</span><span class="token operator">></span><span class="token function">linkToComposerDeath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ALOGE_IF</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"linkToComposerDeath failed (%s) "</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">run</span><span class="token punctuation">(</span><span class="token string">"BootAnimation"</span><span class="token punctuation">,</span> PRIORITY_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当通过SurfaceComposerClient链接到远程Binder服务后，就会执行run方法。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/SurfaceComposerClient.cpp" target="_blank" rel="noopener">SurfaceComposerClient.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t SurfaceComposerClient<span class="token operator">::</span><span class="token function">linkToComposerDeath</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">::</span>DeathRecipient<span class="token operator">></span><span class="token operator">&amp;</span> recipient<span class="token punctuation">,</span>
        <span class="token keyword">void</span><span class="token operator">*</span> cookie<span class="token punctuation">,</span> uint32_t flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>ISurfaceComposer<span class="token operator">></span> <span class="token function">sf</span><span class="token punctuation">(</span>ComposerService<span class="token operator">::</span><span class="token function">getComposerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> IInterface<span class="token operator">::</span><span class="token function">asBinder</span><span class="token punctuation">(</span>sf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">linkToDeath</span><span class="token punctuation">(</span>recipient<span class="token punctuation">,</span> cookie<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到本质上是生成一个ComposerService BpBinder对象，并且进行Binder的死亡代理绑定。</p>
<h3 id="BootAnimation-run"><a href="#BootAnimation-run" class="headerlink" title="BootAnimation run"></a>BootAnimation run</h3><p>本质上BootAnimation还是一个线程：</p>
<pre><code>class BootAnimation : public Thread, public IBinder::DeathRecipient</code></pre><p>因此执行run之后，会先执行readyToRun，接着执行treadLoop方法。注意这两个方法都已经在线程中了。</p>
<h4 id="BootAnimation-readyToRun-准备渲染流程"><a href="#BootAnimation-readyToRun-准备渲染流程" class="headerlink" title="BootAnimation readyToRun 准备渲染流程"></a>BootAnimation readyToRun 准备渲染流程</h4><pre class="line-numbers language-cpp"><code class="language-cpp">status_t BootAnimation<span class="token operator">::</span><span class="token function">readyToRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mAssets<span class="token punctuation">.</span><span class="token function">addDefaultAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> <span class="token function">dtoken</span><span class="token punctuation">(</span>SurfaceComposerClient<span class="token operator">::</span><span class="token function">getBuiltInDisplay</span><span class="token punctuation">(</span>
            ISurfaceComposer<span class="token operator">::</span>eDisplayIdMain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    DisplayInfo dinfo<span class="token punctuation">;</span>
    status_t status <span class="token operator">=</span> SurfaceComposerClient<span class="token operator">::</span><span class="token function">getDisplayInfo</span><span class="token punctuation">(</span>dtoken<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// create the native surface</span>
    sp<span class="token operator">&lt;</span>SurfaceControl<span class="token operator">></span> control <span class="token operator">=</span> <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">createSurface</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span><span class="token string">"BootAnimation"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dinfo<span class="token punctuation">.</span>w<span class="token punctuation">,</span> dinfo<span class="token punctuation">.</span>h<span class="token punctuation">,</span> PIXEL_FORMAT_RGB_565<span class="token punctuation">)</span><span class="token punctuation">;</span>

    SurfaceComposerClient<span class="token operator">::</span>Transaction t<span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">setLayer</span><span class="token punctuation">(</span>control<span class="token punctuation">,</span> <span class="token number">0x40000000</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    sp<span class="token operator">&lt;</span>Surface<span class="token operator">></span> s <span class="token operator">=</span> control<span class="token operator">-</span><span class="token operator">></span><span class="token function">getSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// initialize opengl and egl</span>
    <span class="token keyword">const</span> EGLint attribs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            EGL_RED_SIZE<span class="token punctuation">,</span>   <span class="token number">8</span><span class="token punctuation">,</span>
            EGL_GREEN_SIZE<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span>
            EGL_BLUE_SIZE<span class="token punctuation">,</span>  <span class="token number">8</span><span class="token punctuation">,</span>
            EGL_DEPTH_SIZE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
            EGL_NONE
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    EGLint w<span class="token punctuation">,</span> h<span class="token punctuation">;</span>
    EGLint numConfigs<span class="token punctuation">;</span>
    EGLConfig config<span class="token punctuation">;</span>
    EGLSurface surface<span class="token punctuation">;</span>
    EGLContext context<span class="token punctuation">;</span>

    EGLDisplay display <span class="token operator">=</span> <span class="token function">eglGetDisplay</span><span class="token punctuation">(</span>EGL_DEFAULT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">eglInitialize</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eglChooseConfig</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> attribs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>numConfigs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    surface <span class="token operator">=</span> <span class="token function">eglCreateWindowSurface</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> config<span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context <span class="token operator">=</span> <span class="token function">eglCreateContext</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eglQuerySurface</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> surface<span class="token punctuation">,</span> EGL_WIDTH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eglQuerySurface</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> surface<span class="token punctuation">,</span> EGL_HEIGHT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">eglMakeCurrent</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> surface<span class="token punctuation">,</span> surface<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">==</span> EGL_FALSE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> NO_INIT<span class="token punctuation">;</span>

    mDisplay <span class="token operator">=</span> display<span class="token punctuation">;</span>
    mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
    mSurface <span class="token operator">=</span> surface<span class="token punctuation">;</span>
    mWidth <span class="token operator">=</span> w<span class="token punctuation">;</span>
    mHeight <span class="token operator">=</span> h<span class="token punctuation">;</span>
    mFlingerSurfaceControl <span class="token operator">=</span> control<span class="token punctuation">;</span>
    mFlingerSurface <span class="token operator">=</span> s<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// If the device has encryption turned on or is in process</span>
    <span class="token comment" spellcheck="true">// of being encrypted we show the encrypted boot animation.</span>
    <span class="token keyword">char</span> decrypt<span class="token punctuation">[</span>PROPERTY_VALUE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"vold.decrypt"</span><span class="token punctuation">,</span> decrypt<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> encryptedAnimation <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>decrypt<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"trigger_restart_min_framework"</span><span class="token punctuation">,</span> decrypt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mShuttingDown <span class="token operator">&amp;&amp;</span> encryptedAnimation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> encryptedBootFiles<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
            <span class="token punctuation">{</span>PRODUCT_ENCRYPTED_BOOTANIMATION_FILE<span class="token punctuation">,</span> SYSTEM_ENCRYPTED_BOOTANIMATION_FILE<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> f <span class="token operator">:</span> encryptedBootFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mZipFileName <span class="token operator">=</span> f<span class="token punctuation">;</span>
                <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> bootFiles<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
        <span class="token punctuation">{</span>PRODUCT_BOOTANIMATION_FILE<span class="token punctuation">,</span> OEM_BOOTANIMATION_FILE<span class="token punctuation">,</span> SYSTEM_BOOTANIMATION_FILE<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> shutdownFiles<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
        <span class="token punctuation">{</span>PRODUCT_SHUTDOWNANIMATION_FILE<span class="token punctuation">,</span> OEM_SHUTDOWNANIMATION_FILE<span class="token punctuation">,</span> SYSTEM_SHUTDOWNANIMATION_FILE<span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> f <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">!</span>mShuttingDown <span class="token operator">?</span> bootFiles <span class="token operator">:</span> shutdownFiles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mZipFileName <span class="token operator">=</span> f<span class="token punctuation">;</span>
            <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在准备渲染流程中，做的事情有如下几个步骤：</p>
<ul>
<li>1.SurfaceComposerClient::getBuiltInDisplay 从SF中查询可用的物理屏幕</li>
<li>2.SurfaceComposerClient::getDisplayInfo 从SF中获取屏幕的详细信息</li>
<li>3.session()-&gt;createSurface 通过Client创建绘制平面控制中心</li>
<li>4.t.setLayer(control, 0x40000000) 设置当前layer的层级</li>
<li>5.control-&gt;getSurface 获取真正的绘制平面对象</li>
<li>6.eglGetDisplay 获取opengl es的默认主屏幕，加载OpenGL es</li>
<li>7.eglInitialize 初始化屏幕对象和着色器缓存</li>
<li>8.eglChooseConfig 自动筛选出最合适的配置</li>
<li>9.eglCreateWindowSurface 从Surface中创建一个opengl es的surface</li>
<li>10.eglCreateContext 创建当前opengl es 的上下文</li>
<li>11.eglQuerySurface 查找当前环境的宽高属性</li>
<li>12.eglMakeCurrent 把上下文Context，屏幕display还有渲染面surface,线程关联起来。</li>
<li>13.从如下几个目录查找zip文件，分为两种模式，一种是加密文件的动画，一种是普通压缩文件动画：<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> OEM_BOOTANIMATION_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/oem/media/bootanimation.zip"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> PRODUCT_BOOTANIMATION_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/product/media/bootanimation.zip"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> SYSTEM_BOOTANIMATION_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/system/media/bootanimation.zip"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> PRODUCT_ENCRYPTED_BOOTANIMATION_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/product/media/bootanimation-encrypted.zip"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> SYSTEM_ENCRYPTED_BOOTANIMATION_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/system/media/bootanimation-encrypted.zip"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> OEM_SHUTDOWNANIMATION_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/oem/media/shutdownanimation.zip"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> PRODUCT_SHUTDOWNANIMATION_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/product/media/shutdownanimation.zip"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> SYSTEM_SHUTDOWNANIMATION_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/system/media/shutdownanimation.zip"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
在这些zip包中其实就是一张张图片。播放的时候，解压这些zip包，一张张的图片想动画一样播出。</li>
</ul>
<p>从第6点开始就是opengl es开发初四话流程的套路。其实真的核心的准备核心还是前5点。opengles的环境真正和Android系统关联起来是是第9点创建opengles的surface时候和Android的本地窗口互相绑定。</p>
<h4 id="BootAnimation-threadLoop"><a href="#BootAnimation-threadLoop" class="headerlink" title="BootAnimation threadLoop"></a>BootAnimation threadLoop</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> BootAnimation<span class="token operator">::</span><span class="token function">threadLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> r<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// We have no bootanimation file, so we use the stock android logo</span>
    <span class="token comment" spellcheck="true">// animation.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mZipFileName<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r <span class="token operator">=</span> <span class="token function">android</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        r <span class="token operator">=</span> <span class="token function">movie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">eglMakeCurrent</span><span class="token punctuation">(</span>mDisplay<span class="token punctuation">,</span> EGL_NO_SURFACE<span class="token punctuation">,</span> EGL_NO_SURFACE<span class="token punctuation">,</span> EGL_NO_CONTEXT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eglDestroyContext</span><span class="token punctuation">(</span>mDisplay<span class="token punctuation">,</span> mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eglDestroySurface</span><span class="token punctuation">(</span>mDisplay<span class="token punctuation">,</span> mSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mFlingerSurface<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mFlingerSurfaceControl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eglTerminate</span><span class="token punctuation">(</span>mDisplay<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eglReleaseThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    IPCThreadState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里如果设定了bootanimation的zip压缩包则会走movie解压播放zip中的动画，否则就会走android默认动画。</p>
<h4 id="BootAnimation-moive"><a href="#BootAnimation-moive" class="headerlink" title="BootAnimation moive"></a>BootAnimation moive</h4><p>既然老罗解析了Android默认的动画，我就去解析Android自定义动画的核心原理。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> BootAnimation<span class="token operator">::</span><span class="token function">movie</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Animation<span class="token operator">*</span> animation <span class="token operator">=</span> <span class="token function">loadAnimation</span><span class="token punctuation">(</span>mZipFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>animation <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mUseNpotTextures <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    String8 gl_extensions<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> exts <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token function">glGetString</span><span class="token punctuation">(</span>GL_EXTENSIONS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">glGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        gl_extensions<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>exts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gl_extensions<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">"GL_ARB_texture_non_power_of_two"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>gl_extensions<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">"GL_OES_texture_npot"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mUseNpotTextures <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Blend required to draw time on top of animation frames.</span>
<span class="token comment" spellcheck="true">//设置混合颜色模式 后面是1 - 原图的四个颜色分量</span>
    <span class="token function">glBlendFunc</span><span class="token punctuation">(</span>GL_SRC_ALPHA<span class="token punctuation">,</span> GL_ONE_MINUS_SRC_ALPHA<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//设置颜色过度模式，非平滑模式</span>
    <span class="token function">glShadeModel</span><span class="token punctuation">(</span>GL_FLAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glDisable</span><span class="token punctuation">(</span>GL_DITHER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glDisable</span><span class="token punctuation">(</span>GL_SCISSOR_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glDisable</span><span class="token punctuation">(</span>GL_BLEND<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//绑定纹理</span>
    <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//启动纹理</span>
    <span class="token function">glEnable</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//控制纹理如何与片元颜色进行计算的 设置纹理环境，纹理代替片元</span>
    <span class="token function">glTexEnvx</span><span class="token punctuation">(</span>GL_TEXTURE_ENV<span class="token punctuation">,</span> GL_TEXTURE_ENV_MODE<span class="token punctuation">,</span> GL_REPLACE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//设置横纵两轴的边界外以重复模式绘制纹理</span>
    <span class="token function">glTexParameterx</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_WRAP_S<span class="token punctuation">,</span> GL_REPEAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameterx</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_WRAP_T<span class="token punctuation">,</span> GL_REPEAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//为线性过滤</span>
    <span class="token function">glTexParameterx</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameterx</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> clockFontInitialized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mClockEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        clockFontInitialized <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token function">initFont</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>animation<span class="token operator">-</span><span class="token operator">></span>clockFont<span class="token punctuation">,</span> CLOCK_FONT_ASSET<span class="token punctuation">)</span> <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mClockEnabled <span class="token operator">=</span> clockFontInitialized<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mClockEnabled <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">updateIsTimeAccurate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mTimeCheckThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">TimeCheckThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mTimeCheckThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">"BootAnimation::TimeCheckThread"</span><span class="token punctuation">,</span> PRIORITY_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">playAnimation</span><span class="token punctuation">(</span><span class="token operator">*</span>animation<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mTimeCheckThread <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mTimeCheckThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">requestExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mTimeCheckThread <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">releaseAnimation</span><span class="token punctuation">(</span>animation<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>clockFontInitialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">glDeleteTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>animation<span class="token operator">-</span><span class="token operator">></span>clockFont<span class="token punctuation">.</span>texture<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>大致分为三步骤：</p>
<ul>
<li>1.loadAnimation 解析zip包的动画数据</li>
<li>2.初始化纹理设置</li>
<li>3.playAnimation 播放解析好的纹理数据</li>
<li>4.releaseAnimation 播放完毕释放资源</li>
</ul>
<h4 id="loadAnimation"><a href="#loadAnimation" class="headerlink" title="loadAnimation"></a>loadAnimation</h4><pre class="line-numbers language-cpp"><code class="language-cpp">BootAnimation<span class="token operator">::</span>Animation<span class="token operator">*</span> BootAnimation<span class="token operator">::</span><span class="token function">loadAnimation</span><span class="token punctuation">(</span><span class="token keyword">const</span> String8<span class="token operator">&amp;</span> fn<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mLoadedFiles<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"File \"%s\" is already loaded. Cyclic ref is not allowed"</span><span class="token punctuation">,</span>
            fn<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ZipFileRO <span class="token operator">*</span>zip <span class="token operator">=</span> ZipFileRO<span class="token operator">::</span><span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>zip <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Failed to open animation zip \"%s\": %s"</span><span class="token punctuation">,</span>
            fn<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Animation <span class="token operator">*</span>animation <span class="token operator">=</span>  <span class="token keyword">new</span> Animation<span class="token punctuation">;</span>
    animation<span class="token operator">-</span><span class="token operator">></span>fileName <span class="token operator">=</span> fn<span class="token punctuation">;</span>
    animation<span class="token operator">-</span><span class="token operator">></span>zip <span class="token operator">=</span> zip<span class="token punctuation">;</span>
    animation<span class="token operator">-</span><span class="token operator">></span>clockFont<span class="token punctuation">.</span>map <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    mLoadedFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>animation<span class="token operator">-</span><span class="token operator">></span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">parseAnimationDesc</span><span class="token punctuation">(</span><span class="token operator">*</span>animation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preloadZip</span><span class="token punctuation">(</span><span class="token operator">*</span>animation<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mLoadedFiles<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> animation<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关键方法有两个，第一个是parseAnimationDesc，第二个是preloadZip。</p>
<h4 id="parseAnimationDesc-解析zip包中的描述文件"><a href="#parseAnimationDesc-解析zip包中的描述文件" class="headerlink" title="parseAnimationDesc 解析zip包中的描述文件"></a>parseAnimationDesc 解析zip包中的描述文件</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> BootAnimation<span class="token operator">::</span><span class="token function">parseAnimationDesc</span><span class="token punctuation">(</span>Animation<span class="token operator">&amp;</span> animation<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    String8 desString<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">readFile</span><span class="token punctuation">(</span>animation<span class="token punctuation">.</span>zip<span class="token punctuation">,</span> <span class="token string">"desc.txt"</span><span class="token punctuation">,</span> desString<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> s <span class="token operator">=</span> desString<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Parse the description file</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> endl <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endl <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        String8 <span class="token function">line</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> endl <span class="token operator">-</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> l <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fps <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> width <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> height <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pause <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> path<span class="token punctuation">[</span>ANIM_ENTRY_NAME_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> color<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"000000"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// default to black if unspecified</span>
        <span class="token keyword">char</span> clockPos1<span class="token punctuation">[</span>TEXT_POS_LEN_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> clockPos2<span class="token punctuation">[</span>TEXT_POS_LEN_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span> pathType<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token string">"%d %d %d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>width<span class="token punctuation">,</span> <span class="token operator">&amp;</span>height<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fps<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ALOGD("> w=%d, h=%d, fps=%d", width, height, fps);</span>
            animation<span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
            animation<span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
            animation<span class="token punctuation">.</span>fps <span class="token operator">=</span> fps<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token string">" %c %d %d %s #%6s %16s %16s"</span><span class="token punctuation">,</span>
                          <span class="token operator">&amp;</span>pathType<span class="token punctuation">,</span> <span class="token operator">&amp;</span>count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pause<span class="token punctuation">,</span> path<span class="token punctuation">,</span> color<span class="token punctuation">,</span> clockPos1<span class="token punctuation">,</span> clockPos2<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//ALOGD("> type=%c, count=%d, pause=%d, path=%s, color=%s, clockPos1=%s, clockPos2=%s",</span>
            <span class="token comment" spellcheck="true">//    pathType, count, pause, path, color, clockPos1, clockPos2);</span>
            Animation<span class="token operator">::</span>Part part<span class="token punctuation">;</span>
            part<span class="token punctuation">.</span>playUntilComplete <span class="token operator">=</span> pathType <span class="token operator">==</span> <span class="token string">'c'</span><span class="token punctuation">;</span>
            part<span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
            part<span class="token punctuation">.</span>pause <span class="token operator">=</span> pause<span class="token punctuation">;</span>
            part<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
            part<span class="token punctuation">.</span>audioData <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            part<span class="token punctuation">.</span>animation <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parseColor</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> part<span class="token punctuation">.</span>backgroundColor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"> invalid color '#%s'"</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
                part<span class="token punctuation">.</span>backgroundColor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
                part<span class="token punctuation">.</span>backgroundColor<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
                part<span class="token punctuation">.</span>backgroundColor<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">parsePosition</span><span class="token punctuation">(</span>clockPos1<span class="token punctuation">,</span> clockPos2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>part<span class="token punctuation">.</span>clockPosX<span class="token punctuation">,</span> <span class="token operator">&amp;</span>part<span class="token punctuation">.</span>clockPosY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            animation<span class="token punctuation">.</span>parts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token string">"$SYSTEM"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ALOGD("> SYSTEM");</span>
            Animation<span class="token operator">::</span>Part part<span class="token punctuation">;</span>
            part<span class="token punctuation">.</span>playUntilComplete <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            part<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            part<span class="token punctuation">.</span>pause <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            part<span class="token punctuation">.</span>audioData <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            part<span class="token punctuation">.</span>animation <span class="token operator">=</span> <span class="token function">loadAnimation</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span>SYSTEM_BOOTANIMATION_FILE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span>animation <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
                animation<span class="token punctuation">.</span>parts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        s <span class="token operator">=</span> <span class="token operator">++</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>想要正常解析开机动画，需要有一个desc.txt。有一个例子如下：</p>
<pre><code>241 63 60
c 1 30 part0
c 1 0 part1
c 0 0 part2
c 1 64 part3
c 1 15 part4</code></pre><p>该文件头三个字符串定义了宽高，和帧数。找到\n结束后就到下一行中去。<br>接下来的部分就是动画每一部分，第一个字符串c是指是否一直播放到结束；第而个则是指pause，是暂停的帧数；第三个int是指当前帧数中有加载目录下多少画面，最后一个代表资源路径。</p>
<p>把每一部分当成一个part保存在Animation中。</p>
<p>当然在Android 9.0版本中还能设置更多的选项如音频等。</p>
<h4 id="preloadZip预加载zip"><a href="#preloadZip预加载zip" class="headerlink" title="preloadZip预加载zip"></a>preloadZip预加载zip</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> BootAnimation<span class="token operator">::</span><span class="token function">preloadZip</span><span class="token punctuation">(</span>Animation<span class="token operator">&amp;</span> animation<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// read all the data structures</span>
    <span class="token keyword">const</span> size_t pcount <span class="token operator">=</span> animation<span class="token punctuation">.</span>parts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>cookie <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    ZipFileRO<span class="token operator">*</span> zip <span class="token operator">=</span> animation<span class="token punctuation">.</span>zip<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>zip<span class="token operator">-</span><span class="token operator">></span><span class="token function">startIteration</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cookie<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ZipEntryRO entry<span class="token punctuation">;</span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span>ANIM_ENTRY_NAME_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>entry <span class="token operator">=</span> zip<span class="token operator">-</span><span class="token operator">></span><span class="token function">nextEntry</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> foundEntryName <span class="token operator">=</span> zip<span class="token operator">-</span><span class="token operator">></span><span class="token function">getEntryFileName</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> ANIM_ENTRY_NAME_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>foundEntryName <span class="token operator">></span> ANIM_ENTRY_NAME_MAX <span class="token operator">||</span> foundEntryName <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> String8 <span class="token function">entryName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> String8 <span class="token function">path</span><span class="token punctuation">(</span>entryName<span class="token punctuation">.</span><span class="token function">getPathDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> String8 <span class="token function">leaf</span><span class="token punctuation">(</span>entryName<span class="token punctuation">.</span><span class="token function">getPathLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>leaf<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entryName <span class="token operator">==</span> CLOCK_FONT_ZIP_NAME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                FileMap<span class="token operator">*</span> map <span class="token operator">=</span> zip<span class="token operator">-</span><span class="token operator">></span><span class="token function">createEntryFileMap</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    animation<span class="token punctuation">.</span>clockFont<span class="token punctuation">.</span>map <span class="token operator">=</span> map<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> pcount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">==</span> animation<span class="token punctuation">.</span>parts<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    uint16_t method<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// supports only stored png files</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>zip<span class="token operator">-</span><span class="token operator">></span><span class="token function">getEntryInfo</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>method<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">==</span> ZipFileRO<span class="token operator">::</span>kCompressStored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            FileMap<span class="token operator">*</span> map <span class="token operator">=</span> zip<span class="token operator">-</span><span class="token operator">></span><span class="token function">createEntryFileMap</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                Animation<span class="token operator">::</span>Part<span class="token operator">&amp;</span> <span class="token function">part</span><span class="token punctuation">(</span>animation<span class="token punctuation">.</span>parts<span class="token punctuation">.</span><span class="token function">editItemAt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>leaf <span class="token operator">==</span> <span class="token string">"audio.wav"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// a part may have at most one audio file</span>
                                    part<span class="token punctuation">.</span>audioData <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span>map<span class="token operator">-</span><span class="token operator">></span><span class="token function">getDataPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    part<span class="token punctuation">.</span>audioLength <span class="token operator">=</span> map<span class="token operator">-</span><span class="token operator">></span><span class="token function">getDataLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>leaf <span class="token operator">==</span> <span class="token string">"trim.txt"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    part<span class="token punctuation">.</span>trimData<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token punctuation">)</span>map<span class="token operator">-</span><span class="token operator">></span><span class="token function">getDataPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                        map<span class="token operator">-</span><span class="token operator">></span><span class="token function">getDataLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    Animation<span class="token operator">::</span>Frame frame<span class="token punctuation">;</span>
                                    frame<span class="token punctuation">.</span>name <span class="token operator">=</span> leaf<span class="token punctuation">;</span>
                                    frame<span class="token punctuation">.</span>map <span class="token operator">=</span> map<span class="token punctuation">;</span>
                                    frame<span class="token punctuation">.</span>trimWidth <span class="token operator">=</span> animation<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
                                    frame<span class="token punctuation">.</span>trimHeight <span class="token operator">=</span> animation<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
                                    frame<span class="token punctuation">.</span>trimX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                                    frame<span class="token punctuation">.</span>trimY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                                    part<span class="token punctuation">.</span>frames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>Animation<span class="token operator">::</span>Part<span class="token operator">&amp;</span> part <span class="token operator">:</span> animation<span class="token punctuation">.</span>parts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> trimDataStr <span class="token operator">=</span> part<span class="token punctuation">.</span>trimData<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t frameIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> frameIdx <span class="token operator">&lt;</span> part<span class="token punctuation">.</span>frames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> frameIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> endl <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>trimDataStr<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// No more trimData for this part.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>endl <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            String8 <span class="token function">line</span><span class="token punctuation">(</span>trimDataStr<span class="token punctuation">,</span> endl <span class="token operator">-</span> trimDataStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> lineStr <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            trimDataStr <span class="token operator">=</span> <span class="token operator">++</span>endl<span class="token punctuation">;</span>
            <span class="token keyword">int</span> width <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>lineStr<span class="token punctuation">,</span> <span class="token string">"%dx%d+%d+%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>width<span class="token punctuation">,</span> <span class="token operator">&amp;</span>height<span class="token punctuation">,</span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>y<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Animation<span class="token operator">::</span>Frame<span class="token operator">&amp;</span> <span class="token function">frame</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>frames<span class="token punctuation">.</span><span class="token function">editItemAt</span><span class="token punctuation">(</span>frameIdx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                frame<span class="token punctuation">.</span>trimWidth <span class="token operator">=</span> width<span class="token punctuation">;</span>
                frame<span class="token punctuation">.</span>trimHeight <span class="token operator">=</span> height<span class="token punctuation">;</span>
                frame<span class="token punctuation">.</span>trimX <span class="token operator">=</span> x<span class="token punctuation">;</span>
                frame<span class="token punctuation">.</span>trimY <span class="token operator">=</span> y<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    mCallbacks<span class="token operator">-</span><span class="token operator">></span><span class="token function">init</span><span class="token punctuation">(</span>animation<span class="token punctuation">.</span>parts<span class="token punctuation">)</span><span class="token punctuation">;</span>

    zip<span class="token operator">-</span><span class="token operator">></span><span class="token function">endIteration</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面做了两件事情：</p>
<ul>
<li>1.首先，解压zip包中所有的资源，注入到每一个Animation parts中。让其拥有真正的资源地址。</li>
<li>2.根据每一个parts中的资源数据和头信息，生成一个个Frame保存在Animation中。</li>
</ul>
<h3 id="playAnimation-播放动画"><a href="#playAnimation-播放动画" class="headerlink" title="playAnimation 播放动画"></a>playAnimation 播放动画</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> BootAnimation<span class="token operator">::</span><span class="token function">playAnimation</span><span class="token punctuation">(</span><span class="token keyword">const</span> Animation<span class="token operator">&amp;</span> animation<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> size_t pcount <span class="token operator">=</span> animation<span class="token punctuation">.</span>parts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nsecs_t frameDuration <span class="token operator">=</span> <span class="token function">s2ns</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> animation<span class="token punctuation">.</span>fps<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> animationX <span class="token operator">=</span> <span class="token punctuation">(</span>mWidth <span class="token operator">-</span> animation<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> animationY <span class="token operator">=</span> <span class="token punctuation">(</span>mHeight <span class="token operator">-</span> animation<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"%sAnimationShownTiming start time: %"</span> PRId64 <span class="token string">"ms"</span><span class="token punctuation">,</span> mShuttingDown <span class="token operator">?</span> <span class="token string">"Shutdown"</span> <span class="token operator">:</span> <span class="token string">"Boot"</span><span class="token punctuation">,</span>
            <span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span>pcount <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> Animation<span class="token operator">::</span>Part<span class="token operator">&amp;</span> <span class="token function">part</span><span class="token punctuation">(</span>animation<span class="token punctuation">.</span>parts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> size_t fcount <span class="token operator">=</span> part<span class="token punctuation">.</span>frames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Handle animation package</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span>animation <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">playAnimation</span><span class="token punctuation">(</span><span class="token operator">*</span>part<span class="token punctuation">.</span>animation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exitPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//to next part</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> r<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span> <span class="token operator">!</span>part<span class="token punctuation">.</span>count <span class="token operator">||</span> r<span class="token operator">&lt;</span>part<span class="token punctuation">.</span>count <span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Exit any non playuntil complete parts immediately</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">exitPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>part<span class="token punctuation">.</span>playUntilComplete<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            mCallbacks<span class="token operator">-</span><span class="token operator">></span><span class="token function">playPart</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> part<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">glClearColor</span><span class="token punctuation">(</span>
                    part<span class="token punctuation">.</span>backgroundColor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    part<span class="token punctuation">.</span>backgroundColor<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    part<span class="token punctuation">.</span>backgroundColor<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span> j<span class="token operator">&lt;</span>fcount <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">exitPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> part<span class="token punctuation">.</span>playUntilComplete<span class="token punctuation">)</span> <span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> Animation<span class="token operator">::</span>Frame<span class="token operator">&amp;</span> <span class="token function">frame</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>frames<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                nsecs_t lastFrame <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span>count <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">glGenTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">.</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">glTexParameterx</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">glTexParameterx</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">int</span> w<span class="token punctuation">,</span> h<span class="token punctuation">;</span>
                    <span class="token function">initTexture</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>map<span class="token punctuation">,</span> <span class="token operator">&amp;</span>w<span class="token punctuation">,</span> <span class="token operator">&amp;</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">const</span> <span class="token keyword">int</span> xc <span class="token operator">=</span> animationX <span class="token operator">+</span> frame<span class="token punctuation">.</span>trimX<span class="token punctuation">;</span>
                <span class="token keyword">const</span> <span class="token keyword">int</span> yc <span class="token operator">=</span> animationY <span class="token operator">+</span> frame<span class="token punctuation">.</span>trimY<span class="token punctuation">;</span>
                Region <span class="token function">clearReg</span><span class="token punctuation">(</span><span class="token function">Rect</span><span class="token punctuation">(</span>mWidth<span class="token punctuation">,</span> mHeight<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                clearReg<span class="token punctuation">.</span><span class="token function">subtractSelf</span><span class="token punctuation">(</span><span class="token function">Rect</span><span class="token punctuation">(</span>xc<span class="token punctuation">,</span> yc<span class="token punctuation">,</span> xc<span class="token operator">+</span>frame<span class="token punctuation">.</span>trimWidth<span class="token punctuation">,</span> yc<span class="token operator">+</span>frame<span class="token punctuation">.</span>trimHeight<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clearReg<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Region<span class="token operator">::</span>const_iterator <span class="token function">head</span><span class="token punctuation">(</span>clearReg<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Region<span class="token operator">::</span>const_iterator <span class="token function">tail</span><span class="token punctuation">(</span>clearReg<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">glEnable</span><span class="token punctuation">(</span>GL_SCISSOR_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>head <span class="token operator">!=</span> tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">const</span> Rect<span class="token operator">&amp;</span> <span class="token function">r2</span><span class="token punctuation">(</span><span class="token operator">*</span>head<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">glScissor</span><span class="token punctuation">(</span>r2<span class="token punctuation">.</span>left<span class="token punctuation">,</span> mHeight <span class="token operator">-</span> r2<span class="token punctuation">.</span>bottom<span class="token punctuation">,</span> r2<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r2<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">glDisable</span><span class="token punctuation">(</span>GL_SCISSOR_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">glDrawTexiOES</span><span class="token punctuation">(</span>xc<span class="token punctuation">,</span> mHeight <span class="token operator">-</span> <span class="token punctuation">(</span>yc <span class="token operator">+</span> frame<span class="token punctuation">.</span>trimHeight<span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token number">0</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span>trimWidth<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>trimHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mClockEnabled <span class="token operator">&amp;&amp;</span> mTimeIsAccurate <span class="token operator">&amp;&amp;</span> <span class="token function">validClock</span><span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">drawClock</span><span class="token punctuation">(</span>animation<span class="token punctuation">.</span>clockFont<span class="token punctuation">,</span> part<span class="token punctuation">.</span>clockPosX<span class="token punctuation">,</span> part<span class="token punctuation">.</span>clockPosY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token function">eglSwapBuffers</span><span class="token punctuation">(</span>mDisplay<span class="token punctuation">,</span> mSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>

                nsecs_t now <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                nsecs_t delay <span class="token operator">=</span> frameDuration <span class="token operator">-</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> lastFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//ALOGD("%lld, %lld", ns2ms(now - lastFrame), ns2ms(delay));</span>
                lastFrame <span class="token operator">=</span> now<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">struct</span> timespec spec<span class="token punctuation">;</span>
                    spec<span class="token punctuation">.</span>tv_sec  <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">+</span> delay<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000000000</span><span class="token punctuation">;</span>
                    spec<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">+</span> delay<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000000000</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
                    <span class="token keyword">do</span> <span class="token punctuation">{</span>
                        err <span class="token operator">=</span> <span class="token function">clock_nanosleep</span><span class="token punctuation">(</span>CLOCK_MONOTONIC<span class="token punctuation">,</span> TIMER_ABSTIME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>spec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>err<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token function">checkExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">usleep</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>pause <span class="token operator">*</span> <span class="token function">ns2us</span><span class="token punctuation">(</span>frameDuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// For infinite parts, we've now played them at least once, so perhaps exit</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">exitPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>part<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Free textures created for looping parts now that the animation is done.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Animation<span class="token operator">::</span>Part<span class="token operator">&amp;</span> part <span class="token operator">:</span> animation<span class="token punctuation">.</span>parts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span>count <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> size_t fcount <span class="token operator">=</span> part<span class="token punctuation">.</span>frames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> fcount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> Animation<span class="token operator">::</span>Frame<span class="token operator">&amp;</span> <span class="token function">frame</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>frames<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">glDeleteTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">.</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个过程中，如果没有设置c标志为则不会播放。否则将会循环每一个每一个part中对应frame的个数。当是frame的第一帧的时候将会初始化纹理，设置好纹理需要加载的数据以及宽高，并且绑定当前frame的id为渲染纹理的句柄。</p>
<p>找到动画的动画的启动位置，其位置就是整个屏幕的宽高-动画绘制区域宽高的1/2，保证整个动画刚好在大小适应的位置。</p>
<p>获取到区域之后，通过glScissor进行裁剪。glDrawTexiOES绘制纹理位置，最后进行opengles 缓冲区交换。计算当前已经消耗的时间和每一帧进行比对，再进行延时处理。</p>
<p>最后处理pause的数据，查看需要暂停沉睡多少帧。</p>
<p>最后的最后，销毁每一个绑定在frame.id上的纹理。以及调用checkExit检测是否需要退出该进程。</p>
<h4 id="releaseAnimation"><a href="#releaseAnimation" class="headerlink" title="releaseAnimation"></a>releaseAnimation</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> BootAnimation<span class="token operator">::</span><span class="token function">releaseAnimation</span><span class="token punctuation">(</span>Animation<span class="token operator">*</span> animation<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Vector<span class="token operator">&lt;</span>Animation<span class="token operator">::</span>Part<span class="token operator">></span><span class="token operator">::</span>iterator it <span class="token operator">=</span> animation<span class="token operator">-</span><span class="token operator">></span>parts<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         e <span class="token operator">=</span> animation<span class="token operator">-</span><span class="token operator">></span>parts<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> e<span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token operator">-</span><span class="token operator">></span>animation<span class="token punctuation">)</span>
            <span class="token function">releaseAnimation</span><span class="token punctuation">(</span>it<span class="token operator">-</span><span class="token operator">></span>animation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>animation<span class="token operator">-</span><span class="token operator">></span>zip<span class="token punctuation">)</span>
        <span class="token keyword">delete</span> animation<span class="token operator">-</span><span class="token operator">></span>zip<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> animation<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>销毁animation中part以及zip映射的内存。</p>
<p>那么什么时候才是整个进程真正销毁呢？那一般就是桌面进程准备显示了，那就应该销毁BootAnimation进程了。我们可以猜测就在桌面的Activity 进入了Resume之后进行销毁的。</p>
<h3 id="BootAnimation-进程的销毁"><a href="#BootAnimation-进程的销毁" class="headerlink" title="BootAnimation 进程的销毁"></a>BootAnimation 进程的销毁</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/" target="_blank" rel="noopener">app</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ActivityThread.java" target="_blank" rel="noopener">ActivityThread.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleResumeActivity</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finalStateRequest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isForward<span class="token punctuation">,</span>
            String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        Looper<span class="token punctuation">.</span><span class="token function">myQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIdleHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Idler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在执行完Resume之后，会添加一次IdleHandler对象。让进程空闲执行。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ActivityClientRecord a <span class="token operator">=</span> mNewActivities<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> stopProfiling <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mNewActivities <span class="token operator">=</span> null<span class="token punctuation">;</span>
                IActivityManager am <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ActivityClientRecord prev<span class="token punctuation">;</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>activity <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>a<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            am<span class="token punctuation">.</span><span class="token function">activityIdle</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>token<span class="token punctuation">,</span> a<span class="token punctuation">.</span>createdConfig<span class="token punctuation">,</span> stopProfiling<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            a<span class="token punctuation">.</span>createdConfig <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    prev <span class="token operator">=</span> a<span class="token punctuation">;</span>
                    a <span class="token operator">=</span> a<span class="token punctuation">.</span>nextIdle<span class="token punctuation">;</span>
                    prev<span class="token punctuation">.</span>nextIdle <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法将会通信到AMS中。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java" target="_blank" rel="noopener">ActivityManagerService.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">activityIdle</span><span class="token punctuation">(</span>IBinder token<span class="token punctuation">,</span> Configuration config<span class="token punctuation">,</span> <span class="token keyword">boolean</span> stopProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ActivityStack stack <span class="token operator">=</span> ActivityRecord<span class="token punctuation">.</span><span class="token function">getStackLocked</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ActivityRecord r <span class="token operator">=</span>
                        mStackSupervisor<span class="token punctuation">.</span><span class="token function">activityIdleInternalLocked</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* fromTimeout */</span><span class="token punctuation">,</span>
                                <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* processPausingActivities */</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stopProfiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mProfileProc <span class="token operator">==</span> r<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mProfilerInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">clearProfilerLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/" target="_blank" rel="noopener">am</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java" target="_blank" rel="noopener">ActivityStackSupervisor.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">final</span> ActivityRecord <span class="token function">activityIdleInternalLocked</span><span class="token punctuation">(</span><span class="token keyword">final</span> IBinder token<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fromTimeout<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> processPausingActivities<span class="token punctuation">,</span> Configuration config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_ALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Activity idle: "</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ArrayList<span class="token operator">&lt;</span>ActivityRecord<span class="token operator">></span> finishes <span class="token operator">=</span> null<span class="token punctuation">;</span>
        ArrayList<span class="token operator">&lt;</span>UserState<span class="token operator">></span> startingUsers <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">int</span> NS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> NF <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> booting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> activityRemoved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        ActivityRecord r <span class="token operator">=</span> ActivityRecord<span class="token punctuation">.</span><span class="token function">forTokenLocked</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>IDLE_TIMEOUT_MSG<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span><span class="token function">finishLaunchTickingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fromTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reportActivityLaunchedLocked</span><span class="token punctuation">(</span>fromTimeout<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span><span class="token function">setLastReportedGlobalConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// We are now idle.  If someone is waiting for a thumbnail from</span>
            <span class="token comment" spellcheck="true">// us, we can now deliver.</span>
            r<span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFocusedStack</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> fromTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                booting <span class="token operator">=</span> <span class="token function">checkFinishBootingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时将会执行checkFinishBootingLocked检测BootAnimation是否关闭。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkFinishBootingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> booting <span class="token operator">=</span> mService<span class="token punctuation">.</span>mBooting<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> enableScreen <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span>mBooting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mService<span class="token punctuation">.</span>mBooted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span>mBooted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            enableScreen <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>booting <span class="token operator">||</span> enableScreen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span><span class="token function">postFinishBooting</span><span class="token punctuation">(</span>booting<span class="token punctuation">,</span> enableScreen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> booting<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里很简单，就是一个全局的标志位判断,接下来就回到AMS中</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">postFinishBooting</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> finishBooting<span class="token punctuation">,</span> <span class="token keyword">boolean</span> enableScreen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>FINISH_BOOTING_MSG<span class="token punctuation">,</span>
                finishBooting <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> enableScreen <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>进入AMS的Handler中</p>
<pre class="line-numbers language-java"><code class="language-java">            <span class="token keyword">case</span> FINISH_BOOTING_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>arg1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">finishBooting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>arg2 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">enableScreenAfterBoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>会执行finishBooting继续设置一个标志位。这个标志用来判断不需要其他时候有其他进程来执行结束BootAnimation进程的操作。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">enableScreenAfterBoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        mWindowManager<span class="token punctuation">.</span><span class="token function">enableScreenAfterBoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时就会走到WMS中的enableScreenAfterBoot。因为WMS作为窗体管理服务，肯定有渲染相关的服务在里面。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/wm/" target="_blank" rel="noopener">wm</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java" target="_blank" rel="noopener">WindowManagerService.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enableScreenAfterBoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mWindowMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSystemBooted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mSystemBooted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">hideBootMessagesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mH<span class="token punctuation">.</span><span class="token function">sendEmptyMessageDelayed</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>BOOT_TIMEOUT<span class="token punctuation">,</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mPolicy<span class="token punctuation">.</span><span class="token function">systemBooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">performEnableScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performEnableScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mWindowMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                IBinder surfaceFlinger <span class="token operator">=</span> ServiceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token string">"SurfaceFlinger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>surfaceFlinger <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Parcel data <span class="token operator">=</span> Parcel<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token string">"android.ui.ISurfaceComposer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    surfaceFlinger<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span>IBinder<span class="token punctuation">.</span>FIRST_CALL_TRANSACTION<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// BOOT_FINISHED</span>
                            data<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    data<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mActivityManager<span class="token punctuation">.</span><span class="token function">bootAnimationComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关键是通信到SF中，传入了FIRST_CALL_TRANSACTION命令，而这个命令实际上就是BOOT_FINISHED。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">BOOT_FINISHED <span class="token operator">=</span> IBinder<span class="token operator">::</span>FIRST_CALL_TRANSACTION<span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们去SF的基类看看做了什么。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/ISurfaceComposer.cpp" target="_blank" rel="noopener">ISurfaceComposer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">        <span class="token keyword">case</span> BOOT_FINISHED<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token function">CHECK_INTERFACE</span><span class="token punctuation">(</span>ISurfaceComposer<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">bootFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实就是SF中的bootFinished方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">bootFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartPropertySetThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Join StartPropertySetThread failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> nsecs_t now <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nsecs_t duration <span class="token operator">=</span> now <span class="token operator">-</span> mBootTime<span class="token punctuation">;</span>
    <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Boot is finished (%ld ms)"</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">(</span><span class="token function">ns2ms</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// wait patiently for the window manager death</span>
    <span class="token keyword">const</span> String16 <span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"window"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> <span class="token function">window</span><span class="token punctuation">(</span><span class="token function">defaultServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getService</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token operator">-</span><span class="token operator">></span><span class="token function">linkToDeath</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span>IBinder<span class="token operator">::</span>DeathRecipient<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"service.bootanim.exit"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> LOGTAG_SF_STOP_BOOTANIM <span class="token operator">=</span> <span class="token number">60110</span><span class="token punctuation">;</span>
    <span class="token function">LOG_EVENT_LONG</span><span class="token punctuation">(</span>LOGTAG_SF_STOP_BOOTANIM<span class="token punctuation">,</span>
                   <span class="token function">ns2ms</span><span class="token punctuation">(</span><span class="token function">systemTime</span><span class="token punctuation">(</span>SYSTEM_TIME_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    sp<span class="token operator">&lt;</span>LambdaMessage<span class="token operator">></span> readProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">LambdaMessage</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">readPersistentProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">postMessageAsync</span><span class="token punctuation">(</span>readProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在此刻，SF绑定了对WMS的Binder死亡代理。不过关键还是设置了service.bootanim.exit这个全局属性。而这个属性刚好就是BootAnimation在checkExit方法中不断循环检测。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> BootAnimation<span class="token operator">::</span><span class="token function">checkExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Allow surface flinger to gracefully request shutdown</span>
    <span class="token keyword">char</span> value<span class="token punctuation">[</span>PROPERTY_VALUE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">property_get</span><span class="token punctuation">(</span>EXIT_PROP_NAME<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> exitnow <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exitnow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">requestExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCallbacks<span class="token operator">-</span><span class="token operator">></span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>requestExit其实就是退出该BootAnimation线程的threadLoop方法，这样整个main方法就不会阻塞住，就会一直运行整个main到底结束整个进程。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>用一幅图总结：</p>
<p><img src="/images/%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86.jpg" alt="开机动画启动原理.jpg"></p>
<p>这些其实都是普通的OpenGL es的操作。但是似乎把Android渲染系统部分给屏蔽掉了。我们似乎没有办法继续探索下去了？不得不说封装的太棒了，压根没有感受到OpenGL es适配了平台的特性。</p>
<p>回答开头的疑问，为什么我们不需要Activity也能渲染呢，由始至终都没有看到Activity的存在？其实Activity本身并不是负责渲染，它不过是集UI交互的大成者。真正负责渲染的，其实是由Surface联通SF进行交互渲染的。我们日常开发(不打开硬件加速)似乎有没有看到OpenGL es的身影。</p>
<p>其实我们可以做一个大胆的猜测，其实Android的渲染很可能分为2个部分，一个是借助OpenGL es进行渲染，另一个则是通过Skia画笔绘制好像素之后进行渲染。究竟是不是这样呢？不妨留一个悬念，下一篇文章，将会带领大家阅读Android在封装OpenGL es上做了什么努力。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/01/25/android-chong-xue-xi-lie-xuan-ran-tu-ceng-tu-yuan-huan-chong-dui-lie-chu-shi-hua/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Android 重学系列 渲染图层-图元缓冲队列初始化">
                        
                        <span class="card-title">Android 重学系列 渲染图层-图元缓冲队列初始化</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言经过上一篇文章，对开机启动动画的流程梳理，引出了实际上在开机启动动画中，并没有Activity，而是通过OpenGL es进行渲染，最后通过某种方式，把数据交给Android渲染系统。
本文，先来探索在调用OpenGL es进行渲染的前
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-01-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/01/21/android-chong-xue-xi-lie-surfaceflinger-de-hal-ceng-chu-shi-hua/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="Android 重学系列 SurfaceFlinger 的HAL层初始化">
                        
                        <span class="card-title">Android 重学系列 SurfaceFlinger 的HAL层初始化</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章我们研究了SF的初始化。但是还有一个很大也是核心的模块没有聊到，那就是HAL层对应的初始化。什么是HAL层，有简单的话来讲就是硬件驱动和软件之间的中间层，为了更好的兼容Android系统而诞生。
在Android 8.0之后会
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-01-21
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
