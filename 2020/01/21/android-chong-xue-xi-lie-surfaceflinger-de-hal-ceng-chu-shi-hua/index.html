<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 SurfaceFlinger 的HAL层初始化, Android | Linux | Flutter">
    <meta name="description" content="前言上一篇文章我们研究了SF的初始化。但是还有一个很大也是核心的模块没有聊到，那就是HAL层对应的初始化。什么是HAL层，有简单的话来讲就是硬件驱动和软件之间的中间层，为了更好的兼容Android系统而诞生。
在Android 8.0之后会">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 SurfaceFlinger 的HAL层初始化 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 SurfaceFlinger 的HAL层初始化
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                SurfaceFlinger
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-01-21
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        9.6k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        45 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇文章我们研究了SF的初始化。但是还有一个很大也是核心的模块没有聊到，那就是HAL层对应的初始化。什么是HAL层，有简单的话来讲就是硬件驱动和软件之间的中间层，为了更好的兼容Android系统而诞生。</p>
<p>在Android 8.0之后会涉及应用开发及其少接触的一个新类型文件.hal文件。本质上.hal和.aidl文件十分相似，设计初衷和aidl也很相似。aidl为的是Android跨进程通信，而.hal则是为了让android软件层和硬件层通信而做的隔离，因此这种交互方式又称为HIDL。</p>
<p>闲话不多说，我们先来看看hal文件的用法之后，再去看看SF中IComposer，IComposerClient中都做了什么事情。</p>
<p>如果遇到什么问题可以来本文讨论：<a href="https://www.jianshu.com/p/8e29c3d9b27a" target="_blank" rel="noopener">https://www.jianshu.com/p/8e29c3d9b27a</a></p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>在Android 8.0之后，Google为了各大手机厂商的方便，执行了一个名为Treble计划，其目的就是为了让各大手机厂商和硬件商能够在最小代价在Android系统升级的时候，能快速更新硬件相关的特性。</p>
<p><img src="/images/hal%E7%9A%84%E5%8D%87%E7%BA%A7%E5%8E%86%E7%A8%8B.png" alt="hal的升级历程.png"></p>
<p>大致可以把hal层的历史分为如下3个时期:</p>
<ul>
<li><p>1.Legacy Hal：Android 8.0 之前版本的 HAL 都是编译成 so，然后动态链接到各个 frameworks service 中去。</p>
</li>
<li><p>2.Passthrough Hal：该模式是为了兼容旧版的 HAL，旧版 HAL 实现仍以动态库的方式提供，只是 binder service 链接了动态库 HAL 实现，即 binder service 通过 hw_get_module 链接了旧版的 hal 实现，而用户端通过与 binder service IPC 通信，间接实现了与旧版 HAL 的交互。</p>
</li>
<li><p>3.Binderized HAL：HAL 与 用户调用在不同的进程中，HAL 被写成 binder service，而用户接口如 frameworks 作为 binder client 通过 IPC 机制实现跨进程接口调用。这个是 Google 的最终设计目标。</p>
</li>
</ul>
<p>能看到，从历史来看，整个hal层的隔离越来越厉害，越来越接近AIDL的方向设计。因此，Google选择和AIDL的方式，构建一个hal文件，让硬件商和系统只需要关注暴露在hal文件中接口的逻辑即可。</p>
<p>注意一下，这里面的binder 并非是我之前分析的那个Binder，而是hwBinder，不过代码和原理是一摸一样。不过前者负责进程间通信，hwBinder则负责硬件进程和上层进程的通信。</p>
<p>这样设计其实很简单，如果阅读过我的Binder源码解析就能明白，Binder中有一套复杂的事务传输逻辑，如果把硬件驱动也接进来，就没办法达到软件可以快速响应硬件回调或者软件调用硬件。</p>
<p>为了更好的理解HIDL语言，我们可以完全把它当作AIDL这种语言进行类比学习。</p>
<p>本文重点不是hidl的原理，只是作为基础知识和大家介绍。具体的细节，有机会再和大家聊聊。</p>
<h2 id="hal文件介绍"><a href="#hal文件介绍" class="headerlink" title="hal文件介绍"></a>hal文件介绍</h2><p>我们就以IComposer.hal为例子,先来看看2.1版本。<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/IComposer.hal" target="_blank" rel="noopener">IComposer.hal</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>composer<span class="token annotation punctuation">@2</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> IComposerClient<span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">IComposer</span> <span class="token punctuation">{</span>

    <span class="token keyword">enum</span> Capability <span class="token operator">:</span> int32_t <span class="token punctuation">{</span>
        INVALID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>

        SIDEBAND_STREAM <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>

        SKIP_CLIENT_COLOR_TRANSFORM <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>

        PRESENT_FENCE_IS_NOT_RELIABLE <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@entry</span>
    <span class="token annotation punctuation">@exit</span>
    <span class="token annotation punctuation">@callflow</span><span class="token punctuation">(</span>next<span class="token operator">=</span><span class="token string">"*"</span><span class="token punctuation">)</span>
    <span class="token function">getCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">generates</span> <span class="token punctuation">(</span>vec<span class="token operator">&lt;</span>Capability<span class="token operator">></span> capabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@entry</span>
    <span class="token annotation punctuation">@exit</span>
    <span class="token annotation punctuation">@callflow</span><span class="token punctuation">(</span>next<span class="token operator">=</span><span class="token string">"*"</span><span class="token punctuation">)</span>
    <span class="token function">dumpDebugInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">generates</span> <span class="token punctuation">(</span>string debugInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@entry</span>
    <span class="token annotation punctuation">@callflow</span><span class="token punctuation">(</span>next<span class="token operator">=</span><span class="token string">"*"</span><span class="token punctuation">)</span>
    <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">generates</span> <span class="token punctuation">(</span>Error error<span class="token punctuation">,</span> IComposerClient client<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在hal文件中，只能注意的是，我上一篇文章聊到的createClient方法，创建一个IComposerClient对象返回上层。</p>
<p>能看到实际上和aidl十分相似不是吗。当我们把它类比成aidl就特别好理解了。一般的，编写了一个hal文件之后，就需要使用hidl-gen工具，类似aidl一样生成一个真正的cpp文件，里面包含着真正的跨进程通信逻辑，以及相关的接口文件。</p>
<p>当我们写好hal文件之后，并且通过hidl-gen生成的文件中实现接口后，写好Android.bp文件。大致上能得到类似的目录：<br><img src="/images/%E7%9B%AE%E5%BD%951.png" alt="目录1.png"><br>当然这是composer 2.2版本，不过从大体设计看来差距不是很大。</p>
<p>一般的会在default子目录编写好入口方法：<br><img src="/images/%E7%9B%AE%E5%BD%952.png" alt="目录2.png"></p>
<p>能看到2.2版本下只剩下一个service.cpp。我们再看看2.1版本又是如何：<br><img src="/images/%E7%9B%AE%E5%BD%953.png" alt="目录3.png"></p>
<p>能看到2.1版本中，多了一个cpp文件passthrough。顾名思义，passthrough就是直通模式，service就是binder service模式。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/default/" target="_blank" rel="noopener">default</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/default/Android.bp" target="_blank" rel="noopener">Android.bp</a></p>
<pre><code>cc_library_shared {
    name: "android.hardware.graphics.composer@2.1-impl",
    defaults: ["hidl_defaults"],
    vendor: true,
    relative_install_path: "hw",
    srcs: ["passthrough.cpp"],
    header_libs: [
        "android.hardware.graphics.composer@2.1-passthrough",
    ],
    shared_libs: [
        "android.hardware.graphics.composer@2.1",
        "android.hardware.graphics.mapper@2.0",
        "libbase",
        "libcutils",
        "libfmq",
        "libhardware",
        "libhidlbase",
        "libhidltransport",
        "liblog",
        "libsync",
        "libutils",
        "libhwc2on1adapter",
        "libhwc2onfbadapter",
    ],
    cflags: [
        "-DLOG_TAG=\"ComposerHal\""
    ],
}

cc_binary {
    name: "android.hardware.graphics.composer@2.1-service",
    defaults: ["hidl_defaults"],
    vendor: true,
    relative_install_path: "hw",
    srcs: ["service.cpp"],
    init_rc: ["android.hardware.graphics.composer@2.1-service.rc"],
    shared_libs: [
        "android.hardware.graphics.composer@2.1",
        "libbinder",
        "libhidlbase",
        "libhidltransport",
        "liblog",
        "libsync",
        "libutils",
    ],
}</code></pre><p>能看到这个bp文件中，有两个cc编译工具，一个是以passthrough.cpp为入口，一个是以service.cpp为入口。也就是说，不同的模式启动Composer，将会打包进不同的入口。</p>
<p>值得注意的一点是，在share_libs一行中已经打包进了实现的so文件<a href="mailto:android.hardware.graphics.composer@2.1" target="_blank" rel="noopener">android.hardware.graphics.composer@2.1</a> 以及 图元申请工具<a href="mailto:android.hardware.graphics.mapper@2.0" target="_blank" rel="noopener">android.hardware.graphics.mapper@2.0</a>。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/Android.bp" target="_blank" rel="noopener">Android.bp</a></p>
<pre><code>hidl_interface {
    name: "android.hardware.graphics.composer@2.1",
    root: "android.hardware",
    vndk: {
        enabled: true,
    },
    srcs: [
        "types.hal",
        "IComposer.hal",
        "IComposerCallback.hal",
        "IComposerClient.hal",
    ],
    interfaces: [
        "android.hardware.graphics.common@1.0",
        "android.hidl.base@1.0",
    ],
    types: [
        "Error",
    ],
    gen_java: false,
}</code></pre><p>就能看到这个时候就看是引入了我们之前写入的hal文件。在整个Composer的HAL层包含了三个文件，一个在Composer中的是IComposer对象，一个是IComposerClient对象，还有一个是实现了IComposerCallback进行监听刷新屏幕热插拔的ComposerCallbackBridge。全部都囊括在内。</p>
<p>当我们选择的是直通模式，将会到下面这个<a href="mailto:android.hardware.graphics.composer@2.1-passthrough" target="_blank" rel="noopener">android.hardware.graphics.composer@2.1-passthrough</a>实现中，而这个对应的bp如下：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/" target="_blank" rel="noopener">passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/Android.bp" target="_blank" rel="noopener">Android.bp</a></p>
<pre><code>cc_library_headers {
    name: "android.hardware.graphics.composer@2.1-passthrough",
    defaults: ["hidl_defaults"],
    vendor: true,
    shared_libs: [
        "libhardware",
        "libhwc2on1adapter",
        "libhwc2onfbadapter",
    ],
    export_shared_lib_headers: [
        "libhardware",
        "libhwc2on1adapter",
        "libhwc2onfbadapter",
    ],
    header_libs: [
        "android.hardware.graphics.composer@2.1-hal",
    ],
    export_header_lib_headers: [
        "android.hardware.graphics.composer@2.1-hal",
    ],
    export_include_dirs: ["include"],
}</code></pre><p>能看到进一步的引入了hal，以及compser2.2转2.1的adapter等。值得注意的是export_include_dirs这个命令，这个命令是指把这个目录下的头文件全部引入到该模块中,而在这个文件夹中，就是hal硬件抽象层的实现代码。<br><img src="/images/%E7%9B%AE%E5%BD%954.png" alt="目录4.png"></p>
<p>而这两个文件就是Composer在hal中passthrough模式进入到具体业务的入口。</p>
<p>最后，我们需要在下面如同应用程序注册四大组建一样，注册到Android系统的xml中:<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/device/" target="_blank" rel="noopener">device</a>/<a href="http://androidxref.com/9.0.0_r3/xref/device/linaro/" target="_blank" rel="noopener">linaro</a>/<a href="http://androidxref.com/9.0.0_r3/xref/device/linaro/hikey/" target="_blank" rel="noopener">hikey</a>/<a href="http://androidxref.com/9.0.0_r3/xref/device/linaro/hikey/manifest.xml" target="_blank" rel="noopener">manifest.xml</a></p>
<pre class="line-numbers language-xml"><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hal</span> <span class="token attr-name">format</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hidl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>android.hardware.graphics.composer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transport</span> <span class="token attr-name">arch</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>32+64<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>passthrough<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transport</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interface</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>IComposer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>instance</span><span class="token punctuation">></span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>instance</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interface</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hal</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到的是hikey海思就是这么注册composer的，同时使用的还是passthrough模式。</p>
<p>当然，还有其他的如Google给的案例：</p>
<pre class="line-numbers language-xml"><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hal</span> <span class="token attr-name">format</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hidl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>android.hardware.graphics.composer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transport</span><span class="token punctuation">></span></span>hwbinder<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transport</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interface</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>IComposer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>instance</span><span class="token punctuation">></span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>instance</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interface</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hal</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里则是使用Binder的方式注册hal层逻辑。</p>
<p>别忘了最后编写一个rc文件，让init进程解析运行起来：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/default/" target="_blank" rel="noopener">default</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/default/android.hardware.graphics.composer%402.1-service.rc" target="_blank" rel="noopener">android.hardware.graphics.composer@2.1-service.rc</a></p>
<pre><code>service vendor.hwcomposer-2-1 /vendor/bin/hw/android.hardware.graphics.composer@2.1-service
    class hal animation
    user system
    group graphics drmrpc
    capabilities SYS_NICE
    writepid /dev/cpuset/system-background/tasks

on property:init.svc.surfaceflinger=stopped
    restart vendor.hwcomposer-2-1
</code></pre><p>其实了解这么多就可以了，如果想要全面的了解hidl的使用，不妨阅读下面这片文章：</p>
<ul>
<li><a href="https://www.cnblogs.com/hellokitty2/p/10598227.html" target="_blank" rel="noopener">hidl的使用</a></li>
</ul>
<p>如果想要探索hwBinder 进程service的方式是如何把Compser hal进程注册到hwServiceManager，又是如何找到对应的进程的，不妨看看下面这篇文章，写的挺好的：</p>
<ul>
<li><a href="https://blog.csdn.net/yangwen123/article/details/79854267" target="_blank" rel="noopener">AndroidO Treble架构下Hal进程启动及HIDL服务注册过程</a></li>
</ul>
<p>当我们有了一定的了解之后，我们可以进行对Composer的HAL进行解析。无论是直通模式还是binder service模式，只是启动方式不一样而已，不影响我们研究整个Composer 的HAL核心机制。</p>
<p>本文就以直通模式来和大家聊聊，其中的原理。</p>
<h4 id="小结-hidl的启动与注册"><a href="#小结-hidl的启动与注册" class="headerlink" title="小结 hidl的启动与注册"></a>小结 hidl的启动与注册</h4><p>简单的总结一下，Hal进程的启动和HIDL服务注册的原理:<br>还记得获得IComposer服务的方式如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">mComposer <span class="token operator">=</span> V2_1<span class="token operator">::</span>IComposer<span class="token operator">::</span><span class="token function">getService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>通过getService获取。这个函数做的事情有如下几件事情：</p>
<ul>
<li><p>1.先通过hwservicemanager 查询已经从manifest解析好的数据，先检查该服务需要以哪种形式启动的也就是Transport类型，是hwbinder的绑定模式还是passthrough的直通模式。</p>
</li>
<li><p>2.当为hwbinder模式时候，将会从hwservicemanager查询服务</p>
</li>
<li><p>3.当为passthrough模式时候，将会从PassthroughServiceManager获取服务</p>
</li>
<li><p>4.如果是passthrough启动，则会先先从系统目录下查找有没有对应的so，接着通过dlopen打开so，并用dlsym查找<strong>HIDL_FETCH_I</strong>+interface的名字，也就是HIDL_FETCH_IComposer方法获取IComposer对象，并执行起来。</p>
</li>
<li><p>5.拿到IComposer之后，就会注册到hwservicemanager</p>
</li>
</ul>
<h4 id="HAL-passthrough模式的启动入口"><a href="#HAL-passthrough模式的启动入口" class="headerlink" title="HAL passthrough模式的启动入口"></a>HAL passthrough模式的启动入口</h4><p>我们先来看IComposer 2.1版本：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/default/" target="_blank" rel="noopener">default</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/default/passthrough.cpp" target="_blank" rel="noopener">passthrough.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;android/hardware/graphics/composer/2.1/IComposer.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;composer-passthrough/2.1/HwcLoader.h></span></span>

<span class="token keyword">using</span> android<span class="token operator">::</span>hardware<span class="token operator">::</span>graphics<span class="token operator">::</span>composer<span class="token operator">::</span>V2_1<span class="token operator">::</span>IComposer<span class="token punctuation">;</span>
<span class="token keyword">using</span> android<span class="token operator">::</span>hardware<span class="token operator">::</span>graphics<span class="token operator">::</span>composer<span class="token operator">::</span>V2_1<span class="token operator">::</span>passthrough<span class="token operator">::</span>HwcLoader<span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> IComposer<span class="token operator">*</span> <span class="token function">HIDL_FETCH_IComposer</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token comment" spellcheck="true">/* name */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> HwcLoader<span class="token operator">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到本质上是HwcLoader调用了load方法实例化出来的。</p>
<h3 id="HwcLoader使用IComposer-初始化"><a href="#HwcLoader使用IComposer-初始化" class="headerlink" title="HwcLoader使用IComposer 初始化"></a>HwcLoader使用IComposer 初始化</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/" target="_blank" rel="noopener">passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/include/composer-passthrough/" target="_blank" rel="noopener">composer-passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/include/composer-passthrough/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/include/composer-passthrough/2.1/HwcLoader.h" target="_blank" rel="noopener">HwcLoader.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> IComposer<span class="token operator">*</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> hw_module_t<span class="token operator">*</span> module <span class="token operator">=</span> <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">auto</span> hal <span class="token operator">=</span> <span class="token function">createHalWithAdapter</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">createComposer</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>hal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能从该方法初步看到，IComposer初始化分为三个步骤：</p>
<ul>
<li>1.loadModule 加载hw_module_t 结构体，这个结构体实际上是一个hal模块的结构体。</li>
<li>2.createHalWithAdapter 通过hw_module_t 初始化hwc2_device_t结构体，让其拥有和顶层通信的能力也就是函数指针，并且适配2.1和2.2版本</li>
<li>3.createComposer 把hwc2_device_t转化为IComposer上传给客户端，也就是SF。</li>
</ul>
<p>接下来，我们就围绕着着三个方法，来聊聊整个逻辑。</p>
<h3 id="loadModule-加载-hw-module-t"><a href="#loadModule-加载-hw-module-t" class="headerlink" title="loadModule 加载 hw_module_t"></a>loadModule 加载 hw_module_t</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> HWC_HARDWARE_MODULE_ID "hwcomposer"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> GRALLOC_HARDWARE_MODULE_ID "gralloc"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token comment" spellcheck="true">// load hwcomposer2 module</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> hw_module_t<span class="token operator">*</span> <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> hw_module_t<span class="token operator">*</span> module<span class="token punctuation">;</span>
        <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token function">hw_get_module</span><span class="token punctuation">(</span>HWC_HARDWARE_MODULE_ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"falling back to gralloc module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            error <span class="token operator">=</span> <span class="token function">hw_get_module</span><span class="token punctuation">(</span>GRALLOC_HARDWARE_MODULE_ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"failed to get hwcomposer or gralloc module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> module<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程中会调用hw_get_module尝试获取对应名字的模块hwcomposer，如果获取不到则退化成gralloc，整个机制也就蜕化成HWC还没有出现之前的版本.我们先不去探索失败，我们来看看成功。</p>
<h4 id="hw-get-module-查找-hw-module-t"><a href="#hw-get-module-查找-hw-module-t" class="headerlink" title="hw_get_module 查找 hw_module_t"></a>hw_get_module 查找 hw_module_t</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/libhardware/" target="_blank" rel="noopener">libhardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/libhardware/hardware.c" target="_blank" rel="noopener">hardware.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">hw_get_module_by_class</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>class_id<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span>
                           <span class="token keyword">const</span> <span class="token keyword">struct</span> hw_module_t <span class="token operator">*</span><span class="token operator">*</span>module<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

found<span class="token operator">:</span>
    <span class="token comment" spellcheck="true">/* load the module, if this fails, we're doomed, and we should not try
     * to load a different variant. */</span>
    <span class="token keyword">return</span> <span class="token function">load</span><span class="token punctuation">(</span>class_id<span class="token punctuation">,</span> path<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">hw_get_module</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>id<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> hw_module_t <span class="token operator">*</span><span class="token operator">*</span>module<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">hw_get_module_by_class</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程会根据传进来的id名字来查找是否已经有如下几个路径下的so，</p>
<pre><code>#define HAL_LIBRARY_PATH1 "/system/lib64/hw"
#define HAL_LIBRARY_PATH2 "/vendor/lib64/hw"
#define HAL_LIBRARY_PATH3 "/odm/lib64/hw"
#else
#define HAL_LIBRARY_PATH1 "/system/lib/hw"
#define HAL_LIBRARY_PATH2 "/vendor/lib/hw"
#define HAL_LIBRARY_PATH3 "/odm/lib/hw"</code></pre><p>找到了则执行load方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>id<span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> hw_module_t <span class="token operator">*</span><span class="token operator">*</span>pHmi<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>handle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> hw_module_t <span class="token operator">*</span>hmi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> __ANDROID_VNDK__</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> try_system <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> try_system <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token comment" spellcheck="true">/*
     * load the symbols resolving undefined symbols before
     * dlopen returns. Since RTLD_GLOBAL is not or'd in with
     * RTLD_NOW the external symbols will not be global
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>try_system <span class="token operator">&amp;&amp;</span>
        <span class="token function">strncmp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> HAL_LIBRARY_PATH1<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>HAL_LIBRARY_PATH1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* If the library is in system partition, no need to check
         * sphal namespace. Open it with dlopen.
         */</span>
        handle <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        handle <span class="token operator">=</span> <span class="token function">android_load_sphal_library</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>err_str <span class="token operator">=</span> <span class="token function">dlerror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"load: module=%s\n%s"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> err_str<span class="token operator">?</span>err_str<span class="token operator">:</span><span class="token string">"unknown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/* Get the address of the struct hal_module_info. */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sym <span class="token operator">=</span> HAL_MODULE_INFO_SYM_AS_STR<span class="token punctuation">;</span>
    hmi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> hw_module_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> sym<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hmi <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"load: couldn't find symbol %s"</span><span class="token punctuation">,</span> sym<span class="token punctuation">)</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/* Check that the id matches */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> hmi<span class="token operator">-</span><span class="token operator">></span>id<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"load: id=%s != hmi->id=%s"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> hmi<span class="token operator">-</span><span class="token operator">></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    hmi<span class="token operator">-</span><span class="token operator">></span>dso <span class="token operator">=</span> handle<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* success */</span>
    status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    done<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hmi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dlclose</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            handle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"loaded HAL id=%s path=%s hmi=%p handle=%p"</span><span class="token punctuation">,</span>
                id<span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token operator">*</span>pHmi<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>pHmi <span class="token operator">=</span> hmi<span class="token punctuation">;</span>

    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果没有打开，则执行dlopen拿到对应so的句柄，接着同dlsym查找HMI字符，这个字符所指向的内存地址就是我们所说的hw_module_t.换算到现在名字可能是hwcomposer.xx.so</p>
<p>我们随便挑选一个作为源码解析，就以msm8960为例子：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/" target="_blank" rel="noopener">libhwcomposer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/hwc.cpp" target="_blank" rel="noopener">hwc.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> hw_module_methods_t hwc_module_methods <span class="token operator">=</span> <span class="token punctuation">{</span>
    open<span class="token operator">:</span> hwc_device_open
<span class="token punctuation">}</span><span class="token punctuation">;</span>

hwc_module_t HAL_MODULE_INFO_SYM <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>common <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>tag <span class="token operator">=</span> HARDWARE_MODULE_TAG<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>version_major <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>version_minor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>id <span class="token operator">=</span> HWC_HARDWARE_MODULE_ID<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Qualcomm Hardware Composer Module"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>author <span class="token operator">=</span> <span class="token string">"CodeAurora Forum"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>methods <span class="token operator">=</span> <span class="token operator">&amp;</span>hwc_module_methods<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>dso <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>reserved <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样就能找到hwc_module_t对应在底层的结构体。</p>
<h3 id="createHalWithAdapter-生成hw-device-t"><a href="#createHalWithAdapter-生成hw-device-t" class="headerlink" title="createHalWithAdapter 生成hw_device_t"></a>createHalWithAdapter 生成hw_device_t</h3><pre class="line-numbers language-cpp"><code class="language-cpp">  <span class="token comment" spellcheck="true">// create a ComposerHal instance, insert an adapter if necessary</span>
    <span class="token keyword">static</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>hal<span class="token operator">::</span>ComposerHal<span class="token operator">></span> <span class="token function">createHalWithAdapter</span><span class="token punctuation">(</span><span class="token keyword">const</span> hw_module_t<span class="token operator">*</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">bool</span> adapted<span class="token punctuation">;</span>
        hwc2_device_t<span class="token operator">*</span> device <span class="token operator">=</span> <span class="token function">openDeviceWithAdapter</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token operator">&amp;</span>adapted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>device<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">auto</span> hal <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>HwcHal<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> hal<span class="token operator">-</span><span class="token operator">></span><span class="token function">initWithDevice</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">!</span>adapted<span class="token punctuation">)</span> <span class="token operator">?</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>hal<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程做了两件事情，第一件事情就是openDeviceWithAdapter初始化hwc2_device_t，第二件事情就是实例化HwcHal对象并且设置hwc2_device_t。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">static</span> hwc2_device_t<span class="token operator">*</span> <span class="token function">openDeviceWithAdapter</span><span class="token punctuation">(</span><span class="token keyword">const</span> hw_module_t<span class="token operator">*</span> module<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> outAdapted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token operator">-</span><span class="token operator">></span>id <span class="token operator">&amp;&amp;</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span>module<span class="token operator">-</span><span class="token operator">></span>id<span class="token punctuation">)</span> <span class="token operator">==</span> GRALLOC_HARDWARE_MODULE_ID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>outAdapted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">adaptGrallocModule</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        hw_device_t<span class="token operator">*</span> device<span class="token punctuation">;</span>
        <span class="token keyword">int</span> error <span class="token operator">=</span> module<span class="token operator">-</span><span class="token operator">></span>methods<span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> HWC_HARDWARE_COMPOSER<span class="token punctuation">,</span> <span class="token operator">&amp;</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"failed to open hwcomposer device: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> major <span class="token operator">=</span> <span class="token punctuation">(</span>device<span class="token operator">-</span><span class="token operator">></span>version <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>outAdapted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">adaptHwc1Device</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>hwc_composer_device_1<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token operator">*</span>outAdapted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>hwc2_device_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能够看到，如果失败则会调用adaptGrallocModule，初始化的是gralloc的hal模块。成果则会调用hw_module_t中的open方法。判断如果当前主版本不是2，则调用adaptHwc1Device适配hw_device_t，最后返回。</p>
<p>这里需要注意一点hw_device_t，会被向下转型成hwc_composer_device_1对象后传入adaptHwc1Device。其原理和类的继承很相似，因为hwc_composer_device_1包裹了一个hw_device_t。又因为struct是连续分配的空间，这样才能够强转(这种设计在socket系统调用到处都是)。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> hwc_composer_device_1 <span class="token punctuation">{</span>

    <span class="token keyword">struct</span> hw_device_t common<span class="token punctuation">;</span>


    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>prepare<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1 <span class="token operator">*</span>dev<span class="token punctuation">,</span>
                    size_t numDisplays<span class="token punctuation">,</span> hwc_display_contents_1_t<span class="token operator">*</span><span class="token operator">*</span> displays<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1 <span class="token operator">*</span>dev<span class="token punctuation">,</span>
                size_t numDisplays<span class="token punctuation">,</span> hwc_display_contents_1_t<span class="token operator">*</span><span class="token operator">*</span> displays<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>eventControl<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1<span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> disp<span class="token punctuation">,</span>
            <span class="token keyword">int</span> event<span class="token punctuation">,</span> <span class="token keyword">int</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">union</span> <span class="token punctuation">{</span>

        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>blank<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1<span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> disp<span class="token punctuation">,</span> <span class="token keyword">int</span> blank<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setPowerMode<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1<span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> disp<span class="token punctuation">,</span>
                <span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>


    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>query<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1<span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> what<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dump<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1<span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token keyword">int</span> buff_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>getDisplayConfigs<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1<span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> disp<span class="token punctuation">,</span>
            uint32_t<span class="token operator">*</span> configs<span class="token punctuation">,</span> size_t<span class="token operator">*</span> numConfigs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>getDisplayAttributes<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1<span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> disp<span class="token punctuation">,</span>
            uint32_t config<span class="token punctuation">,</span> <span class="token keyword">const</span> uint32_t<span class="token operator">*</span> attributes<span class="token punctuation">,</span> int32_t<span class="token operator">*</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>getActiveConfig<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1<span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> disp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setActiveConfig<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1<span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> disp<span class="token punctuation">,</span>
            <span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setCursorPositionAsync<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1 <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> disp<span class="token punctuation">,</span> <span class="token keyword">int</span> x_pos<span class="token punctuation">,</span> <span class="token keyword">int</span> y_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span><span class="token operator">*</span> reserved_proc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> hwc_composer_device_1_t<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上文能看到此时open的方法，指向的是hwc_device_open函数指针。</p>
<h5 id="hwc-device-open-初始化hw-device-t"><a href="#hwc-device-open-初始化hw-device-t" class="headerlink" title="hwc_device_open 初始化hw_device_t"></a>hwc_device_open 初始化hw_device_t</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hwc_device_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> hw_module_t<span class="token operator">*</span> module<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span>
                           <span class="token keyword">struct</span> hw_device_t<span class="token operator">*</span><span class="token operator">*</span> device<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> HWC_HARDWARE_COMPOSER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> hwc_context_t <span class="token operator">*</span>dev<span class="token punctuation">;</span>
        dev <span class="token operator">=</span> <span class="token punctuation">(</span>hwc_context_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//Initialize hwc context</span>
        <span class="token function">initContext</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//Setup HWC methods</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>common<span class="token punctuation">.</span>tag          <span class="token operator">=</span> HARDWARE_DEVICE_TAG<span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>common<span class="token punctuation">.</span>version      <span class="token operator">=</span> HWC_DEVICE_API_VERSION_1_2<span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>common<span class="token punctuation">.</span>module       <span class="token operator">=</span> <span class="token keyword">const_cast</span><span class="token operator">&lt;</span>hw_module_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>common<span class="token punctuation">.</span>close        <span class="token operator">=</span> hwc_device_close<span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>prepare             <span class="token operator">=</span> hwc_prepare<span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>set                 <span class="token operator">=</span> hwc_set<span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>eventControl        <span class="token operator">=</span> hwc_eventControl<span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>blank               <span class="token operator">=</span> hwc_blank<span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>query               <span class="token operator">=</span> hwc_query<span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>registerProcs       <span class="token operator">=</span> hwc_registerProcs<span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>dump                <span class="token operator">=</span> hwc_dump<span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>getDisplayConfigs   <span class="token operator">=</span> hwc_getDisplayConfigs<span class="token punctuation">;</span>
        dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>getDisplayAttributes <span class="token operator">=</span> hwc_getDisplayAttributes<span class="token punctuation">;</span>
        <span class="token operator">*</span>device <span class="token operator">=</span> <span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>common<span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个方法中，为hw_device_t这个结构体每一个函数指针都真正赋予了其含义，最后所有的hal层执行都会走到hwc.cpp这里。</p>
<p>这里要注意了version的计算并不是上面那个version_major,而是HWC_DEVICE_API_VERSION_1_2。其实他的计算如下</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">define HWC_DEVICE_API_VERSION_1_2  <span class="token function">HARDWARE_DEVICE_API_VERSION_2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> HWC_HEADER_VERSION<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> HARDWARE_MAKE_API_VERSION_2(maj,min,hdr) \
            ((((maj) &amp; 0xff) &lt;&lt; 24) | (((min) &amp; 0xff) &lt;&lt; 16) | ((hdr) &amp; 0xffff))</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>很有误导性，其实是1在高24位，5在低16位，最后一个是头信息。因此是其实1.2版本，而不是版本2。</p>
<p>所以接下来会走到适配的分之adaptHwc1Device。</p>
<h4 id="adaptHwc1Device-适配hwc2-device-t"><a href="#adaptHwc1Device-适配hwc2-device-t" class="headerlink" title="adaptHwc1Device 适配hwc2_device_t"></a>adaptHwc1Device 适配hwc2_device_t</h4><pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">static</span> hwc2_device_t<span class="token operator">*</span> <span class="token function">adaptHwc1Device</span><span class="token punctuation">(</span>hwc_composer_device_1<span class="token operator">*</span> device<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> minor <span class="token operator">=</span> <span class="token punctuation">(</span>device<span class="token operator">-</span><span class="token operator">></span>common<span class="token punctuation">.</span>version <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>minor <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"hwcomposer 1.0 is not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            device<span class="token operator">-</span><span class="token operator">></span>common<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token operator">-</span><span class="token operator">></span>common<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">HWC2On1Adapter</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到小版本小于1则非法，只会适配大于等于的版本，就会生成一个HWC2On1Adapter对象。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hwc2on1adapter/" target="_blank" rel="noopener">hwc2on1adapter</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hwc2on1adapter/HWC2On1Adapter.cpp" target="_blank" rel="noopener">HWC2On1Adapter.cpp</a></p>
<p>其实这个对象就是hwc2_device_t：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">HWC2On1Adapter</span> <span class="token operator">:</span> <span class="token keyword">public</span> hwc2_device_t<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们来看看他的构造函数。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">HWC2On1Adapter<span class="token operator">::</span><span class="token function">HWC2On1Adapter</span><span class="token punctuation">(</span>hwc_composer_device_1_t<span class="token operator">*</span> hwc1Device<span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">mDumpString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mHwc1Device</span><span class="token punctuation">(</span>hwc1Device<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mHwc1MinorVersion</span><span class="token punctuation">(</span><span class="token function">getMinorVersion</span><span class="token punctuation">(</span>hwc1Device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mHwc1SupportsVirtualDisplays</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mHwc1SupportsBackgroundColor</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mHwc1Callbacks</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Callbacks<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mLayers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mHwc1VirtualDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mStateMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mHasPendingInvalidate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mPendingVsyncs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mPendingHotplugs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mDisplays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mHwc1DisplayMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    common<span class="token punctuation">.</span>close <span class="token operator">=</span> closeHook<span class="token punctuation">;</span>
    getCapabilities <span class="token operator">=</span> getCapabilitiesHook<span class="token punctuation">;</span>
    getFunction <span class="token operator">=</span> getFunctionHook<span class="token punctuation">;</span>
    <span class="token function">populateCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">populatePrimary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mHwc1Device<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerProcs</span><span class="token punctuation">(</span>mHwc1Device<span class="token punctuation">,</span>
            <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> hwc_procs_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>mHwc1Callbacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里面设置两个很核心的东西一个是getFunctionHook，一个调用了hwc_device_t的registerProcs方法。</p>
<p>前者是一个模版方法，调用hwc_device_t中方法指针。后者是hal层注册监听驱动的核心逻辑。</p>
<p>首先看看mHwc1Callbacks实际上是HWC2On1Adapter::Callbacks：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">HWC2On1Adapter</span><span class="token operator">::</span>Callbacks <span class="token operator">:</span> <span class="token keyword">public</span> hwc_procs_t <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">explicit</span> <span class="token function">Callbacks</span><span class="token punctuation">(</span>HWC2On1Adapter<span class="token operator">&amp;</span> adapter<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">mAdapter</span><span class="token punctuation">(</span>adapter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            invalidate <span class="token operator">=</span> <span class="token operator">&amp;</span>invalidateHook<span class="token punctuation">;</span>
            vsync <span class="token operator">=</span> <span class="token operator">&amp;</span>vsyncHook<span class="token punctuation">;</span>
            hotplug <span class="token operator">=</span> <span class="token operator">&amp;</span>hotplugHook<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invalidateHook</span><span class="token punctuation">(</span><span class="token keyword">const</span> hwc_procs_t<span class="token operator">*</span> procs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> callbacks <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> Callbacks<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>procs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            callbacks<span class="token operator">-</span><span class="token operator">></span>mAdapter<span class="token punctuation">.</span><span class="token function">hwc1Invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">vsyncHook</span><span class="token punctuation">(</span><span class="token keyword">const</span> hwc_procs_t<span class="token operator">*</span> procs<span class="token punctuation">,</span> <span class="token keyword">int</span> display<span class="token punctuation">,</span>
                int64_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> callbacks <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> Callbacks<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>procs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            callbacks<span class="token operator">-</span><span class="token operator">></span>mAdapter<span class="token punctuation">.</span><span class="token function">hwc1Vsync</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hotplugHook</span><span class="token punctuation">(</span><span class="token keyword">const</span> hwc_procs_t<span class="token operator">*</span> procs<span class="token punctuation">,</span> <span class="token keyword">int</span> display<span class="token punctuation">,</span>
                <span class="token keyword">int</span> connected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> callbacks <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> Callbacks<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>procs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            callbacks<span class="token operator">-</span><span class="token operator">></span>mAdapter<span class="token punctuation">.</span><span class="token function">hwc1Hotplug</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> connected<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        HWC2On1Adapter<span class="token operator">&amp;</span> mAdapter<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到三个十分熟悉的回调，invalidate，vsync，hotplug。那么其实这个回调就是从底层驱动程序上传第一个回调，之后才有其他的。每个方法又会调用HWC2On1Adapter对应的回调方法。</p>
<p>记住，在这里面同时把hwc_procs_t三个函数指针invalidate，vsync，hotplug都指向了这个回调中的方法。换句话说所有从底层响应上来，都该类中调用所有的回调，最终都会汇总到这个Callback。</p>
<p>我们暂时把流程停在这里，稍后让我把监听的接进来，再去更加底层看看是怎么回事？</p>
<h4 id="HwcHal的初始化"><a href="#HwcHal的初始化" class="headerlink" title="HwcHal的初始化"></a>HwcHal的初始化</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/" target="_blank" rel="noopener">passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/include/composer-passthrough/" target="_blank" rel="noopener">composer-passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/include/composer-passthrough/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/passthrough/include/composer-passthrough/2.1/HwcHal.h" target="_blank" rel="noopener">HwcHal.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> android <span class="token punctuation">{</span>
<span class="token keyword">namespace</span> hardware <span class="token punctuation">{</span>
<span class="token keyword">namespace</span> graphics <span class="token punctuation">{</span>
<span class="token keyword">namespace</span> composer <span class="token punctuation">{</span>
<span class="token keyword">namespace</span> V2_1 <span class="token punctuation">{</span>
<span class="token keyword">namespace</span> passthrough <span class="token punctuation">{</span>

<span class="token keyword">namespace</span> detail <span class="token punctuation">{</span>

<span class="token keyword">using</span> android<span class="token operator">::</span>hardware<span class="token operator">::</span>graphics<span class="token operator">::</span>common<span class="token operator">::</span>V1_0<span class="token operator">::</span>ColorMode<span class="token punctuation">;</span>
<span class="token keyword">using</span> android<span class="token operator">::</span>hardware<span class="token operator">::</span>graphics<span class="token operator">::</span>common<span class="token operator">::</span>V1_0<span class="token operator">::</span>ColorTransform<span class="token punctuation">;</span>
<span class="token keyword">using</span> android<span class="token operator">::</span>hardware<span class="token operator">::</span>graphics<span class="token operator">::</span>common<span class="token operator">::</span>V1_0<span class="token operator">::</span>Dataspace<span class="token punctuation">;</span>
<span class="token keyword">using</span> android<span class="token operator">::</span>hardware<span class="token operator">::</span>graphics<span class="token operator">::</span>common<span class="token operator">::</span>V1_0<span class="token operator">::</span>Hdr<span class="token punctuation">;</span>
<span class="token keyword">using</span> android<span class="token operator">::</span>hardware<span class="token operator">::</span>graphics<span class="token operator">::</span>common<span class="token operator">::</span>V1_0<span class="token operator">::</span>PixelFormat<span class="token punctuation">;</span>
<span class="token keyword">using</span> android<span class="token operator">::</span>hardware<span class="token operator">::</span>graphics<span class="token operator">::</span>common<span class="token operator">::</span>V1_0<span class="token operator">::</span>Transform<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// HwcHalImpl implements V2_*::hal::ComposerHal on top of hwcomposer2</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> Hal<span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">HwcHalImpl</span> <span class="token operator">:</span> <span class="token keyword">public</span> Hal <span class="token punctuation">{</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">HwcHalImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDevice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hwc2_close</span><span class="token punctuation">(</span>mDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">bool</span> <span class="token function">initWithDevice</span><span class="token punctuation">(</span>hwc2_device_t<span class="token operator">*</span> device<span class="token punctuation">,</span> <span class="token keyword">bool</span> requireReliablePresentFence<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// we own the device from this point on</span>
        mDevice <span class="token operator">=</span> device<span class="token punctuation">;</span>

        <span class="token function">initCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requireReliablePresentFence <span class="token operator">&amp;&amp;</span>
            <span class="token function">hasCapability</span><span class="token punctuation">(</span>HWC2_CAPABILITY_PRESENT_FENCE_IS_NOT_RELIABLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"present fence must be reliable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mDevice<span class="token operator">-</span><span class="token operator">></span>common<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mDevice<span class="token operator">-</span><span class="token operator">></span>common<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mDevice <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initDispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mDevice<span class="token operator">-</span><span class="token operator">></span>common<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mDevice<span class="token operator">-</span><span class="token operator">></span>common<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mDevice <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace detail</span>

<span class="token keyword">using</span> HwcHal <span class="token operator">=</span> detail<span class="token operator">::</span>HwcHalImpl<span class="token operator">&lt;</span>hal<span class="token operator">::</span>ComposerHal<span class="token operator">></span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace passthrough</span>
<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace V2_1</span>
<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace composer</span>
<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace graphics</span>
<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace hardware</span>
<span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// namespace android</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>HwcHalImpl 本质上就是继承hal::ComposerHal，也就是说ComposerHal持有<br>将会持有一个hw_device_t结构体，作为真正的操作对象。</p>
<p>第二点，调用initDispatch，为mDispatch结构体中所有的函数指针都初始化。之后所有调用函数都是是通过mDispatch调用hw_device_t的方法</p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        HWC2_PFN_ACCEPT_DISPLAY_CHANGES acceptDisplayChanges<span class="token punctuation">;</span>
        HWC2_PFN_CREATE_LAYER createLayer<span class="token punctuation">;</span>
        HWC2_PFN_CREATE_VIRTUAL_DISPLAY createVirtualDisplay<span class="token punctuation">;</span>
        HWC2_PFN_DESTROY_LAYER destroyLayer<span class="token punctuation">;</span>
        HWC2_PFN_DESTROY_VIRTUAL_DISPLAY destroyVirtualDisplay<span class="token punctuation">;</span>
        HWC2_PFN_DUMP dump<span class="token punctuation">;</span>
        HWC2_PFN_GET_ACTIVE_CONFIG getActiveConfig<span class="token punctuation">;</span>
        HWC2_PFN_GET_CHANGED_COMPOSITION_TYPES getChangedCompositionTypes<span class="token punctuation">;</span>
        HWC2_PFN_GET_CLIENT_TARGET_SUPPORT getClientTargetSupport<span class="token punctuation">;</span>
        HWC2_PFN_GET_COLOR_MODES getColorModes<span class="token punctuation">;</span>
        HWC2_PFN_GET_DISPLAY_ATTRIBUTE getDisplayAttribute<span class="token punctuation">;</span>
        HWC2_PFN_GET_DISPLAY_CONFIGS getDisplayConfigs<span class="token punctuation">;</span>
        HWC2_PFN_GET_DISPLAY_NAME getDisplayName<span class="token punctuation">;</span>
        HWC2_PFN_GET_DISPLAY_REQUESTS getDisplayRequests<span class="token punctuation">;</span>
        HWC2_PFN_GET_DISPLAY_TYPE getDisplayType<span class="token punctuation">;</span>
        HWC2_PFN_GET_DOZE_SUPPORT getDozeSupport<span class="token punctuation">;</span>
        HWC2_PFN_GET_HDR_CAPABILITIES getHdrCapabilities<span class="token punctuation">;</span>
        HWC2_PFN_GET_MAX_VIRTUAL_DISPLAY_COUNT getMaxVirtualDisplayCount<span class="token punctuation">;</span>
        HWC2_PFN_GET_RELEASE_FENCES getReleaseFences<span class="token punctuation">;</span>
        HWC2_PFN_PRESENT_DISPLAY presentDisplay<span class="token punctuation">;</span>
        HWC2_PFN_REGISTER_CALLBACK registerCallback<span class="token punctuation">;</span>
        HWC2_PFN_SET_ACTIVE_CONFIG setActiveConfig<span class="token punctuation">;</span>
        HWC2_PFN_SET_CLIENT_TARGET setClientTarget<span class="token punctuation">;</span>
        HWC2_PFN_SET_COLOR_MODE setColorMode<span class="token punctuation">;</span>
        HWC2_PFN_SET_COLOR_TRANSFORM setColorTransform<span class="token punctuation">;</span>
        HWC2_PFN_SET_CURSOR_POSITION setCursorPosition<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_BLEND_MODE setLayerBlendMode<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_BUFFER setLayerBuffer<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_COLOR setLayerColor<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_COMPOSITION_TYPE setLayerCompositionType<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_DATASPACE setLayerDataspace<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_DISPLAY_FRAME setLayerDisplayFrame<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_PLANE_ALPHA setLayerPlaneAlpha<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_SIDEBAND_STREAM setLayerSidebandStream<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_SOURCE_CROP setLayerSourceCrop<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_SURFACE_DAMAGE setLayerSurfaceDamage<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_TRANSFORM setLayerTransform<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_VISIBLE_REGION setLayerVisibleRegion<span class="token punctuation">;</span>
        HWC2_PFN_SET_LAYER_Z_ORDER setLayerZOrder<span class="token punctuation">;</span>
        HWC2_PFN_SET_OUTPUT_BUFFER setOutputBuffer<span class="token punctuation">;</span>
        HWC2_PFN_SET_POWER_MODE setPowerMode<span class="token punctuation">;</span>
        HWC2_PFN_SET_VSYNC_ENABLED setVsyncEnabled<span class="token punctuation">;</span>
        HWC2_PFN_VALIDATE_DISPLAY validateDisplay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> mDispatch <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="createComposer-构建IComposer对象"><a href="#createComposer-构建IComposer对象" class="headerlink" title="createComposer 构建IComposer对象"></a>createComposer 构建IComposer对象</h3><pre class="line-numbers language-c"><code class="language-c">    <span class="token keyword">static</span> IComposer<span class="token operator">*</span> <span class="token function">createComposer</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token operator">&lt;</span>hal<span class="token punctuation">:</span><span class="token punctuation">:</span>ComposerHal<span class="token operator">></span> hal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> hal<span class="token punctuation">:</span><span class="token punctuation">:</span>Composer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">create</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>hal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/" target="_blank" rel="noopener">hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/" target="_blank" rel="noopener">composer-hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/Composer.h" target="_blank" rel="noopener">Composer.h</a></p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token keyword">static</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token operator">&lt;</span>ComposerImpl<span class="token operator">></span> <span class="token function">create</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token operator">&lt;</span>Hal<span class="token operator">></span> hal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>make_unique<span class="token operator">&lt;</span>ComposerImpl<span class="token operator">></span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">move</span><span class="token punctuation">(</span>hal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>很简单，本质上就是一个ComposerImpl持有了ComposerHal。</p>
<p>嵌套的层级有点深，接下来让我把整个UML图画出来就清晰了，再结合一下上一篇文章，梳理一下。<br><img src="/images/HWC%E5%85%B3%E9%94%AE%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.jpg" alt="HWC关键数据结构.jpg"></p>
<h3 id="Composer初始化中Hal的工作"><a href="#Composer初始化中Hal的工作" class="headerlink" title="Composer初始化中Hal的工作"></a>Composer初始化中Hal的工作</h3><p>在上一篇文章中有两个hal方法没有进一步的聊，第一个是createClient创建IComposerClient，另一个是注册监听。</p>
<h4 id="Composer创建ComposerClient"><a href="#Composer创建ComposerClient" class="headerlink" title="Composer创建ComposerClient"></a>Composer创建ComposerClient</h4><p>我们先把视角转移到<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/" target="_blank" rel="noopener">DisplayHardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/ComposerHal.cpp" target="_blank" rel="noopener">ComposerHal.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Composer<span class="token operator">::</span><span class="token function">Composer</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> serviceName<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">mWriter</span><span class="token punctuation">(</span>kWriterInitialSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mIsUsingVrComposer</span><span class="token punctuation">(</span>serviceName <span class="token operator">==</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"vr"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mComposer <span class="token operator">=</span> V2_1<span class="token operator">::</span>IComposer<span class="token operator">::</span><span class="token function">getService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mComposer<span class="token operator">-</span><span class="token operator">></span><span class="token function">createClient</span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> tmpError<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> tmpClient<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpError <span class="token operator">==</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mClient <span class="token operator">=</span> tmpClient<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// 2.2 support is optional</span>
    sp<span class="token operator">&lt;</span>IComposer<span class="token operator">></span> composer_2_2 <span class="token operator">=</span> IComposer<span class="token operator">::</span><span class="token function">castFrom</span><span class="token punctuation">(</span>mComposer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>composer_2_2 <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mClient_2_2 <span class="token operator">=</span> IComposerClient<span class="token operator">::</span><span class="token function">castFrom</span><span class="token punctuation">(</span>mClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>mComposer通过getService拿到hal层的IComposer对象。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/" target="_blank" rel="noopener">hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/" target="_blank" rel="noopener">composer-hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/Composer.h" target="_blank" rel="noopener">Composer.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    Return<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">createClient</span><span class="token punctuation">(</span>IComposer<span class="token operator">::</span>createClient_cb hidl_cb<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mClientMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">waitForClientDestroyedLocked</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hidl_cb</span><span class="token punctuation">(</span>Error<span class="token operator">::</span>NO_RESOURCES<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        sp<span class="token operator">&lt;</span>IComposerClient<span class="token operator">></span> client <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hidl_cb</span><span class="token punctuation">(</span>Error<span class="token operator">::</span>NO_RESOURCES<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mClient <span class="token operator">=</span> client<span class="token punctuation">;</span>
        <span class="token function">hidl_cb</span><span class="token punctuation">(</span>Error<span class="token operator">::</span>NONE<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">onClientDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token operator">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mClientMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mClient<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mClientDestroyedCondition<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">virtual</span> IComposerClient<span class="token operator">*</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> client <span class="token operator">=</span> ComposerClient<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>mHal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">auto</span> clientDestroyed <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">onClientDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        client<span class="token operator">-</span><span class="token operator">></span><span class="token function">setOnClientDestroyed</span><span class="token punctuation">(</span>clientDestroyed<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上还是调用了ComposerClient::create方法实例化一个IComposerClient方法，接着才会把这个这个方法通过回调回调出去。同时让Composer持有一个mClient对象，当销毁的时候，会调用mClient的clear方法，并且唤起阻塞。也就是指销毁一个HWC::Device的mClient对象。</p>
<p>接下来看看ComposerClient的create方法：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/" target="_blank" rel="noopener">hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/" target="_blank" rel="noopener">composer-hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/ComposerClient.h" target="_blank" rel="noopener">ComposerClient.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">static</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>ComposerClientImpl<span class="token operator">></span> <span class="token function">create</span><span class="token punctuation">(</span>Hal<span class="token operator">*</span> hal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> client <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>ComposerClientImpl<span class="token operator">></span><span class="token punctuation">(</span>hal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> client<span class="token operator">-</span><span class="token operator">></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mResources <span class="token operator">=</span> <span class="token function">createResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"failed to create composer resources"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mCommandEngine <span class="token operator">=</span> <span class="token function">createCommandEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">virtual</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>ComposerResources<span class="token operator">></span> <span class="token function">createResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ComposerResources<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">virtual</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>ComposerCommandEngine<span class="token operator">></span> <span class="token function">createCommandEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>ComposerCommandEngine<span class="token operator">></span><span class="token punctuation">(</span>mHal<span class="token punctuation">,</span> mResources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到Client会持有两个对象，一个是ComposerResources，一个是ComposerCommandEngine。</p>
<ul>
<li>ComposerResources 控制整个SF的Hal的资源，如绘制面Layer，如图元</li>
<li>ComposerCommandEngine 处理从SF上层到hal层的一些命令，用来实现一些需要直接通信到驱动的命令。</li>
</ul>
<h4 id="ComposerResources-初始化"><a href="#ComposerResources-初始化" class="headerlink" title="ComposerResources 初始化"></a>ComposerResources 初始化</h4><pre class="line-numbers language-cpp"><code class="language-cpp"> <span class="token keyword">static</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>ComposerResources<span class="token operator">></span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> resources <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>ComposerResources<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> resources<span class="token operator">-</span><span class="token operator">></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> mImporter<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在ComposerResources初始化的同时，还会初始化ComposerHandleImporter对象。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">ComposerHandleImporter</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">bool</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mMapper <span class="token operator">=</span> mapper<span class="token operator">::</span>V2_0<span class="token operator">::</span>IMapper<span class="token operator">::</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> mMapper <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该对象初始化了一个IMapper的Hal服务，其实该Hal服务就是图元申请器。换句话说Composer将会通过ComposerResources调用ComposerHandleImporter控制图元的状态。</p>
<h4 id="ComposerCommandEngine-初始化"><a href="#ComposerCommandEngine-初始化" class="headerlink" title="ComposerCommandEngine 初始化"></a>ComposerCommandEngine 初始化</h4><pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token function">ComposerCommandEngine</span><span class="token punctuation">(</span>ComposerHal<span class="token operator">*</span> hal<span class="token punctuation">,</span> ComposerResources<span class="token operator">*</span> resources<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">mHal</span><span class="token punctuation">(</span>hal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mResources</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这个对象等到用的时候再去理解。</p>
<p>这两个对象很重要，记住就好，后面会和它们打交道。</p>
<h4 id="IComposer通过注册监听Hal层实现监听驱动的关键动作"><a href="#IComposer通过注册监听Hal层实现监听驱动的关键动作" class="headerlink" title="IComposer通过注册监听Hal层实现监听驱动的关键动作"></a>IComposer通过注册监听Hal层实现监听驱动的关键动作</h4><p>还记得在SF的init方法中，我们还注册了一个Callback到Hal层中:<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/" target="_blank" rel="noopener">DisplayHardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/HWC2.cpp" target="_blank" rel="noopener">HWC2.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> Device<span class="token operator">::</span><span class="token function">registerCallback</span><span class="token punctuation">(</span>ComposerCallback<span class="token operator">*</span> callback<span class="token punctuation">,</span> int32_t sequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegisteredCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Callback already registered. Ignored extra registration "</span>
                <span class="token string">"attempt."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mRegisteredCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>ComposerCallbackBridge<span class="token operator">></span> <span class="token function">callbackBridge</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token function">ComposerCallbackBridge</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> sequenceId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mComposer<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerCallback</span><span class="token punctuation">(</span>callbackBridge<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Device中的mComposer，其实是Composer，而这个对象才是统一处理HIDL对应在客户端的对象。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> Composer<span class="token operator">::</span><span class="token function">registerCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IComposerCallback<span class="token operator">></span><span class="token operator">&amp;</span> callback<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">auto</span> ret <span class="token operator">=</span> mClient<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"failed to register IComposerCallback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/" target="_blank" rel="noopener">hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/" target="_blank" rel="noopener">composer-hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/ComposerClient.h" target="_blank" rel="noopener">ComposerClient.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    Return<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">registerCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IComposerCallback<span class="token operator">></span><span class="token operator">&amp;</span> callback<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// no locking as we require this function to be called only once</span>
        mHalEventCallback <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>HalEventCallback<span class="token operator">></span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> mResources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHal<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerEventCallback</span><span class="token punctuation">(</span>mHalEventCallback<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这里面会把IComposerCallback再一次包裹成HalEventCallback对象，才会注册到mHal，也就是HwcHalImpl对象。</p>
<p>来看看HalEventCallback这个包裹类：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">class</span> <span class="token class-name">HalEventCallback</span> <span class="token operator">:</span> <span class="token keyword">public</span> Hal<span class="token operator">::</span>EventCallback <span class="token punctuation">{</span>
       <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">HalEventCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IComposerCallback<span class="token operator">></span> callback<span class="token punctuation">,</span> ComposerResources<span class="token operator">*</span> resources<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">mCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mResources</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">onHotplug</span><span class="token punctuation">(</span>Display display<span class="token punctuation">,</span> IComposerCallback<span class="token operator">::</span>Connection connected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connected <span class="token operator">==</span> IComposerCallback<span class="token operator">::</span>Connection<span class="token operator">::</span>CONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mResources<span class="token operator">-</span><span class="token operator">></span><span class="token function">addPhysicalDisplay</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>connected <span class="token operator">==</span> IComposerCallback<span class="token operator">::</span>Connection<span class="token operator">::</span>DISCONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mResources<span class="token operator">-</span><span class="token operator">></span><span class="token function">removeDisplay</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">auto</span> ret <span class="token operator">=</span> mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onHotplug</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> connected<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ALOGE_IF</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"failed to send onHotplug: %s"</span><span class="token punctuation">,</span> ret<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">onRefresh</span><span class="token punctuation">(</span>Display display<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> ret <span class="token operator">=</span> mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onRefresh</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ALOGE_IF</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"failed to send onRefresh: %s"</span><span class="token punctuation">,</span> ret<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">onVsync</span><span class="token punctuation">(</span>Display display<span class="token punctuation">,</span> int64_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> ret <span class="token operator">=</span> mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onVsync</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ALOGE_IF</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"failed to send onVsync: %s"</span><span class="token punctuation">,</span> ret<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

       <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IComposerCallback<span class="token operator">></span> mCallback<span class="token punctuation">;</span>
        ComposerResources<span class="token operator">*</span> <span class="token keyword">const</span> mResources<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法本质上就是为了集中IComposerCallback和mResources处理。在HalEventCallback中对应每一种回调都有自己的方法，他除了会调用IComposerCallback对应的回调之外，还会特别处理屏幕的热插拔，如果是插入则将一个屏幕对象添加到ComposerResources，进行管理。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">void</span> <span class="token function">registerEventCallback</span><span class="token punctuation">(</span>hal<span class="token operator">::</span>ComposerHal<span class="token operator">::</span>EventCallback<span class="token operator">*</span> callback<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        mMustValidateDisplay <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        mEventCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>

        mDispatch<span class="token punctuation">.</span><span class="token function">registerCallback</span><span class="token punctuation">(</span>mDevice<span class="token punctuation">,</span> HWC2_CALLBACK_HOTPLUG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                                   <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>hwc2_function_pointer_t<span class="token operator">></span><span class="token punctuation">(</span>hotplugHook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDispatch<span class="token punctuation">.</span><span class="token function">registerCallback</span><span class="token punctuation">(</span>mDevice<span class="token punctuation">,</span> HWC2_CALLBACK_REFRESH<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                                   <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>hwc2_function_pointer_t<span class="token operator">></span><span class="token punctuation">(</span>refreshHook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDispatch<span class="token punctuation">.</span><span class="token function">registerCallback</span><span class="token punctuation">(</span>mDevice<span class="token punctuation">,</span> HWC2_CALLBACK_VSYNC<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                                   <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>hwc2_function_pointer_t<span class="token operator">></span><span class="token punctuation">(</span>vsyncHook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时将会调用mDispatch的registerCallback方法。其实这个方法是一个模版方法，其实就是调用mDevice的registerCallback方法，并且把后面几个作为参数设置进去。</p>
<p>从上文就解析到mDevice其实是hw2_device_t结构体也是HWC2On1Adapter，那么其实就是调用HWC2On1Adapter中的注册方法。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hwc2on1adapter/" target="_blank" rel="noopener">hwc2on1adapter</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hwc2on1adapter/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hwc2on1adapter/include/hwc2on1adapter/" target="_blank" rel="noopener">hwc2on1adapter</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hwc2on1adapter/include/hwc2on1adapter/HWC2On1Adapter.h" target="_blank" rel="noopener">HWC2On1Adapter.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Error HWC2On1Adapter<span class="token operator">::</span><span class="token function">registerCallback</span><span class="token punctuation">(</span>Callback descriptor<span class="token punctuation">,</span>
        hwc2_callback_data_t callbackData<span class="token punctuation">,</span> hwc2_function_pointer_t pointer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValid</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Error<span class="token operator">::</span>BadParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>recursive_timed_mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mStateMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pointer <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mCallbacks<span class="token punctuation">[</span>descriptor<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>callbackData<span class="token punctuation">,</span> pointer<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"unregisterCallback(%s)"</span><span class="token punctuation">,</span> <span class="token function">to_string</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCallbacks<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Error<span class="token operator">::</span>None<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> hasPendingInvalidate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>hwc2_display_t<span class="token operator">></span> displayIds<span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>pair<span class="token operator">&lt;</span>hwc2_display_t<span class="token punctuation">,</span> int64_t<span class="token operator">>></span> pendingVsyncs<span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>pair<span class="token operator">&lt;</span>hwc2_display_t<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">>></span> pendingHotplugs<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor <span class="token operator">==</span> Callback<span class="token operator">::</span>Refresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasPendingInvalidate <span class="token operator">=</span> mHasPendingInvalidate<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasPendingInvalidate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> displayPair <span class="token operator">:</span> mDisplays<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                displayIds<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>displayPair<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mHasPendingInvalidate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor <span class="token operator">==</span> Callback<span class="token operator">::</span>Vsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> pending <span class="token operator">:</span> mPendingVsyncs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> hwc1DisplayId <span class="token operator">=</span> pending<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mHwc1DisplayMap<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>hwc1DisplayId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"hwc1Vsync: Couldn't find display for HWC1 id %d"</span><span class="token punctuation">,</span>
                        hwc1DisplayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">auto</span> displayId <span class="token operator">=</span> mHwc1DisplayMap<span class="token punctuation">[</span>hwc1DisplayId<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> timestamp <span class="token operator">=</span> pending<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
            pendingVsyncs<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mPendingVsyncs<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor <span class="token operator">==</span> Callback<span class="token operator">::</span>Hotplug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Hotplug the primary display</span>
        pendingHotplugs<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>mHwc1DisplayMap<span class="token punctuation">[</span>HWC_DISPLAY_PRIMARY<span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>int32_t<span class="token operator">></span><span class="token punctuation">(</span>Connection<span class="token operator">::</span>Connected<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> pending <span class="token operator">:</span> mPendingHotplugs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> hwc1DisplayId <span class="token operator">=</span> pending<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mHwc1DisplayMap<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>hwc1DisplayId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"hwc1Hotplug: Couldn't find display for HWC1 id %d"</span><span class="token punctuation">,</span>
                        hwc1DisplayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">auto</span> displayId <span class="token operator">=</span> mHwc1DisplayMap<span class="token punctuation">[</span>hwc1DisplayId<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> connected <span class="token operator">=</span> pending<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
            pendingHotplugs<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span> connected<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Call pending callbacks without the state lock held</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasPendingInvalidate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> refresh <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>HWC2_PFN_REFRESH<span class="token operator">></span><span class="token punctuation">(</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> displayId <span class="token operator">:</span> displayIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">refresh</span><span class="token punctuation">(</span>callbackData<span class="token punctuation">,</span> displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pendingVsyncs<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> vsync <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>HWC2_PFN_VSYNC<span class="token operator">></span><span class="token punctuation">(</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> pendingVsync <span class="token operator">:</span> pendingVsyncs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">vsync</span><span class="token punctuation">(</span>callbackData<span class="token punctuation">,</span> pendingVsync<span class="token punctuation">.</span>first<span class="token punctuation">,</span> pendingVsync<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pendingHotplugs<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> hotplug <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>HWC2_PFN_HOTPLUG<span class="token operator">></span><span class="token punctuation">(</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> pendingHotplug <span class="token operator">:</span> pendingHotplugs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hotplug</span><span class="token punctuation">(</span>callbackData<span class="token punctuation">,</span> pendingHotplug<span class="token punctuation">.</span>first<span class="token punctuation">,</span> pendingHotplug<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Error<span class="token operator">::</span>None<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到有2个集合，一个标志位在Hal判断是否需要回调当顶层。当mPendingHotplugs存在还没有被通知的屏幕热插拔消息的时候将会调用hotplug；当mPendingVsyncs存在还没有通知到的屏幕的同步也会调用vsync；如果需要刷新则会有hasPendingInvalidate设置true的标志。</p>
<p>但是，如果是SF第一次进来就肯定不会有回调，因为此时还没有任何的拿到底层的任何数据。但是会把当前的监听类型和回调的方法指针都保存到mCallbacks数组中。</p>
<p>此时就会直接转型为每一个回调到上层，此时就是HwcHalImpl中的refreshHook，hotplugHook，vsyncHook。</p>
<h4 id="HwcHalImpl-refreshHook"><a href="#HwcHalImpl-refreshHook" class="headerlink" title="HwcHalImpl refreshHook"></a>HwcHalImpl refreshHook</h4><pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">refreshHook</span><span class="token punctuation">(</span>hwc2_callback_data_t callbackData<span class="token punctuation">,</span> hwc2_display_t display<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> hal <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>HwcHalImpl<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>callbackData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        hal<span class="token operator">-</span><span class="token operator">></span>mMustValidateDisplay <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        hal<span class="token operator">-</span><span class="token operator">></span>mEventCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onRefresh</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时就会回调到IComposerClient的HalEventCallback。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/" target="_blank" rel="noopener">hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/" target="_blank" rel="noopener">composer-hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/ComposerClient.h" target="_blank" rel="noopener">ComposerClient.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">        <span class="token keyword">void</span> <span class="token function">onRefresh</span><span class="token punctuation">(</span>Display display<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> ret <span class="token operator">=</span> mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onRefresh</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这个Callback就是上层的ComposerCallbackBridge<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/" target="_blank" rel="noopener">DisplayHardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/HWC2.cpp" target="_blank" rel="noopener">HWC2.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    Return<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">onRefresh</span><span class="token punctuation">(</span>Hwc2<span class="token operator">::</span>Display display<span class="token punctuation">)</span> override
    <span class="token punctuation">{</span>
        mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onRefreshReceived</span><span class="token punctuation">(</span>mSequenceId<span class="token punctuation">,</span> display<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而这个Callback就是SF。此时就会走到SF的页面刷新</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">onRefreshReceived</span><span class="token punctuation">(</span><span class="token keyword">int</span> sequenceId<span class="token punctuation">,</span>
                                       hwc2_display_t <span class="token comment" spellcheck="true">/*display*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mStateLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sequenceId <span class="token operator">!=</span> <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mComposerSequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">repaintEverything</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>repaintEverything这个方法将会更新所有Layer中的图元。具体是什么意思，在之后的文章将会和大家聊聊</p>
<h5 id="HwcHalImpl-vsyncHook"><a href="#HwcHalImpl-vsyncHook" class="headerlink" title="HwcHalImpl vsyncHook"></a>HwcHalImpl vsyncHook</h5><pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">vsyncHook</span><span class="token punctuation">(</span>hwc2_callback_data_t callbackData<span class="token punctuation">,</span> hwc2_display_t display<span class="token punctuation">,</span>
                          int64_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> hal <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>HwcHalImpl<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>callbackData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        hal<span class="token operator">-</span><span class="token operator">></span>mEventCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onVsync</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="HalEventCallback-onVsync"><a href="#HalEventCallback-onVsync" class="headerlink" title="HalEventCallback onVsync"></a>HalEventCallback onVsync</h5><pre class="line-numbers language-cpp"><code class="language-cpp">        <span class="token keyword">void</span> <span class="token function">onVsync</span><span class="token punctuation">(</span>Display display<span class="token punctuation">,</span> int64_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> ret <span class="token operator">=</span> mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onVsync</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="ComposerCallbackBridge-onVsync"><a href="#ComposerCallbackBridge-onVsync" class="headerlink" title="ComposerCallbackBridge onVsync"></a>ComposerCallbackBridge onVsync</h5><pre class="line-numbers language-cpp"><code class="language-cpp">    Return<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">onVsync</span><span class="token punctuation">(</span>Hwc2<span class="token operator">::</span>Display display<span class="token punctuation">,</span> int64_t timestamp<span class="token punctuation">)</span> override
    <span class="token punctuation">{</span>
        mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onVsyncReceived</span><span class="token punctuation">(</span>mSequenceId<span class="token punctuation">,</span> display<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后就会走到SF中的回调</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">onVsyncReceived</span><span class="token punctuation">(</span>int32_t sequenceId<span class="token punctuation">,</span>
        hwc2_display_t displayId<span class="token punctuation">,</span> int64_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mStateLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Ignore any vsyncs from a previous hardware composer.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sequenceId <span class="token operator">!=</span> <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mComposerSequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    int32_t type<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token operator">-</span><span class="token operator">></span><span class="token function">onVsync</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> needsHwVsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Scope for the lock</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mHWVsyncLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> DisplayDevice<span class="token operator">::</span>DISPLAY_PRIMARY <span class="token operator">&amp;&amp;</span> mPrimaryHWVsyncEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            needsHwVsync <span class="token operator">=</span> mPrimaryDispSync<span class="token punctuation">.</span><span class="token function">addResyncSample</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>needsHwVsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enableHardwareVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">disableHardwareVsync</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个回调中，会从硬件传来一个时间戳，对整个Vsync进行一次调整。究竟是怎么一个逻辑，我将放在后面的文章来聊。</p>
<p>本文最重要将会关注屏幕热插拔的回调。</p>
<h4 id="HwcHalImpl-hotplugHook"><a href="#HwcHalImpl-hotplugHook" class="headerlink" title="HwcHalImpl hotplugHook"></a>HwcHalImpl hotplugHook</h4><pre><code>    static void hotplugHook(hwc2_callback_data_t callbackData, hwc2_display_t display,
                            int32_t connected) {
        auto hal = static_cast&lt;HwcHalImpl*&gt;(callbackData);
        hal-&gt;mEventCallback-&gt;onHotplug(display,
                                       static_cast&lt;IComposerCallback::Connection&gt;(connected));
    }</code></pre><h4 id="HalEventCallback-hotplugHook"><a href="#HalEventCallback-hotplugHook" class="headerlink" title="HalEventCallback hotplugHook"></a>HalEventCallback hotplugHook</h4><pre class="line-numbers language-cpp"><code class="language-cpp">
        <span class="token keyword">void</span> <span class="token function">onHotplug</span><span class="token punctuation">(</span>Display display<span class="token punctuation">,</span> IComposerCallback<span class="token operator">::</span>Connection connected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connected <span class="token operator">==</span> IComposerCallback<span class="token operator">::</span>Connection<span class="token operator">::</span>CONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mResources<span class="token operator">-</span><span class="token operator">></span><span class="token function">addPhysicalDisplay</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>connected <span class="token operator">==</span> IComposerCallback<span class="token operator">::</span>Connection<span class="token operator">::</span>DISCONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mResources<span class="token operator">-</span><span class="token operator">></span><span class="token function">removeDisplay</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">auto</span> ret <span class="token operator">=</span> mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onHotplug</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> connected<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ALOGE_IF</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"failed to send onHotplug: %s"</span><span class="token punctuation">,</span> ret<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个过程中就不是简单的回调，而是把回调上来的hwc2_display_t对象添加到ComposerResources中。</p>
<h4 id="ComposerResources-添加Display管理"><a href="#ComposerResources-添加Display管理" class="headerlink" title="ComposerResources 添加Display管理"></a>ComposerResources 添加Display管理</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/" target="_blank" rel="noopener">composer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/" target="_blank" rel="noopener">hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/" target="_blank" rel="noopener">composer-hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/" target="_blank" rel="noopener">2.1</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/composer/2.1/utils/hal/include/composer-hal/2.1/ComposerResources.h" target="_blank" rel="noopener">ComposerResources.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    Error <span class="token function">addPhysicalDisplay</span><span class="token punctuation">(</span>Display display<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> displayResource <span class="token operator">=</span>
            <span class="token function">createDisplayResource</span><span class="token punctuation">(</span>ComposerDisplayResource<span class="token operator">::</span>DisplayType<span class="token operator">::</span>PHYSICAL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token operator">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mDisplayResourcesMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> result <span class="token operator">=</span> mDisplayResources<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>displayResource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span>second <span class="token operator">?</span> Error<span class="token operator">::</span>NONE <span class="token operator">:</span> Error<span class="token operator">::</span>BAD_DISPLAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">virtual</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>ComposerDisplayResource<span class="token operator">></span> <span class="token function">createDisplayResource</span><span class="token punctuation">(</span>
        ComposerDisplayResource<span class="token operator">::</span>DisplayType type<span class="token punctuation">,</span> uint32_t outputBufferCacheSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>ComposerDisplayResource<span class="token operator">></span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> mImporter<span class="token punctuation">,</span> outputBufferCacheSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中，Composer会把每一个hwc2_display_t最终封装成一个个ComposerDisplayResource，加入到集合当中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">ComposerDisplayResource</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">DisplayType</span> <span class="token punctuation">{</span>
        PHYSICAL<span class="token punctuation">,</span>
        VIRTUAL<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">ComposerDisplayResource</span><span class="token punctuation">(</span>DisplayType type<span class="token punctuation">,</span> ComposerHandleImporter<span class="token operator">&amp;</span> importer<span class="token punctuation">,</span>
                            uint32_t outputBufferCacheSize<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">mType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">mClientTargetCache</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">mOutputBufferCache</span><span class="token punctuation">(</span>importer<span class="token punctuation">,</span> ComposerHandleCache<span class="token operator">::</span>HandleType<span class="token operator">::</span>BUFFER<span class="token punctuation">,</span>
                             outputBufferCacheSize<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，此时就是把ComposerResources中的图元申请服务交给ComposerDisplayResource持有，让Display自己拥有控制图元的能力，同时初始化缓存为0.</p>
<p>当缓存好ComposerDisplayResource之后就会继续回调，到顶层</p>
<h4 id="ComposerCallbackBridge-onHotplug"><a href="#ComposerCallbackBridge-onHotplug" class="headerlink" title="ComposerCallbackBridge onHotplug"></a>ComposerCallbackBridge onHotplug</h4><pre><code>    Return&lt;void&gt; onHotplug(Hwc2::Display display,
                           IComposerCallback::Connection conn) override
    {
        HWC2::Connection connection = static_cast&lt;HWC2::Connection&gt;(conn);
        mCallback-&gt;onHotplugReceived(mSequenceId, display, connection);
        return Void();
    }</code></pre><p>此时终于来到了上一篇文章中解析的SF层中屏幕的初始化流程中。</p>
<h4 id="注意小结"><a href="#注意小结" class="headerlink" title="注意小结"></a>注意小结</h4><p>了解了整个回调机制之后，我们能够发现其实registerCallback在Hwc1OnAdapter(也是hwc2_device_t)中做的事情仅仅只是把当前的方法指针和回调类型存储起来，同时让刚注册进来的监听消费掉还没有回调上去的消息。</p>
<p>到这里，整个逻辑链路似乎就断开了。我曾经看源码也苦恼了很久，发现其实真正从硬件回调上来的地方其实是Hwc1OnAdapter::Callback中的回调。他是在hwc_device_t的registerProcs的时候注册进去的。</p>
<p>接下来让我们探索一下他的原理。</p>
<h4 id="hwc-device-t的registerProcs"><a href="#hwc-device-t的registerProcs" class="headerlink" title="hwc_device_t的registerProcs"></a>hwc_device_t的registerProcs</h4><p>调用如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    mHwc1Device<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerProcs</span><span class="token punctuation">(</span>mHwc1Device<span class="token punctuation">,</span>
            <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> hwc_procs_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>mHwc1Callbacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/" target="_blank" rel="noopener">libhwcomposer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/hwc.cpp" target="_blank" rel="noopener">hwc.cpp</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hwc_registerProcs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1<span class="token operator">*</span> dev<span class="token punctuation">,</span>
                              hwc_procs_t <span class="token keyword">const</span><span class="token operator">*</span> procs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    hwc_context_t<span class="token operator">*</span> ctx <span class="token operator">=</span> <span class="token punctuation">(</span>hwc_context_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ctx<span class="token operator">-></span>proc <span class="token operator">=</span> procs<span class="token punctuation">;</span>

    <span class="token function">init_uevent_thread</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">init_vsync_thread</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>又一次见到这种设计把hwc_composer_device_1转型成hwc_context_t.</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> hwc_context_t <span class="token punctuation">{</span>
    hwc_composer_device_1_t device<span class="token punctuation">;</span>
    <span class="token keyword">const</span> hwc_procs_t<span class="token operator">*</span> proc<span class="token punctuation">;</span>

    qhwc<span class="token operator">::</span>CopyBit <span class="token operator">*</span>mCopyBit<span class="token punctuation">[</span>MAX_DISPLAYS<span class="token punctuation">]</span><span class="token punctuation">;</span>

    overlay<span class="token operator">::</span>Overlay <span class="token operator">*</span>mOverlay<span class="token punctuation">;</span>
    overlay<span class="token operator">::</span>RotMgr <span class="token operator">*</span>mRotMgr<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//Primary and external FB updater</span>
    qhwc<span class="token operator">::</span>IFBUpdate <span class="token operator">*</span>mFBUpdate<span class="token punctuation">[</span>MAX_DISPLAYS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// External display related information</span>
    qhwc<span class="token operator">::</span>ExternalDisplay <span class="token operator">*</span>mExtDisplay<span class="token punctuation">;</span>
    qhwc<span class="token operator">::</span>MDPInfo mMDP<span class="token punctuation">;</span>
    qhwc<span class="token operator">::</span>VsyncState vstate<span class="token punctuation">;</span>
    qhwc<span class="token operator">::</span>DisplayAttributes dpyAttr<span class="token punctuation">[</span>MAX_DISPLAYS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    qhwc<span class="token operator">::</span>ListStats listStats<span class="token punctuation">[</span>MAX_DISPLAYS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    qhwc<span class="token operator">::</span>LayerProp <span class="token operator">*</span>layerProp<span class="token punctuation">[</span>MAX_DISPLAYS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    qhwc<span class="token operator">::</span>LayerRotMap <span class="token operator">*</span>mLayerRotMap<span class="token punctuation">[</span>MAX_DISPLAYS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    qhwc<span class="token operator">::</span>MDPComp <span class="token operator">*</span>mMDPComp<span class="token punctuation">[</span>MAX_DISPLAYS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    qhwc<span class="token operator">::</span>CablProp mCablProp<span class="token punctuation">;</span>
    overlay<span class="token operator">::</span>utils<span class="token operator">::</span>Whf mPrevWHF<span class="token punctuation">[</span>MAX_DISPLAYS<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//Securing in progress indicator</span>
    <span class="token keyword">bool</span> mSecuring<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//External Display configuring progress indicator</span>
    <span class="token keyword">bool</span> mExtDispConfiguring<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//Display in secure mode indicator</span>
    <span class="token keyword">bool</span> mSecureMode<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//Lock to prevent set from being called while blanking</span>
    <span class="token keyword">mutable</span> Locker mBlankLock<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//Lock to protect set when detaching external disp</span>
    <span class="token keyword">mutable</span> Locker mExtSetLock<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//DMA used for rotator</span>
    <span class="token keyword">bool</span> mDMAInUse<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//MDP rotater needed</span>
    <span class="token keyword">bool</span> mNeedsRotator<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//Check if base pipe is set up</span>
    <span class="token keyword">bool</span> mBasePipeSetup<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//Flags the transition of a video session</span>
    <span class="token keyword">bool</span> mVideoTransFlag<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个方法初始化了2个线程，一个是vsync同步信号线程，一个是uevent的事件信号线程。还会把当前的hwc_procs_t这个回调结构体存储起来。</p>
<h4 id="hwc-初始化事件线程"><a href="#hwc-初始化事件线程" class="headerlink" title="hwc 初始化事件线程"></a>hwc 初始化事件线程</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/" target="_blank" rel="noopener">libhwcomposer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/hwc_uevents.cpp" target="_blank" rel="noopener">hwc_uevents.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">uevent_loop</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>param<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">char</span> udata<span class="token punctuation">[</span>PAGE_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    hwc_context_t <span class="token operator">*</span> ctx <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>hwc_context_t <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> thread_name<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span> <span class="token operator">=</span> HWC_UEVENT_THREAD_NAME<span class="token punctuation">;</span>
    <span class="token function">prctl</span><span class="token punctuation">(</span>PR_SET_NAME<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>thread_name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setpriority</span><span class="token punctuation">(</span>PRIO_PROCESS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> HAL_PRIORITY_URGENT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uevent_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        len <span class="token operator">=</span> <span class="token function">uevent_next_event</span><span class="token punctuation">(</span>udata<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>udata<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">handle_uevent</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> udata<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">init_uevent_thread</span><span class="token punctuation">(</span>hwc_context_t<span class="token operator">*</span> ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    pthread_t uevent_thread<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Initializing UEVENT Thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uevent_thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> uevent_loop<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"%s: failed to create %s: %s"</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span>
            HWC_UEVENT_THREAD_NAME<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到该方法其实就是实例化一个最高优先级的pthread线程，经过一个uevent_init初始化后进入了uevent_loop的循环。关键能看到下面这个死循环：</p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        len <span class="token operator">=</span> <span class="token function">uevent_next_event</span><span class="token punctuation">(</span>udata<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>udata<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">handle_uevent</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> udata<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>uevent_next_event不断的获取下一个需要处理事件，handle_uevent进行处理。</p>
<h4 id="uevent-init"><a href="#uevent-init" class="headerlink" title="uevent_init"></a>uevent_init</h4><p>文件： /<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/libhardware_legacy/" target="_blank" rel="noopener">libhardware_legacy</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/libhardware_legacy/uevent.c" target="_blank" rel="noopener">uevent.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">uevent_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sockaddr_nl addr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token number">64</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addr<span class="token punctuation">.</span>nl_family <span class="token operator">=</span> AF_NETLINK<span class="token punctuation">;</span>
    addr<span class="token punctuation">.</span>nl_pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addr<span class="token punctuation">.</span>nl_groups <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>

    s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_NETLINK<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> NETLINK_KOBJECT_UEVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>s <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">setsockopt</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVBUFFORCE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sz<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fd <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>fd <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在msm8994中event的初始化其实就是一个socket服务端。这个socket设置协议族为SOCK_DGRAM也就是面向数据包的协议。同时设置了该socket是接收端，还设置了bind绑定了地址，并且回调了socket中的fd。</p>
<h4 id="uevent-next-event-获取需要处理的事件"><a href="#uevent-next-event-获取需要处理的事件" class="headerlink" title="uevent_next_event 获取需要处理的事件"></a>uevent_next_event 获取需要处理的事件</h4><p>文件： /<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/libhardware_legacy/" target="_blank" rel="noopener">libhardware_legacy</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/libhardware_legacy/uevent.c" target="_blank" rel="noopener">uevent.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">uevent_next_event</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> buffer_length<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> pollfd fds<span class="token punctuation">;</span>
        <span class="token keyword">int</span> nr<span class="token punctuation">;</span>

        fds<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
        fds<span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>
        fds<span class="token punctuation">.</span>revents <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        nr <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fds<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>nr <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fds<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> buffer_length<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> uevent_handler <span class="token operator">*</span>h<span class="token punctuation">;</span>
                <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uevent_handler_list_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LIST_FOREACH</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uevent_handler_list<span class="token punctuation">,</span> list<span class="token punctuation">)</span>
                    h<span class="token operator">-</span><span class="token operator">></span><span class="token function">handler</span><span class="token punctuation">(</span>h<span class="token operator">-</span><span class="token operator">></span>handler_data<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> buffer_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uevent_handler_list_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> count<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// won't get here</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其核心方法就是调用了poll系统调用，监听socket文件描述符中数据流的变化。一旦nr大于0，说明又说来了，就调用recv从socket中读取数据，回去遍历查找已经通过uevent_add_native_handler添加进来的回调，并返回发生变化的数量。</p>
<p>然而这里面并没有通过uevent_add_native_handler进来一个回调。而是直接交给下一个函数处理。</p>
<h4 id="handle-uevent"><a href="#handle-uevent" class="headerlink" title="handle_uevent"></a>handle_uevent</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/" target="_blank" rel="noopener">libhwcomposer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/hwc_uevents.cpp" target="_blank" rel="noopener">hwc_uevents.cpp</a></p>
<p>此时用过uevent_next_event已经把数据拷贝到uevent_data中,就开始解析数据</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">enum</span> <span class="token punctuation">{</span>
    EXTERNAL_OFFLINE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    EXTERNAL_ONLINE<span class="token punctuation">,</span>
    EXTERNAL_PAUSE<span class="token punctuation">,</span>
    EXTERNAL_RESUME
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handle_uevent</span><span class="token punctuation">(</span>hwc_context_t<span class="token operator">*</span> ctx<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> udata<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> udata<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> usecopybit <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> compositionType <span class="token operator">=</span>
        qdutils<span class="token operator">::</span>QCCompositionType<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCompositionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>compositionType <span class="token operator">&amp;</span> <span class="token punctuation">(</span>qdutils<span class="token operator">::</span>COMPOSITION_TYPE_DYN <span class="token operator">|</span>
                           qdutils<span class="token operator">::</span>COMPOSITION_TYPE_MDP <span class="token operator">|</span>
                           qdutils<span class="token operator">::</span>COMPOSITION_TYPE_C2D<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        usecopybit <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcasestr</span><span class="token punctuation">(</span><span class="token string">"change@/devices/virtual/switch/hdmi"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
       <span class="token operator">!</span><span class="token function">strcasestr</span><span class="token punctuation">(</span><span class="token string">"change@/devices/virtual/switch/wfd"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> connected <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// initial value - will be set to  1/0 based on hotplug</span>
    <span class="token keyword">int</span> extDpyNum <span class="token operator">=</span> HWC_DISPLAY_EXTERNAL<span class="token punctuation">;</span>
    <span class="token keyword">char</span> property<span class="token punctuation">[</span>PROPERTY_VALUE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"persist.sys.wfd.virtual"</span><span class="token punctuation">,</span> property<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> PROPERTY_VALUE_MAX <span class="token punctuation">)</span> <span class="token operator">||</span>
             <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span><span class="token string">"true"</span><span class="token punctuation">,</span> PROPERTY_VALUE_MAX <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// This means we are using Google API to trigger WFD Display</span>
        extDpyNum <span class="token operator">=</span> HWC_DISPLAY_VIRTUAL<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> dpy <span class="token operator">=</span> <span class="token function">isHDMI</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">?</span> HWC_DISPLAY_EXTERNAL <span class="token operator">:</span> extDpyNum<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// update extDpyNum</span>
    ctx<span class="token operator">-</span><span class="token operator">></span>mExtDisplay<span class="token operator">-</span><span class="token operator">></span><span class="token function">setExtDpyNum</span><span class="token punctuation">(</span>dpy<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"SWITCH_STATE="</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"SWITCH_STATE="</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            connected <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>str <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"SWITCH_STATE="</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//Disabled until SF calls unblank</span>
            ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>HWC_DISPLAY_EXTERNAL<span class="token punctuation">]</span><span class="token punctuation">.</span>isActive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//Ignored for Virtual Displays</span>
            <span class="token comment" spellcheck="true">//ToDo: we can do this in a much better way</span>
            ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>HWC_DISPLAY_VIRTUAL<span class="token punctuation">]</span><span class="token punctuation">.</span>isActive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        str <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">-</span> udata <span class="token operator">>=</span> len<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span><span class="token punctuation">(</span>connected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> EXTERNAL_OFFLINE<span class="token operator">:</span>
            <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// disconnect event</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>mExtDisplay<span class="token operator">-</span><span class="token operator">></span><span class="token function">processUEventOffline</span><span class="token punctuation">(</span>udata<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>mFBUpdate<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Locker<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>mExtSetLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">delete</span> ctx<span class="token operator">-</span><span class="token operator">></span>mFBUpdate<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    ctx<span class="token operator">-</span><span class="token operator">></span>mFBUpdate<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>mCopyBit<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    Locker<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>mExtSetLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">delete</span> ctx<span class="token operator">-</span><span class="token operator">></span>mCopyBit<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    ctx<span class="token operator">-</span><span class="token operator">></span>mCopyBit<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>mMDPComp<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">delete</span> ctx<span class="token operator">-</span><span class="token operator">></span>mMDPComp<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    ctx<span class="token operator">-</span><span class="token operator">></span>mMDPComp<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">.</span>connected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                Locker<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>mExtSetLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//hwc comp could be on</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>proc<span class="token operator">-</span><span class="token operator">></span><span class="token function">hotplug</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>proc<span class="token punctuation">,</span> dpy<span class="token punctuation">,</span> connected<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">case</span> EXTERNAL_ONLINE<span class="token operator">:</span>
            <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// connect case</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>mExtDispConfiguring <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>mExtDisplay<span class="token operator">-</span><span class="token operator">></span><span class="token function">processUEventOnline</span><span class="token punctuation">(</span>udata<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>mFBUpdate<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span> <span class="token operator">=</span>
                        IFBUpdate<span class="token operator">::</span><span class="token function">getObject</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">.</span>xres<span class="token punctuation">,</span> dpy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">.</span>isPause <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>usecopybit<span class="token punctuation">)</span>
                    ctx<span class="token operator">-</span><span class="token operator">></span>mCopyBit<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CopyBit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>mMDPComp<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span> <span class="token operator">=</span>  MDPComp<span class="token operator">::</span><span class="token function">getObject</span><span class="token punctuation">(</span>
                        ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">.</span>xres<span class="token punctuation">,</span> dpy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">.</span>connected <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                Locker<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>mExtSetLock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//hwc comp could be on</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>proc<span class="token operator">-</span><span class="token operator">></span><span class="token function">hotplug</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>proc<span class="token punctuation">,</span> dpy<span class="token punctuation">,</span> connected<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">case</span> EXTERNAL_PAUSE<span class="token operator">:</span>
            <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// pause case</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>mExtDispConfiguring <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">.</span>isActive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">.</span>isPause <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">case</span> EXTERNAL_RESUME<span class="token operator">:</span>
            <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// resume case</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">.</span>isActive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">.</span>isPause <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实这里表达的观点很简单，首先它只解析以”change@/devices/virtual/switch/hdmi”或者”change@/devices/virtual/switch/wfd”开头的消息。这种消息的格式如下：</p>
<pre><code>change@/devices/virtual/switch/hdmi ACTION=change
SWITCH_STATE=0</code></pre><p>需要判断的类型就是SWITCH_STATE对应的字符的int是什么进行响应的处理。有4个状态：</p>
<ul>
<li>1.EXTERNAL_OFFLINE 0</li>
<li>2.EXTERNAL_ONLINE 1</li>
<li>3.EXTERNAL_PAUSE 2</li>
<li>4.EXTERNAL_RESUME 3</li>
</ul>
<p>同时dpy代表屏幕类型，如果是change@/devices/virtual/switch/hdmi消息来了，说明是物理屏幕HWC_DISPLAY_EXTERNAL</p>
<blockquote>
<p>当为EXTERNAL_OFFLINE 的时候就代表屏幕被关闭或者拔出。先调用 qhwc::ExternalDisplay-&gt;processUEventOffline，销毁保存在数组中数据，并让dpyAttr对应的id变成false，最后调用hotPlugin回调</p>
</blockquote>
<blockquote>
<p>EXTERNAL_ONLINE 代表屏幕联通了。先调用ExternalDisplay的processUEventOnline，申请资源，最后调用hotPlugin回调</p>
</blockquote>
<blockquote>
<p>EXTERNAL_PAUSE 屏幕冻结了，设置dpyAttr标志位</p>
</blockquote>
<blockquote>
<p>EXTERNAL_RESUME 屏幕恢复了，设置dpyAttr标志位</p>
</blockquote>
<p>暂时理解这么多即可。</p>
<h4 id="vysnc线程初始化"><a href="#vysnc线程初始化" class="headerlink" title="vysnc线程初始化"></a>vysnc线程初始化</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/" target="_blank" rel="noopener">libhwcomposer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/hwc_vsync.cpp" target="_blank" rel="noopener">hwc_vsync.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">init_vsync_thread</span><span class="token punctuation">(</span>hwc_context_t<span class="token operator">*</span> ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    pthread_t vsync_thread<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vsync_thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> vsync_loop<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">vsync_loop</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>param<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> vsync_timestamp_fb0 <span class="token operator">=</span> <span class="token string">"/sys/class/graphics/fb0/vsync_event"</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> vsync_timestamp_fb1 <span class="token operator">=</span> <span class="token string">"/sys/class/graphics/fb1/vsync_event"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> dpy <span class="token operator">=</span> HWC_DISPLAY_PRIMARY<span class="token punctuation">;</span>

    hwc_context_t <span class="token operator">*</span> ctx <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>hwc_context_t <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> thread_name<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span> <span class="token operator">=</span> HWC_VSYNC_THREAD_NAME<span class="token punctuation">;</span>
    <span class="token function">prctl</span><span class="token punctuation">(</span>PR_SET_NAME<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>thread_name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setpriority</span><span class="token punctuation">(</span>PRIO_PROCESS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> HAL_PRIORITY_URGENT_DISPLAY <span class="token operator">+</span>
                android<span class="token operator">::</span>PRIORITY_MORE_FAVORABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> MAX_DATA <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">char</span> vdata<span class="token punctuation">[</span>MAX_DATA<span class="token punctuation">]</span><span class="token punctuation">;</span>

    uint64_t cur_timestamp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    ssize_t len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd_timestamp <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> fb1_vsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> logvsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> property<span class="token punctuation">[</span>PROPERTY_VALUE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"debug.hwc.fakevsync"</span><span class="token punctuation">,</span> property<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
            ctx<span class="token operator">-</span><span class="token operator">></span>vstate<span class="token punctuation">.</span>fakevsync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"debug.hwc.logvsync"</span><span class="token punctuation">,</span> property<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
            logvsync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fd_timestamp <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>vsync_timestamp_fb0<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd_timestamp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        ctx<span class="token operator">-</span><span class="token operator">></span>vstate<span class="token punctuation">.</span>fakevsync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LIKELY</span><span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token operator">-</span><span class="token operator">></span>vstate<span class="token punctuation">.</span>fakevsync<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            len <span class="token operator">=</span> <span class="token function">pread</span><span class="token punctuation">(</span>fd_timestamp<span class="token punctuation">,</span> vdata<span class="token punctuation">,</span> MAX_DATA<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// extract timestamp</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> vdata<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"VSYNC="</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"VSYNC="</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cur_timestamp <span class="token operator">=</span> <span class="token function">strtoull</span><span class="token punctuation">(</span>str <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"VSYNC="</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">16666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cur_timestamp <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// send timestamp to HAL</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>vstate<span class="token punctuation">.</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token operator">-</span><span class="token operator">></span>proc<span class="token operator">-</span><span class="token operator">></span><span class="token function">vsync</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>proc<span class="token punctuation">,</span> dpy<span class="token punctuation">,</span> cur_timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd_timestamp <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">close</span> <span class="token punctuation">(</span>fd_timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其核心原理十分简单，也是进入到一个死循环。该循环会读取/sys/class/graphics/fb0/vsync_event下的驱动文件，如果失败说明没有硬件驱动，那就使用软件模拟，能看到这里面就会沉睡16.66毫秒。</p>
<p>如果成功则读取里面的数据,一般为如下格式：</p>
<blockquote>
<p>VSYNC=41800875994<br>获取后面的数值，最后把该时间顶层回调即可。</p>
</blockquote>
<p>本文对vysnc同步的信号的探索到这里，之后会结合整个SF聊聊它的原理。</p>
<h4 id="回调到HWC2On1Adapter-Callbacks"><a href="#回调到HWC2On1Adapter-Callbacks" class="headerlink" title="回调到HWC2On1Adapter::Callbacks"></a>回调到HWC2On1Adapter::Callbacks</h4><p>我们现在暂时只关注一个屏幕的热插拔逻辑。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hotplugHook</span><span class="token punctuation">(</span><span class="token keyword">const</span> hwc_procs_t<span class="token operator">*</span> procs<span class="token punctuation">,</span> <span class="token keyword">int</span> display<span class="token punctuation">,</span>
                <span class="token keyword">int</span> connected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> callbacks <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> Callbacks<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>procs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            callbacks<span class="token operator">-</span><span class="token operator">></span>mAdapter<span class="token punctuation">.</span><span class="token function">hwc1Hotplug</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> connected<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> HWC2On1Adapter<span class="token operator">::</span><span class="token function">hwc1Hotplug</span><span class="token punctuation">(</span><span class="token keyword">int</span> hwc1DisplayId<span class="token punctuation">,</span> <span class="token keyword">int</span> connected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"Received hwc1Hotplug(%d, %d)"</span><span class="token punctuation">,</span> hwc1DisplayId<span class="token punctuation">,</span> connected<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>hwc1DisplayId <span class="token operator">!=</span> HWC_DISPLAY_EXTERNAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>recursive_timed_mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mStateMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallbacks<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>Callback<span class="token operator">::</span>Hotplug<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPendingHotplugs<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>hwc1DisplayId<span class="token punctuation">,</span> connected<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    hwc2_display_t displayId <span class="token operator">=</span> UINT64_MAX<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mHwc1DisplayMap<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>hwc1DisplayId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connected <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"hwc1Hotplug: Received disconnect for unconnected display"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">auto</span> display <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>HWC2On1Adapter<span class="token operator">::</span>Display<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span>
                HWC2<span class="token operator">::</span>DisplayType<span class="token operator">::</span>Physical<span class="token punctuation">)</span><span class="token punctuation">;</span>
        display<span class="token operator">-</span><span class="token operator">></span><span class="token function">setHwc1Id</span><span class="token punctuation">(</span>HWC_DISPLAY_EXTERNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        display<span class="token operator">-</span><span class="token operator">></span><span class="token function">populateConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        displayId <span class="token operator">=</span> display<span class="token operator">-</span><span class="token operator">></span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHwc1DisplayMap<span class="token punctuation">[</span>HWC_DISPLAY_EXTERNAL<span class="token punctuation">]</span> <span class="token operator">=</span> displayId<span class="token punctuation">;</span>
        mDisplays<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connected <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"hwc1Hotplug: Received connect for previously connected "</span>
                    <span class="token string">"display"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        displayId <span class="token operator">=</span> mHwc1DisplayMap<span class="token punctuation">[</span>hwc1DisplayId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        mHwc1DisplayMap<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>HWC_DISPLAY_EXTERNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDisplays<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> callbackInfo <span class="token operator">=</span> mCallbacks<span class="token punctuation">[</span>Callback<span class="token operator">::</span>Hotplug<span class="token punctuation">]</span><span class="token punctuation">;</span>


    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> hotplug <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>HWC2_PFN_HOTPLUG<span class="token operator">></span><span class="token punctuation">(</span>callbackInfo<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> hwc2Connected <span class="token operator">=</span> <span class="token punctuation">(</span>connected <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span>
            HWC2<span class="token operator">::</span>Connection<span class="token operator">::</span>Disconnected <span class="token operator">:</span> HWC2<span class="token operator">::</span>Connection<span class="token operator">::</span>Connected<span class="token punctuation">;</span>
    <span class="token function">hotplug</span><span class="token punctuation">(</span>callbackInfo<span class="token punctuation">.</span>data<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>int32_t<span class="token operator">></span><span class="token punctuation">(</span>hwc2Connected<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果没有注册热插拔的监听，则会保存到mPendingHotplugs集合中，等待回调监听。</p>
<p>该回调只处理物理屏幕的逻辑。如果connect是0且mHwc1DisplayMap大于0说明有屏幕链接过，现在断开链接了，则从mHwc1DisplayMap中销毁对应id，销毁mDisplays对应的屏幕对象对象。</p>
<p>如果connect为1，说明有屏幕链接进来了。此时会生成一个HWC2On1Adapter::Display对象保存mDisplays。最后就是走上面registerCallback之上的逻辑了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>重新梳理一遍：</p>
<ul>
<li>Composer其实最重要的行为就是createClient，创建一个ComposerClient，ComposerClient此时真正的逻辑核心。</li>
<li>ComposerClient会持有HwcHalImpl，该类因为持有这hw2_device_t，所以拥有了和硬件通信的能力。ComposerResource中持有ComposerInputHandler这个对象负责图元服务的控制。ComposerCommandEngine则是处理一些来自上层的命令。</li>
<li>HWC2On1Adapter则是为了适配hw_device_t和版本2之间的区别，同时注册一个监听到驱动中。</li>
<li>对于回调来讲，分为两部分，当registerCallback的时候会消耗从底层回调上来。另一部分则是从底层直接拿到对应的HwcHalImpl的hook函数向上回调。</li>
</ul>
<p>原理如图：<br><img src="/images/ComposerCallback.png" alt="ComposerCallback.png"></p>
<p>了解Hal层的运作原理，为之后的逻辑打下基础。</p>
<p>最后再补上一副hal层对应的SF的数据结构：</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/01/25/android-chong-xue-xi-lie-xi-tong-qi-dong-dong-hua/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="Android 重学系列 系统启动动画">
                        
                        <span class="card-title">Android 重学系列 系统启动动画</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言经过上一篇文章的探索和学习，相信大家对Hal 层的运作原理以及SF如何监听Hal层返回的回调有一定的了解。
原本应该是聊如何申请图元的，但是感觉和前文的逻辑割裂有点大，还是继续按照SF初始化，开机的逻辑顺序继续走下去。这一次就让我们聊聊
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-01-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/01/19/android-chong-xue-xi-lie-surfaceflinger-de-chu-shi-hua/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="Android 重学系列 SurfaceFlinger 的初始化">
                        
                        <span class="card-title">Android 重学系列 SurfaceFlinger 的初始化</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言本片来看看SurfaceFlinger的初始化。从SurfaceFlinger的初始化，来对整个SurfaceFlinger的有一个总览。记住以下代码全部来自Android 9.0
遇到问题可以来本文下讨论:https://www.ji
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-01-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
