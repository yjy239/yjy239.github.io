<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 ion驱动源码浅析, Android | Linux | Flutter">
    <meta name="description" content="前言上一篇文章，在解析初始化GraphicBuffer中，遇到一个ion驱动，对图元进行管理。首先看看ion是怎么使用的：

1.打开驱动：mIonFd = open(ION_DEVICE, O_RDONLY);

2.ioctl 发送IO">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 ion驱动源码浅析 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/9.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 ion驱动源码浅析
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                SurfaceFlinger
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-01-31
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        8.8k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        42 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇文章，在解析初始化GraphicBuffer中，遇到一个ion驱动，对图元进行管理。首先看看ion是怎么使用的：</p>
<ul>
<li>1.打开驱动：<pre class="line-numbers language-cpp"><code class="language-cpp">mIonFd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>ION_DEVICE<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>2.ioctl 发送ION_IOC_ALLOC命令<pre class="line-numbers language-cpp"><code class="language-cpp">  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>mIonFd<span class="token punctuation">,</span> ION_IOC_ALLOC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ionAllocData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      err <span class="token operator">=</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
      <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"ION_IOC_ALLOC failed with error - %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>3.ioctl发送ION_IOC_MAP命令<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">ioctl</span><span class="token punctuation">(</span>mIonFd<span class="token punctuation">,</span> ION_IOC_MAP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>4.mmap 映射一段共享内存<pre class="line-numbers language-cpp"><code class="language-cpp">      base <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ionAllocData<span class="token punctuation">.</span>len<span class="token punctuation">,</span> PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span>
                  MAP_SHARED<span class="token punctuation">,</span> fd_data<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>5.ioctl ION_IOC_FREE 释放底层的句柄<pre class="line-numbers language-c"><code class="language-c">  <span class="token function">ioctl</span><span class="token punctuation">(</span>mIonFd<span class="token punctuation">,</span> ION_IOC_FREE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
我们按照这个流程分析ion的源码。</li>
</ul>
<p>如果对ion使用感兴趣，可以去这篇文章下面看<a href="https://blog.csdn.net/hexiaolong2009/article/details/102596744" target="_blank" rel="noopener">https://blog.csdn.net/hexiaolong2009/article/details/102596744</a></p>
<p>本文基于Android的Linux内核版本3.1.8</p>
<p>遇到什么问题欢迎来本文讨论<a href="https://www.jianshu.com/p/5fe57566691f" target="_blank" rel="noopener">https://www.jianshu.com/p/5fe57566691f</a></p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>什么是ion？如果是音视频，Camera的工程师会对这个驱动比较熟悉。最早的GPU和其他驱动协作申请一块内存进行绘制是使用比较粗暴的共享内存。在Android系统中使用的是匿名内存。最早由三星实现了一个Display和Camera共享内存的问题，曾经在Linux社区掀起过一段时间。之后各路大牛不断的改进之下，就成为了dma_buf驱动。并在 Linux-3.3 主线版本合入主线。现在已经广泛的运用到各大多媒体开发中。</p>
<p>首先介绍dma_buf的2个角色，importer和exporter。importer是dma_buf驱动中的图元消费者，exporter是dma_buf驱动中的图元生产者。</p>
<p>这里借用大佬的图片：<br><img src="/images/dma_buf.png" alt="dma_buf.png"></p>
<p>ion是基于dma_buf设计完成的。经过阅读源码，其实不少思路和Android的匿名内存有点相似。阅读本文之前就算不知道dma_buf的设计思想也没关系，我不会仔细到每一行，我会注重其在gralloc服务中的申请流程，看看ion是如何管理共享内存，为什么要抛弃ashmem。</p>
<h2 id="ion初始化"><a href="#ion初始化" class="headerlink" title="ion初始化"></a>ion初始化</h2><p>我们先来看看ion的file_operation:</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> file_operations ion_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>owner          <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open           <span class="token operator">=</span> ion_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release        <span class="token operator">=</span> ion_release<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> ion_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>compat_ioctl   <span class="token operator">=</span> compat_ion_ioctl<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>只有一个open和ioctl函数。但是没有mmap映射。因此mmap映射的时候一定其他对象在工作。</p>
<p>我们关注显卡英伟达的初始化模块。<br>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/tegra/" target="_blank" rel="noopener">tegra</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/tegra/tegra_ion.c" target="_blank" rel="noopener">tegra_ion.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> platform_driver ion_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> tegra_ion_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> tegra_ion_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"ion-tegra"</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">module_platform_driver</span><span class="token punctuation">(</span>ion_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>module_platform_driver实际上就是我之前经常提到过的module_init的一个宏,多了一个register注册到对应名字的平台中的步骤。在这里面注册了一个probe方法指针，probe指向的tegra_ion_probe是加载内核模块注册的时候调用。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> ion_device <span class="token operator">*</span>idev<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> num_heaps<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> ion_heap <span class="token operator">*</span><span class="token operator">*</span>heaps<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">tegra_ion_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> platform_device <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_platform_data <span class="token operator">*</span>pdata <span class="token operator">=</span> pdev<span class="token operator">-></span>dev<span class="token punctuation">.</span>platform_data<span class="token punctuation">;</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    num_heaps <span class="token operator">=</span> pdata<span class="token operator">-></span>nr<span class="token punctuation">;</span>

    heaps <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-></span>dev<span class="token punctuation">,</span>
                 <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_heap <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> pdata<span class="token operator">-></span>nr<span class="token punctuation">,</span>
                 GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    idev <span class="token operator">=</span> <span class="token function">ion_device_create</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR_OR_NULL</span><span class="token punctuation">(</span>idev<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>idev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* create the heaps as specified in the board file */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_heaps<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> ion_platform_heap <span class="token operator">*</span>heap_data <span class="token operator">=</span> <span class="token operator">&amp;</span>pdata<span class="token operator">-></span>heaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        heaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ion_heap_create</span><span class="token punctuation">(</span>heap_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR_OR_NULL</span><span class="token punctuation">(</span>heaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            err <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>heaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">ion_device_add_heap</span><span class="token punctuation">(</span>idev<span class="token punctuation">,</span> heaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">platform_set_drvdata</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> idev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
err<span class="token punctuation">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_heaps<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>heaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token function">ion_heap_destroy</span><span class="token punctuation">(</span>heaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先来看看对应的结构体：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> ion_platform_data <span class="token punctuation">{</span>
    <span class="token keyword">int</span> nr<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*有多少ion_platform_heap*/</span>
    <span class="token keyword">struct</span> ion_platform_heap <span class="token operator">*</span>heaps<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*ion_platform_heap 指针数组*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>再来看看对应ion内的堆结构体：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> ion_platform_heap <span class="token punctuation">{</span>
    <span class="token keyword">enum</span> ion_heap_type type<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*heap 类型*/</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    ion_phys_addr_t base<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*heap 起始地址*/</span>
    size_t size<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*heap 大小*/</span>
    ion_phys_addr_t align<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*heap需要对齐*/</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>priv<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>完成的事情如下几个步骤：</p>
<ul>
<li>1.ion_device_create 初始化注册ion驱动</li>
<li>2.ion_heap_create和ion_device_add_heap 初始化ion_platform_data中申请内存的堆，并添加到ion驱动中管理</li>
</ul>
<h3 id="ion-device-create-初始化注册ion驱动"><a href="#ion-device-create-初始化注册ion驱动" class="headerlink" title="ion_device_create 初始化注册ion驱动"></a>ion_device_create 初始化注册ion驱动</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> ion_device <span class="token operator">*</span><span class="token function">ion_device_create</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>custom_ioctl<span class="token punctuation">)</span>
                     <span class="token punctuation">(</span><span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client<span class="token punctuation">,</span>
                      <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span>
                      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_device <span class="token operator">*</span>idev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    idev <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_device<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span>

    idev<span class="token operator">-></span>dev<span class="token punctuation">.</span>minor <span class="token operator">=</span> MISC_DYNAMIC_MINOR<span class="token punctuation">;</span>
    idev<span class="token operator">-></span>dev<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"ion"</span><span class="token punctuation">;</span>
    idev<span class="token operator">-></span>dev<span class="token punctuation">.</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>ion_fops<span class="token punctuation">;</span>
    idev<span class="token operator">-></span>dev<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">misc_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idev<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    idev<span class="token operator">-></span>debug_root <span class="token operator">=</span> <span class="token function">debugfs_create_dir</span><span class="token punctuation">(</span><span class="token string">"ion"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>idev<span class="token operator">-></span>debug_root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">goto</span> debugfs_done<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

debugfs_done<span class="token punctuation">:</span>

    idev<span class="token operator">-></span>custom_ioctl <span class="token operator">=</span> custom_ioctl<span class="token punctuation">;</span>
    idev<span class="token operator">-></span>buffers <span class="token operator">=</span> RB_ROOT<span class="token punctuation">;</span>
    <span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idev<span class="token operator">-></span>buffer_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">init_rwsem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idev<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">plist_head_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idev<span class="token operator">-></span>heaps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    idev<span class="token operator">-></span>clients <span class="token operator">=</span> RB_ROOT<span class="token punctuation">;</span>
    <span class="token keyword">return</span> idev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们不关注debug模式。其实整个就是我们分析了很多次的方法。把这个对象注册miscdevice中。等到insmod就会把整个整个内核模块从dev_t的map中关联出来。</p>
<p>我们来看看这个驱动结构体：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> ion_device <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> miscdevice dev<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*驱动设备符*/</span>
    <span class="token keyword">struct</span> rb_root buffers<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*ion_buffer ion内核缓冲区 红黑树*/</span>
    <span class="token keyword">struct</span> mutex buffer_lock<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rw_semaphore lock<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> plist_head heaps<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*ion_buffer ion内核堆链表*/</span>
    <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>custom_ioctl<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span>
                 <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rb_root clients<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*每一个open进来的对象*/</span>
    <span class="token keyword">struct</span> dentry <span class="token operator">*</span>debug_root<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> dentry <span class="token operator">*</span>heaps_debug_root<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> dentry <span class="token operator">*</span>clients_debug_root<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ion-heap-create-创建ion内存申请堆"><a href="#ion-heap-create-创建ion内存申请堆" class="headerlink" title="ion_heap_create 创建ion内存申请堆"></a>ion_heap_create 创建ion内存申请堆</h3><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion_heap.c" target="_blank" rel="noopener">ion_heap.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> ion_heap <span class="token operator">*</span><span class="token function">ion_heap_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_platform_heap <span class="token operator">*</span>heap_data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>heap_data<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> ION_HEAP_TYPE_SYSTEM_CONTIG<span class="token punctuation">:</span>
        heap <span class="token operator">=</span> <span class="token function">ion_system_contig_heap_create</span><span class="token punctuation">(</span>heap_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ION_HEAP_TYPE_SYSTEM<span class="token punctuation">:</span>
        heap <span class="token operator">=</span> <span class="token function">ion_system_heap_create</span><span class="token punctuation">(</span>heap_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ION_HEAP_TYPE_CARVEOUT<span class="token punctuation">:</span>
        heap <span class="token operator">=</span> <span class="token function">ion_carveout_heap_create</span><span class="token punctuation">(</span>heap_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ION_HEAP_TYPE_CHUNK<span class="token punctuation">:</span>
        heap <span class="token operator">=</span> <span class="token function">ion_chunk_heap_create</span><span class="token punctuation">(</span>heap_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ION_HEAP_TYPE_DMA<span class="token punctuation">:</span>
        heap <span class="token operator">=</span> <span class="token function">ion_cma_heap_create</span><span class="token punctuation">(</span>heap_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    heap<span class="token operator">-></span>name <span class="token operator">=</span> heap_data<span class="token operator">-></span>name<span class="token punctuation">;</span>
    heap<span class="token operator">-></span>id <span class="token operator">=</span> heap_data<span class="token operator">-></span>id<span class="token punctuation">;</span>
    <span class="token keyword">return</span> heap<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里有四个不同堆会申请出来，我们主要来看看默认的ION_HEAP_TYPE_SYSTEM对应的heap流程。</p>
<h4 id="ion-system-heap-create"><a href="#ion-system-heap-create" class="headerlink" title="ion_system_heap_create"></a>ion_system_heap_create</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> orders<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> ion_heap_ops system_heap_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>allocate <span class="token operator">=</span> ion_system_heap_allocate<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>free <span class="token operator">=</span> ion_system_heap_free<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>map_dma <span class="token operator">=</span> ion_system_heap_map_dma<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unmap_dma <span class="token operator">=</span> ion_system_heap_unmap_dma<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>map_kernel <span class="token operator">=</span> ion_heap_map_kernel<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unmap_kernel <span class="token operator">=</span> ion_heap_unmap_kernel<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>map_user <span class="token operator">=</span> ion_heap_map_user<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>shrink <span class="token operator">=</span> ion_system_heap_shrink<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> ion_heap <span class="token operator">*</span><span class="token function">ion_system_heap_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_platform_heap <span class="token operator">*</span>unused<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_system_heap <span class="token operator">*</span>heap<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    heap <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_system_heap<span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> num_orders<span class="token punctuation">,</span>
            GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>heap<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    heap<span class="token operator">-</span><span class="token operator">></span>heap<span class="token punctuation">.</span>ops <span class="token operator">=</span> <span class="token operator">&amp;</span>system_heap_ops<span class="token punctuation">;</span>
    heap<span class="token operator">-</span><span class="token operator">></span>heap<span class="token punctuation">.</span>type <span class="token operator">=</span> ION_HEAP_TYPE_SYSTEM<span class="token punctuation">;</span>
    heap<span class="token operator">-</span><span class="token operator">></span>heap<span class="token punctuation">.</span>flags <span class="token operator">=</span> ION_HEAP_FLAG_DEFER_FREE<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_orders<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span>pool<span class="token punctuation">;</span>
        gfp_t gfp_flags <span class="token operator">=</span> low_order_gfp_flags<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>orders<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">4</span><span class="token punctuation">)</span>
            gfp_flags <span class="token operator">=</span> high_order_gfp_flags<span class="token punctuation">;</span>
        pool <span class="token operator">=</span> <span class="token function">ion_page_pool_create</span><span class="token punctuation">(</span>gfp_flags<span class="token punctuation">,</span> orders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pool<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> destroy_pools<span class="token punctuation">;</span>
        heap<span class="token operator">-</span><span class="token operator">></span>pools<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pool<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    heap<span class="token operator">-</span><span class="token operator">></span>heap<span class="token punctuation">.</span>debug_show <span class="token operator">=</span> ion_system_heap_debug_show<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>heap<span class="token operator">-</span><span class="token operator">></span>heap<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> ion_system_heap <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_heap heap<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span>pools<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实真正象征ion的内存堆是下面这个结构体</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> ion_heap <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> plist_node node<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_device <span class="token operator">*</span>dev<span class="token punctuation">;</span>
    <span class="token keyword">enum</span> ion_heap_type type<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*类型*/</span>
    <span class="token keyword">struct</span> ion_heap_ops <span class="token operator">*</span>ops<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*堆操作*/</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*此时是ION_HEAP_FLAG_DEFER_FREE*/</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> shrinker shrinker<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*回收资源方法*/</span>
    <span class="token keyword">struct</span> list_head free_list<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*空闲资源*/</span>
    size_t free_list_size<span class="token punctuation">;</span>
    spinlock_t free_lock<span class="token punctuation">;</span>
    wait_queue_head_t waitqueue<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> task_struct <span class="token operator">*</span>task<span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>debug_show<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap<span class="token punctuation">,</span> <span class="token keyword">struct</span> seq_file <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不管原来的那个heap，会新建3个ion_system_heap，分别order为8，4，0,大于4为大内存。意思就是这个heap中持有一个ion_page_pool 页资源池子，里面只有对应order的2的次幂，内存块。其实就和伙伴系统有点相似。</p>
<p>还会设置flag为ION_HEAP_FLAG_DEFER_FREE，这个标志位后面会用到。</p>
<h5 id="ion-page-pool-create-创建页资源池"><a href="#ion-page-pool-create-创建页资源池" class="headerlink" title="ion_page_pool_create 创建页资源池"></a>ion_page_pool_create 创建页资源池</h5><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion_page_pool.c" target="_blank" rel="noopener">ion_page_pool.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span><span class="token function">ion_page_pool_create</span><span class="token punctuation">(</span>gfp_t gfp_mask<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> order<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span>pool <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_page_pool<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pool<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    pool<span class="token operator">-</span><span class="token operator">></span>high_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    pool<span class="token operator">-</span><span class="token operator">></span>low_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-</span><span class="token operator">></span>low_items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-</span><span class="token operator">></span>high_items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pool<span class="token operator">-</span><span class="token operator">></span>gfp_mask <span class="token operator">=</span> gfp_mask <span class="token operator">|</span> __GFP_COMP<span class="token punctuation">;</span>
    pool<span class="token operator">-</span><span class="token operator">></span>order <span class="token operator">=</span> order<span class="token punctuation">;</span>
    <span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-</span><span class="token operator">></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">plist_node_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-</span><span class="token operator">></span>list<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pool<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> ion_page_pool <span class="token punctuation">{</span>
    <span class="token keyword">int</span> high_count<span class="token punctuation">;</span>
    <span class="token keyword">int</span> low_count<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> list_head high_items<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> list_head low_items<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> mutex mutex<span class="token punctuation">;</span>
    gfp_t gfp_mask<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> order<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> plist_node list<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在pool中分为2个链表一个是high_items，另一个是low_items。他们之间的区分在此时就是以2为底4的次幂为分界线。</p>
<h3 id="ion-device-add-heap"><a href="#ion-device-add-heap" class="headerlink" title="ion_device_add_heap"></a>ion_device_add_heap</h3><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion.c" target="_blank" rel="noopener">ion.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">ion_device_add_heap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_device <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> dentry <span class="token operator">*</span>debug_file<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>heap<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ION_HEAP_FLAG_DEFER_FREE<span class="token punctuation">)</span>
        <span class="token function">ion_heap_init_deferred_free</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>heap<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ION_HEAP_FLAG_DEFER_FREE<span class="token punctuation">)</span> <span class="token operator">||</span> heap<span class="token operator">-></span>ops<span class="token operator">-></span>shrink<span class="token punctuation">)</span>
        <span class="token function">ion_heap_init_shrinker</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    heap<span class="token operator">-></span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    <span class="token function">down_write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">plist_node_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap<span class="token operator">-></span>node<span class="token punctuation">,</span> <span class="token operator">-</span>heap<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">plist_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap<span class="token operator">-></span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-></span>heaps<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> DEBUG_HEAP_SHRINKER</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token function">up_write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为打开了标志位ION_HEAP_FLAG_DEFER_FREE和heap存在shrink方法。因此会初始化两个回收函数。</p>
<ul>
<li>1.ion_heap_init_deferred_free</li>
<li>2.ion_heap_init_shrinker</li>
<li>3.ion_heap 添加到ion_device的heap红黑树中。</li>
</ul>
<h4 id="ion-heap-init-deferred-free-启动销毁heap中free资源的线程"><a href="#ion-heap-init-deferred-free-启动销毁heap中free资源的线程" class="headerlink" title="ion_heap_init_deferred_free 启动销毁heap中free资源的线程"></a>ion_heap_init_deferred_free 启动销毁heap中free资源的线程</h4><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion_heap.c" target="_blank" rel="noopener">ion_heap.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ion_heap_deferred_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap <span class="token operator">=</span> data<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">;</span>

        <span class="token function">wait_event_freezable</span><span class="token punctuation">(</span>heap<span class="token operator">-></span>waitqueue<span class="token punctuation">,</span>
                     <span class="token function">ion_heap_freelist_size</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap<span class="token operator">-></span>free_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap<span class="token operator">-></span>free_list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap<span class="token operator">-></span>free_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        buffer <span class="token operator">=</span> <span class="token function">list_first_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap<span class="token operator">-></span>free_list<span class="token punctuation">,</span> <span class="token keyword">struct</span> ion_buffer<span class="token punctuation">,</span>
                      list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-></span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        heap<span class="token operator">-></span>free_list_size <span class="token operator">-</span><span class="token operator">=</span> buffer<span class="token operator">-></span>size<span class="token punctuation">;</span>
        <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap<span class="token operator">-></span>free_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ion_buffer_destroy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">ion_heap_init_deferred_free</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sched_param param <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>sched_priority <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap<span class="token operator">-></span>free_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    heap<span class="token operator">-></span>free_list_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap<span class="token operator">-></span>free_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap<span class="token operator">-></span>waitqueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    heap<span class="token operator">-></span>task <span class="token operator">=</span> <span class="token function">kthread_run</span><span class="token punctuation">(</span>ion_heap_deferred_free<span class="token punctuation">,</span> heap<span class="token punctuation">,</span>
                 <span class="token string">"%s"</span><span class="token punctuation">,</span> heap<span class="token operator">-></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>heap<span class="token operator">-></span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR_OR_ZERO</span><span class="token punctuation">(</span>heap<span class="token operator">-></span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">sched_setscheduler</span><span class="token punctuation">(</span>heap<span class="token operator">-></span>task<span class="token punctuation">,</span> SCHED_IDLE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时会创建一个内核线程，调用ion_heap_deferred_free内核不断的循环处理。不过由于这个线程设置的是SCHED_IDLE，这是最低等级的时间片轮转抢占。和Handler那个adle一样的处理规则，就是闲时处理。</p>
<p>在这个循环中，不断的循环销毁处理heap的free_list里面已经没有用的ion_buffer缓冲对象。</p>
<h4 id="ion-heap-init-shrinker-释放ion-pool中的page"><a href="#ion-heap-init-shrinker-释放ion-pool中的page" class="headerlink" title="ion_heap_init_shrinker  释放ion_pool中的page"></a>ion_heap_init_shrinker  释放ion_pool中的page</h4><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion_system_heap.c" target="_blank" rel="noopener">ion_system_heap.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">ion_heap_init_shrinker</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    heap<span class="token operator">-</span><span class="token operator">></span>shrinker<span class="token punctuation">.</span>count_objects <span class="token operator">=</span> ion_heap_shrink_count<span class="token punctuation">;</span>
    heap<span class="token operator">-</span><span class="token operator">></span>shrinker<span class="token punctuation">.</span>scan_objects <span class="token operator">=</span> ion_heap_shrink_scan<span class="token punctuation">;</span>
    heap<span class="token operator">-</span><span class="token operator">></span>shrinker<span class="token punctuation">.</span>seeks <span class="token operator">=</span> DEFAULT_SEEKS<span class="token punctuation">;</span>
    heap<span class="token operator">-</span><span class="token operator">></span>shrinker<span class="token punctuation">.</span>batch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">register_shrinker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap<span class="token operator">-</span><span class="token operator">></span>shrinker<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注册了heap的销毁内存的方法。当系统需要销毁页的时候，就会调用通过register_shrinker注册进来的函数。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ion_system_heap_shrink</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap<span class="token punctuation">,</span> gfp_t gfp_mask<span class="token punctuation">,</span>
                    <span class="token keyword">int</span> nr_to_scan<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_system_heap <span class="token operator">*</span>sys_heap<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nr_total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    sys_heap <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> <span class="token keyword">struct</span> ion_system_heap<span class="token punctuation">,</span> heap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_orders<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span>pool <span class="token operator">=</span> sys_heap<span class="token operator">-</span><span class="token operator">></span>pools<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        nr_total <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">ion_page_pool_shrink</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> gfp_mask<span class="token punctuation">,</span> nr_to_scan<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> nr_total<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion_page_pool.c" target="_blank" rel="noopener">ion_page_pool.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">ion_page_pool_shrink</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span>pool<span class="token punctuation">,</span> gfp_t gfp_mask<span class="token punctuation">,</span>
                <span class="token keyword">int</span> nr_to_scan<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> freed<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> high<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">current_is_kswapd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        high <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        high <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>gfp_mask <span class="token operator">&amp;</span> __GFP_HIGHMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nr_to_scan <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ion_page_pool_total</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> freed <span class="token operator">&lt;</span> nr_to_scan<span class="token punctuation">;</span> freed<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> page <span class="token operator">*</span>page<span class="token punctuation">;</span>

        <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-</span><span class="token operator">></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-</span><span class="token operator">></span>low_count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            page <span class="token operator">=</span> <span class="token function">ion_page_pool_remove</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>high <span class="token operator">&amp;&amp;</span> pool<span class="token operator">-</span><span class="token operator">></span>high_count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            page <span class="token operator">=</span> <span class="token function">ion_page_pool_remove</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-</span><span class="token operator">></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-</span><span class="token operator">></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ion_page_pool_free_pages</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> freed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> page <span class="token operator">*</span><span class="token function">ion_page_pool_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span>pool<span class="token punctuation">,</span> <span class="token keyword">bool</span> high<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> page <span class="token operator">*</span>page<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>high<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        page <span class="token operator">=</span> <span class="token function">list_first_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-</span><span class="token operator">></span>high_items<span class="token punctuation">,</span> <span class="token keyword">struct</span> page<span class="token punctuation">,</span> lru<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pool<span class="token operator">-</span><span class="token operator">></span>high_count<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        page <span class="token operator">=</span> <span class="token function">list_first_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-</span><span class="token operator">></span>low_items<span class="token punctuation">,</span> <span class="token keyword">struct</span> page<span class="token punctuation">,</span> lru<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pool<span class="token operator">-</span><span class="token operator">></span>low_count<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page<span class="token operator">-</span><span class="token operator">></span>lru<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> page<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ion_page_pool_free_pages</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span>pool<span class="token punctuation">,</span>
                     <span class="token keyword">struct</span> page <span class="token operator">*</span>page<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">ion_page_pool_free_set_cache_policy</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__free_pages</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> pool<span class="token operator">-</span><span class="token operator">></span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>整个流程很简单，其实就是遍历循环需要销毁的页面数量，接着如果是8的次幂就是移除high_items中的page缓存。4和0则销毁low_items中的page缓存。至于为什么是2的次幂其实很简单，为了销毁和申请简单。__free_pages能够整页的销毁。</p>
<h2 id="ion-open"><a href="#ion-open" class="headerlink" title="ion open"></a>ion open</h2><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion.c" target="_blank" rel="noopener">ion.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ion_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> inode <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> miscdevice <span class="token operator">*</span>miscdev <span class="token operator">=</span> file<span class="token operator">-</span><span class="token operator">></span>private_data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_device <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>miscdev<span class="token punctuation">,</span> <span class="token keyword">struct</span> ion_device<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client<span class="token punctuation">;</span>
    <span class="token keyword">char</span> debug_name<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: %d\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>debug_name<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token string">"%u"</span><span class="token punctuation">,</span> <span class="token function">task_pid_nr</span><span class="token punctuation">(</span>current<span class="token operator">-</span><span class="token operator">></span>group_leader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client <span class="token operator">=</span> <span class="token function">ion_client_create</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> debug_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    file<span class="token operator">-</span><span class="token operator">></span>private_data <span class="token operator">=</span> client<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.ion_client_create 为open对应file创建一个ion_client</li>
<li>2.file的私有数据更换为ion_client</li>
</ul>
<h3 id="ion-client-create-为open对应file创建一个ion-client"><a href="#ion-client-create-为open对应file创建一个ion-client" class="headerlink" title="ion_client_create 为open对应file创建一个ion_client"></a>ion_client_create 为open对应file创建一个ion_client</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> ion_client <span class="token operator">*</span><span class="token function">ion_client_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_device <span class="token operator">*</span>dev<span class="token punctuation">,</span>
                     <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> task_struct <span class="token operator">*</span>task<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rb_node <span class="token operator">*</span><span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rb_node <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_client <span class="token operator">*</span>entry<span class="token punctuation">;</span>
    pid_t pid<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">get_task_struct</span><span class="token punctuation">(</span>current<span class="token operator">-</span><span class="token operator">></span>group_leader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">task_lock</span><span class="token punctuation">(</span>current<span class="token operator">-</span><span class="token operator">></span>group_leader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pid <span class="token operator">=</span> <span class="token function">task_pid_nr</span><span class="token punctuation">(</span>current<span class="token operator">-</span><span class="token operator">></span>group_leader<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-</span><span class="token operator">></span>group_leader<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> PF_KTHREAD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">put_task_struct</span><span class="token punctuation">(</span>current<span class="token operator">-</span><span class="token operator">></span>group_leader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        task <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        task <span class="token operator">=</span> current<span class="token operator">-</span><span class="token operator">></span>group_leader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">task_unlock</span><span class="token punctuation">(</span>current<span class="token operator">-</span><span class="token operator">></span>group_leader<span class="token punctuation">)</span><span class="token punctuation">;</span>

    client <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_client<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> err_put_task_struct<span class="token punctuation">;</span>

    client<span class="token operator">-</span><span class="token operator">></span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    client<span class="token operator">-</span><span class="token operator">></span>handles <span class="token operator">=</span> RB_ROOT<span class="token punctuation">;</span>
    <span class="token function">idr_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-</span><span class="token operator">></span>idr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-</span><span class="token operator">></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token operator">-</span><span class="token operator">></span>task <span class="token operator">=</span> task<span class="token punctuation">;</span>
    client<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">=</span> pid<span class="token punctuation">;</span>
    client<span class="token operator">-</span><span class="token operator">></span>name <span class="token operator">=</span> <span class="token function">kstrdup</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> err_free_client<span class="token punctuation">;</span>

    <span class="token function">down_write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token operator">-</span><span class="token operator">></span>display_serial <span class="token operator">=</span> <span class="token function">ion_get_client_serial</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">></span>clients<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token operator">-</span><span class="token operator">></span>display_name <span class="token operator">=</span> <span class="token function">kasprintf</span><span class="token punctuation">(</span>
        GFP_KERNEL<span class="token punctuation">,</span> <span class="token string">"%s-%d"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> client<span class="token operator">-</span><span class="token operator">></span>display_serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token operator">-</span><span class="token operator">></span>display_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">up_write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err_free_client_name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    p <span class="token operator">=</span> <span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">></span>clients<span class="token punctuation">.</span>rb_node<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
        entry <span class="token operator">=</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token keyword">struct</span> ion_client<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">&lt;</span> entry<span class="token punctuation">)</span>
            p <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>rb_left<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">></span> entry<span class="token punctuation">)</span>
            p <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>rb_right<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">rb_link_node</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-</span><span class="token operator">></span>node<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rb_insert_color</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-</span><span class="token operator">></span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">></span>clients<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">up_write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> client<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要就是初始化ion_client各个参数，最后把ion_client插入到ion_device的clients。来看看ion_client结构体：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> ion_client <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> rb_node node<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*链接对应ion_device红黑树的node*/</span>
    <span class="token keyword">struct</span> ion_device <span class="token operator">*</span>dev<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*驱动对象*/</span>
    <span class="token keyword">struct</span> rb_root handles<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*一个client带着的句柄红黑树*/</span>
    <span class="token keyword">struct</span> idr idr<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> mutex lock<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>display_name<span class="token punctuation">;</span>
    <span class="token keyword">int</span> display_serial<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> task_struct <span class="token operator">*</span>task<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*线程组的leader，也就是当前的进程*/</span>
    pid_t pid<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*进程id*/</span>
    <span class="token keyword">struct</span> dentry <span class="token operator">*</span>debug_root<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ioctl-发送ION-IOC-ALLOC命令"><a href="#ioctl-发送ION-IOC-ALLOC命令" class="headerlink" title="ioctl 发送ION_IOC_ALLOC命令"></a>ioctl 发送ION_IOC_ALLOC命令</h2><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">ion_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client <span class="token operator">=</span> filp<span class="token operator">-</span><span class="token operator">></span>private_data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_device <span class="token operator">*</span>dev <span class="token operator">=</span> client<span class="token operator">-</span><span class="token operator">></span>dev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_handle <span class="token operator">*</span>cleanup_handle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> dir<span class="token punctuation">;</span>

    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> ion_fd_data fd<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> ion_allocation_data allocation<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> ion_handle_data handle<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> ion_custom_data custom<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> data<span class="token punctuation">;</span>

    dir <span class="token operator">=</span> <span class="token function">ion_ioctl_dir</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dir <span class="token operator">&amp;</span> _IOC_WRITE<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> ION_IOC_ALLOC<span class="token operator">:</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> ion_handle <span class="token operator">*</span>handle<span class="token punctuation">;</span>

        handle <span class="token operator">=</span> <span class="token function">ion_alloc</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> data<span class="token punctuation">.</span>allocation<span class="token punctuation">.</span>len<span class="token punctuation">,</span>
                        data<span class="token punctuation">.</span>allocation<span class="token punctuation">.</span>align<span class="token punctuation">,</span>
                        data<span class="token punctuation">.</span>allocation<span class="token punctuation">.</span>heap_id_mask<span class="token punctuation">,</span>
                        data<span class="token punctuation">.</span>allocation<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        data<span class="token punctuation">.</span>allocation<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle<span class="token operator">-</span><span class="token operator">></span>id<span class="token punctuation">;</span>

        cleanup_handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> ION_IOC_FREE<span class="token operator">:</span>
    <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> ION_IOC_SHARE<span class="token operator">:</span>
    <span class="token keyword">case</span> ION_IOC_MAP<span class="token operator">:</span>
    <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dir <span class="token operator">&amp;</span> _IOC_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cleanup_handle<span class="token punctuation">)</span>
                <span class="token function">ion_free</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> cleanup_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心还是调用ion_alloc申请一个ion缓冲区的句柄。最后把数据拷贝会用户空间。</p>
<h3 id="ion-alloc-创建句柄和缓冲区"><a href="#ion-alloc-创建句柄和缓冲区" class="headerlink" title="ion_alloc 创建句柄和缓冲区"></a>ion_alloc 创建句柄和缓冲区</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> ion_handle <span class="token operator">*</span><span class="token function">ion_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span>
                 size_t align<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> heap_id_mask<span class="token punctuation">,</span>
                 <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_handle <span class="token operator">*</span>handle<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_device <span class="token operator">*</span>dev <span class="token operator">=</span> client<span class="token operator">-></span>dev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    len <span class="token operator">=</span> <span class="token function">PAGE_ALIGN</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>len<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">down_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">plist_for_each_entry</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-></span>heaps<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* if the caller didn't specify this heap id */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> heap<span class="token operator">-></span>id<span class="token punctuation">)</span> <span class="token operator">&amp;</span> heap_id_mask<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        buffer <span class="token operator">=</span> <span class="token function">ion_buffer_create</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> len<span class="token punctuation">,</span> align<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">up_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    handle <span class="token operator">=</span> <span class="token function">ion_handle_create</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ion_buffer_put</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> handle<span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">ion_handle_add</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ion_handle_put</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        handle <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> handle<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.遍历ion_device的中heaps，ion_buffer_create创建ion_buffer</li>
<li>2.ion_handle_create 创建句柄ion_handle</li>
<li>3.ion_buffer_put 设置buffer销毁时候的函数</li>
<li>4.ion_handle_add 把ion_handle插入到ion_client的handles红黑树。</li>
</ul>
<h4 id="ion-buffer-create-创建ion-buffer"><a href="#ion-buffer-create-创建ion-buffer" class="headerlink" title="ion_buffer_create 创建ion_buffer"></a>ion_buffer_create 创建ion_buffer</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span><span class="token function">ion_buffer_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap<span class="token punctuation">,</span>
                     <span class="token keyword">struct</span> ion_device <span class="token operator">*</span>dev<span class="token punctuation">,</span>
                     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">,</span>
                     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> align<span class="token punctuation">,</span>
                     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sg_table <span class="token operator">*</span>table<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> scatterlist <span class="token operator">*</span>sg<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>

    buffer <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>

    buffer<span class="token operator">-</span><span class="token operator">></span>heap <span class="token operator">=</span> heap<span class="token punctuation">;</span>
    buffer<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
    <span class="token function">kref_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-</span><span class="token operator">></span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> heap<span class="token operator">-</span><span class="token operator">></span>ops<span class="token operator">-</span><span class="token operator">></span><span class="token function">allocate</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> len<span class="token punctuation">,</span> align<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    buffer<span class="token operator">-</span><span class="token operator">></span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    buffer<span class="token operator">-</span><span class="token operator">></span>size <span class="token operator">=</span> len<span class="token punctuation">;</span>

    table <span class="token operator">=</span> heap<span class="token operator">-</span><span class="token operator">></span>ops<span class="token operator">-</span><span class="token operator">></span><span class="token function">map_dma</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    buffer<span class="token operator">-</span><span class="token operator">></span>sg_table <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ion_buffer_fault_user_mappings</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> num_pages <span class="token operator">=</span> <span class="token function">PAGE_ALIGN</span><span class="token punctuation">(</span>buffer<span class="token operator">-</span><span class="token operator">></span>size<span class="token punctuation">)</span> <span class="token operator">/</span> PAGE_SIZE<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> scatterlist <span class="token operator">*</span>sg<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        buffer<span class="token operator">-</span><span class="token operator">></span>pages <span class="token operator">=</span> <span class="token function">vmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> page <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> num_pages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token operator">-</span><span class="token operator">></span>pages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> err1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">for_each_sg</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>sgl<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> table<span class="token operator">-</span><span class="token operator">></span>nents<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> page <span class="token operator">*</span>page <span class="token operator">=</span> <span class="token function">sg_page</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> sg<span class="token operator">-</span><span class="token operator">></span>length <span class="token operator">/</span> PAGE_SIZE<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
                buffer<span class="token operator">-</span><span class="token operator">></span>pages<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> page<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    buffer<span class="token operator">-</span><span class="token operator">></span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    buffer<span class="token operator">-</span><span class="token operator">></span>size <span class="token operator">=</span> len<span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-</span><span class="token operator">></span>vmas<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-</span><span class="token operator">></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* this will set up dma addresses for the sglist -- it is not
       technically correct as per the dma api -- a specific
       device isn't really taking ownership here.  However, in practice on
       our systems the only dma_address space is physical addresses.
       Additionally, we can't afford the overhead of invalidating every
       allocation via dma_map_sg. The implicit contract here is that
       memory coming from the heaps is ready for dma, ie if it has a
       cached mapping that mapping has been invalidated */</span>
    <span class="token function">for_each_sg</span><span class="token punctuation">(</span>buffer<span class="token operator">-</span><span class="token operator">></span>sg_table<span class="token operator">-</span><span class="token operator">></span>sgl<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> buffer<span class="token operator">-</span><span class="token operator">></span>sg_table<span class="token operator">-</span><span class="token operator">></span>nents<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token function">sg_dma_address</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">sg_phys</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">></span>buffer_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ion_buffer_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">></span>buffer_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.调用ion_heap的allocate</li>
<li>2.调用ion_heap的map_dma</li>
<li>3.ion_buffer_fault_user_mappings判断当前的buffer是否设置了GRALLOC_USAGE_SW_READ_RARELY，对应顶层就是USAGE_SW_READ_RARELY。也就是读写很少的图元GraphicBuffer。只有打开这个才会为buffer设置vmalloc在动态映射区映射内存(这个高端内存区域的物理内存不连续，虚拟内存是连续)，这种很少见，一般是不变的浮层。</li>
<li>4.for_each_sg 把table中所有的地址从物理地址直接转化为dma地址。因为高端内存的地址的确可以一一简单的计算算出物理地址。不过这样做很少见。</li>
<li>4.ion_buffer_add 把ion_buffer插入ion_device的buffers红黑树。</li>
</ul>
<h4 id="ion-heap的allocate-ion-system-heap-allocate"><a href="#ion-heap的allocate-ion-system-heap-allocate" class="headerlink" title="ion_heap的allocate ion_system_heap_allocate"></a>ion_heap的allocate ion_system_heap_allocate</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ion_system_heap_allocate</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap<span class="token punctuation">,</span>
                     <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">,</span>
                     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> align<span class="token punctuation">,</span>
                     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_system_heap <span class="token operator">*</span>sys_heap <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span>
                            <span class="token keyword">struct</span> ion_system_heap<span class="token punctuation">,</span>
                            heap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sg_table <span class="token operator">*</span>table<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> scatterlist <span class="token operator">*</span>sg<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> list_head pages<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> page <span class="token operator">*</span>page<span class="token punctuation">,</span> <span class="token operator">*</span>tmp_page<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size_remaining <span class="token operator">=</span> <span class="token function">PAGE_ALIGN</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_order <span class="token operator">=</span> orders<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>align <span class="token operator">></span> PAGE_SIZE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">/</span> PAGE_SIZE <span class="token operator">></span> totalram_pages <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>size_remaining <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        page <span class="token operator">=</span> <span class="token function">alloc_largest_available</span><span class="token punctuation">(</span>sys_heap<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> size_remaining<span class="token punctuation">,</span>
                        max_order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> free_pages<span class="token punctuation">;</span>
        <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page<span class="token operator">-></span>lru<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size_remaining <span class="token operator">-</span><span class="token operator">=</span> PAGE_SIZE <span class="token operator">&lt;&lt;</span> <span class="token function">compound_order</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        max_order <span class="token operator">=</span> <span class="token function">compound_order</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    table <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sg_table<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sg_alloc_table</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> i<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> free_table<span class="token punctuation">;</span>

    sg <span class="token operator">=</span> table<span class="token operator">-></span>sgl<span class="token punctuation">;</span>
    <span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> tmp_page<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pages<span class="token punctuation">,</span> lru<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sg_set_page</span><span class="token punctuation">(</span>sg<span class="token punctuation">,</span> page<span class="token punctuation">,</span> PAGE_SIZE <span class="token operator">&lt;&lt;</span> <span class="token function">compound_order</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sg <span class="token operator">=</span> <span class="token function">sg_next</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page<span class="token operator">-></span>lru<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    buffer<span class="token operator">-></span>priv_virt <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>把页数进行4kb对齐</li>
<li>接着调用alloc_largest_available找到最合适的大小资源池里申请去。</li>
<li>初始化ion_buffer中sg_table，设置物理页到sg_table中每一页对象。</li>
<li>ion_buffer的priv_virt设置为sg_table</li>
</ul>
<h5 id="alloc-largest-available"><a href="#alloc-largest-available" class="headerlink" title="alloc_largest_available"></a>alloc_largest_available</h5><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">order_to_size</span><span class="token punctuation">(</span><span class="token keyword">int</span> order<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> PAGE_SIZE <span class="token operator">&lt;&lt;</span> order<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> page <span class="token operator">*</span><span class="token function">alloc_largest_available</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_system_heap <span class="token operator">*</span>heap<span class="token punctuation">,</span>
                        <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">,</span>
                        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">,</span>
                        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_order<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> page <span class="token operator">*</span>page<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_orders<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token function">order_to_size</span><span class="token punctuation">(</span>orders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>max_order <span class="token operator">&lt;</span> orders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        page <span class="token operator">=</span> <span class="token function">alloc_buffer_page</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> orders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> page<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个实际上就是找到最小能承载的大小，去申请内存。如果8kb申请内存，就会拆分积分在0-4kb，4kb-16kb，16kb-128kb区间找。刚好dma也是在128kb之内才能申请。超过这个数字就禁止申请。8kb就会拆成2个4kb保存在第一个pool中。</p>
<p>最后所有的申请的page都添加到pages集合中。</p>
<h5 id="alloc-buffer-page"><a href="#alloc-buffer-page" class="headerlink" title="alloc_buffer_page"></a>alloc_buffer_page</h5><pre class="line-numbers language-c"><code class="language-c">bool <span class="token function">ion_buffer_cached</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>buffer<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ION_FLAG_CACHED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> gfp_t high_order_gfp_flags <span class="token operator">=</span> <span class="token punctuation">(</span>GFP_HIGHUSER <span class="token operator">|</span> __GFP_ZERO <span class="token operator">|</span> __GFP_NOWARN <span class="token operator">|</span>
                     __GFP_NORETRY<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>__GFP_WAIT<span class="token punctuation">;</span>
<span class="token keyword">static</span> gfp_t low_order_gfp_flags  <span class="token operator">=</span> <span class="token punctuation">(</span>GFP_HIGHUSER <span class="token operator">|</span> __GFP_ZERO <span class="token operator">|</span> __GFP_NOWARN<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> page <span class="token operator">*</span><span class="token function">alloc_buffer_page</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_system_heap <span class="token operator">*</span>heap<span class="token punctuation">,</span>
                      <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">,</span>
                      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> order<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    bool cached <span class="token operator">=</span> <span class="token function">ion_buffer_cached</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span>pool <span class="token operator">=</span> heap<span class="token operator">-></span>pools<span class="token punctuation">[</span><span class="token function">order_to_index</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> page <span class="token operator">*</span>page<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        page <span class="token operator">=</span> <span class="token function">ion_page_pool_alloc</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        gfp_t gfp_flags <span class="token operator">=</span> low_order_gfp_flags<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">></span> <span class="token number">4</span><span class="token punctuation">)</span>
            gfp_flags <span class="token operator">=</span> high_order_gfp_flags<span class="token punctuation">;</span>
        page <span class="token operator">=</span> <span class="token function">alloc_pages</span><span class="token punctuation">(</span>gfp_flags <span class="token operator">|</span> __GFP_COMP<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token function">ion_pages_sync_for_device</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> page<span class="token punctuation">,</span> PAGE_SIZE <span class="token operator">&lt;&lt;</span> order<span class="token punctuation">,</span>
                        DMA_BIDIRECTIONAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> page<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.不许需要缓存则使用ion_page_pool_alloc申请</li>
<li>2.需要dma缓存，先调用alloc_pages获取page，接着ion_pages_sync_for_device通过dma缓冲。</li>
</ul>
<h5 id="ion-page-pool-alloc"><a href="#ion-page-pool-alloc" class="headerlink" title="ion_page_pool_alloc"></a>ion_page_pool_alloc</h5><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion_page_pool.c" target="_blank" rel="noopener">ion_page_pool.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> page <span class="token operator">*</span><span class="token function">ion_page_pool_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span>pool<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> page <span class="token operator">*</span>page <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-></span>high_count<span class="token punctuation">)</span>
        page <span class="token operator">=</span> <span class="token function">ion_page_pool_remove</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-></span>low_count<span class="token punctuation">)</span>
        page <span class="token operator">=</span> <span class="token function">ion_page_pool_remove</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page<span class="token punctuation">)</span>
        page <span class="token operator">=</span> <span class="token function">ion_page_pool_alloc_pages</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> page<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时会从 ion_page_pool冲取出对应大小区域的空闲页返回上层，如果最早的时候没有则会调用ion_page_pool_alloc_pages申请一个新的page。由于引用最终来自ion_page_pool中，因此之后申请之后还是在ion_page_pool中。</p>
<pre><code>static void *ion_page_pool_alloc_pages(struct ion_page_pool *pool)
{
    struct page *page = alloc_pages(pool-&gt;gfp_mask, pool-&gt;order);

    if (!page)
        return NULL;
    ion_page_pool_alloc_set_cache_policy(pool, page);

    ion_pages_sync_for_device(NULL, page, PAGE_SIZE &lt;&lt; pool-&gt;order,
                        DMA_BIDIRECTIONAL);
    return page;
}
</code></pre><ul>
<li>ion_page_pool_alloc_set_cache_policy 检测内存是否泄露</li>
<li>ion_pages_sync_for_device 每一次申请都需要同步dma的数据。</li>
</ul>
<p>这里的处理就是为了避免DMA直接内存造成的缓存差异(一般的申请，默认会带一个DMA标志位)。换句话说，是否打开cache其实就是，关闭了则使用pool的cache，打开了则不使用pool缓存，只依赖DMA的缓存。</p>
<p>我们可以看另一个dma的heap，它是怎么做到dma内存的一致性.<br>文件：<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion_cma_heap.c" target="_blank" rel="noopener">ion_cma_heap.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ion_cma_allocate</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap<span class="token punctuation">,</span> <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">,</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> align<span class="token punctuation">,</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_cma_heap <span class="token operator">*</span>cma_heap <span class="token operator">=</span> <span class="token function">to_cma_heap</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> device <span class="token operator">*</span>dev <span class="token operator">=</span> cma_heap<span class="token operator">-></span>dev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_cma_buffer_info <span class="token operator">*</span>info<span class="token punctuation">;</span>

    <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"Request buffer allocation len %ld\n"</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ION_FLAG_CACHED<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>align <span class="token operator">></span> PAGE_SIZE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    info <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_cma_buffer_info<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ION_CMA_ALLOCATE_FAILED<span class="token punctuation">;</span>

    info<span class="token operator">-></span>cpu_addr <span class="token operator">=</span> <span class="token function">dma_alloc_coherent</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>info<span class="token operator">-></span>handle<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        GFP_HIGHUSER <span class="token operator">|</span> __GFP_ZERO<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token operator">-></span>cpu_addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"Fail to allocate buffer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    info<span class="token operator">-></span>table <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sg_table<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token operator">-></span>table<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> free_mem<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ion_cma_get_sgtable</span>
        <span class="token punctuation">(</span>dev<span class="token punctuation">,</span> info<span class="token operator">-></span>table<span class="token punctuation">,</span> info<span class="token operator">-></span>cpu_addr<span class="token punctuation">,</span> info<span class="token operator">-></span>handle<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> free_table<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* keep this for memory release */</span>
    buffer<span class="token operator">-></span>priv_virt <span class="token operator">=</span> info<span class="token punctuation">;</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"Allocate buffer %p\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到它为了能办到dma缓存的一致性，使用了dma_alloc_coherent创建了一个所有强制同步的地址，也就是没有DMA缓存的地址。</p>
<h5 id="sg-table-和-scatterlist初始化"><a href="#sg-table-和-scatterlist初始化" class="headerlink" title="sg_table 和 scatterlist初始化"></a>sg_table 和 scatterlist初始化</h5><p>这里出现了几个新的结构体，sg_table和scatterlist</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> sg_table <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> scatterlist <span class="token operator">*</span>sgl<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* the list */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nents<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* number of mapped entries */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> orig_nents<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* original size of list */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> scatterlist <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span>    page_link<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    offset<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    length<span class="token punctuation">;</span>
    dma_addr_t    dma_address<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_NEED_SG_DMA_LENGTH</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    dma_length<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c">    table <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sg_table<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>table<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> free_pages<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sg_alloc_table</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> i<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> free_table<span class="token punctuation">;</span>

    sg <span class="token operator">=</span> table<span class="token operator">-></span>sgl<span class="token punctuation">;</span>
    <span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> tmp_page<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pages<span class="token punctuation">,</span> lru<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sg_set_page</span><span class="token punctuation">(</span>sg<span class="token punctuation">,</span> page<span class="token punctuation">,</span> PAGE_SIZE <span class="token operator">&lt;&lt;</span> <span class="token function">compound_order</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sg <span class="token operator">=</span> <span class="token function">sg_next</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page<span class="token operator">-></span>lru<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.sg_alloc_table初始化sg_table</li>
<li>2.遍历pages，添加到scatterlist。</li>
</ul>
<p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/lib/" target="_blank" rel="noopener">lib</a>/<a href="http://androidxref.com/kernel_3.18/xref/lib/scatterlist.c" target="_blank" rel="noopener">scatterlist.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> SG_MAX_SINGLE_ALLOC        (PAGE_SIZE / sizeof(struct scatterlist))</span>

<span class="token keyword">int</span> <span class="token function">__sg_alloc_table</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sg_table <span class="token operator">*</span>table<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nents<span class="token punctuation">,</span>
             <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_ents<span class="token punctuation">,</span> <span class="token keyword">struct</span> scatterlist <span class="token operator">*</span>first_chunk<span class="token punctuation">,</span>
             gfp_t gfp_mask<span class="token punctuation">,</span> sg_alloc_fn <span class="token operator">*</span>alloc_fn<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> scatterlist <span class="token operator">*</span>sg<span class="token punctuation">,</span> <span class="token operator">*</span>prv<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> left<span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nents <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> CONFIG_ARCH_HAS_SG_CHAIN</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span>nents <span class="token operator">></span> max_ents<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    left <span class="token operator">=</span> nents<span class="token punctuation">;</span>
    prv <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> sg_size<span class="token punctuation">,</span> alloc_size <span class="token operator">=</span> left<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>alloc_size <span class="token operator">></span> max_ents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            alloc_size <span class="token operator">=</span> max_ents<span class="token punctuation">;</span>
            sg_size <span class="token operator">=</span> alloc_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            sg_size <span class="token operator">=</span> alloc_size<span class="token punctuation">;</span>

        left <span class="token operator">-</span><span class="token operator">=</span> sg_size<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>first_chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sg <span class="token operator">=</span> first_chunk<span class="token punctuation">;</span>
            first_chunk <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            sg <span class="token operator">=</span> <span class="token function">alloc_fn</span><span class="token punctuation">(</span>alloc_size<span class="token punctuation">,</span> gfp_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>sg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * Adjust entry count to reflect that the last
             * entry of the previous table won't be used for
             * linkage.  Without this, sg_kfree() may get
             * confused.
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prv<span class="token punctuation">)</span>
                table<span class="token operator">-></span>nents <span class="token operator">=</span> <span class="token operator">++</span>table<span class="token operator">-></span>orig_nents<span class="token punctuation">;</span>

             <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">sg_init_table</span><span class="token punctuation">(</span>sg<span class="token punctuation">,</span> alloc_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        table<span class="token operator">-></span>nents <span class="token operator">=</span> table<span class="token operator">-></span>orig_nents <span class="token operator">+</span><span class="token operator">=</span> sg_size<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * If this is the first mapping, assign the sg table header.
         * If this is not the first mapping, chain previous part.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prv<span class="token punctuation">)</span>
            <span class="token function">sg_chain</span><span class="token punctuation">(</span>prv<span class="token punctuation">,</span> max_ents<span class="token punctuation">,</span> sg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            table<span class="token operator">-></span>sgl <span class="token operator">=</span> sg<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * If no more entries after this one, mark the end
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>left<span class="token punctuation">)</span>
            <span class="token function">sg_mark_end</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sg<span class="token punctuation">[</span>sg_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        prv <span class="token operator">=</span> sg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> scatterlist <span class="token operator">*</span><span class="token function">sg_kmalloc</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> nents<span class="token punctuation">,</span> gfp_t gfp_mask<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nents <span class="token operator">==</span> SG_MAX_SINGLE_ALLOC<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">__get_free_page</span><span class="token punctuation">(</span>gfp_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kmemleak_alloc</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> gfp_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>nents <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> scatterlist<span class="token punctuation">)</span><span class="token punctuation">,</span> gfp_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">sg_alloc_table</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sg_table <span class="token operator">*</span>table<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nents<span class="token punctuation">,</span> gfp_t gfp_mask<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">__sg_alloc_table</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> nents<span class="token punctuation">,</span> SG_MAX_SINGLE_ALLOC<span class="token punctuation">,</span>
                   <span class="token constant">NULL</span><span class="token punctuation">,</span> gfp_mask<span class="token punctuation">,</span> sg_kmalloc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">__sg_free_table</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> SG_MAX_SINGLE_ALLOC<span class="token punctuation">,</span> false<span class="token punctuation">,</span> sg_kfree<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面实际上做的事情就是一件：初始化sg_table.<br>sg_table中有一个核心的对象scatterlist链表。如果pages申请的对象数量&lt;PAGE_SIZE/sizeof(scatterlist),每一项sg_table只有一个scatterlist。但是超出这个数字就会增加一个scatterlist。</p>
<p>用公式来说：</p>
<blockquote>
<p>pages.size() &lt; PAGE_SIZE/sizeof(scatterlist) = pages.size() * sizeof(scatterlist) &lt; PAGE_SIZE</p>
</blockquote>
<p>换句话说，每一次生成scatterlist的链表就会直接尽可能占满一页，让内存更好管理。</p>
<h4 id="ion-heap-map-dma"><a href="#ion-heap-map-dma" class="headerlink" title="ion_heap map_dma"></a>ion_heap map_dma</h4><pre><code>static struct sg_table *ion_system_heap_map_dma(struct ion_heap *heap,
                        struct ion_buffer *buffer)
{
    return buffer-&gt;priv_virt;
}</code></pre><p>返回了sg_table。</p>
<h3 id="ion-handle-create-创建ion-handle句柄"><a href="#ion-handle-create-创建ion-handle句柄" class="headerlink" title="ion_handle_create 创建ion_handle句柄"></a>ion_handle_create 创建ion_handle句柄</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> ion_handle <span class="token operator">*</span><span class="token function">ion_handle_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client<span class="token punctuation">,</span>
                     <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_handle <span class="token operator">*</span>handle<span class="token punctuation">;</span>

    handle <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_handle<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handle<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kref_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-></span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RB_CLEAR_NODE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-></span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    handle<span class="token operator">-></span>client <span class="token operator">=</span> client<span class="token punctuation">;</span>
    <span class="token function">ion_buffer_get</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*增加ion_buffer引用计数*/</span>
    <span class="token function">ion_buffer_add_to_handle</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    handle<span class="token operator">-></span>buffer <span class="token operator">=</span> buffer<span class="token punctuation">;</span>

    <span class="token keyword">return</span> handle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ion_buffer_add_to_handle</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buffer<span class="token operator">-></span>handle_count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> ion_handle <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> kref ref<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*销毁引用*/</span>
    <span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*对应的客户端*/</span>
    <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*ion缓冲区*/</span>
    <span class="token keyword">struct</span> rb_node node<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*client 中handles红黑树的节点*/</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> kmap_cnt<span class="token punctuation">;</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>初始化ion_handle，并且记录对应的ion_client是当前打开文件的进程，并且设置ion_buffer到handle中。使得句柄能够和buffer关联起来。</p>
<h3 id="ion-buffer-put-设置ion-buffer销毁函数"><a href="#ion-buffer-put-设置ion-buffer销毁函数" class="headerlink" title="ion_buffer_put 设置ion_buffer销毁函数"></a>ion_buffer_put 设置ion_buffer销毁函数</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ion_buffer_put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">kref_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-></span>ref<span class="token punctuation">,</span> _ion_buffer_destroy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_ion_buffer_destroy</span><span class="token punctuation">(</span><span class="token keyword">struct</span> kref <span class="token operator">*</span>kref<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>kref<span class="token punctuation">,</span> <span class="token keyword">struct</span> ion_buffer<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap <span class="token operator">=</span> buffer<span class="token operator">-></span>heap<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_device <span class="token operator">*</span>dev <span class="token operator">=</span> buffer<span class="token operator">-></span>dev<span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>buffer_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rb_erase</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-></span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-></span>buffers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>buffer_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>heap<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ION_HEAP_FLAG_DEFER_FREE<span class="token punctuation">)</span>
        <span class="token function">ion_heap_freelist_add</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">ion_buffer_destroy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>每当ion_buffer需要销毁，如果heap打开了ION_HEAP_FLAG_DEFER_FREE标志，将会把对象放到ion_heap中free_list链表。没打开则直接调用heap的销毁函数。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">ion_buffer_destroy</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON</span><span class="token punctuation">(</span>buffer<span class="token operator">-></span>kmap_cnt <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        buffer<span class="token operator">-></span>heap<span class="token operator">-></span>ops<span class="token operator">-></span><span class="token function">unmap_kernel</span><span class="token punctuation">(</span>buffer<span class="token operator">-></span>heap<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buffer<span class="token operator">-></span>heap<span class="token operator">-></span>ops<span class="token operator">-></span><span class="token function">unmap_dma</span><span class="token punctuation">(</span>buffer<span class="token operator">-></span>heap<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buffer<span class="token operator">-></span>heap<span class="token operator">-></span>ops<span class="token operator">-></span><span class="token function">free</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token operator">-></span>pages<span class="token punctuation">)</span>
        <span class="token function">vfree</span><span class="token punctuation">(</span>buffer<span class="token operator">-></span>pages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ion_system_heap_free</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_system_heap <span class="token operator">*</span>sys_heap <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>buffer<span class="token operator">-></span>heap<span class="token punctuation">,</span>
                            <span class="token keyword">struct</span> ion_system_heap<span class="token punctuation">,</span>
                            heap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sg_table <span class="token operator">*</span>table <span class="token operator">=</span> buffer<span class="token operator">-></span>sg_table<span class="token punctuation">;</span>
    bool cached <span class="token operator">=</span> <span class="token function">ion_buffer_cached</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> scatterlist <span class="token operator">*</span>sg<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cached <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>buffer<span class="token operator">-></span>private_flags <span class="token operator">&amp;</span> ION_PRIV_FLAG_SHRINKER_FREE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">ion_heap_buffer_zero</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">for_each_sg</span><span class="token punctuation">(</span>table<span class="token operator">-></span>sgl<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> table<span class="token operator">-></span>nents<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token function">free_buffer_page</span><span class="token punctuation">(</span>sys_heap<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token function">sg_page</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sg_free_table</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">free_buffer_page</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_system_heap <span class="token operator">*</span>heap<span class="token punctuation">,</span>
                 <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">struct</span> page <span class="token operator">*</span>page<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> order <span class="token operator">=</span> <span class="token function">compound_order</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool cached <span class="token operator">=</span> <span class="token function">ion_buffer_cached</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cached <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>buffer<span class="token operator">-></span>private_flags <span class="token operator">&amp;</span> ION_PRIV_FLAG_SHRINKER_FREE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> ion_page_pool <span class="token operator">*</span>pool <span class="token operator">=</span> heap<span class="token operator">-></span>pools<span class="token punctuation">[</span><span class="token function">order_to_index</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token operator">-></span>private_flags <span class="token operator">&amp;</span> ION_PRIV_FLAG_SHRINKER_FREE<span class="token punctuation">)</span>
            <span class="token function">ion_page_pool_free_immediate</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">ion_page_pool_free</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">__free_pages</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>free_buffer_page将会把sg_table中所有scatterlist持有的list全部移动到pool的highItem和lowItem中，如果添加失败则会直接调用__free_pages释放page。最后释放sg_table内存。</p>
<h3 id="ion-handle-put-设置句柄销毁函数"><a href="#ion-handle-put-设置句柄销毁函数" class="headerlink" title="ion_handle_put 设置句柄销毁函数"></a>ion_handle_put 设置句柄销毁函数</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ion_handle_put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_handle <span class="token operator">*</span>handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client <span class="token operator">=</span> handle<span class="token operator">-></span>client<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">kref_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-></span>ref<span class="token punctuation">,</span> ion_handle_destroy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ion_handle_destroy</span><span class="token punctuation">(</span><span class="token keyword">struct</span> kref <span class="token operator">*</span>kref<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_handle <span class="token operator">*</span>handle <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>kref<span class="token punctuation">,</span> <span class="token keyword">struct</span> ion_handle<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client <span class="token operator">=</span> handle<span class="token operator">-></span>client<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer <span class="token operator">=</span> handle<span class="token operator">-></span>buffer<span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>handle<span class="token operator">-></span>kmap_cnt<span class="token punctuation">)</span>
        <span class="token function">ion_handle_kmap_put</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">idr_remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-></span>idr<span class="token punctuation">,</span> handle<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">RB_EMPTY_NODE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-></span>node<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">rb_erase</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-></span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client<span class="token operator">-></span>handles<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ion_buffer_remove_from_handle</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ion_buffer_put</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">kfree</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先释放ion_client中保存的handle，接着调用ion_buffer_remove_from_handle，减少buffer持有当前handle数量,最后释放。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>整个ion的初始化到这一步就完成，从device驱动结构体到缓存的核心ion_handle初始化。</p>
<ul>
<li><p>1.ion_device将会持有一个clients的红黑树，对所有的通过open进来的client，为file设置私有数据我为client。一个buffers红黑树，用于全局控制ion_buffer。一个ion_heap红黑树，用于管理所有类型ion_heap。</p>
</li>
<li><p>2.ion_heap 持有一个ion_page_pool，在这个资源池子里面控制不同规格的内存块。当heap需要申请的内存时候，将会从ion_page_pool找到对应index下的内存页page划分给heap进行ion_buffer的申请。</p>
</li>
<li><p>3.ion会启动一个最低抢占权限的idle的内核线程，不断的循环ion_heap的free_list中的buffer进行销毁。同时注册shrink函数，进行压缩ion_page_pool中的page。</p>
</li>
<li><p>4.ion_handle会持有一个ion_buffer返回到上层。同时ion_buffer也会记录持有多少ion_handle。</p>
</li>
<li><p>5.当引用计数为0的时候，ion_buffer将会把数据销毁或者挡在ion_heap的free_list中。当等到ion_buffer执行销毁行为的时候，将会把当前ion _buffer放入到ion_heap中的ion_pages_pool的high_item和low_item的page链表。并且把数据清空。等到下次需要的时候就优先从pool总获取page。</p>
</li>
</ul>
<h2 id="ioctl发送ION-IOC-MAP命令"><a href="#ioctl发送ION-IOC-MAP命令" class="headerlink" title="ioctl发送ION_IOC_MAP命令"></a>ioctl发送ION_IOC_MAP命令</h2><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion.c" target="_blank" rel="noopener">ion.c</a></p>
<p>我们直接看ioctl的截选：</p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token keyword">case</span> ION_IOC_SHARE<span class="token punctuation">:</span>
    <span class="token keyword">case</span> ION_IOC_MAP<span class="token punctuation">:</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> ion_handle <span class="token operator">*</span>handle<span class="token punctuation">;</span>

        handle <span class="token operator">=</span> <span class="token function">ion_handle_get_by_id</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> data<span class="token punctuation">.</span>handle<span class="token punctuation">.</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>fd<span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token function">ion_share_dma_buf_fd</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ion_handle_put</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">.</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            ret <span class="token operator">=</span> data<span class="token punctuation">.</span>fd<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.通过client找之前ION_IOC_ALLOC生成的ion_handle。</li>
<li>2.ion_share_dma_buf_fd 绑定fd文件</li>
<li>3.ion_handle_put 设置ion_handle_put销毁函数。</li>
</ul>
<p>唯一需要注意的是ion_share_dma_buf_fd。</p>
<h3 id="ion-share-dma-buf-fd-生成dma共享缓存"><a href="#ion-share-dma-buf-fd-生成dma共享缓存" class="headerlink" title="ion_share_dma_buf_fd 生成dma共享缓存"></a>ion_share_dma_buf_fd 生成dma共享缓存</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">ion_share_dma_buf_fd</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client<span class="token punctuation">,</span> <span class="token keyword">struct</span> ion_handle <span class="token operator">*</span>handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> dma_buf <span class="token operator">*</span>dmabuf<span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>

    dmabuf <span class="token operator">=</span> <span class="token function">ion_share_dma_buf</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dmabuf<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>dmabuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">dma_buf_fd</span><span class="token punctuation">(</span>dmabuf<span class="token punctuation">,</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">dma_buf_put</span><span class="token punctuation">(</span>dmabuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行分两部分：</p>
<ul>
<li>1.ion_share_dma_buf 生成dma_buf</li>
<li>2.dma_buf_fd dma_buf和fd绑定</li>
</ul>
<h4 id="ion-share-dma-buf-生成dma-buf"><a href="#ion-share-dma-buf-生成dma-buf" class="headerlink" title="ion_share_dma_buf 生成dma_buf"></a>ion_share_dma_buf 生成dma_buf</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> dma_buf <span class="token operator">*</span><span class="token function">ion_share_dma_buf</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client<span class="token punctuation">,</span>
                        <span class="token keyword">struct</span> ion_handle <span class="token operator">*</span>handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> dma_buf <span class="token operator">*</span>dmabuf<span class="token punctuation">;</span>
    bool valid_handle<span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    valid_handle <span class="token operator">=</span> <span class="token function">ion_handle_validate</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    buffer <span class="token operator">=</span> handle<span class="token operator">-></span>buffer<span class="token punctuation">;</span>
    <span class="token function">ion_buffer_get</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    dmabuf <span class="token operator">=</span> <span class="token function">dma_buf_export</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dma_buf_ops<span class="token punctuation">,</span> buffer<span class="token operator">-></span>size<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">,</span>
                <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dmabuf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ion_buffer_put</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dmabuf<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> dmabuf<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中核心只有一个方法dma_buf_export，这个方法就是ion身为importer就是向身为exporter的dma_buf申请一段dma共享内存。同时为这一段内存设置一个特殊的操作结构体：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> dma_buf_ops dma_buf_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>map_dma_buf <span class="token operator">=</span> ion_map_dma_buf<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unmap_dma_buf <span class="token operator">=</span> ion_unmap_dma_buf<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>mmap <span class="token operator">=</span> ion_mmap<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> ion_dma_buf_release<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>begin_cpu_access <span class="token operator">=</span> ion_dma_buf_begin_cpu_access<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>end_cpu_access <span class="token operator">=</span> ion_dma_buf_end_cpu_access<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>kmap_atomic <span class="token operator">=</span> ion_dma_buf_kmap<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>kunmap_atomic <span class="token operator">=</span> ion_dma_buf_kunmap<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>kmap <span class="token operator">=</span> ion_dma_buf_kmap<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>kunmap <span class="token operator">=</span> ion_dma_buf_kunmap<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>dma_buf_ops中所有的操作都是关于mmap的映射操作。因此我们能推测出，实际上我们之后进行mmap内存应该就是操作这一段内存。</p>
<h3 id="dma-buf-export-exporter生产dma-buf"><a href="#dma-buf-export-exporter生产dma-buf" class="headerlink" title="dma_buf_export exporter生产dma_buf"></a>dma_buf_export exporter生产dma_buf</h3><p>dma_buf_export实际上是一个dma_buf_export_named的宏。</p>
<p>文件:/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/dma-buf/" target="_blank" rel="noopener">dma-buf</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/dma-buf/dma-buf.c" target="_blank" rel="noopener">dma-buf.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> dma_buf <span class="token operator">*</span><span class="token function">dma_buf_export_named</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>priv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> dma_buf_ops <span class="token operator">*</span>ops<span class="token punctuation">,</span>
                size_t size<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>exp_name<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> reservation_object <span class="token operator">*</span>resv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> dma_buf <span class="token operator">*</span>dmabuf<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">;</span>
    size_t alloc_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> dma_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resv<span class="token punctuation">)</span>
        alloc_size <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> reservation_object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token comment" spellcheck="true">/* prevent &amp;dma_buf[1] == dma_buf->resv */</span>
        alloc_size <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    dmabuf <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>alloc_size<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    dmabuf<span class="token operator">-></span>priv <span class="token operator">=</span> priv<span class="token punctuation">;</span>
    dmabuf<span class="token operator">-></span>ops <span class="token operator">=</span> ops<span class="token punctuation">;</span>
    dmabuf<span class="token operator">-></span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>
    dmabuf<span class="token operator">-></span>exp_name <span class="token operator">=</span> exp_name<span class="token punctuation">;</span>
    <span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dmabuf<span class="token operator">-></span>poll<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dmabuf<span class="token operator">-></span>cb_excl<span class="token punctuation">.</span>poll <span class="token operator">=</span> dmabuf<span class="token operator">-></span>cb_shared<span class="token punctuation">.</span>poll <span class="token operator">=</span> <span class="token operator">&amp;</span>dmabuf<span class="token operator">-></span>poll<span class="token punctuation">;</span>
    dmabuf<span class="token operator">-></span>cb_excl<span class="token punctuation">.</span>active <span class="token operator">=</span> dmabuf<span class="token operator">-></span>cb_shared<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> reservation_object <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dmabuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">reservation_object_init</span><span class="token punctuation">(</span>resv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    dmabuf<span class="token operator">-></span>resv <span class="token operator">=</span> resv<span class="token punctuation">;</span>

    file <span class="token operator">=</span> <span class="token function">anon_inode_getfile</span><span class="token punctuation">(</span><span class="token string">"dmabuf"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dma_buf_fops<span class="token punctuation">,</span> dmabuf<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>dmabuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">ERR_CAST</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    file<span class="token operator">-></span>f_mode <span class="token operator">|</span><span class="token operator">=</span> FMODE_LSEEK<span class="token punctuation">;</span>
    dmabuf<span class="token operator">-></span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>

    <span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dmabuf<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dmabuf<span class="token operator">-></span>attachments<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>db_list<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dmabuf<span class="token operator">-></span>list_node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>db_list<span class="token punctuation">.</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>db_list<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> dmabuf<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>设计上其实和ashmem进行内存和file关联的做法几乎一样。<br>核心的事情只有两件：</p>
<ul>
<li>1.初始化dmabuf中所有的参数。priv是ion_buffer，ops是dma_buf_ops，等待队列头，以及dmabuf的attachments链表，reservation_object,并把当前的dmabuf添加全局的dma_buf_list中。</li>
<li>2.anon_inode_getfile 把file设置了新的文件操作dma_buf_fops，并且把ion_buffer设置为file的私有数据。并让dmabuf持有file结构体<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> file_operations dma_buf_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span>release    <span class="token operator">=</span> dma_buf_release<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>mmap        <span class="token operator">=</span> dma_buf_mmap_internal<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>llseek        <span class="token operator">=</span> dma_buf_llseek<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>poll        <span class="token operator">=</span> dma_buf_poll<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>这里出现了dma_buf全新的结构体，我们稍微看看：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> dma_buf <span class="token punctuation">{</span>
    size_t size<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*关联的file结构体*/</span>
    <span class="token keyword">struct</span> list_head attachments<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> dma_buf_ops <span class="token operator">*</span>ops<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*dma_buf的mmap县官操作*/</span>
    <span class="token comment" spellcheck="true">/* mutex to serialize list manipulation, attach/detach and vmap/unmap */</span>
    <span class="token keyword">struct</span> mutex lock<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> vmapping_counter<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>vmap_ptr<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>exp_name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> list_head list_node<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>priv<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> reservation_object <span class="token operator">*</span>resv<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* poll support */</span>
    wait_queue_head_t poll<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*poll时候的等待队列*/</span>

    <span class="token keyword">struct</span> dma_buf_poll_cb_t <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> fence_cb cb<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*fence同步栅的回调*/</span>
        wait_queue_head_t <span class="token operator">*</span>poll<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*同步poll操作*/</span>

        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> active<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> cb_excl<span class="token punctuation">,</span> cb_shared<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="dma-buf-fd-dma-buf和fd绑定"><a href="#dma-buf-fd-dma-buf和fd绑定" class="headerlink" title="dma_buf_fd dma_buf和fd绑定"></a>dma_buf_fd dma_buf和fd绑定</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">dma_buf_fd</span><span class="token punctuation">(</span><span class="token keyword">struct</span> dma_buf <span class="token operator">*</span>dmabuf<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dmabuf <span class="token operator">||</span> <span class="token operator">!</span>dmabuf<span class="token operator">-></span>file<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">get_unused_fd_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> fd<span class="token punctuation">;</span>

    <span class="token function">fd_install</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> dmabuf<span class="token operator">-></span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，其实就是为dmabuf-&gt;file从当前进程中分配一个可用的fd句柄。最后上传到handle的fd中</p>
<h2 id="回顾gralloc-lock步骤中的mmap"><a href="#回顾gralloc-lock步骤中的mmap" class="headerlink" title="回顾gralloc lock步骤中的mmap"></a>回顾gralloc lock步骤中的mmap</h2><p>我们熟悉了ion驱动整个申请内存的原理，我们回过头来整个申请图元的步骤：</p>
<pre class="line-numbers language-c"><code class="language-c">    err <span class="token operator">=</span> <span class="token function">open_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>mIonFd<span class="token punctuation">,</span> ION_IOC_ALLOC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ionAllocData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    fd_data<span class="token punctuation">.</span>handle <span class="token operator">=</span> ionAllocData<span class="token punctuation">.</span>handle<span class="token punctuation">;</span>
    handle_data<span class="token punctuation">.</span>handle <span class="token operator">=</span> ionAllocData<span class="token punctuation">.</span>handle<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>mIonFd<span class="token punctuation">,</span> ION_IOC_MAP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ION_SECURE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        base <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ionAllocData<span class="token punctuation">.</span>len<span class="token punctuation">,</span> PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span>
                    MAP_SHARED<span class="token punctuation">,</span> fd_data<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ionAllocData<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Clean cache after memset</span>
        <span class="token function">clean_buffer</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> data<span class="token punctuation">.</span>size<span class="token punctuation">,</span> data<span class="token punctuation">.</span>offset<span class="token punctuation">,</span> fd_data<span class="token punctuation">.</span>fd<span class="token punctuation">,</span>
                     CACHE_CLEAN_AND_INVALIDATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    data<span class="token punctuation">.</span>base <span class="token operator">=</span> base<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd_data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
    <span class="token function">ioctl</span><span class="token punctuation">(</span>mIonFd<span class="token punctuation">,</span> ION_IOC_FREE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之前提到的ION_SECURE标志位，就在createBufferLayer方法中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t SurfaceFlinger<span class="token operator">::</span><span class="token function">createBufferLayer</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Client<span class="token operator">></span><span class="token operator">&amp;</span> client<span class="token punctuation">,</span>
        <span class="token keyword">const</span> String8<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> uint32_t w<span class="token punctuation">,</span> uint32_t h<span class="token punctuation">,</span> uint32_t flags<span class="token punctuation">,</span> PixelFormat<span class="token operator">&amp;</span> format<span class="token punctuation">,</span>
        sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">*</span> handle<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">></span><span class="token operator">*</span> gbp<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>Layer<span class="token operator">></span><span class="token operator">*</span> outLayer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    sp<span class="token operator">&lt;</span>BufferLayer<span class="token operator">></span> layer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BufferLayer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> client<span class="token punctuation">,</span> name<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    status_t err <span class="token operator">=</span> layer<span class="token operator">-</span><span class="token operator">></span><span class="token function">setBuffers</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> format<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

status_t BufferLayer<span class="token operator">::</span><span class="token function">setBuffers</span><span class="token punctuation">(</span>uint32_t w<span class="token punctuation">,</span> uint32_t h<span class="token punctuation">,</span> PixelFormat format<span class="token punctuation">,</span> uint32_t flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint32_t <span class="token keyword">const</span> maxSurfaceDims <span class="token operator">=</span>
            <span class="token function">min</span><span class="token punctuation">(</span>mFlinger<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMaxTextureSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mFlinger<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMaxViewportDims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">uint32_t</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token operator">></span> maxSurfaceDims<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">uint32_t</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token operator">></span> maxSurfaceDims<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> BAD_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mFormat <span class="token operator">=</span> format<span class="token punctuation">;</span>

    mPotentialCursor <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ISurfaceComposerClient<span class="token operator">::</span>eCursorWindow<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    mProtectedByApp <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ISurfaceComposerClient<span class="token operator">::</span>eProtectedByApp<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    mCurrentOpacity <span class="token operator">=</span> <span class="token function">getOpacityForFormat</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mConsumer<span class="token operator">-</span><span class="token operator">></span><span class="token function">setDefaultBufferSize</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mConsumer<span class="token operator">-</span><span class="token operator">></span><span class="token function">setDefaultBufferFormat</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mConsumer<span class="token operator">-</span><span class="token operator">></span><span class="token function">setConsumerUsageBits</span><span class="token punctuation">(</span><span class="token function">getEffectiveUsage</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个flag是SurfaceComposerClient传入的。此时是0，也就是说没有打开ION_SECURE。将会走mmap的if里面，其中fd_data.fd其实就是dma_buf关联file对应的fd信息。</p>
<h2 id="dma-buf-file的mmap"><a href="#dma-buf-file的mmap" class="headerlink" title="dma_buf file的mmap"></a>dma_buf file的mmap</h2><p>从上面的信息可以指知道，此时调用file文件的mmap其实就调用dma_buf_mmap_internal。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dma_buf_mmap_internal</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">struct</span> vm_area_struct <span class="token operator">*</span>vma<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> dma_buf <span class="token operator">*</span>dmabuf<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dma_buf_file</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    dmabuf <span class="token operator">=</span> file<span class="token operator">-></span>private_data<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* check for overflowing the buffer's size */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_pgoff <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_end <span class="token operator">-</span> vma<span class="token operator">-></span>vm_start<span class="token punctuation">)</span> <span class="token operator">>></span> PAGE_SHIFT<span class="token punctuation">)</span> <span class="token operator">></span>
        dmabuf<span class="token operator">-></span>size <span class="token operator">>></span> PAGE_SHIFT<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">return</span> dmabuf<span class="token operator">-></span>ops<span class="token operator">-></span><span class="token function">mmap</span><span class="token punctuation">(</span>dmabuf<span class="token punctuation">,</span> vma<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时调用了dmabuf 缓冲区的mmap，此时dmabuf的mmap操作符就是指ion_mmap</p>
<h3 id="ion-mmap"><a href="#ion-mmap" class="headerlink" title="ion_mmap"></a>ion_mmap</h3><p>文件：<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion.c" target="_blank" rel="noopener">ion.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ion_mmap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> dma_buf <span class="token operator">*</span>dmabuf<span class="token punctuation">,</span> <span class="token keyword">struct</span> vm_area_struct <span class="token operator">*</span>vma<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer <span class="token operator">=</span> dmabuf<span class="token operator">-></span>priv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token operator">-></span>heap<span class="token operator">-></span>ops<span class="token operator">-></span>map_user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: this heap does not define a method for mapping to userspace\n"</span><span class="token punctuation">,</span>
            <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ion_buffer_fault_user_mappings</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vma<span class="token operator">-></span>vm_flags <span class="token operator">|</span><span class="token operator">=</span> VM_IO <span class="token operator">|</span> VM_PFNMAP <span class="token operator">|</span> VM_DONTEXPAND <span class="token operator">|</span>
                            VM_DONTDUMP<span class="token punctuation">;</span>
        vma<span class="token operator">-></span>vm_private_data <span class="token operator">=</span> buffer<span class="token punctuation">;</span>
        vma<span class="token operator">-></span>vm_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>ion_vma_ops<span class="token punctuation">;</span>
        <span class="token function">ion_vm_open</span><span class="token punctuation">(</span>vma<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>buffer<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ION_FLAG_CACHED<span class="token punctuation">)</span><span class="token punctuation">)</span>
        vma<span class="token operator">-></span>vm_page_prot <span class="token operator">=</span> <span class="token function">pgprot_writecombine</span><span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_page_prot<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> buffer<span class="token operator">-></span>heap<span class="token operator">-></span>ops<span class="token operator">-></span><span class="token function">map_user</span><span class="token punctuation">(</span>buffer<span class="token operator">-></span>heap<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> vma<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: failure mapping buffer to userspace\n"</span><span class="token punctuation">,</span>
               <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool <span class="token function">ion_buffer_fault_user_mappings</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>buffer<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ION_FLAG_CACHED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>buffer<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ION_FLAG_CACHED_NEEDS_SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.ion_buffer_fault_user_mappings判断需要使用默认的缓存，也就是DMA缓存，跳过pool的缓存模式。这种模式下只依赖DMA，只会为vma虚拟内存设置操作符，接着调用ion_vm_open的方法访问虚拟内存。</li>
<li>2.pgprot_writecombine不禁止写缓存，调用ion_heap 的map_user方法。</li>
</ul>
<p>我们先不考察直接依赖DMA，我们看看heap中的map_user ion_heap_map_user。</p>
<h4 id="ion-system-heap-ion-heap-map-user"><a href="#ion-system-heap-ion-heap-map-user" class="headerlink" title="ion_system_heap ion_heap_map_user"></a>ion_system_heap ion_heap_map_user</h4><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion_heap.c" target="_blank" rel="noopener">ion_heap.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">ion_heap_map_user</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_heap <span class="token operator">*</span>heap<span class="token punctuation">,</span> <span class="token keyword">struct</span> ion_buffer <span class="token operator">*</span>buffer<span class="token punctuation">,</span>
              <span class="token keyword">struct</span> vm_area_struct <span class="token operator">*</span>vma<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sg_table <span class="token operator">*</span>table <span class="token operator">=</span> buffer<span class="token operator">-></span>sg_table<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> addr <span class="token operator">=</span> vma<span class="token operator">-></span>vm_start<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> offset <span class="token operator">=</span> vma<span class="token operator">-></span>vm_pgoff <span class="token operator">*</span> PAGE_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> scatterlist <span class="token operator">*</span>sg<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token function">for_each_sg</span><span class="token punctuation">(</span>table<span class="token operator">-></span>sgl<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> table<span class="token operator">-></span>nents<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> page <span class="token operator">*</span>page <span class="token operator">=</span> <span class="token function">sg_page</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> remainder <span class="token operator">=</span> vma<span class="token operator">-></span>vm_end <span class="token operator">-</span> addr<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len <span class="token operator">=</span> sg<span class="token operator">-></span>length<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">>=</span> sg<span class="token operator">-></span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            offset <span class="token operator">-</span><span class="token operator">=</span> sg<span class="token operator">-></span>length<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            page <span class="token operator">+</span><span class="token operator">=</span> offset <span class="token operator">/</span> PAGE_SIZE<span class="token punctuation">;</span>
            len <span class="token operator">=</span> sg<span class="token operator">-></span>length <span class="token operator">-</span> offset<span class="token punctuation">;</span>
            offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        len <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> remainder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">remap_pfn_range</span><span class="token punctuation">(</span>vma<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token function">page_to_pfn</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span>
                vma<span class="token operator">-></span>vm_page_prot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        addr <span class="token operator">+</span><span class="token operator">=</span> len<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">>=</span> vma<span class="token operator">-></span>vm_end<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的核心就是把scatterlist存储的地址还原为page，获取这段虚拟地址vma的偏移量，计算出需要获取多少page。然后从sg_table中分配scatterlist中的page给这段虚拟内存。</p>
<p>这样就让上层内存和底层管理的page关联到一起</p>
<h2 id="ioctl-ION-IOC-FREE-释放底层的句柄"><a href="#ioctl-ION-IOC-FREE-释放底层的句柄" class="headerlink" title="ioctl ION_IOC_FREE 释放底层的句柄"></a>ioctl ION_IOC_FREE 释放底层的句柄</h2><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/drivers/" target="_blank" rel="noopener">drivers</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/" target="_blank" rel="noopener">staging</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/" target="_blank" rel="noopener">ion</a>/<a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/ion/ion.c" target="_blank" rel="noopener">ion.c</a></p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token keyword">case</span> ION_IOC_FREE<span class="token punctuation">:</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> ion_handle <span class="token operator">*</span>handle<span class="token punctuation">;</span>

        handle <span class="token operator">=</span> <span class="token function">ion_handle_get_by_id</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> data<span class="token punctuation">.</span>handle<span class="token punctuation">.</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ion_free</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ion_handle_put</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过client找到handle之后调用ion_free，使用ion_handle_put减少ion_handle的引用计数。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">ion_free</span><span class="token punctuation">(</span><span class="token keyword">struct</span> ion_client <span class="token operator">*</span>client<span class="token punctuation">,</span> <span class="token keyword">struct</span> ion_handle <span class="token operator">*</span>handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    bool valid_handle<span class="token punctuation">;</span>

    <span class="token function">BUG_ON</span><span class="token punctuation">(</span>client <span class="token operator">!=</span> handle<span class="token operator">-></span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    valid_handle <span class="token operator">=</span> <span class="token function">ion_handle_validate</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valid_handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">WARN</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%s: invalid handle passed to free.\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ion_handle_put</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>等到计数归0将会调用上面说过的handle回收机制。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>先用一幅图来总结整个结构和流程：<br><img src="/images/GraphicBuffer%E5%92%8Cion.png" alt="GraphicBuffer和ion.png"></p>
<p>先来看初始化：<br>整个ion的初始化到这一步就完成，从device驱动结构体到缓存的核心ion_handle初始化。</p>
<ul>
<li><p>1.ion_device将会持有一个clients的红黑树，对所有的通过open进来的client，为file设置私有数据我为client。一个buffers红黑树，用于全局控制ion_buffer。一个ion_heap红黑树，用于管理所有类型ion_heap。</p>
</li>
<li><p>2.ion_heap 持有一个ion_page_pool，在这个资源池子里面控制不同规格的内存块。当heap需要申请的内存时候，将会从ion_page_pool找到对应index下的内存页page划分给heap进行ion_buffer的申请。</p>
</li>
<li><p>3.ion会启动一个最低抢占权限的idle的内核线程，不断的循环ion_heap的free_list中的buffer进行销毁。同时注册shrink函数，进行压缩ion_page_pool中的page。</p>
</li>
<li><p>4.ion_handle会持有一个ion_buffer返回到上层。同时ion_buffer也会记录持有多少ion_handle。</p>
</li>
<li><p>5.当引用计数为0的时候，ion_buffer将会把数据销毁或者挡在ion_heap的free_list中。当等到ion_buffer执行销毁行为的时候，将会把当前ion _buffer放入到ion_heap中的ion_pages_pool的high_item和low_item的page链表。并且把数据清空。等到下次需要的时候就优先从pool总获取page。</p>
</li>
</ul>
<p>接着再来看ioctl几个命令：</p>
<ul>
<li><ol>
<li>ION_IOC_ALLOC 实际上是从io_heap的io_pages_pool找到合适大小的page交给ion_buffer去管理。同时ion_buffer不会直接控制page，而是交给sg_table的scatterlist中保存page的地址。最后ion_buffer会被ion_handle包裹返回用户空间。</li>
</ol>
</li>
<li><ol start="2">
<li>ION_IOC_MAP 调用dma_buf生成一个dmabuf缓冲区，并且和ion_handle中的fd句柄进行关联。</li>
</ol>
</li>
<li><ol start="3">
<li>ION_IOC_FREE 当用完了记住要释放底层对应ion_handle，不过在这里是减少handle引用计数。每销毁一个ion_handle也会减少一个ion_buffer的handle计数，同时减少ion_buffer的引用计数。</li>
</ol>
</li>
</ul>
<p>最后是mmap：<br>对于mmap来说，其实就是把dmabuf中的file和ion_buffer的sg_table的scatterlist中page进行绑定处理，实现内存共享。</p>
<p>在使用上，我们需要抓住一个要点，fd的转化就能彻底明白了：<br>先使用ion驱动的fd，接着通过ioctl发送ION_IOC_MAP，之后所有就会使用关联dma_buf的file对应的fd。</p>
<p>之后通过跨进程通信，无论是SF还是App应用进程，只要持有native_handle_t的句柄就能找到importBuffer保存在GrallocImportedInstancePool的句柄，其中的fd就能找到GraphicBuffer中的共享内存。</p>
<p>注意这里不需要Binder的fd的转化，是因为整个GraphicBufferAllocator的hal层和GraphicBufferMapper的hal层都在自己的进程。实际上每次沟通Hal层也是一个类似Binder一样的跨进程操作。所以fd得到申请是收到SF和Hal进程的fd_table的限制的。因此才把真正实例化GraphicBuffer放在SF中同时限制了一个Layer最大只能有64个GraphicBuffer，不允许别人乱实例化。</p>
<p>最后我们在根据ion的功能重新看看GraphicBuffer的几个操作：</p>
<ul>
<li><ol>
<li>dequeue生成一个新的GraphicBuffer或者找到一个旧的GraphicBuffer。如果是新的，将会在SF进程，通过GraphicBufferAllcator进行申请，实际上就会通过ion申请一段共享内存。其中ION_IOC_MAP将会生成一个新的fd，这个fd是关联着dmabuf一个匿名共享文件。之后所有的操作就是操作这个file。同时在SF还会再进行一次mmap映射，保证能够在底层操作。</li>
</ol>
</li>
<li><ol start="2">
<li>requestBuffer 将会通过Binder机制获取到GraphicBuffer的native_handle_t，这个句柄中的fd将会底层强转成ion_handle，里面有fd作为找到匿名文件的标示。</li>
</ol>
</li>
<li><ol start="3">
<li>同时会进行GraphicBufferMapper.importBuffer，保存native_handle_t到GrallocImportedInstancePool中。并且会通过mmap映射这个匿名文件到一段固定大小的虚拟地址。并且把地址保存在native_handle_t的base中。</li>
</ol>
</li>
<li><ol start="4">
<li>lock 根据像素规格，宽高映射native_handle_t的base获取一段合适大小的共享内存，并且把native_handle_t的base的地址和GraphicBuffer的bits进行关联。</li>
</ol>
</li>
</ul>
<p>只有经过这几个步骤，我们才能正常使用的GraphicBuffer。</p>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>那么ion和ashmem比较有什么区别。ashmem在设计层面上和ion十分相似。也是先通过ashmem访问获取对应匿名内存文件的fd。最后所有的访问都是在这段内存文件上处理。</p>
<p>但是有一点是ashmem怎么也无法比的，那就是ion实际上是生成DMA直接访问内存。原本ashmem的方式需要从GPU访问到CPU再到内存中的地址。但是在这里就变成了GPU直接访问修改DMA，CPU也能直接修改DMA。</p>
<p>其次就是那就是ion很好的处理了不同内核模块，进程之间共享内存的问题。</p>
<p>在ion中有一个很低优先级的内核线程在不断的回收free_list中的ion_buffer。可以比做gc线程一样。不过没有gc设计这么复杂。同时每一次申请都会经过heap的pool尝试请求已经回收的page。这样享元设计很值得学习。在底层同时会不断计算ion_buffer的引用计数。当归0将会把ion_buffer移动到free_list中。</p>
<p>这也是为什么，我们在使用后记住要清除内存中的数据。因为不一定及时清除。</p>
<p>要知道一个屏幕的像素可是十分大的，有了这些内存回收的设计，为系统系统腾出更多的内存。这就是为什么要选择ion。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/02/14/android-chong-xue-xi-lie-tu-yuan-de-xiao-fei/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="Android 重学系列 图元的消费">
                        
                        <span class="card-title">Android 重学系列 图元的消费</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言经过前两篇文章的解析，我们彻底的理解GraphicBuffer的生产端究竟做了什么。本文就来讨论GraphicBuffer是怎么消费。
整个图元的消费到合成，最后到通过hwc发送到fb。由于整个流程十分长，中间有许多细节，我将会挑出核心
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-02-14
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/01/31/android-chong-xue-xi-lie-graphicbuffer-de-dan-sheng/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="Android 重学系列 GraphicBuffer的诞生">
                        
                        <span class="card-title">Android 重学系列 GraphicBuffer的诞生</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言经过上一篇对OpenGL es的解析，我们引出了在eglSwapBuffer时候会调用会调用两个关键的方法：

1.Surface::dequeueBuffer
2.Surface::queueBuffer

从上一篇openGL es
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-01-31
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
