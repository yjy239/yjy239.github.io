<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 GraphicBuffer的诞生, Android | Linux | Flutter">
    <meta name="description" content="前言经过上一篇对OpenGL es的解析，我们引出了在eglSwapBuffer时候会调用会调用两个关键的方法：

1.Surface::dequeueBuffer
2.Surface::queueBuffer

从上一篇openGL es">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 GraphicBuffer的诞生 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 GraphicBuffer的诞生
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                SurfaceFlinger
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-01-31
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        9.7k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        47 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>经过上一篇对OpenGL es的解析，我们引出了在eglSwapBuffer时候会调用会调用两个关键的方法：</p>
<ul>
<li>1.Surface::dequeueBuffer</li>
<li>2.Surface::queueBuffer</li>
</ul>
<p>从上一篇openGL es分析可以得出，每一次当我们绘制完一次图元之后，surface做为生产者一方会在一个循环中一般依次完成如下内容：</p>
<ul>
<li>1.dequeueBuffer 获取一个图元的插槽位置，或者生产一个图元</li>
<li>2.lock 锁定图元</li>
<li>3.queueBuffer 把图元放入缓冲队列中</li>
<li>4.unlock 解锁图元</li>
</ul>
<p>对于生产者来说关键的是这四个步骤。不过openGL es把整个过程颠倒，每一次绘制上一帧，对于更加好理解，我把整个过程设置回Android常用的方式。我们分别来研究这几个函数做了什么。</p>
<p>遇到什么问题，欢迎来本文进行讨论<a href="https://www.jianshu.com/p/3bfc0053d254" target="_blank" rel="noopener">https://www.jianshu.com/p/3bfc0053d254</a></p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>首先我们先不去深究细节，先对整个流程的源码流程有一个大体印象。因为图元的诞生不清楚，也看不懂其他原理。</p>
<h3 id="egl-lock-锁定图元"><a href="#egl-lock-锁定图元" class="headerlink" title="egl lock 锁定图元"></a>egl lock 锁定图元</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/opengl/" target="_blank" rel="noopener">opengl</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/opengl/libagl/" target="_blank" rel="noopener">libagl</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/opengl/libagl/egl.cpp" target="_blank" rel="noopener">egl.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t egl_window_surface_v2_t<span class="token operator">::</span><span class="token function">lock</span><span class="token punctuation">(</span>
        ANativeWindowBuffer<span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> usage<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> vaddr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">auto</span><span class="token operator">&amp;</span> mapper <span class="token operator">=</span> GraphicBufferMapper<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span>buf<span class="token operator">-</span><span class="token operator">></span>handle<span class="token punctuation">,</span> usage<span class="token punctuation">,</span>
            android<span class="token operator">::</span><span class="token function">Rect</span><span class="token punctuation">(</span>buf<span class="token operator">-</span><span class="token operator">></span>width<span class="token punctuation">,</span> buf<span class="token operator">-</span><span class="token operator">></span>height<span class="token punctuation">)</span><span class="token punctuation">,</span> vaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在lock函数实际上是把ANativeWindowBuffer的handle传进去进行锁定，同时传入了一个vaddr的地址，这个地址是做什么的呢？其实就是共享buffer中的图元存储的地址。</p>
<p>实际上上在lock的时候，并不是直接把buffer传下去，而是传递一个handle，一个ANativeWindowBuffer的句柄。</p>
<h2 id="dequeueBuffer-获取一个图元的插槽位置，或者生产一个图元"><a href="#dequeueBuffer-获取一个图元的插槽位置，或者生产一个图元" class="headerlink" title="dequeueBuffer 获取一个图元的插槽位置，或者生产一个图元"></a>dequeueBuffer 获取一个图元的插槽位置，或者生产一个图元</h2><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/Surface.cpp" target="_blank" rel="noopener">Surface.cpp</a></p>
<p>先介绍Surface的核心对象之一mSlot，这个对象是数组BufferSlot：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> BufferSlot <span class="token punctuation">{</span>

    <span class="token function">BufferSlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">mGraphicBuffer</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mEglDisplay</span><span class="token punctuation">(</span>EGL_NO_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mBufferState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mRequestBufferCalled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mFrameNumber</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mEglFence</span><span class="token punctuation">(</span>EGL_NO_SYNC_KHR<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mFence</span><span class="token punctuation">(</span>Fence<span class="token operator">::</span>NO_FENCE<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mAcquireCalled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mNeedsReallocation</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span> mGraphicBuffer<span class="token punctuation">;</span>

    EGLDisplay mEglDisplay<span class="token punctuation">;</span>

    BufferState mBufferState<span class="token punctuation">;</span>


    <span class="token keyword">bool</span> mRequestBufferCalled<span class="token punctuation">;</span>


    uint64_t mFrameNumber<span class="token punctuation">;</span>


    EGLSyncKHR mEglFence<span class="token punctuation">;</span>

    sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span> mFence<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Indicates whether this buffer has been seen by a consumer yet</span>
    <span class="token keyword">bool</span> mAcquireCalled<span class="token punctuation">;</span>


    <span class="token keyword">bool</span> mNeedsReallocation<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里面保存着几个很重要对象：</p>
<ul>
<li>1.GraphicBuffer 图元缓冲对象</li>
<li>2.mEglDisplay opengl es的屏幕对象，实际上就是egl_display_t</li>
<li>3.BufferState 图元状态</li>
<li>4.EGLSyncKHR opengl es的同步栅</li>
<li>5.Fence 同步栅</li>
</ul>
<p>在这里先介绍一个重要的概念，每一个GraphicBuffer图元在不同的流程会分为5个状态都会在BufferState记录状态：</p>
<ul>
<li>1.free 图元是自由的等待dequeue使用</li>
<li>2.dequeue SF中缓冲队列的插槽对应index的图元要么找到一个free的图元，要么就申请一个出来。</li>
<li>3.queue 从dequeue出来的图元，经过queueBuffer进入到SF进行刷新界面时候读取出来进行渲染</li>
<li>4.acquire 当SF的图元消费者进行消费之后，将会把这个状态设置为Acquire</li>
<li>4.share 共享图元 这种模式比较特殊，这种模式下能够和其他三个模式并存，只是这种模式下只会整个Layer进行绘制使用同一个图元绘制。</li>
</ul>
<p>根据这些状态，在SF中对应的计数个数不一样，这些计数影响着SF是否需要调整整个mSlot的使用策略。<br>图元状态|mShared|mDequeueCount|mQueueCount|mAcquireCount<br>-|-|-|-|-<br>FREE|false|0|0|0<br>DEQUEUED|false|1|0|0<br>QUEUED|false|0|1|0<br>ACQUIRED|false|0|0|1<br>SHARED|true|any|any|any</p>
<ul>
<li>1.mShared 代表该图元是共享的</li>
<li>2.mDequeueCount 有多少图元是否出队，被应用程序正在处理</li>
<li>3.mQueueCount 有多少图元已经入队，正在等待被消费者消费</li>
<li>4.mAcquireCount 有多少图元正在被消费。</li>
</ul>
<p>因此当我们需要进行调整，需要对mDequeueCount+mAcquireCount加入调整计算，这样才能知道一共有多少图元在缓冲队伍之外，才能正确的计算，是否应该调整BufferQueue.mSlot的策略。在图元缓冲队列初始化那一章中，能看到会计算mMaxAcquiredBufferCount和mMaxDequeuedBufferCount的数量，来控制每一个Layer的图元生产者的是否需要调整slot为新的GraphicBuffer腾出位置。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> Surface<span class="token operator">::</span><span class="token function">dequeueBuffer</span><span class="token punctuation">(</span>android_native_buffer_t<span class="token operator">*</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> fenceFd<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    uint32_t reqWidth<span class="token punctuation">;</span>
    uint32_t reqHeight<span class="token punctuation">;</span>
    PixelFormat reqFormat<span class="token punctuation">;</span>
    uint64_t reqUsage<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> enableFrameTimestamps<span class="token punctuation">;</span>

    <span class="token punctuation">{</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mReportRemovedBuffers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mRemovedBuffers<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        reqWidth <span class="token operator">=</span> mReqWidth <span class="token operator">?</span> mReqWidth <span class="token operator">:</span> mUserWidth<span class="token punctuation">;</span>
        reqHeight <span class="token operator">=</span> mReqHeight <span class="token operator">?</span> mReqHeight <span class="token operator">:</span> mUserHeight<span class="token punctuation">;</span>

        reqFormat <span class="token operator">=</span> mReqFormat<span class="token punctuation">;</span>
        reqUsage <span class="token operator">=</span> mReqUsage<span class="token punctuation">;</span>

        enableFrameTimestamps <span class="token operator">=</span> mEnableFrameTimestamps<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSharedBufferMode <span class="token operator">&amp;&amp;</span> mAutoRefresh <span class="token operator">&amp;&amp;</span> mSharedBufferSlot <span class="token operator">!=</span>
                BufferItem<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">gbuf</span><span class="token punctuation">(</span>mSlots<span class="token punctuation">[</span>mSharedBufferSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>gbuf <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>buffer <span class="token operator">=</span> gbuf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>fenceFd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// Drop the lock so that we can still touch the Surface while blocking in IGBP::dequeueBuffer</span>

    <span class="token keyword">int</span> buf <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span> fence<span class="token punctuation">;</span>
    nsecs_t startTime <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    FrameEventHistoryDelta frameTimestamps<span class="token punctuation">;</span>
    status_t result <span class="token operator">=</span> mGraphicBufferProducer<span class="token operator">-</span><span class="token operator">></span><span class="token function">dequeueBuffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fence<span class="token punctuation">,</span> reqWidth<span class="token punctuation">,</span> reqHeight<span class="token punctuation">,</span>
                                                            reqFormat<span class="token punctuation">,</span> reqUsage<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mBufferAge<span class="token punctuation">,</span>
                                                            enableFrameTimestamps <span class="token operator">?</span> <span class="token operator">&amp;</span>frameTimestamps
                                                                                  <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mLastDequeueDuration <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>buf <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> buf <span class="token operator">>=</span> NUM_BUFFER_SLOTS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> FAILED_TRANSACTION<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Write this while holding the mutex</span>
    mLastDequeueStartTime <span class="token operator">=</span> startTime<span class="token punctuation">;</span>

    sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">gbuf</span><span class="token punctuation">(</span>mSlots<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// this should never happen</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;</span> IGraphicBufferProducer<span class="token operator">::</span>RELEASE_ALL_BUFFERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">freeAllBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableFrameTimestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         mFrameEventHistory<span class="token operator">-</span><span class="token operator">></span><span class="token function">applyDelta</span><span class="token punctuation">(</span>frameTimestamps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>result <span class="token operator">&amp;</span> IGraphicBufferProducer<span class="token operator">::</span>BUFFER_NEEDS_REALLOCATION<span class="token punctuation">)</span> <span class="token operator">||</span> gbuf <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mReportRemovedBuffers <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>gbuf <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mRemovedBuffers<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>gbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result <span class="token operator">=</span> mGraphicBufferProducer<span class="token operator">-</span><span class="token operator">></span><span class="token function">requestBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mGraphicBufferProducer<span class="token operator">-</span><span class="token operator">></span><span class="token function">cancelBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> fence<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fence<span class="token operator">-</span><span class="token operator">></span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>fenceFd <span class="token operator">=</span> fence<span class="token operator">-</span><span class="token operator">></span><span class="token function">dup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>fenceFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>fenceFd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>buffer <span class="token operator">=</span> gbuf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mSharedBufferMode <span class="token operator">&amp;&amp;</span> mAutoRefresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mSharedBufferSlot <span class="token operator">=</span> buf<span class="token punctuation">;</span>
        mSharedBufferHasBeenQueued <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mSharedBufferSlot <span class="token operator">==</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mSharedBufferSlot <span class="token operator">=</span> BufferItem<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">;</span>
        mSharedBufferHasBeenQueued <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>流程如下：</p>
<ul>
<li>1.如果是共享图元模式，则只会获取mSharedBufferSlot记录的在共享图元在mShared的位置，直接返回对的index。</li>
<li>2.调用SF的dequeueBuffer方法，在SF尝试的获取图元对应的位置。</li>
<li>3.如果返回的result超出了NUM_BUFFER_SLOTS，则返回一场。判断返回的命令决定是否释放在客户端中的mSlot</li>
<li>4.如果判断到BUFFER_NEEDS_REALLOCATION需要重新申请图元，则调用requestBuffer，拿到新申请图元的保存到客户端进程。</li>
</ul>
<p>让我们重点关注SF的dequeueBuffer。</p>
<h3 id="BufferQueueProducer-dequeueBuffer"><a href="#BufferQueueProducer-dequeueBuffer" class="headerlink" title="BufferQueueProducer dequeueBuffer"></a>BufferQueueProducer dequeueBuffer</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/BufferQueueProducer.cpp" target="_blank" rel="noopener">BufferQueueProducer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferQueueProducer<span class="token operator">::</span><span class="token function">dequeueBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> outSlot<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>android<span class="token operator">::</span>Fence<span class="token operator">></span><span class="token operator">*</span> outFence<span class="token punctuation">,</span>
                                            uint32_t width<span class="token punctuation">,</span> uint32_t height<span class="token punctuation">,</span> PixelFormat format<span class="token punctuation">,</span>
                                            uint64_t usage<span class="token punctuation">,</span> uint64_t<span class="token operator">*</span> outBufferAge<span class="token punctuation">,</span>
                                            FrameEventHistoryDelta<span class="token operator">*</span> outTimestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Autolock scope</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mConsumerName <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mConsumerName<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mIsAbandoned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> NO_INIT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mConnectedApi <span class="token operator">==</span> BufferQueueCore<span class="token operator">::</span>NO_CONNECTED_API<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> NO_INIT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// Autolock scope</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>width <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>height<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>width <span class="token operator">&amp;&amp;</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> BAD_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    status_t returnFlags <span class="token operator">=</span> NO_ERROR<span class="token punctuation">;</span>
    EGLDisplay eglDisplay <span class="token operator">=</span> EGL_NO_DISPLAY<span class="token punctuation">;</span>
    EGLSyncKHR eglFence <span class="token operator">=</span> EGL_NO_SYNC_KHR<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> attachedByConsumer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Autolock scope</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCore<span class="token operator">-</span><span class="token operator">></span><span class="token function">waitWhileAllocatingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>format <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            format <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mDefaultBufferFormat<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Enable the usage bits the consumer requested</span>
        usage <span class="token operator">|</span><span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mConsumerUsageBits<span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token keyword">bool</span> useDefaultSize <span class="token operator">=</span> <span class="token operator">!</span>width <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>height<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>useDefaultSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            width <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mDefaultWidth<span class="token punctuation">;</span>
            height <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mDefaultHeight<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> found <span class="token operator">=</span> BufferItem<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>found <span class="token operator">==</span> BufferItem<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            status_t status <span class="token operator">=</span> <span class="token function">waitForFreeSlotThenRelock</span><span class="token punctuation">(</span>FreeSlotCaller<span class="token operator">::</span>Dequeue<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>found<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> status<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// This should not happen</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>found <span class="token operator">==</span> BufferQueueCore<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">buffer</span><span class="token punctuation">(</span>mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mGraphicBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mCore<span class="token operator">-</span><span class="token operator">></span>mAllowAllocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token operator">-</span><span class="token operator">></span><span class="token function">needsReallocation</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> format<span class="token punctuation">,</span> BQ_LAYER_COUNT<span class="token punctuation">,</span> usage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">==</span> found<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> BAD_VALUE<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mCore<span class="token operator">-</span><span class="token operator">></span>mFreeSlots<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mCore<span class="token operator">-</span><span class="token operator">></span><span class="token function">clearBufferSlotLocked</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    found <span class="token operator">=</span> BufferItem<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">buffer</span><span class="token punctuation">(</span>mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mGraphicBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">==</span> found <span class="token operator">&amp;&amp;</span>
                buffer<span class="token operator">-</span><span class="token operator">></span><span class="token function">needsReallocation</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> format<span class="token punctuation">,</span> BQ_LAYER_COUNT<span class="token punctuation">,</span> usage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> BAD_VALUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">!=</span> found<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mActiveBuffers<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">*</span>outSlot <span class="token operator">=</span> found<span class="token punctuation">;</span>
        <span class="token function">ATRACE_BUFFER_INDEX</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">;</span>

        attachedByConsumer <span class="token operator">=</span> mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mNeedsReallocation<span class="token punctuation">;</span>
        mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mNeedsReallocation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                buffer<span class="token operator">-</span><span class="token operator">></span><span class="token function">needsReallocation</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> format<span class="token punctuation">,</span> BQ_LAYER_COUNT<span class="token punctuation">,</span> usage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mAcquireCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mGraphicBuffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mRequestBufferCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mEglDisplay <span class="token operator">=</span> EGL_NO_DISPLAY<span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mEglFence <span class="token operator">=</span> EGL_NO_SYNC_KHR<span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence <span class="token operator">=</span> Fence<span class="token operator">::</span>NO_FENCE<span class="token punctuation">;</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mBufferAge <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mIsAllocating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            returnFlags <span class="token operator">|</span><span class="token operator">=</span> BUFFER_NEEDS_REALLOCATION<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// We add 1 because that will be the frame number when this buffer</span>
            <span class="token comment" spellcheck="true">// is queued</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mBufferAge <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mFrameCounter <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">-</span> mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mFrameNumber<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span>mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        eglDisplay <span class="token operator">=</span> mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mEglDisplay<span class="token punctuation">;</span>
        eglFence <span class="token operator">=</span> mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mEglFence<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Don't return a fence in shared buffer mode, except for the first</span>
        <span class="token comment" spellcheck="true">// frame.</span>
        <span class="token operator">*</span>outFence <span class="token operator">=</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferMode <span class="token operator">&amp;&amp;</span>
                mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">==</span> found<span class="token punctuation">)</span> <span class="token operator">?</span>
                Fence<span class="token operator">::</span>NO_FENCE <span class="token operator">:</span> mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence<span class="token punctuation">;</span>
        mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mEglFence <span class="token operator">=</span> EGL_NO_SYNC_KHR<span class="token punctuation">;</span>
        mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence <span class="token operator">=</span> Fence<span class="token operator">::</span>NO_FENCE<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferMode <span class="token operator">&amp;&amp;</span> mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">==</span>
                BufferQueueCore<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">=</span> found<span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span>mShared <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// Autolock scope</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFlags <span class="token operator">&amp;</span> BUFFER_NEEDS_REALLOCATION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span> graphicBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">GraphicBuffer</span><span class="token punctuation">(</span>
                width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> format<span class="token punctuation">,</span> BQ_LAYER_COUNT<span class="token punctuation">,</span> usage<span class="token punctuation">,</span>
                <span class="token punctuation">{</span>mConsumerName<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mConsumerName<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        status_t error <span class="token operator">=</span> graphicBuffer<span class="token operator">-</span><span class="token operator">></span><span class="token function">initCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Autolock scope</span>
            Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> NO_ERROR <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mCore<span class="token operator">-</span><span class="token operator">></span>mIsAbandoned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                graphicBuffer<span class="token operator">-</span><span class="token operator">></span><span class="token function">setGenerationNumber</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mGenerationNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mSlots<span class="token punctuation">[</span><span class="token operator">*</span>outSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>mGraphicBuffer <span class="token operator">=</span> graphicBuffer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mCore<span class="token operator">-</span><span class="token operator">></span>mIsAllocating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mIsAllocatingCondition<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mCore<span class="token operator">-</span><span class="token operator">></span>mFreeSlots<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">*</span>outSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mCore<span class="token operator">-</span><span class="token operator">></span><span class="token function">clearBufferSlotLocked</span><span class="token punctuation">(</span><span class="token operator">*</span>outSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> error<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mIsAbandoned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mCore<span class="token operator">-</span><span class="token operator">></span>mFreeSlots<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">*</span>outSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mCore<span class="token operator">-</span><span class="token operator">></span><span class="token function">clearBufferSlotLocked</span><span class="token punctuation">(</span><span class="token operator">*</span>outSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> NO_INIT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">VALIDATE_CONSISTENCY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// Autolock scope</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>attachedByConsumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        returnFlags <span class="token operator">|</span><span class="token operator">=</span> BUFFER_NEEDS_REALLOCATION<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>eglFence <span class="token operator">!=</span> EGL_NO_SYNC_KHR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        EGLint result <span class="token operator">=</span> <span class="token function">eglClientWaitSyncKHR</span><span class="token punctuation">(</span>eglDisplay<span class="token punctuation">,</span> eglFence<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token number">1000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> EGL_FALSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">BQ_LOGE</span><span class="token punctuation">(</span><span class="token string">"dequeueBuffer: error %#x waiting for fence"</span><span class="token punctuation">,</span>
                    <span class="token function">eglGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> EGL_TIMEOUT_EXPIRED_KHR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">BQ_LOGE</span><span class="token punctuation">(</span><span class="token string">"dequeueBuffer: timeout waiting for fence"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">eglDestroySyncKHR</span><span class="token punctuation">(</span>eglDisplay<span class="token punctuation">,</span> eglFence<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>outBufferAge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>outBufferAge <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mBufferAge<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">addAndGetFrameTimestamps</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> outTimestamps<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> returnFlags<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>waitWhileAllocatingLocked 如果其他线程进入这个方法，会等待BufferQueueProducer帮其他应用进程申请完之后才能继续走下去。</li>
</ol>
</li>
<li><ol start="2">
<li>waitForFreeSlotThenRelock 不断的查找BufferQueueCore的Slot中空闲的插槽位置，并且取出BufferSlot(在SF中也有一个BufferSlot对应记录)中的GraphicBuffer的index(found)，判断当前这个图元是否宽高，像素格式是否和请求一样，不一样则需要重新请求，则在返回码添加BUFFER_NEEDS_REALLOCATION。</li>
</ol>
</li>
<li><ol start="3">
<li>先把found的index添加到mActiveBuffer 区间，标示为活跃状态,并且设置为dequeue状态。接着如果找到的GraphicBuffer是空的，或者需要重新申请，则把设置到BufferSlot的参数全部初始化。</li>
</ol>
</li>
<li><ol start="4">
<li>发现打开了BUFFER_NEEDS_REALLOCATION标志位，就在SF中申请一个新的GraphicBuffer，接着调用GraphicBuffer的initCheck进行校验。拿到found的下标，把新的GraphicBuffer 加入到mSlot。调用clearBufferSlotLocked，初始化clearBufferSlotLocked和里面的参数。</li>
</ol>
</li>
<li><ol start="5">
<li>addAndGetFrameTimestamps 这个方法在dequeuebuffer没有意义。</li>
</ol>
</li>
</ul>
<p>在这个过程中其实很简单，就是找到合适的空位，添加到活跃区间，设置标志位，最后发现为空则会新生成一个，最后返回的是mSlot对应位置的下标。而不会直接返回一个完整的GraphicBuffer，因为一个图元太大了，根本不可能通过Binder进行通信。</p>
<p>我们来看看waitForFreeSlotThenRelock是怎么从mSlot找到合适位置的图元插槽。</p>
<h4 id="BufferQueueProducer-waitForFreeSlotThenRelock"><a href="#BufferQueueProducer-waitForFreeSlotThenRelock" class="headerlink" title="BufferQueueProducer waitForFreeSlotThenRelock"></a>BufferQueueProducer waitForFreeSlotThenRelock</h4><pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferQueueProducer<span class="token operator">::</span><span class="token function">waitForFreeSlotThenRelock</span><span class="token punctuation">(</span>FreeSlotCaller caller<span class="token punctuation">,</span>
        <span class="token keyword">int</span><span class="token operator">*</span> found<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> callerString <span class="token operator">=</span> <span class="token punctuation">(</span>caller <span class="token operator">==</span> FreeSlotCaller<span class="token operator">::</span>Dequeue<span class="token punctuation">)</span> <span class="token operator">?</span>
            <span class="token string">"dequeueBuffer"</span> <span class="token operator">:</span> <span class="token string">"attachBuffer"</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> tryAgain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tryAgain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mIsAbandoned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> NO_INIT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> dequeuedCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> acquiredCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> s <span class="token operator">:</span> mCore<span class="token operator">-</span><span class="token operator">></span>mActiveBuffers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSlots<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">isDequeued</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">++</span>dequeuedCount<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSlots<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">isAcquired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">++</span>acquiredCount<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mBufferHasBeenQueued <span class="token operator">&amp;&amp;</span>
                dequeuedCount <span class="token operator">>=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mMaxDequeuedBufferCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> INVALID_OPERATION<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token operator">*</span>found <span class="token operator">=</span> BufferQueueCore<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> maxBufferCount <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMaxBufferCountLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> tooManyBuffers <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">></span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">></span><span class="token punctuation">(</span>maxBufferCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tooManyBuffers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferMode <span class="token operator">&amp;&amp;</span> mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">!=</span>
                    BufferQueueCore<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>found <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">==</span> FreeSlotCaller<span class="token operator">::</span>Dequeue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// If we're calling this from dequeue, prefer free buffers</span>
                    <span class="token keyword">int</span> slot <span class="token operator">=</span> <span class="token function">getFreeBufferLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>slot <span class="token operator">!=</span> BufferQueueCore<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token operator">*</span>found <span class="token operator">=</span> slot<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mAllowAllocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token operator">*</span>found <span class="token operator">=</span> <span class="token function">getFreeSlotLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// If we're calling this from attach, prefer free slots</span>
                    <span class="token keyword">int</span> slot <span class="token operator">=</span> <span class="token function">getFreeSlotLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>slot <span class="token operator">!=</span> BufferQueueCore<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token operator">*</span>found <span class="token operator">=</span> slot<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token operator">*</span>found <span class="token operator">=</span> <span class="token function">getFreeBufferLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        tryAgain <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>found <span class="token operator">==</span> BufferQueueCore<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token operator">||</span>
                   tooManyBuffers<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tryAgain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mDequeueBufferCannotBlock <span class="token operator">||</span> mCore<span class="token operator">-</span><span class="token operator">></span>mAsyncMode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span>acquiredCount <span class="token operator">&lt;=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mMaxAcquiredBufferCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> WOULD_BLOCK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mDequeueTimeout <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                status_t result <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mDequeueCondition<span class="token punctuation">.</span><span class="token function">waitRelative</span><span class="token punctuation">(</span>
                        mCore<span class="token operator">-</span><span class="token operator">></span>mMutex<span class="token punctuation">,</span> mDequeueTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> TIMED_OUT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mCore<span class="token operator">-</span><span class="token operator">></span>mDequeueCondition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// while (tryAgain)</span>

    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.每一次进入这个方法，都会先循环检测mActiveBuffers中所有所有保存的GraphicBuffer对象的状态，计算已经出队dequeue和消费acquire的数目，并且做校验dequeue是否大于mMaxDequeuedBufferCount数目，超出了就不能计算。还要校验整个Queue大小是否已经比maxBufferCount的限制。</li>
<li>2.如果判断在dequeue执行状态，则会从先从mFreeBuffer找，找不到再从mFreeSlots中查找。</li>
<li>3.最后唤醒其他要出队到应用的线程。</li>
</ul>
<h4 id="BufferQueueProducer-requestBuffer"><a href="#BufferQueueProducer-requestBuffer" class="headerlink" title="BufferQueueProducer requestBuffer"></a>BufferQueueProducer requestBuffer</h4><pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferQueueProducer<span class="token operator">::</span><span class="token function">requestBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> slot<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span><span class="token operator">*</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">BQ_LOGV</span><span class="token punctuation">(</span><span class="token string">"requestBuffer: slot %d"</span><span class="token punctuation">,</span> slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mRequestBufferCalled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>buf <span class="token operator">=</span> mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mGraphicBuffer<span class="token punctuation">;</span>
    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中，很简单，直接返回一个GraphicBuffer对象。不是说GraphicBuffer很大，Binder没有办法传输吗？为什么这里又能返回到app进程呢？稍后解析。这里就能Surface就记录了对应index的GraphicBuffer。</p>
<h3 id="Surface-queueBuffer"><a href="#Surface-queueBuffer" class="headerlink" title="Surface queueBuffer"></a>Surface queueBuffer</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> Surface<span class="token operator">::</span><span class="token function">queueBuffer</span><span class="token punctuation">(</span>android_native_buffer_t<span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> fenceFd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"Surface::queueBuffer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    int64_t timestamp<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> isAutoTimestamp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mTimestamp <span class="token operator">==</span> NATIVE_WINDOW_TIMESTAMP_AUTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timestamp <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span>SYSTEM_TIME_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        isAutoTimestamp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        timestamp <span class="token operator">=</span> mTimestamp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">getSlotFromBufferLocked</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fenceFd <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mSharedBufferSlot <span class="token operator">==</span> i <span class="token operator">&amp;&amp;</span> mSharedBufferHasBeenQueued<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fenceFd <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">// Make sure the crop rectangle is entirely inside the buffer.</span>
    Rect <span class="token function">crop</span><span class="token punctuation">(</span>Rect<span class="token operator">::</span>EMPTY_RECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mCrop<span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span><span class="token function">Rect</span><span class="token punctuation">(</span>buffer<span class="token operator">-</span><span class="token operator">></span>width<span class="token punctuation">,</span> buffer<span class="token operator">-</span><span class="token operator">></span>height<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>crop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span> <span class="token function">fence</span><span class="token punctuation">(</span>fenceFd <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token function">Fence</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">)</span> <span class="token operator">:</span> Fence<span class="token operator">::</span>NO_FENCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    IGraphicBufferProducer<span class="token operator">::</span>QueueBufferOutput output<span class="token punctuation">;</span>
    IGraphicBufferProducer<span class="token operator">::</span>QueueBufferInput <span class="token function">input</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> isAutoTimestamp<span class="token punctuation">,</span>
            <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>android_dataspace<span class="token operator">></span><span class="token punctuation">(</span>mDataSpace<span class="token punctuation">)</span><span class="token punctuation">,</span> crop<span class="token punctuation">,</span> mScalingMode<span class="token punctuation">,</span>
            mTransform <span class="token operator">^</span> mStickyTransform<span class="token punctuation">,</span> fence<span class="token punctuation">,</span> mStickyTransform<span class="token punctuation">,</span>
            mEnableFrameTimestamps<span class="token punctuation">)</span><span class="token punctuation">;</span>

    input<span class="token punctuation">.</span><span class="token function">setHdrMetadata</span><span class="token punctuation">(</span>mHdrMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mConnectedToCpu <span class="token operator">||</span> mDirtyRegion<span class="token punctuation">.</span><span class="token function">bounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Rect<span class="token operator">::</span>INVALID_RECT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        input<span class="token punctuation">.</span><span class="token function">setSurfaceDamage</span><span class="token punctuation">(</span>Region<span class="token operator">::</span>INVALID_REGION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

        <span class="token keyword">int</span> width <span class="token operator">=</span> buffer<span class="token operator">-</span><span class="token operator">></span>width<span class="token punctuation">;</span>
        <span class="token keyword">int</span> height <span class="token operator">=</span> buffer<span class="token operator">-</span><span class="token operator">></span>height<span class="token punctuation">;</span>
        <span class="token keyword">bool</span> rotated90 <span class="token operator">=</span> <span class="token punctuation">(</span>mTransform <span class="token operator">^</span> mStickyTransform<span class="token punctuation">)</span> <span class="token operator">&amp;</span>
                NATIVE_WINDOW_TRANSFORM_ROT_90<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rotated90<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            std<span class="token operator">::</span><span class="token function">swap</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Region flippedRegion<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> rect <span class="token operator">:</span> mDirtyRegion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> left <span class="token operator">=</span> rect<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
            <span class="token keyword">int</span> right <span class="token operator">=</span> rect<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
            <span class="token keyword">int</span> top <span class="token operator">=</span> height <span class="token operator">-</span> rect<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Flip from OpenGL convention</span>
            <span class="token keyword">int</span> bottom <span class="token operator">=</span> height <span class="token operator">-</span> rect<span class="token punctuation">.</span>top<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Flip from OpenGL convention</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>mTransform <span class="token operator">^</span> mStickyTransform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> NATIVE_WINDOW_TRANSFORM_ROT_90<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Rotate 270 degrees</span>
                    Rect flippedRect<span class="token punctuation">{</span>top<span class="token punctuation">,</span> width <span class="token operator">-</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> width <span class="token operator">-</span> left<span class="token punctuation">}</span><span class="token punctuation">;</span>
                    flippedRegion<span class="token punctuation">.</span><span class="token function">orSelf</span><span class="token punctuation">(</span>flippedRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> NATIVE_WINDOW_TRANSFORM_ROT_180<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Rotate 180 degrees</span>
                    Rect flippedRect<span class="token punctuation">{</span>width <span class="token operator">-</span> right<span class="token punctuation">,</span> height <span class="token operator">-</span> bottom<span class="token punctuation">,</span>
                            width <span class="token operator">-</span> left<span class="token punctuation">,</span> height <span class="token operator">-</span> top<span class="token punctuation">}</span><span class="token punctuation">;</span>
                    flippedRegion<span class="token punctuation">.</span><span class="token function">orSelf</span><span class="token punctuation">(</span>flippedRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> NATIVE_WINDOW_TRANSFORM_ROT_270<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Rotate 90 degrees</span>
                    Rect flippedRect<span class="token punctuation">{</span>height <span class="token operator">-</span> bottom<span class="token punctuation">,</span> left<span class="token punctuation">,</span>
                            height <span class="token operator">-</span> top<span class="token punctuation">,</span> right<span class="token punctuation">}</span><span class="token punctuation">;</span>
                    flippedRegion<span class="token punctuation">.</span><span class="token function">orSelf</span><span class="token punctuation">(</span>flippedRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    Rect flippedRect<span class="token punctuation">{</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">}</span><span class="token punctuation">;</span>
                    flippedRegion<span class="token punctuation">.</span><span class="token function">orSelf</span><span class="token punctuation">(</span>flippedRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        input<span class="token punctuation">.</span><span class="token function">setSurfaceDamage</span><span class="token punctuation">(</span>flippedRegion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    nsecs_t now <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    status_t err <span class="token operator">=</span> mGraphicBufferProducer<span class="token operator">-</span><span class="token operator">></span><span class="token function">queueBuffer</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> input<span class="token punctuation">,</span> <span class="token operator">&amp;</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mLastQueueDuration <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now<span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mEnableFrameTimestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mFrameEventHistory<span class="token operator">-</span><span class="token operator">></span><span class="token function">applyDelta</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>frameTimestamps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mFrameEventHistory<span class="token operator">-</span><span class="token operator">></span><span class="token function">updateAcquireFence</span><span class="token punctuation">(</span>mNextFrameNumber<span class="token punctuation">,</span>
                std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>FenceTime<span class="token operator">></span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mFrameEventHistory<span class="token operator">-</span><span class="token operator">></span><span class="token function">updateSignalTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mLastFrameNumber <span class="token operator">=</span> mNextFrameNumber<span class="token punctuation">;</span>

    mDefaultWidth <span class="token operator">=</span> output<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    mDefaultHeight <span class="token operator">=</span> output<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    mNextFrameNumber <span class="token operator">=</span> output<span class="token punctuation">.</span>nextFrameNumber<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Disable transform hint if sticky transform is set.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mStickyTransform <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mTransformHint <span class="token operator">=</span> output<span class="token punctuation">.</span>transformHint<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mConsumerRunningBehind <span class="token operator">=</span> <span class="token punctuation">(</span>output<span class="token punctuation">.</span>numPendingBuffers <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mConnectedToCpu<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Clear surface damage back to full-buffer</span>
        mDirtyRegion <span class="token operator">=</span> Region<span class="token operator">::</span>INVALID_REGION<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mSharedBufferMode <span class="token operator">&amp;&amp;</span> mAutoRefresh <span class="token operator">&amp;&amp;</span> mSharedBufferSlot <span class="token operator">==</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mSharedBufferHasBeenQueued <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mQueueBufferCondition<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>流程如下：</p>
<ul>
<li>1.获取当前的时间戳，等着作为参数传出去。通过getSlotFromBufferLocked检测GraphicBuffer有没有保存在Surface的mSlots中，没有就不能进行下一步。</li>
<li>2.设置所有的必须的参数给QueueBufferInput。如crop裁剪区域，fence同步栅。如果打开了硬件加速，则会设置Surface的Image。如果发现旋转角度，则会旋转像素区域，最后进行合并。最后设置到input。</li>
<li>3.调用BufferQueueProducer的queueBuffer，把图元对应的下标index设置进BufferQueueProducer中处理。</li>
<li>4.更新mFrameEventHistory数据。</li>
<li>5.设置framebuffer，记录前后两帧在对应index；记录入队消耗的时间等辅助参数。</li>
</ul>
<h3 id="BufferQueueProducer-queueBuffer"><a href="#BufferQueueProducer-queueBuffer" class="headerlink" title="BufferQueueProducer queueBuffer"></a>BufferQueueProducer queueBuffer</h3><pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferQueueProducer<span class="token operator">::</span><span class="token function">queueBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> slot<span class="token punctuation">,</span>
        <span class="token keyword">const</span> QueueBufferInput <span class="token operator">&amp;</span>input<span class="token punctuation">,</span> QueueBufferOutput <span class="token operator">*</span>output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    int64_t requestedPresentTimestamp<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> isAutoTimestamp<span class="token punctuation">;</span>
    android_dataspace dataSpace<span class="token punctuation">;</span>
    Rect <span class="token function">crop</span><span class="token punctuation">(</span>Rect<span class="token operator">::</span>EMPTY_RECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> scalingMode<span class="token punctuation">;</span>
    uint32_t transform<span class="token punctuation">;</span>
    uint32_t stickyTransform<span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span> acquireFence<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> getFrameTimestamps <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    input<span class="token punctuation">.</span><span class="token function">deflate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>requestedPresentTimestamp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>isAutoTimestamp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dataSpace<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>crop<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scalingMode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>transform<span class="token punctuation">,</span> <span class="token operator">&amp;</span>acquireFence<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stickyTransform<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>getFrameTimestamps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> Region<span class="token operator">&amp;</span> surfaceDamage <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getSurfaceDamage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> HdrMetadata<span class="token operator">&amp;</span> hdrMetadata <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getHdrMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">auto</span> acquireFenceTime <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>FenceTime<span class="token operator">></span><span class="token punctuation">(</span>acquireFence<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>scalingMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> NATIVE_WINDOW_SCALING_MODE_FREEZE<span class="token operator">:</span>
        <span class="token keyword">case</span> NATIVE_WINDOW_SCALING_MODE_SCALE_TO_WINDOW<span class="token operator">:</span>
        <span class="token keyword">case</span> NATIVE_WINDOW_SCALING_MODE_SCALE_CROP<span class="token operator">:</span>
        <span class="token keyword">case</span> NATIVE_WINDOW_SCALING_MODE_NO_SCALE_CROP<span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> BAD_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sp<span class="token operator">&lt;</span>IConsumerListener<span class="token operator">></span> frameAvailableListener<span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>IConsumerListener<span class="token operator">></span> frameReplacedListener<span class="token punctuation">;</span>
    <span class="token keyword">int</span> callbackTicket <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    uint64_t currentFrameNumber <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    BufferItem item<span class="token punctuation">;</span>
    <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Autolock scope</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferMode <span class="token operator">&amp;&amp;</span> mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">==</span>
                BufferQueueCore<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">=</span> slot<span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span>mShared <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">graphicBuffer</span><span class="token punctuation">(</span>mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mGraphicBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Rect <span class="token function">bufferRect</span><span class="token punctuation">(</span>graphicBuffer<span class="token operator">-</span><span class="token operator">></span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> graphicBuffer<span class="token operator">-</span><span class="token operator">></span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Rect <span class="token function">croppedRect</span><span class="token punctuation">(</span>Rect<span class="token operator">::</span>EMPTY_RECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        crop<span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span>bufferRect<span class="token punctuation">,</span> <span class="token operator">&amp;</span>croppedRect<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSpace <span class="token operator">==</span> HAL_DATASPACE_UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dataSpace <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mDefaultBufferDataSpace<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence <span class="token operator">=</span> acquireFence<span class="token punctuation">;</span>
        mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token operator">++</span>mCore<span class="token operator">-</span><span class="token operator">></span>mFrameCounter<span class="token punctuation">;</span>
        currentFrameNumber <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mFrameCounter<span class="token punctuation">;</span>
        mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mFrameNumber <span class="token operator">=</span> currentFrameNumber<span class="token punctuation">;</span>

        item<span class="token punctuation">.</span>mAcquireCalled <span class="token operator">=</span> mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mAcquireCalled<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mGraphicBuffer <span class="token operator">=</span> mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mGraphicBuffer<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mCrop <span class="token operator">=</span> crop<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mTransform <span class="token operator">=</span> transform <span class="token operator">&amp;</span>
                <span class="token operator">~</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>NATIVE_WINDOW_TRANSFORM_INVERSE_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mTransformToDisplayInverse <span class="token operator">=</span>
                <span class="token punctuation">(</span>transform <span class="token operator">&amp;</span> NATIVE_WINDOW_TRANSFORM_INVERSE_DISPLAY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mScalingMode <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>scalingMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mTimestamp <span class="token operator">=</span> requestedPresentTimestamp<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mIsAutoTimestamp <span class="token operator">=</span> isAutoTimestamp<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mDataSpace <span class="token operator">=</span> dataSpace<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mHdrMetadata <span class="token operator">=</span> hdrMetadata<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mFrameNumber <span class="token operator">=</span> currentFrameNumber<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mSlot <span class="token operator">=</span> slot<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mFence <span class="token operator">=</span> acquireFence<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mFenceTime <span class="token operator">=</span> acquireFenceTime<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mIsDroppable <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mAsyncMode <span class="token operator">||</span>
                mCore<span class="token operator">-</span><span class="token operator">></span>mDequeueBufferCannotBlock <span class="token operator">||</span>
                <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferMode <span class="token operator">&amp;&amp;</span> mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">==</span> slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mSurfaceDamage <span class="token operator">=</span> surfaceDamage<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mQueuedBuffer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mAutoRefresh <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferMode <span class="token operator">&amp;&amp;</span> mCore<span class="token operator">-</span><span class="token operator">></span>mAutoRefresh<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mApi <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mConnectedApi<span class="token punctuation">;</span>

        mStickyTransform <span class="token operator">=</span> stickyTransform<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Cache the shared buffer data so that the BufferItem can be recreated.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferCache<span class="token punctuation">.</span>crop <span class="token operator">=</span> crop<span class="token punctuation">;</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferCache<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform<span class="token punctuation">;</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferCache<span class="token punctuation">.</span>scalingMode <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>
                    scalingMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferCache<span class="token punctuation">.</span>dataspace <span class="token operator">=</span> dataSpace<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        output<span class="token operator">-</span><span class="token operator">></span>bufferReplaced <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frameAvailableListener <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mConsumerListener<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> BufferItem<span class="token operator">&amp;</span> last <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">itemAt</span><span class="token punctuation">(</span>
                    mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>last<span class="token punctuation">.</span>mIsDroppable<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>last<span class="token punctuation">.</span>mIsStale<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mSlots<span class="token punctuation">[</span>last<span class="token punctuation">.</span>mSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">freeQueued</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferMode <span class="token operator">&amp;&amp;</span>
                            mSlots<span class="token punctuation">[</span>last<span class="token punctuation">.</span>mSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">isFree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mSlots<span class="token punctuation">[</span>last<span class="token punctuation">.</span>mSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span>mShared <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// Don't put the shared buffer on the free list.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSlots<span class="token punctuation">[</span>last<span class="token punctuation">.</span>mSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mCore<span class="token operator">-</span><span class="token operator">></span>mActiveBuffers<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>last<span class="token punctuation">.</span>mSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mCore<span class="token operator">-</span><span class="token operator">></span>mFreeBuffers<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>last<span class="token punctuation">.</span>mSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        output<span class="token operator">-</span><span class="token operator">></span>bufferReplaced <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">editItemAt</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>
                frameReplacedListener <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mConsumerListener<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
                frameAvailableListener <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mConsumerListener<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mCore<span class="token operator">-</span><span class="token operator">></span>mBufferHasBeenQueued <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        mCore<span class="token operator">-</span><span class="token operator">></span>mDequeueCondition<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCore<span class="token operator">-</span><span class="token operator">></span>mLastQueuedSlot <span class="token operator">=</span> slot<span class="token punctuation">;</span>

        output<span class="token operator">-</span><span class="token operator">></span>width <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mDefaultWidth<span class="token punctuation">;</span>
        output<span class="token operator">-</span><span class="token operator">></span>height <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mDefaultHeight<span class="token punctuation">;</span>
        output<span class="token operator">-</span><span class="token operator">></span>transformHint <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mTransformHint<span class="token punctuation">;</span>
        output<span class="token operator">-</span><span class="token operator">></span>numPendingBuffers <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output<span class="token operator">-</span><span class="token operator">></span>nextFrameNumber <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mFrameCounter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token function">ATRACE_INT</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mConsumerName<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>int32_t<span class="token operator">></span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCore<span class="token operator">-</span><span class="token operator">></span>mOccupancyTracker<span class="token punctuation">.</span><span class="token function">registerOccupancyChange</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Take a ticket for the callback functions</span>
        callbackTicket <span class="token operator">=</span> mNextCallbackTicket<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token function">VALIDATE_CONSISTENCY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// Autolock scope</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mConsumerIsSurfaceFlinger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span>mGraphicBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    item<span class="token punctuation">.</span>mSlot <span class="token operator">=</span> BufferItem<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">;</span>


    <span class="token keyword">int</span> connectedApi<span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span> lastQueuedFence<span class="token punctuation">;</span>

    <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// scope for the lock</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCallbackMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>callbackTicket <span class="token operator">!=</span> mCurrentCallbackTicket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCallbackCondition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>mCallbackMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>frameAvailableListener <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            frameAvailableListener<span class="token operator">-</span><span class="token operator">></span><span class="token function">onFrameAvailable</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frameReplacedListener <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            frameReplacedListener<span class="token operator">-</span><span class="token operator">></span><span class="token function">onFrameReplaced</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        connectedApi <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mConnectedApi<span class="token punctuation">;</span>
        lastQueuedFence <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>mLastQueueBufferFence<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mLastQueueBufferFence <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>acquireFence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLastQueuedCrop <span class="token operator">=</span> item<span class="token punctuation">.</span>mCrop<span class="token punctuation">;</span>
        mLastQueuedTransform <span class="token operator">=</span> item<span class="token punctuation">.</span>mTransform<span class="token punctuation">;</span>

        <span class="token operator">++</span>mCurrentCallbackTicket<span class="token punctuation">;</span>
        mCallbackCondition<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Wait without lock held</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connectedApi <span class="token operator">==</span> NATIVE_WINDOW_API_EGL<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        lastQueuedFence<span class="token operator">-</span><span class="token operator">></span><span class="token function">waitForever</span><span class="token punctuation">(</span><span class="token string">"Throttling EGL Production"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Update and get FrameEventHistory.</span>
    nsecs_t postedTime <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span>SYSTEM_TIME_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NewFrameEventsEntry newFrameEventsEntry <span class="token operator">=</span> <span class="token punctuation">{</span>
        currentFrameNumber<span class="token punctuation">,</span>
        postedTime<span class="token punctuation">,</span>
        requestedPresentTimestamp<span class="token punctuation">,</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>acquireFenceTime<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">addAndGetFrameTimestamps</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>newFrameEventsEntry<span class="token punctuation">,</span>
            getFrameTimestamps <span class="token operator">?</span> <span class="token operator">&amp;</span>output<span class="token operator">-</span><span class="token operator">></span>frameTimestamps <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心有四个：</p>
<ul>
<li>1.拿到当前需要入队的图元，并且把QueueBufferInput设置的参数全部取出，设置到BufferItem中，接着设置到BufferQueueCore的mQueue中，mQueue为如下类型：<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> Vector<span class="token operator">&lt;</span>BufferItem<span class="token operator">></span> Fifo<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>其实在这个阶段判断mQueue如果为空，直接加到mQueue的末尾。不为空，需要判断最后一个图元是否已经不需要显示了，如果是共享模式的图元，则关闭。不是，则会从Active区域移除，放到Free区域中，并且代替mQueue最后一个图元。否则还是放到mQueue末尾。</p>
<ul>
<li><p>2.设置QueueBufferOutput参数，能看到nextframebuffer，就是BufferQueueCore中包含者帧数+1。</p>
</li>
<li><p>3.调用frameAvailableListener回调。这个回调在缓冲队列初始化有专门介绍过。是通知消费者可以进行消费图元的回调。</p>
</li>
<li><ol start="4">
<li>addAndGetFrameTimestamps 更新当前帧时间戳。</li>
</ol>
</li>
</ul>
<h3 id="addAndGetFrameTimestamps"><a href="#addAndGetFrameTimestamps" class="headerlink" title="addAndGetFrameTimestamps"></a>addAndGetFrameTimestamps</h3><pre class="line-numbers language-cpp"><code class="language-cpp"> nsecs_t postedTime <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span>SYSTEM_TIME_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NewFrameEventsEntry newFrameEventsEntry <span class="token operator">=</span> <span class="token punctuation">{</span>
        currentFrameNumber<span class="token punctuation">,</span>
        postedTime<span class="token punctuation">,</span>
        requestedPresentTimestamp<span class="token punctuation">,</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>acquireFenceTime<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">addAndGetFrameTimestamps</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>newFrameEventsEntry<span class="token punctuation">,</span>
            getFrameTimestamps <span class="token operator">?</span> <span class="token operator">&amp;</span>output<span class="token operator">-</span><span class="token operator">></span>frameTimestamps <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.currentFrameNumber 每当进入queueBuffer，就会自动添加一次mFrameCounter，这个参数代表这是当前Surface诞生以来第几帧。</li>
<li>2.postedTime 完成queue时候的时间。</li>
<li>3.requestedPresentTimestamp 应用端调用Binder通信时候的时刻。</li>
<li>4.acquireFenceTime 一个同步栅</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> BufferQueueProducer<span class="token operator">::</span><span class="token function">addAndGetFrameTimestamps</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> NewFrameEventsEntry<span class="token operator">*</span> newTimestamps<span class="token punctuation">,</span>
        FrameEventHistoryDelta<span class="token operator">*</span> outDelta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newTimestamps <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> outDelta <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sp<span class="token operator">&lt;</span>IConsumerListener<span class="token operator">></span> listener<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        listener <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mConsumerListener<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        listener<span class="token operator">-</span><span class="token operator">></span><span class="token function">addAndGetFrameTimestamps</span><span class="token punctuation">(</span>newTimestamps<span class="token punctuation">,</span> outDelta<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时就是回调到消费者中的监听回调，具体做了什么之后再说。</p>
<h3 id="unlock-解锁图元"><a href="#unlock-解锁图元" class="headerlink" title="unlock 解锁图元"></a>unlock 解锁图元</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/opengl/" target="_blank" rel="noopener">opengl</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/opengl/libagl/" target="_blank" rel="noopener">libagl</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/opengl/libagl/egl.cpp" target="_blank" rel="noopener">egl.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t egl_window_surface_v2_t<span class="token operator">::</span><span class="token function">unlock</span><span class="token punctuation">(</span>ANativeWindowBuffer<span class="token operator">*</span> buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buf<span class="token punctuation">)</span> <span class="token keyword">return</span> BAD_VALUE<span class="token punctuation">;</span>
    <span class="token keyword">auto</span><span class="token operator">&amp;</span> mapper <span class="token operator">=</span> GraphicBufferMapper<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span>buf<span class="token operator">-</span><span class="token operator">></span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到GraphicBufferMapper调用以ANativeWindowBuffer的handle为线索unlock解锁图元映射。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在整个流程中，我们能够看到生产者生产涉及到的主要角色如下：</p>
<ul>
<li>1.GraphicBufferMapper</li>
<li>2.BufferQueueProducer</li>
<li>3.Surface(ANativeWindow)</li>
<li>4.GraphicBuffer（ANativeWindowBuffer）</li>
</ul>
<p>Surface是面向应用客户端的图元生产者，BufferQueueProducer是面向SF服务端的图元生产者。其核心涉及实际是查找mSlot中有没有空闲的位置，让图元占用。但是真正进行消费的时候，需要设置到BufferItem的Vector中。</p>
<p>但是思考过没有，一个图元代表一帧的数据。一个屏幕常见的占用的内存1080<em>1920</em>4 早就超过了应用传输Binder的极限1040k.那么系统是怎么规避这个问题呢？</p>
<p>我们从dequeue步骤中能看到，每一次dequeue之后先回返回一个mSlot的下标，即使在这个步骤已经new了一个GraphicBuffer，他也不会返回GraphicBuffer。但是到了requestBuffer就能GraphicBuffer对象。为什么这么设计？就算是返回了GraphicBuffer对象，Binder会因为这个对象占用太大而报错。</p>
<p>系统是怎么办到的？而且在OpenGL es中eglSwapBuffers中，把framebuffer_t和ANativeWindowBuffer的bit属性关联起来，ANativeWindowBuffer又是怎么在跨进程通信初始化bit字段的？</p>
<p>接下来让我们专门来解析GraphicBuffer类。</p>
<h3 id="GraphicBuffer-初始化"><a href="#GraphicBuffer-初始化" class="headerlink" title="GraphicBuffer 初始化"></a>GraphicBuffer 初始化</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/include/ui/" target="_blank" rel="noopener">ui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/include/ui/GraphicBuffer.h" target="_blank" rel="noopener">GraphicBuffer.h</a><br>先来看看其继承关系：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">
<span class="token keyword">class</span> <span class="token class-name">GraphicBuffer</span>
    <span class="token operator">:</span> <span class="token keyword">public</span> ANativeObjectBase<span class="token operator">&lt;</span>ANativeWindowBuffer<span class="token punctuation">,</span> GraphicBuffer<span class="token punctuation">,</span> RefBase<span class="token operator">></span><span class="token punctuation">,</span>
      <span class="token keyword">public</span> Flattenable<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>GraphicBuffer继承于ANativeWindowBuffer和Flattenable，前者是在ANativeWindow中的图元缓冲，后者是Binder 传输时候的Parcel封装IBinder。但是这里里面的flattern和unflattern方法被重写了为自己的保存所有参数的方法。我们稍后再看。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/ui/" target="_blank" rel="noopener">ui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/ui/GraphicBuffer.cpp" target="_blank" rel="noopener">GraphicBuffer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">        sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span> graphicBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">GraphicBuffer</span><span class="token punctuation">(</span>
                width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> format<span class="token punctuation">,</span> BQ_LAYER_COUNT<span class="token punctuation">,</span> usage<span class="token punctuation">,</span>
                <span class="token punctuation">{</span>mConsumerName<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mConsumerName<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">GraphicBuffer<span class="token operator">::</span><span class="token function">GraphicBuffer</span><span class="token punctuation">(</span>uint32_t inWidth<span class="token punctuation">,</span> uint32_t inHeight<span class="token punctuation">,</span>
        PixelFormat inFormat<span class="token punctuation">,</span> uint32_t inLayerCount<span class="token punctuation">,</span> uint64_t usage<span class="token punctuation">,</span> std<span class="token operator">::</span>string requestorName<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">GraphicBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mInitCheck <span class="token operator">=</span> <span class="token function">initWithSize</span><span class="token punctuation">(</span>inWidth<span class="token punctuation">,</span> inHeight<span class="token punctuation">,</span> inFormat<span class="token punctuation">,</span> inLayerCount<span class="token punctuation">,</span>
            usage<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>requestorName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t GraphicBuffer<span class="token operator">::</span><span class="token function">initWithSize</span><span class="token punctuation">(</span>uint32_t inWidth<span class="token punctuation">,</span> uint32_t inHeight<span class="token punctuation">,</span>
        PixelFormat inFormat<span class="token punctuation">,</span> uint32_t inLayerCount<span class="token punctuation">,</span> uint64_t inUsage<span class="token punctuation">,</span>
        std<span class="token operator">::</span>string requestorName<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    GraphicBufferAllocator<span class="token operator">&amp;</span> allocator <span class="token operator">=</span> GraphicBufferAllocator<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint32_t outStride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    status_t err <span class="token operator">=</span> allocator<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>inWidth<span class="token punctuation">,</span> inHeight<span class="token punctuation">,</span> inFormat<span class="token punctuation">,</span> inLayerCount<span class="token punctuation">,</span>
            inUsage<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>outStride<span class="token punctuation">,</span> mId<span class="token punctuation">,</span>
            std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>requestorName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mBufferMapper<span class="token punctuation">.</span><span class="token function">getTransportSize</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mTransportNumFds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mTransportNumInts<span class="token punctuation">)</span><span class="token punctuation">;</span>

        width <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>inWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
        height <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>inHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        format <span class="token operator">=</span> inFormat<span class="token punctuation">;</span>
        layerCount <span class="token operator">=</span> inLayerCount<span class="token punctuation">;</span>
        usage <span class="token operator">=</span> inUsage<span class="token punctuation">;</span>
        usage_deprecated <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>usage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stride <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>outStride<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在初始化中有一个十分核心的类GraphicBufferAllocator，图元申请器。这个类真正在一个GraphicBuffer的壳内，通过allocate真正生成一个核心内存块。接着会调用GraphicBufferMapper. getTransportSize在Mapper中记录大小。请注意，allocate方法中有一个十分核心的参数handle。他是来自ANativeWindowBuffer：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/nativebase/" target="_blank" rel="noopener">nativebase</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/nativebase/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/nativebase/include/nativebase/" target="_blank" rel="noopener">nativebase</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/nativebase/include/nativebase/nativebase.h" target="_blank" rel="noopener">nativebase.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">const</span> native_handle_t<span class="token operator">*</span> handle<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> native_handle
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> version<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* sizeof(native_handle_t) */</span>
    <span class="token keyword">int</span> numFds<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/* number of file-descriptors at &amp;data[0] */</span>
    <span class="token keyword">int</span> numInts<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* number of ints at &amp;data[numFds] */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined(__clang__)</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> clang diagnostic push</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> clang diagnostic ignored "-Wzero-length-array"</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token keyword">int</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* numFds + numInts ints */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined(__clang__)</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> clang diagnostic pop</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span> native_handle_t<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>native_handle_t实际上是的GraphicBuffer的句柄。</p>
<p>让我们依次看看GraphicBufferAllocator和GraphicBufferMapper都做了什么。</p>
<h2 id="GraphicBufferAllocator-初始化"><a href="#GraphicBufferAllocator-初始化" class="headerlink" title="GraphicBufferAllocator 初始化"></a>GraphicBufferAllocator 初始化</h2><p>文件：<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/ui/" target="_blank" rel="noopener">ui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/ui/GraphicBufferAllocator.cpp" target="_blank" rel="noopener">GraphicBufferAllocator.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">ANDROID_SINGLETON_STATIC_INSTANCE</span><span class="token punctuation">(</span> GraphicBufferAllocator <span class="token punctuation">)</span>

Mutex GraphicBufferAllocator<span class="token operator">::</span>sLock<span class="token punctuation">;</span>
KeyedVector<span class="token operator">&lt;</span>buffer_handle_t<span class="token punctuation">,</span>
    GraphicBufferAllocator<span class="token operator">::</span>alloc_rec_t<span class="token operator">></span> GraphicBufferAllocator<span class="token operator">::</span>sAllocList<span class="token punctuation">;</span>

GraphicBufferAllocator<span class="token operator">::</span><span class="token function">GraphicBufferAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">mMapper</span><span class="token punctuation">(</span>GraphicBufferMapper<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mAllocator</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Gralloc2<span class="token operator">::</span>Allocator<span class="token operator">></span><span class="token punctuation">(</span>
                mMapper<span class="token punctuation">.</span><span class="token function">getGrallocMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ANDROID_SINGLETON_STATIC_INSTANCE这个宏实际上就是一个单例：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> TYPE<span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">ANDROID_API</span> Singleton
<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">static</span> TYPE<span class="token operator">&amp;</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>sLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        TYPE<span class="token operator">*</span> instance <span class="token operator">=</span> sInstance<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">TYPE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sInstance <span class="token operator">=</span> instance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">*</span>instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">hasInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>sLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sInstance <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token operator">~</span><span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> Mutex sLock<span class="token punctuation">;</span>
    <span class="token keyword">static</span> TYPE<span class="token operator">*</span> sInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> defined(__clang__)</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> clang diagnostic pop</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> ANDROID_SINGLETON_STATIC_INSTANCE(TYPE)                 \
    template&lt;> ::android::Mutex  \
        (::android::Singleton&lt; TYPE >::sLock)(::android::Mutex::PRIVATE);  \
    template&lt;> TYPE* ::android::Singleton&lt; TYPE >::sInstance(0);  </span><span class="token comment" spellcheck="true">/* NOLINT */</span> \
    <span class="token keyword">template</span> <span class="token keyword">class</span> <span class="token operator">::</span>android<span class="token operator">::</span>Singleton<span class="token operator">&lt;</span> TYPE <span class="token operator">></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实很简单有一个静态方法，上锁后获取一个静态实例。</p>
<p>在构造函数中实例化了两个十分核心对象：</p>
<ul>
<li>1.GraphicBufferMapper</li>
<li>2.Gralloc2::Allocator 从GraphicBufferMapper获图元生成器</li>
</ul>
<h3 id="GraphicBufferMapper-初始化"><a href="#GraphicBufferMapper-初始化" class="headerlink" title="GraphicBufferMapper 初始化"></a>GraphicBufferMapper 初始化</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/ui/" target="_blank" rel="noopener">ui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/ui/GraphicBufferMapper.cpp" target="_blank" rel="noopener">GraphicBufferMapper.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">ANDROID_SINGLETON_STATIC_INSTANCE</span><span class="token punctuation">(</span> GraphicBufferMapper <span class="token punctuation">)</span>

GraphicBufferMapper<span class="token operator">::</span><span class="token function">GraphicBufferMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">mMapper</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span><span class="token keyword">const</span> Gralloc2<span class="token operator">::</span>Mapper<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>初始化核心对象Gralloc2::Mapper。</p>
<p>其实Gralloc2::Mapper和Gralloc2::Allocator两者都是对应Hal层的对象。我们依次看看两者的初始化。</p>
<h4 id="Gralloc2-Mapper-的初始化"><a href="#Gralloc2-Mapper-的初始化" class="headerlink" title="Gralloc2::Mapper 的初始化"></a>Gralloc2::Mapper 的初始化</h4><pre class="line-numbers language-cpp"><code class="language-cpp">Mapper<span class="token operator">::</span><span class="token function">Mapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mMapper <span class="token operator">=</span> hardware<span class="token operator">::</span>graphics<span class="token operator">::</span>mapper<span class="token operator">::</span>V2_0<span class="token operator">::</span>IMapper<span class="token operator">::</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// IMapper 2.1 is optional</span>
    mMapperV2_1 <span class="token operator">=</span> IMapper<span class="token operator">::</span><span class="token function">castFrom</span><span class="token punctuation">(</span>mMapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到本质上是沟通了Hal层的hwServiceManager之后，获取IMapper的服务。</p>
<p>之前在SurfaceFlinger的HAL层初始化有详细的介绍，这里就不多赘述。这里就直接摆出关键几个数据结构。</p>
<h3 id="Gralloc2-Mapper-HAL层的数据结构介绍"><a href="#Gralloc2-Mapper-HAL层的数据结构介绍" class="headerlink" title="Gralloc2::Mapper HAL层的数据结构介绍"></a>Gralloc2::Mapper HAL层的数据结构介绍</h3><p>从我之前几篇文章能够知道，一般来说HAL需要hw_module_t的结构体作为核心。本文继续以msm8960为基准，Gralloc2对应的Hal层全部都是passthrough 直通模式，我们看看这个数据结构<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/" target="_blank" rel="noopener">libgralloc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/gralloc.cpp" target="_blank" rel="noopener">gralloc.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> private_module_t HAL_MODULE_INFO_SYM <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>base <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>common <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span>tag <span class="token operator">=</span> HARDWARE_MODULE_TAG<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>module_api_version <span class="token operator">=</span> GRALLOC_MODULE_API_VERSION_0_2<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>hal_api_version <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>id <span class="token operator">=</span> GRALLOC_HARDWARE_MODULE_ID<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Graphics Memory Allocator Module"</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>author <span class="token operator">=</span> <span class="token string">"The Android Open Source Project"</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>methods <span class="token operator">=</span> <span class="token operator">&amp;</span>gralloc_module_methods<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>dso <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>registerBuffer <span class="token operator">=</span> gralloc_register_buffer<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>unregisterBuffer <span class="token operator">=</span> gralloc_unregister_buffer<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>lock <span class="token operator">=</span> gralloc_lock<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>unlock <span class="token operator">=</span> gralloc_unlock<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>perform <span class="token operator">=</span> gralloc_perform<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>lock_ycbcr <span class="token operator">=</span> gralloc_lock_ycbcr<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>framebuffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>fbFormat <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>numBuffers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>bufferMask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>lock <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>currentBuffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里面gralloc对应的结构体，module_api_version 代表gralloc hal结构体的版本。此时版本为0.2。以及注册了gralloc_register_buffer，gralloc_unregister_buffer，gralloc_lock，gralloc_unlock，gralloc_perform,gralloc_lock_ycbcr的方法指针.</p>
<p>对应hw_module_t的包装类是Gralloc0HalImpl 。gralloc有点特殊，没有包装成hw_device_t，而是直接操作hw_module_t。</p>
<p>位置如下：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/" target="_blank" rel="noopener">mapper</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/" target="_blank" rel="noopener">passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/mapper-passthrough/" target="_blank" rel="noopener">mapper-passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/mapper-passthrough/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/mapper-passthrough/2.0/Gralloc0Hal.h" target="_blank" rel="noopener">Gralloc0Hal.h</a></p>
<p>最后我们关注IMapper.hal，看看这个hal层开放了什么方法给上层：</p>
<pre><code>interface IMapper {
...

    @entry
    @callflow(next="*")
    createDescriptor(BufferDescriptorInfo descriptorInfo)
          generates (Error error,
                     BufferDescriptor descriptor);

    @entry
    @callflow(next="*")
    importBuffer(handle rawHandle) generates (Error error, pointer buffer);


    @exit
    @callflow(next="*")
    freeBuffer(pointer buffer) generates (Error error);

    @callflow(next="unlock")
    lock(pointer buffer,
         bitfield&lt;BufferUsage&gt; cpuUsage,
         Rect accessRegion,
         handle acquireFence)
        generates (Error error,
                   pointer data);

    @callflow(next="unlock")
    lockYCbCr(pointer buffer,
              bitfield&lt;BufferUsage&gt; cpuUsage,
              Rect accessRegion,
              handle acquireFence)
        generates (Error error,
                   YCbCrLayout layout);

    @callflow(next="*")
    unlock(pointer buffer)
        generates (Error error,
                   handle releaseFence);
};
</code></pre><p>一共四个方法：</p>
<ul>
<li>1.importBuffer 生成可用的Buffer</li>
<li>2.freeBuffer 释放Buffer</li>
<li>3.lock 上锁buffer</li>
<li>4.lockYCbCr 上锁一个ycbcr的像素格式的buffer</li>
<li>4.unlock 解锁锁buffer</li>
</ul>
<p>最后包装在这个HalImpl的类之上，在包装一层GrallocMapper给上层：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">GrallocMapper</span> <span class="token operator">:</span> <span class="token keyword">public</span> T <span class="token punctuation">{</span>
   <span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">addImportedBuffer</span><span class="token punctuation">(</span>native_handle_t<span class="token operator">*</span> bufferHandle<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        <span class="token keyword">return</span> GrallocImportedBufferPool<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bufferHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    native_handle_t<span class="token operator">*</span> <span class="token function">removeImportedBuffer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> buffer<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        <span class="token keyword">return</span> GrallocImportedBufferPool<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> native_handle_t<span class="token operator">*</span> <span class="token function">getImportedBuffer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> buffer<span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span>
        <span class="token keyword">return</span> GrallocImportedBufferPool<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>GrallocMapper是继承与MapperImpl，位置如下。</p>
<p>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/" target="_blank" rel="noopener">mapper</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/hal/" target="_blank" rel="noopener">hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/hal/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/hal/include/mapper-hal/" target="_blank" rel="noopener">mapper-hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/hal/include/mapper-hal/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/hal/include/mapper-hal/2.0/Mapper.h" target="_blank" rel="noopener">Mapper.h</a></p>
<h3 id="Gralloc2-Allocator-HAL层的数据结构介绍"><a href="#Gralloc2-Allocator-HAL层的数据结构介绍" class="headerlink" title="Gralloc2::Allocator HAL层的数据结构介绍"></a>Gralloc2::Allocator HAL层的数据结构介绍</h3><p>其实对于Allocator来说,其实对应的hw_module_t和IMapper是一致的。只不过不同的hal对象开发的api不同。对于Allocator他只关注如何申请内存出来。<br>先来看看对应的hal文件：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/" target="_blank" rel="noopener">allocator</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/IAllocator.hal" target="_blank" rel="noopener">IAllocator.hal</a></p>
<pre><code>interface IAllocator {

    @entry
    @exit
    @callflow(next="*")
    dumpDebugInfo() generates (string debugInfo);

    @entry
    @exit
    @callflow(next="*")
    allocate(BufferDescriptor descriptor, uint32_t count)
        generates (Error error,
                   uint32_t stride,
                   vec&lt;handle&gt; buffers);
};</code></pre><p>其实只有一个allocate的方法，进行内存申请。不过在IAllocator的包装类Gralloc0HalImpl在调用initMoudle初始化hw_module_t的时候，调用了如下方法：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/" target="_blank" rel="noopener">allocator</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/passthrough/" target="_blank" rel="noopener">passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/passthrough/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/passthrough/include/allocator-passthrough/" target="_blank" rel="noopener">allocator-passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/passthrough/include/allocator-passthrough/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/passthrough/include/allocator-passthrough/2.0/Gralloc0Hal.h" target="_blank" rel="noopener">Gralloc0Hal.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">bool</span> <span class="token function">initWithModule</span><span class="token punctuation">(</span><span class="token keyword">const</span> hw_module_t<span class="token operator">*</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">gralloc_open</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mDevice <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里调用了gralloc_open，对hw_module_t进行初始化，生成一个hw_device_t.<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/" target="_blank" rel="noopener">libgralloc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/gralloc.cpp" target="_blank" rel="noopener">gralloc.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">gralloc_device_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> hw_module_t<span class="token operator">*</span> module<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span>
                        hw_device_t<span class="token operator">*</span><span class="token operator">*</span> device<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> GRALLOC_HARDWARE_GPU0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> private_module_t<span class="token operator">*</span> m <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> private_module_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>
            module<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gpu_context_t <span class="token operator">*</span>dev<span class="token punctuation">;</span>
        IAllocController<span class="token operator">*</span> alloc_ctrl <span class="token operator">=</span> IAllocController<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dev <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">gpu_context_t</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> alloc_ctrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>device <span class="token operator">=</span> <span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">></span>common<span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        status <span class="token operator">=</span> <span class="token function">fb_device_open</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> name<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在gralloc初始化hw_device_t时候，会判断hw_module_t中的name字段。是否打开gralloc服务。打开就使用gpu_context_t包装gralloc申请服务返回给上层，不打开则使用老的方式framebuffer，通信fb驱动。</p>
<p>能看到上面hw_module_t.name字段就是GRALLOC_HARDWARE_GPU0。其实绝大部分都是在使用gralloc服务。framebuffer的服务将不会仔细聊，我们把重点放到gralloc服务。</p>
<p>再来看看gpu_context_t：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/" target="_blank" rel="noopener">libgralloc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/gpu.cpp" target="_blank" rel="noopener">gpu.cpp</a></p>
<pre><code>gpu_context_t::gpu_context_t(const private_module_t* module,
                             IAllocController* alloc_ctrl ) :
    mAllocCtrl(alloc_ctrl)
{
    // Zero out the alloc_device_t
    memset(static_cast&lt;alloc_device_t*&gt;(this), 0, sizeof(alloc_device_t));

    // Initialize the procs
    common.tag     = HARDWARE_DEVICE_TAG;
    common.version = 0;
    common.module  = const_cast&lt;hw_module_t*&gt;(&amp;module-&gt;base.common);
    common.close   = gralloc_close;
    alloc          = gralloc_alloc;
#ifdef QCOM_BSP
    allocSize      = gralloc_alloc_size;
#endif
    free           = gralloc_free;

}</code></pre><p>到了这一步，才真正的给整个hal的allocate方法赋予意义。</p>
<p>先来看看IAllocController 这个单例初始化。</p>
<h4 id="IAllocController-初始化"><a href="#IAllocController-初始化" class="headerlink" title="IAllocController 初始化"></a>IAllocController 初始化</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/" target="_blank" rel="noopener">libgralloc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/alloc_controller.cpp" target="_blank" rel="noopener">alloc_controller.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">IAllocController<span class="token operator">*</span> IAllocController<span class="token operator">::</span>sController <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
IAllocController<span class="token operator">*</span> IAllocController<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sController <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">IonController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sController<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">//-------------- IonController-----------------------//</span>
IonController<span class="token operator">::</span><span class="token function">IonController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mIonAlloc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">IonAlloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>IAllocController中间包装了一个IonAlloc。IonController中包装一个ion驱动控制器IonAlloc。IonAlloc实际上继承IMemAlloc。</p>
<p>最后对应着HAL向外暴露的对象为AllocatorImpl</p>
<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>涉及到的对象有点多，我们还是画一个UML图来梳理一遍整个GraphicAllactor的Hal层初始化。<br><img src="/images/GraphicBuffer%E7%94%9F%E6%88%90%E4%BD%93%E7%B3%BB.png" alt="GraphicBuffer生成体系.png"></p>
<p>记住这幅图就能对整个GraphicBuffer的体系的设计了然于胸。</p>
<h3 id="GraphicBuffer-Hal层的生成原理"><a href="#GraphicBuffer-Hal层的生成原理" class="headerlink" title="GraphicBuffer Hal层的生成原理"></a>GraphicBuffer Hal层的生成原理</h3><p>在GraphicBuffer中其核心方法为：</p>
<ul>
<li>1.GraphicBufferAllocator. allocate。</li>
<li>2.GraphicBufferMapper. getTransportSize</li>
</ul>
<p>让我们依次解析这两个方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t GraphicBufferAllocator<span class="token operator">::</span><span class="token function">allocate</span><span class="token punctuation">(</span>uint32_t width<span class="token punctuation">,</span> uint32_t height<span class="token punctuation">,</span>
        PixelFormat format<span class="token punctuation">,</span> uint32_t layerCount<span class="token punctuation">,</span> uint64_t usage<span class="token punctuation">,</span>
        buffer_handle_t<span class="token operator">*</span> handle<span class="token punctuation">,</span> uint32_t<span class="token operator">*</span> stride<span class="token punctuation">,</span>
        uint64_t <span class="token comment" spellcheck="true">/*graphicBufferId*/</span><span class="token punctuation">,</span> std<span class="token operator">::</span>string requestorName<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// make sure to not allocate a N x 0 or 0 x N buffer, since this is</span>
    <span class="token comment" spellcheck="true">// allowed from an API stand-point allocate a 1x1 buffer instead.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>width <span class="token operator">||</span> <span class="token operator">!</span>height<span class="token punctuation">)</span>
        width <span class="token operator">=</span> height <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Ensure that layerCount is valid.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>layerCount <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
        layerCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    Gralloc2<span class="token operator">::</span>IMapper<span class="token operator">::</span>BufferDescriptorInfo info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>layerCount <span class="token operator">=</span> layerCount<span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>format <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>Gralloc2<span class="token operator">::</span>PixelFormat<span class="token operator">></span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>usage <span class="token operator">=</span> usage<span class="token punctuation">;</span>

    Gralloc2<span class="token operator">::</span>Error error <span class="token operator">=</span> mAllocator<span class="token operator">-</span><span class="token operator">></span><span class="token function">allocate</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> Gralloc2<span class="token operator">::</span>Error<span class="token operator">::</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>sLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        KeyedVector<span class="token operator">&lt;</span>buffer_handle_t<span class="token punctuation">,</span> alloc_rec_t<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">list</span><span class="token punctuation">(</span>sAllocList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        uint32_t bpp <span class="token operator">=</span> <span class="token function">bytesPerPixel</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
        alloc_rec_t rec<span class="token punctuation">;</span>
        rec<span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
        rec<span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
        rec<span class="token punctuation">.</span>stride <span class="token operator">=</span> <span class="token operator">*</span>stride<span class="token punctuation">;</span>
        rec<span class="token punctuation">.</span>format <span class="token operator">=</span> format<span class="token punctuation">;</span>
        rec<span class="token punctuation">.</span>layerCount <span class="token operator">=</span> layerCount<span class="token punctuation">;</span>
        rec<span class="token punctuation">.</span>usage <span class="token operator">=</span> usage<span class="token punctuation">;</span>
        rec<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">></span><span class="token punctuation">(</span>height <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>stride<span class="token punctuation">)</span> <span class="token operator">*</span> bpp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rec<span class="token punctuation">.</span>requestorName <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>requestorName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">*</span>handle<span class="token punctuation">,</span> rec<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> NO_MEMORY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心方法就是把buffer_handle_t句柄作为参数调用mAllocator的allocate方法，接着获得真正申请出来的参数保存到sAllocList中。之后删除就能通过handle找到对应的参数销毁。</p>
<h4 id="Gralloc2-Allocator-allocate"><a href="#Gralloc2-Allocator-allocate" class="headerlink" title="Gralloc2::Allocator allocate"></a>Gralloc2::Allocator allocate</h4><pre class="line-numbers language-cpp"><code class="language-cpp">    Error <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">const</span> IMapper<span class="token operator">::</span>BufferDescriptorInfo<span class="token operator">&amp;</span> descriptorInfo<span class="token punctuation">,</span> uint32_t count<span class="token punctuation">,</span>
            uint32_t<span class="token operator">*</span> outStride<span class="token punctuation">,</span> buffer_handle_t<span class="token operator">*</span> outBufferHandles<span class="token punctuation">)</span> <span class="token keyword">const</span>
    <span class="token punctuation">{</span>
        BufferDescriptor descriptor<span class="token punctuation">;</span>
        Error error <span class="token operator">=</span> mMapper<span class="token punctuation">.</span><span class="token function">createDescriptor</span><span class="token punctuation">(</span>descriptorInfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            error <span class="token operator">=</span> <span class="token function">allocate</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> count<span class="token punctuation">,</span> outStride<span class="token punctuation">,</span> outBufferHandles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Error <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">const</span> IMapper<span class="token operator">::</span>BufferDescriptorInfo<span class="token operator">&amp;</span> descriptorInfo<span class="token punctuation">,</span>
            uint32_t<span class="token operator">*</span> outStride<span class="token punctuation">,</span> buffer_handle_t<span class="token operator">*</span> outBufferHandle<span class="token punctuation">)</span> <span class="token keyword">const</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">allocate</span><span class="token punctuation">(</span>descriptorInfo<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> outStride<span class="token punctuation">,</span> outBufferHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先使用了Gralloc2::Mapper创建了BufferDescriptor对象。很简单就不去看，就是在Hal层初始化了BufferDescriptor对象。</p>
<pre><code>Error Allocator::allocate(BufferDescriptor descriptor, uint32_t count,
        uint32_t* outStride, buffer_handle_t* outBufferHandles) const
{
    Error error;
    auto ret = mAllocator-&gt;allocate(descriptor, count,
            [&amp;](const auto&amp; tmpError, const auto&amp; tmpStride,
                const auto&amp; tmpBuffers) {
                error = tmpError;
                if (tmpError != Error::NONE) {
                    return;
                }

                // import buffers
                for (uint32_t i = 0; i &lt; count; i++) {
                    error = mMapper.importBuffer(tmpBuffers[i],
                            &amp;outBufferHandles[i]);
                    if (error != Error::NONE) {
                        for (uint32_t j = 0; j &lt; i; j++) {
                            mMapper.freeBuffer(outBufferHandles[j]);
                            outBufferHandles[j] = nullptr;
                        }
                        return;
                    }
                }

                *outStride = tmpStride;
            });

    // make sure the kernel driver sees BC_FREE_BUFFER and closes the fds now
    hardware::IPCThreadState::self()-&gt;flushCommands();

    return (ret.isOk()) ? error : kTransactionError;
}</code></pre><p>能看到这里就会调用了Hal层对应AllocatorImpl的申请多个图元方法。能看到在申请完内存之后，将会调用GraphicBufferMapper的importBuffer方法，让这段句柄对应的内存变得可用。</p>
<h5 id="AllocatorImpl-allocate"><a href="#AllocatorImpl-allocate" class="headerlink" title="AllocatorImpl allocate"></a>AllocatorImpl allocate</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/" target="_blank" rel="noopener">allocator</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/hal/" target="_blank" rel="noopener">hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/hal/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/hal/include/allocator-hal/" target="_blank" rel="noopener">allocator-hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/hal/include/allocator-hal/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/hal/include/allocator-hal/2.0/Allocator.h" target="_blank" rel="noopener">Allocator.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    Return<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">const</span> BufferDescriptor<span class="token operator">&amp;</span> descriptor<span class="token punctuation">,</span> uint32_t count<span class="token punctuation">,</span>
                          IAllocator<span class="token operator">::</span>allocate_cb hidl_cb<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        uint32_t stride<span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> native_handle_t<span class="token operator">*</span><span class="token operator">></span> buffers<span class="token punctuation">;</span>
        Error error <span class="token operator">=</span> mHal<span class="token operator">-</span><span class="token operator">></span><span class="token function">allocateBuffers</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stride<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hidl_cb</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> hidl_vec<span class="token operator">&lt;</span>hidl_handle<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        hidl_vec<span class="token operator">&lt;</span>hidl_handle<span class="token operator">></span> <span class="token function">hidlBuffers</span><span class="token punctuation">(</span>buffers<span class="token punctuation">.</span><span class="token function">cbegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffers<span class="token punctuation">.</span><span class="token function">cend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">hidl_cb</span><span class="token punctuation">(</span>Error<span class="token operator">::</span>NONE<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> hidlBuffers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// free the local handles</span>
        mHal<span class="token operator">-</span><span class="token operator">></span><span class="token function">freeBuffers</span><span class="token punctuation">(</span>buffers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时还是一样调用mHal的allocateBuffers的方法，并且使用hidl_handle包装native_handle_t。换句话说，实际上我们在上层GraphicBuffer拿到的handle是hidl_handle对象。</p>
<h5 id="Gralloc0HalImpl-allocateBuffers"><a href="#Gralloc0HalImpl-allocateBuffers" class="headerlink" title="Gralloc0HalImpl::allocateBuffers"></a>Gralloc0HalImpl::allocateBuffers</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/" target="_blank" rel="noopener">allocator</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/passthrough/" target="_blank" rel="noopener">passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/passthrough/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/passthrough/include/allocator-passthrough/" target="_blank" rel="noopener">allocator-passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/passthrough/include/allocator-passthrough/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/allocator/2.0/utils/passthrough/include/allocator-passthrough/2.0/Gralloc0Hal.h" target="_blank" rel="noopener">Gralloc0Hal.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    Error <span class="token function">allocateBuffers</span><span class="token punctuation">(</span><span class="token keyword">const</span> BufferDescriptor<span class="token operator">&amp;</span> descriptor<span class="token punctuation">,</span> uint32_t count<span class="token punctuation">,</span> uint32_t<span class="token operator">*</span> outStride<span class="token punctuation">,</span>
                          std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> native_handle_t<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> outBuffers<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        mapper<span class="token operator">::</span>V2_0<span class="token operator">::</span>IMapper<span class="token operator">::</span>BufferDescriptorInfo descriptorInfo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">grallocDecodeBufferDescriptor</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token operator">&amp;</span>descriptorInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Error<span class="token operator">::</span>BAD_DESCRIPTOR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Error error <span class="token operator">=</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">;</span>
        uint32_t stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> native_handle_t<span class="token operator">*</span><span class="token operator">></span> buffers<span class="token punctuation">;</span>
        buffers<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// allocate the buffers</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>uint32_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> native_handle_t<span class="token operator">*</span> tmpBuffer<span class="token punctuation">;</span>
            uint32_t tmpStride<span class="token punctuation">;</span>
            error <span class="token operator">=</span> <span class="token function">allocateOneBuffer</span><span class="token punctuation">(</span>descriptorInfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmpBuffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmpStride<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            buffers<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>tmpBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>stride <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stride <span class="token operator">=</span> tmpStride<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stride <span class="token operator">!=</span> tmpStride<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// non-uniform strides</span>
                error <span class="token operator">=</span> Error<span class="token operator">::</span>UNSUPPORTED<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token operator">*</span>outStride <span class="token operator">=</span> stride<span class="token punctuation">;</span>
        <span class="token operator">*</span>outBuffers <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>buffers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心的方法是allocateOneBuffer申请一个图元内存。我们直接看对应的gralloc的实现。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    Error <span class="token function">allocateOneBuffer</span><span class="token punctuation">(</span><span class="token keyword">const</span> mapper<span class="token operator">::</span>V2_0<span class="token operator">::</span>IMapper<span class="token operator">::</span>BufferDescriptorInfo<span class="token operator">&amp;</span> info<span class="token punctuation">,</span>
                            <span class="token keyword">const</span> native_handle_t<span class="token operator">*</span><span class="token operator">*</span> outBuffer<span class="token punctuation">,</span> uint32_t<span class="token operator">*</span> outStride<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>layerCount <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>usage <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Error<span class="token operator">::</span>BAD_VALUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> native_handle_t<span class="token operator">*</span> buffer <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> mDevice<span class="token operator">-</span><span class="token operator">></span><span class="token function">alloc</span><span class="token punctuation">(</span>mDevice<span class="token punctuation">,</span> info<span class="token punctuation">.</span>width<span class="token punctuation">,</span> info<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>format<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    info<span class="token punctuation">.</span>usage<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token operator">*</span>outBuffer <span class="token operator">=</span> buffer<span class="token punctuation">;</span>
                <span class="token operator">*</span>outStride <span class="token operator">=</span> stride<span class="token punctuation">;</span>
                <span class="token keyword">return</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token operator">-</span>EINVAL<span class="token operator">:</span>
                <span class="token keyword">return</span> Error<span class="token operator">::</span>BAD_VALUE<span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">return</span> Error<span class="token operator">::</span>NO_RESOURCES<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="gpu-context-t-gralloc-alloc"><a href="#gpu-context-t-gralloc-alloc" class="headerlink" title="gpu_context_t::gralloc_alloc"></a>gpu_context_t::gralloc_alloc</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/" target="_blank" rel="noopener">libgralloc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/gpu.cpp" target="_blank" rel="noopener">gpu.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> gpu_context_t<span class="token operator">::</span><span class="token function">gralloc_alloc</span><span class="token punctuation">(</span>alloc_device_t<span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> h<span class="token punctuation">,</span> <span class="token keyword">int</span> format<span class="token punctuation">,</span>
                                 <span class="token keyword">int</span> usage<span class="token punctuation">,</span> buffer_handle_t<span class="token operator">*</span> pHandle<span class="token punctuation">,</span>
                                 <span class="token keyword">int</span><span class="token operator">*</span> pStride<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gpu_context_t<span class="token operator">*</span> gpu <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>gpu_context_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> gpu<span class="token operator">-</span><span class="token operator">></span><span class="token function">alloc_impl</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> format<span class="token punctuation">,</span> usage<span class="token punctuation">,</span> pHandle<span class="token punctuation">,</span> pStride<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="gpu-context-t-alloc-impl"><a href="#gpu-context-t-alloc-impl" class="headerlink" title="gpu_context_t::alloc_impl"></a>gpu_context_t::alloc_impl</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> gpu_context_t<span class="token operator">::</span><span class="token function">alloc_impl</span><span class="token punctuation">(</span><span class="token keyword">int</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> h<span class="token punctuation">,</span> <span class="token keyword">int</span> format<span class="token punctuation">,</span> <span class="token keyword">int</span> usage<span class="token punctuation">,</span>
                              buffer_handle_t<span class="token operator">*</span> pHandle<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> pStride<span class="token punctuation">,</span>
                              size_t bufferSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pHandle <span class="token operator">||</span> <span class="token operator">!</span>pStride<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    size_t size<span class="token punctuation">;</span>
    <span class="token keyword">int</span> alignedw<span class="token punctuation">,</span> alignedh<span class="token punctuation">;</span>
    <span class="token keyword">int</span> grallocFormat <span class="token operator">=</span> format<span class="token punctuation">;</span>
    <span class="token keyword">int</span> bufferType<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//If input format is HAL_PIXEL_FORMAT_IMPLEMENTATION_DEFINED then based on</span>
    <span class="token comment" spellcheck="true">//the usage bits, gralloc assigns a format.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">getGrallocInformationFromFormat</span><span class="token punctuation">(</span>grallocFormat<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bufferType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size <span class="token operator">=</span> <span class="token function">getBufferSizeAndDimensions</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> grallocFormat<span class="token punctuation">,</span> alignedw<span class="token punctuation">,</span> alignedh<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    size <span class="token operator">=</span> <span class="token punctuation">(</span>bufferSize <span class="token operator">>=</span> size<span class="token punctuation">)</span><span class="token operator">?</span> bufferSize <span class="token operator">:</span> size<span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_EXTERNAL_DISP<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_PROTECTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bufferType <span class="token operator">=</span> BUFFER_TYPE_VIDEO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> useFbMem <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> property<span class="token punctuation">[</span>PROPERTY_VALUE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_HW_FB<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
       <span class="token punctuation">(</span><span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"debug.gralloc.map_fb_memory"</span><span class="token punctuation">,</span> property<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
       <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> PROPERTY_VALUE_MAX <span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span><span class="token string">"true"</span><span class="token punctuation">,</span> PROPERTY_VALUE_MAX <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        useFbMem <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>useFbMem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token function">gralloc_alloc_framebuffer</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> usage<span class="token punctuation">,</span> pHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token function">gralloc_alloc_buffer</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> usage<span class="token punctuation">,</span> pHandle<span class="token punctuation">,</span> bufferType<span class="token punctuation">,</span>
                                   grallocFormat<span class="token punctuation">,</span> alignedw<span class="token punctuation">,</span> alignedh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>pStride <span class="token operator">=</span> alignedw<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>getBufferSizeAndDimensions计算不同规格像素需要占用的内存大小。接着检测debug.gralloc.map_fb_memory是否在全局变量中设置开，打开了gralloc服务也会强制使用fb驱动。</p>
<p>我们先不管fb驱动的逻辑，先看gralloc逻辑。调用gralloc_alloc_buffer。</p>
<h5 id="gralloc-alloc-buffer"><a href="#gralloc-alloc-buffer" class="headerlink" title="gralloc_alloc_buffer"></a>gralloc_alloc_buffer</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> gpu_context_t<span class="token operator">::</span><span class="token function">gralloc_alloc_buffer</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">,</span> <span class="token keyword">int</span> usage<span class="token punctuation">,</span>
                                        buffer_handle_t<span class="token operator">*</span> pHandle<span class="token punctuation">,</span> <span class="token keyword">int</span> bufferType<span class="token punctuation">,</span>
                                        <span class="token keyword">int</span> format<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    size <span class="token operator">=</span> <span class="token function">roundUpToPageSize</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    alloc_data data<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>format <span class="token operator">==</span> HAL_PIXEL_FORMAT_YCbCr_420_SP_TILED<span class="token punctuation">)</span>
        data<span class="token punctuation">.</span>align <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        data<span class="token punctuation">.</span>align <span class="token operator">=</span> <span class="token function">getpagesize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>qdutils<span class="token operator">::</span>MDPVersion<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMDPVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> \
         qdutils<span class="token operator">::</span>MDSS_V5<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_PROTECTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>align <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>align<span class="token punctuation">,</span> SZ_1M<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">.</span>align<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    data<span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>pHandle <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span> pHandle<span class="token punctuation">;</span>
    err <span class="token operator">=</span> mAllocCtrl<span class="token operator">-</span><span class="token operator">></span><span class="token function">allocate</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> usage<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* allocate memory for enhancement data */</span>
        alloc_data eData<span class="token punctuation">;</span>
        eData<span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        eData<span class="token punctuation">.</span>base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        eData<span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        eData<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token function">ROUND_UP_PAGESIZE</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>MetaData_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eData<span class="token punctuation">.</span>pHandle <span class="token operator">=</span> data<span class="token punctuation">.</span>pHandle<span class="token punctuation">;</span>
        eData<span class="token punctuation">.</span>align <span class="token operator">=</span> <span class="token function">getpagesize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> eDataUsage <span class="token operator">=</span> GRALLOC_USAGE_PRIVATE_SYSTEM_HEAP<span class="token punctuation">;</span>
        <span class="token keyword">int</span> eDataErr <span class="token operator">=</span> mAllocCtrl<span class="token operator">-</span><span class="token operator">></span><span class="token function">allocate</span><span class="token punctuation">(</span>eData<span class="token punctuation">,</span> eDataUsage<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        flags <span class="token operator">|</span><span class="token operator">=</span> data<span class="token punctuation">.</span>allocType<span class="token punctuation">;</span>
        <span class="token keyword">int</span> eBaseAddr <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>eData<span class="token punctuation">.</span>base<span class="token punctuation">)</span> <span class="token operator">+</span> eData<span class="token punctuation">.</span>offset<span class="token punctuation">;</span>
        private_handle_t <span class="token operator">*</span>hnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">private_handle_t</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> size<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                bufferType<span class="token punctuation">,</span> format<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> eData<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> eData<span class="token punctuation">.</span>offset<span class="token punctuation">,</span>
                eBaseAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        hnd<span class="token operator">-</span><span class="token operator">></span>offset <span class="token operator">=</span> data<span class="token punctuation">.</span>offset<span class="token punctuation">;</span>
        hnd<span class="token operator">-</span><span class="token operator">></span>base <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>base<span class="token punctuation">)</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>offset<span class="token punctuation">;</span>
        hnd<span class="token operator">-</span><span class="token operator">></span>gpuaddr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token operator">*</span>pHandle <span class="token operator">=</span> hnd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>alloc_data中保存handle句柄，让IonController处理。当IonController.allocate申请完内存后，alloc_data记录记录映射的共享内存的起点位置和长度，以及对应的fd。这个fd很重要，fd究竟是指什么驱动呢？我们往下看。</p>
<h4 id="IonController-allocate"><a href="#IonController-allocate" class="headerlink" title="IonController allocate"></a>IonController allocate</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/" target="_blank" rel="noopener">libgralloc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/alloc_controller.cpp" target="_blank" rel="noopener">alloc_controller.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> IonController<span class="token operator">::</span><span class="token function">allocate</span><span class="token punctuation">(</span>alloc_data<span class="token operator">&amp;</span> data<span class="token punctuation">,</span> <span class="token keyword">int</span> usage<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ionFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    data<span class="token punctuation">.</span>uncached <span class="token operator">=</span> <span class="token function">useUncached</span><span class="token punctuation">(</span>usage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>allocType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_PRIVATE_UI_CONTIG_HEAP<span class="token punctuation">)</span>
        ionFlags <span class="token operator">|</span><span class="token operator">=</span> <span class="token function">ION_HEAP</span><span class="token punctuation">(</span>ION_SF_HEAP_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_PRIVATE_SYSTEM_HEAP<span class="token punctuation">)</span>
        ionFlags <span class="token operator">|</span><span class="token operator">=</span> <span class="token function">ION_HEAP</span><span class="token punctuation">(</span>ION_SYSTEM_HEAP_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_PRIVATE_IOMMU_HEAP<span class="token punctuation">)</span>
        ionFlags <span class="token operator">|</span><span class="token operator">=</span> <span class="token function">ION_HEAP</span><span class="token punctuation">(</span>ION_IOMMU_HEAP_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//MM Heap is exclusively a secure heap.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_PRIVATE_MM_HEAP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_PROTECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ionFlags <span class="token operator">|</span><span class="token operator">=</span> <span class="token function">ION_HEAP</span><span class="token punctuation">(</span>ION_CP_MM_HEAP_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ionFlags <span class="token operator">|</span><span class="token operator">=</span> ION_SECURE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>

            ionFlags <span class="token operator">|</span><span class="token operator">=</span> <span class="token function">ION_HEAP</span><span class="token punctuation">(</span>ION_IOMMU_HEAP_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_PRIVATE_CAMERA_HEAP<span class="token punctuation">)</span>
        ionFlags <span class="token operator">|</span><span class="token operator">=</span> <span class="token function">ION_HEAP</span><span class="token punctuation">(</span>ION_CAMERA_HEAP_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_PROTECTED<span class="token punctuation">)</span>
         data<span class="token punctuation">.</span>allocType <span class="token operator">|</span><span class="token operator">=</span> private_handle_t<span class="token operator">::</span>PRIV_FLAGS_SECURE_BUFFER<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ionFlags<span class="token punctuation">)</span>
        ionFlags <span class="token operator">=</span> <span class="token function">ION_HEAP</span><span class="token punctuation">(</span>ION_SF_HEAP_ID<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">ION_HEAP</span><span class="token punctuation">(</span>ION_IOMMU_HEAP_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    data<span class="token punctuation">.</span>flags <span class="token operator">=</span> ionFlags<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> mIonAlloc<span class="token operator">-</span><span class="token operator">></span><span class="token function">alloc_buffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Fallback</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">canFallback</span><span class="token punctuation">(</span>usage<span class="token punctuation">,</span>
                              <span class="token punctuation">(</span>ionFlags <span class="token operator">&amp;</span> ION_SYSTEM_HEAP_ID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Falling back to system heap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token function">ION_HEAP</span><span class="token punctuation">(</span>ION_SYSTEM_HEAP_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> mIonAlloc<span class="token operator">-</span><span class="token operator">></span><span class="token function">alloc_buffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>allocType <span class="token operator">|</span><span class="token operator">=</span> private_handle_t<span class="token operator">::</span>PRIV_FLAGS_USES_ION<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="IonAlloc-alloc-buffer"><a href="#IonAlloc-alloc-buffer" class="headerlink" title="IonAlloc alloc_buffer"></a>IonAlloc alloc_buffer</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/" target="_blank" rel="noopener">libgralloc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/ionalloc.cpp" target="_blank" rel="noopener">ionalloc.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> ION_DEVICE "/dev/ion"</span>

<span class="token keyword">int</span> IonAlloc<span class="token operator">::</span><span class="token function">alloc_buffer</span><span class="token punctuation">(</span>alloc_data<span class="token operator">&amp;</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Locker<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_handle_data handle_data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_fd_data fd_data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ion_allocation_data ionAllocData<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    ionAllocData<span class="token punctuation">.</span>len <span class="token operator">=</span> data<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
    ionAllocData<span class="token punctuation">.</span>align <span class="token operator">=</span> data<span class="token punctuation">.</span>align<span class="token punctuation">;</span>
    ionAllocData<span class="token punctuation">.</span>heap_id_mask <span class="token operator">=</span> data<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token operator">~</span>ION_SECURE<span class="token punctuation">;</span>
    ionAllocData<span class="token punctuation">.</span>flags <span class="token operator">=</span> data<span class="token punctuation">.</span>uncached <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> ION_FLAG_CACHED<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ION_SECURE<span class="token punctuation">)</span>
        ionAllocData<span class="token punctuation">.</span>flags <span class="token operator">|</span><span class="token operator">=</span> ION_SECURE<span class="token punctuation">;</span>

    err <span class="token operator">=</span> <span class="token function">open_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>mIonFd<span class="token punctuation">,</span> ION_IOC_ALLOC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ionAllocData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fd_data<span class="token punctuation">.</span>handle <span class="token operator">=</span> ionAllocData<span class="token punctuation">.</span>handle<span class="token punctuation">;</span>
    handle_data<span class="token punctuation">.</span>handle <span class="token operator">=</span> ionAllocData<span class="token punctuation">.</span>handle<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>mIonFd<span class="token punctuation">,</span> ION_IOC_MAP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
        <span class="token function">ioctl</span><span class="token punctuation">(</span>mIonFd<span class="token punctuation">,</span> ION_IOC_FREE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ION_SECURE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        base <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ionAllocData<span class="token punctuation">.</span>len<span class="token punctuation">,</span> PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span>
                    MAP_SHARED<span class="token punctuation">,</span> fd_data<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>base <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            err <span class="token operator">=</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
            <span class="token function">ioctl</span><span class="token punctuation">(</span>mIonFd<span class="token punctuation">,</span> ION_IOC_FREE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ionAllocData<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Clean cache after memset</span>
        <span class="token function">clean_buffer</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> data<span class="token punctuation">.</span>size<span class="token punctuation">,</span> data<span class="token punctuation">.</span>offset<span class="token punctuation">,</span> fd_data<span class="token punctuation">.</span>fd<span class="token punctuation">,</span>
                     CACHE_CLEAN_AND_INVALIDATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    data<span class="token punctuation">.</span>base <span class="token operator">=</span> base<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd_data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
    <span class="token function">ioctl</span><span class="token punctuation">(</span>mIonFd<span class="token punctuation">,</span> ION_IOC_FREE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>IonController通过format预计完需要申请的图元内存大小，就调用IonAlloc的allocate。在这个方法中做的事情核心有三件：</p>
<ul>
<li>1.打开/dev/ion 驱动，在驱动中创建一个ion_client对象</li>
<li>2.调用ioctl 传入ION_IOC_ALLOC ，在底层创建一个ion_buffer区域，并和ion_handle_data绑定。</li>
<li>3.ioctl 传入ION_IOC_MAP 进行ion_allocation_data的内存和里面fd文件句柄进行绑定，也即是有了一个匿名文件。</li>
<li>4.如果不是安全模式，mmap 映射一段共享的地址在base中，并且让虚拟内存和ion管理的page绑定。</li>
</ul>
<h3 id="GraphicBufferMapper-importBuffer"><a href="#GraphicBufferMapper-importBuffer" class="headerlink" title="GraphicBufferMapper importBuffer"></a>GraphicBufferMapper importBuffer</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/ui/" target="_blank" rel="noopener">ui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/ui/GraphicBufferMapper.cpp" target="_blank" rel="noopener">GraphicBufferMapper.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t GraphicBufferMapper<span class="token operator">::</span><span class="token function">importBuffer</span><span class="token punctuation">(</span>buffer_handle_t rawHandle<span class="token punctuation">,</span>
        uint32_t width<span class="token punctuation">,</span> uint32_t height<span class="token punctuation">,</span> uint32_t layerCount<span class="token punctuation">,</span>
        PixelFormat format<span class="token punctuation">,</span> uint64_t usage<span class="token punctuation">,</span> uint32_t stride<span class="token punctuation">,</span>
        buffer_handle_t<span class="token operator">*</span> outHandle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    buffer_handle_t bufferHandle<span class="token punctuation">;</span>
    Gralloc2<span class="token operator">::</span>Error error <span class="token operator">=</span> mMapper<span class="token operator">-</span><span class="token operator">></span><span class="token function">importBuffer</span><span class="token punctuation">(</span>
            hardware<span class="token operator">::</span><span class="token function">hidl_handle</span><span class="token punctuation">(</span>rawHandle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bufferHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    Gralloc2<span class="token operator">::</span>IMapper<span class="token operator">::</span>BufferDescriptorInfo info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>layerCount <span class="token operator">=</span> layerCount<span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>format <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>Gralloc2<span class="token operator">::</span>PixelFormat<span class="token operator">></span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>usage <span class="token operator">=</span> usage<span class="token punctuation">;</span>

    error <span class="token operator">=</span> mMapper<span class="token operator">-</span><span class="token operator">></span><span class="token function">validateBufferSize</span><span class="token punctuation">(</span>bufferHandle<span class="token punctuation">,</span> info<span class="token punctuation">,</span> stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">*</span>outHandle <span class="token operator">=</span> bufferHandle<span class="token punctuation">;</span>

    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能上面的allocate方法只能此时的句柄是hidl_handle，而hidl_handle成为rawHandle，这个句柄还不能使用。需要经过importBuffer经过转化才能使用。最后需要校验buffer的大小</p>
<h4 id="MapperImpl-importBuffer"><a href="#MapperImpl-importBuffer" class="headerlink" title="MapperImpl importBuffer"></a>MapperImpl importBuffer</h4><pre class="line-numbers language-cpp"><code class="language-cpp">  Return<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">importBuffer</span><span class="token punctuation">(</span><span class="token keyword">const</span> hidl_handle<span class="token operator">&amp;</span> rawHandle<span class="token punctuation">,</span>
                              IMapper<span class="token operator">::</span>importBuffer_cb hidl_cb<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        native_handle_t<span class="token operator">*</span> bufferHandle <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        Error error <span class="token operator">=</span> mHal<span class="token operator">-</span><span class="token operator">></span><span class="token function">importBuffer</span><span class="token punctuation">(</span>rawHandle<span class="token punctuation">.</span><span class="token function">getNativeHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bufferHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hidl_cb</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span><span class="token operator">*</span> buffer <span class="token operator">=</span> <span class="token function">addImportedBuffer</span><span class="token punctuation">(</span>bufferHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mHal<span class="token operator">-</span><span class="token operator">></span><span class="token function">freeBuffer</span><span class="token punctuation">(</span>bufferHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">hidl_cb</span><span class="token punctuation">(</span>Error<span class="token operator">::</span>NO_RESOURCES<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">hidl_cb</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在MapperImpl中，把importBuffer分成2步骤。</p>
<ul>
<li>1.Gralloc0HalImpl importBuffer</li>
<li>2.import 处理完Buffer后，addImportedBuffer把每一个Handle都添加到GrallocImportedBufferPool一个缓存池中，缓存起来。</li>
</ul>
<h4 id="Gralloc0HalImpl-importBuffer"><a href="#Gralloc0HalImpl-importBuffer" class="headerlink" title="Gralloc0HalImpl importBuffer"></a>Gralloc0HalImpl importBuffer</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/" target="_blank" rel="noopener">mapper</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/" target="_blank" rel="noopener">passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/mapper-passthrough/" target="_blank" rel="noopener">mapper-passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/mapper-passthrough/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/mapper-passthrough/2.0/Gralloc0Hal.h" target="_blank" rel="noopener">Gralloc0Hal.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    Error <span class="token function">importBuffer</span><span class="token punctuation">(</span><span class="token keyword">const</span> native_handle_t<span class="token operator">*</span> rawHandle<span class="token punctuation">,</span>
                       native_handle_t<span class="token operator">*</span><span class="token operator">*</span> outBufferHandle<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        native_handle_t<span class="token operator">*</span> bufferHandle <span class="token operator">=</span> <span class="token function">native_handle_clone</span><span class="token punctuation">(</span>rawHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mModule<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerBuffer</span><span class="token punctuation">(</span>mModule<span class="token punctuation">,</span> bufferHandle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> Error<span class="token operator">::</span>BAD_BUFFER<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token operator">*</span>outBufferHandle <span class="token operator">=</span> bufferHandle<span class="token punctuation">;</span>

        <span class="token keyword">return</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时importBuffer对应的方法就是registerBuffer。在mMapper中，是直接操作hw_module_t。</p>
<h5 id="hw-module-t"><a href="#hw-module-t" class="headerlink" title="hw_module_t"></a>hw_module_t</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/" target="_blank" rel="noopener">libgralloc</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libgralloc/mapper.cpp" target="_blank" rel="noopener">mapper.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">gralloc_register_buffer</span><span class="token punctuation">(</span>gralloc_module_t <span class="token keyword">const</span><span class="token operator">*</span> module<span class="token punctuation">,</span>
                            buffer_handle_t handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    private_handle_t<span class="token operator">*</span> hnd <span class="token operator">=</span> <span class="token punctuation">(</span>private_handle_t<span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">;</span>
    hnd<span class="token operator">-</span><span class="token operator">></span>base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    hnd<span class="token operator">-</span><span class="token operator">></span>base_metadata <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">gralloc_map</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时才会调用gralloc_map，真正进行mmap进行映射。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">gralloc_map</span><span class="token punctuation">(</span>gralloc_module_t <span class="token keyword">const</span><span class="token operator">*</span> module<span class="token punctuation">,</span>
                       buffer_handle_t handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    private_handle_t<span class="token operator">*</span> hnd <span class="token operator">=</span> <span class="token punctuation">(</span>private_handle_t<span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>mappedAddress<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>hnd<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> private_handle_t<span class="token operator">::</span>PRIV_FLAGS_FRAMEBUFFER<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>hnd<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> private_handle_t<span class="token operator">::</span>PRIV_FLAGS_SECURE_BUFFER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        size_t size <span class="token operator">=</span> hnd<span class="token operator">-</span><span class="token operator">></span>size<span class="token punctuation">;</span>
        IMemAlloc<span class="token operator">*</span> memalloc <span class="token operator">=</span> <span class="token function">getAllocator</span><span class="token punctuation">(</span>hnd<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token keyword">int</span> err <span class="token operator">=</span> memalloc<span class="token operator">-</span><span class="token operator">></span><span class="token function">map_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mappedAddress<span class="token punctuation">,</span> size<span class="token punctuation">,</span>
                                       hnd<span class="token operator">-</span><span class="token operator">></span>offset<span class="token punctuation">,</span> hnd<span class="token operator">-</span><span class="token operator">></span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">||</span> mappedAddress <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hnd<span class="token operator">-</span><span class="token operator">></span>base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        hnd<span class="token operator">-</span><span class="token operator">></span>base <span class="token operator">=</span> <span class="token function">intptr_t</span><span class="token punctuation">(</span>mappedAddress<span class="token punctuation">)</span> <span class="token operator">+</span> hnd<span class="token operator">-</span><span class="token operator">></span>offset<span class="token punctuation">;</span>
        mappedAddress <span class="token operator">=</span> MAP_FAILED<span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token function">ROUND_UP_PAGESIZE</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>MetaData_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        err <span class="token operator">=</span> memalloc<span class="token operator">-</span><span class="token operator">></span><span class="token function">map_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mappedAddress<span class="token punctuation">,</span> size<span class="token punctuation">,</span>
                                       hnd<span class="token operator">-</span><span class="token operator">></span>offset_metadata<span class="token punctuation">,</span> hnd<span class="token operator">-</span><span class="token operator">></span>fd_metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">||</span> mappedAddress <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hnd<span class="token operator">-</span><span class="token operator">></span>base_metadata <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        hnd<span class="token operator">-</span><span class="token operator">></span>base_metadata <span class="token operator">=</span> <span class="token function">intptr_t</span><span class="token punctuation">(</span>mappedAddress<span class="token punctuation">)</span> <span class="token operator">+</span> hnd<span class="token operator">-</span><span class="token operator">></span>offset_metadata<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时会调用ionalloc的map_buffer，为hnd的mappedAddress进行映射。映射了2段内存。一段是从mappedAddress到hnd-&gt;offset的，另一段是重新申请的mappedAddress到offset_metadata。记住这两个base。换句话说，只有此时才给handle中的base赋值共享内存的地址。</p>
<h3 id="GraphicBufferMapper-lock"><a href="#GraphicBufferMapper-lock" class="headerlink" title="GraphicBufferMapper lock"></a>GraphicBufferMapper lock</h3><p>类似的流程，我们直接看核心方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">gralloc_lock</span><span class="token punctuation">(</span>gralloc_module_t <span class="token keyword">const</span><span class="token operator">*</span> module<span class="token punctuation">,</span>
                 buffer_handle_t handle<span class="token punctuation">,</span> <span class="token keyword">int</span> usage<span class="token punctuation">,</span>
                 <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> h<span class="token punctuation">,</span>
                 <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> vaddr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    private_handle_t<span class="token operator">*</span> hnd <span class="token operator">=</span> <span class="token punctuation">(</span>private_handle_t<span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">;</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">gralloc_map_and_invalidate</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> usage<span class="token punctuation">,</span> l<span class="token punctuation">,</span> t<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span>
        <span class="token operator">*</span>vaddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>hnd<span class="token operator">-</span><span class="token operator">></span>base<span class="token punctuation">;</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">gralloc_map_and_invalidate</span> <span class="token punctuation">(</span>gralloc_module_t <span class="token keyword">const</span><span class="token operator">*</span> module<span class="token punctuation">,</span>
                                       buffer_handle_t handle<span class="token punctuation">,</span> <span class="token keyword">int</span> usage<span class="token punctuation">,</span>
                                       <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> h<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>private_handle_t<span class="token operator">::</span><span class="token function">validate</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    private_handle_t<span class="token operator">*</span> hnd <span class="token operator">=</span> <span class="token punctuation">(</span>private_handle_t<span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> <span class="token punctuation">(</span>GRALLOC_USAGE_SW_READ_MASK <span class="token operator">|</span> GRALLOC_USAGE_SW_WRITE_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hnd<span class="token operator">-</span><span class="token operator">></span>base <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// we need to map for real</span>
            pthread_mutex_t<span class="token operator">*</span> <span class="token keyword">const</span> lock <span class="token operator">=</span> <span class="token operator">&amp;</span>sMapLock<span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            err <span class="token operator">=</span> <span class="token function">gralloc_map</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        IMemAlloc<span class="token operator">*</span> memalloc <span class="token operator">=</span> <span class="token function">getAllocator</span><span class="token punctuation">(</span>hnd<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">)</span> <span class="token punctuation">;</span>
        err <span class="token operator">=</span> memalloc<span class="token operator">-</span><span class="token operator">></span><span class="token function">clean_buffer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>hnd<span class="token operator">-</span><span class="token operator">></span>base<span class="token punctuation">,</span>
                                     hnd<span class="token operator">-</span><span class="token operator">></span>size<span class="token punctuation">,</span> hnd<span class="token operator">-</span><span class="token operator">></span>offset<span class="token punctuation">,</span> hnd<span class="token operator">-</span><span class="token operator">></span>fd<span class="token punctuation">,</span>
                                     CACHE_INVALIDATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>usage <span class="token operator">&amp;</span> GRALLOC_USAGE_SW_WRITE_MASK<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token punctuation">(</span>hnd<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> private_handle_t<span class="token operator">::</span>PRIV_FLAGS_FRAMEBUFFER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hnd<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">|</span><span class="token operator">=</span> private_handle_t<span class="token operator">::</span>PRIV_FLAGS_NEEDS_FLUSH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        hnd<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">|</span><span class="token operator">=</span> private_handle_t<span class="token operator">::</span>PRIV_FLAGS_DO_NOT_FLUSH<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时lock核心的思想，调用gralloc_map_and_invalidate，检测private_handle_t中的base的字段有没有进行映射过，没有就进行一次映射。接着就初始化这一段内存的资源，最后让句柄中hnd-&gt;base共享地址的资源赋值给addr，这个地址是什么？其实就是ANativeWindowBuffer中的bits字段。这样private_handle_t中的base就和ANativeWindowBuffer的bits关联起来。</p>
<p>此时才能正常的操作整个图元。</p>
<h3 id="GraphicBuffer-的跨进程通信"><a href="#GraphicBuffer-的跨进程通信" class="headerlink" title="GraphicBuffer 的跨进程通信"></a>GraphicBuffer 的跨进程通信</h3><p>前文说过GraphicBuffer的数据太大了，没有办法进行Binder通信，那么他为什么可以办到binder返回呢？我们先去图元生产者的基类IGraphicBufferProducer 的远程端：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">BpGraphicBufferProducer</span> <span class="token operator">:</span> <span class="token keyword">public</span> BpInterface<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">></span>
<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">explicit</span> <span class="token function">BpGraphicBufferProducer</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> impl<span class="token punctuation">)</span>
        <span class="token operator">:</span> BpInterface<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">></span><span class="token punctuation">(</span>impl<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">BpGraphicBufferProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override<span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> status_t <span class="token function">requestBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> bufferIdx<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span><span class="token operator">*</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Parcel data<span class="token punctuation">,</span> reply<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span>IGraphicBufferProducer<span class="token operator">::</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">writeInt32</span><span class="token punctuation">(</span>bufferIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        status_t result <span class="token operator">=</span><span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">transact</span><span class="token punctuation">(</span>REQUEST_BUFFER<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">bool</span> nonNull <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nonNull<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">GraphicBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">(</span><span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        result <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实就在App进程中new了一个GraphicBuffer对象，但是这个对象展示不会去ion申请内存。而是调用了read的方法，继续解压缩reply返回的数据包。因为GraphicBuffer是一个Flatten对象，因此会走到GraphicBuffer的unflatten方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t GraphicBuffer<span class="token operator">::</span><span class="token function">unflatten</span><span class="token punctuation">(</span>
        <span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&amp;</span> buffer<span class="token punctuation">,</span> size_t<span class="token operator">&amp;</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&amp;</span> fds<span class="token punctuation">,</span> size_t<span class="token operator">&amp;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">int</span> <span class="token keyword">const</span><span class="token operator">*</span> buf <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        native_handle<span class="token operator">*</span> h <span class="token operator">=</span> <span class="token function">native_handle_create</span><span class="token punctuation">(</span>
                <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>numFds<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>numInts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>h<span class="token operator">-</span><span class="token operator">></span>data<span class="token punctuation">,</span> fds<span class="token punctuation">,</span> numFds <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>h<span class="token operator">-</span><span class="token operator">></span>data <span class="token operator">+</span> numFds<span class="token punctuation">,</span> buf <span class="token operator">+</span> flattenWordCount<span class="token punctuation">,</span> numInts <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handle <span class="token operator">=</span> h<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    mId <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint64_t<span class="token operator">></span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span>
    mId <span class="token operator">|</span><span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mGenerationNumber <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mOwner <span class="token operator">=</span> ownHandle<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer_handle_t importedHandle<span class="token punctuation">;</span>
        status_t err <span class="token operator">=</span> mBufferMapper<span class="token punctuation">.</span><span class="token function">importBuffer</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token function">uint32_t</span><span class="token punctuation">(</span>width<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint32_t</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">uint32_t</span><span class="token punctuation">(</span>layerCount<span class="token punctuation">)</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> usage<span class="token punctuation">,</span> <span class="token function">uint32_t</span><span class="token punctuation">(</span>stride<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>importedHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">native_handle_close</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">native_handle_delete</span><span class="token punctuation">(</span><span class="token keyword">const_cast</span><span class="token operator">&lt;</span>native_handle_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handle <span class="token operator">=</span> importedHandle<span class="token punctuation">;</span>
        mBufferMapper<span class="token punctuation">.</span><span class="token function">getTransportSize</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mTransportNumFds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mTransportNumInts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    buffer <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint8_t <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">+</span> sizeNeeded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size <span class="token operator">-</span><span class="token operator">=</span> sizeNeeded<span class="token punctuation">;</span>
    fds <span class="token operator">+</span><span class="token operator">=</span> numFds<span class="token punctuation">;</span>
    count <span class="token operator">-</span><span class="token operator">=</span> numFds<span class="token punctuation">;</span>

    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时就把整个handle拷贝过来了，接着调用importBuffer，把handle转化从hidl_handle转化为可用的private_handle_t。记住此时一般是deqeue方法中调用，此时还没有lock，因此还没有和底层共享内存关联。</p>
<p>但是最重要的SF进程和App进程之间同一个handle的GraphicBuffer没有进行关联，我们来看看MapperImpl的lock方法：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/" target="_blank" rel="noopener">mapper</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/hal/" target="_blank" rel="noopener">hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/hal/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/hal/include/mapper-hal/" target="_blank" rel="noopener">mapper-hal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/hal/include/mapper-hal/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/hal/include/mapper-hal/2.0/Mapper.h" target="_blank" rel="noopener">Mapper.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    Return<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> uint64_t cpuUsage<span class="token punctuation">,</span> <span class="token keyword">const</span> V2_0<span class="token operator">::</span>IMapper<span class="token operator">::</span>Rect<span class="token operator">&amp;</span> accessRegion<span class="token punctuation">,</span>
                      <span class="token keyword">const</span> hidl_handle<span class="token operator">&amp;</span> acquireFence<span class="token punctuation">,</span> IMapper<span class="token operator">::</span>lock_cb hidl_cb<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        <span class="token keyword">const</span> native_handle_t<span class="token operator">*</span> bufferHandle <span class="token operator">=</span> <span class="token function">getImportedBuffer</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bufferHandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hidl_cb</span><span class="token punctuation">(</span>Error<span class="token operator">::</span>BAD_BUFFER<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        base<span class="token operator">::</span>unique_fd fenceFd<span class="token punctuation">;</span>
        Error error <span class="token operator">=</span> <span class="token function">getFenceFd</span><span class="token punctuation">(</span>acquireFence<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hidl_cb</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span><span class="token operator">*</span> data <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        error <span class="token operator">=</span> mHal<span class="token operator">-</span><span class="token operator">></span><span class="token function">lock</span><span class="token punctuation">(</span>bufferHandle<span class="token punctuation">,</span> cpuUsage<span class="token punctuation">,</span> accessRegion<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">hidl_cb</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在进行mmap共享内存绑定之前，会通过getImportedBuffer查找已经在GrallocImportedBufferPool缓存下来的图元数据的句柄native_handle_t，这样App进程就找到了对应SF进程中GraphicBuffer的共享内存。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>老规矩一幅图总结：<br><img src="/images/GraphicBuffer%E8%AF%9E%E7%94%9F%E5%88%B0%E5%8F%AF%E4%BD%BF%E7%94%A8.png" alt="GraphicBuffer诞生到可使用.png"></p>
<p>一般来说：图元的绘制分为如下几个步骤：</p>
<ul>
<li>1.dequeueBuffer 获取一个图元的插槽位置，或者生产一个图元。其实在IGrraphicBufferProducer通过flattern进行一次句柄GraphicBuffer拷贝，依次为依据找到底层的共享内存。</li>
<li>2.lock 绑定图元共享内存地址，最后通过句柄在GrallocImportedBufferPool中找到在SF进程申请好的内存地址</li>
<li>3.queueBuffer 把图元放入mActiveBuffer中，并且从新计算dequeue和acquire的数量，同时把GrapicBuffer放到mQueue进行消费，最后调用frameAvilable回调通知消费者。</li>
<li>4.unlock 解锁图元 揭开共享内存的映射。</li>
</ul>
<p>到这里面涉及到了几个fd的转化，先不用太关注，知道是通过ion申请一段共享内存，通过fd的方式告诉App进程可以映射到同一段物理内存。</p>
<p>到这里，我们就能看到了整个gralloc的服务，在申请内存时候，会把主要的工作交给内核驱动ion。这个驱动究竟是怎么回事呢？在Android 4.4的时候还是在ashmem，申请共享内存，那么ion是怎么设计的，下一篇将会为你揭晓。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/01/31/android-chong-xue-xi-lie-ion-qu-dong-yuan-ma-qian-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="Android 重学系列 ion驱动源码浅析">
                        
                        <span class="card-title">Android 重学系列 ion驱动源码浅析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章，在解析初始化GraphicBuffer中，遇到一个ion驱动，对图元进行管理。首先看看ion是怎么使用的：

1.打开驱动：mIonFd = open(ION_DEVICE, O_RDONLY);

2.ioctl 发送IO
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-01-31
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/01/27/android-chong-xue-xi-lie-xuan-ran-tu-ceng-opengl-es-shang-de-feng-zhuang-xia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/23.jpg" class="responsive-img" alt="Android 重学系列 渲染图层-OpenGL es上的封装(下)">
                        
                        <span class="card-title">Android 重学系列 渲染图层-OpenGL es上的封装(下)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言经过上一篇对OpenGL es的环境搭建，了解几个关键的数据结构，本文将会解析软件模拟纹理的绘制流程。
先摆一张，OpenGL es上下文的数据结构:
在阅读本文时候，我们需要时刻记住这个图。
如果问题，可以来本文讨论https://w
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-01-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
