<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 SurfaceFlinger 的初始化, Android | Linux | Flutter">
    <meta name="description" content="前言本片来看看SurfaceFlinger的初始化。从SurfaceFlinger的初始化，来对整个SurfaceFlinger的有一个总览。记住以下代码全部来自Android 9.0
遇到问题可以来本文下讨论:https://www.ji">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 SurfaceFlinger 的初始化 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 SurfaceFlinger 的初始化
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                SurfaceFlinger
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-01-19
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        9.5k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        43 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本片来看看SurfaceFlinger的初始化。从SurfaceFlinger的初始化，来对整个SurfaceFlinger的有一个总览。记住以下代码全部来自Android 9.0</p>
<p>遇到问题可以来本文下讨论:<a href="https://www.jianshu.com/p/9dac91bbb9c9" target="_blank" rel="noopener">https://www.jianshu.com/p/9dac91bbb9c9</a></p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="bp-文件的初步浏览"><a href="#bp-文件的初步浏览" class="headerlink" title="bp 文件的初步浏览"></a>bp 文件的初步浏览</h2><p>要明白SurfaceFlinger的启动需要看看SurfaceFlinger模块目录下的bp文件：<br>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/Android.bp" target="_blank" rel="noopener">Android.bp</a></p>
<p>其实bp最后都会转化为nija文件进行编译，因此和gn文件从某种程度上很相似，我们来看看这个bp文件就大致知道SurfaceFlinger涉及了什么模块，这里只列举出比较重要的模块</p>
<pre class="line-numbers language-bp"><code class="language-bp">....
cc_defaults {
    name: "libsurfaceflinger_defaults",
    defaults: ["surfaceflinger_defaults"],
    cflags: [
        "-DGL_GLEXT_PROTOTYPES",
        "-DEGL_EGLEXT_PROTOTYPES",
    ],
    shared_libs: [
        "android.frameworks.vr.composer@1.0",
        "android.hardware.configstore-utils",
        "android.hardware.configstore@1.0",
        "android.hardware.configstore@1.1",
        "android.hardware.graphics.allocator@2.0",
        "android.hardware.graphics.composer@2.1",
        "android.hardware.graphics.composer@2.2",
        "android.hardware.power@1.0",
        "libbase",
        "libbinder",
        "libbufferhubqueue",
        "libcutils",
        "libdl",
        "libEGL",
        "libfmq",
        "libGLESv1_CM",
        "libGLESv2",
        "libgui",
        "libhardware",
        "libhidlbase",
        "libhidltransport",
        "libhwbinder",
        "liblayers_proto",
        "liblog",
        "libpdx_default_transport",
        "libprotobuf-cpp-lite",
        "libsync",
        "libtimestats_proto",
        "libui",
        "libutils",
        "libvulkan",
    ],
    static_libs: [
        "libserviceutils",
        "libtrace_proto",
        "libvkjson",
        "libvr_manager",
        "libvrflinger",
    ],
    header_libs: [
        "android.hardware.graphics.composer@2.1-command-buffer",
        "android.hardware.graphics.composer@2.2-command-buffer",
    ],
    export_static_lib_headers: [
        "libserviceutils",
    ],
    export_shared_lib_headers: [
        "android.hardware.graphics.allocator@2.0",
        "android.hardware.graphics.composer@2.1",
        "android.hardware.graphics.composer@2.2",
        "libhidlbase",
        "libhidltransport",
        "libhwbinder",
    ],
}

cc_library_headers {
....
}

filegroup {
    name: "libsurfaceflinger_sources",
    srcs: [
      ...//cpp 源代码文件
    ],
}

cc_library_shared {
    name: "libsurfaceflinger",
    defaults: ["libsurfaceflinger_defaults"],
...
}

cc_binary {
    name: "surfaceflinger",
    defaults: ["surfaceflinger_defaults"],
    init_rc: ["surfaceflinger.rc"],
    srcs: ["main_surfaceflinger.cpp"],
    whole_static_libs: [
        "libsigchain",
    ],
    shared_libs: [
        "android.frameworks.displayservice@1.0",
        "android.hardware.configstore-utils",
        "android.hardware.configstore@1.0",
        "android.hardware.graphics.allocator@2.0",
        "libbinder",
        "libcutils",
        "libdisplayservicehidl",
        "libhidlbase",
        "libhidltransport",
        "liblayers_proto",
        "liblog",
        "libsurfaceflinger",
        "libtimestats_proto",
        "libutils",
    ],
    static_libs: [
        "libserviceutils",
        "libtrace_proto",
    ],
    ldflags: ["-Wl,--export-dynamic"],

...
}
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里就先不讲解bp文件的编写。我们把每一个大括号都当作gn中的模块，就很好理解。能看到在SurfaceFlinger中导入了如下几个比较核心的东西：</p>
<ul>
<li><p><a href="mailto:1.android.hardware.graphics.allocator@2.0" target="_blank" rel="noopener">1.android.hardware.graphics.allocator@2.0</a> 图元生成器抽象硬件层的实现</p>
</li>
<li><ol start="2">
<li><a href="mailto:android.hardware.graphics.composer@2.x" target="_blank" rel="noopener">android.hardware.graphics.composer@2.x</a> hwc图层合成抽象硬件层实现</li>
</ol>
</li>
<li><p>3.binder，opengles，hwbinder(抽象硬件层的binder)等。</p>
</li>
<li><p>4.设定了SurfaceFlinger的在Android启动初期需要加载的init.rc文件：surfaceflinger.rc。</p>
</li>
<li><p>5.SurfaceFlinger的主函数入口main_surfaceflinger.cpp</p>
</li>
</ul>
<h3 id="surfaceflinger-rc"><a href="#surfaceflinger-rc" class="headerlink" title="surfaceflinger.rc"></a>surfaceflinger.rc</h3><p>头三点可能不太好理解，什么是硬件抽象层，先把疑问放在这里。我们先来阅读我们熟悉的init.rc文件：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/surfaceflinger.rc" target="_blank" rel="noopener">surfaceflinger.rc</a></p>
<pre><code>service surfaceflinger /system/bin/surfaceflinger
    class core animation
    user system
    group graphics drmrpc readproc
    onrestart restart zygote
    writepid /dev/stune/foreground/tasks
    socket pdx/system/vr/display/client     stream 0666 system graphics u:object_r:pdx_display_client_endpoint_socket:s0
    socket pdx/system/vr/display/manager    stream 0666 system graphics u:object_r:pdx_display_manager_endpoint_socket:s0
    socket pdx/system/vr/display/vsync      stream 0666 system graphics u:object_r:pdx_display_vsync_endpoint_socket:s0</code></pre><p>能看到这里面能看到处理打开了surfaceflinger之外，同时还启动了三个socket，这三个socket还在init进程解析init.rc服务时候自动创建的socket文件描述符，并且会通过vr模块启动。vr并非是这一系列的重点，我以后有时间可能会去解析。</p>
<h3 id="SurfaceFlinger-启动入口main-surfaceflinger"><a href="#SurfaceFlinger-启动入口main-surfaceflinger" class="headerlink" title="SurfaceFlinger 启动入口main_surfaceflinger"></a>SurfaceFlinger 启动入口main_surfaceflinger</h3><p>接下来去看看SF进程的入口文件:<br>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/main_surfaceflinger.cpp" target="_blank" rel="noopener">main_surfaceflinger.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    hardware<span class="token operator">::</span><span class="token function">configureRpcThreadpool</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token comment" spellcheck="true">/* maxThreads */</span><span class="token punctuation">,</span>
            <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* callerWillJoin */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">startGraphicsAllocatorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// When SF is launched in its own process, limit the number of</span>
    <span class="token comment" spellcheck="true">// binder threads to 4.</span>
    ProcessState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setThreadPoolMaxThreadCount</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// start the thread pool</span>
    sp<span class="token operator">&lt;</span>ProcessState<span class="token operator">></span> <span class="token function">ps</span><span class="token punctuation">(</span>ProcessState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ps<span class="token operator">-</span><span class="token operator">></span><span class="token function">startThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// instantiate surfaceflinger</span>
    sp<span class="token operator">&lt;</span>SurfaceFlinger<span class="token operator">></span> flinger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">SurfaceFlinger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setpriority</span><span class="token punctuation">(</span>PRIO_PROCESS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PRIORITY_URGENT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">set_sched_policy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SP_FOREGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Put most SurfaceFlinger threads in the system-background cpuset</span>
    <span class="token comment" spellcheck="true">// Keeps us from unnecessarily using big cores</span>
    <span class="token comment" spellcheck="true">// Do this after the binder thread pool init</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cpusets_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">set_cpuset_policy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SP_SYSTEM<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// initialize before clients can connect</span>
    flinger<span class="token operator">-</span><span class="token operator">></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// publish surface flinger</span>
    sp<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> <span class="token function">sm</span><span class="token punctuation">(</span><span class="token function">defaultServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sm<span class="token operator">-</span><span class="token operator">></span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token function">String16</span><span class="token punctuation">(</span>SurfaceFlinger<span class="token operator">::</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flinger<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                   IServiceManager<span class="token operator">::</span>DUMP_FLAG_PRIORITY_CRITICAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// publish GpuService</span>
    sp<span class="token operator">&lt;</span>GpuService<span class="token operator">></span> gpuservice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">GpuService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sm<span class="token operator">-</span><span class="token operator">></span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token function">String16</span><span class="token punctuation">(</span>GpuService<span class="token operator">::</span>SERVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">,</span> gpuservice<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">startDisplayService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// dependency on SF getting registered above</span>

    <span class="token keyword">struct</span> sched_param param <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    param<span class="token punctuation">.</span>sched_priority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sched_setscheduler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SCHED_FIFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Couldn't set SCHED_FIFO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// run surface flinger in this thread</span>
    flinger<span class="token operator">-</span><span class="token operator">></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能够在这里看到有如下几个核心方法：</p>
<ul>
<li>1.startGraphicsAllocatorService 初始化Hal层的图元生成器服务</li>
<li>2.初始化ProcessState，也就是把该进程映射到Binder驱动程序</li>
<li>3.SurfaceFlinger实例化</li>
<li>4.set_sched_policy设置为前台进程</li>
<li>5.SurfaceFlinger调用init方法</li>
<li>6.因为SurfaceFlinger本质上也是一个Binder服务，因此添加到ServiceManager进程中。</li>
<li>7.初始化GpuService，也添加到ServiceManager进程中</li>
<li>8.启动DisplayService</li>
<li>9.sched_setscheduler 把进程调度模式设置为实时进程的FIFO</li>
<li>10.调用SurfaceFlinger的run方法。</li>
</ul>
<p>值得注意的有三点：</p>
<ul>
<li>1.初始化GraphicsAllocator服务和Display服务</li>
<li>2.set_sched_policy和sched_setscheduler设置进程</li>
<li>3.SurfaceFlinger的init和run方法</li>
</ul>
<p>首先第一点Hal硬件抽象层先不介绍，放到下一章统一介绍。我们来注重关注看看第二点SurfaceFlinger的进程策略和第三点SF的初始化。</p>
<h3 id="SurfaceFlinger-进程调度策略"><a href="#SurfaceFlinger-进程调度策略" class="headerlink" title="SurfaceFlinger 进程调度策略"></a>SurfaceFlinger 进程调度策略</h3><p>SurfaceFlinger作为Android整个进程最为核心进程之一，但是它并非像App一样前台显示，而是在背后运行，那么有什么办法保证它不被干掉呢？同时保证他的优先级，让CPU不断的优先把资源让渡给SF呢？让SF不断的抢到机会让渲染任务在16ms完成呢？</p>
<p>这里就需要介绍一下Linux内核的进程管理。</p>
<h4 id="Linux的进程调度简介"><a href="#Linux的进程调度简介" class="headerlink" title="Linux的进程调度简介"></a>Linux的进程调度简介</h4><p>在Linux中把进程分为两大类：</p>
<ul>
<li>1.实时进程 是指需要尽快执行那种</li>
<li>2.普通进程 是指大部分不同进程</li>
</ul>
<p>而在这两种进程中又有分为两大类进程调度策略：</p>
<ul>
<li><p>1.实时调度策略：SCHED_FIFO、SCHED_RR、SCHED_DEADLINE。<br>SCHED_FIFO先入先出策略，按照优先级排列进程；SCHED_RR 轮流调度策略，按照完成顺序不断把任务添加到队尾，让渡任务给队首；SCHED_DEADLINE 按照任务的deadline策略。</p>
</li>
<li><p>2.普通调度策略：SCHED_NORMAL，SCHED_BATCH，SCHED_IDLE<br>SCHED_NORMAL 普通进程调度策略，SCHED_BATCH后台进程策略，SCHED_IDLE 只有特别空闲才会跑策略。</p>
</li>
</ul>
<p>而这里面所有的策略都是由task_struct结构体下面这个属性负责的：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">struct</span> sched_class <span class="token operator">*</span>sched_class<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>而这个class分为如下几种：</p>
<ul>
<li>1.stop_sched_class 优先级最高的策略，会中断其他进程</li>
<li>2.dl_sched_class deadline 策略</li>
<li>3.rt_sched_class 根据rt算法或者FIFO策略</li>
<li>4.fair_sched_class 依据公平算法cfs的普通进程调度策略</li>
<li>5.idle_sched_class 空闲进程的调度策略</li>
</ul>
<p>简单聊一下公平算法cfs：<br>公平算法根据每一个普通进程的vruntime，找到最小vruntime从红黑树移除出来运行，最后又放回红黑树中，算法如下：</p>
<blockquote>
<p>虚拟运行时间 vruntime += 实际运行时间 delta_exec * NICE_0_LOAD/ 权重<br>这样根据实际运行时间，实际运行时间短的分配权重高，长的权重少，这样就变相公平。</p>
</blockquote>
<p>每个进程当设置了不同的调度策略将会挂载到不同的进度策略类别队列中。当调用了__scheme方法之后，就会调用pick_next_task，这个时候按照如下图所示的，按照顺序遍历整个调度策略的链表，如下图：<br><img src="/images/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6.jpeg" alt="进程调度.jpeg"></p>
<p>当有了这些基础知识之后，我们就能很简单的理解整个SF了。SF被设置为SP_FOREGROUND，设置为前台进程，加入到前台进程组中。接着SCHED_FIFO优先级策略。这样就能保证SF在较高优先级下，运行进程，同时保证只要每一次遍历进程调度类的时候，必定会先让渡给SF，接着让渡给我们App应用。</p>
<h2 id="SurfaceFlinger的初始化"><a href="#SurfaceFlinger的初始化" class="headerlink" title="SurfaceFlinger的初始化"></a>SurfaceFlinger的初始化</h2><p>在看进程初始化之前，我们先来看看SurfaceFlinger的UML图。<br><img src="/images/SurfaceFlinger_UML.png" alt="SurfaceFlinger UML.png"></p>
<p>能看到整个SF体系基础关系还是比较复杂。我们把目光放在最为关键的两个类：</p>
<ul>
<li>1.ISurfaceComposer 所用面向SF之外进程的Binder操作回调，而这里面我挑选比较重要几个回调放在UML图中，记住他们之后分析会遇到。</li>
<li>2.HWC2::ComposerCallback 这是面向底层硬件的回调，这个Callback中包含了三个很关键的回调：</li>
<li>1.Hotplug 显示屏的热插拔通知上层SF进程</li>
<li>2.Refresh 底层硬件通知上层SF进程 HWC的刷新</li>
<li>3.Vsync 底层通知上层SF 进程 同步信号来了</li>
</ul>
<p>有了这两个大的回调机制，SF就能通过这两者分别和硬件层以及App进程进行通信，这样SF的初步桥梁才形成了。</p>
<p>有了初步的印象之后，我们进一步的去看看，SF的构造函数：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp" target="_blank" rel="noopener">SurfaceFlinger.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">SurfaceFlinger<span class="token operator">::</span><span class="token function">SurfaceFlinger</span><span class="token punctuation">(</span>SurfaceFlinger<span class="token operator">::</span>SkipInitializationTag<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">BnSurfaceComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mTransactionFlags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mTransactionPending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mAnimTransactionPending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mLayersRemoved</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mLayersAdded</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mRepaintEverything</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mBootTime</span><span class="token punctuation">(</span><span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mBuiltinDisplays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mVisibleRegionsDirty</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mGeometryInvalid</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mAnimCompositionPending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mDebugRegion</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mDebugDDMS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mDebugDisableHWC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mDebugDisableTransformHint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mDebugInSwapBuffers</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mLastSwapBufferTime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mDebugInTransaction</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mLastTransactionTime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mBootFinished</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mForceFullDamage</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mPrimaryDispSync</span><span class="token punctuation">(</span><span class="token string">"PrimaryDispSync"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mPrimaryHWVsyncEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mHWVsyncAvailable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mHasPoweredOff</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mNumLayers</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mVrFlingerRequestsDisplay</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mMainThreadId</span><span class="token punctuation">(</span>std<span class="token operator">::</span>this_thread<span class="token operator">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mCreateBufferQueue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>BufferQueue<span class="token operator">::</span>createBufferQueue<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mCreateNativeWindowSurface</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>impl<span class="token operator">::</span>NativeWindowSurface<span class="token operator">::</span>create<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里面我们关注集合比较核心初始对象：</p>
<ul>
<li>1.BnSurfaceComposer SurfaceFlinger的父类</li>
<li>2.mPrimaryDispSync 主要的信号同步处理器</li>
<li>3.BufferQueue 图元消费队列</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp">SurfaceFlinger<span class="token operator">::</span><span class="token function">SurfaceFlinger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">SurfaceFlinger</span><span class="token punctuation">(</span>SkipInitialization<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    vsyncPhaseOffsetNs <span class="token operator">=</span> getInt64<span class="token operator">&lt;</span> ISurfaceFlingerConfigs<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>vsyncEventPhaseOffsetNs<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    sfVsyncPhaseOffsetNs <span class="token operator">=</span> getInt64<span class="token operator">&lt;</span> ISurfaceFlingerConfigs<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>vsyncSfEventPhaseOffsetNs<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    hasSyncFramework <span class="token operator">=</span> getBool<span class="token operator">&lt;</span> ISurfaceFlingerConfigs<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>hasSyncFramework<span class="token operator">></span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    dispSyncPresentTimeOffset <span class="token operator">=</span> getInt64<span class="token operator">&lt;</span> ISurfaceFlingerConfigs<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>presentTimeOffsetFromVSyncNs<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    useHwcForRgbToYuv <span class="token operator">=</span> getBool<span class="token operator">&lt;</span> ISurfaceFlingerConfigs<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>useHwcForRGBtoYUV<span class="token operator">></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    maxVirtualDisplaySize <span class="token operator">=</span> getUInt64<span class="token operator">&lt;</span>ISurfaceFlingerConfigs<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>maxVirtualDisplaySize<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Vr flinger is only enabled on Daydream ready devices.</span>
    useVrFlinger <span class="token operator">=</span> getBool<span class="token operator">&lt;</span> ISurfaceFlingerConfigs<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>useVrFlinger<span class="token operator">></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    maxFrameBufferAcquiredBuffers <span class="token operator">=</span> getInt64<span class="token operator">&lt;</span> ISurfaceFlingerConfigs<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>maxFrameBufferAcquiredBuffers<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    hasWideColorDisplay <span class="token operator">=</span>
            getBool<span class="token operator">&lt;</span>ISurfaceFlingerConfigs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>hasWideColorDisplay<span class="token operator">></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    V1_1<span class="token operator">::</span>DisplayOrientation primaryDisplayOrientation <span class="token operator">=</span>
        getDisplayOrientation<span class="token operator">&lt;</span> V1_1<span class="token operator">::</span>ISurfaceFlingerConfigs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>V1_1<span class="token operator">::</span>ISurfaceFlingerConfigs<span class="token operator">::</span>primaryDisplayOrientation<span class="token operator">></span><span class="token punctuation">(</span>
            V1_1<span class="token operator">::</span>DisplayOrientation<span class="token operator">::</span>ORIENTATION_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryDisplayOrientation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> V1_1<span class="token operator">::</span>DisplayOrientation<span class="token operator">::</span>ORIENTATION_90<span class="token operator">:</span>
            mPrimaryDisplayOrientation <span class="token operator">=</span> DisplayState<span class="token operator">::</span>eOrientation90<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> V1_1<span class="token operator">::</span>DisplayOrientation<span class="token operator">::</span>ORIENTATION_180<span class="token operator">:</span>
            mPrimaryDisplayOrientation <span class="token operator">=</span> DisplayState<span class="token operator">::</span>eOrientation180<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> V1_1<span class="token operator">::</span>DisplayOrientation<span class="token operator">::</span>ORIENTATION_270<span class="token operator">:</span>
            mPrimaryDisplayOrientation <span class="token operator">=</span> DisplayState<span class="token operator">::</span>eOrientation270<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            mPrimaryDisplayOrientation <span class="token operator">=</span> DisplayState<span class="token operator">::</span>eOrientationDefault<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mPrimaryDispSync<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>SurfaceFlinger<span class="token operator">::</span>hasSyncFramework<span class="token punctuation">,</span> SurfaceFlinger<span class="token operator">::</span>dispSyncPresentTimeOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// debugging stuff...</span>
    <span class="token keyword">char</span> value<span class="token punctuation">[</span>PROPERTY_VALUE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"debug.sf.enable_hwc_vds"</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mUseHwcVirtualDisplays <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"ro.sf.disable_triple_buffer"</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mLayerTripleBufferingDisabled <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">const</span> size_t defaultListSize <span class="token operator">=</span> MAX_LAYERS<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> listSize <span class="token operator">=</span> <span class="token function">property_get_int32</span><span class="token punctuation">(</span><span class="token string">"debug.sf.max_igbp_list_size"</span><span class="token punctuation">,</span> <span class="token function">int32_t</span><span class="token punctuation">(</span>defaultListSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mMaxGraphicBufferProducerListSize <span class="token operator">=</span> <span class="token punctuation">(</span>listSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">size_t</span><span class="token punctuation">(</span>listSize<span class="token punctuation">)</span> <span class="token operator">:</span> defaultListSize<span class="token punctuation">;</span>

    <span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"debug.sf.early_phase_offset_ns"</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> earlyWakeupOffsetOffsetNs <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mVsyncModulator<span class="token punctuation">.</span><span class="token function">setPhaseOffsets</span><span class="token punctuation">(</span>sfVsyncPhaseOffsetNs <span class="token operator">-</span> earlyWakeupOffsetOffsetNs<span class="token punctuation">,</span>
            sfVsyncPhaseOffsetNs<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>SF构造函数初始化做了如下几件事情：</p>
<ul>
<li>1.初始化了vsyncPhaseOffsetNs，sfVsyncPhaseOffsetNs两个相位差，分别是指app的以及sf的相位差。关于相位差的基本概念在第一节有和大家聊过，等到专门专题和大家聊聊</li>
<li>2.设置SF的渲染方向，是哪一个角度。</li>
<li>3.mPrimaryDispSync 主显示屏信号同步器初始化</li>
<li>4.根据Android的全局配置，判断是否需要打开三重缓冲，HWC合成机制</li>
</ul>
<h3 id="PrimaryDispSync-init"><a href="#PrimaryDispSync-init" class="headerlink" title="PrimaryDispSync init"></a>PrimaryDispSync init</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DispSync.cpp" target="_blank" rel="noopener">DispSync.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> DispSync<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">bool</span> hasSyncFramework<span class="token punctuation">,</span> int64_t dispSyncPresentTimeOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mIgnorePresentFences <span class="token operator">=</span> <span class="token operator">!</span>hasSyncFramework<span class="token punctuation">;</span>
    mPresentTimeOffset <span class="token operator">=</span> dispSyncPresentTimeOffset<span class="token punctuation">;</span>
    mThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">"DispSync"</span><span class="token punctuation">,</span> PRIORITY_URGENT_DISPLAY <span class="token operator">+</span> PRIORITY_MORE_FAVORABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// set DispSync to SCHED_FIFO to minimize jitter</span>
    <span class="token keyword">struct</span> sched_param param <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    param<span class="token punctuation">.</span>sched_priority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sched_setscheduler</span><span class="token punctuation">(</span>mThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">getTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SCHED_FIFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Couldn't set SCHED_FIFO for DispSyncThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">beginResync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>kTraceDetailedInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mIgnorePresentFences <span class="token operator">&amp;&amp;</span> kEnableZeroPhaseTracer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mZeroPhaseTracer <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>ZeroPhaseTracer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"ZeroPhaseTracer"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mZeroPhaseTracer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中初始化了DispSyncThread这个线程并且运行起来，并且初始化一些简单的数据。同时设置这个线程调度的优先类为FIFO。注意在Linux内核中，根本不会关心Thread和Process这两者区别，对于内核来说都是task_struct(任务)，区别仅仅只是初始化Thread的时候，会调用clone系统调用，并且把父亲任务指向进程，并且指向进程中所有的堆栈达到共享数据的目的。</p>
<p>这样就保证了相位计算的有限度十分高。我们对这个类有个总体的印象即可。</p>
<h3 id="SurfaceFlinger-onFirstRef"><a href="#SurfaceFlinger-onFirstRef" class="headerlink" title="SurfaceFlinger onFirstRef"></a>SurfaceFlinger onFirstRef</h3><p>从main函数还能看到，SF实际上是一个智能指针。sp强引用指针。这种指针在初始化的时候对应类型的构造函数的时候，会调用onFirstRef方法，进一步实例化内部需要的对象。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mEventQueue<span class="token operator">-</span><span class="token operator">></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法调用了mEventQueue的init方法。而这个对象就是如下一个线程安全的MessageQueue对象。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">mutable</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> mEventQueue<span class="token punctuation">{</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>MessageQueue<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>而在SF中的这个MessageQueue其实和Android 应用层开发的MessageQueue设计十分相似，只是有的角色做的事情稍微有点不同。</p>
<p>SurfaceFlinger的MessageQueue机制的角色:</p>
<ul>
<li><p>1.MessageQueue 同样作为消息队列向外暴露操作接口，并不像应用层的MessageQueue一样作为Message链表的队列缓存，而是提供了相应的发送消息的接口以及等待消息方法。</p>
</li>
<li><p>2.native的Looper 是整个MessageQueue真正的核心，以epoll_event为核心，event_fd为辅助构建了一套快速的消息回调机制。</p>
</li>
<li><p>3.native的Handler 则是实现handleMessage方法，当Looper回调时候，将会调用Handler中handleMessage方法处理回调函数。</p>
</li>
</ul>
<p>为了加深印象，我这里放出Android应用层MessageQueue和Looper的对应关系来和SF中MessageQueue设计的比较</p>
<p><img src="/images/Looper%E8%AE%BE%E8%AE%A1%E5%9B%BE.png" alt="Looper设计图.png"></p>
<h4 id="MessageQueue-init"><a href="#MessageQueue-init" class="headerlink" title="MessageQueue init"></a>MessageQueue init</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/MessageQueue.cpp" target="_blank" rel="noopener">MessageQueue.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MessageQueue<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>SurfaceFlinger<span class="token operator">></span><span class="token operator">&amp;</span> flinger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mFlinger <span class="token operator">=</span> flinger<span class="token punctuation">;</span>
    mLooper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Looper</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在MessageQueue中实例化了Looper和Handler。Looper其实和之前我将的Looper的原理一致，关键看看其回调函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MessageQueue<span class="token operator">::</span>Handler<span class="token operator">::</span><span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> Message<span class="token operator">&amp;</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> INVALIDATE<span class="token operator">:</span>
            <span class="token function">android_atomic_and</span><span class="token punctuation">(</span><span class="token operator">~</span>eventMaskInvalidate<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mEventMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mQueue<span class="token punctuation">.</span>mFlinger<span class="token operator">-</span><span class="token operator">></span><span class="token function">onMessageReceived</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> REFRESH<span class="token operator">:</span>
            <span class="token function">android_atomic_and</span><span class="token punctuation">(</span><span class="token operator">~</span>eventMaskRefresh<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mEventMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mQueue<span class="token punctuation">.</span>mFlinger<span class="token operator">-</span><span class="token operator">></span><span class="token function">onMessageReceived</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到注册了两种不同的图元刷新监听，一个是invalidate局部刷新，一个是refresh重新刷新。最后都会回调到SF的onMessageReceived中。换句话说，每当我们需要图元刷新的时候，就会通过mEventQueue的post方法，把数据异步加载到Handler中进行刷新。</p>
<p>了解到这一点之后，就暂时足够了，我们继续往下阅读在main方法中的SF的init方法。</p>
<h3 id="SurfaceFlinger-init"><a href="#SurfaceFlinger-init" class="headerlink" title="SurfaceFlinger init"></a>SurfaceFlinger init</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mStateLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// start the EventThread</span>
    mEventThreadSource <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>DispSyncSource<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mPrimaryDispSync<span class="token punctuation">,</span> SurfaceFlinger<span class="token operator">::</span>vsyncPhaseOffsetNs<span class="token punctuation">,</span>
                                             <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mEventThread <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventThread<span class="token operator">></span><span class="token punctuation">(</span>mEventThreadSource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                       <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                       impl<span class="token operator">::</span>EventThread<span class="token operator">::</span><span class="token function">InterceptVSyncsCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                       <span class="token string">"appEventThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSfEventThreadSource <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>DispSyncSource<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mPrimaryDispSync<span class="token punctuation">,</span>
                                             SurfaceFlinger<span class="token operator">::</span>sfVsyncPhaseOffsetNs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"sf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mSFEventThread <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventThread<span class="token operator">></span><span class="token punctuation">(</span>mSfEventThreadSource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>nsecs_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                                    mInterceptor<span class="token operator">-</span><span class="token operator">></span><span class="token function">saveVSyncEvent</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                <span class="token string">"sfEventThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mEventQueue<span class="token operator">-</span><span class="token operator">></span><span class="token function">setEventThread</span><span class="token punctuation">(</span>mSFEventThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mVsyncModulator<span class="token punctuation">.</span><span class="token function">setEventThread</span><span class="token punctuation">(</span>mSFEventThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Get a RenderEngine for the given display / config (can't fail)</span>
    <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mRenderEngine <span class="token operator">=</span>
            RE<span class="token operator">::</span>impl<span class="token operator">::</span>RenderEngine<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>HAL_PIXEL_FORMAT_RGBA_8888<span class="token punctuation">,</span>
                                           hasWideColorDisplay
                                                   <span class="token operator">?</span> RE<span class="token operator">::</span>RenderEngine<span class="token operator">::</span>WIDE_COLOR_SUPPORT
                                                   <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token function">HWComposer</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Hwc2<span class="token operator">::</span>impl<span class="token operator">::</span>Composer<span class="token operator">></span><span class="token punctuation">(</span><span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwcServiceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mComposerSequenceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 该方法第一次进来无效，这是SF重启发现有屏幕插进来，一般不会走进来</span>
    <span class="token function">processDisplayHotplugEventsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment" spellcheck="true">//第一次进来还没有链接进来的Display的Binder对象，跳过</span>
    <span class="token function">getDefaultDisplayDeviceLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">makeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//打开vr功能相关模块</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    mEventControlThread <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventControlThread<span class="token operator">></span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">bool</span> enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">setVsyncEnabled</span><span class="token punctuation">(</span>HWC_DISPLAY_PRIMARY<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// initialize our drawing state</span>
    mDrawingState <span class="token operator">=</span> mCurrentState<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// set initial conditions (e.g. unblank default device)</span>
    <span class="token function">initializeDisplays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mRenderEngine<span class="token operator">-</span><span class="token operator">></span><span class="token function">primeCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Inform native graphics APIs whether the present timestamp is supported:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getHwComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasCapability</span><span class="token punctuation">(</span>
            HWC2<span class="token operator">::</span>Capability<span class="token operator">::</span>PresentFenceIsNotReliable<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mStartPropertySetThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">StartPropertySetThread</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mStartPropertySetThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">StartPropertySetThread</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartPropertySetThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    mLegacySrgbSaturationMatrix <span class="token operator">=</span> <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token operator">-</span><span class="token operator">></span><span class="token function">getDataspaceSaturationMatrix</span><span class="token punctuation">(</span>HWC_DISPLAY_PRIMARY<span class="token punctuation">,</span>
            Dataspace<span class="token operator">::</span>SRGB_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在init过程中初始化不少重要的对象：</p>
<ul>
<li>1.DispSyncSource 的初始化</li>
<li>2.EventThread 的初始化</li>
<li>3.EventQueue 监听初始化</li>
<li>4.渲染引擎的初始化</li>
<li>5.初始化HWComposer</li>
<li>6.EventControlThread初始化</li>
<li>7.初始化和链接DisplayService</li>
</ul>
<p>我们展示不需要过多的深入的理解每一个类是怎么做怎么实现的，我之后会慢慢和大家聊聊。</p>
<h4 id="DispSyncSource-和EventThread的初始化"><a href="#DispSyncSource-和EventThread的初始化" class="headerlink" title="DispSyncSource 和EventThread的初始化"></a>DispSyncSource 和EventThread的初始化</h4><p>一般都会把这两者放在一起聊。我们把初始化堪称两部分，一部分是app的EventThread，一部分是SF的EventThread。</p>
<h5 id="app的EventThread"><a href="#app的EventThread" class="headerlink" title="app的EventThread"></a>app的EventThread</h5><p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/EventThread.cpp" target="_blank" rel="noopener">EventThread.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    mEventThreadSource <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>DispSyncSource<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mPrimaryDispSync<span class="token punctuation">,</span> SurfaceFlinger<span class="token operator">::</span>vsyncPhaseOffsetNs<span class="token punctuation">,</span>
                                             <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mEventThread <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventThread<span class="token operator">></span><span class="token punctuation">(</span>mEventThreadSource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                       <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                       impl<span class="token operator">::</span>EventThread<span class="token operator">::</span><span class="token function">InterceptVSyncsCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                       <span class="token string">"appEventThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上mEventThread本质上就是一个DisSyncSource对象，我们看看他的构造函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">DispSyncSource</span> final <span class="token operator">:</span> <span class="token keyword">public</span> VSyncSource<span class="token punctuation">,</span> <span class="token keyword">private</span> DispSync<span class="token operator">::</span>Callback <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">DispSyncSource</span><span class="token punctuation">(</span>DispSync<span class="token operator">*</span> dispSync<span class="token punctuation">,</span> nsecs_t phaseOffset<span class="token punctuation">,</span> <span class="token keyword">bool</span> traceVsync<span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token operator">:</span>
            <span class="token function">mName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">mValue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">mTraceVsync</span><span class="token punctuation">(</span>traceVsync<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">mVsyncOnLabel</span><span class="token punctuation">(</span>String8<span class="token operator">::</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"VsyncOn-%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">mVsyncEventLabel</span><span class="token punctuation">(</span>String8<span class="token operator">::</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"VSYNC-%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">mDispSync</span><span class="token punctuation">(</span>dispSync<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">mCallbackMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">mVsyncMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">mPhaseOffset</span><span class="token punctuation">(</span>phaseOffset<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">mEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">DispSyncSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个中设置两个关键参数，一个是上面初始化好的DispSync显示同步信号，一个是app的DispSyncSource相位差，这个相位差就是1000000。</p>
<p>接着初始化EventThread，把app的DispSyncSource作为参数,进行实例化</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">EventThread<span class="token operator">::</span><span class="token function">EventThread</span><span class="token punctuation">(</span>VSyncSource<span class="token operator">*</span> src<span class="token punctuation">,</span> ResyncWithRateLimitCallback resyncWithRateLimitCallback<span class="token punctuation">,</span>
                         InterceptVSyncsCallback interceptVSyncsCallback<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> threadName<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">mVSyncSource</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mResyncWithRateLimitCallback</span><span class="token punctuation">(</span>resyncWithRateLimitCallback<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mInterceptVSyncsCallback</span><span class="token punctuation">(</span>interceptVSyncsCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> event <span class="token operator">:</span> mVSyncEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">=</span> DisplayEventReceiver<span class="token operator">::</span>DISPLAY_EVENT_VSYNC<span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>header<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>header<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>vsync<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mThread <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>EventThread<span class="token operator">::</span>threadMain<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_setname_np</span><span class="token punctuation">(</span>mThread<span class="token punctuation">.</span><span class="token function">native_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> threadName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    pid_t tid <span class="token operator">=</span> <span class="token function">pthread_gettid_np</span><span class="token punctuation">(</span>mThread<span class="token punctuation">.</span><span class="token function">native_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Use SCHED_FIFO to minimize jitter</span>
    <span class="token keyword">constexpr</span> <span class="token keyword">int</span> EVENT_THREAD_PRIORITY <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sched_param param <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    param<span class="token punctuation">.</span>sched_priority <span class="token operator">=</span> EVENT_THREAD_PRIORITY<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_setschedparam</span><span class="token punctuation">(</span>mThread<span class="token punctuation">.</span><span class="token function">native_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SCHED_FIFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Couldn't set SCHED_FIFO for EventThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">set_sched_policy</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> SP_FOREGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能够看到在这个过程中做的事情和DispSync的方法很相似。首先实例化一个内部线程，并且设置这个线程的启动后的方法，以及设置该线程为FIFO策略并且设置为前台线程，使用更高的优先级Task。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> EventThread<span class="token operator">::</span><span class="token function">threadMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> NO_THREAD_SAFETY_ANALYSIS <span class="token punctuation">{</span>
    std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>mKeepRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        DisplayEventReceiver<span class="token operator">::</span>Event event<span class="token punctuation">;</span>
        Vector<span class="token operator">&lt;</span>sp<span class="token operator">&lt;</span>EventThread<span class="token operator">::</span>Connection<span class="token operator">></span> <span class="token operator">></span> signalConnections<span class="token punctuation">;</span>
        signalConnections <span class="token operator">=</span> <span class="token function">waitForEventLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// dispatch events to listeners...</span>
        <span class="token keyword">const</span> size_t count <span class="token operator">=</span> signalConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Connection<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">conn</span><span class="token punctuation">(</span>signalConnections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// now see if we still need to report this event</span>
            status_t err <span class="token operator">=</span> conn<span class="token operator">-</span><span class="token operator">></span><span class="token function">postEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span>EAGAIN <span class="token operator">||</span> err <span class="token operator">==</span> <span class="token operator">-</span>EWOULDBLOCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// The destination doesn't accept events anymore, it's probably</span>
                <span class="token comment" spellcheck="true">// full. For now, we just drop the events on the floor.</span>
                <span class="token comment" spellcheck="true">// FIXME: Note that some events cannot be dropped and would have</span>
                <span class="token comment" spellcheck="true">// to be re-sent later.</span>
                <span class="token comment" spellcheck="true">// Right-now we don't have the ability to do this.</span>
                <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"EventThread: dropping event (%08x) for connection %p"</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>header<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                      conn<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// handle any other error on the pipe as fatal. the only</span>
                <span class="token comment" spellcheck="true">// reasonable thing to do is to clean-up this connection.</span>
                <span class="token comment" spellcheck="true">// The most common error we'll get here is -EPIPE.</span>
                <span class="token function">removeDisplayEventConnectionLocked</span><span class="token punctuation">(</span>signalConnections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个过程中，会通过waitForEventLocked阻塞等待外部链接进来的EventThread的Connection，链接进来。一般是应用程序注册了Choreographer之后，就会注册DisplayEventReceiver，此时会对应DisplayEventReceiverDispatch一个Looper的callback，同时会通过Binder把当前为当前对象注册一个COnnect给SF进程的EventThread。当唤醒之后，经过检测将会调用postEvent把同步信号同步给App应用。</p>
<p>在waitForEventLocked等待循环的过程中，每一次同步信号的发出都会调用构造函数进来的回调interceptVSyncsCallback，也就是：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>同时会根据条件判断，当前是否打开同步信号。</p>
<p>有初步的概念即可，之后有专门的文章专门聊聊。</p>
<h4 id="sf的EventThread初始化"><a href="#sf的EventThread初始化" class="headerlink" title="sf的EventThread初始化"></a>sf的EventThread初始化</h4><pre class="line-numbers language-cpp"><code class="language-cpp">    mSfEventThreadSource <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>DispSyncSource<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mPrimaryDispSync<span class="token punctuation">,</span>
                                             SurfaceFlinger<span class="token operator">::</span>sfVsyncPhaseOffsetNs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"sf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mSFEventThread <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventThread<span class="token operator">></span><span class="token punctuation">(</span>mSfEventThreadSource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>nsecs_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                                    mInterceptor<span class="token operator">-</span><span class="token operator">></span><span class="token function">saveVSyncEvent</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                <span class="token string">"sfEventThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mEventQueue<span class="token operator">-</span><span class="token operator">></span><span class="token function">setEventThread</span><span class="token punctuation">(</span>mSFEventThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mVsyncModulator<span class="token punctuation">.</span><span class="token function">setEventThread</span><span class="token punctuation">(</span>mSFEventThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同理有着极其相似的逻辑，不过sf的EventThread监听的是本进程的，其先去看看mEventQueue这个SF中的MessageQueue的setEventThread方法</p>
<h5 id="MessageQueue-setEventThread"><a href="#MessageQueue-setEventThread" class="headerlink" title="MessageQueue setEventThread"></a>MessageQueue setEventThread</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/MessageQueue.cpp" target="_blank" rel="noopener">MessageQueue.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MessageQueue<span class="token operator">::</span><span class="token function">setEventThread</span><span class="token punctuation">(</span>android<span class="token operator">::</span>EventThread<span class="token operator">*</span> eventThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mEventThread <span class="token operator">==</span> eventThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mEventTube<span class="token punctuation">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">removeFd</span><span class="token punctuation">(</span>mEventTube<span class="token punctuation">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mEventThread <span class="token operator">=</span> eventThread<span class="token punctuation">;</span>
    mEvents <span class="token operator">=</span> eventThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">createEventConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mEvents<span class="token operator">-</span><span class="token operator">></span><span class="token function">stealReceiveChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mEventTube<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">addFd</span><span class="token punctuation">(</span>mEventTube<span class="token punctuation">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Looper<span class="token operator">::</span>EVENT_INPUT<span class="token punctuation">,</span> MessageQueue<span class="token operator">::</span>cb_eventReceiver<span class="token punctuation">,</span>
                   <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中能看到和App应用极其相似的逻辑。首先通过eventThread的createEventConnection创建一个Connection，是的EventThread可以从waitForEventLocked能够监听到这个链接。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">sp<span class="token operator">&lt;</span>BnDisplayEventConnection<span class="token operator">></span> EventThread<span class="token operator">::</span><span class="token function">createEventConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">Connection</span><span class="token punctuation">(</span><span class="token keyword">const_cast</span><span class="token operator">&lt;</span>EventThread<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">EventThread<span class="token operator">::</span>Connection<span class="token operator">::</span><span class="token function">Connection</span><span class="token punctuation">(</span>EventThread<span class="token operator">*</span> eventThread<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mEventThread</span><span class="token punctuation">(</span>eventThread<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mChannel</span><span class="token punctuation">(</span>gui<span class="token operator">::</span>BitTube<span class="token operator">::</span>DefaultSize<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

EventThread<span class="token operator">::</span>Connection<span class="token operator">::</span><span class="token operator">~</span><span class="token function">Connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// do nothing here -- clean-up will happen automatically</span>
    <span class="token comment" spellcheck="true">// when the main thread wakes up</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventThread<span class="token operator">::</span>Connection<span class="token operator">::</span><span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// NOTE: mEventThread doesn't hold a strong reference on us</span>
    mEventThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerDisplayEventConnection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>初始化了一个BitTube对象，以及把当前的Connection注册到EventThread中，让waitForEvent可以监听到新的监听进来了。BitTube是什么呢？</p>
<h5 id="BitTube"><a href="#BitTube" class="headerlink" title="BitTube"></a>BitTube</h5><p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/BitTube.cpp" target="_blank" rel="noopener">BitTube.cpp</a></p>
<p>它本质上就是一个封装过的socketpair。socketpair是什么？解释一下就类似于管道，一对可以互相通信的socket.可以从1号写入，0号读取。也可以从0号写入，1号读取。是一个全双工的通道。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">const</span> size_t DEFAULT_SOCKET_BUFFER_SIZE <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>


BitTube<span class="token operator">::</span><span class="token function">BitTube</span><span class="token punctuation">(</span>size_t bufsize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">init</span><span class="token punctuation">(</span>bufsize<span class="token punctuation">,</span> bufsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

BitTube<span class="token operator">::</span><span class="token function">BitTube</span><span class="token punctuation">(</span>DefaultSizeType<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">BitTube</span><span class="token punctuation">(</span>DEFAULT_SOCKET_BUFFER_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">void</span> BitTube<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>size_t rcvbuf<span class="token punctuation">,</span> size_t sndbuf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockets<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">socketpair</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_SEQPACKET<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sockets<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        size_t size <span class="token operator">=</span> DEFAULT_SOCKET_BUFFER_SIZE<span class="token punctuation">;</span>
        <span class="token function">setsockopt</span><span class="token punctuation">(</span>sockets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rcvbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rcvbuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setsockopt</span><span class="token punctuation">(</span>sockets<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_SNDBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sndbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sndbuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// sine we don't use the "return channel", we keep it small...</span>
        <span class="token function">setsockopt</span><span class="token punctuation">(</span>sockets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_SNDBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setsockopt</span><span class="token punctuation">(</span>sockets<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fcntl</span><span class="token punctuation">(</span>sockets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fcntl</span><span class="token punctuation">(</span>sockets<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mReceiveFd <span class="token operator">=</span> sockets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        mSendFd <span class="token operator">=</span> sockets<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mReceiveFd <span class="token operator">=</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"BitTube: pipe creation failed (%s)"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>mReceiveFd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在BitTube中设定了0是接受，1是写入。其实就和管道一致。</p>
<p>接着调用EventThread::Connection的stealReceiveChannel：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t EventThread<span class="token operator">::</span>Connection<span class="token operator">::</span><span class="token function">stealReceiveChannel</span><span class="token punctuation">(</span>gui<span class="token operator">::</span>BitTube<span class="token operator">*</span> outChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    outChannel<span class="token operator">-</span><span class="token operator">></span><span class="token function">setReceiveFd</span><span class="token punctuation">(</span>mChannel<span class="token punctuation">.</span><span class="token function">moveReceiveFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> BitTube<span class="token operator">::</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mReceiveFd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时将会设置一个直接的接受的fd为公开，然后Looper将会注册这个接受端是否有数据从发送端到来。</p>
<p>当waitForEvent接触等待后，将会调用Connection的postEvent方法：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/EventThread.cpp" target="_blank" rel="noopener">EventThread.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t EventThread<span class="token operator">::</span>Connection<span class="token operator">::</span><span class="token function">postEvent</span><span class="token punctuation">(</span><span class="token keyword">const</span> DisplayEventReceiver<span class="token operator">::</span>Event<span class="token operator">&amp;</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ssize_t size <span class="token operator">=</span> DisplayEventReceiver<span class="token operator">::</span><span class="token function">sendEvents</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mChannel<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> size <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token function">status_t</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">status_t</span><span class="token punctuation">(</span>NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/DisplayEventReceiver.cpp" target="_blank" rel="noopener">DisplayEventReceiver.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">ssize_t DisplayEventReceiver<span class="token operator">::</span><span class="token function">sendEvents</span><span class="token punctuation">(</span>gui<span class="token operator">::</span>BitTube<span class="token operator">*</span> dataChannel<span class="token punctuation">,</span>
        Event <span class="token keyword">const</span><span class="token operator">*</span> events<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> gui<span class="token operator">::</span>BitTube<span class="token operator">::</span><span class="token function">sendObjects</span><span class="token punctuation">(</span>dataChannel<span class="token punctuation">,</span> events<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样就完成了从发送端到接收端的过程监听。把监听事件丢给epoll处理。当有数据唤醒时候就会进入到MessageQueue的回调中.</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/MessageQueue.cpp" target="_blank" rel="noopener">MessageQueue.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> MessageQueue<span class="token operator">::</span><span class="token function">cb_eventReceiver</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MessageQueue<span class="token operator">*</span> queue <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>MessageQueue<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> queue<span class="token operator">-</span><span class="token operator">></span><span class="token function">eventReceiver</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> events<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> MessageQueue<span class="token operator">::</span><span class="token function">eventReceiver</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token comment" spellcheck="true">/*fd*/</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token comment" spellcheck="true">/*events*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ssize_t n<span class="token punctuation">;</span>
    DisplayEventReceiver<span class="token operator">::</span>Event buffer<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> DisplayEventReceiver<span class="token operator">::</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mEventTube<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">==</span> DisplayEventReceiver<span class="token operator">::</span>DISPLAY_EVENT_VSYNC<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mHandler<span class="token operator">-</span><span class="token operator">></span><span class="token function">dispatchInvalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时MessageQueue就会调用Handler中的dispatchInvalidate，也就调用到了SF的onMessageReceived中的布局刷新回调。</p>
<h4 id="渲染引擎的初始化"><a href="#渲染引擎的初始化" class="headerlink" title="渲染引擎的初始化"></a>渲染引擎的初始化</h4><pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mRenderEngine <span class="token operator">=</span>
            RE<span class="token operator">::</span>impl<span class="token operator">::</span>RenderEngine<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>HAL_PIXEL_FORMAT_RGBA_8888<span class="token punctuation">,</span>
                                           hasWideColorDisplay
                                                   <span class="token operator">?</span> RE<span class="token operator">::</span>RenderEngine<span class="token operator">::</span>WIDE_COLOR_SUPPORT
                                                   <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在SF中有一个SurfaceFlingerBE对象会一起初始化。将会一个RenderEngine创建给SurfaceFlingerBE。实际上SurfaceFlingerBE可以看做是SF的影子，它控制着所有硬件那一块的接口。而SF则是对应上整个Android系统的刷新机制。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>RenderEngine<span class="token operator">></span> RenderEngine<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">int</span> hwcFormat<span class="token punctuation">,</span> uint32_t featureFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// initialize EGL for the default display</span>
    EGLDisplay display <span class="token operator">=</span> <span class="token function">eglGetDisplay</span><span class="token punctuation">(</span>EGL_DEFAULT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">eglInitialize</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">"failed to initialize EGL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    GLExtensions<span class="token operator">&amp;</span> extensions <span class="token operator">=</span> GLExtensions<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    extensions<span class="token punctuation">.</span><span class="token function">initWithEGLStrings</span><span class="token punctuation">(</span><span class="token function">eglQueryStringImplementationANDROID</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> EGL_VERSION<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  <span class="token function">eglQueryStringImplementationANDROID</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> EGL_EXTENSIONS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// The code assumes that ES2 or later is available if this extension is</span>
    <span class="token comment" spellcheck="true">// supported.</span>
    EGLConfig config <span class="token operator">=</span> EGL_NO_CONFIG<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>extensions<span class="token punctuation">.</span><span class="token function">hasNoConfigContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        config <span class="token operator">=</span> <span class="token function">chooseEglConfig</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> hwcFormat<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/*logConfig*/</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    EGLint renderableType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">==</span> EGL_NO_CONFIG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        renderableType <span class="token operator">=</span> EGL_OPENGL_ES2_BIT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">eglGetConfigAttrib</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> config<span class="token punctuation">,</span> EGL_RENDERABLE_TYPE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>renderableType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">"can't query EGLConfig RENDERABLE_TYPE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    EGLint contextClientVersion <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderableType <span class="token operator">&amp;</span> EGL_OPENGL_ES2_BIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contextClientVersion <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>renderableType <span class="token operator">&amp;</span> EGL_OPENGL_ES_BIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contextClientVersion <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">"no supported EGL_RENDERABLE_TYPEs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>EGLint<span class="token operator">></span> contextAttributes<span class="token punctuation">;</span>
    contextAttributes<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    contextAttributes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>EGL_CONTEXT_CLIENT_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    contextAttributes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>contextClientVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> useContextPriority <span class="token operator">=</span> <span class="token function">overrideUseContextPriorityFromConfig</span><span class="token punctuation">(</span>extensions<span class="token punctuation">.</span><span class="token function">hasContextPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>useContextPriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contextAttributes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>EGL_CONTEXT_PRIORITY_LEVEL_IMG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        contextAttributes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>EGL_CONTEXT_PRIORITY_HIGH_IMG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    contextAttributes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>EGL_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    EGLContext ctxt <span class="token operator">=</span> <span class="token function">eglCreateContext</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> contextAttributes<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// if can't create a GL context, we can only abort.</span>
    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>ctxt <span class="token operator">==</span> EGL_NO_CONTEXT<span class="token punctuation">,</span> <span class="token string">"EGLContext creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// now figure out what version of GL did we actually get</span>
    <span class="token comment" spellcheck="true">// NOTE: a dummy surface is not needed if KHR_create_context is supported</span>

    EGLConfig dummyConfig <span class="token operator">=</span> config<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dummyConfig <span class="token operator">==</span> EGL_NO_CONFIG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dummyConfig <span class="token operator">=</span> <span class="token function">chooseEglConfig</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> hwcFormat<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/*logConfig*/</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    EGLint attribs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>EGL_WIDTH<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> EGL_HEIGHT<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> EGL_NONE<span class="token punctuation">,</span> EGL_NONE<span class="token punctuation">}</span><span class="token punctuation">;</span>
    EGLSurface dummy <span class="token operator">=</span> <span class="token function">eglCreatePbufferSurface</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> dummyConfig<span class="token punctuation">,</span> attribs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>dummy <span class="token operator">==</span> EGL_NO_SURFACE<span class="token punctuation">,</span> <span class="token string">"can't create dummy pbuffer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    EGLBoolean success <span class="token operator">=</span> <span class="token function">eglMakeCurrent</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> dummy<span class="token punctuation">,</span> dummy<span class="token punctuation">,</span> ctxt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">,</span> <span class="token string">"can't make dummy pbuffer current"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    extensions<span class="token punctuation">.</span><span class="token function">initWithGLStrings</span><span class="token punctuation">(</span><span class="token function">glGetString</span><span class="token punctuation">(</span>GL_VENDOR<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">glGetString</span><span class="token punctuation">(</span>GL_RENDERER<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 <span class="token function">glGetString</span><span class="token punctuation">(</span>GL_VERSION<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">glGetString</span><span class="token punctuation">(</span>GL_EXTENSIONS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    GlesVersion version <span class="token operator">=</span> <span class="token function">parseGlesVersion</span><span class="token punctuation">(</span>extensions<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// initialize the renderer while GL is current</span>

    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>RenderEngine<span class="token operator">></span> engine<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>version<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> GLES_VERSION_1_0<span class="token operator">:</span>
        <span class="token keyword">case</span> GLES_VERSION_1_1<span class="token operator">:</span>
            <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">"SurfaceFlinger requires OpenGL ES 2.0 minimum to run."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> GLES_VERSION_2_0<span class="token operator">:</span>
        <span class="token keyword">case</span> GLES_VERSION_3_0<span class="token operator">:</span>
            engine <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>GLES20RenderEngine<span class="token operator">></span><span class="token punctuation">(</span>featureFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    engine<span class="token operator">-</span><span class="token operator">></span><span class="token function">setEGLHandles</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> config<span class="token punctuation">,</span> ctxt<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">eglMakeCurrent</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> EGL_NO_SURFACE<span class="token punctuation">,</span> EGL_NO_SURFACE<span class="token punctuation">,</span> EGL_NO_CONTEXT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eglDestroySurface</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> dummy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> engine<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上这就是一个最经典的openGL es的初始化流程。它做了如下几个事情:</p>
<ul>
<li>1.初始化EGLDisplay ，获得当前系统默认的显示屏对象</li>
<li>2.初始化EGL的版本</li>
<li>3.chooseEglConfig选择处理EGL的配置。这里的逻辑比较有意思，先通过eglGetConfigs查找可返回的EGL配置的数目，接着调用eglChooseConfig从所有配置项中得到最为推荐的配置数组，最后通过遍历查询，把系统中符合当前配置项中所有的配置都添加进来</li>
<li>4.eglCreateContext 初始化EGL上下文</li>
<li>5.设置GL版本号</li>
<li>6.eglCreatePbufferSurface创建一个dump的Surface，开辟一段可以缓存帧数据的空间，并用eglMakeCurrent把EGLDisplay和dump链接起来，其目的就是为了检查OpenGL es是否有问题。</li>
<li>6.setEGLHandles 设置EGLDisplay，上下文和配置为全局配置</li>
<li>7.eglMakeCurrent 把EGLDisplay设置为当前OpenGL es的环境，销毁dump这个Surface。</li>
</ul>
<p>通过这里，我们完全看到一个工业级别的OpenGL es是如何初始化的。</p>
<h4 id="HWComposer的初始化"><a href="#HWComposer的初始化" class="headerlink" title="HWComposer的初始化"></a>HWComposer的初始化</h4><p>这个对象十分十分的重要，它联通的硬件抽象层，硬件层和SF，作为绘制的核心类。可以看做为HardwareCompose硬件合成。也就是我们常说的HWC。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token function">HWComposer</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Hwc2<span class="token operator">::</span>impl<span class="token operator">::</span>Composer<span class="token operator">></span><span class="token punctuation">(</span><span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwcServiceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mComposerSequenceId<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>本文不会过于详细的解析HWC是如何联通硬件抽象层hal中。我们来简单的看看其中的逻辑。能看到HWComposer中传入一个Hwc2::impl::Composer对象，先看看这个对象:<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/" target="_blank" rel="noopener">DisplayHardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/ComposerHal.cpp" target="_blank" rel="noopener">ComposerHal.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Composer<span class="token operator">::</span><span class="token function">Composer</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> serviceName<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">mWriter</span><span class="token punctuation">(</span>kWriterInitialSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mIsUsingVrComposer</span><span class="token punctuation">(</span>serviceName <span class="token operator">==</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"vr"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mComposer <span class="token operator">=</span> V2_1<span class="token operator">::</span>IComposer<span class="token operator">::</span><span class="token function">getService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mComposer<span class="token operator">-</span><span class="token operator">></span><span class="token function">createClient</span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> tmpError<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> tmpClient<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpError <span class="token operator">==</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mClient <span class="token operator">=</span> tmpClient<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// 2.2 support is optional</span>
    sp<span class="token operator">&lt;</span>IComposer<span class="token operator">></span> composer_2_2 <span class="token operator">=</span> IComposer<span class="token operator">::</span><span class="token function">castFrom</span><span class="token punctuation">(</span>mComposer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>composer_2_2 <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mClient_2_2 <span class="token operator">=</span> IComposerClient<span class="token operator">::</span><span class="token function">castFrom</span><span class="token punctuation">(</span>mClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUsingVrComposer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sp<span class="token operator">&lt;</span>IVrComposerClient<span class="token operator">></span> vrClient <span class="token operator">=</span> IVrComposerClient<span class="token operator">::</span><span class="token function">castFrom</span><span class="token punctuation">(</span>mClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到Composer对象中又会持有一个mComposer对象。这个对象可以暂且理解类似为Binder，从抽象层(hal)服务端传送过来的IComposer接口对象。之后所有要和硬件层进行交互，只需要操作这个IComposer对象即可。接着调用IComposer的createClient创建开一个Client对象。如果里面有2.2版本的IComposer对象则会把2.1版本的IComposer转化过去。</p>
<p>这样软件层Composer就和硬件抽象层的Composer对应起来。等待HWComposer的操作。先暂时理解到这里，下一篇文章将会解析硬件抽象层是怎么来到软件层。接下来我会把硬件抽象层简称为hal层。</p>
<h5 id="HWComposer的非hal层初始化与监听"><a href="#HWComposer的非hal层初始化与监听" class="headerlink" title="HWComposer的非hal层初始化与监听"></a>HWComposer的非hal层初始化与监听</h5><p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/" target="_blank" rel="noopener">DisplayHardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp" target="_blank" rel="noopener">HWComposer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">HWComposer<span class="token operator">::</span><span class="token function">HWComposer</span><span class="token punctuation">(</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>android<span class="token operator">::</span>Hwc2<span class="token operator">::</span>Composer<span class="token operator">></span> composer<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">mHwcDevice</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>HWC2<span class="token operator">::</span>Device<span class="token operator">></span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>composer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在这个结构中能看到HWComposer还会初始化一个HWC2::Device对象，这个设备对象才是真正操作hal层的对应的对象。HWC2::Device对象很简单，几乎没有逻辑就跳过。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Device<span class="token operator">::</span><span class="token function">Device</span><span class="token punctuation">(</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>android<span class="token operator">::</span>Hwc2<span class="token operator">::</span>Composer<span class="token operator">></span> composer<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">mComposer</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>composer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">loadCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="HWComposer的监听"><a href="#HWComposer的监听" class="headerlink" title="HWComposer的监听"></a>HWComposer的监听</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mComposerSequenceId<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>接下来会注册SF的监听到HWC中。<br>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/" target="_blank" rel="noopener">DisplayHardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp" target="_blank" rel="noopener">HWComposer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> HWComposer<span class="token operator">::</span><span class="token function">registerCallback</span><span class="token punctuation">(</span>HWC2<span class="token operator">::</span>ComposerCallback<span class="token operator">*</span> callback<span class="token punctuation">,</span>
                                  int32_t sequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mHwcDevice<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> sequenceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件:<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/HWC2.cpp" target="_blank" rel="noopener">http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DisplayHardware/HWC2.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> Device<span class="token operator">::</span><span class="token function">registerCallback</span><span class="token punctuation">(</span>ComposerCallback<span class="token operator">*</span> callback<span class="token punctuation">,</span> int32_t sequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegisteredCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Callback already registered. Ignored extra registration "</span>
                <span class="token string">"attempt."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mRegisteredCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>ComposerCallbackBridge<span class="token operator">></span> <span class="token function">callbackBridge</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token function">ComposerCallbackBridge</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> sequenceId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mComposer<span class="token operator">-</span><span class="token operator">></span><span class="token function">registerCallback</span><span class="token punctuation">(</span>callbackBridge<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到HWC将会借助一个ComposerCallbackBridge对象把对象注册到hal层中进行监听，这个对象的思路其实和ServiceDispatcher，ReceiverDispatcher十分相似，也是本身回调无法传入Binder，这里是进入hal层，转而使用一个包裹的可以传入底层协议的hal对象进行回调。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">ComposerCallbackBridge</span> <span class="token operator">:</span> <span class="token keyword">public</span> Hwc2<span class="token operator">::</span>IComposerCallback <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">ComposerCallbackBridge</span><span class="token punctuation">(</span>ComposerCallback<span class="token operator">*</span> callback<span class="token punctuation">,</span> int32_t sequenceId<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">mCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mSequenceId</span><span class="token punctuation">(</span>sequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    Return<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">onHotplug</span><span class="token punctuation">(</span>Hwc2<span class="token operator">::</span>Display display<span class="token punctuation">,</span>
                           IComposerCallback<span class="token operator">::</span>Connection conn<span class="token punctuation">)</span> override
    <span class="token punctuation">{</span>
        HWC2<span class="token operator">::</span>Connection connection <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>HWC2<span class="token operator">::</span>Connection<span class="token operator">></span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onHotplugReceived</span><span class="token punctuation">(</span>mSequenceId<span class="token punctuation">,</span> display<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Return<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">onRefresh</span><span class="token punctuation">(</span>Hwc2<span class="token operator">::</span>Display display<span class="token punctuation">)</span> override
    <span class="token punctuation">{</span>
        mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onRefreshReceived</span><span class="token punctuation">(</span>mSequenceId<span class="token punctuation">,</span> display<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Return<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">onVsync</span><span class="token punctuation">(</span>Hwc2<span class="token operator">::</span>Display display<span class="token punctuation">,</span> int64_t timestamp<span class="token punctuation">)</span> override
    <span class="token punctuation">{</span>
        mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onVsyncReceived</span><span class="token punctuation">(</span>mSequenceId<span class="token punctuation">,</span> display<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    ComposerCallback<span class="token operator">*</span> mCallback<span class="token punctuation">;</span>
    int32_t mSequenceId<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到很简单的思路，每当hal层发生回调的时候，如刷新请求等时候，就会调用callback对应的onRefreshReceived，onVsyncReceived，onHotplugReceived三个方法。还记得最上面的SF的UML图吗？SF实际上实现了ComposerCallback。也就是说，此时SF就通过了ComposerBridge联通了hal层。</p>
<p>这样就能做到从hal通知到软件层。</p>
<h4 id="EventControlThread的初始化"><a href="#EventControlThread的初始化" class="headerlink" title="EventControlThread的初始化"></a>EventControlThread的初始化</h4><p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/EventControlThread.cpp" target="_blank" rel="noopener">EventControlThread.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">EventControlThread<span class="token operator">::</span><span class="token function">EventControlThread</span><span class="token punctuation">(</span>EventControlThread<span class="token operator">::</span>SetVSyncEnabledFunction function<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">mSetVSyncEnabled</span><span class="token punctuation">(</span>function<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pthread_setname_np</span><span class="token punctuation">(</span>mThread<span class="token punctuation">.</span><span class="token function">native_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"EventControlThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pid_t tid <span class="token operator">=</span> <span class="token function">pthread_gettid_np</span><span class="token punctuation">(</span>mThread<span class="token punctuation">.</span><span class="token function">native_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setpriority</span><span class="token punctuation">(</span>PRIO_PROCESS<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> ANDROID_PRIORITY_URGENT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_sched_policy</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> SP_FOREGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventControlThread<span class="token operator">::</span><span class="token function">threadMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> NO_THREAD_SAFETY_ANALYSIS <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> keepRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> currentVsyncEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>keepRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mSetVSyncEnabled</span><span class="token punctuation">(</span>currentVsyncEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCondition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">,</span> currentVsyncEnabled<span class="token punctuation">,</span> keepRunning<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> NO_THREAD_SAFETY_ANALYSIS <span class="token punctuation">{</span>
            <span class="token keyword">return</span> currentVsyncEnabled <span class="token operator">!=</span> mVsyncEnabled <span class="token operator">||</span> keepRunning <span class="token operator">!=</span> mKeepRunning<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentVsyncEnabled <span class="token operator">=</span> mVsyncEnabled<span class="token punctuation">;</span>
        keepRunning <span class="token operator">=</span> mKeepRunning<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到EventControlThread其实就是对整个HWC的EventThread的控制。因为mSetVSyncEnabled其实对应的是</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">setVsyncEnabled</span><span class="token punctuation">(</span>HWC_DISPLAY_PRIMARY<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>不过简单很多，是因为它只对HWC负责。</p>
<h4 id="initializeDisplays-准备初始化显示屏数据异步消息"><a href="#initializeDisplays-准备初始化显示屏数据异步消息" class="headerlink" title="initializeDisplays 准备初始化显示屏数据异步消息"></a>initializeDisplays 准备初始化显示屏数据异步消息</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">initializeDisplays</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">MessageScreenInitialized</span> <span class="token operator">:</span> <span class="token keyword">public</span> MessageBase <span class="token punctuation">{</span>
        SurfaceFlinger<span class="token operator">*</span> flinger<span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">explicit</span> <span class="token function">MessageScreenInitialized</span><span class="token punctuation">(</span>SurfaceFlinger<span class="token operator">*</span> flinger<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">flinger</span><span class="token punctuation">(</span>flinger<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
        <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            flinger<span class="token operator">-</span><span class="token operator">></span><span class="token function">onInitializeDisplays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>MessageBase<span class="token operator">></span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MessageScreenInitialized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">postMessageAsync</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// we may be called from main thread, use async message</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种写法在底层十分常见，能直观的看到Handler的回调机制。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t SurfaceFlinger<span class="token operator">::</span><span class="token function">postMessageAsync</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>MessageBase<span class="token operator">></span><span class="token operator">&amp;</span> msg<span class="token punctuation">,</span>
        nsecs_t reltime<span class="token punctuation">,</span> uint32_t <span class="token comment" spellcheck="true">/* flags */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mEventQueue<span class="token operator">-</span><span class="token operator">></span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> reltime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到在这里借助SF的异步机制调用到下一次Looper回来之后才会调用。还记得这个时候mEventQueue中的Looper仅仅只是初始化，还没循环阻塞起来进行监听吗？需要等到mEventQueue进行了Looper。因此这个时候不会立即进入Handler中进行回调。而是会继续下一个步骤。</p>
<h4 id="SF-的-run"><a href="#SF-的-run" class="headerlink" title="SF 的 run"></a>SF 的 run</h4><p>此时SF的init方法已经结束了。当经过startDisplayService的注册hal层的DisplayService方法之后，接着在main_surfaceflinger中会继续走surfaceFlinger的run方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token function">waitForEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">waitForEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mEventQueue<span class="token operator">-</span><span class="token operator">></span><span class="token function">waitMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/MessageQueue.cpp" target="_blank" rel="noopener">MessageQueue.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MessageQueue<span class="token operator">::</span><span class="token function">waitMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        IPCThreadState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">flushCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        int32_t ret <span class="token operator">=</span> mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">pollOnce</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> Looper<span class="token operator">::</span>POLL_WAKE<span class="token operator">:</span>
            <span class="token keyword">case</span> Looper<span class="token operator">::</span>POLL_CALLBACK<span class="token operator">:</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> Looper<span class="token operator">::</span>POLL_ERROR<span class="token operator">:</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Looper::POLL_ERROR"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> Looper<span class="token operator">::</span>POLL_TIMEOUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// timeout (should not happen)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// should not happen</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Looper::pollOnce() returned unknown status %d"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>进入这个死循环之后，会处理一下Binder过来的消息，接着通过epoll等待有人唤醒epoll。</p>
<h3 id="SF-初始化显示屏模块"><a href="#SF-初始化显示屏模块" class="headerlink" title="SF 初始化显示屏模块"></a>SF 初始化显示屏模块</h3><p>有想过，为什么SF要这么做吗？为什么在init的时候就提前把mEventQueue的消息循环起来？而是等到最后再run呢？其实其目的很简单，就是为了做一件事，就为了让注册到硬件层中ComposerCallback进行回调。等到回调之后再执行刚刚因为run起来而执行的异步消息。</p>
<p>下一篇文章，我将带领你们看看高通msm8996在hal层是如何实现回调。我们从常识推断，一个手机通电，屏幕驱动一定是最早那几个启动的常用服务(除了Linux内核这些之外)。因此当SF启动之后，在底层一定会准备好一个通知，一旦SF注册了监听一定会回调。还记得ComposerCallbackBridge中回调，实际上应对上的是SF对应的，屏幕热插拔回调：onHotplugReceived。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">onHotplugReceived</span><span class="token punctuation">(</span>int32_t sequenceId<span class="token punctuation">,</span> hwc2_display_t display<span class="token punctuation">,</span>
                                       HWC2<span class="token operator">::</span>Connection connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"onHotplugReceived(%d, %"</span> PRIu64 <span class="token string">", %s)"</span><span class="token punctuation">,</span> sequenceId<span class="token punctuation">,</span> display<span class="token punctuation">,</span>
          connection <span class="token operator">==</span> HWC2<span class="token operator">::</span>Connection<span class="token operator">::</span>Connected <span class="token operator">?</span> <span class="token string">"connected"</span> <span class="token operator">:</span> <span class="token string">"disconnected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Ignore events that do not have the right sequenceId.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sequenceId <span class="token operator">!=</span> <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mComposerSequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ConditionalLock <span class="token function">lock</span><span class="token punctuation">(</span>mStateLock<span class="token punctuation">,</span> std<span class="token operator">::</span>this_thread<span class="token operator">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> mMainThreadId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mPendingHotplugEvents<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>HotplugEvent<span class="token punctuation">{</span>display<span class="token punctuation">,</span> connection<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>std<span class="token operator">::</span>this_thread<span class="token operator">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> mMainThreadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Process all pending hot plug events immediately if we are on the main thread.</span>
        <span class="token function">processDisplayHotplugEventsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">setTransactionFlags</span><span class="token punctuation">(</span>eDisplayTransactionNeeded<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这一段代码段，能看到HWC2::Connection 代表当前的链接状态，而hwc2_display_t则是来自hal层的结构体，象征着屏幕。此时构建一个新的结构体压入mPendingHotplugEvents 集合中。等待SF消化这个集合中的数据</p>
<p>这里可能出现两个不同的线程一个是来自hwBinder(实际也是一个Binder驱动，只是专门负责和硬件交流罢了)，一个可能是来自自己线程。我们就默认是当前线程即可，就会执行processDisplayHotplugEventsLocked。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">processDisplayHotplugEventsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> event <span class="token operator">:</span> mPendingHotplugEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> displayType <span class="token operator">=</span> <span class="token function">determineDisplayType</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>display<span class="token punctuation">,</span> event<span class="token punctuation">.</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>displayType <span class="token operator">==</span> DisplayDevice<span class="token operator">::</span>DISPLAY_ID_INVALID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token operator">-</span><span class="token operator">></span><span class="token function">isUsingVrComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> displayType <span class="token operator">==</span> DisplayDevice<span class="token operator">::</span>DISPLAY_EXTERNAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token operator">-</span><span class="token operator">></span><span class="token function">onHotplug</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>display<span class="token punctuation">,</span> displayType<span class="token punctuation">,</span> event<span class="token punctuation">.</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>connection <span class="token operator">==</span> HWC2<span class="token operator">::</span>Connection<span class="token operator">::</span>Connected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mBuiltinDisplays<span class="token punctuation">[</span>displayType<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mBuiltinDisplays<span class="token punctuation">[</span>displayType<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// All non-virtual displays are currently considered secure.</span>
                DisplayDeviceState <span class="token function">info</span><span class="token punctuation">(</span>displayType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                info<span class="token punctuation">.</span>displayName <span class="token operator">=</span> displayType <span class="token operator">==</span> DisplayDevice<span class="token operator">::</span>DISPLAY_PRIMARY <span class="token operator">?</span>
                        <span class="token string">"Built-in Screen"</span> <span class="token operator">:</span> <span class="token string">"External Screen"</span><span class="token punctuation">;</span>
                mCurrentState<span class="token punctuation">.</span>displays<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mBuiltinDisplays<span class="token punctuation">[</span>displayType<span class="token punctuation">]</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mInterceptor<span class="token operator">-</span><span class="token operator">></span><span class="token function">saveDisplayCreation</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            ssize_t idx <span class="token operator">=</span> mCurrentState<span class="token punctuation">.</span>displays<span class="token punctuation">.</span><span class="token function">indexOfKey</span><span class="token punctuation">(</span>mBuiltinDisplays<span class="token punctuation">[</span>displayType<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> DisplayDeviceState<span class="token operator">&amp;</span> <span class="token function">info</span><span class="token punctuation">(</span>mCurrentState<span class="token punctuation">.</span>displays<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mInterceptor<span class="token operator">-</span><span class="token operator">></span><span class="token function">saveDisplayDeletion</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mCurrentState<span class="token punctuation">.</span>displays<span class="token punctuation">.</span><span class="token function">removeItemsAt</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mBuiltinDisplays<span class="token punctuation">[</span>displayType<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">processDisplayChangesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mPendingHotplugEvents<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.此时会调用mHwc-&gt;onHotplug主动通知HWComposer。</p>
</li>
<li><p>2.如果此时显示屏是告诉SF是插入了一个屏幕，则需要屏幕id作为index，为mBuiltinDisplays赋值一个BBinder，等待DisplayerManagerService的调用。并且保存当前的状态。把当前屏幕加入到mCurrentState的display</p>
</li>
<li><p>3.如果此时屏幕关闭或者拔出，则销毁当前mBuiltinDisplays对应index中屏幕的信息以及信息。</p>
</li>
<li><p>4.processDisplayChangesLocked 处理屏幕状态发生变化后的处理。</p>
</li>
</ul>
<p>这里稍微提一句mBuiltinDisplays本质上就是一个大小为2数组。但是设定两个不同的类型：</p>
<ul>
<li>DISPLAY_PRIMARY 数值为0 是指主屏幕</li>
<li>DISPLAY_EXTERNAL  数值为1 指额外屏幕</li>
</ul>
<h3 id="HWComposer-主动处理onHotplug"><a href="#HWComposer-主动处理onHotplug" class="headerlink" title="HWComposer 主动处理onHotplug"></a>HWComposer 主动处理onHotplug</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> HWComposer<span class="token operator">::</span><span class="token function">onHotplug</span><span class="token punctuation">(</span>hwc2_display_t displayId<span class="token punctuation">,</span> int32_t displayType<span class="token punctuation">,</span>
                           HWC2<span class="token operator">::</span>Connection connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>displayType <span class="token operator">>=</span> HWC_NUM_PHYSICAL_DISPLAY_TYPES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mHwcDevice<span class="token operator">-</span><span class="token operator">></span><span class="token function">onHotplug</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">==</span> HWC2<span class="token operator">::</span>Connection<span class="token operator">::</span>Connected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mDisplayData<span class="token punctuation">[</span>displayType<span class="token punctuation">]</span><span class="token punctuation">.</span>hwcDisplay <span class="token operator">=</span> mHwcDevice<span class="token operator">-</span><span class="token operator">></span><span class="token function">getDisplayById</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHwcDisplaySlots<span class="token punctuation">[</span>displayId<span class="token punctuation">]</span> <span class="token operator">=</span> displayType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上在这个过程中会把链接上的屏幕保存到mDisplayData和mHwcDisplaySlots两个数组中。不过核心还是把事情委托下层的mHwcDevice的事情。经过上面的阅读，本质上就是HWC::Device:</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> Device<span class="token operator">::</span><span class="token function">onHotplug</span><span class="token punctuation">(</span>hwc2_display_t displayId<span class="token punctuation">,</span> Connection connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">==</span> Connection<span class="token operator">::</span>Connected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> oldDisplay <span class="token operator">=</span> <span class="token function">getDisplayById</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldDisplay <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> oldDisplay<span class="token operator">-</span><span class="token operator">></span><span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Hotplug connecting an already connected display."</span>
                    <span class="token string">" Clearing old display state."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mDisplays<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        DisplayType displayType<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> intError <span class="token operator">=</span> mComposer<span class="token operator">-</span><span class="token operator">></span><span class="token function">getDisplayType</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span>
                <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Hwc2<span class="token operator">::</span>IComposerClient<span class="token operator">::</span>DisplayType <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>
                        <span class="token operator">&amp;</span>displayType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> error <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>Error<span class="token operator">></span><span class="token punctuation">(</span>intError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> Error<span class="token operator">::</span>None<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">auto</span> newDisplay <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Display<span class="token operator">></span><span class="token punctuation">(</span>
                <span class="token operator">*</span>mComposer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mCapabilities<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span> displayType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        newDisplay<span class="token operator">-</span><span class="token operator">></span><span class="token function">setConnected</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDisplays<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>newDisplay<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">==</span> Connection<span class="token operator">::</span>Disconnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> display <span class="token operator">=</span> <span class="token function">getDisplayById</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>display<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            display<span class="token operator">-</span><span class="token operator">></span><span class="token function">setConnected</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实这里面的逻辑很简单，就是记录下一个还没有链接过的屏幕，并且初始化为HWC::Display一个屏幕对象，并设置好状态。并且保存到mDisplays中。到这里就完成了从硬件层的硬件对象到软件层的映射。</p>
<p>从有限信息里面可以得知hwc2_display_t 会对应上一个HWC::Display对象。但是在hal层是不是真的这个对象呢？等到后面再来看。</p>
<h4 id="processDisplayChangesLocked-尝试为屏幕分配图元Surface"><a href="#processDisplayChangesLocked-尝试为屏幕分配图元Surface" class="headerlink" title="processDisplayChangesLocked 尝试为屏幕分配图元Surface"></a>processDisplayChangesLocked 尝试为屏幕分配图元Surface</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">processDisplayChangesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> KeyedVector<span class="token operator">&lt;</span>wp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token punctuation">,</span> DisplayDeviceState<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">curr</span><span class="token punctuation">(</span>mCurrentState<span class="token punctuation">.</span>displays<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> KeyedVector<span class="token operator">&lt;</span>wp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token punctuation">,</span> DisplayDeviceState<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">draw</span><span class="token punctuation">(</span>mDrawingState<span class="token punctuation">.</span>displays<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>curr<span class="token punctuation">.</span><span class="token function">isIdenticalTo</span><span class="token punctuation">(</span>draw<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mVisibleRegionsDirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> size_t cc <span class="token operator">=</span> curr<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        size_t dc <span class="token operator">=</span> draw<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dc<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> ssize_t j <span class="token operator">=</span> curr<span class="token punctuation">.</span><span class="token function">indexOfKey</span><span class="token punctuation">(</span>draw<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> sp<span class="token operator">&lt;</span><span class="token keyword">const</span> DisplayDevice<span class="token operator">></span> <span class="token function">defaultDisplay</span><span class="token punctuation">(</span><span class="token function">getDefaultDisplayDeviceLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultDisplay <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> defaultDisplay<span class="token operator">-</span><span class="token operator">></span><span class="token function">makeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sp<span class="token operator">&lt;</span>DisplayDevice<span class="token operator">></span> <span class="token function">hw</span><span class="token punctuation">(</span><span class="token function">getDisplayDeviceLocked</span><span class="token punctuation">(</span>draw<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>hw <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> hw<span class="token operator">-</span><span class="token operator">></span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token function">getHwComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>draw<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">&lt;</span> DisplayDevice<span class="token operator">::</span>NUM_BUILTIN_DISPLAY_TYPES<span class="token punctuation">)</span>
                    mEventThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">onHotplugReceived</span><span class="token punctuation">(</span>draw<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mDisplays<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span>draw<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token operator">++</span>i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// find displays that were added</span>
        <span class="token comment" spellcheck="true">// (ie: in current state but not in drawing state)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>draw<span class="token punctuation">.</span><span class="token function">indexOfKey</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> DisplayDeviceState<span class="token operator">&amp;</span> <span class="token function">state</span><span class="token punctuation">(</span>curr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                sp<span class="token operator">&lt;</span>DisplaySurface<span class="token operator">></span> dispSurface<span class="token punctuation">;</span>
                sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">></span> producer<span class="token punctuation">;</span>
                sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">></span> bqProducer<span class="token punctuation">;</span>
                sp<span class="token operator">&lt;</span>IGraphicBufferConsumer<span class="token operator">></span> bqConsumer<span class="token punctuation">;</span>
                <span class="token function">mCreateBufferQueue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bqProducer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bqConsumer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                int32_t hwcId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">isVirtualDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    hwcId <span class="token operator">=</span> state<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
                    dispSurface <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">FramebufferSurface</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token punctuation">,</span> hwcId<span class="token punctuation">,</span> bqConsumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    producer <span class="token operator">=</span> bqProducer<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">const</span> wp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">display</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dispSurface <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mDisplays<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span>
                                  <span class="token function">setupNewDisplayDeviceInternal</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> hwcId<span class="token punctuation">,</span> state<span class="token punctuation">,</span> dispSurface<span class="token punctuation">,</span>
                                                                producer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">isVirtualDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mEventThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">onHotplugReceived</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    mDrawingState<span class="token punctuation">.</span>displays <span class="token operator">=</span> mCurrentState<span class="token punctuation">.</span>displays<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法很长，我省略了一部分，先关注剩下这部分符合第一次初始化进来的逻辑。</p>
<p>能看到在SF中有两个显示屏的State。一个是mCurrentState当前持有所有的显示屏数据的mCurrentState，换句话说SF当前的状态。另一个是mDrawingState，也就是SF需要绘制的状态。</p>
<p>SF每一次绘制只会绘制在mDrawingState中的屏幕和图元，而不是mCurrentState。但是每一次执行该方法的时候会为mDrawingState中的display设置为mCurrentState的display。</p>
<p>因此第一次回调的时候，一定不会在mDrawingState找到mCurrentState中的显示屏数据。先调用getDisplayDeviceLocked尝试设置默认屏幕也就是主屏幕为当前要绘制的屏幕。关闭其他屏幕。但是此时主屏幕都还没有初始化好，这段逻辑也就没用。</p>
<p>核心逻辑在遍历下面那个mCurrentState中。我们不去管虚拟屏幕，我们只关注接进来主屏幕。</p>
<p>在这个过程，出现一个十分重要的对象mCreateBufferQueue，这是就是我之前篇章聊到过图元队列，里面包含着生产者和消费者，最后赋值给FramebufferSurface。</p>
<p>换句话，当我们需要思考图元消费逻辑，就需要从FramebufferSurface开始探索。</p>
<p>最后要进行很核心的逻辑，把display对应的BBinder和通过setupNewDisplayDeviceInternal生产的DisplayService设置到mDisplays这个map缓存中。</p>
<p>如果，如果不是虚拟屏幕，此时将会进行调用EventThread的onHotplugReceived。这里不要弄混淆ComposerCallback一样的HotPlugin回调。这个是EventThread是发送vysnc，用于唤醒waitForEvent的阻塞：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> EventThread<span class="token operator">::</span><span class="token function">onHotplugReceived</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">bool</span> connected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">&lt;</span> DisplayDevice<span class="token operator">::</span>NUM_BUILTIN_DISPLAY_TYPES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        DisplayEventReceiver<span class="token operator">::</span>Event event<span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">=</span> DisplayEventReceiver<span class="token operator">::</span>DISPLAY_EVENT_HOTPLUG<span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>header<span class="token punctuation">.</span>id <span class="token operator">=</span> type<span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>header<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>hotplug<span class="token punctuation">.</span>connected <span class="token operator">=</span> connected<span class="token punctuation">;</span>
        mPendingEvents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCondition<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时会唤起阻塞住线程mCondition。具体做了什么，之后再聊。</p>
<h4 id="setupNewDisplayDeviceInternal"><a href="#setupNewDisplayDeviceInternal" class="headerlink" title="setupNewDisplayDeviceInternal"></a>setupNewDisplayDeviceInternal</h4><pre class="line-numbers language-cpp"><code class="language-cpp">sp<span class="token operator">&lt;</span>DisplayDevice<span class="token operator">></span> SurfaceFlinger<span class="token operator">::</span><span class="token function">setupNewDisplayDeviceInternal</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> wp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> display<span class="token punctuation">,</span> <span class="token keyword">int</span> hwcId<span class="token punctuation">,</span> <span class="token keyword">const</span> DisplayDeviceState<span class="token operator">&amp;</span> state<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>DisplaySurface<span class="token operator">></span><span class="token operator">&amp;</span> dispSurface<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">></span><span class="token operator">&amp;</span> producer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">bool</span> hasWideColorGamut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>unordered_map<span class="token operator">&lt;</span>ColorMode<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>RenderIntent<span class="token operator">>></span> hwcColorModes<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasWideColorDisplay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>ColorMode<span class="token operator">></span> modes <span class="token operator">=</span> <span class="token function">getHwComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColorModes</span><span class="token punctuation">(</span>hwcId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ColorMode colorMode <span class="token operator">:</span> modes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>colorMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> ColorMode<span class="token operator">::</span>DISPLAY_P3<span class="token operator">:</span>
                <span class="token keyword">case</span> ColorMode<span class="token operator">::</span>ADOBE_RGB<span class="token operator">:</span>
                <span class="token keyword">case</span> ColorMode<span class="token operator">::</span>DCI_P3<span class="token operator">:</span>
                    hasWideColorGamut <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>RenderIntent<span class="token operator">></span> renderIntents <span class="token operator">=</span> <span class="token function">getHwComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRenderIntents</span><span class="token punctuation">(</span>hwcId<span class="token punctuation">,</span>
                                                                                       colorMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            hwcColorModes<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>colorMode<span class="token punctuation">,</span> renderIntents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    HdrCapabilities hdrCapabilities<span class="token punctuation">;</span>
    <span class="token function">getHwComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHdrCapabilities</span><span class="token punctuation">(</span>hwcId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hdrCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> nativeWindowSurface <span class="token operator">=</span> <span class="token function">mCreateNativeWindowSurface</span><span class="token punctuation">(</span>producer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> nativeWindow <span class="token operator">=</span> nativeWindowSurface<span class="token operator">-</span><span class="token operator">></span><span class="token function">getNativeWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
     * Create our display's surface
     */</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>RE<span class="token operator">::</span>Surface<span class="token operator">></span> renderSurface <span class="token operator">=</span> <span class="token function">getRenderEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    renderSurface<span class="token operator">-</span><span class="token operator">></span><span class="token function">setCritical</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>type <span class="token operator">==</span> DisplayDevice<span class="token operator">::</span>DISPLAY_PRIMARY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    renderSurface<span class="token operator">-</span><span class="token operator">></span><span class="token function">setAsync</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>type <span class="token operator">>=</span> DisplayDevice<span class="token operator">::</span>DISPLAY_VIRTUAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    renderSurface<span class="token operator">-</span><span class="token operator">></span><span class="token function">setNativeWindow</span><span class="token punctuation">(</span>nativeWindow<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> displayWidth <span class="token operator">=</span> renderSurface<span class="token operator">-</span><span class="token operator">></span><span class="token function">queryWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> displayHeight <span class="token operator">=</span> renderSurface<span class="token operator">-</span><span class="token operator">></span><span class="token function">queryHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>type <span class="token operator">>=</span> DisplayDevice<span class="token operator">::</span>DISPLAY_VIRTUAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nativeWindow<span class="token operator">-</span><span class="token operator">></span><span class="token function">setSwapInterval</span><span class="token punctuation">(</span>nativeWindow<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// virtual displays are always considered enabled</span>
    <span class="token keyword">auto</span> initialPowerMode <span class="token operator">=</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>type <span class="token operator">>=</span> DisplayDevice<span class="token operator">::</span>DISPLAY_VIRTUAL<span class="token punctuation">)</span> <span class="token operator">?</span> HWC_POWER_MODE_NORMAL
                                                                           <span class="token operator">:</span> HWC_POWER_MODE_OFF<span class="token punctuation">;</span>

    sp<span class="token operator">&lt;</span>DisplayDevice<span class="token operator">></span> hw <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token function">DisplayDevice</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>type<span class="token punctuation">,</span> hwcId<span class="token punctuation">,</span> state<span class="token punctuation">.</span>isSecure<span class="token punctuation">,</span> display<span class="token punctuation">,</span> nativeWindow<span class="token punctuation">,</span>
                              dispSurface<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>renderSurface<span class="token punctuation">)</span><span class="token punctuation">,</span> displayWidth<span class="token punctuation">,</span> displayHeight<span class="token punctuation">,</span>
                              hasWideColorGamut<span class="token punctuation">,</span> hdrCapabilities<span class="token punctuation">,</span>
                              <span class="token function">getHwComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSupportedPerFrameMetadata</span><span class="token punctuation">(</span>hwcId<span class="token punctuation">)</span><span class="token punctuation">,</span>
                              hwcColorModes<span class="token punctuation">,</span> initialPowerMode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>maxFrameBufferAcquiredBuffers <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nativeWindowSurface<span class="token operator">-</span><span class="token operator">></span><span class="token function">preallocateBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ColorMode defaultColorMode <span class="token operator">=</span> ColorMode<span class="token operator">::</span>NATIVE<span class="token punctuation">;</span>
    Dataspace defaultDataSpace <span class="token operator">=</span> Dataspace<span class="token operator">::</span>UNKNOWN<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasWideColorGamut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        defaultColorMode <span class="token operator">=</span> ColorMode<span class="token operator">::</span>SRGB<span class="token punctuation">;</span>
        defaultDataSpace <span class="token operator">=</span> Dataspace<span class="token operator">::</span>SRGB<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">setActiveColorModeInternal</span><span class="token punctuation">(</span>hw<span class="token punctuation">,</span> defaultColorMode<span class="token punctuation">,</span> defaultDataSpace<span class="token punctuation">,</span>
                               RenderIntent<span class="token operator">::</span>COLORIMETRIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>type <span class="token operator">&lt;</span> DisplayDevice<span class="token operator">::</span>DISPLAY_VIRTUAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hw<span class="token operator">-</span><span class="token operator">></span><span class="token function">setActiveConfig</span><span class="token punctuation">(</span><span class="token function">getHwComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActiveConfigIndex</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    hw<span class="token operator">-</span><span class="token operator">></span><span class="token function">setLayerStack</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>layerStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hw<span class="token operator">-</span><span class="token operator">></span><span class="token function">setProjection</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>orientation<span class="token punctuation">,</span> state<span class="token punctuation">.</span>viewport<span class="token punctuation">,</span> state<span class="token punctuation">.</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hw<span class="token operator">-</span><span class="token operator">></span><span class="token function">setDisplayName</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>displayName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> hw<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 这里面的核心结构有两个，一个是通过图元生产者构建一个nativeWindow，同时让RenderEngine渲染引擎生成一个RE::Surface对象，并从RE::Surface获取宽高信息，layer栈，并全部收集到DisplayDevice。</p>
<p>数据结构有点乱，当我们需要找到一个屏幕的图元渲染Surface该怎么找呢？总结就是，先从mDisplays 通过displayID找到DisplayDevice，DisplayDevice能找到对应的nativeWindow，最后能找到E::Surface。</p>
<p>好了，关于显示屏数据结构已经准备好了，我们来看看在等待队列中消息做了什么？</p>
<h4 id="onInitializeDisplays"><a href="#onInitializeDisplays" class="headerlink" title="onInitializeDisplays"></a>onInitializeDisplays</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">onInitializeDisplays</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// reset screen orientation and use primary layer stack</span>
    Vector<span class="token operator">&lt;</span>ComposerState<span class="token operator">></span> state<span class="token punctuation">;</span>
    Vector<span class="token operator">&lt;</span>DisplayState<span class="token operator">></span> displays<span class="token punctuation">;</span>
    DisplayState d<span class="token punctuation">;</span>
    d<span class="token punctuation">.</span>what <span class="token operator">=</span> DisplayState<span class="token operator">::</span>eDisplayProjectionChanged <span class="token operator">|</span>
             DisplayState<span class="token operator">::</span>eLayerStackChanged<span class="token punctuation">;</span>
    d<span class="token punctuation">.</span>token <span class="token operator">=</span> mBuiltinDisplays<span class="token punctuation">[</span>DisplayDevice<span class="token operator">::</span>DISPLAY_PRIMARY<span class="token punctuation">]</span><span class="token punctuation">;</span>
    d<span class="token punctuation">.</span>layerStack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    d<span class="token punctuation">.</span>orientation <span class="token operator">=</span> DisplayState<span class="token operator">::</span>OrientationDefault<span class="token punctuation">;</span>
    d<span class="token punctuation">.</span>frame<span class="token punctuation">.</span><span class="token function">makeInvalid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    d<span class="token punctuation">.</span>viewport<span class="token punctuation">.</span><span class="token function">makeInvalid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    d<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    d<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    displays<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTransactionState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> displays<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setPowerModeInternal</span><span class="token punctuation">(</span><span class="token function">getDisplayDevice</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">,</span> HWC_POWER_MODE_NORMAL<span class="token punctuation">,</span>
                         <span class="token comment" spellcheck="true">/*stateLockHeld*/</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> activeConfig <span class="token operator">=</span> <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token operator">-</span><span class="token operator">></span><span class="token function">getActiveConfig</span><span class="token punctuation">(</span>HWC_DISPLAY_PRIMARY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nsecs_t period <span class="token operator">=</span> activeConfig<span class="token operator">-</span><span class="token operator">></span><span class="token function">getVsyncPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mAnimFrameTracker<span class="token punctuation">.</span><span class="token function">setDisplayRefreshPeriod</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setCompositorTimingSnapped</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> period<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里能看到其实就是收集主屏幕相关的信息，通过setTransactionState设置和调整mCurrentState中的display中属性的状态。这里因为篇幅原因，等到遇到再聊。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文详细的剖析了SF的hal层之上的SurfaceFlinger的初始化，让我们对SF有了一个整体的概括印象。明白每一个重要角色将会负担什么？</p>
<ul>
<li><ol>
<li>PrimaryDispSync EventThread MessageQueue组成了Vysnc同步信号的发放逻辑。</li>
</ol>
</li>
</ul>
<p><img src="/images/EventThread.png" alt="EventThread.png"></p>
<ul>
<li>2.SF 有一个SFBE作为面向硬件设备操作的对象。里面包含两个及其重要的角色HWComposer，以及RenderEngine。HWComposer里面包裹这和hal通信的媒介HWC::Device,同时HWComposer会把SF注册到hal层，等待硬件的回调。RenderEngine则是为渲染图元做出了画面承载体的准备，和准备了OpenGL es相关的环境。</li>
</ul>
<p>用一副图对SF进行总结。<br><img src="/images/SF%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BB%93%E6%9E%84.png" alt="SF初始化结构.png"></p>
<p>记住这幅图，就对SF有了一个大体的印象，之后我们剖析整个SF的细节，将会从这个图的某一处进行学习和探索。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/01/21/android-chong-xue-xi-lie-surfaceflinger-de-hal-ceng-chu-shi-hua/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="Android 重学系列 SurfaceFlinger 的HAL层初始化">
                        
                        <span class="card-title">Android 重学系列 SurfaceFlinger 的HAL层初始化</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章我们研究了SF的初始化。但是还有一个很大也是核心的模块没有聊到，那就是HAL层对应的初始化。什么是HAL层，有简单的话来讲就是硬件驱动和软件之间的中间层，为了更好的兼容Android系统而诞生。
在Android 8.0之后会
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-01-21
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/12/15/linux-nei-he-ni-hao-xi-lie-dui-nei-cun-xi-tong-de-zong-lan/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Linux内核你好系列 对内存系统的总览">
                        
                        <span class="card-title">Linux内核你好系列 对内存系统的总览</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言在阅读Android底层源码，特别是关于Linux内核的代码时候，如果对Linux内核整体上没有一定的认知，阅读起来一定很幸苦，本文就总结一下Linux内核内存管理系统的总览，之后有时间会把这些总览分为一个个详细的知识点一一解析其源码

                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-12-15
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Linux-kernel/" class="post-category">
                                    Linux kernel
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Linux/">
                        <span class="chip bg-color">Linux</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
