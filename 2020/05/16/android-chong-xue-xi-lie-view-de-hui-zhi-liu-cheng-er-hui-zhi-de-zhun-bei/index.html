<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 View的绘制流程(二) 绘制的准备, Android | Linux | Flutter">
    <meta name="description" content="前言经过对SurfaceFlinger，SurfaceView的源码的阅读后。这里我们接着这一篇文章View的初始化继续来聊聊View的绘制流程。View的绘制流程总所周知有三步骤，onMeasure，onLayout，onDraw。本文就">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 View的绘制流程(二) 绘制的准备 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/15.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 View的绘制流程(二) 绘制的准备
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/View的绘制流程/" class="post-category">
                                View的绘制流程
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-05-16
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        12.9k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        59 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>经过对SurfaceFlinger，SurfaceView的源码的阅读后。这里我们接着这一篇文章<a href="https://www.jianshu.com/p/003dc36af9db" target="_blank" rel="noopener">View的初始化</a>继续来聊聊View的绘制流程。View的绘制流程总所周知有三步骤，onMeasure，onLayout，onDraw。本文就来聊聊onMeasure相关的知识点。</p>
<p>然而在这个步骤之前还有比较重要的准备步骤，onAttachWindow （View绑定窗口的绘制信息）以及onApplyWindowInsets(分发窗体的间距消费)，硬件渲染的准备。当View剥离出View树进行销毁，就会调用onDetachWindow周期。</p>
<p>本文就围绕准备绘制的前三点进行分析。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>当通过setContentView完成了View的实例化后，此时执行完了Activity的onCreate生命周期。就会走到onResume生命周期中。</p>
<p>在Activity的onResume回调处理后，会继续回到ActivityThread的handleResumeActivity方法。handleResumeActivity将会调用WM的addView的方法。接下来的流程，我在WMS系列文章中有和大家详细的聊过，建议阅读这一篇文章：<a href="https://www.jianshu.com/p/157e8bbfa45a" target="_blank" rel="noopener">WMS在Activity启动中的职责 添加窗体(三)</a>。</p>
<p>其中的核心就是调用ViewRootImpl的setView方法。在聊ViewRootImpl的setView方法之前，ViewRootImpl这个类中有一个类View.AttachInfo贯穿了整个View绘制的逻辑，我们先来看看。</p>
<h3 id="View-AttachInfo"><a href="#View-AttachInfo" class="headerlink" title="View.AttachInfo"></a>View.AttachInfo</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/View.java" target="_blank" rel="noopener">View.java</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
     * A set of information given to a view when it is attached to its parent
     * window.
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AttachInfo</span> <span class="token punctuation">{</span>
        <span class="token keyword">interface</span> <span class="token class-name">Callbacks</span> <span class="token punctuation">{</span>
            <span class="token keyword">void</span> <span class="token function">playSoundEffect</span><span class="token punctuation">(</span><span class="token keyword">int</span> effectId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> <span class="token function">performHapticFeedback</span><span class="token punctuation">(</span><span class="token keyword">int</span> effectId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> always<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/**
         * InvalidateInfo is used to post invalidate(int, int, int, int) messages
         * to a Handler. This class contains the target (View) to invalidate and
         * the coordinates of the dirty rectangle.
         *
         * For performance purposes, this class also implements a pool of up to
         * POOL_LIMIT objects that get reused. This reduces memory allocations
         * whenever possible.
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InvalidateInfo</span> <span class="token punctuation">{</span>
            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> POOL_LIMIT <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> SynchronizedPool<span class="token operator">&lt;</span>InvalidateInfo<span class="token operator">></span> sPool <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">SynchronizedPool</span><span class="token operator">&lt;</span>InvalidateInfo<span class="token operator">></span><span class="token punctuation">(</span>POOL_LIMIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

            View target<span class="token punctuation">;</span>

            <span class="token keyword">int</span> left<span class="token punctuation">;</span>
            <span class="token keyword">int</span> top<span class="token punctuation">;</span>
            <span class="token keyword">int</span> right<span class="token punctuation">;</span>
            <span class="token keyword">int</span> bottom<span class="token punctuation">;</span>

            <span class="token keyword">public</span> <span class="token keyword">static</span> InvalidateInfo <span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                InvalidateInfo instance <span class="token operator">=</span> sPool<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>instance <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> instance <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">InvalidateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                target <span class="token operator">=</span> null<span class="token punctuation">;</span>
                sPool<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> IWindowSession mSession<span class="token punctuation">;</span>

        <span class="token keyword">final</span> IWindow mWindow<span class="token punctuation">;</span>

        <span class="token keyword">final</span> IBinder mWindowToken<span class="token punctuation">;</span>

        Display mDisplay<span class="token punctuation">;</span>

        <span class="token keyword">final</span> Callbacks mRootCallbacks<span class="token punctuation">;</span>

        IWindowId mIWindowId<span class="token punctuation">;</span>
        WindowId mWindowId<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * The top view of the hierarchy.
         */</span>
        View mRootView<span class="token punctuation">;</span>

        IBinder mPanelParentWindowToken<span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> mHardwareAccelerated<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> mHardwareAccelerationRequested<span class="token punctuation">;</span>
        ThreadedRenderer mThreadedRenderer<span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>RenderNode<span class="token operator">></span> mPendingAnimatingRenderNodes<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * The state of the display to which the window is attached, as reported
         * by {@link Display#getState()}.  Note that the display state constants
         * declared by {@link Display} do not exactly line up with the screen state
         * constants declared by {@link View} (there are more display states than
         * screen states).
         */</span>
        <span class="token keyword">int</span> mDisplayState <span class="token operator">=</span> Display<span class="token punctuation">.</span>STATE_UNKNOWN<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Scale factor used by the compatibility mode
         */</span>
        <span class="token keyword">float</span> mApplicationScale<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Indicates whether the application is in compatibility mode
         */</span>
        <span class="token keyword">boolean</span> mScalingRequired<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Left position of this view's window
         */</span>
        <span class="token keyword">int</span> mWindowLeft<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Top position of this view's window
         */</span>
        <span class="token keyword">int</span> mWindowTop<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Indicates whether views need to use 32-bit drawing caches
         */</span>
        <span class="token keyword">boolean</span> mUse32BitDrawingCache<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * For windows that are full-screen but using insets to layout inside
         * of the screen areas, these are the current insets to appear inside
         * the overscan area of the display.
         */</span>
        <span class="token keyword">final</span> Rect mOverscanInsets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * For windows that are full-screen but using insets to layout inside
         * of the screen decorations, these are the current insets for the
         * content of the window.
         */</span>
        <span class="token keyword">final</span> Rect mContentInsets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * For windows that are full-screen but using insets to layout inside
         * of the screen decorations, these are the current insets for the
         * actual visible parts of the window.
         */</span>
        <span class="token keyword">final</span> Rect mVisibleInsets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * For windows that are full-screen but using insets to layout inside
         * of the screen decorations, these are the current insets for the
         * stable system windows.
         */</span>
        <span class="token keyword">final</span> Rect mStableInsets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> DisplayCutout<span class="token punctuation">.</span>ParcelableWrapper mDisplayCutout <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">DisplayCutout<span class="token punctuation">.</span>ParcelableWrapper</span><span class="token punctuation">(</span>DisplayCutout<span class="token punctuation">.</span>NO_CUTOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * For windows that include areas that are not covered by real surface these are the outsets
         * for real surface.
         */</span>
        <span class="token keyword">final</span> Rect mOutsets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * In multi-window we force show the navigation bar. Because we don't want that the surface
         * size changes in this mode, we instead have a flag whether the navigation bar size should
         * always be consumed, so the app is treated like there is no virtual navigation bar at all.
         */</span>
        <span class="token keyword">boolean</span> mAlwaysConsumeNavBar<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * The internal insets given by this window.  This value is
         * supplied by the client (through
         * {@link ViewTreeObserver.OnComputeInternalInsetsListener}) and will
         * be given to the window manager when changed to be used in laying
         * out windows behind it.
         */</span>
        <span class="token keyword">final</span> ViewTreeObserver<span class="token punctuation">.</span>InternalInsetsInfo mGivenInternalInsets
                <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewTreeObserver<span class="token punctuation">.</span>InternalInsetsInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Set to true when mGivenInternalInsets is non-empty.
         */</span>
        <span class="token keyword">boolean</span> mHasNonEmptyGivenInternalInsets<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * All views in the window's hierarchy that serve as scroll containers,
         * used to determine if the window can be resized or must be panned
         * to adjust for a soft input area.
         */</span>
        <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>View<span class="token operator">></span> mScrollContainers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>View<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> KeyEvent<span class="token punctuation">.</span>DispatcherState mKeyDispatchState
                <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyEvent<span class="token punctuation">.</span>DispatcherState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Indicates whether the view's window currently has the focus.
         */</span>
        <span class="token keyword">boolean</span> mHasWindowFocus<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * The current visibility of the window.
         */</span>
        <span class="token keyword">int</span> mWindowVisibility<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Indicates the time at which drawing started to occur.
         */</span>
        <span class="token keyword">long</span> mDrawingTime<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Indicates whether or not ignoring the DIRTY_MASK flags.
         */</span>
        <span class="token keyword">boolean</span> mIgnoreDirtyState<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * This flag tracks when the mIgnoreDirtyState flag is set during draw(),
         * to avoid clearing that flag prematurely.
         */</span>
        <span class="token keyword">boolean</span> mSetIgnoreDirtyState <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Indicates whether the view's window is currently in touch mode.
         */</span>
        <span class="token keyword">boolean</span> mInTouchMode<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Indicates whether the view has requested unbuffered input dispatching for the current
         * event stream.
         */</span>
        <span class="token keyword">boolean</span> mUnbufferedDispatchRequested<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Indicates that ViewAncestor should trigger a global layout change
         * the next time it performs a traversal
         */</span>
        <span class="token keyword">boolean</span> mRecomputeGlobalAttributes<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Always report new attributes at next traversal.
         */</span>
        <span class="token keyword">boolean</span> mForceReportNewAttributes<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Set during a traveral if any views want to keep the screen on.
         */</span>
        <span class="token keyword">boolean</span> mKeepScreenOn<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Set during a traveral if the light center needs to be updated.
         */</span>
        <span class="token keyword">boolean</span> mNeedsUpdateLightCenter<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Bitwise-or of all of the values that views have passed to setSystemUiVisibility().
         */</span>
        <span class="token keyword">int</span> mSystemUiVisibility<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Hack to force certain system UI visibility flags to be cleared.
         */</span>
        <span class="token keyword">int</span> mDisabledSystemUiVisibility<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Last global system UI visibility reported by the window manager.
         */</span>
        <span class="token keyword">int</span> mGlobalSystemUiVisibility <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * True if a view in this hierarchy has an OnSystemUiVisibilityChangeListener
         * attached.
         */</span>
        <span class="token keyword">boolean</span> mHasSystemUiListeners<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Set if the window has requested to extend into the overscan region
         * via WindowManager.LayoutParams.FLAG_LAYOUT_IN_OVERSCAN.
         */</span>
        <span class="token keyword">boolean</span> mOverscanRequested<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Set if the visibility of any views has changed.
         */</span>
        <span class="token keyword">boolean</span> mViewVisibilityChanged<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Set to true if a view has been scrolled.
         */</span>
        <span class="token keyword">boolean</span> mViewScrollChanged<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Set to true if a pointer event is currently being handled.
         */</span>
        <span class="token keyword">boolean</span> mHandlingPointerEvent<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Global to the view hierarchy used as a temporary for dealing with
         * x/y points in the transparent region computations.
         */</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mTransparentLocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Global to the view hierarchy used as a temporary for dealing with
         * x/y points in the ViewGroup.invalidateChild implementation.
         */</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mInvalidateChildLocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Global to the view hierarchy used as a temporary for dealing with
         * computing absolute on-screen location.
         */</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mTmpLocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Global to the view hierarchy used as a temporary for dealing with
         * x/y location when view is transformed.
         */</span>
        <span class="token keyword">final</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mTmpTransformLocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">float</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * The view tree observer used to dispatch global events like
         * layout, pre-draw, touch mode change, etc.
         */</span>
        <span class="token keyword">final</span> ViewTreeObserver mTreeObserver<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * A Canvas used by the view hierarchy to perform bitmap caching.
         */</span>
        Canvas mCanvas<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * The view root impl.
         */</span>
        <span class="token keyword">final</span> ViewRootImpl mViewRootImpl<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * A Handler supplied by a view's {@link android.view.ViewRootImpl}. This
         * handler can be used to pump events in the UI events queue.
         */</span>
        <span class="token keyword">final</span> Handler mHandler<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Temporary for use in computing invalidate rectangles while
         * calling up the hierarchy.
         */</span>
        <span class="token keyword">final</span> Rect mTmpInvalRect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Temporary for use in computing hit areas with transformed views
         */</span>
        <span class="token keyword">final</span> RectF mTmpTransformRect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RectF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Temporary for use in computing hit areas with transformed views
         */</span>
        <span class="token keyword">final</span> RectF mTmpTransformRect1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RectF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Temporary list of rectanges.
         */</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>RectF<span class="token operator">></span> mTmpRectList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Temporary for use in transforming invalidation rect
         */</span>
        <span class="token keyword">final</span> Matrix mTmpMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Temporary for use in transforming invalidation rect
         */</span>
        <span class="token keyword">final</span> Transformation mTmpTransformation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Temporary for use in querying outlines from OutlineProviders
         */</span>
        <span class="token keyword">final</span> Outline mTmpOutline <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Outline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Temporary list for use in collecting focusable descendents of a view.
         */</span>
        <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>View<span class="token operator">></span> mTempArrayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>View<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * The id of the window for accessibility purposes.
         */</span>
        <span class="token keyword">int</span> mAccessibilityWindowId <span class="token operator">=</span> AccessibilityWindowInfo<span class="token punctuation">.</span>UNDEFINED_WINDOW_ID<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Flags related to accessibility processing.
         *
         * @see AccessibilityNodeInfo#FLAG_INCLUDE_NOT_IMPORTANT_VIEWS
         * @see AccessibilityNodeInfo#FLAG_REPORT_VIEW_IDS
         */</span>
        <span class="token keyword">int</span> mAccessibilityFetchFlags<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * The drawable for highlighting accessibility focus.
         */</span>
        Drawable mAccessibilityFocusDrawable<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * The drawable for highlighting autofilled views.
         *
         * @see #isAutofilled()
         */</span>
        Drawable mAutofilledDrawable<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Show where the margins, bounds and layout bounds are for each view.
         */</span>
        <span class="token keyword">boolean</span> mDebugLayout <span class="token operator">=</span> SystemProperties<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>DEBUG_LAYOUT_PROPERTY<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Point used to compute visible regions.
         */</span>
        <span class="token keyword">final</span> Point mPoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Used to track which View originated a requestLayout() call, used when
         * requestLayout() is called during layout.
         */</span>
        View mViewRequestingLayout<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Used to track views that need (at least) a partial relayout at their current size
         * during the next traversal.
         */</span>
        List<span class="token operator">&lt;</span>View<span class="token operator">></span> mPartialLayoutViews <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Swapped with mPartialLayoutViews during layout to avoid concurrent
         * modification. Lazily assigned during ViewRootImpl layout.
         */</span>
        List<span class="token operator">&lt;</span>View<span class="token operator">></span> mEmptyPartialLayoutViews<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Used to track the identity of the current drag operation.
         */</span>
        IBinder mDragToken<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * The drag shadow surface for the current drag operation.
         */</span>
        <span class="token keyword">public</span> Surface mDragSurface<span class="token punctuation">;</span>


        <span class="token comment" spellcheck="true">/**
         * The view that currently has a tooltip displayed.
         */</span>
        View mTooltipHost<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * Creates a new set of attachment information with the specified
         * events handler and thread.
         *
         * @param handler the events handler the view must use
         */</span>
        <span class="token function">AttachInfo</span><span class="token punctuation">(</span>IWindowSession session<span class="token punctuation">,</span> IWindow window<span class="token punctuation">,</span> Display display<span class="token punctuation">,</span>
                ViewRootImpl viewRootImpl<span class="token punctuation">,</span> Handler handler<span class="token punctuation">,</span> Callbacks effectPlayer<span class="token punctuation">,</span>
                Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSession <span class="token operator">=</span> session<span class="token punctuation">;</span>
            mWindow <span class="token operator">=</span> window<span class="token punctuation">;</span>
            mWindowToken <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mDisplay <span class="token operator">=</span> display<span class="token punctuation">;</span>
            mViewRootImpl <span class="token operator">=</span> viewRootImpl<span class="token punctuation">;</span>
            mHandler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
            mRootCallbacks <span class="token operator">=</span> effectPlayer<span class="token punctuation">;</span>
            mTreeObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewTreeObserver</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>AttachInfo实际上就是整个Android Framework在进行View绘制流程中绑定的一个全局的信息。它决定了整个Android整个View 树该怎么渲染。<br>下面介绍一下核心的属性：</p>
<ul>
<li>1.Callbacks 内部接口，实现者是ViewRootImpl，能发出一些简单的按键声响</li>
<li>2.InvalidateInfo 内部类。这个类记录了整个View树哪一部分是脏区，需要进行刷新的部分。</li>
<li>3.IWindowSession mSession 一个WindowSession对象，联通了IMS，WMS等服务。是一个面向服务的门面操作者。</li>
<li>4.IWindow mWindow 对应WMS的客户端，也就是一个跨进程通信的Window对象</li>
<li>5.IBinder mWindowToken 当前AttachInfo对应Window的Token。这个句柄会在WMS有对应的记录。</li>
<li>6.Display mDisplay 通过DisplayManager获取的对象，里面记录了屏幕属性。</li>
<li>7.View mRootView 整个View树的根布局</li>
<li>8.boolean mHardwareAccelerated 是否需要硬件加速</li>
<li>9.ThreadedRenderer mThreadedRenderer 硬件渲染的核心对象</li>
<li>10.mDisplayState 当前屏幕的状态，如果状态发生了变更，ViewRootImpl也同时需要变更。</li>
<li>11.mApplicationScale 根据Display对象来判断，当前的View绘制过程中是否需要进行放大。</li>
<li>12.mWindowLeft等 当前AttachInfo对应的View所对应的Window的坐标</li>
<li>13.mUse32BitDrawingCache 绘制是否使用32位缓存</li>
<li>14.mOverscanInsets，mContentInsets，mVisibleInsets 等Insect，这些就是之前WMS第四篇文章聊过的，过扫描区域，内容区域，可视区域等</li>
<li>15.boolean mAlwaysConsumeNavBar 这个标志位一半是多窗口显示的时候告诉Android系统不需要一直显示导航栏</li>
<li>16.mScrollContainers 那些可以滚动的View，或者可以因为软键盘变化平移的View</li>
<li>17.mHasWindowFocus 该窗口是否有焦点</li>
<li>18.mInTouchMode 该View是否是touch mode</li>
<li>19.mKeepScreenOn 刷新的时候，是否保持屏幕点亮</li>
<li>20.mSystemUiVisibility 系统的ui如statusBar等是否显示</li>
<li>21.ViewTreeObserver mTreeObserver 监听View树的绘制</li>
<li>22.Canvas mCanvas; 用于View 树的bitmap的缓存</li>
</ul>
<p>差不多这些就够了。能看到这些所有的信息都是View在绘制流程中需要注意的。</p>
<h2 id="ViewRootImpl-setView"><a href="#ViewRootImpl-setView" class="headerlink" title="ViewRootImpl setView"></a>ViewRootImpl setView</h2><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/ViewRootImpl.java" target="_blank" rel="noopener">ViewRootImpl.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setView</span><span class="token punctuation">(</span>View view<span class="token punctuation">,</span> WindowManager<span class="token punctuation">.</span>LayoutParams attrs<span class="token punctuation">,</span> View panelParentView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mView <span class="token operator">=</span> view<span class="token punctuation">;</span>

                mAttachInfo<span class="token punctuation">.</span>mDisplayState <span class="token operator">=</span> mDisplay<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mDisplayManager<span class="token punctuation">.</span><span class="token function">registerDisplayListener</span><span class="token punctuation">(</span>mDisplayListener<span class="token punctuation">,</span> mHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

                mViewLayoutDirectionInitial <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getRawLayoutDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mFallbackEventHandler<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mWindowAttributes<span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mWindowAttributes<span class="token punctuation">.</span>packageName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mWindowAttributes<span class="token punctuation">.</span>packageName <span class="token operator">=</span> mBasePackageName<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                attrs <span class="token operator">=</span> mWindowAttributes<span class="token punctuation">;</span>
                <span class="token function">setTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


                <span class="token comment" spellcheck="true">// Keep track of the actual window flags supplied by the client.</span>
                mClientWindowLayoutFlags <span class="token operator">=</span> attrs<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>

                <span class="token function">setAccessibilityFocus</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token keyword">instanceof</span> <span class="token class-name">RootViewSurfaceTaker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mSurfaceHolderCallback <span class="token operator">=</span>
                            <span class="token punctuation">(</span><span class="token punctuation">(</span>RootViewSurfaceTaker<span class="token punctuation">)</span>view<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">willYouTakeTheSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mSurfaceHolderCallback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mSurfaceHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TakenSurfaceHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mSurfaceHolder<span class="token punctuation">.</span><span class="token function">setFormat</span><span class="token punctuation">(</span>PixelFormat<span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mSurfaceHolder<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>mSurfaceHolderCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// Compute surface insets required to draw at specified Z value.</span>
                <span class="token comment" spellcheck="true">// TODO: Use real shadow insets for a constant max Z.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>attrs<span class="token punctuation">.</span>hasManualSurfaceInsets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    attrs<span class="token punctuation">.</span><span class="token function">setSurfaceInsets</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*manual*/</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*preservePrevious*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                CompatibilityInfo compatibilityInfo <span class="token operator">=</span>
                        mDisplay<span class="token punctuation">.</span><span class="token function">getDisplayAdjustments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCompatibilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mTranslator <span class="token operator">=</span> compatibilityInfo<span class="token punctuation">.</span><span class="token function">getTranslator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// If the application owns the surface, don't enable hardware acceleration</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mSurfaceHolder <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// While this is supposed to enable only, it can effectively disable</span>
                    <span class="token comment" spellcheck="true">// the acceleration too.</span>
                    <span class="token function">enableHardwareAcceleration</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token keyword">boolean</span> useMTRenderer <span class="token operator">=</span> MT_RENDERER_AVAILABLE
                            <span class="token operator">&amp;&amp;</span> mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer <span class="token operator">!=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mUseMTRenderer <span class="token operator">!=</span> useMTRenderer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Shouldn't be resizing, as it's done only in window setup,</span>
                        <span class="token comment" spellcheck="true">// but end just in case.</span>
                        <span class="token function">endDragResizing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mUseMTRenderer <span class="token operator">=</span> useMTRenderer<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">boolean</span> restore <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mTranslator <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mSurface<span class="token punctuation">.</span><span class="token function">setCompatibilityTranslator</span><span class="token punctuation">(</span>mTranslator<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    restore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    attrs<span class="token punctuation">.</span><span class="token function">backup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mTranslator<span class="token punctuation">.</span><span class="token function">translateWindowLayout</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>compatibilityInfo<span class="token punctuation">.</span><span class="token function">supportsScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    attrs<span class="token punctuation">.</span>privateFlags <span class="token operator">|=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>PRIVATE_FLAG_COMPATIBLE_WINDOW<span class="token punctuation">;</span>
                    mLastInCompatMode <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                mSoftInputMode <span class="token operator">=</span> attrs<span class="token punctuation">.</span>softInputMode<span class="token punctuation">;</span>
                mWindowAttributesChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                mWindowAttributesChangesFlag <span class="token operator">=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>EVERYTHING_CHANGED<span class="token punctuation">;</span>
                mAttachInfo<span class="token punctuation">.</span>mRootView <span class="token operator">=</span> view<span class="token punctuation">;</span>
                mAttachInfo<span class="token punctuation">.</span>mScalingRequired <span class="token operator">=</span> mTranslator <span class="token operator">!=</span> null<span class="token punctuation">;</span>
                mAttachInfo<span class="token punctuation">.</span>mApplicationScale <span class="token operator">=</span>
                        mTranslator <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">1.0f</span> <span class="token operator">:</span> mTranslator<span class="token punctuation">.</span>applicationScale<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>panelParentView <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAttachInfo<span class="token punctuation">.</span>mPanelParentWindowToken
                            <span class="token operator">=</span> panelParentView<span class="token punctuation">.</span><span class="token function">getApplicationWindowToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> res<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* = WindowManagerImpl.ADD_OKAY; */</span>

                <span class="token comment" spellcheck="true">// Schedule the first layout -before- adding to the window</span>
                <span class="token comment" spellcheck="true">// manager, to make sure we do the relayout before receiving</span>
                <span class="token comment" spellcheck="true">// any other events from the system.</span>
                <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mWindowAttributes<span class="token punctuation">.</span>inputFeatures
                        <span class="token operator">&amp;</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>INPUT_FEATURE_NO_INPUT_CHANNEL<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mInputChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mForceDecorViewVisibility <span class="token operator">=</span> <span class="token punctuation">(</span>mWindowAttributes<span class="token punctuation">.</span>privateFlags
                        <span class="token operator">&amp;</span> PRIVATE_FLAG_FORCE_DECOR_VIEW_VISIBILITY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mOrigWindowType <span class="token operator">=</span> mWindowAttributes<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
                    mAttachInfo<span class="token punctuation">.</span>mRecomputeGlobalAttributes <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token function">collectViewAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    res <span class="token operator">=</span> mWindowSession<span class="token punctuation">.</span><span class="token function">addToDisplay</span><span class="token punctuation">(</span>mWindow<span class="token punctuation">,</span> mSeq<span class="token punctuation">,</span> mWindowAttributes<span class="token punctuation">,</span>
                            <span class="token function">getHostVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mDisplay<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mWinFrame<span class="token punctuation">,</span>
                            mAttachInfo<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">,</span>
                            mAttachInfo<span class="token punctuation">.</span>mOutsets<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">,</span> mInputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    mView <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    mAttachInfo<span class="token punctuation">.</span>mRootView <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    mInputChannel <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    mFallbackEventHandler<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">unscheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setAccessibilityFocus</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Adding window failed"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>restore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        attrs<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mTranslator <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mTranslator<span class="token punctuation">.</span><span class="token function">translateRectInScreenToAppWindow</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mPendingOverscanInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mPendingContentInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mPendingStableInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mPendingDisplayCutout<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mPendingVisibleInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAttachInfo<span class="token punctuation">.</span>mAlwaysConsumeNavBar <span class="token operator">=</span>
                        <span class="token punctuation">(</span>res <span class="token operator">&amp;</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_FLAG_ALWAYS_CONSUME_NAV_BAR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                mPendingAlwaysConsumeNavBar <span class="token operator">=</span> mAttachInfo<span class="token punctuation">.</span>mAlwaysConsumeNavBar<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_OKAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAttachInfo<span class="token punctuation">.</span>mRootView <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    mAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    mFallbackEventHandler<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">unscheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setAccessibilityFocus</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token keyword">instanceof</span> <span class="token class-name">RootViewSurfaceTaker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mInputQueueCallback <span class="token operator">=</span>
                        <span class="token punctuation">(</span><span class="token punctuation">(</span>RootViewSurfaceTaker<span class="token punctuation">)</span>view<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">willYouTakeTheInputQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mInputChannel <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mInputQueueCallback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mInputQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mInputQueueCallback<span class="token punctuation">.</span><span class="token function">onInputQueueCreated</span><span class="token punctuation">(</span>mInputQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mInputEventReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowInputEventReceiver</span><span class="token punctuation">(</span>mInputChannel<span class="token punctuation">,</span>
                            Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                view<span class="token punctuation">.</span><span class="token function">assignParent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAddedTouchMode <span class="token operator">=</span> <span class="token punctuation">(</span>res <span class="token operator">&amp;</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_FLAG_IN_TOUCH_MODE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                mAppVisible <span class="token operator">=</span> <span class="token punctuation">(</span>res <span class="token operator">&amp;</span> WindowManagerGlobal<span class="token punctuation">.</span>ADD_FLAG_APP_VISIBLE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mAccessibilityManager<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAccessibilityInteractionConnectionManager<span class="token punctuation">.</span><span class="token function">ensureConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getImportantForAccessibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> View<span class="token punctuation">.</span>IMPORTANT_FOR_ACCESSIBILITY_AUTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    view<span class="token punctuation">.</span><span class="token function">setImportantForAccessibility</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>IMPORTANT_FOR_ACCESSIBILITY_YES<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// Set up the input pipeline.</span>
                CharSequence counterSuffix <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mSyntheticInputStage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyntheticInputStage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                InputStage viewPostImeStage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewPostImeInputStage</span><span class="token punctuation">(</span>mSyntheticInputStage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                InputStage nativePostImeStage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativePostImeInputStage</span><span class="token punctuation">(</span>viewPostImeStage<span class="token punctuation">,</span>
                        <span class="token string">"aq:native-post-ime:"</span> <span class="token operator">+</span> counterSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
                InputStage earlyPostImeStage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EarlyPostImeInputStage</span><span class="token punctuation">(</span>nativePostImeStage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                InputStage imeStage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImeInputStage</span><span class="token punctuation">(</span>earlyPostImeStage<span class="token punctuation">,</span>
                        <span class="token string">"aq:ime:"</span> <span class="token operator">+</span> counterSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
                InputStage viewPreImeStage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewPreImeInputStage</span><span class="token punctuation">(</span>imeStage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                InputStage nativePreImeStage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativePreImeInputStage</span><span class="token punctuation">(</span>viewPreImeStage<span class="token punctuation">,</span>
                        <span class="token string">"aq:native-pre-ime:"</span> <span class="token operator">+</span> counterSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>

                mFirstInputStage <span class="token operator">=</span> nativePreImeStage<span class="token punctuation">;</span>
                mFirstPostImeInputStage <span class="token operator">=</span> earlyPostImeStage<span class="token punctuation">;</span>
                mPendingInputEventQueueLengthCounterName <span class="token operator">=</span> <span class="token string">"aq:pending:"</span> <span class="token operator">+</span> counterSuffix<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面完成的事情，除去性能跟踪的逻辑，如下三件大事情，源码分散开了，这里统筹起来：</p>
<ul>
<li><p>1.根据当前从DisplayManager获取到的Display的状态，绑定到AttachInfo中。并且把ViewRootImpl的Handler注册到DisplayManager中监听回调。从Display中获取当前屏幕的兼容信息，并获取坐标转化器。如果获取到，说明此时需要屏幕中的内容需要进行缩放。最后把这些信息都存放到AttachInfo中的mApplicationScale，并在AttachInfo记录根部View(DecorView)</p>
</li>
<li><p>2.根据传递的WindowManager.LayoutParams设置软键盘模式，并调用requestLayout触发下一轮的View 树的遍历。接着调用WindowSession的addToDisplay方法，把当前的Window添加到WMS的服务上进行处理。并从addToDisplay获取到的几个如mContentInsets，记录在mAttachInfo以及ViewRootImpl中。</p>
</li>
<li><p>3.清空AccessibilityService(Android的无障碍服务)的焦点。并且校验服务是否还在链接监听中。</p>
</li>
<li><p>4.如果还没有InputChannel，则创建一个InputChannel，并且进行点击事件的监听。这个对象就是通过socket监听IMS服务发送的点击事件，最后传递到我们的Activity中。关于这个对象的设计，我们暂时不去深究，后面会有专门的IMS的源码解析专题。</p>
</li>
</ul>
<p>在这几个中，最重要的是第二点。它承载了核心的View的树的构建与遍历逻辑。关于addToDisplay方法的详细解析可以看看我写的<a href="https://www.jianshu.com/p/157e8bbfa45a" target="_blank" rel="noopener">WMS在Activity启动中的职责 添加窗体(三)</a>。<br>接下来我们顺着requestLayout看看究竟做了什么。</p>
<h2 id="requestLayout-请求下一次的View树遍历"><a href="#requestLayout-请求下一次的View树遍历" class="headerlink" title="requestLayout 请求下一次的View树遍历"></a>requestLayout 请求下一次的View树遍历</h2><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHandlingLayoutInLayoutRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mLayoutRequested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">scheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">checkThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mThread <span class="token operator">!=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CalledFromWrongThreadException</span><span class="token punctuation">(</span>
                    <span class="token string">"Only the original thread that created a view hierarchy can touch its views."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们就能看到这个过程中，就能看到为什么异步调用requestLayout方法就爆异常。在每一次调用requestLayout都会调用checkThread进行一次是否是主线程调用的。</p>
<p>如果正在走onLayout的方法，mHandlingLayoutInLayoutRequest的标志位为true，禁止调用requestLayout。如果调用了requestlayout之后，mLayoutRequested就会设置为true。最后调用scheduleTraversals，进行Handler下一个Looper的处理View树的遍历和绘制。</p>
<h2 id="scheduleTraversals"><a href="#scheduleTraversals" class="headerlink" title="scheduleTraversals"></a>scheduleTraversals</h2><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">scheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTraversalScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTraversalScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mTraversalBarrier <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postSyncBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mChoreographer<span class="token punctuation">.</span><span class="token function">postCallback</span><span class="token punctuation">(</span>
                    Choreographer<span class="token punctuation">.</span>CALLBACK_TRAVERSAL<span class="token punctuation">,</span> mTraversalRunnable<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mUnbufferedInputDispatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">scheduleConsumeBatchedInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">notifyRendererOfFramePending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pokeDrawLockIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.首先把mTraversalScheduled设置为true。接下来会调用postSyncBarrier方法设置同步屏障。关于这个方法，我在<a href="https://www.jianshu.com/p/416de2a3a1d6" target="_blank" rel="noopener">Handler与相关系统调用的剖析(上)</a>一文中有提到过。</p>
</li>
<li><p>2.通过mChoreographer的postCallback方法发送一个CALLBACK_TRAVERSAL，监听Vsync信号的到来，接着执行mTraversalRunnable这个runnable方法。关于这一段的原理，可以看我写的<a href="https://www.jianshu.com/p/82c0556e9c76" target="_blank" rel="noopener">Vsync同步信号原理</a>一文有详细的讲解流程。</p>
</li>
<li><p>3.scheduleConsumeBatchedInput 处理没有处理完的按键消息发送</p>
</li>
<li><p>4.notifyRendererOfFramePending 通知硬件渲染机制，尝试进行当前的状态进行动画绘制。</p>
</li>
<li><p>5.pokeDrawLockIfNeeded 如果发现当前屏幕的状态出于休眠低消耗doze状态，则会通过PowerManager.WakeLock强制点亮屏幕(通过WMS查询当前Window 对应的WindowState，在这里面有一个点亮屏幕的对象)。</p>
</li>
</ul>
<p>关键还是View 树的遍历绘制流程，为了可以彻底的理解这个过程，我们看看Handler的同步屏障运作原理。</p>
<h4 id="Handler-同步屏障的原理解析"><a href="#Handler-同步屏障的原理解析" class="headerlink" title="Handler 同步屏障的原理解析"></a>Handler 同步屏障的原理解析</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/" target="_blank" rel="noopener">os</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/MessageQueue.java" target="_blank" rel="noopener">MessageQueue.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">postSyncBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">postSyncBarrier</span><span class="token punctuation">(</span>SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">postSyncBarrier</span><span class="token punctuation">(</span><span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> token <span class="token operator">=</span> mNextBarrierToken<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Message msg <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">markInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>when <span class="token operator">=</span> when<span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> token<span class="token punctuation">;</span>

            Message prev <span class="token operator">=</span> null<span class="token punctuation">;</span>
            Message p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>when <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>when <span class="token operator">&lt;=</span> when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
                    p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// invariant: p == prev.next</span>
                msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
                prev<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
                mMessages <span class="token operator">=</span> msg<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> token<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个方法实际上很简单，就是把一个记录为当前时刻的msg插入到mMessages链表中。当然这种同步屏障消息和普通的消息最大的区别，我们可以回到普通方法的入队看看做了什么：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/" target="_blank" rel="noopener">os</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/Handler.java" target="_blank" rel="noopener">Handler.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>MessageQueue queue<span class="token punctuation">,</span> Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msg<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAsynchronous<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> queue<span class="token punctuation">.</span><span class="token function">enqueueMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上，每一个从Handler入队的消息，target都是指向Handler，其目的就是为了回调到Handler的回调中。而最大区别就是这里，普通的消息设置了target，而消息屏障的消息则没有设置target。</p>
<p>当Looper被唤醒的时候，会调用Looper的loop方法中 Message.next的进行msg的遍历，会执行如下片段：</p>
<pre class="line-numbers language-java"><code class="language-java">                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>target <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span>
                    <span class="token keyword">do</span> <span class="token punctuation">{</span>
                        prevMsg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
                        msg <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个代码中，判断到msg.target为null就走进来。接下来优先执行打开了isAsynchronous 异步标志的Handler信息。把其他消息执行向后挪动。那么我们可以猜测接下去的handler遍历View树并绘制的消息是一个异步消息。</p>
<p>我们回过头来看看下面这个方法。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/ViewRootImpl.java" target="_blank" rel="noopener">ViewRootImpl.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">            mChoreographer<span class="token punctuation">.</span><span class="token function">postCallback</span><span class="token punctuation">(</span>
                    Choreographer<span class="token punctuation">.</span>CALLBACK_TRAVERSAL<span class="token punctuation">,</span> mTraversalRunnable<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>mChoreographer中的postCallback这个方法根据我之前写的文章最终会调用到FrameDisplayEventReceiver.onVsync中。并在这个回调中通过Handler在doFrame方法调用mTraversalRunnable的run方法。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onVsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestampNanos<span class="token punctuation">,</span> <span class="token keyword">int</span> builtInDisplayId<span class="token punctuation">,</span> <span class="token keyword">int</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mTimestampNanos <span class="token operator">=</span> timestampNanos<span class="token punctuation">;</span>
            mFrame <span class="token operator">=</span> frame<span class="token punctuation">;</span>
            Message msg <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> timestampNanos <span class="token operator">/</span> TimeUtils<span class="token punctuation">.</span>NANOS_PER_MS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到接受了Vsync信号回调后的Message，就是一个Asynchronous异步消息。能够在同步屏障内执行。</p>
<pre class="line-numbers language-java"><code class="language-java">            AnimationUtils<span class="token punctuation">.</span><span class="token function">lockAnimationClock</span><span class="token punctuation">(</span>frameTimeNanos <span class="token operator">/</span> TimeUtils<span class="token punctuation">.</span>NANOS_PER_MS<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mFrameInfo<span class="token punctuation">.</span><span class="token function">markInputHandlingStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doCallbacks</span><span class="token punctuation">(</span>Choreographer<span class="token punctuation">.</span>CALLBACK_INPUT<span class="token punctuation">,</span> frameTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mFrameInfo<span class="token punctuation">.</span><span class="token function">markAnimationsStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doCallbacks</span><span class="token punctuation">(</span>Choreographer<span class="token punctuation">.</span>CALLBACK_ANIMATION<span class="token punctuation">,</span> frameTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mFrameInfo<span class="token punctuation">.</span><span class="token function">markPerformTraversalsStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doCallbacks</span><span class="token punctuation">(</span>Choreographer<span class="token punctuation">.</span>CALLBACK_TRAVERSAL<span class="token punctuation">,</span> frameTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">doCallbacks</span><span class="token punctuation">(</span>Choreographer<span class="token punctuation">.</span>CALLBACK_COMMIT<span class="token punctuation">,</span> frameTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到Choreographer.CALLBACK_TRAVERSAL这种消息是倒数第二个执行的顺序，并在doCallbacks中执行了mTraversalRunnable方法。</p>
<p>其实这就是Android是如何把View的绘制消息尽可能的提高消息处理的优先级原理。其原理和flutter的绘制机制十分相似。既然知道mTraversalRunnable是如何执行的,我们看看runnable内部做了什么。</p>
<h3 id="TraversalRunnable"><a href="#TraversalRunnable" class="headerlink" title="TraversalRunnable"></a>TraversalRunnable</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TraversalRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">doTraversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">doTraversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTraversalScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTraversalScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeSyncBarrier</span><span class="token punctuation">(</span>mTraversalBarrier<span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token function">performTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mProfile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Debug<span class="token punctuation">.</span><span class="token function">stopMethodTracing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mProfile <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，在这个过程中首先通过removeSyncBarrier移除了mTraversalBarrier这个同步屏障。这样就能继续执行Handler的接下来的消息。但是这个时候还在Handler的执行的一个方法中，所以并不会被其他消息打断View树的绘制优先级。</p>
<p>接下来就是整个View树的绘制核心，performTraversals。</p>
<h2 id="performTraversals"><a href="#performTraversals" class="headerlink" title="performTraversals"></a>performTraversals</h2><p>这个方法十分长，这里我们把它分为4大部分，绘制准备，onAttachWindow绑定窗口,onApplyWindowInsets分发窗体间距,准备硬件渲染Surface,onMeasure，onLayout，onDraw。</p>
<h3 id="绘制准备onAttachWindow"><a href="#绘制准备onAttachWindow" class="headerlink" title="绘制准备onAttachWindow"></a>绘制准备onAttachWindow</h3><p>接下来，我这边先抛开硬件渲染的流程，集中理解软件渲染的流程。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// cache mView since it is used so much below...</span>
        <span class="token keyword">final</span> View host <span class="token operator">=</span> mView<span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>host <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>mAdded<span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>

        mIsInTraversal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        mWillDrawSoon <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> windowSizeMayChange <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> newSurface <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> surfaceChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        WindowManager<span class="token punctuation">.</span>LayoutParams lp <span class="token operator">=</span> mWindowAttributes<span class="token punctuation">;</span>

        <span class="token keyword">int</span> desiredWindowWidth<span class="token punctuation">;</span>
        <span class="token keyword">int</span> desiredWindowHeight<span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> viewVisibility <span class="token operator">=</span> <span class="token function">getHostVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> viewVisibilityChanged <span class="token operator">=</span> <span class="token operator">!</span>mFirst
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mViewVisibility <span class="token operator">!=</span> viewVisibility <span class="token operator">||</span> mNewSurfaceNeeded

                <span class="token operator">||</span> mAppVisibilityChanged<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mAppVisibilityChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> viewUserVisibilityChanged <span class="token operator">=</span> <span class="token operator">!</span>mFirst <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>mViewVisibility <span class="token operator">==</span> View<span class="token punctuation">.</span>VISIBLE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>viewVisibility <span class="token operator">==</span> View<span class="token punctuation">.</span>VISIBLE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        WindowManager<span class="token punctuation">.</span>LayoutParams params <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mWindowAttributesChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mWindowAttributesChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            surfaceChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            params <span class="token operator">=</span> lp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        CompatibilityInfo compatibilityInfo <span class="token operator">=</span>
                mDisplay<span class="token punctuation">.</span><span class="token function">getDisplayAdjustments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCompatibilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>compatibilityInfo<span class="token punctuation">.</span><span class="token function">supportsScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> mLastInCompatMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            params <span class="token operator">=</span> lp<span class="token punctuation">;</span>
            mFullRedrawNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mLayoutRequested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLastInCompatMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                params<span class="token punctuation">.</span>privateFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>PRIVATE_FLAG_COMPATIBLE_WINDOW<span class="token punctuation">;</span>
                mLastInCompatMode <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                params<span class="token punctuation">.</span>privateFlags <span class="token operator">|=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>PRIVATE_FLAG_COMPATIBLE_WINDOW<span class="token punctuation">;</span>
                mLastInCompatMode <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mWindowAttributesChangesFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        Rect frame <span class="token operator">=</span> mWinFrame<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mFirst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mFullRedrawNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mLayoutRequested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> Configuration config <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldUseDisplaySize</span><span class="token punctuation">(</span>lp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// NOTE -- system code, won't try to do compat mode.</span>
                Point size <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mDisplay<span class="token punctuation">.</span><span class="token function">getRealSize</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                desiredWindowWidth <span class="token operator">=</span> size<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                desiredWindowHeight <span class="token operator">=</span> size<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                desiredWindowWidth <span class="token operator">=</span> mWinFrame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                desiredWindowHeight <span class="token operator">=</span> mWinFrame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mAttachInfo<span class="token punctuation">.</span>mUse32BitDrawingCache <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mAttachInfo<span class="token punctuation">.</span>mHasWindowFocus <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mAttachInfo<span class="token punctuation">.</span>mWindowVisibility <span class="token operator">=</span> viewVisibility<span class="token punctuation">;</span>
            mAttachInfo<span class="token punctuation">.</span>mRecomputeGlobalAttributes <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mLastConfigurationFromResources<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mLastSystemUiVisibility <span class="token operator">=</span> mAttachInfo<span class="token punctuation">.</span>mSystemUiVisibility<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mViewLayoutDirectionInitial <span class="token operator">==</span> View<span class="token punctuation">.</span>LAYOUT_DIRECTION_INHERIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                host<span class="token punctuation">.</span><span class="token function">setLayoutDirection</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getLayoutDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            host<span class="token punctuation">.</span><span class="token function">dispatchAttachedToWindow</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mAttachInfo<span class="token punctuation">.</span>mTreeObserver<span class="token punctuation">.</span><span class="token function">dispatchOnWindowAttachedChange</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">dispatchApplyInsets</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            desiredWindowWidth <span class="token operator">=</span> frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            desiredWindowHeight <span class="token operator">=</span> frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>desiredWindowWidth <span class="token operator">!=</span> mWidth <span class="token operator">||</span> desiredWindowHeight <span class="token operator">!=</span> mHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mFullRedrawNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                mLayoutRequested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                windowSizeMayChange <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>viewVisibilityChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAttachInfo<span class="token punctuation">.</span>mWindowVisibility <span class="token operator">=</span> viewVisibility<span class="token punctuation">;</span>
            host<span class="token punctuation">.</span><span class="token function">dispatchWindowVisibilityChanged</span><span class="token punctuation">(</span>viewVisibility<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>viewUserVisibilityChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                host<span class="token punctuation">.</span><span class="token function">dispatchVisibilityAggregated</span><span class="token punctuation">(</span>viewVisibility <span class="token operator">==</span> View<span class="token punctuation">.</span>VISIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>viewVisibility <span class="token operator">!=</span> View<span class="token punctuation">.</span>VISIBLE <span class="token operator">||</span> mNewSurfaceNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">endDragResizing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">destroyHardwareResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>viewVisibility <span class="token operator">==</span> View<span class="token punctuation">.</span>GONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mHasHadWindowFocus <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mWindowVisibility <span class="token operator">!=</span> View<span class="token punctuation">.</span>VISIBLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            host<span class="token punctuation">.</span><span class="token function">clearAccessibilityFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中，我们可以把情况分为2种，第一种ViewRootImpl首次渲染，第二种ViewRootImpl非首次渲染。</p>
<p>首次渲染可以分为如下几个步骤：</p>
<ul>
<li><p>1.如果通过shouldUseDisplaySize判断到此时是System的ui，如statusbar，音量等，就会设置desiredWindowWidth和desiredWindowHeight为屏幕的宽高。</p>
</li>
<li><p>2.如果不是System的ui，则设置从Session.addToDislpay中获取到的mWindowFrame设置为屏幕的当前准备渲染的宽高。</p>
</li>
<li><p>3.setLayoutDirection，设置整个View树的渲染方向。如果对海外开发熟悉的朋友应该知道marginStart和marginLeft之前的区别。前者可以根据地域的阅读喜欢设定如文字是从左到右还是从右到左的渲染。</p>
</li>
<li><p>4.调用dispatchAttachedToWindow 分发从当前的根部View(DecorView)开始，往下进行onAttachWindow的方法。</p>
</li>
</ul>
<p>如果非首次渲染：<br>步骤就简单很多了：</p>
<ul>
<li>1.直接设置了desiredWindowWidth和desiredWindowHeight为mWindowFrame的宽高。</li>
<li>2.此时会直接判断DecorView是否还可见，如果可见则回调从根部DecorView分发下去的dispatchWindowVisibilityChanged的方法改变Window的可见性。</li>
</ul>
<p>如果不可见，则清空无障碍服务的焦点。</p>
<p>在这个准备流程中，值得注意的点有三点：</p>
<ul>
<li>1.mWindowFrame 是如何计算出来的，和屏幕宽高有什么差距</li>
<li>2.首次渲染调用的dispatchAttachedToWindow，分发AttachInfo做了什么行为。</li>
<li>3.dispatchWindowVisibilityChanged分发了什么事件。</li>
</ul>
<p>让我们一一来解析一边。</p>
<h4 id="addToDisplay-初步计算屏幕区域"><a href="#addToDisplay-初步计算屏幕区域" class="headerlink" title="addToDisplay 初步计算屏幕区域"></a>addToDisplay 初步计算屏幕区域</h4><p>关于这个函数，我在<a href="https://www.jianshu.com/p/157e8bbfa45a" target="_blank" rel="noopener">WMS在Activity启动中的职责 添加窗体</a>一文中，我已经剖析过了这个函数是如何把第一次渲染的Window添加到WMS中进行管理的。</p>
<p>这一次，我们把目光放在addToDisplay中的初步计算区域的方法PhoneWindowManager.getLayoutHintLw。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/" target="_blank" rel="noopener">com</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/" target="_blank" rel="noopener">server</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/policy/" target="_blank" rel="noopener">policy</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/policy/PhoneWindowManager.java" target="_blank" rel="noopener">PhoneWindowManager.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getLayoutHintLw</span><span class="token punctuation">(</span>WindowManager<span class="token punctuation">.</span>LayoutParams attrs<span class="token punctuation">,</span> Rect taskBounds<span class="token punctuation">,</span>
            DisplayFrames displayFrames<span class="token punctuation">,</span> Rect outFrame<span class="token punctuation">,</span> Rect outContentInsets<span class="token punctuation">,</span> Rect outStableInsets<span class="token punctuation">,</span>
            Rect outOutsets<span class="token punctuation">,</span> DisplayCutout<span class="token punctuation">.</span>ParcelableWrapper outDisplayCutout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> fl <span class="token operator">=</span> PolicyControl<span class="token punctuation">.</span><span class="token function">getWindowFlags</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> pfl <span class="token operator">=</span> attrs<span class="token punctuation">.</span>privateFlags<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> requestedSysUiVis <span class="token operator">=</span> PolicyControl<span class="token punctuation">.</span><span class="token function">getSystemUiVisibility</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> sysUiVis <span class="token operator">=</span> requestedSysUiVis <span class="token operator">|</span> <span class="token function">getImpliedSysUiFlagsForLayout</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> displayRotation <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mRotation<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> displayWidth <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mDisplayWidth<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> displayHeight <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mDisplayHeight<span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> useOutsets <span class="token operator">=</span> outOutsets <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">shouldUseOutsets</span><span class="token punctuation">(</span>attrs<span class="token punctuation">,</span> fl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>useOutsets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> outset <span class="token operator">=</span> ScreenShapeHelper<span class="token punctuation">.</span><span class="token function">getWindowOutsetBottomPx</span><span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>outset <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>displayRotation <span class="token operator">==</span> Surface<span class="token punctuation">.</span>ROTATION_0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    outOutsets<span class="token punctuation">.</span>bottom <span class="token operator">+=</span> outset<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>displayRotation <span class="token operator">==</span> Surface<span class="token punctuation">.</span>ROTATION_90<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    outOutsets<span class="token punctuation">.</span>right <span class="token operator">+=</span> outset<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>displayRotation <span class="token operator">==</span> Surface<span class="token punctuation">.</span>ROTATION_180<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    outOutsets<span class="token punctuation">.</span>top <span class="token operator">+=</span> outset<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>displayRotation <span class="token operator">==</span> Surface<span class="token punctuation">.</span>ROTATION_270<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    outOutsets<span class="token punctuation">.</span>left <span class="token operator">+=</span> outset<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> layoutInScreen <span class="token operator">=</span> <span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_LAYOUT_IN_SCREEN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> layoutInScreenAndInsetDecor <span class="token operator">=</span> layoutInScreen <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_LAYOUT_INSET_DECOR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> screenDecor <span class="token operator">=</span> <span class="token punctuation">(</span>pfl <span class="token operator">&amp;</span> PRIVATE_FLAG_IS_SCREEN_DECOR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>layoutInScreenAndInsetDecor <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>screenDecor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> availRight<span class="token punctuation">,</span> availBottom<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canHideNavigationBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span>sysUiVis <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                outFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                availRight <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
                availBottom <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                outFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
                availRight <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
                availBottom <span class="token operator">=</span> displayFrames<span class="token punctuation">.</span>mRestricted<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            outStableInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>left<span class="token punctuation">,</span> displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
                    availRight <span class="token operator">-</span> displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>right<span class="token punctuation">,</span>
                    availBottom <span class="token operator">-</span> displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sysUiVis <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_STABLE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_FULLSCREEN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    outContentInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStableFullscreen<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
                            displayFrames<span class="token punctuation">.</span>mStableFullscreen<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
                            availRight <span class="token operator">-</span> displayFrames<span class="token punctuation">.</span>mStableFullscreen<span class="token punctuation">.</span>right<span class="token punctuation">,</span>
                            availBottom <span class="token operator">-</span> displayFrames<span class="token punctuation">.</span>mStableFullscreen<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    outContentInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>outStableInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_FULLSCREEN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>fl <span class="token operator">&amp;</span> FLAG_LAYOUT_IN_OVERSCAN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                outContentInsets<span class="token punctuation">.</span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                outContentInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mCurrent<span class="token punctuation">.</span>left<span class="token punctuation">,</span> displayFrames<span class="token punctuation">.</span>mCurrent<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
                        availRight <span class="token operator">-</span> displayFrames<span class="token punctuation">.</span>mCurrent<span class="token punctuation">.</span>right<span class="token punctuation">,</span>
                        availBottom <span class="token operator">-</span> displayFrames<span class="token punctuation">.</span>mCurrent<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>taskBounds <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">calculateRelevantTaskInsets</span><span class="token punctuation">(</span>taskBounds<span class="token punctuation">,</span> outContentInsets<span class="token punctuation">,</span>
                        displayWidth<span class="token punctuation">,</span> displayHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">calculateRelevantTaskInsets</span><span class="token punctuation">(</span>taskBounds<span class="token punctuation">,</span> outStableInsets<span class="token punctuation">,</span>
                        displayWidth<span class="token punctuation">,</span> displayHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
                outFrame<span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span>taskBounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            outDisplayCutout<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">.</span><span class="token function">calculateRelativeTo</span><span class="token punctuation">(</span>outFrame<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getDisplayCutout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> mForceShowSystemBars<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>layoutInScreen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                outFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mUnrestricted<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                outFrame<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>displayFrames<span class="token punctuation">.</span>mStable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>taskBounds <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                outFrame<span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span>taskBounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            outContentInsets<span class="token punctuation">.</span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            outStableInsets<span class="token punctuation">.</span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            outDisplayCutout<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>DisplayCutout<span class="token punctuation">.</span>NO_CUTOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> mForceShowSystemBars<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面出现了<a href="https://www.jianshu.com/p/e83496ca788c" target="_blank" rel="noopener">计算窗体的大小</a>一文中出现过的几个参数。关于SystemUI几个标志位，这里有一篇文章写的挺全的<br><a href="https://www.jianshu.com/p/e27e7f09d1f7" target="_blank" rel="noopener">管理System UI (状态栏 + 导航栏)</a></p>
<p>我们可以看到实际上第一次计算窗体的区域，是根据SystemUI的标志位进行了处理：</p>
<ul>
<li>1.首先根据当前的window的旋转方向，设置好当前Window应该旋转多少度后显示。</li>
<li>2.如果判断到打开了FLAG_LAYOUT_IN_SCREEN，FLAG_LAYOUT_INSET_DECOR标志位，关闭了PRIVATE_FLAG_IS_SCREEN_DECOR标志位。则会走如下分支：<ul>
<li>1.如果允许隐藏导航栏，同时打开了SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION标志位。则把区域设置为我在计算窗体大小一节说过的，outFrame设置为mUnrestricted区域，正式屏幕大小，但是不包含过扫描区域。</li>
<li>2.否则，outFrame则设置为mRestricted区域。这个区域是屏幕大小，但是如果状态栏无法隐藏，就是减去状态栏的高度，当然不包含过扫描区域。</li>
</ul>
</li>
</ul>
<p>接下来outStableInsets 稳定区域嵌入区域，内容嵌入区域。也就是说基于这些嵌入区域垫在左边，接着的位置才是真正的Stable，Content区域。</p>
<ul>
<li>3.接着第二大点的逻辑，如果不满足上述标志的处理，如果打开了FLAG_LAYOUT_IN_SCREEN标志位，则设置mUnrestricted为mWindowFrame区域。否则则是mStable。</li>
</ul>
<p>其他的逻辑暂时不管。我们可以总结了一点，mUnrestricted是最大的扫描区域。其次是restricted区域，可以包含导航栏以及状态栏，但是这两个区域可以内容重叠。接下里就是Stable区域，也就是稳定内容区域。实际上不同沉浸式模式就是改变ViewRootImpl显示区域在这三个显示区域之间切换。</p>
<h4 id="ViewGroup-dispatchAttachedToWindow"><a href="#ViewGroup-dispatchAttachedToWindow" class="headerlink" title="ViewGroup dispatchAttachedToWindow"></a>ViewGroup dispatchAttachedToWindow</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/ViewGroup.java" target="_blank" rel="noopener">ViewGroup.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">dispatchAttachedToWindow</span><span class="token punctuation">(</span>AttachInfo info<span class="token punctuation">,</span> <span class="token keyword">int</span> visibility<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mGroupFlags <span class="token operator">|=</span> FLAG_PREVENT_DISPATCH_ATTACHED_TO_WINDOW<span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispatchAttachedToWindow</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> visibility<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mGroupFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>FLAG_PREVENT_DISPATCH_ATTACHED_TO_WINDOW<span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> count <span class="token operator">=</span> mChildrenCount<span class="token punctuation">;</span>
        <span class="token keyword">final</span> View<span class="token punctuation">[</span><span class="token punctuation">]</span> children <span class="token operator">=</span> mChildren<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> View child <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            child<span class="token punctuation">.</span><span class="token function">dispatchAttachedToWindow</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span>
                    <span class="token function">combineVisibility</span><span class="token punctuation">(</span>visibility<span class="token punctuation">,</span> child<span class="token punctuation">.</span><span class="token function">getVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> transientCount <span class="token operator">=</span> mTransientIndices <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> mTransientIndices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> transientCount<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            View view <span class="token operator">=</span> mTransientViews<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            view<span class="token punctuation">.</span><span class="token function">dispatchAttachedToWindow</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span>
                    <span class="token function">combineVisibility</span><span class="token punctuation">(</span>visibility<span class="token punctuation">,</span> view<span class="token punctuation">.</span><span class="token function">getVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于在ViewRootImpl中第一个布局是一个DecorView，它同时是一个ViewGroup也是一个FrameLayout.能看到这个付哦凑成很简单，实际上就是遍历绑定在ViewGroup中所有子View的dispatchAttachedToWindow方法。</p>
<h4 id="View-dispatchAttachedToWindow"><a href="#View-dispatchAttachedToWindow" class="headerlink" title="View dispatchAttachedToWindow"></a>View dispatchAttachedToWindow</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/View.java" target="_blank" rel="noopener">View.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">dispatchAttachedToWindow</span><span class="token punctuation">(</span>AttachInfo info<span class="token punctuation">,</span> <span class="token keyword">int</span> visibility<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mAttachInfo <span class="token operator">=</span> info<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOverlay <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mOverlay<span class="token punctuation">.</span><span class="token function">getOverlayView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispatchAttachedToWindow</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> visibility<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mWindowAttachCount<span class="token operator">++</span><span class="token punctuation">;</span>

        mPrivateFlags <span class="token operator">|=</span> PFLAG_DRAWABLE_STATE_DIRTY<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mFloatingTreeObserver <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            info<span class="token punctuation">.</span>mTreeObserver<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>mFloatingTreeObserver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mFloatingTreeObserver <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">registerPendingFrameMetricsObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags<span class="token operator">&amp;</span>PFLAG_SCROLL_CONTAINER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAttachInfo<span class="token punctuation">.</span>mScrollContainers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPrivateFlags <span class="token operator">|=</span> PFLAG_SCROLL_CONTAINER_ADDED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Transfer all pending runnables.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRunQueue <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mRunQueue<span class="token punctuation">.</span><span class="token function">executeActions</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>mHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mRunQueue <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">performCollectViewAttributes</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">,</span> visibility<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ListenerInfo li <span class="token operator">=</span> mListenerInfo<span class="token punctuation">;</span>
        <span class="token keyword">final</span> CopyOnWriteArrayList<span class="token operator">&lt;</span>OnAttachStateChangeListener<span class="token operator">></span> listeners <span class="token operator">=</span>
                li <span class="token operator">!=</span> null <span class="token operator">?</span> li<span class="token punctuation">.</span>mOnAttachStateChangeListeners <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listeners <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> listeners<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>OnAttachStateChangeListener listener <span class="token operator">:</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                listener<span class="token punctuation">.</span><span class="token function">onViewAttachedToWindow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> vis <span class="token operator">=</span> info<span class="token punctuation">.</span>mWindowVisibility<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vis <span class="token operator">!=</span> GONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onWindowVisibilityChanged</span><span class="token punctuation">(</span>vis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isShown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">onVisibilityAggregated</span><span class="token punctuation">(</span>vis <span class="token operator">==</span> VISIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">onVisibilityChanged</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> visibility<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags<span class="token operator">&amp;</span>PFLAG_DRAWABLE_STATE_DIRTY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// If nobody has evaluated the drawable state yet, then do it now.</span>
            <span class="token function">refreshDrawableState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">needGlobalAttributesUpdate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">notifyEnterOrExitForAutoFillIfNeeded</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.首先把ViewRootImpl的AttachInfo分发到View的mAttachInfo中，接着继续分发到View的浮层OverLayer中。这个浮层挺有用的，不占用过多层级，适合给View添加没有任何行为的图标等。</p>
</li>
<li><p>2.把View自己的mFloatingTreeObserver(如果存在)也就是ViewTreeObserver对象，合并到全局的ViewRootImpl的ViewTreeObserver监听中。</p>
</li>
<li><p>3.registerPendingFrameMetricsObservers 设置硬件渲染的掉帧和渲染完成监听。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">registerPendingFrameMetricsObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mFrameMetricsObservers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ThreadedRenderer renderer <span class="token operator">=</span> <span class="token function">getThreadedRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>renderer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span>FrameMetricsObserver fmo <span class="token operator">:</span> mFrameMetricsObservers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  renderer<span class="token punctuation">.</span><span class="token function">addFrameMetricsObserver</span><span class="token punctuation">(</span>fmo<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<pre><code>- 4.判断是否打开了通过setScrollContainer方法打开了PFLAG_SCROLL_CONTAINER标志位。这个标志位设定了View是否能在键盘弹出的时候进行向上移动。其效果和adjustPan类似。也可以通过xml的android:isScrollContainer设置。

- 5.执行View中通过post方法设置进来的Runnable方法。有一种使用方式十分常见：
```java
view.post(new Runnable());</code></pre><p>这样就能保证这个Runnable对象在主线程中处理。其原理很简单：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">post</span><span class="token punctuation">(</span>Runnable action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> AttachInfo attachInfo <span class="token operator">=</span> mAttachInfo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attachInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> attachInfo<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">getRunQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就是判断如果当前的View绑定了mAttachInfo，则把事件委托给ViewRootImpl的Handler处理。否则将会把事件预存到HandlerActionQueue中，直到真正开始渲染之前消费。</p>
<ul>
<li><p>6.performCollectViewAttributes收集View可见属性：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">void</span> <span class="token function">performCollectViewAttributes</span><span class="token punctuation">(</span>AttachInfo attachInfo<span class="token punctuation">,</span> <span class="token keyword">int</span> visibility<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>visibility <span class="token operator">&amp;</span> VISIBILITY_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> VISIBLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> KEEP_SCREEN_ON<span class="token punctuation">)</span> <span class="token operator">==</span> KEEP_SCREEN_ON<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              attachInfo<span class="token punctuation">.</span>mKeepScreenOn <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          attachInfo<span class="token punctuation">.</span>mSystemUiVisibility <span class="token operator">|=</span> mSystemUiVisibility<span class="token punctuation">;</span>
          ListenerInfo li <span class="token operator">=</span> mListenerInfo<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>li <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnSystemUiVisibilityChangeListener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              attachInfo<span class="token punctuation">.</span>mHasSystemUiListeners <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到只要有一个View的mKeepScreenOn为true则全局为ture。如果有一个View设置了SystemUI可见那么全局可见，其实这里是收集每一个View对SystemUI设置的标志位行为。</p>
</li>
<li><p>7.调用onAttachedToWindow方法，接着回调所有的监听onAttachedToWindow行为的回调。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> PFLAG_REQUEST_TRANSPARENT_REGIONS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          mParent<span class="token punctuation">.</span><span class="token function">requestTransparentRegion</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      mPrivateFlags3 <span class="token operator">&amp;=</span> <span class="token operator">~</span>PFLAG3_IS_LAID_OUT<span class="token punctuation">;</span>

      <span class="token function">jumpDrawablesToCurrentState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">resetSubtreeAccessibilityStateChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">rebuildOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFocused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          InputMethodManager imm <span class="token operator">=</span> InputMethodManager<span class="token punctuation">.</span><span class="token function">peekInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>imm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              imm<span class="token punctuation">.</span><span class="token function">focusIn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<pre><code>这里面的工作不多，主要是处理Drawable中设置了几种状态的情况，选定一种；并且打上一个标志位，告诉Accessibility无障碍服务整个View层次结构重建了；重新构建View 的ViewOutlineProvider，也就是外框(可以用于实现圆角，QMUI也是通过这种方式实现的)；如果打上了foucs标志位，则告诉InputMethodManager(软键盘管理器)以此View为焦点弹出。

- 8.如果View不是Gone,会调用onWindowVisibilityChanged设置当前窗口的可见性时候需要的处理。
```java
    protected void onWindowVisibilityChanged(@Visibility int visibility) {
        if (visibility == VISIBLE) {
            initialAwakenScrollBars();
        }
    }
    private boolean initialAwakenScrollBars() {
        return mScrollCache != null &amp;&amp;
                awakenScrollBars(mScrollCache.scrollBarDefaultDelayBeforeFade * 4, true);
    }</code></pre><p>能看到实际上就是唤醒Scrollbar(上下滚动的滑轮)的显示时间。这里的默认时间为300毫秒淡入淡出。</p>
<ul>
<li><p>9.onVisibilityAggregated 这里主要的工作是为了调用AutofillManager中关注的View那些是显示的。提一句，AutofillManager这个系统服务是用于自动化填充字符串的服务，这里暂时不讨论。感兴趣可以看看官方网站的介绍<a href="https://developer.android.google.cn/reference/android/view/autofill/AutofillManager.html" target="_blank" rel="noopener">https://developer.android.google.cn/reference/android/view/autofill/AutofillManager.html</a>以及<a href="https://blog.csdn.net/weixin_34245169/article/details/88022291?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.nonecase&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.nonecase" target="_blank" rel="noopener">一个完整例子</a>。</p>
</li>
<li><p>10.调用onVisibilityChanged方法回调。我们编写View的时候可以重写这个方法监听是否可见。</p>
</li>
<li><p>11.在上面添加了PFLAG_DRAWABLE_STATE_DIRTY标志位。此时就会执行refreshDrawableState 刷新Drawable的状态内容。</p>
</li>
<li><p>12.notifyEnterOrExitForAutoFillIfNeeded 实际上就是AutofillManager调用了notifyViewEntered方法，告诉AutofillManager服务已经遍历到这个层级。</p>
</li>
</ul>
<h4 id="dispatchWindowVisibilityChanged"><a href="#dispatchWindowVisibilityChanged" class="headerlink" title="dispatchWindowVisibilityChanged"></a>dispatchWindowVisibilityChanged</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatchWindowVisibilityChanged</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Visibility</span> <span class="token keyword">int</span> visibility<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onWindowVisibilityChanged</span><span class="token punctuation">(</span>visibility<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onWindowVisibilityChanged</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Visibility</span> <span class="token keyword">int</span> visibility<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>visibility <span class="token operator">==</span> VISIBLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">initialAwakenScrollBars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上这里的逻辑和上面的Window的Attach步骤几乎一致。说明只要Window从不可视到可视都会尝试的显示一次滚轮。</p>
<h4 id="ViewRootImpl-绘制准备分发WindowInsets"><a href="#ViewRootImpl-绘制准备分发WindowInsets" class="headerlink" title="ViewRootImpl 绘制准备分发WindowInsets"></a>ViewRootImpl 绘制准备分发WindowInsets</h4><pre class="line-numbers language-java"><code class="language-java">        <span class="token function">getRunQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executeActions</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> insetsChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> layoutRequested <span class="token operator">=</span> mLayoutRequested <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>mStopped <span class="token operator">||</span> mReportNextDraw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layoutRequested<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">final</span> Resources res <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mFirst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mAttachInfo<span class="token punctuation">.</span>mInTouchMode <span class="token operator">=</span> <span class="token operator">!</span>mAddedTouchMode<span class="token punctuation">;</span>
                <span class="token function">ensureTouchModeLocally</span><span class="token punctuation">(</span>mAddedTouchMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingOverscanInsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mOverscanInsets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    insetsChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingContentInsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    insetsChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingStableInsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    insetsChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingDisplayCutout<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    insetsChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingVisibleInsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mVisibleInsets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAttachInfo<span class="token punctuation">.</span>mVisibleInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mPendingVisibleInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingOutsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mOutsets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    insetsChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingAlwaysConsumeNavBar <span class="token operator">!=</span> mAttachInfo<span class="token punctuation">.</span>mAlwaysConsumeNavBar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    insetsChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lp<span class="token punctuation">.</span>width <span class="token operator">==</span> ViewGroup<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>WRAP_CONTENT
                        <span class="token operator">||</span> lp<span class="token punctuation">.</span>height <span class="token operator">==</span> ViewGroup<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>WRAP_CONTENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    windowSizeMayChange <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldUseDisplaySize</span><span class="token punctuation">(</span>lp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Point size <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mDisplay<span class="token punctuation">.</span><span class="token function">getRealSize</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        desiredWindowWidth <span class="token operator">=</span> size<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                        desiredWindowHeight <span class="token operator">=</span> size<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        Configuration config <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        desiredWindowWidth <span class="token operator">=</span> <span class="token function">dipToPx</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>screenWidthDp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        desiredWindowHeight <span class="token operator">=</span> <span class="token function">dipToPx</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>screenHeightDp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            windowSizeMayChange <span class="token operator">|=</span> <span class="token function">measureHierarchy</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> lp<span class="token punctuation">,</span> res<span class="token punctuation">,</span>
                    desiredWindowWidth<span class="token punctuation">,</span> desiredWindowHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">collectViewAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            params <span class="token operator">=</span> lp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mForceReportNewAttributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAttachInfo<span class="token punctuation">.</span>mForceReportNewAttributes <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            params <span class="token operator">=</span> lp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mFirst <span class="token operator">||</span> mAttachInfo<span class="token punctuation">.</span>mViewVisibilityChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAttachInfo<span class="token punctuation">.</span>mViewVisibilityChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> resizeMode <span class="token operator">=</span> mSoftInputMode <span class="token operator">&amp;</span>
                    WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>SOFT_INPUT_MASK_ADJUST<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resizeMode <span class="token operator">==</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>SOFT_INPUT_ADJUST_UNSPECIFIED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> mAttachInfo<span class="token punctuation">.</span>mScrollContainers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mScrollContainers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isShown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        resizeMode <span class="token operator">=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>SOFT_INPUT_ADJUST_RESIZE<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resizeMode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    resizeMode <span class="token operator">=</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>SOFT_INPUT_ADJUST_PAN<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lp<span class="token punctuation">.</span>softInputMode <span class="token operator">&amp;</span>
                        WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>SOFT_INPUT_MASK_ADJUST<span class="token punctuation">)</span> <span class="token operator">!=</span> resizeMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lp<span class="token punctuation">.</span>softInputMode <span class="token operator">=</span> <span class="token punctuation">(</span>lp<span class="token punctuation">.</span>softInputMode <span class="token operator">&amp;</span>
                            <span class="token operator">~</span>WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>SOFT_INPUT_MASK_ADJUST<span class="token punctuation">)</span> <span class="token operator">|</span>
                            resizeMode<span class="token punctuation">;</span>
                    params <span class="token operator">=</span> lp<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">.</span>mPrivateFlags <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>PFLAG_REQUEST_TRANSPARENT_REGIONS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PixelFormat<span class="token punctuation">.</span><span class="token function">formatHasAlpha</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>format<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    params<span class="token punctuation">.</span>format <span class="token operator">=</span> PixelFormat<span class="token punctuation">.</span>TRANSLUCENT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            mAttachInfo<span class="token punctuation">.</span>mOverscanRequested <span class="token operator">=</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>flags
                    <span class="token operator">&amp;</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FLAG_LAYOUT_IN_OVERSCAN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mApplyInsetsRequested<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mApplyInsetsRequested <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mLastOverscanRequested <span class="token operator">=</span> mAttachInfo<span class="token punctuation">.</span>mOverscanRequested<span class="token punctuation">;</span>
            <span class="token function">dispatchApplyInsets</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLayoutRequested<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                windowSizeMayChange <span class="token operator">|=</span> <span class="token function">measureHierarchy</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> lp<span class="token punctuation">,</span>
                        mView<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        desiredWindowWidth<span class="token punctuation">,</span> desiredWindowHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>layoutRequested<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mLayoutRequested <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> windowShouldResize <span class="token operator">=</span> layoutRequested <span class="token operator">&amp;&amp;</span> windowSizeMayChange
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mWidth <span class="token operator">!=</span> host<span class="token punctuation">.</span><span class="token function">getMeasuredWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> mHeight <span class="token operator">!=</span> host<span class="token punctuation">.</span><span class="token function">getMeasuredHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token punctuation">(</span>lp<span class="token punctuation">.</span>width <span class="token operator">==</span> ViewGroup<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>WRAP_CONTENT <span class="token operator">&amp;&amp;</span>
                        frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> desiredWindowWidth <span class="token operator">&amp;&amp;</span> frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> mWidth<span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token punctuation">(</span>lp<span class="token punctuation">.</span>height <span class="token operator">==</span> ViewGroup<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>WRAP_CONTENT <span class="token operator">&amp;&amp;</span>
                        frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> desiredWindowHeight <span class="token operator">&amp;&amp;</span> frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> mHeight<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        windowShouldResize <span class="token operator">|=</span> mDragResizing <span class="token operator">&amp;&amp;</span> mResizeMode <span class="token operator">==</span> RESIZE_MODE_FREEFORM<span class="token punctuation">;</span>


        windowShouldResize <span class="token operator">|=</span> mActivityRelaunched<span class="token punctuation">;</span>


        <span class="token keyword">final</span> <span class="token keyword">boolean</span> computesInternalInsets <span class="token operator">=</span>
                mAttachInfo<span class="token punctuation">.</span>mTreeObserver<span class="token punctuation">.</span><span class="token function">hasComputeInternalInsetsListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> mAttachInfo<span class="token punctuation">.</span>mHasNonEmptyGivenInternalInsets<span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> insetsPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> relayoutResult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> updatedConfiguration <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> surfaceGenerationId <span class="token operator">=</span> mSurface<span class="token punctuation">.</span><span class="token function">getGenerationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isViewVisible <span class="token operator">=</span> viewVisibility <span class="token operator">==</span> View<span class="token punctuation">.</span>VISIBLE<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> windowRelayoutWasForced <span class="token operator">=</span> mForceNextWindowRelayout<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.在ViewRootImpl中也有自己的RunQueue。也是通过post的方法传递进来。不过这个任务队列是专门用来处理从IMS接受到的点击事件等。</p>
</li>
<li><p>2.mLayoutRequested 这个标志位在requestLayout设置为true。同时mStopped为false。所以此时会走到layoutRequested 的分支中。</p>
<ul>
<li>1.此时是首次渲染，则会根据ADD_FLAG_IN_TOUCH_MODE这个标志位设置相反的状态到mAttachInfo.mInTouchMode。这个标志位其实标志着正在进行按键导航而不是触摸屏。</li>
<li>2.如果不是首次渲染，则校验当前通过上面的addToDisplay获取的当前各个显示区域和当前的显示区域进行比较，只要有一处发生了变化insetsChanged为true。最后如果判断到WindowManager.LayoutParams的宽高都是WRAP_CONTENT，则windowSizeMayChange强制设置为true。并重新更新全局的宽高。</li>
</ul>
</li>
</ul>
<p>不管哪一种情况都会走到measureHierarchy方法中，重新进行通过performMeasure对View树中每一个层级中View的宽高的变化校验。关于performMeasure相关的内容，我们放到下一篇区聊聊。</p>
<ul>
<li><p>3.如果调用了View.requestApplyInsets方法，则会调用dispatchApplyInsets方法分发Inset，如果是requestLayout开始调用使得mLayoutRequested为true，则调用measureHierarchy判断是否发生了变化。</p>
</li>
<li><p>4.接着处理这个标志位，windowShouldResize。windowShouldResize标志位代表着窗口是否重新计算大小。这里的判断mWindowFrame是宽高比窗口的小同时和当前的宽高不相同则为true。如果ViewRootImpl发现Activity是重新登陆或者第一次登陆也会强制设置为true。</p>
</li>
</ul>
<p>这个过程中值得注意的是Inset的分发。</p>
<h4 id="dispatchApplyInsets"><a href="#dispatchApplyInsets" class="headerlink" title="dispatchApplyInsets"></a>dispatchApplyInsets</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">dispatchApplyInsets</span><span class="token punctuation">(</span>View host<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        WindowInsets insets <span class="token operator">=</span> <span class="token function">getWindowInsets</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* forceConstruct */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> dispatchCutout <span class="token operator">=</span> <span class="token punctuation">(</span>mWindowAttributes<span class="token punctuation">.</span>layoutInDisplayCutoutMode
                <span class="token operator">==</span> LAYOUT_IN_DISPLAY_CUTOUT_MODE_ALWAYS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dispatchCutout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            insets <span class="token operator">=</span> insets<span class="token punctuation">.</span><span class="token function">consumeDisplayCutout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        host<span class="token punctuation">.</span><span class="token function">dispatchApplyWindowInsets</span><span class="token punctuation">(</span>insets<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，通过getWindowInsets获取到一个WindowInsets对象。如果LAYOUT_IN_DISPLAY_CUTOUT_MODE_ALWAYS没有打开，就是指窗口没有使用刘海屏的挖孔区域，则调用WindowInsets.consumeDisplayCutout消费这段区域，扩充起来。最后通过DecorView分发下去。</p>
<p>那么有三个函数值得注意：</p>
<ul>
<li>1.getWindowInsets 这个函数获取了哪个区域的内容</li>
<li>2.consumeDisplayCutout WindowInsets是如何消费区域的</li>
<li>3.dispatchApplyWindowInsets ViewGroup的分发做了什么。</li>
</ul>
<h5 id="getWindowInsets"><a href="#getWindowInsets" class="headerlink" title="getWindowInsets"></a>getWindowInsets</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/* package */</span> WindowInsets <span class="token function">getWindowInsets</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forceConstruct<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLastWindowInsets <span class="token operator">==</span> null <span class="token operator">||</span> forceConstruct<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mDispatchContentInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mDispatchStableInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mDispatchDisplayCutout <span class="token operator">=</span> mAttachInfo<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Rect contentInsets <span class="token operator">=</span> mDispatchContentInsets<span class="token punctuation">;</span>
            Rect stableInsets <span class="token operator">=</span> mDispatchStableInsets<span class="token punctuation">;</span>
            DisplayCutout displayCutout <span class="token operator">=</span> mDispatchDisplayCutout<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forceConstruct
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingContentInsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>contentInsets<span class="token punctuation">)</span> <span class="token operator">||</span>
                        <span class="token operator">!</span>mPendingStableInsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>stableInsets<span class="token punctuation">)</span> <span class="token operator">||</span>
                        <span class="token operator">!</span>mPendingDisplayCutout<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>displayCutout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                contentInsets <span class="token operator">=</span> mPendingContentInsets<span class="token punctuation">;</span>
                stableInsets <span class="token operator">=</span> mPendingStableInsets<span class="token punctuation">;</span>
                displayCutout <span class="token operator">=</span> mPendingDisplayCutout<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Rect outsets <span class="token operator">=</span> mAttachInfo<span class="token punctuation">.</span>mOutsets<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>outsets<span class="token punctuation">.</span>left <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> outsets<span class="token punctuation">.</span>top <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> outsets<span class="token punctuation">.</span>right <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> outsets<span class="token punctuation">.</span>bottom <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                contentInsets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span>contentInsets<span class="token punctuation">.</span>left <span class="token operator">+</span> outsets<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
                        contentInsets<span class="token punctuation">.</span>top <span class="token operator">+</span> outsets<span class="token punctuation">.</span>top<span class="token punctuation">,</span> contentInsets<span class="token punctuation">.</span>right <span class="token operator">+</span> outsets<span class="token punctuation">.</span>right<span class="token punctuation">,</span>
                        contentInsets<span class="token punctuation">.</span>bottom <span class="token operator">+</span> outsets<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            contentInsets <span class="token operator">=</span> <span class="token function">ensureInsetsNonNegative</span><span class="token punctuation">(</span>contentInsets<span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stableInsets <span class="token operator">=</span> <span class="token function">ensureInsetsNonNegative</span><span class="token punctuation">(</span>stableInsets<span class="token punctuation">,</span> <span class="token string">"stable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mLastWindowInsets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowInsets</span><span class="token punctuation">(</span>contentInsets<span class="token punctuation">,</span>
                    null <span class="token comment" spellcheck="true">/* windowDecorInsets */</span><span class="token punctuation">,</span> stableInsets<span class="token punctuation">,</span>
                    mContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isScreenRound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mAttachInfo<span class="token punctuation">.</span>mAlwaysConsumeNavBar<span class="token punctuation">,</span> displayCutout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mLastWindowInsets<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意，这里的outOutsets就是上文getLayoutHintL方法中的mOutSets参数。mOutSets这个对象实际上是由后面的Session的relayout方法获取的。如果非首次渲染，还会通过ScreenShapeHelper.getWindowOutsetBottomPx获取com.android.internal.R.integer.config_windowOutsetBottom这个资源设定的间距区域。</p>
<p>能看到实际上这个过程就是把Window中每一种区域的Inset都设置到WindowInsets中。</p>
<h4 id="consumeDisplayCutout"><a href="#consumeDisplayCutout" class="headerlink" title="consumeDisplayCutout"></a>consumeDisplayCutout</h4><p>那么consumeDisplayCutout就很好理解了：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/WindowInsets.java" target="_blank" rel="noopener">WindowInsets.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> WindowInsets <span class="token function">consumeDisplayCutout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> WindowInsets result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowInsets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>mDisplayCutout <span class="token operator">=</span> null<span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>mDisplayCutoutConsumed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就把刘海屏幕的距离屏幕的间距区域给抹平了。</p>
<h4 id="ViewGroup-dispatchApplyWindowInsets"><a href="#ViewGroup-dispatchApplyWindowInsets" class="headerlink" title="ViewGroup dispatchApplyWindowInsets"></a>ViewGroup dispatchApplyWindowInsets</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> WindowInsets <span class="token function">dispatchApplyWindowInsets</span><span class="token punctuation">(</span>WindowInsets insets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        insets <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispatchApplyWindowInsets</span><span class="token punctuation">(</span>insets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>insets<span class="token punctuation">.</span><span class="token function">isConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                insets <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispatchApplyWindowInsets</span><span class="token punctuation">(</span>insets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>insets<span class="token punctuation">.</span><span class="token function">isConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> insets<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实ViewGroup很简单，先处理View的dispatchApplyWindowInsets方法。接着遍历每一个子View的dispatchApplyWindowInsets方法。判断这个View是否需要消费Inset，一旦是需要消费就跳出遍历。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mSystemWindowInsetsConsumed <span class="token operator">&amp;&amp;</span> mWindowDecorInsetsConsumed <span class="token operator">&amp;&amp;</span> mStableInsetsConsumed
                <span class="token operator">&amp;&amp;</span> mDisplayCutoutConsumed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在WindowInsets中只要有4个区域的需要消费了就是true。那么我们注重看一下View的dispatchApplyWindowInsets方法。</p>
<h4 id="View-dispatchApplyWindowInsets"><a href="#View-dispatchApplyWindowInsets" class="headerlink" title="View dispatchApplyWindowInsets"></a>View dispatchApplyWindowInsets</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> WindowInsets <span class="token function">dispatchApplyWindowInsets</span><span class="token punctuation">(</span>WindowInsets insets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mPrivateFlags3 <span class="token operator">|=</span> PFLAG3_APPLYING_INSETS<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mListenerInfo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mListenerInfo<span class="token punctuation">.</span>mOnApplyWindowInsetsListener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mListenerInfo<span class="token punctuation">.</span>mOnApplyWindowInsetsListener<span class="token punctuation">.</span><span class="token function">onApplyWindowInsets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> insets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">onApplyWindowInsets</span><span class="token punctuation">(</span>insets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            mPrivateFlags3 <span class="token operator">&amp;=</span> <span class="token operator">~</span>PFLAG3_APPLYING_INSETS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里其实很简单，每一次经历这个方法先打开PFLAG3_APPLYING_INSETS标志位后关闭。如果有mOnApplyWindowInsetsListener的回调，则根据回调onApplyWindowInsets的结果返回。这里关注一下，默认情况onApplyWindowInsets方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> WindowInsets <span class="token function">onApplyWindowInsets</span><span class="token punctuation">(</span>WindowInsets insets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags3 <span class="token operator">&amp;</span> PFLAG3_FITTING_SYSTEM_WINDOWS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fitSystemWindows</span><span class="token punctuation">(</span>insets<span class="token punctuation">.</span><span class="token function">getSystemWindowInsets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> insets<span class="token punctuation">.</span><span class="token function">consumeSystemWindowInsets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fitSystemWindowsInt</span><span class="token punctuation">(</span>insets<span class="token punctuation">.</span><span class="token function">getSystemWindowInsets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> insets<span class="token punctuation">.</span><span class="token function">consumeSystemWindowInsets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> insets<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意在这个方法中，会判断PFLAG3_FITTING_SYSTEM_WINDOWS标志位是否开启。也就会走到if上方的分支。注意这里传入到fitSystemWindowsInt中进行判断的，实际上是整个WindowInsets中的mSystemWindowInsets对象,但是这里并不是操作这个对象，而是拷贝一份进行判断。因此不会影响到WindowInsets获取到的mSystemWindowInsets数值。</p>
<h5 id="fitSystemWindows"><a href="#fitSystemWindows" class="headerlink" title="fitSystemWindows"></a>fitSystemWindows</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">fitSystemWindows</span><span class="token punctuation">(</span>Rect insets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags3 <span class="token operator">&amp;</span> PFLAG3_APPLYING_INSETS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>insets <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mPrivateFlags3 <span class="token operator">|=</span> PFLAG3_FITTING_SYSTEM_WINDOWS<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">dispatchApplyWindowInsets</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WindowInsets</span><span class="token punctuation">(</span>insets<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                mPrivateFlags3 <span class="token operator">&amp;=</span> <span class="token operator">~</span>PFLAG3_FITTING_SYSTEM_WINDOWS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">fitSystemWindowsInt</span><span class="token punctuation">(</span>insets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于每一次经历dispatchApplyInsets都会打开PFLAG3_APPLYING_INSETS标志位，就会走到下面的分支。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">fitSystemWindowsInt</span><span class="token punctuation">(</span>Rect insets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> FITS_SYSTEM_WINDOWS<span class="token punctuation">)</span> <span class="token operator">==</span> FITS_SYSTEM_WINDOWS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mUserPaddingStart <span class="token operator">=</span> UNDEFINED_PADDING<span class="token punctuation">;</span>
            mUserPaddingEnd <span class="token operator">=</span> UNDEFINED_PADDING<span class="token punctuation">;</span>
            Rect localInsets <span class="token operator">=</span> sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localInsets <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                localInsets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>localInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">boolean</span> res <span class="token operator">=</span> <span class="token function">computeFitSystemWindows</span><span class="token punctuation">(</span>insets<span class="token punctuation">,</span> localInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mUserPaddingLeftInitial <span class="token operator">=</span> localInsets<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
            mUserPaddingRightInitial <span class="token operator">=</span> localInsets<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
            <span class="token function">internalSetPadding</span><span class="token punctuation">(</span>localInsets<span class="token punctuation">.</span>left<span class="token punctuation">,</span> localInsets<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
                    localInsets<span class="token punctuation">.</span>right<span class="token punctuation">,</span> localInsets<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里就会判断FITS_SYSTEM_WINDOWS这个标志位是否开启，没有开启则返回false。这个标志位是什么时候开启的呢？其实就是我们熟悉的在xml布局文件中添加的fitsSystemWindows标签：</p>
<pre class="line-numbers language-java"><code class="language-java">                <span class="token keyword">case</span> com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>View_fitsSystemWindows<span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        viewFlagValues <span class="token operator">|=</span> FITS_SYSTEM_WINDOWS<span class="token punctuation">;</span>
                        viewFlagMasks <span class="token operator">|=</span> FITS_SYSTEM_WINDOWS<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面的关键的行为有2点：</p>
<ul>
<li>1.从线程私有数据中获取localInsets，并且通过computeFitSystemWindows计算是否fitSystemWindows，从而消费掉SystemWindowInsets，让应用置顶。</li>
<li>2.internalSetPadding 把inset作为padding设置到View中。</li>
</ul>
<p>注意这个方法的返回，决定了WindowInsets中的consumeSystemWindowInsets方法是否执行。</p>
<h6 id="computeFitSystemWindows"><a href="#computeFitSystemWindows" class="headerlink" title="computeFitSystemWindows"></a>computeFitSystemWindows</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">computeFitSystemWindows</span><span class="token punctuation">(</span>Rect inoutInsets<span class="token punctuation">,</span> Rect outLocalInsets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        WindowInsets innerInsets <span class="token operator">=</span> <span class="token function">computeSystemWindowInsets</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WindowInsets</span><span class="token punctuation">(</span>inoutInsets<span class="token punctuation">)</span><span class="token punctuation">,</span>
                outLocalInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inoutInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>innerInsets<span class="token punctuation">.</span><span class="token function">getSystemWindowInsets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> innerInsets<span class="token punctuation">.</span><span class="token function">isSystemWindowInsetsConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> WindowInsets <span class="token function">computeSystemWindowInsets</span><span class="token punctuation">(</span>WindowInsets in<span class="token punctuation">,</span> Rect outLocalInsets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> OPTIONAL_FITS_SYSTEM_WINDOWS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                <span class="token operator">||</span> mAttachInfo <span class="token operator">==</span> null
                <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mSystemUiVisibility <span class="token operator">&amp;</span> SYSTEM_UI_LAYOUT_FLAGS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mAttachInfo<span class="token punctuation">.</span>mOverscanRequested<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            outLocalInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">getSystemWindowInsets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> in<span class="token punctuation">.</span><span class="token function">consumeSystemWindowInsets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inset</span><span class="token punctuation">(</span>outLocalInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> Rect overscan <span class="token operator">=</span> mAttachInfo<span class="token punctuation">.</span>mOverscanInsets<span class="token punctuation">;</span>
            outLocalInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>overscan<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> in<span class="token punctuation">.</span><span class="token function">inset</span><span class="token punctuation">(</span>outLocalInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.不需要fitSystemWindow，也不需要全屏，同时不需要过扫描区域的覆盖。则会先调用consumeSystemWindowInsets，后调用inset计算新的WindowInsets的大小。</li>
<li>2.负责调用inset把mOverscanInsets设置到WindowInsets后返回。</li>
</ul>
<p>当返回后就调用isSystemWindowInsetsConsumed进行判断：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">isSystemWindowInsetsConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mSystemWindowInsetsConsumed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>很简单，就是判断一次标志位是否打开。</p>
<h4 id="WindowInsets计算原理"><a href="#WindowInsets计算原理" class="headerlink" title="WindowInsets计算原理"></a>WindowInsets计算原理</h4><p>到这里，似乎还是可能对WindowInsets是什么，以及计算了什么东西还有点迷惑。我们来看看WindowInsets中inset方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> WindowInsets <span class="token function">inset</span><span class="token punctuation">(</span>Rect r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">inset</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>left<span class="token punctuation">,</span> r<span class="token punctuation">.</span>top<span class="token punctuation">,</span> r<span class="token punctuation">.</span>right<span class="token punctuation">,</span> r<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> WindowInsets <span class="token function">inset</span><span class="token punctuation">(</span><span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Preconditions<span class="token punctuation">.</span><span class="token function">checkArgumentNonnegative</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Preconditions<span class="token punctuation">.</span><span class="token function">checkArgumentNonnegative</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Preconditions<span class="token punctuation">.</span><span class="token function">checkArgumentNonnegative</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Preconditions<span class="token punctuation">.</span><span class="token function">checkArgumentNonnegative</span><span class="token punctuation">(</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>

        WindowInsets result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowInsets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>mSystemWindowInsetsConsumed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span>mSystemWindowInsets <span class="token operator">=</span>
                    <span class="token function">insetInsets</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>mSystemWindowInsets<span class="token punctuation">,</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>mWindowDecorInsetsConsumed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span>mWindowDecorInsets <span class="token operator">=</span>
                    <span class="token function">insetInsets</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>mWindowDecorInsets<span class="token punctuation">,</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>mStableInsetsConsumed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span>mStableInsets <span class="token operator">=</span> <span class="token function">insetInsets</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">,</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDisplayCutout <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span>mDisplayCutout <span class="token operator">=</span> result<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">.</span><span class="token function">inset</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result<span class="token punctuation">.</span>mDisplayCutout <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>到这里我们能看到，实际上WindowInsets管理了Window中每块区域距离屏幕边缘的区域。为什么说是间距区域呢？实际上可以从addToDisplay中能看到真正的内容区域都是先加上间距区域后才是整个屏幕区域宽高。分别是</p>
<ul>
<li>1.系统ui间距区域</li>
<li>2.Decor内容间距区域</li>
<li>3.Stable内容间距区域</li>
<li>4.DisplayCutout 刘海间距区域</li>
</ul>
<p>注意这里的逻辑，如果判断不需要消费对应区域的Insets间距区，就会通过inset方法WindowInsets对每一个间距进行调整，就能让App应用中的内容抹除这些距离，从而实现如沉浸式的模式，适配刘海屏。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> Rect <span class="token function">insetInsets</span><span class="token punctuation">(</span>Rect insets<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> newLeft <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> insets<span class="token punctuation">.</span>left <span class="token operator">-</span> left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> newTop <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> insets<span class="token punctuation">.</span>top <span class="token operator">-</span> top<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> newRight <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> insets<span class="token punctuation">.</span>right <span class="token operator">-</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> newBottom <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> insets<span class="token punctuation">.</span>bottom <span class="token operator">-</span> bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newLeft <span class="token operator">==</span> left <span class="token operator">&amp;&amp;</span> newTop <span class="token operator">==</span> top <span class="token operator">&amp;&amp;</span> newRight <span class="token operator">==</span> right <span class="token operator">&amp;&amp;</span> newBottom <span class="token operator">==</span> bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> insets<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span>newLeft<span class="token punctuation">,</span> newTop<span class="token punctuation">,</span> newRight<span class="token punctuation">,</span> newBottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>进一步的来看这个方法，实际上是对insets的四个方向的区域都减去对应的大小。让整个Rect变得更小，但是不能低于0.</p>
<h4 id="internalSetPadding"><a href="#internalSetPadding" class="headerlink" title="internalSetPadding"></a>internalSetPadding</h4><p>这一段代码就是整个xml布局文件中fitSystemWindows标志位的核心</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">internalSetPadding</span><span class="token punctuation">(</span><span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mUserPaddingLeft <span class="token operator">=</span> left<span class="token punctuation">;</span>
        mUserPaddingRight <span class="token operator">=</span> right<span class="token punctuation">;</span>
        mUserPaddingBottom <span class="token operator">=</span> bottom<span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> viewFlags <span class="token operator">=</span> mViewFlags<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Common case is there are no scroll bars.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>SCROLLBARS_VERTICAL<span class="token operator">|</span>SCROLLBARS_HORIZONTAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> SCROLLBARS_VERTICAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> SCROLLBARS_INSET_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                        <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token function">getVerticalScrollbarWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>mVerticalScrollbarPosition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> SCROLLBAR_POSITION_DEFAULT<span class="token operator">:</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLayoutRtl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            left <span class="token operator">+=</span> offset<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            right <span class="token operator">+=</span> offset<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> SCROLLBAR_POSITION_RIGHT<span class="token operator">:</span>
                        right <span class="token operator">+=</span> offset<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> SCROLLBAR_POSITION_LEFT<span class="token operator">:</span>
                        left <span class="token operator">+=</span> offset<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> SCROLLBARS_HORIZONTAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                bottom <span class="token operator">+=</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> SCROLLBARS_INSET_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                        <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token function">getHorizontalScrollbarHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPaddingLeft <span class="token operator">!=</span> left<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mPaddingLeft <span class="token operator">=</span> left<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPaddingTop <span class="token operator">!=</span> top<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mPaddingTop <span class="token operator">=</span> top<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPaddingRight <span class="token operator">!=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mPaddingRight <span class="token operator">=</span> right<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPaddingBottom <span class="token operator">!=</span> bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mPaddingBottom <span class="token operator">=</span> bottom<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">invalidateOutline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里根据消费后的insets，还剩下多少的insets还是设置整个View默认padding数值。一般来说都是设置了toppadding和bottompadding。如果遇到ScrollView这种可能可能横向滚动的View，也会根据剩下的Insets给当前的View设置padding数值。</p>
<h4 id="WindowInsets-沉浸式和非沉浸式Padding设置的原理"><a href="#WindowInsets-沉浸式和非沉浸式Padding设置的原理" class="headerlink" title="WindowInsets 沉浸式和非沉浸式Padding设置的原理"></a>WindowInsets 沉浸式和非沉浸式Padding设置的原理</h4><p>那么通过什么判断走到这个方法进行Padding的设置呢？</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYSTEM_UI_LAYOUT_FLAGS <span class="token operator">=</span>
            SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
            <span class="token operator">|</span> SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>一般来说，普通的ui显示SYSTEM_UI_LAYOUT_FLAGS这个标志位都是关闭的，因此会走到computeSystemWindowInsets上面的分支。</p>
<p>如果设置了透明状态栏，透明导航栏SYSTEM_UI_LAYOUT_FLAGS这个标志位就会打开，走computeSystemWindowInsets下面的分支。因此会返回2个完全不同的结果到上层，进行internalSetPadding设置Padding。</p>
<p>这样透明状态栏就能返回一个(0,0,0,0)的padding，而普通ui显示，则会返回一个(0,状态栏高度相同的间距区域,0,0)。那么是哪里进行设置的呢？</p>
<p>其实实在上方setView中调用collectViewAttributes，获取View的参数。其中getImpliedSystemUiVisibility方法，就是把两个WindowManager.LayoutParams特殊的标志位转化为View的标志位：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getImpliedSystemUiVisibility</span><span class="token punctuation">(</span>WindowManager<span class="token punctuation">.</span>LayoutParams params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> vis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Translucent decor window flags imply stable system ui visibility.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FLAG_TRANSLUCENT_STATUS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            vis <span class="token operator">|=</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_STABLE <span class="token operator">|</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FLAG_TRANSLUCENT_NAVIGATION<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            vis <span class="token operator">|=</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_STABLE <span class="token operator">|</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> vis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过这种方式，让设置了透明标志位天生获取到的四个padding方向大小就是0.而没有透明(也就是沉浸式)的UI带了(0,状态栏高度相同的间距区域,0,0)四个方向的padding。</p>
<p>注意这个过程中，实际上非沉浸式判断到mAttachInfo.mSystemUiVisibility &amp; SYSTEM_UI_LAYOUT_FLAGS)为0(也就是没打开)，从而是给DecorView这个根布局添加了一个paddingTop的数值是的沉浸式和非沉浸式出现了ui上表现的偏差。</p>
<h4 id="沉浸式下fitsSystemWindows设置原理"><a href="#沉浸式下fitsSystemWindows设置原理" class="headerlink" title="沉浸式下fitsSystemWindows设置原理"></a>沉浸式下fitsSystemWindows设置原理</h4><p>弄清楚了沉浸式和非沉浸式之间的区别设置的Padding区别后。fitWindowInsets虽然也是通过computeSystemWindowInsets获取到四个方向的padding，但是原理上是不一样的。</p>
<p>这里我们可以追溯会setContentView中装载DecorView方法。详情可以看<a href="https://www.jianshu.com/p/003dc36af9db" target="_blank" rel="noopener">View的初始化</a>一文。</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installDecor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mForceDecorInstall <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mContentParent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mContentParent <span class="token operator">=</span> <span class="token function">generateLayout</span><span class="token punctuation">(</span>mDecor<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mDecor<span class="token punctuation">.</span><span class="token function">makeOptionalFitsSystemWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而DecorView中makeOptionalFitsSystemWindows就是核心。位于ViewGroup下面这个方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">makeOptionalFitsSystemWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">makeOptionalFitsSystemWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> count <span class="token operator">=</span> mChildrenCount<span class="token punctuation">;</span>
        <span class="token keyword">final</span> View<span class="token punctuation">[</span><span class="token punctuation">]</span> children <span class="token operator">=</span> mChildren<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">makeOptionalFitsSystemWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">makeOptionalFitsSystemWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setFlags</span><span class="token punctuation">(</span>OPTIONAL_FITS_SYSTEM_WINDOWS<span class="token punctuation">,</span> OPTIONAL_FITS_SYSTEM_WINDOWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>换句话说每一个DecorView的第一层级的子View都带上了OPTIONAL_FITS_SYSTEM_WINDOWS标志位，同时因为带上了这个标志位。由于判断到此时是沉浸式模式SYSTEM_UI_LAYOUT_FLAGS打开了。因此默认不给根布局加padding。</p>
<p>而到了自定义的Xml的根布局之后，因为打开了FITS_SYSTEM_WINDOWS标志位，则fitSystemWindowsInt会开始默认处理Insets的逻辑中。又因为没有打开OPTIONAL_FITS_SYSTEM_WINDOWS标志位，最后给当前这个自定义的布局添加了一个Padding。</p>
<h4 id="WindowInsets-具体例子"><a href="#WindowInsets-具体例子" class="headerlink" title="WindowInsets 具体例子"></a>WindowInsets 具体例子</h4><p>结合一下上下文，如果此时打开了透明状态栏标志位</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FLAG_TRANSLUCENT_STATUS<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果我们使用的主题是NoActionBar。则会有如下的表现形式：<br><img src="/images/translate_statusbar.png" alt="translate_statusbar.png"><br>能看到我们什么都没有做的时候，发现整个内容区域都是置顶的，和状态栏重合了。一般我们都会怎么解决呢？</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>app</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res-auto<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/pp<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>fitsSystemWindows</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一般我们都会在根布局加一个fitsSystemWindows的标志位，这样内容布局就会在透明状态栏之下。如下图：<br><img src="/images/after_fitsw.png" alt="after_fitsw.png"></p>
<p>这里我们为了更加清晰的探索整个过程，我从ViewRootImpl，View.AttachInfo反射了几个关键的属性（反射的是Android 7.0.大体上变化不多，就是少了刘海间距区域）。</p>
<p>下面是没有fitsSystemWindows标志位，透明状态栏的参数：<br><img src="/images/translate_statusbar_params.png" alt="translate_statusbar_params.png"></p>
<ul>
<li><p>1.能看到所有的Insets如mContentInsets，mStableInsets，mVisibleInsets都是左右底为0，上为72.只有代表过扫描区域mOverscanInsets的是0，这些数据都是通过addToDisplay(实际上就是WMS的addWindow)获取到的。</p>
</li>
<li><p>2.mWindowFrame就是上文一直提到过的，绘制准备阶段需要绘制的大小，也就是全屏幕的高度。</p>
</li>
<li><p>3.而在布局文件中也没有设置padding，所以padding都为0。</p>
</li>
<li><p>4.默认情况下，所有区域的消费只有mWindowDecorInsetsConsumed，也就是Decor内容区域消费了间距。</p>
</li>
</ul>
<p>接下来看看打开了fitsSystemWindows标志位的参数：<br><img src="/images/fitsystemwindow_params.png" alt="fitsystemwindow_params.png"></p>
<p>能看到实际上这个过程中只有打了fitSystemWindows标志位的View，自带了一个高度差和WindowInsets一致的mPaddingTop。也就符合上述的逻辑。正是因为这个PaddingTop的存在，透明的状态栏下方的颜色就是背景色。</p>
<p>其他的参数其实在addToDisplay中已经决定好了Insets的大小，因此会都一致。</p>
<p>请注意这里的标志位，只有mWindowDecorInsetsConsumed设置为true，其他都为false。由于Android 9.0这些属性和方法不少是hidden的，因此我反射的是Android 7.0的，除了没有刘海区域，几乎逻辑还是一致。</p>
<p>那么问题来了，为什么透明状态栏的标志位一旦打开，整个内容布局就顶上了呢？这里的就需要看下面的relayoutWindow方法了。、</p>
<h3 id="重新计算Window大小以及根据大小准备对应的Surface"><a href="#重新计算Window大小以及根据大小准备对应的Surface" class="headerlink" title="重新计算Window大小以及根据大小准备对应的Surface"></a>重新计算Window大小以及根据大小准备对应的Surface</h3><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">if</span> <span class="token punctuation">(</span>mFirst <span class="token operator">||</span> windowShouldResize <span class="token operator">||</span> insetsChanged <span class="token operator">||</span>
                viewVisibilityChanged <span class="token operator">||</span> params <span class="token operator">!=</span> null <span class="token operator">||</span> mForceNextWindowRelayout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mForceNextWindowRelayout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>isViewVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                insetsPending <span class="token operator">=</span> computesInternalInsets <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mFirst <span class="token operator">||</span> viewVisibilityChanged<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSurfaceHolder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSurfaceHolder<span class="token punctuation">.</span>mSurfaceLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mDrawingAllowed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> hwInitialized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> contentInsetsChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> hadSurface <span class="token operator">=</span> mSurface<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">pauseSurface</span><span class="token punctuation">(</span>mSurface<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mDirty<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mWidth<span class="token punctuation">,</span> mHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mChoreographer<span class="token punctuation">.</span>mFrameInfo<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>FrameInfo<span class="token punctuation">.</span>FLAG_WINDOW_LAYOUT_CHANGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                relayoutResult <span class="token operator">=</span> <span class="token function">relayoutWindow</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> viewVisibility<span class="token punctuation">,</span> insetsPending<span class="token punctuation">)</span><span class="token punctuation">;</span>



                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingMergedConfiguration<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mLastReportedMergedConfiguration<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token function">performConfigurationChange</span><span class="token punctuation">(</span>mPendingMergedConfiguration<span class="token punctuation">,</span> <span class="token operator">!</span>mFirst<span class="token punctuation">,</span>
                            INVALID_DISPLAY <span class="token comment" spellcheck="true">/* same display */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    updatedConfiguration <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">final</span> <span class="token keyword">boolean</span> overscanInsetsChanged <span class="token operator">=</span> <span class="token operator">!</span>mPendingOverscanInsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                        mAttachInfo<span class="token punctuation">.</span>mOverscanInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                contentInsetsChanged <span class="token operator">=</span> <span class="token operator">!</span>mPendingContentInsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                        mAttachInfo<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> visibleInsetsChanged <span class="token operator">=</span> <span class="token operator">!</span>mPendingVisibleInsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                        mAttachInfo<span class="token punctuation">.</span>mVisibleInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> stableInsetsChanged <span class="token operator">=</span> <span class="token operator">!</span>mPendingStableInsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                        mAttachInfo<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> cutoutChanged <span class="token operator">=</span> <span class="token operator">!</span>mPendingDisplayCutout<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                        mAttachInfo<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> outsetsChanged <span class="token operator">=</span> <span class="token operator">!</span>mPendingOutsets<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mOutsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> surfaceSizeChanged <span class="token operator">=</span> <span class="token punctuation">(</span>relayoutResult
                        <span class="token operator">&amp;</span> WindowManagerGlobal<span class="token punctuation">.</span>RELAYOUT_RES_SURFACE_RESIZED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                surfaceChanged <span class="token operator">|=</span> surfaceSizeChanged<span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> alwaysConsumeNavBarChanged <span class="token operator">=</span>
                        mPendingAlwaysConsumeNavBar <span class="token operator">!=</span> mAttachInfo<span class="token punctuation">.</span>mAlwaysConsumeNavBar<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>contentInsetsChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAttachInfo<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mPendingContentInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>overscanInsetsChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAttachInfo<span class="token punctuation">.</span>mOverscanInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mPendingOverscanInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    contentInsetsChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stableInsetsChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAttachInfo<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mPendingStableInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    contentInsetsChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cutoutChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAttachInfo<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mPendingDisplayCutout<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    contentInsetsChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>alwaysConsumeNavBarChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAttachInfo<span class="token punctuation">.</span>mAlwaysConsumeNavBar <span class="token operator">=</span> mPendingAlwaysConsumeNavBar<span class="token punctuation">;</span>
                    contentInsetsChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>contentInsetsChanged <span class="token operator">||</span> mLastSystemUiVisibility <span class="token operator">!=</span>
                        mAttachInfo<span class="token punctuation">.</span>mSystemUiVisibility <span class="token operator">||</span> mApplyInsetsRequested
                        <span class="token operator">||</span> mLastOverscanRequested <span class="token operator">!=</span> mAttachInfo<span class="token punctuation">.</span>mOverscanRequested
                        <span class="token operator">||</span> outsetsChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mLastSystemUiVisibility <span class="token operator">=</span> mAttachInfo<span class="token punctuation">.</span>mSystemUiVisibility<span class="token punctuation">;</span>
                    mLastOverscanRequested <span class="token operator">=</span> mAttachInfo<span class="token punctuation">.</span>mOverscanRequested<span class="token punctuation">;</span>
                    mAttachInfo<span class="token punctuation">.</span>mOutsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mPendingOutsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mApplyInsetsRequested <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">dispatchApplyInsets</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>visibleInsetsChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mAttachInfo<span class="token punctuation">.</span>mVisibleInsets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mPendingVisibleInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadSurface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mSurface<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        newSurface <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        mFullRedrawNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        mPreviousTransparentRegion<span class="token punctuation">.</span><span class="token function">setEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                hwInitialized <span class="token operator">=</span> mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>
                                        mSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>hwInitialized <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>host<span class="token punctuation">.</span>mPrivateFlags
                                        <span class="token operator">&amp;</span> View<span class="token punctuation">.</span>PFLAG_REQUEST_TRANSPARENT_REGIONS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    mSurface<span class="token punctuation">.</span><span class="token function">allocateBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfResourcesException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">handleOutOfResourcesException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSurface<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mLastScrolledFocus <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mLastScrolledFocus<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mScrollY <span class="token operator">=</span> mCurScrollY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token keyword">instanceof</span> <span class="token class-name">RootViewSurfaceTaker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">(</span><span class="token punctuation">(</span>RootViewSurfaceTaker<span class="token punctuation">)</span> mView<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onRootViewScrollYChanged</span><span class="token punctuation">(</span>mCurScrollY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mScroller <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mScroller<span class="token punctuation">.</span><span class="token function">abortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// Our surface is gone</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                            mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>surfaceGenerationId <span class="token operator">!=</span> mSurface<span class="token punctuation">.</span><span class="token function">getGenerationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">||</span> surfaceSizeChanged <span class="token operator">||</span> windowRelayoutWasForced<span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> mSurfaceHolder <span class="token operator">==</span> null
                        <span class="token operator">&amp;&amp;</span> mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mFullRedrawNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">updateSurface</span><span class="token punctuation">(</span>mSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfResourcesException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">handleOutOfResourcesException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">final</span> <span class="token keyword">boolean</span> freeformResizing <span class="token operator">=</span> <span class="token punctuation">(</span>relayoutResult
                        <span class="token operator">&amp;</span> WindowManagerGlobal<span class="token punctuation">.</span>RELAYOUT_RES_DRAG_RESIZING_FREEFORM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> dockedResizing <span class="token operator">=</span> <span class="token punctuation">(</span>relayoutResult
                        <span class="token operator">&amp;</span> WindowManagerGlobal<span class="token punctuation">.</span>RELAYOUT_RES_DRAG_RESIZING_DOCKED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> dragResizing <span class="token operator">=</span> freeformResizing <span class="token operator">||</span> dockedResizing<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mDragResizing <span class="token operator">!=</span> dragResizing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dragResizing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mResizeMode <span class="token operator">=</span> freeformResizing
                                <span class="token operator">?</span> RESIZE_MODE_FREEFORM
                                <span class="token operator">:</span> RESIZE_MODE_DOCKED_DIVIDER<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// TODO: Need cutout?</span>
                        <span class="token function">startDragResizing</span><span class="token punctuation">(</span>mPendingBackDropFrame<span class="token punctuation">,</span>
                                mWinFrame<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mPendingBackDropFrame<span class="token punctuation">)</span><span class="token punctuation">,</span> mPendingVisibleInsets<span class="token punctuation">,</span>
                                mPendingStableInsets<span class="token punctuation">,</span> mResizeMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">endDragResizing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mUseMTRenderer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dragResizing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mCanvasOffsetX <span class="token operator">=</span> mWinFrame<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
                        mCanvasOffsetY <span class="token operator">=</span> mWinFrame<span class="token punctuation">.</span>top<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        mCanvasOffsetX <span class="token operator">=</span> mCanvasOffsetY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>


            mAttachInfo<span class="token punctuation">.</span>mWindowLeft <span class="token operator">=</span> frame<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
            mAttachInfo<span class="token punctuation">.</span>mWindowTop <span class="token operator">=</span> frame<span class="token punctuation">.</span>top<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mWidth <span class="token operator">!=</span> frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> mHeight <span class="token operator">!=</span> frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mWidth <span class="token operator">=</span> frame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mHeight <span class="token operator">=</span> frame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSurfaceHolder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mSurface<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mSurfaceHolder<span class="token punctuation">.</span>mSurface <span class="token operator">=</span> mSurface<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mSurfaceHolder<span class="token punctuation">.</span><span class="token function">setSurfaceFrameSize</span><span class="token punctuation">(</span>mWidth<span class="token punctuation">,</span> mHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mSurfaceHolder<span class="token punctuation">.</span>mSurfaceLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mSurface<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadSurface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mSurfaceHolder<span class="token punctuation">.</span><span class="token function">ungetCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        mIsCreating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        SurfaceHolder<span class="token punctuation">.</span>Callback callbacks<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> mSurfaceHolder<span class="token punctuation">.</span><span class="token function">getCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span>SurfaceHolder<span class="token punctuation">.</span>Callback c <span class="token operator">:</span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                c<span class="token punctuation">.</span><span class="token function">surfaceCreated</span><span class="token punctuation">(</span>mSurfaceHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        surfaceChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>surfaceChanged <span class="token operator">||</span> surfaceGenerationId <span class="token operator">!=</span> mSurface<span class="token punctuation">.</span><span class="token function">getGenerationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        SurfaceHolder<span class="token punctuation">.</span>Callback callbacks<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> mSurfaceHolder<span class="token punctuation">.</span><span class="token function">getCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span>SurfaceHolder<span class="token punctuation">.</span>Callback c <span class="token operator">:</span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                c<span class="token punctuation">.</span><span class="token function">surfaceChanged</span><span class="token punctuation">(</span>mSurfaceHolder<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>format<span class="token punctuation">,</span>
                                        mWidth<span class="token punctuation">,</span> mHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    mIsCreating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hadSurface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mSurfaceHolder<span class="token punctuation">.</span><span class="token function">ungetCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    SurfaceHolder<span class="token punctuation">.</span>Callback callbacks<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> mSurfaceHolder<span class="token punctuation">.</span><span class="token function">getCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>SurfaceHolder<span class="token punctuation">.</span>Callback c <span class="token operator">:</span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            c<span class="token punctuation">.</span><span class="token function">surfaceDestroyed</span><span class="token punctuation">(</span>mSurfaceHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    mSurfaceHolder<span class="token punctuation">.</span>mSurfaceLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        mSurfaceHolder<span class="token punctuation">.</span>mSurface <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Surface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        mSurfaceHolder<span class="token punctuation">.</span>mSurfaceLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> ThreadedRenderer threadedRenderer <span class="token operator">=</span> mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>threadedRenderer <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> threadedRenderer<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>hwInitialized
                        <span class="token operator">||</span> mWidth <span class="token operator">!=</span> threadedRenderer<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">||</span> mHeight <span class="token operator">!=</span> threadedRenderer<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">||</span> mNeedsRendererSetup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    threadedRenderer<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span>mWidth<span class="token punctuation">,</span> mHeight<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">,</span>
                            mWindowAttributes<span class="token punctuation">.</span>surfaceInsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mNeedsRendererSetup <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里完成的事情有如下几件事：</p>
<ul>
<li><ol>
<li>把设置在WindowManager.LayoutParams中参数(如透明状态栏等标志位)传递到relayoutWindow 方法中对整个PhoneWindow的大小进行计算。关于这一块的内容本文就不多讲了，可以阅读我写的<a href="https://www.jianshu.com/p/e83496ca788c" target="_blank" rel="noopener">计算窗体的大小</a>一文有详细讲解整个计算流程，以及状态栏下的内容是怎么通过WindowManager.LayoutParams参数进行区域的确定。</li>
</ol>
</li>
</ul>
<ul>
<li><p>2.发现如果各个区域可视的状态发生了变化则需要重新分发一次WindowInsets重新给合适的View设置padding。</p>
</li>
<li><p>3.更新Surface的状态。如果发现mThreadedRenderer不为空，且Surface有效，并且还没有初始化，则调用mThreadedRenderer.initialize初始化硬件渲染的Surface。</p>
</li>
<li><p>4.如果发现Surface失效了，则会调用mThreadedRenderer.destroy销毁硬件渲染对象。</p>
</li>
<li><p>5.如果发现Surface的大小更新了，则会mThreadedRenderer.updateSurface更新硬件渲染对应Surface下的大小。</p>
</li>
<li><p>6.mSurfaceHolder如果不为空，则按照对应的行为，依次回调surfaceCreated，surfaceChanged，surfaceDestroyed返回给监听者。</p>
</li>
<li><p>7.发现如果硬件渲染需要装载Surface初始化，则调用threadedRenderer.setup方法进行初始化。</p>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到这里，View的绘制流程准备就完毕了。</p>
<p>在进行onMeasure之前，会执行比较重要的准备步骤，这里涉及到了整个ViewRootImpl的绘制范围。可以大致分为五个简单的步骤：</p>
<ul>
<li><ol>
<li>addToDisplay 初步计算Window的各个间距屏幕数值</li>
</ol>
</li>
<li>2.dispatchAttachedToWindow</li>
<li>3.dispatchApplyWindowInsets</li>
<li>4.relayoutWindow 计算窗体的大小以及位置</li>
<li>5.准备硬件渲染</li>
</ul>
<h3 id="addToDisplay总结"><a href="#addToDisplay总结" class="headerlink" title="addToDisplay总结"></a>addToDisplay总结</h3><p>本质上，就是调用WMS的addWindow方法。这个过程会把当前的PhoneWindow的远程对象保存到WMS中进行管理。同时会把IMS服务也通过这个方法保存会App端。在这里还做了另一件重要的事情，那就是把窗体中每个不同区域距离屏幕的间距获取出来，返回给App端进行消费处理。</p>
<p>在这之后就会通过Choreographer监听Vsync的同步信号，开始真正的View树遍历与绘制。</p>
<h3 id="dispatchAttachedToWindow的总结"><a href="#dispatchAttachedToWindow的总结" class="headerlink" title="dispatchAttachedToWindow的总结"></a>dispatchAttachedToWindow的总结</h3><p>dispatchAttachedToWindow本质上是View第一次绑定到整个ViewRootImpl中的View的绘制树中调用的方法。其核心实际上就是绑定同步了贯通ViewRootImpl绘制流程的参数。如WindowInests，窗体是否可见，根部布局，硬件渲染对象，屏幕状态，以及WindowSession的Binder通信者等等。有了这个贯通绘制的上下文，ViewRootImpl就能更好的管理每一个View的绘制。</p>
<p>在分发的过程中，也会对AutoFillManagerService进行初始化。以及对View的外框绘制对象Outline进行初始化。</p>
<h3 id="dispatchApplyWindowInsets的总结"><a href="#dispatchApplyWindowInsets的总结" class="headerlink" title="dispatchApplyWindowInsets的总结"></a>dispatchApplyWindowInsets的总结</h3><p>这个过程实际上就是处理如fitSysytemWindows标志位的状态。本质上是Android窗体之间本身就会和屏幕有自己的间距。但是可以在这个步骤消费掉，抹除这些间距。常见的如刘海屏的适配，透明导航栏和透明状态栏的适配。</p>
<p>当我们没有打开这些特殊的WindowManager.LayoutParams的标志位的时候，整个屏幕是正常结构，内容区域在状态栏区域之下。</p>
<p>之所以在透明状态栏，透明状态栏下设置fitSysytemWindow才起作用，而没有任何标志位的普通显示的View树不起作用。是因为在ViewRootImpl的setView阶段，解析了WindowManager.LayoutParams中的两个特殊沉浸式flags，转化为View中的flag。</p>
<p>而在分发消费Insets的过程中，computeSystemWindowInsets判断了应该计算返回多少大小的Inset区域，进而给当前View四个方向的padding设置对应的数值。这才是fitSysytemWindows的核心思想。</p>
<p>如果设置了透明状态栏，由于判断到SYSTEM_UI_LAYOUT_FLAGS默认是打开（因为这个标志位包含了隐藏导航栏和全屏）就会返回(0,0,0,0)的四个padding数值。普通状态栏则会返回(0,状态栏高度,0,0)给Decorview这个布局。</p>
<p>fitSystemWindows标志位只有在沉浸式模式才有效，是因为在非沉浸式模式下，已经在DecorView的子层级中把这个Insets消费了。永远不会到达我们自定义的布局中进行padding的设置。而fitSystemWindows在沉浸式中起效，主要是因为该View没有打上OPTIONAL_FITS_SYSTEM_WINDOWS标志位，同时打了FITS_SYSTEM_WINDOWS标志位。</p>
<p>而OPTIONAL_FITS_SYSTEM_WINDOWS标志位，在沉浸式模式下就会跳开计算Insets的大小。这就是这个注解的来源。</p>
<h4 id="relayoutWindow总结"><a href="#relayoutWindow总结" class="headerlink" title="relayoutWindow总结"></a>relayoutWindow总结</h4><p>当我们准备好了Window的大小，以及距离绘制区域的padding数值，就开始把数据交给WMS的relayoutWindow方法，基于整个Android的系统的计算。其中状态栏，和内容区域的真正摆放位置也是在这个方法中决定的。</p>
<p>详情请看<a href="https://www.jianshu.com/p/e83496ca788c" target="_blank" rel="noopener">Android 重学系列 WMS在Activity启动中的职责 计算窗体的大小(四)</a></p>
<h4 id="准备硬件渲染总结"><a href="#准备硬件渲染总结" class="headerlink" title="准备硬件渲染总结"></a>准备硬件渲染总结</h4><p>初始化可以分为如下3个步骤：</p>
<ul>
<li>1.mThreadedRenderer.initialize</li>
<li>2.mThreadedRenderer.updateSurface</li>
<li>3.threadedRenderer.setup</li>
</ul>
<p>销毁则是</p>
<ul>
<li>4.mThreadedRenderer.destroy</li>
</ul>
<p>记住硬件渲染对象初始化3个步骤以及销毁。之后会有专题进行分析。</p>
<h2 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h2><p>之前零零散散的知识和文章可以看到要开始串联起来了。这个沉浸式和非沉浸式的计算模式倒是有点绕。不过明白了之后，以前感觉黑箱的操作也明了了。也知道在5年前刚入行时候，感觉在低版本机子设置paddingTop从而达到沉浸式的样式有点low觉得背后有什么魔法。实际上经过文章一分析，确实也是靠着padding做事情，看来很多东西看起来复杂，实际上也不过如此。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/05/25/android-chong-xue-xi-lie-view-de-hui-zhi-liu-cheng-san-onmeasure/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="Android 重学系列 View的绘制流程(三) onMeasure">
                        
                        <span class="card-title">Android 重学系列 View的绘制流程(三) onMeasure</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言经过上一篇文章的解析，我们熟知了Android在绘制流程之前需要完成的事情。本文将继续和大家聊聊onMeasure以及onLayout的流程。并且举几个常用的View的onMeasure和onLayout进行讲解。
正文我们跟着上一篇文
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-05-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/View的绘制流程/" class="post-category">
                                    View的绘制流程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/05/04/android-chong-xue-xi-lie-sharedpreferences-yuan-ma-jie-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Android 重学系列 SharedPreferences源码解析">
                        
                        <span class="card-title">Android 重学系列 SharedPreferences源码解析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言分析了MMKV的源码解析后，我们来看看Android中常用的键值对组件SharedPreferences的实现。究竟源码中出现了什么问题，导致了SharedPreferences的卡顿和ANR呢？
正文关于SharedPreferenc
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-05-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-Framework/" class="post-category">
                                    Android Framework
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                    <a href="/tags/性能优化/">
                        <span class="chip bg-color">性能优化</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
